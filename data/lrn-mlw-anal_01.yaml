- en: Introduction to Malware Analysis
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 恶意软件分析简介
- en: The number of cyber attacks is undoubtedly on the rise, targeting government,
    military, public and private sectors. These cyber attacks focus on targeting individuals
    or organizations with an effort to extract valuable information. Sometimes, these
    cyber attacks are allegedly linked to cybercrime or state-sponsored groups, but
    may also be carried out by individual groups to achieve their goals. Most of these
    cyber attacks use malicious software (also called malware) to infect their targets.
    Knowledge, skills, and tools required to analyze malicious software are essential
    to detect, investigate and defend against such attacks.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 网络攻击数量无疑在增加，攻击目标包括政府、军事、公共和私营部门。这些网络攻击集中在攻击个人或组织，企图窃取有价值的信息。有时，这些网络攻击被认为与网络犯罪或国家支持的团体有关，但也可能是由个人团体为实现目标而实施的。这些网络攻击大多数使用恶意软件（也称为恶意程序）来感染目标。分析恶意软件所需的知识、技能和工具对于检测、调查和防御此类攻击至关重要。
- en: 'In this chapter, you will learn the following topics:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你将学习以下内容：
- en: What malware means and its role in the cyber-attacks
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 恶意软件的含义及其在网络攻击中的作用
- en: Malware analysis and its significance in digital forensics
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 恶意软件分析及其在数字取证中的重要性
- en: Different types of malware analysis
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 不同类型的恶意软件分析
- en: Setting up the lab environment
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 设置实验室环境
- en: Various sources to obtain malware samples
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 获取恶意软件样本的各种来源
- en: 1\. What Is Malware?
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 1\. 什么是恶意软件？
- en: Malware is a code that performs malicious actions; it can take the form of an
    executable, script, code, or any other software. Attackers use malware to steal
    sensitive information, spy on the infected system, or take control of the system.
    It typically gets into your system without your consent and can be delivered via
    various communication channels such as email, web, or USB drives.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 恶意软件是执行恶意操作的代码；它可以是可执行文件、脚本、代码或任何其他软件。攻击者使用恶意软件来窃取敏感信息、监视感染的系统或控制该系统。它通常未经你同意便进入你的系统，可以通过多种通信渠道传播，如电子邮件、网页或USB驱动器。
- en: 'The following are some of the malicious actions performed by malware:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是恶意软件执行的一些恶意操作：
- en: Disrupting computer operations
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 干扰计算机操作
- en: Stealing sensitive information, including personal, business, and financial
    data
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 窃取敏感信息，包括个人、商业和财务数据
- en: Unauthorized access to the victim's system
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 未经授权访问受害者的系统
- en: Spying on the victims
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监视受害者
- en: Sending spam emails
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 发送垃圾邮件
- en: Engaging in distributed-denial-of-service attacks (DDOS)
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 参与分布式拒绝服务攻击（DDOS）
- en: Locking up the files on the computer and holding them for ransom
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 锁定计算机上的文件并勒索赎金
- en: '*Malware* is a broad term that refers to different types of malicious programs
    such as trojans, viruses, worms, and rootkits. While performing malware analysis,
    you will often come across various types of malicious programs; some of these
    malicious programs are categorized based on their functionality and attack vectors
    as mentioned here:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: '*恶意软件*是一个广泛的术语，指的是不同类型的恶意程序，如特洛伊木马、病毒、蠕虫和Rootkit。在进行恶意软件分析时，你经常会遇到各种类型的恶意程序；这些恶意程序通常根据其功能和攻击方式进行分类，如下所示：'
- en: '**Virus or Worm**: Malware that is capable of copying itself and spreading
    to other computers. A virus needs user intervention, whereas a worm can spread
    without user intervention.'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**病毒或蠕虫**：能够自我复制并传播到其他计算机的恶意软件。病毒需要用户干预，而蠕虫可以在没有用户干预的情况下传播。'
- en: '**Trojan**: Malware that disguises itself as a regular program to trick users
    to install it on their systems. Once installed, it can perform malicious actions
    such as stealing sensitive data, uploading files to the attacker''s server, or
    monitoring webcams.'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**特洛伊木马**：一种伪装成普通程序的恶意软件，诱使用户将其安装到系统中。安装后，它可以执行恶意操作，如窃取敏感数据、将文件上传到攻击者的服务器或监控摄像头。'
- en: '**Backdoor / Remote Access Trojan (RAT)**: This is a type of *Trojan* that
    enables the attacker to gain access to and execute commands on the compromised
    system.'
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**后门 / 远程访问木马（RAT）**：这是一种*特洛伊木马*，它允许攻击者访问并执行被攻击系统上的命令。'
- en: '**Adware**: Malware that presents unwanted advertisements (ads) to the user.
    They usually get delivered via free downloads and can forcibly install software
    on your system.'
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**广告软件**：一种向用户展示不需要的广告（广告）的恶意软件。通常通过免费下载传播，并可以强制在你的系统上安装软件。'
- en: '**Botnet**: This is a group of computers infected with the same malware (called
    *bots*), waiting to receive instructions from the command-and-control server controlled
    by the attacker. The attacker can then issue a command to these bots, which can
    perform malicious activities such as DDOS attacks or sending spam emails.'
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**僵尸网络**：这是一个由感染了相同恶意软件（称为*僵尸*）的计算机组成的群体，等待从攻击者控制的指挥与控制服务器接收指令。攻击者可以向这些僵尸发送命令，执行恶意活动，如分布式拒绝服务（DDOS）攻击或发送垃圾邮件。'
- en: '**Information stealer**: Malware designed to steal sensitive data such as banking
    credentials or typed keystrokes from the infected system. Some examples of these
    malicious programs include key loggers, spyware, sniffers, and form grabbers.'
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**信息窃取器**：旨在窃取敏感数据（如银行凭证或键盘输入）从被感染系统的恶意软件。这些恶意程序的示例包括键盘记录器、间谍软件、嗅探器和表单抓取器。'
- en: '**Ransomware**: Malware that holds the system for ransom by locking users out
    of their computer or by encrypting their files.'
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**勒索软件**：通过将用户锁定在计算机外或加密文件来控制系统的恶意软件。'
- en: '**Rootkit**: Malware that provides the attacker with privileged access to the
    infected system and conceals its presence or the presence of other software.'
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Rootkit（根套件）**：恶意软件，能够为攻击者提供对被感染系统的特权访问，并隐藏其自身或其他软件的存在。'
- en: '**Downloader or dropper**: Malware designed to download or install additional
    malware components.'
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**下载器或投放器**：旨在下载或安装额外恶意软件组件的恶意软件。'
- en: A handy resource for understanding malware terminologies and definitions is
    available at [https://blog.malwarebytes.com/glossary/](https://blog.malwarebytes.com/glossary/).
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 有一个便捷的资源可以帮助了解恶意软件术语和定义，访问链接：[https://blog.malwarebytes.com/glossary/](https://blog.malwarebytes.com/glossary/)。
- en: Classifying malware based on their functionalities may not always be possible
    because a single malware can contain multiple functionalities, which may fall
    into a variety of categories mentioned just now. For example, malware can include
    a worm component that scans the network looking for vulnerable systems and can
    drop another malware component such as a *backdoor* or a *ransomware* upon successful
    exploitation.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 基于功能对恶意软件进行分类可能并不总是可行的，因为单一恶意软件可能包含多个功能，而这些功能可能属于刚才提到的多个类别。例如，恶意软件可能包括一个蠕虫组件，扫描网络寻找易受攻击的系统，并在成功利用后投放另一个恶意软件组件，如*后门*或*勒索软件*。
- en: Malware classification can also be undertaken based on the attacker's motive.
    For example, if the malware is used to steal personal, business, or proprietary
    information for profit, then the malware can be classified as c*rimeware* or c*ommodity
    malware*. If the malware is used to target a particular organization or industry
    to steal information/gather intelligence for espionage, then it can be classified
    as t*argeted* or e*spionage malware*.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 恶意软件分类也可以根据攻击者的动机进行。例如，如果恶意软件用于窃取个人、商业或专有信息以获取利润，则可以将其分类为**犯罪软件**或**商品恶意软件**。如果恶意软件用于针对特定组织或行业，窃取信息/收集情报以进行间谍活动，则可以将其分类为**定向恶意软件**或**间谍恶意软件**。
- en: 2\. What Is Malware Analysis?
  id: totrans-31
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 2. 什么是恶意软件分析？
- en: Malware analysis is the study of malware's behavior. The objective of malware
    analysis is to understand the working of malware and how to detect and eliminate
    it. It involves analyzing the suspect binary in a safe environment to identify
    its characteristics and functionalities so that better defenses can be built to
    protect an organization's network.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 恶意软件分析是研究恶意软件行为的过程。恶意软件分析的目的是了解恶意软件的工作原理，以及如何检测和消除它。它包括在安全环境中分析可疑的二进制文件，识别其特征和功能，从而构建更好的防御措施以保护组织的网络。
- en: 3\. Why Malware Analysis?
  id: totrans-33
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 3. 为什么进行恶意软件分析？
- en: 'The primary motive behind performing malware analysis is to extract information
    from the malware sample, which can help in responding to a malware incident. The
    goal of malware analysis is to determine the capability of malware, detect it,
    and contain it. It also helps in determining identifiable patterns that can be
    used to cure and prevent future infections. The following are some of the reasons
    why you will perform malware analysis:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 执行恶意软件分析的主要动机是从恶意软件样本中提取信息，帮助应对恶意软件事件。恶意软件分析的目标是确定恶意软件的能力，检测它并将其隔离。它还帮助确定可识别的模式，这些模式可以用于治愈和防止未来的感染。以下是你进行恶意软件分析的一些原因：
- en: To determine the nature and purpose of the malware. For example, it can help
    you determine whether malware is an information stealer, HTTP bot, spam bot, rootkit,
    keylogger, or RAT, and so on.
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 确定恶意软件的性质和目的。例如，它可以帮助你判断恶意软件是否是信息窃取者、HTTP 机器人、垃圾邮件机器人、Rootkit、键盘记录器或RAT等。
- en: To gain an understanding of how the system was compromised and its impact.
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 了解系统是如何被攻破的及其影响。
- en: To identify the network indicators associated with the malware, which can then
    be used to detect similar infections using network monitoring. For example, during
    your analysis, if you determine that a malware contacts a particular *domain/IP
    address*, then you can use this domain/IP address to create a signature and monitor
    the network traffic to identify all the hosts contacting that domain/IP address.
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 识别与恶意软件相关的网络指标，这些指标可以用于通过网络监控检测类似的感染。例如，在你的分析过程中，如果你确定恶意软件与某个特定的*域名/IP地址*进行通信，那么你可以使用这个域名/IP地址创建一个签名，并监控网络流量，以识别所有与该域名/IP地址通信的主机。
- en: To extract host-based indicators such as filenames, and registry keys, which,
    in turn, can be used to determine similar infection using host-based monitoring.
    For instance, if you learn that a malware creates a registry key, you can use
    this registry key as an indicator to create a signature, or scan your network
    to identify the hosts that have the same registry key.
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 提取基于主机的指标，如文件名和注册表键，这些可以用于通过主机监控确定类似的感染。例如，如果你发现某个恶意软件创建了一个注册表键，你可以将这个注册表键作为一个指标，创建一个签名，或者扫描你的网络以识别具有相同注册表键的主机。
- en: To determine the attacker's intention and motive. For instance, during your
    analysis, if you find that the malware is stealing banking credentials, then you
    can deduce that the motive of the attacker is monetary gain.
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 确定攻击者的意图和动机。例如，在你的分析过程中，如果发现恶意软件窃取银行凭证，那么你可以推断出攻击者的动机是为了经济利益。
- en: Threat intelligence teams very often use the indicators determined from a malware
    analysis to classify the attack and attribute them to known threats. Malware analysis
    can help you get information about who could be behind the attack (competitor,
    state-sponsored attack group, and so on).
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 威胁情报团队通常使用通过恶意软件分析确定的指标来分类攻击，并将其归类为已知的威胁。恶意软件分析可以帮助你获取关于谁可能是攻击背后的人（竞争对手、国家支持的攻击组织等）的信息。
- en: 4\. Types Of Malware Analysis
  id: totrans-41
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 4\. 恶意软件分析类型
- en: 'To understand the working and the characteristics of malware and to assess
    its impact on the system, you will often use different analysis techniques. The
    following is the classification of these analysis techniques:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 要理解恶意软件的工作原理和特征，并评估其对系统的影响，通常需要使用不同的分析技术。以下是这些分析技术的分类：
- en: '**Static analysis**: This is the process of analyzing a binary without executing
    it. It is easiest to perform and allows you to extract the metadata associated
    with the suspect binary. Static analysis might not reveal all the required information,
    but it can sometimes provide interesting information that helps in determining
    where to focus your subsequent analysis efforts. [Chapter 2](part0032.html#UGI00-ac10ba3f98854c44bac1c2c5641ca485),
    *Static Analysis*, covers the tools and techniques to extract useful information
    from the malware binary using static analysis.'
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**静态分析**：这是在不执行二进制文件的情况下分析其过程。它是最容易执行的，允许你提取与可疑二进制文件相关的元数据。静态分析可能不会揭示所有所需的信息，但有时能提供有趣的信息，帮助你确定接下来分析的重点。[第2章](part0032.html#UGI00-ac10ba3f98854c44bac1c2c5641ca485)，*静态分析*，涵盖了使用静态分析从恶意软件二进制文件中提取有用信息的工具和技术。'
- en: '**Dynamic analysis (Behavioral Analysis)**: This is the process of executing
    the suspect binary in an isolated environment and monitoring its behavior. This
    analysis technique is easy to perform and gives valuable insights into the activity
    of the binary during its execution. This analysis technique is useful but does
    not reveal all the functionalities of the hostile program. [Chapter 3](part0065.html#1TVKI0-ac10ba3f98854c44bac1c2c5641ca485),
    *Dynamic Analysis*, covers the tools and techniques to determine the behavior
    of the malware using dynamic analysis.'
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**动态分析（行为分析）**：这是在隔离环境中执行可疑二进制文件并监控其行为的过程。此分析技术容易执行，并且可以提供二进制文件执行过程中的活动的有价值的洞察。该分析技术有用，但不能揭示恶意程序的所有功能。[第3章](part0065.html#1TVKI0-ac10ba3f98854c44bac1c2c5641ca485)，*动态分析*，涵盖了使用动态分析确定恶意软件行为的工具和技术。'
- en: '**Code analysis**: It is an advanced technique that focuses on analyzing the
    code to understand the inner workings of the binary. This technique reveals information
    that is not possible to determine just from static and dynamic analysis. Code
    analysis is further divided into *Static code analysis* and *Dynamic code analysis*.
    *Static code analysis* involves disassembling the suspect binary and looking at
    the code to understand the program''s behavior, whereas *Dynamic code analysis *involves
    debugging the suspect binary in a controlled manner to understand its functionality.
    Code analysis requires an understanding of the programming language and operating
    system concepts. The upcoming chapters (*Chapters 4 to 9*) will cover the knowledge,
    tools, and techniques required to perform code analysis.'
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**代码分析**：这是一种高级技术，专注于分析代码以理解二进制文件的内部工作原理。这项技术揭示了仅通过静态和动态分析无法得出的信息。代码分析进一步分为*静态代码分析*和*动态代码分析*。*静态代码分析*包括反汇编可疑的二进制文件，并查看代码以理解程序的行为，而*动态代码分析*则是在受控环境中调试可疑的二进制文件，以理解其功能。代码分析需要了解编程语言和操作系统的概念。接下来的章节（*第4到第9章*）将介绍执行代码分析所需的知识、工具和技术。'
- en: '**Memory analysis (Memory forensics)**: This is the technique of analyzing
    the computer''s RAM for forensic artifacts. It is typically a forensic technique,
    but integrating it into your malware analysis will assist in gaining an understanding
    of the malware''s behavior after infection. Memory analysis is especially useful
    to determine the stealth and evasive capabilities of the malware. You will learn
    how to perform memory analysis in subsequent chapters (*Chapters 10 and 11*).'
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**内存分析（内存取证）**：这是分析计算机RAM中的取证痕迹的技术。通常这是一种取证技术，但将其整合到恶意软件分析中将有助于了解恶意软件感染后的行为。内存分析对于确定恶意软件的隐蔽性和回避能力特别有用。在随后的章节中（*第10和第11章*），你将学习如何进行内存分析。'
- en: Integrating different analysis techniques while performing malware analysis
    can reveal a wealth of contextual information, which will prove to be valuable
    in your malware investigation.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 在进行恶意软件分析时，整合不同的分析技术可以揭示大量的上下文信息，这对你的恶意软件调查将非常有价值。
- en: 5\. Setting Up The Lab Environment
  id: totrans-48
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5. 设置实验室环境
- en: 'Analysis of a hostile program requires a safe and secure lab environment, as
    you do not want to infect your system or the production system. A malware lab
    can be very simple or complex depending on the resources available to you (hardware,
    virtualization software, Windows license, and so on). This section will guide
    you to set up a simple personal lab on a single physical system consisting of
    *virtual machines (VMs)*. If you wish to set up a similar lab environment, feel
    free to follow along or skip to the next section (*Section 6: Malware Sources*).'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 恶意程序的分析需要一个安全的实验室环境，因为你不希望感染你的系统或生产系统。恶意软件实验室可以根据可用资源（硬件、虚拟化软件、Windows许可证等）来设立得很简单或很复杂。本节将指导你在单一物理系统上设置一个简单的个人实验室，实验室由*虚拟机（VMs）*组成。如果你希望设置一个类似的实验室环境，可以随时跟着操作，或者跳到下一节（*第6节：恶意软件来源*）。
- en: 5.1 Lab Requirements
  id: totrans-50
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5.1 实验室需求
- en: 'Before you begin setting up a lab, you need a few components: a *physical system*
    running a base operating system of *Linux, Windows*, or *macOS X*, and installed
    with virtualization software (such as *VMware* or *VirtualBox*). When analyzing
    the malware, you will be executing the malware on a Windows-based virtual machine
    (Windows VM). The advantage of using a virtual machine is that after you finish
    analyzing the malware, you can revert it to a clean state.'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 在开始搭建实验室之前，你需要一些组件：一个运行基础操作系统*Linux*、*Windows*或*macOS X*的*物理系统*，并安装虚拟化软件（如*VMware*或*VirtualBox*）。在分析恶意软件时，你将会在基于Windows的虚拟机（Windows
    VM）上执行恶意软件。使用虚拟机的好处是，在完成恶意软件分析后，你可以将其恢复到干净的状态。
- en: '*VMware Workstation* for Windows and Linux is available for download from [https://www.vmware.com/products/workstation/workstation-evaluation.html](https://www.vmware.com/products/workstation/workstation-evaluation.html),
    and *VMware Fusion* for macOS X is available for download from [https://www.vmware.com/products/fusion/fusion-evaluation.html](https://www.vmware.com/products/fusion/fusion-evaluation.html).
    VirtualBox for different flavors of operating systems is available for download
    from [https://www.virtualbox.org/wiki/Downloads](https://www.virtualbox.org/wiki/Downloads).'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: '*VMware Workstation*（适用于 Windows 和 Linux）可从 [https://www.vmware.com/products/workstation/workstation-evaluation.html](https://www.vmware.com/products/workstation/workstation-evaluation.html)
    下载，*VMware Fusion*（适用于 macOS X）可从 [https://www.vmware.com/products/fusion/fusion-evaluation.html](https://www.vmware.com/products/fusion/fusion-evaluation.html)
    下载，适用于不同操作系统版本的 VirtualBox 可从 [https://www.virtualbox.org/wiki/Downloads](https://www.virtualbox.org/wiki/Downloads)
    下载。'
- en: 'To create a safe lab environment, you should take the necessary precautions
    to avoid malware from escaping the virtualized environment and infecting your
    physical (host) system. The following are a few points to remember when setting
    up the virtualized lab:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 为了创建一个安全的实验室环境，你应该采取必要的预防措施，避免恶意软件从虚拟化环境中逃逸并感染你的物理（主机）系统。以下是设置虚拟化实验室时需要记住的几点：
- en: Keep your virtualization software up to date. This is necessary because it might
    be possible for malware to exploit a vulnerability in the virtualization software,
    escape from the virtual environment, and infect your host system.
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 保持你的虚拟化软件更新。这是必要的，因为恶意软件可能会利用虚拟化软件中的漏洞，从虚拟环境逃逸并感染主机系统。
- en: Install a fresh copy of the operating system inside the virtual machine (VM),
    and do not keep any sensitive information in the virtual machine.
  id: totrans-55
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在虚拟机（VM）内安装一个全新的操作系统副本，并且不要在虚拟机中存放任何敏感信息。
- en: While analyzing a malware, if you don't want the malware to reach out to the
    Internet, then you should consider using *host-only* network configuration mode
    or restrict your network traffic within your lab environment using simulated services.
  id: totrans-56
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在分析恶意软件时，如果你不希望恶意软件连接到互联网，那么你应该考虑使用 *仅主机* 网络配置模式，或通过使用模拟服务将你的网络流量限制在实验室环境内。
- en: Do not connect any removable media that might later be used on the physical
    machines, such as USB drives.
  id: totrans-57
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 不要连接任何可能后来用于物理机器的可移动媒体，如 USB 驱动器。
- en: Since you will be analyzing Windows malware (typically Executable or DLL), it
    is recommended to choose a base operating system such as Linux or macOS X for
    your host machine instead of Windows. This is because, even if a Windows malware
    escapes from the virtual machine, it will still not be able to infect your host
    machine.
  id: totrans-58
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 由于你将分析 Windows 恶意软件（通常是可执行文件或 DLL），建议为主机机器选择一个基础操作系统，如 Linux 或 macOS X，而不是 Windows。这是因为即使
    Windows 恶意软件从虚拟机逃逸，它仍然无法感染你的主机机器。
- en: 5.2 Overview Of Lab Architecture
  id: totrans-59
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5.2 实验室架构概述
- en: The lab architecture I will be using throughout the book consists of a *physical
    machine (called host machine)* running *Ubuntu Linux* with instances of *Linux
    virtual machine (Ubuntu Linux VM)* and *Windows virtual machine (Windows VM)*.
    These virtual machines will be configured to be part of the same network and use *Host-only*
    network configuration mode so that the malware is not allowed to contact the Internet
    and network traffic is contained in the isolated lab environment.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 本书中将使用的实验室架构包括一台运行 *Ubuntu Linux* 的 *物理机器（称为主机机器）*，以及多个 *Linux 虚拟机（Ubuntu Linux
    虚拟机）* 和 *Windows 虚拟机（Windows 虚拟机）* 实例。这些虚拟机会配置在同一网络中，并使用 *仅主机* 网络配置模式，以确保恶意软件无法连接互联网，且网络流量被隔离在实验室环境内。
- en: '*Windows VM* is where the malware will be executed during analysis, and the
    *Linux VM* is used to monitor the network traffic and will be configured to simulate
    Internet services (DNS, HTTP, and so on) to provide an appropriate response when
    the malware requests for these services. For example, the Linux VM will be configured
    such that when the malware requests a service such as DNS, the Linux VM will provide
    the proper DNS response. [Chapter 3](part0065.html#1TVKI0-ac10ba3f98854c44bac1c2c5641ca485),
    *Dynamic Analysis*, covers this concept in detail.'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: '*Windows 虚拟机* 是分析过程中执行恶意软件的地方，而 *Linux 虚拟机* 用于监控网络流量，并将配置为模拟互联网服务（如 DNS、HTTP
    等），以便在恶意软件请求这些服务时提供适当的响应。例如，Linux 虚拟机会被配置为当恶意软件请求 DNS 服务时，提供正确的 DNS 响应。[第 3 章](part0065.html#1TVKI0-ac10ba3f98854c44bac1c2c5641ca485)，*动态分析*，详细介绍了这一概念。'
- en: The following figure shows an example of a simple lab architecture, which I
    will use in this book. In this setup, the *Linux VM* will be preconfigured to
    IP address `192.168.1.100`, and the IP address of the *Windows VM* will be set
    to `192.168.1.x` (where x is any number from `1` to `254` except `100`). The default
    gateway and the DNS of the Windows VM will be set to the IP address of the Linux
    VM (that is, `192.168.1.100`) so that all of the Windows network traffic is routed
    through the Linux VM. The upcoming section will guide you to set up the Linux
    VM and Windows VM to match with this setup.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 以下图显示了一个简单的实验室架构示例，我将在本书中使用。在此设置中，*Linux 虚拟机* 将预配置为 IP 地址 `192.168.1.100`，而
    *Windows 虚拟机* 的 IP 地址将设置为 `192.168.1.x`（其中 x 为 `1` 到 `254` 之间的任何数字，除了 `100`）。Windows
    虚拟机的默认网关和 DNS 将设置为 Linux 虚拟机的 IP 地址（即 `192.168.1.100`），以便所有 Windows 网络流量都通过 Linux
    虚拟机路由。接下来的部分将指导您设置 Linux 虚拟机和 Windows 虚拟机以匹配此设置。
- en: '![](../images/00005.jpeg)You need not restrict yourself to the lab architecture
    shown in the preceding Figure; different lab configurations are possible, it is
    not feasible to provide instructions on every possible configuration. In this
    book, I will show you how to set up and use the lab architecture shown in the
    preceding figure.'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: '![](../images/00005.jpeg)您不必局限于前面图示的实验室架构；可以有不同的实验室配置，无法为每种可能的配置提供说明。在本书中，我将向您展示如何设置并使用前述图中的实验室架构。'
- en: 'It is also possible to set up a lab consisting of multiple VMs running different
    versions of Windows; this will allow you to analyze the malware specimen on various
    versions of Windows operating systems. An example configuration containing multiple
    Windows VMs will look similar to the one shown in the following diagram:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 也可以设置一个包含多个运行不同版本 Windows 的虚拟机的实验室；这样可以在不同版本的 Windows 操作系统上分析恶意软件样本。包含多个 Windows
    虚拟机的示例配置类似于以下图所示：
- en: '![](../images/00006.jpeg)'
  id: totrans-65
  prefs: []
  type: TYPE_IMG
  zh: '![](../images/00006.jpeg)'
- en: 5.3 Setting Up And Configuring Linux VM
  id: totrans-66
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5.3 设置和配置 Linux 虚拟机
- en: 'To set up the Linux VM, I will use *Ubuntu 16.04.2 LTS* Linux distribution
    ([http://releases.ubuntu.com/16.04/](http://releases.ubuntu.com/16.04/)). The
    reason I have chosen Ubuntu is that most of the tools covered in this book are
    either preinstalled or available through the *apt-get* package manager. The following
    is a step-by-step procedure to configure Ubuntu 16.04.2 LTS on *VMware* and *VirtualBox.* Feel
    free to follow the instructions given here depending on the virtualization software
    (either *VMware* or *VirtualBox*) installed on your system:'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 要设置 Linux 虚拟机，我将使用 *Ubuntu 16.04.2 LTS* Linux 发行版 ([http://releases.ubuntu.com/16.04/](http://releases.ubuntu.com/16.04/))。我选择
    Ubuntu 的原因是，本书中涉及的大多数工具要么已经预安装，要么可以通过 *apt-get* 包管理器获得。以下是配置 *Ubuntu 16.04.2 LTS*
    在 *VMware* 和 *VirtualBox* 上的逐步流程。根据您系统上安装的虚拟化软件（*VMware* 或 *VirtualBox*），可以自由遵循此处提供的说明：
- en: If you are not familiar with installing and configuring virtual machines, refer
    to VMware's guide at [http://pubs.vmware.com/workstation-12/topic/com.vmware.ICbase/PDF/workstation-pro-12-user-guide.pdf](http://pubs.vmware.com/workstation-12/topic/com.vmware.ICbase/PDF/workstation-pro-12-user-guide.pdf) or
    the VirtualBox user manual ([https://www.virtualbox.org/manual/UserManual.html](https://www.virtualbox.org/manual/UserManual.html)).
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您不熟悉安装和配置虚拟机，请参考 VMware 的指南：[http://pubs.vmware.com/workstation-12/topic/com.vmware.ICbase/PDF/workstation-pro-12-user-guide.pdf](http://pubs.vmware.com/workstation-12/topic/com.vmware.ICbase/PDF/workstation-pro-12-user-guide.pdf)
    或 VirtualBox 用户手册 ([https://www.virtualbox.org/manual/UserManual.html](https://www.virtualbox.org/manual/UserManual.html))。
- en: Download Ubuntu 16.04.2 LTS from [http://releases.ubuntu.com/16.04/](http://releases.ubuntu.com/16.04/)
    and install it in VMware Workstation/Fusion or VirtualBox. If you wish to install
    any other version of Ubuntu Linux, you are free to do so as long as you are comfortable
    installing packages and solving any dependency issues.
  id: totrans-69
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从 [http://releases.ubuntu.com/16.04/](http://releases.ubuntu.com/16.04/) 下载
    Ubuntu 16.04.2 LTS，并将其安装到 VMware Workstation/Fusion 或 VirtualBox 中。如果您希望安装其他版本的
    Ubuntu Linux，只要您能够安装包并解决依赖问题，您可以自由选择。
- en: Install the *Virtualization Tools* on Ubuntu; this will allow Ubuntu's screen
    resolution to automatically adjust to match your monitor's geometry and provide
    additional enhancements, such as the ability to share clipboard content and to
    copy/paste or drag and drop files across your underlying *host machine* and the
    *Linux virtual machine*. To install virtualization tools on VMware Workstation
    or VMware Fusion, you can follow the procedure mentioned at [https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=1022525](https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=1022525)
    or watch the video at [https://youtu.be/ueM1dCk3o58](https://youtu.be/ueM1dCk3o58).
    Once installed, reboot the system.
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 Ubuntu 上安装 *虚拟化工具*；这将允许 Ubuntu 的屏幕分辨率自动调整以匹配你的显示器几何形状，并提供额外的增强功能，例如能够共享剪贴板内容，以及在主机和
    *Linux 虚拟机* 之间进行复制/粘贴或拖放文件。要在 VMware Workstation 或 VMware Fusion 上安装虚拟化工具，你可以按照[此链接](https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=1022525)中的步骤，或观看[此视频](https://youtu.be/ueM1dCk3o58)。安装完成后，重启系统。
- en: If you are using *VirtualBox*, you must install *Guest Additions software*.
    To accomplish this, from the VirtualBox menu, select Devices | Insert guest additions
    CD image. This will bring up the Guest Additions Dialog Window. Then click on
    Run to invoke the installer from the virtual CD. Authenticate with your password
    when prompted and reboot.
  id: totrans-71
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果你使用的是 *VirtualBox*，你必须安装 *Guest Additions 软件*。为此，在 VirtualBox 菜单中选择 设备 | 插入客户机附加
    CD 镜像。这将打开 Guest Additions 对话框。然后点击运行以从虚拟 CD 调用安装程序。提示时输入密码并重启系统。
- en: Once the Ubuntu operating system and the virtualization tools are installed,
    start the Ubuntu VM and install the following tools and packages.
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦 Ubuntu 操作系统和虚拟化工具安装完成，启动 Ubuntu 虚拟机并安装以下工具和包。
- en: 'Install *pip*; pip is a package management system used to install and manage
    packages written in Python. In this book, I will be running a few Python scripts;
    some of them rely on third-party libraries. To automate the installation of third-party
    packages, you need to install *pip*. Run the following command in the terminal
    to install and upgrade *pip*:'
  id: totrans-73
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装 *pip*；pip 是一个包管理系统，用于安装和管理用 Python 编写的包。在本书中，我将运行一些 Python 脚本，其中一些依赖于第三方库。为了自动化安装第三方包，你需要安装
    *pip*。在终端运行以下命令来安装并升级 *pip*：
- en: '[PRE0]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'The following are some of the tools and Python packages that will be used in
    this book. To install these tools and Python packages, run these commands in the
    terminal:'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是本书中将使用的一些工具和 Python 包。要安装这些工具和 Python 包，请在终端中运行以下命令：
- en: '[PRE1]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: '*INetSim* ([http://www.inetsim.org/index.html](http://www.inetsim.org/index.html))
    is a powerful utility that allows simulating various Internet services (such as
    DNS, and HTTP) that malware frequently expects to interact with. Later, you will
    understand how to configure *INetSim* to simulate services. To install INetSim,
    use the following commands. The use of INetSim will be covered in detail in [Chapter
    3](part0065.html#1TVKI0-ac10ba3f98854c44bac1c2c5641ca485), *Dynamic Analysis*.
    If you have difficulties installing INetSim, refer to the documentation ([http://www.inetsim.org/packages.html](http://www.inetsim.org/packages.html)):'
  id: totrans-77
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '*INetSim* ([http://www.inetsim.org/index.html](http://www.inetsim.org/index.html))
    是一个强大的工具，可以模拟恶意软件常常需要与之交互的各种互联网服务（例如 DNS 和 HTTP）。稍后，你将了解如何配置 *INetSim* 来模拟这些服务。要安装
    INetSim，请使用以下命令。INetSim 的使用将在[第 3 章](part0065.html#1TVKI0-ac10ba3f98854c44bac1c2c5641ca485)中详细介绍，标题为
    *动态分析*。如果你在安装 INetSim 时遇到困难，请参考文档 ([http://www.inetsim.org/packages.html](http://www.inetsim.org/packages.html))：'
- en: '[PRE2]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: You can now isolate Ubuntu VM within your lab by configuring the virtual appliance
    to use *Host-only* network mode. On *VMware,* bring up the Network Adapter Settings
    and choose Host-only mode as shown in the following *Figure*. Save the settings
    and reboot*.*
  id: totrans-79
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，你可以通过配置虚拟设备使用 *Host-only* 网络模式来隔离 Ubuntu 虚拟机。在 *VMware* 中，打开网络适配器设置并选择 Host-only
    模式，如下图所示。保存设置并重启虚拟机。
- en: '![](../images/00007.jpeg)'
  id: totrans-80
  prefs: []
  type: TYPE_IMG
  zh: '![](../images/00007.jpeg)'
- en: In VirtualBox, shut down *Ubuntu VM* and thenbring up Settings. Select Network
    and change the adapter settings to Host-only Adapter as shown in the following
    diagram; click on OK.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 在 VirtualBox 中，关闭 *Ubuntu 虚拟机*，然后打开设置。选择网络并将适配器设置更改为 Host-only Adapter，如下图所示；点击确定。
- en: On VirtualBox, sometimes when you choose the Host-only adapter option, the interface
    name might appear as *Not selected.* In that case, you need to first create at
    least one host-only interface by navigating to File| Preferences | Network | Host-only
    networks | Add host-only network. Click on OK; then** b**ring up the Settings.
    Select Network and change the adapter settings to Host-only Adapter, as shown
    in the following screenshot. Click on OK.![](../images/00008.jpeg)
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 在VirtualBox中，有时选择Host-only适配器选项时，接口名称可能显示为*未选择*。在这种情况下，你需要首先通过导航到文件|首选项|网络|Host-only网络|添加Host-only网络来创建至少一个Host-only接口。点击确定，然后**b**ring上设置。选择网络并将适配器设置更改为Host-only适配器，如下图所示。点击确定。![](../images/00008.jpeg)
- en: 'Now we will assign a static IP address of `192.168.1.100` to the Ubuntu Linux
    VM. To do that, power on the Linux VM, open the terminal window, type the command
    `ifconfig`, and note down the interface name. In my case, the interface name is
    `ens33`. In your case, the interface name might be different. If it is different,
    you need to make changes to the following steps accordingly**.** Open the file `/etc/network/interfaces` using
    the following command:'
  id: totrans-83
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在我们将为Ubuntu Linux虚拟机分配一个静态IP地址`192.168.1.100`。为此，启动Linux虚拟机，打开终端窗口，输入命令`ifconfig`，并记录下接口名称。在我的情况下，接口名称是`ens33`。在你的情况下，接口名称可能会有所不同。如果不同，你需要根据以下步骤做出相应的更改**。**
    使用以下命令打开`/etc/network/interfaces`文件：
- en: '[PRE3]'
  id: totrans-84
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Add the following entries at the end of the file (make sure you replace `ens33`
    with the interface name on your system) and save it:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 在文件末尾添加以下条目（确保将`ens33`替换为系统中的接口名称），并保存文件：
- en: '[PRE4]'
  id: totrans-86
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'The `/etc/network/interfaces` file should now look like the one shown here.
    Newly added entries are highlighted here:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: '`/etc/network/interfaces`文件现在应如下所示。新增的条目已在此高亮显示：'
- en: '[PRE5]'
  id: totrans-88
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Then restart the Ubuntu Linux VM. At this point, the IP address of the Ubuntu
    VM should be set to `192.168.1.100`. You can verify that by running the following
    command:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 然后重新启动Ubuntu Linux虚拟机。此时，Ubuntu虚拟机的IP地址应已设置为`192.168.1.100`。你可以通过运行以下命令来验证：
- en: '[PRE6]'
  id: totrans-90
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'The next step is to configure *INetSim* so that it can listen to and simulate
    all the services on the configured IP address `192.168.1.100`. By default, it
    listens on the local interface (`127.0.0.1`), which needs to be changed to `192.168.1.100`.
    To do that, open the configuration file located at `/etc/inetsim/inetsim.conf`
    using the following command:'
  id: totrans-91
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 下一步是配置*INetSim*，使其能够在配置的IP地址`192.168.1.100`上监听并模拟所有服务。默认情况下，它监听本地接口（`127.0.0.1`），需要将其更改为`192.168.1.100`。为此，使用以下命令打开位于`/etc/inetsim/inetsim.conf`的配置文件：
- en: '[PRE7]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Go to the `service_bind_address` section in the configuration file and add
    the entry shown here:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 转到配置文件中的`service_bind_address`部分，并添加以下条目：
- en: '[PRE8]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'The added entry (highlighted) in the configuration file should look like this:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 配置文件中添加的条目（高亮显示）应如下所示：
- en: '[PRE9]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'By default, INetSim''s DNS server will resolve all the domain names to `127.0.0.1`.
    Instead of that, we want the domain name to resolve to `192.168.1.100` (the IP
    address of Linux VM). To do that, go to the `dns_default_ip` section in the configuration
    file and add an entry as shown here:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，INetSim的DNS服务器会将所有域名解析到`127.0.0.1`。我们希望将域名解析到`192.168.1.100`（Linux虚拟机的IP地址）。为此，转到配置文件中的`dns_default_ip`部分，并添加如下所示的条目：
- en: '[PRE10]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'The added entry (highlighted in the following code) in the configuration file
    should look like this:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 配置文件中添加的条目（在以下代码中高亮显示）应如下所示：
- en: '[PRE11]'
  id: totrans-100
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Once the configuration changes are done, Save the configuration file and launch
    the INetSim main program. Verify that all the services are running and also check
    whether the `inetsim` is listening on `192.168.1.100`, as highlighted in the following
    code. You can stop the service by pressing *CTRL+C*:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 配置更改完成后，保存配置文件并启动INetSim主程序。验证所有服务是否正常运行，并检查`inetsim`是否在`192.168.1.100`上监听，如以下代码中高亮显示的那样。你可以通过按*CTRL+C*停止服务：
- en: '[PRE12]'
  id: totrans-102
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: At some point, you need the ability to transfer files between the host and the
    virtual machine. To enable that on *VMware*, power off the virtual machine and
    bring up the Settings. Select Options | Guest Isolation and check both Enable
    drag and drop and Enable copy and paste. Save the settings.
  id: totrans-103
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 有时，你需要在主机和虚拟机之间传输文件。要在*VMware*上启用此功能，请关闭虚拟机并打开设置。选择选项|访客隔离，然后勾选启用拖放和启用复制粘贴。保存设置。
- en: On *Virtualbox*, while the virtual machine is powered off, bring up Settings
    | General | Advanced and make sure that both Shared Clipboard and Drag 'n' Drop
    are set to Bidirectional. Click on OK.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 在 *Virtualbox* 中，当虚拟机处于关闭状态时，进入设置 | 常规 | 高级，确保共享剪贴板和拖放功能都设置为双向。点击 OK 保存设置。
- en: At this point, the Linux VM is configured to use Host-only mode, and INetSim
    is set up to simulate all the services. The last step is to take a snapshot (clean
    snapshot) and give it a name of your choice so that you can revert it back to
    the clean state when required. To take a snapshot on  VMware workstation, click
    on VM | Snapshot | Take Snapshot. On Virtualbox, the same can be done by clicking
    on Machine | Take Snapshot.
  id: totrans-105
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 此时，Linux 虚拟机已配置为使用 Host-only 模式，并且 INetSim 已设置为模拟所有服务。最后一步是创建一个快照（干净快照），并给它取一个你选择的名称，这样你在需要时可以将其恢复到干净的状态。在
    VMware Workstation 中，点击 VM | Snapshot | Take Snapshot 来创建快照。在 VirtualBox 中，同样可以通过点击
    Machine | Take Snapshot 来完成。
- en: Apart from the *drag and drop* feature, it is also possible to transfer files
    from the host machine to the virtual machine using shared folders; refer to the
    following for VirtualBox ([https://www.virtualbox.org/manual/ch04.html#sharedfolders](https://www.virtualbox.org/manual/ch04.html#sharedfolders))
    and to the following for VMware ([https://docs.vmware.com/en/VMware-Workstation-Pro/14.0/com.vmware.ws.using.doc/GUID-AACE0935-4B43-43BA-A935-FC71ABA17803.html](https://docs.vmware.com/en/VMware-Workstation-Pro/14.0/com.vmware.ws.using.doc/GUID-AACE0935-4B43-43BA-A935-FC71ABA17803.html)).
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 除了 *拖放* 功能外，还可以通过共享文件夹将文件从宿主机传输到虚拟机；有关 VirtualBox 的说明，请参考以下链接（[https://www.virtualbox.org/manual/ch04.html#sharedfolders](https://www.virtualbox.org/manual/ch04.html#sharedfolders)），有关
    VMware 的说明，请参考以下链接（[https://docs.vmware.com/en/VMware-Workstation-Pro/14.0/com.vmware.ws.using.doc/GUID-AACE0935-4B43-43BA-A935-FC71ABA17803.html](https://docs.vmware.com/en/VMware-Workstation-Pro/14.0/com.vmware.ws.using.doc/GUID-AACE0935-4B43-43BA-A935-FC71ABA17803.html)）。
- en: 5.4 Setting Up And Configuring Windows VM
  id: totrans-107
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5.4 设置和配置 Windows 虚拟机
- en: 'Before setting up the Windows VM, you first need to install a Windows operating
    system (Windows 7, Window 8, and so on) of your choice in the virtualization software
    (such as VMware or VirtualBox). Once you have Windows installed, follow these
    steps:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 在设置 Windows 虚拟机之前，首先需要在虚拟化软件（如 VMware 或 VirtualBox）中安装你选择的 Windows 操作系统（例如 Windows
    7、Windows 8 等）。安装 Windows 后，按照以下步骤操作：
- en: Download Python from [https://www.python.org/downloads/](https://www.python.org/downloads/).
    Be sure to download *Python 2.7.x* (such as 2.7.13); most of the scripts used
    in this book are written to run on the Python 2.7 version and may not run correctly
    on Python 3\. After you've downloaded the file, run the installer. Make sure you
    check the option to install pip and Add python.exe to Path, as shown in the following
    screenshot. Installing pip will make it easier to install any third-party Python
    libraries, and adding Python to the path will make it easier to run Python from
    any location.
  id: totrans-109
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从 [https://www.python.org/downloads/](https://www.python.org/downloads/) 下载
    Python。确保下载 *Python 2.7.x* 版本（例如 2.7.13）；本书中使用的大多数脚本是为 Python 2.7 版本编写的，可能无法在
    Python 3 中正确运行。下载文件后，运行安装程序。确保勾选安装 pip 以及将 python.exe 添加到路径中的选项，如下截图所示。安装 pip
    可以方便地安装任何第三方 Python 库，添加 Python 到路径中则可以在任何位置运行 Python。
- en: '![](../images/00009.jpeg)'
  id: totrans-110
  prefs: []
  type: TYPE_IMG
  zh: '![](../images/00009.jpeg)'
- en: Configure your Windows VM to run in Host-only network configuration mode. To
    do that in VMware or VirtualBox, bring up the Network Settings and choose the
    Host-only mode; save the settings and reboot **(t**his step is similar to the
    one covered in the *Setting Up and Configuring Linux VM* section).
  id: totrans-111
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将 Windows 虚拟机配置为使用 Host-only 网络配置模式。要在 VMware 或 VirtualBox 中做到这一点，请打开网络设置并选择
    Host-only 模式；保存设置后重启虚拟机 **（此步骤类似于 *设置和配置 Linux 虚拟机* 部分的内容）**。
- en: Configure the IP address of the Windows VM to `192.168.1.x` (choose any IP address
    except `192.168.1.100` because the Linux VM is set to use that IP) and set up
    your Default gateway and the DNS server to the IP address of Linux VM (that is, `192.168.1.100`),
    as shown in the following screenshot*.* This configuration is required so that
    when we execute the hostile program on the Windows VM, all of the network traffic
    will be routed through the Linux VM.
  id: totrans-112
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将 Windows 虚拟机的 IP 地址配置为 `192.168.1.x`（选择任何 IP 地址，但不能是 `192.168.1.100`，因为该 IP
    已配置给 Linux 虚拟机使用），并将默认网关和 DNS 服务器设置为 Linux 虚拟机的 IP 地址（即 `192.168.1.100`），如下面的截图所示*。*
    这样配置是为了在我们执行 Windows 虚拟机上的恶意程序时，所有的网络流量都会通过 Linux 虚拟机进行转发。
- en: '![](../images/00010.jpeg)'
  id: totrans-113
  prefs: []
  type: TYPE_IMG
  zh: '![](../images/00010.jpeg)'
- en: 'Power on both the Linux VM and the Window VM, and make sure they can communicate
    with each other. You can check for the connectivity by running the ping command,
    as shown in this screenshot:'
  id: totrans-114
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动 Linux 虚拟机和 Windows 虚拟机，并确保它们可以相互通信。您可以通过运行 ping 命令来检查连接性，如此屏幕截图所示：
- en: '![](../images/00011.jpeg)'
  id: totrans-115
  prefs: []
  type: TYPE_IMG
  zh: '![](../images/00011.jpeg)'
- en: 'Windows Defender Service needs to be disabled on your Windows VM as it may
    interfere when you are executing the malware sample. To do that, press the *Windows
    key + R* to open the Run menu, enter *gpedit.msc*, and hit *Enter* to launch the
    Local Group Policy Editor. In the left-hand pane of Local Group Policy Editor,
    navigate to Computer Configuration | Administrative Templates | Windows Components
    | Windows Defender. In the right-hand pane, double-click on the Turn off Windows
    Defender policy to edit it; then select Enabled and click on OK:'
  id: totrans-116
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: Windows Defender 服务需要在您的 Windows 虚拟机上禁用，因为在执行恶意软件样本时可能会产生干扰。要做到这一点，请按下*Windows
    键 + R*打开运行菜单，输入*gpedit.msc*，然后按*Enter*启动本地组策略编辑器。在本地组策略编辑器的左侧窗格中，导航至计算机配置 | 管理模板
    | Windows 组件 | Windows Defender。在右侧窗格中，双击“关闭 Windows Defender 策略”进行编辑；然后选择启用并点击确定：
- en: '![](../images/00012.jpeg)'
  id: totrans-117
  prefs: []
  type: TYPE_IMG
  zh: '![](../images/00012.jpeg)'
- en: To be able to transfer files (drag and drop) and to copy clipboard content between
    the host machine and the Windows VM, follow the instructions as mentioned in S*tep
    7 of* the *Setting Up and Configuring Linux VM* section*.*
  id: totrans-118
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为了能够在主机机器和 Windows 虚拟机之间传输文件（拖放）和复制剪贴板内容，请按照*Linux 虚拟机设置和配置*部分的*第 7 步*中提到的说明进行操作。
- en: Take a clean snapshot so that you can revert to the pristine/clean state after
    every analysis. The procedure to take a snapshot was covered in *Step 10 of* the
    *Setting Up and Configuring Linux VM* section*.*
  id: totrans-119
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个干净的快照，以便在每次分析后恢复到原始/干净状态。拍摄快照的步骤在*Linux 虚拟机设置和配置*部分的*第 10 步*中已经介绍过。
- en: At this point, your lab environment should be ready. The Linux and Windows VMs
    in your clean snapshot should be in Host-only network mode and should be able
    to communicate with each other. Throughout this book, I will be covering various
    malware analysis tools; if you wish to use those tools, you can copy them to the
    clean snapshot on the virtual machines. To keep your clean snapshot up to date,
    just transfer/install those tools on the virtual machines and take a new clean snapshot.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 此时，您的实验环境应该已经准备就绪。您的干净快照中的 Linux 和 Windows 虚拟机应该处于仅主机网络模式，并且应该能够彼此通信。在本书中，我将介绍各种恶意软件分析工具；如果您希望使用这些工具，您可以将它们复制到虚拟机上的干净快照中。为了保持您的干净快照最新，只需将这些工具传输/安装到虚拟机上，并创建一个新的干净快照。
- en: 6\. Malware Sources
  id: totrans-121
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6\. 恶意软件来源
- en: 'Once you have a lab set up, you will need malware samples for performing analysis.
    In this book, I have used various malware samples in the examples, since these
    samples are from real attacks, I have decided not to distribute them as there
    may be legal issues distributing such samples with the book. You can find them
    (or similar samples) by searching various malware repositories. The following
    are some of the sources from where you can get malware samples for your analysis.
    Some of these sources allow you to download malware samples for free (or after
    free registration), and some require you to contact the owner to set up an account,
    after which you will be able to obtain the samples:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦您建立了实验室，您将需要恶意软件样本进行分析。在本书中，我在示例中使用了各种恶意软件样本，由于这些样本来自真实攻击，我决定不随书分发它们，因为分发此类样本可能存在法律问题。您可以通过搜索各种恶意软件存储库来找到它们（或类似样本）。以下是一些可以获取用于分析的恶意软件样本的来源。其中一些来源允许您免费下载恶意软件样本（或免费注册后），而一些则要求您联系所有者建立账户，之后您将能够获取样本：
- en: '*Hybrid Analysis*: [https://www.hybrid-analysis.com/](https://www.hybrid-analysis.com/)'
  id: totrans-123
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*Hybrid Analysis*: [https://www.hybrid-analysis.com/](https://www.hybrid-analysis.com/)'
- en: '*KernelMode.info*: [http://www.kernelmode.info/forum/viewforum.php?f=16](http://www.kernelmode.info/forum/viewforum.php?f=16)'
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*KernelMode.info*: [http://www.kernelmode.info/forum/viewforum.php?f=16](http://www.kernelmode.info/forum/viewforum.php?f=16)'
- en: '*VirusBay*: [https://beta.virusbay.io/](https://beta.virusbay.io/)'
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*VirusBay*: [https://beta.virusbay.io/](https://beta.virusbay.io/)'
- en: '*Contagio malware dump*: [http://contagiodump.blogspot.com/](http://contagiodump.blogspot.com/)'
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*Contagio malware dump*: [http://contagiodump.blogspot.com/](http://contagiodump.blogspot.com/)'
- en: '*AVCaesar*: [https://avcaesar.malware.lu/](https://avcaesar.malware.lu/)'
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*AVCaesar*: [https://avcaesar.malware.lu/](https://avcaesar.malware.lu/)'
- en: '*Malwr*: [https://malwr.com/](https://malwr.com/)'
  id: totrans-128
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*Malwr*: [https://malwr.com/](https://malwr.com/)'
- en: '*VirusShare*: [https://virusshare.com/](https://virusshare.com/)'
  id: totrans-129
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*VirusShare*: [https://virusshare.com/](https://virusshare.com/)'
- en: '*theZoo*: [http://thezoo.morirt.com/](http://thezoo.morirt.com/)'
  id: totrans-130
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*theZoo*: [http://thezoo.morirt.com/](http://thezoo.morirt.com/)'
- en: You can find links to various other malware sources in Lenny Zeltser's blog
    post about [https://zeltser.com/malware-sample-sources/](https://zeltser.com/malware-sample-sources/).
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在Lenny Zeltser的博客文章中找到指向其他各种恶意软件来源的链接，网址为[https://zeltser.com/malware-sample-sources/](https://zeltser.com/malware-sample-sources/)。
- en: If none of the aforementioned methods work for you and you wish to get the malware
    samples used in this book, please feel free to contact the author.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 如果上述方法都不适用，并且你希望获取本书中使用的恶意软件样本，请随时联系作者。
- en: Summary
  id: totrans-133
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 概述
- en: Setting up an isolated lab environment is crucial before analyzing malicious
    programs. While performing malware analysis, you will usually run the hostile
    code to observe its behavior, so having an isolated lab environment will prevent
    the accidental spreading of malicious code to your system or production systems
    on your network. In the next chapter, you will learn about the tools and techniques
    to extract valuable information from the malware specimen using *Static Analysis.*
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 在分析恶意程序之前，建立一个隔离的实验室环境至关重要。在进行恶意软件分析时，你通常会运行敌对代码以观察其行为，因此，拥有一个隔离的实验室环境将防止恶意代码意外传播到你的系统或网络中的生产系统。在下一章中，你将学习如何使用*静态分析*提取恶意软件样本中的有价值信息。
