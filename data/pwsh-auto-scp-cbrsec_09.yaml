- en: '9'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '9'
- en: Blue Team Tasks and Cookbook
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 蓝队任务与食谱
- en: As a member of the blue team, your primary goal is to protect your organization’s
    systems and networks from cyber threats. However, this is no easy task. The threat
    landscape is constantly evolving, and you may be faced with challenges such as
    managing and analyzing large amounts of data, coordinating with other teams, and
    ensuring compliance with regulations.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 作为蓝队成员，你的主要目标是保护组织的系统和网络免受网络威胁。然而，这不是一项简单的任务。威胁环境不断变化，你可能面临一些挑战，如管理和分析大量数据、与其他团队协调以及确保遵守规定。
- en: In this chapter, we’ll first take a closer look at the *protect, detect, and
    respond* approach and some of the challenges that blue teamers face. Next, we
    will explore an overview of some useful open source tools written in PowerShell
    that can help you in your daily practice as a blue teamer. Finally, we will look
    at the blue team cookbook, a collection of PowerShell snippets that can come in
    handy in your daily work as a blue team practitioner.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本章中，我们首先将更详细地探讨*保护、检测和响应*方法及蓝队员面临的一些挑战。接下来，我们将介绍一些有用的 PowerShell 开源工具概览，这些工具可以帮助你作为蓝队员在日常工作中提高效率。最后，我们将探讨蓝队食谱——这是一些
    PowerShell 代码片段的集合，可以在你作为蓝队从业者的日常工作中派上用场。
- en: 'In this chapter, we will discuss the following topics:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将讨论以下主题：
- en: Understanding the protect, detect, and respond approach
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 理解保护、检测和响应方法
- en: Common PowerShell blue team tools
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 常见的 PowerShell 蓝队工具
- en: The blue team cookbook
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 蓝队食谱
- en: Technical requirements
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'To get the most out of this chapter, ensure that you have the following:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 为了最大化地从本章中获益，请确保你具备以下条件：
- en: Windows PowerShell 5.1
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows PowerShell 5.1
- en: PowerShell 7.3 and above
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: PowerShell 7.3 或更高版本
- en: Visual Studio Code
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Visual Studio Code
- en: 'Access to the GitHub repository for this chapter:'
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 访问本章的 GitHub 仓库：
- en: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter09](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter09)'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter09](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter09)'
- en: Protect, detect, and respond
  id: totrans-15
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 保护、检测和响应
- en: Being a blue teamer is not an easy thing to do. You need to constantly keep
    up with the evolving threat landscape and stay up to date. While a red teamer
    needs to find just one single vulnerability to be successful, a blue teamer needs
    to watch for everything, as one little error already means that your network could
    be compromised.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 成为一个蓝队成员并非易事。你需要不断跟进不断变化的威胁环境，并保持最新状态。尽管红队员只需要找到一个漏洞就能成功，但蓝队员则需要注意所有细节，因为一个小小的错误就可能导致你的网络遭到入侵。
- en: Blue teamers not only need to configure and manage their systems but also analyze
    large amounts of data and coordinate with other teams. They need to ensure compliance
    with regulations and standards. And while they do all that, they need to keep
    the right balance between security and usability, ensuring that their users don’t
    get overwhelmed with all the security measures and try to bypass them by themselves.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 蓝队员不仅需要配置和管理他们的系统，还需要分析大量数据并与其他团队协调。他们还需要确保遵守相关的规定和标准。在做这些工作的同时，他们需要保持安全性与可用性之间的正确平衡，确保用户不会因过多的安全措施而感到困扰，并试图绕过它们。
- en: To help keep track of everything that needs to be taken into account, categorizing
    tasks into **protect**, **detect**, and **respond** types can help. This is an
    approach to secure your organization’s systems, as well as its network. It is
    structured into three different areas – protection, detection, and response. Every
    pillar is of equal importance to keep your infrastructure safe.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 为了帮助跟踪需要考虑的所有事项，将任务分类为**保护**、**检测**和**响应**类型会有所帮助。这是保护组织系统和网络的一种方法，结构分为三个不同的领域——保护、检测和响应。每个支柱都同样重要，以确保你的基础设施安全。
- en: '![Figure 9.1 – The protect, detect, and respond approach](image/B16679_09_001.jpg)'
  id: totrans-19
  prefs: []
  type: TYPE_IMG
  zh: '![图 9.1 – 保护、检测和响应方法](image/B16679_09_001.jpg)'
- en: Figure 9.1 – The protect, detect, and respond approach
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 图 9.1 – 保护、检测和响应方法
- en: Many companies just focus on the protection part, although detection and response
    are also very important to keep adversaries out of your network.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 许多公司仅关注保护部分，尽管检测和响应同样对保持敌人远离网络至关重要。
- en: Let’s explore what each area covers in the following subsections.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们在接下来的小节中深入探讨每个领域的内容。
- en: Protection
  id: totrans-23
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 保护
- en: 'The goal of **protection** measures is to mitigate security risks and implement
    controls to reduce and block threats *before they happen*. Protection measures
    could include the following:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: '**保护**措施的目标是减轻安全风险并实施控制，以减少和阻止威胁的发生，*在它们发生之前*。保护措施可能包括以下内容：'
- en: Regularly updating systems and monitoring them to fix vulnerabilities that could
    be exploited by attackers.
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 定期更新系统并监控它们，以修复可能被攻击者利用的漏洞。
- en: Implementing user authentication and authorization to ensure that only authorized
    users have access to data and systems. The least privilege approach also needs
    to be followed.
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实施用户身份验证和授权，确保只有授权用户才能访问数据和系统。同时也需要遵循最小权限原则。
- en: Encrypting sensitive data to minimize the risk of it being accessed by unauthorized
    users. Encrypt hard drives to avoid credential theft from a person that has physical
    access or even data theft if a device was stolen.
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 加密敏感数据，以减少未经授权用户访问的风险。加密硬盘，以防止具有物理访问权限的人盗取凭证，甚至在设备被盗时发生数据泄露。
- en: Implementing security policies, baselines, and access control to ensure that
    systems are configured as safely as possible. A strong password policy also needs
    to be introduced.
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实施安全策略、基准和访问控制，以确保系统尽可能安全地配置。同时还需要引入强密码策略。
- en: Deploying firewalls and **intrusion detection systems** (**IDSs**)/intrusion
    **prevention systems** (**IPSs**) to block unauthorized activities and detect
    suspicious activities.
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 部署防火墙和**入侵检测系统**（**IDSs**）/入侵**防御系统**（**IPSs**），以阻止未经授权的活动并检测可疑活动。
- en: Of course, protection mechanisms could also have a second purpose, such as an
    IDS or IPS, which not only blocks suspicious activities but also detects and alerts
    you to them. Therefore, this solution could also be a part of the **detection**
    area.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，保护机制也可能有第二个目的，例如IDS或IPS，它不仅能阻止可疑活动，还能检测并提醒你这些活动。因此，这种解决方案也可以是**检测**领域的一部分。
- en: Detection
  id: totrans-31
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检测
- en: 'In the detection phase, the goal is to identify and report potential security
    threats as quickly as possible. There are various things that you can do to improve
    your detection stance, such as the following:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 在检测阶段，目标是尽快识别和报告潜在的安全威胁。你可以做各种事情来改善你的检测能力，例如：
- en: Collecting and analyzing event logs about potential security breaches, such
    as failed login attempts or configuration changes.
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 收集和分析关于潜在安全漏洞的事件日志，如失败的登录尝试或配置更改。
- en: Monitoring network activity for anomalies and suspicious behavior, such as users
    that are logging in to machines that they usually never log in to or attempts
    to access restricted resources. Another example would be if PowerShell (or other)
    code was executed from a workstation of a person that usually never runs code,
    such as employees from accounting or marketing.
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监控网络活动中的异常和可疑行为，例如用户登录到他们通常从未登录过的机器，或者尝试访问受限资源。另一个例子是，如果从通常不运行代码的工作站（如会计或市场部门的员工）执行了PowerShell（或其他）代码。
- en: Evaluating security alerts from antivirus software and IDSs/IPSs.
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 评估来自杀毒软件和IDSs/IPSs的安全警报。
- en: Regularly scanning your network for vulnerabilities to identify potential weaknesses
    that could be abused by adversaries. Also, periodically hire external penetration
    testers to check your security.
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 定期扫描你的网络漏洞，以识别可能被对手利用的潜在弱点。同时，定期聘请外部渗透测试人员检查你的安全性。
- en: Implementing good detection measures will help you raise your awareness of what
    happens in your network. This allows you to act on potential security threats
    in the response phase.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 实施良好的检测措施将有助于提高你对网络中发生的事件的意识。这使你能够在响应阶段对潜在的安全威胁作出反应。
- en: Response
  id: totrans-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 响应
- en: 'If a security threat was detected, it means that you need to act on it quickly
    to reduce the risk and restore systems to a secure state. This can involve a variety
    of activities, such as the following:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 如果检测到安全威胁，意味着你需要迅速采取行动，以减少风险并将系统恢复到安全状态。这可能涉及多种活动，例如：
- en: Isolating compromised systems to prevent further damage and the threat spreading
    within an environment.
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 隔离受损的系统，以防止进一步的损害和威胁在环境内传播。
- en: Gathering forensic data from affected systems and analyzing it. This helps to
    identify the attack source and determine the extent of the damage. It can also
    help to mitigate future threats.
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从受影响的系统中收集法医数据并进行分析。这有助于识别攻击来源并确定损害的程度。它还可以帮助减轻未来的威胁。
- en: 'Restoring systems to a secure state, which may involve repairing or reinstalling
    them in accordance with the NIST **Cybersecurity Framework** (NIST **CSF**) guidelines:'
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 恢复系统至安全状态，这可能涉及根据 NIST **网络安全框架**（NIST **CSF**）指南修复或重新安装系统：
- en: '[https://www.nist.gov/cyberframework/framework](https://www.nist.gov/cyberframework/framework)'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://www.nist.gov/cyberframework/framework](https://www.nist.gov/cyberframework/framework)'
- en: Implementing additional security controls to prevent similar threats in the
    future.
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实施额外的安全控制措施，以防止未来类似的威胁。
- en: All three pillars combined build the protect, detect, and respond life cycle
    and should always be focused on with equal importance.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 这三大支柱共同构建了保护、检测和响应的生命周期，应该始终平等重视。
- en: There are also many open source tools that can support a blue teamer to pursue
    the protect, detect, and respond approach. In the next section, we will explore
    some of them.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 也有许多开源工具可以支持蓝队成员采用保护、检测和响应的方法。在接下来的章节中，我们将探讨其中一些工具。
- en: Common PowerShell blue team tools
  id: totrans-47
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 常见的 PowerShell 蓝队工具
- en: As a blue teamer, you are constantly on the lookout for tools and techniques
    that can help you protect your organization’s systems and networks from cyber
    threats.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 作为蓝队成员，你时刻在寻找能够帮助你保护组织系统和网络免受网络威胁的工具和技术。
- en: In this section, we’ll explore some common PowerShell open source tools that
    can be particularly helpful for blue teamers. These tools can assist with tasks
    such as analyzing system logs, gathering system information, and detecting malicious
    activity. Some of the tools can also help with tasks such as analyzing the attack
    surface of a system, identifying and decoding potentially malicious data, and
    searching for indicators of compromise. By leveraging these tools, you can streamline
    your workflows and more effectively defend your organization against cyber threats.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将探索一些常见的 PowerShell 开源工具，这些工具对蓝队成员特别有帮助。这些工具可以协助执行诸如分析系统日志、收集系统信息和检测恶意活动等任务。有些工具还可以帮助分析系统的攻击面、识别和解码潜在的恶意数据，以及搜索入侵指示符。通过利用这些工具，你可以简化工作流程，更有效地保护组织免受网络威胁。
- en: PSGumshoe
  id: totrans-50
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: PSGumshoe
- en: '**PSGumshoe** is a powerful PowerShell module that is designed to assist with
    tasks such as live response, hunt, and forensics. Developed by Carlos Perez, this
    open source tool is designed to help blue teamers collect artifacts from a variety
    of sources. Whether you are investigating a security incident, conducting a hunt
    for indicators of compromise, or performing forensic analysis, PSGumshoe can be
    a valuable asset in your toolkit. It also has functions included to support retrieving
    data from Sysmon-generated events or to track **Windows Management Instrumentation**
    (**WMI**) activity.'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: '**PSGumshoe** 是一个强大的 PowerShell 模块，旨在协助执行实时响应、追踪和取证等任务。由 Carlos Perez 开发，这个开源工具专为蓝队成员设计，帮助他们从各种来源收集证据。无论你是在调查安全事件、进行入侵指示符（IOC）的搜寻，还是执行取证分析，PSGumshoe
    都可以成为你工具箱中的一个宝贵资产。它还包括支持从 Sysmon 生成的事件中检索数据，或跟踪 **Windows Management Instrumentation**（**WMI**）活动的功能。'
- en: 'You can install PSGumshoe from PowerShell Gallery using the **Install-Module
    PSGumshoe** command or download it from GitHub: [https://github.com/PSGumshoe/PSGumshoe](https://github.com/PSGumshoe/PSGumshoe).'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过 PowerShell Gallery 使用 **Install-Module PSGumshoe** 命令安装 PSGumshoe，或者从
    GitHub 下载： [https://github.com/PSGumshoe/PSGumshoe](https://github.com/PSGumshoe/PSGumshoe)。
- en: PowerShellArsenal
  id: totrans-53
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: PowerShellArsenal
- en: '**PowerShellArsenal** is a PowerShell module developed by Matt Graeber that
    is designed to assist reverse engineers in a variety of tasks. With its wide range
    of features and capabilities, this tool can help you disassemble code, perform
    .NET malware analysis, analyze and parse memory structures, and much more. Whether
    you are a seasoned reverse engineer or just starting out, PowerShellArsenal can
    be a valuable addition to your toolkit.'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: '**PowerShellArsenal** 是 Matt Graeber 开发的 PowerShell 模块，旨在帮助逆向工程师完成多种任务。凭借其广泛的功能和能力，这个工具可以帮助你反汇编代码、执行
    .NET 恶意软件分析、分析和解析内存结构等等。无论你是经验丰富的逆向工程师，还是刚刚入门，PowerShellArsenal 都能成为你工具箱中的有力助手。'
- en: 'It can be downloaded and installed as a module from GitHub: [https://github.com/mattifestation/PowerShellArsenal](https://github.com/mattifestation/PowerShellArsenal).'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 它可以作为模块从 GitHub 下载并安装： [https://github.com/mattifestation/PowerShellArsenal](https://github.com/mattifestation/PowerShellArsenal)。
- en: AtomicTestHarnesses
  id: totrans-56
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: AtomicTestHarnesses
- en: '**AtomicTestHarnesses** is a PowerShell module that allows you to simulate
    and validate the execution of attack techniques. With a PowerShell component for
    Windows and a Python component for macOS and Linux, this tool can be used across
    platforms.'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: '**AtomicTestHarnesses** 是一个 PowerShell 模块，允许你模拟和验证攻击技术的执行。它具有适用于 Windows 的
    PowerShell 组件，以及适用于 macOS 和 Linux 的 Python 组件，可以跨平台使用。'
- en: Developed by Mike Haag, Jesse Brown, Matt Graeber, Jonathan Johnson, and Jared
    Atkinson, AtomicTestHarnesses is a valuable resource for blue teamers who are
    looking to test their defenses and ensure that they are prepared to respond to
    real-world attacks.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: AtomicTestHarnesses 由 Mike Haag、Jesse Brown、Matt Graeber、Jonathan Johnson 和
    Jared Atkinson 开发，是蓝队成员在测试防御并确保能够应对现实攻击时的宝贵资源。
- en: 'You can easily install AtomicTestHarnesses from the PowerShell gallery using
    the **Install-Module -Name AtomicTestHarnesses** command, or you can download
    it from GitHub at the following link: [https://github.com/redcanaryco/AtomicTestHarnesses](https://github.com/redcanaryco/AtomicTestHarnesses).'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过 **Install-Module -Name AtomicTestHarnesses** 命令从 PowerShell gallery 安装
    AtomicTestHarnesses，或者通过以下链接从 GitHub 下载：[https://github.com/redcanaryco/AtomicTestHarnesses](https://github.com/redcanaryco/AtomicTestHarnesses)。
- en: PowerForensics
  id: totrans-60
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: PowerForensics
- en: '**PowerForensics** is a powerful framework for hard drive forensics developed
    by Jared Atkinson. Currently supporting **NTFS** (**New Technology File System**)
    and **FAT** (**File Allocation Table**) file systems, this tool is designed to
    assist with tasks such as analyzing Windows artifacts, the Windows registry, boot
    sector, and application compatibility cache, as well as creating a forensic timeline.'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: '**PowerForensics** 是由 Jared Atkinson 开发的强大硬盘取证框架。目前支持 **NTFS**（**新技术文件系统**）和
    **FAT**（**文件分配表**）文件系统，该工具旨在协助分析 Windows 遗留物、Windows 注册表、引导扇区和应用程序兼容性缓存等任务，并能够创建取证时间线。'
- en: 'With its extensive range of features and capabilities, PowerForensics is an
    invaluable resource for blue teamers who need to conduct forensic analysis on
    hard drives. You can easily install PowerForensics from the PowerShell gallery
    using the **Install-Module PowerForensics** command, or you can download it from
    GitHub at the following link: [https://github.com/Invoke-IR/PowerForensics](https://github.com/Invoke-IR/PowerForensics).'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: PowerForensics 具备广泛的功能和能力，是蓝队成员进行硬盘取证分析的重要资源。你可以通过 **Install-Module PowerForensics**
    命令从 PowerShell gallery 安装 PowerForensics，或者通过以下链接从 GitHub 下载：[https://github.com/Invoke-IR/PowerForensics](https://github.com/Invoke-IR/PowerForensics)。
- en: NtObjectManager
  id: totrans-63
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: NtObjectManager
- en: '**NtObjectManager** is an extensive PowerShell module that allows you to access
    the NT Object Manager namespace. It is part of the sandbox attack surface analysis
    tools toolkit (which is also definitely worth a look!) that was developed by James
    Forshaw. The Object Manager itself is a subsystem within Windows that is responsible
    for managing the system’s objects, which represent various system resources such
    as processes, threads, files, and devices.'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: '**NtObjectManager** 是一个广泛的 PowerShell 模块，允许你访问 NT 对象管理器命名空间。它是沙盒攻击面分析工具包的一部分（这个工具包也绝对值得一看！），由
    James Forshaw 开发。对象管理器本身是 Windows 中的一个子系统，负责管理系统的对象，这些对象代表着各种系统资源，如进程、线程、文件和设备。'
- en: The Object Manager is also in charge of creating and deleting objects, as well
    as maintaining the relationships between objects. It also handles object access
    requests, ensuring that only authorized entities are able to access specific objects.
    The Object Manager is an integral part of the operating system and is involved
    in many aspects of system operation, including memory management, process and
    thread management, and I/O operations.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 对象管理器还负责创建和删除对象，以及维护对象之间的关系。它还处理对象访问请求，确保只有授权实体能够访问特定对象。对象管理器是操作系统的一个重要组成部分，涉及系统操作的多个方面，包括内存管理、进程和线程管理以及
    I/O 操作。
- en: The NTObjectManager module offers a wide variety of capabilities, including
    working with symbolic links, auditing RPC servers, manipulating the Object Manager,
    and generally messing around with the Windows operating system.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: NTObjectManager 模块提供了多种功能，包括处理符号链接、审计 RPC 服务器、操作对象管理器，以及通常操作 Windows 操作系统。
- en: 'NtObjectManager can be easily installed using the **Install-Module -Name NtObjectManager**
    command, and the source code can be found on GitHub at the following link: [https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools](https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools).'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: NtObjectManager 可以通过 **Install-Module -Name NtObjectManager** 命令轻松安装，源代码可以在
    GitHub 上找到，链接为：[https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools](https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools)。
- en: DSInternals
  id: totrans-68
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: DSInternals
- en: '**DSInternals** is a powerful Active Directory suite developed by Michael Grafnetter
    that consists of two parts – a framework that exposes various internal components
    of Active Directory that can be accessed from any .NET application, and a PowerShell
    module that provides a range of cmdlets built on top of the framework. The module
    offers extensive functionality, including the ability to audit Azure AD FIDO2
    keys, AD passwords, and key credentials, and perform bare-metal recovery of domain
    controllers.'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: '**DSInternals** 是由 Michael Grafnetter 开发的强大 Active Directory 套件，包含两个部分——一个框架，暴露了
    Active Directory 的各种内部组件，可以从任何 .NET 应用程序中访问；另一个是 PowerShell 模块，提供了一系列基于该框架构建的
    cmdlet。该模块功能广泛，包括能够审计 Azure AD FIDO2 密钥、AD 密码和密钥凭证，并执行域控制器的裸机恢复。'
- en: 'DSInternals can be easily installed using the **Install-Module DSInternals**
    command, or you can download it from GitHub at the following link: [https://github.com/MichaelGrafnetter/DSInternals](https://github.com/MichaelGrafnetter/DSInternals).'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: DSInternals 可以通过 **Install-Module DSInternals** 命令轻松安装，或者通过以下 GitHub 链接下载：[https://github.com/MichaelGrafnetter/DSInternals](https://github.com/MichaelGrafnetter/DSInternals)。
- en: With its many features and capabilities, DSInternals is a valuable resource
    for blue teamers who need to manage and secure their Active Directory environment.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 凭借其众多特性和功能，DSInternals 是蓝队员管理和保护其 Active Directory 环境的重要资源。
- en: PSScriptAnalyzer and InjectionHunter
  id: totrans-72
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: PSScriptAnalyzer 和 InjectionHunter
- en: '**PSScriptAnalyzer** is a tool that helps you improve the quality and security
    of your PowerShell scripts and modules. It checks your code against predefined
    rules and provides recommendations for any potential defects it finds. You can
    install PSScriptAnalyzer using the **Install-Module PSScriptAnalyzer** command,
    or you can download it from GitHub at the following link: [https://github.com/PowerShell/PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer).'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: '**PSScriptAnalyzer** 是一款帮助你提高 PowerShell 脚本和模块质量与安全性的工具。它会根据预定义规则检查你的代码，并为发现的潜在缺陷提供建议。你可以使用
    **Install-Module PSScriptAnalyzer** 命令安装 PSScriptAnalyzer，或者通过以下 GitHub 链接下载：[https://github.com/PowerShell/PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer)。'
- en: '**InjectionHunter** is a module developed by Lee Holmes that helps you detect
    potential opportunities for code injection in your own PowerShell scripts. To
    use InjectionHunter, you need to have PSScriptAnalyzer installed, as it relies
    on the **ScriptAnalyzer.Generic.DiagnosticRecord** output type and uses custom
    detection rules. You can install InjectionHunter using the **Install-Module InjectionHunter**
    command, or you can find it in the PowerShell Gallery at the following link: [https://www.powershellgallery.com/packages/InjectionHunter/1.0.0](https://www.powershellgallery.com/packages/InjectionHunter/1.0.0).'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: '**InjectionHunter** 是由 Lee Holmes 开发的一个模块，帮助你检测自己 PowerShell 脚本中潜在的代码注入机会。要使用
    InjectionHunter，你需要先安装 PSScriptAnalyzer，因为它依赖于 **ScriptAnalyzer.Generic.DiagnosticRecord**
    输出类型并使用自定义检测规则。你可以通过 **Install-Module InjectionHunter** 命令安装 InjectionHunter，或者在
    PowerShell Gallery 中找到它，链接为：[https://www.powershellgallery.com/packages/InjectionHunter/1.0.0](https://www.powershellgallery.com/packages/InjectionHunter/1.0.0)。'
- en: 'Also refer to the official blog post on InjectionHunter: [https://devblogs.microsoft.com/powershell/powershell-injection-hunter-security-auditing-for-powershell-scripts/](https://devblogs.microsoft.com/powershell/powershell-injection-hunter-security-auditing-for-powershell-scripts/).'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 另请参考关于 InjectionHunter 的官方博客文章：[https://devblogs.microsoft.com/powershell/powershell-injection-hunter-security-auditing-for-powershell-scripts/](https://devblogs.microsoft.com/powershell/powershell-injection-hunter-security-auditing-for-powershell-scripts/)。
- en: Later in [*Chapter 13*](B16679_13_Final_PD.xhtml#_idTextAnchor341), *What Else?
    – Further Mitigations and Resources*, we will also take a closer look at both
    tools and how they can be used.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 在 [*第13章*](B16679_13_Final_PD.xhtml#_idTextAnchor341) *还有什么？——更多缓解措施和资源* 中，我们还将更深入地了解这两个工具以及如何使用它们。
- en: Revoke-Obfuscation
  id: totrans-77
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Revoke-Obfuscation
- en: '**Revoke-Obfuscation** is a PowerShell obfuscation detection framework developed
    by Daniel Bohannon and Lee Holmes. Compatible with PowerShell v3 and later, this
    tool helps blue teamers detect obfuscated PowerShell scripts and commands at scale.
    Unlike other solutions that rely on simple **indicators of compromise** (**IOCs**)
    or regular expression matching, Revoke-Obfuscation uses PowerShell’s **abstract
    syntax tree** (**AST**) to extract features from a script, making it more robust
    in detecting even unknown obfuscation techniques.'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: '**Revoke-Obfuscation**是由Daniel Bohannon和Lee Holmes开发的PowerShell混淆检测框架。它兼容PowerShell
    v3及更高版本，帮助蓝队员大规模检测混淆的PowerShell脚本和命令。与依赖简单**妥协指示器**（**IOCs**）或正则表达式匹配的其他解决方案不同，Revoke-Obfuscation使用PowerShell的**抽象语法树**（**AST**）从脚本中提取特征，使其在检测未知混淆技术时更加可靠。'
- en: 'You can easily install Revoke-Obfuscation using the **Install-Module Revoke-Obfuscation**
    command, or you can download it from GitHub at the following link: [https://github.com/danielbohannon/Revoke-Obfuscation](https://github.com/danielbohannon/Revoke-Obfuscation).'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过**Install-Module Revoke-Obfuscation**命令轻松安装Revoke-Obfuscation，或者你也可以通过以下GitHub链接下载：[https://github.com/danielbohannon/Revoke-Obfuscation](https://github.com/danielbohannon/Revoke-Obfuscation)。
- en: Posh-VirusTotal
  id: totrans-80
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Posh-VirusTotal
- en: As a defender, it’s critical to regularly check files, domains, IPs, and URLs
    for malware. One popular service to do this is **VirusTotal** ([https://www.virustotal.com](https://www.virustotal.com)),
    which allows you to quickly check whether a file hash or URL is considered malicious
    and whether it would be detected by one or more security vendors. However, manually
    uploading each file or checking URLs one by one can be time-consuming and tedious.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 作为防御者，定期检查文件、域名、IP和URL以发现恶意软件是至关重要的。**VirusTotal**（[https://www.virustotal.com](https://www.virustotal.com)）是一个常用服务，允许你快速检查文件哈希或URL是否被认为是恶意的，并且它是否会被一个或多个安全厂商检测到。然而，手动上传每个文件或逐个检查URL可能会耗时且繁琐。
- en: That’s where the PowerShell module **Posh-VirusTotal** comes in. Developed by
    Carlos Perez, this tool enables you to automate your VirusTotal submissions and
    save time in your busy schedule. It’s compatible with PowerShell v3 and higher
    and can use either the public or private version 2 API provided by VirusTotal.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 这就是PowerShell模块**Posh-VirusTotal**的作用所在。由Carlos Perez开发，这个工具可以自动化你的VirusTotal提交，节省你宝贵的时间。它兼容PowerShell
    v3及更高版本，并且可以使用VirusTotal提供的公共或私有版本2 API。
- en: 'You can easily install Posh-VirusTotal using the **Install-Module Posh-VirusTotal**
    command, or you can download it from GitHub at the following link: https://github.com/darkoperator/Posh-VirusTotal.'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过**Install-Module Posh-VirusTotal**命令轻松安装Posh-VirusTotal，或者你也可以通过以下GitHub链接下载：https://github.com/darkoperator/Posh-VirusTotal。
- en: If you’re using an older version of PowerShell, such as v3, you can also install
    Posh-VirusTotal using the **iex (New-Object** **Net.WebClient).DownloadString("https://gist.githubusercontent.com/darkoperator/9138373/raw/22fb97c07a21139a398c2a3d6ca7e3e710e476bc/PoshVTInstall.ps1")**
    command.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你使用的是较旧版本的PowerShell（如v3），你也可以使用**iex (New-Object** **Net.WebClient).DownloadString("https://gist.githubusercontent.com/darkoperator/9138373/raw/22fb97c07a21139a398c2a3d6ca7e3e710e476bc/PoshVTInstall.ps1")**命令来安装Posh-VirusTotal。
- en: With Posh-VirusTotal, you can streamline your malware checks and stay one step
    ahead of threats.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 使用Posh-VirusTotal，你可以简化恶意软件检查，并走在威胁的前面。
- en: EventList
  id: totrans-86
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: EventList
- en: '**EventList** is a useful tool that I developed to help you improve your audit
    capabilities and build a more effective **security operations center** (**SOC**).
    Developed to combine Microsoft security baselines with MITRE ATT&CK, EventList
    enables you to generate hunting queries for your SIEM system, regardless of the
    product you use.'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: '**EventList**是我开发的一个有用工具，旨在帮助你提升审计能力，构建一个更有效的**安全运营中心**（**SOC**）。EventList结合了Microsoft的安全基准和MITRE
    ATT&CK，能够帮助你为SIEM系统生成猎杀查询，无论你使用的是哪个产品。'
- en: By leveraging the power of EventList, you can take a proactive approach to detecting
    and responding to security threats.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 通过利用EventList的强大功能，你可以采取主动的方式来检测和应对安全威胁。
- en: 'It can be installed using the **Install-Module EventList** command or downloaded
    from GitHub: [https://github.com/miriamxyra/EventList](https://github.com/miriamxyra/EventList).'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 它可以通过**Install-Module EventList**命令安装，或者从GitHub下载：[https://github.com/miriamxyra/EventList](https://github.com/miriamxyra/EventList)。
- en: JEAnalyzer
  id: totrans-90
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: JEAnalyzer
- en: '**Just Enough Administration** (**JEA**) is a powerful tool to secure the PowerShell
    commands that administrators and users are allowed to use in your environment.
    However, configuring and auditing JEA roles can be a tedious and time-consuming
    task. That’s where JEAnalyzer comes in.'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: '**Just Enough Administration**（**JEA**）是一个强大的工具，用于保护管理员和用户在您的环境中允许使用的PowerShell命令。然而，配置和审计JEA角色可能是一项繁琐且耗时的任务。这就是JEAnalyzer派上用场的地方。'
- en: Developed by Miriam Wiesner and Friedrich Weinmann, this tool simplifies the
    implementation and management of JEA, as well as providing tools to scan commands
    for potential danger when exposed in a JEA endpoint and creating JEA endpoints
    simply and conveniently.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 由Miriam Wiesner和Friedrich Weinmann开发，这个工具简化了JEA的实现和管理，并提供了扫描命令潜在危险的工具，当命令暴露在JEA端点时，可以轻松创建JEA端点。
- en: 'You can easily install JEAnalyzer using the **Install-Module JEAnalyzer** command,
    or you can download it from GitHub at the following link: https://github.com/PSSecTools/JEAnalyzer.'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过**Install-Module JEAnalyzer**命令轻松安装JEAnalyzer，或者您可以从GitHub下载它，链接如下：https://github.com/PSSecTools/JEAnalyzer。
- en: All these PowerShell modules come in very handy for blue teamers, as they can
    assist in tasks such as live response, hunt, forensics, and reverse engineering.
    These tools can help streamline workflows and defend against cyber threats by
    analyzing system logs, gathering system information, detecting malicious activity,
    analyzing attack surfaces, identifying and decoding potentially malicious data,
    searching for indicators of compromise, and many more use cases.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 所有这些PowerShell模块对蓝队员非常有用，因为它们可以帮助执行诸如实时响应、猎杀、取证和逆向工程等任务。这些工具可以通过分析系统日志、收集系统信息、检测恶意活动、分析攻击面、识别并解码潜在的恶意数据、寻找妥协的指标以及许多其他用例，帮助简化工作流程并防御网络威胁。
- en: Blue team cookbook
  id: totrans-95
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 蓝队菜谱
- en: In the following subsections, you will find some code snippets that come in
    handy for your daily life as a blue team PowerShell practitioner. Blue teaming
    is quite extensive; therefore, you won’t find use cases for every scenario but,
    rather, some of the basics.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下小节中，您将找到一些对蓝队PowerShell从业者日常工作很有帮助的代码片段。蓝队工作范围广泛，因此您不会找到每个场景的用例，而是一些基础的用法。
- en: Also, refer to [*Chapter 8*](B16679_08_Final_PD.xhtml#_idTextAnchor204), *Red
    Team Tasks and Cookbook*, as you will find many red teamer code snippets and scripts
    there that can also sometimes be useful for a blue teamer.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，参阅[*第8章*](B16679_08_Final_PD.xhtml#_idTextAnchor204)，*红队任务和菜谱*，您将在那里找到许多红队代码片段和脚本，这些内容有时也对蓝队员有帮助。
- en: Checking for installed updates
  id: totrans-98
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查已安装的更新
- en: You want to find out which updates were installed on one or more remote systems.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 您想要找出一个或多个远程系统上已安装的更新。
- en: Solution
  id: totrans-100
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use the **Get-InstalledUpdates.ps1** script to scan an IP range for
    installed Windows updates. You can find the script in the GitHub repository of
    this chapter: [https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Get-InstalledUpdates.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Get-InstalledUpdates.ps1).'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用**Get-InstalledUpdates.ps1**脚本扫描IP范围内已安装的Windows更新。您可以在本章的GitHub仓库中找到此脚本：[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Get-InstalledUpdates.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Get-InstalledUpdates.ps1)。
- en: 'Use this example to scan the **172.29.0.10-20** IP range for installed updates:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此示例扫描**172.29.0.10-20** IP范围内已安装的更新：
- en: '[PRE0]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '**-MinIP** represents the smallest last IP address octet, while -**MaxIP**
    represents the highest last IP address octet. Enabling the **-Verbose** parameter
    allows the script to display a detailed output of its actions. It is also possible
    to use the **-MaxJobs** parameter to define how many jobs can be run in parallel
    to check updates.'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: '**-MinIP**表示最小的最后一个IP地址八位组，而-**MaxIP**表示最大的最后一个IP地址八位组。启用**-Verbose**参数会使脚本显示其操作的详细输出。还可以使用**-MaxJobs**参数定义可以并行运行多少个任务来检查更新。'
- en: Checking for missing updates
  id: totrans-105
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查缺失的更新
- en: You want to find out which updates are missing on one or more remote host(s).
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 您想要找出一个或多个远程主机上缺少的更新。
- en: Solution
  id: totrans-107
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use the **Scan-RemoteUpdates.ps1** script to check for missing Windows
    updates – either on the localhost or on one or more remote host(s). You can find
    the script in the GitHub repository of this chapter: [https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Scan-RemoteUpdates.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Scan-RemoteUpdates.ps1).'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用 **Scan-RemoteUpdates.ps1** 脚本检查缺失的 Windows 更新——可以在本地主机上检查，也可以在一个或多个远程主机上检查。你可以在本章的
    GitHub 仓库中找到这个脚本：[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Scan-RemoteUpdates.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Scan-RemoteUpdates.ps1)。
- en: 'Scanning only the localhost is done as follows:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 仅扫描本地主机的方法如下：
- en: '[PRE1]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Scanning for multiple remote hosts is done as follows:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 扫描多个远程主机的方法如下：
- en: '[PRE2]'
  id: totrans-112
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: If the **-Force** parameter is specified, the **wsusscn2.cab** file will be
    deleted if present and a new version will be downloaded. Use the **-CabPath**
    parameter to specify where the **wsusscn2.cab** file should be downloaded. If
    nothing is specified, it will be downloaded to **$env:temp\wsusscn2.cab**. If
    **-DoNotDeleteCabFile** is present, the **wsusscn2.cab** file will not be deleted
    after the check.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 如果指定了 **-Force** 参数，**wsusscn2.cab** 文件（如果存在）将会被删除，并下载新版本。使用 **-CabPath** 参数来指定
    **wsusscn2.cab** 文件的下载位置。如果未指定，它将被下载到 **$env:temp\wsusscn2.cab**。如果存在 **-DoNotDeleteCabFile**，则在检查后
    **wsusscn2.cab** 文件不会被删除。
- en: Reviewing the PowerShell history of all users
  id: totrans-114
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 查看所有用户的 PowerShell 历史记录
- en: During an incident response, you want to review the PowerShell history of all
    users on a system.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 在事件响应期间，你希望查看系统上所有用户的 PowerShell 历史记录。
- en: Solution
  id: totrans-116
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'The **Get-History** cmdlet would only get the current shell’s history, which
    is not very helpful. To review the entire PowerShell history of each user, you
    can loop through the **ConsoleHost_history.txt** files on a system:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: '**Get-History** cmdlet 仅会获取当前 shell 的历史记录，这并不太有帮助。要查看每个用户的整个 PowerShell 历史记录，你可以遍历系统中的
    **ConsoleHost_history.txt** 文件：'
- en: '[PRE3]'
  id: totrans-118
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: In this example, you would loop through all the **ConsoleHost_history.txt**
    files of all users, as well as through the system profile (if available).
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，你将遍历所有用户的 **ConsoleHost_history.txt** 文件，以及系统配置文件（如果可用）。
- en: Inspecting the event log of a remote host
  id: totrans-120
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查远程主机的事件日志
- en: You want to inspect the event log of a remote host and search for specific patterns.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 你想检查远程主机的事件日志并搜索特定的模式。
- en: Solution
  id: totrans-122
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use **Get-WinEvent** to get all events on a (remote) host and filter
    for specific patterns. Please note that the RemoteRegistry service needs to run
    on the remote host in order for the **Get-WinEvent** cmdlet to work remotely:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用 **Get-WinEvent** 获取（远程）主机上的所有事件，并筛选特定的模式。请注意，为了使 **Get-WinEvent** cmdlet
    能够远程工作，远程主机上需要运行 RemoteRegistry 服务：
- en: '[PRE4]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Using this example, you would connect to the remote host, **PSSec-PC01.PSSec.local**,
    and retrieve all events in the **Microsoft-Windows-Powershell/Operational** event
    log and save them into the **$LogEntries** variable. This allows you to quickly
    operate with the events by not always connecting remotely and, instead, operating
    the variable.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 使用这个示例，你将连接到远程主机 **PSSec-PC01.PSSec.local**，并检索 **Microsoft-Windows-Powershell/Operational**
    事件日志中的所有事件，将它们保存到 **$LogEntries** 变量中。这样你可以通过操作变量，而不必每次都远程连接来快速处理事件。
- en: Using the **$LogEntries** variable, you could filter for specific events or
    strings. In this example, we filter for events with the **4104** event ID that
    contain the **"Mimikatz"** string in the message body. The wildcards, *****, indicate
    that other characters could prefix or suffix the search term **"Mimikatz"**.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 **$LogEntries** 变量，你可以筛选特定的事件或字符串。在这个例子中，我们筛选了事件 ID 为 **4104** 的事件，这些事件的消息体中包含
    **"Mimikatz"** 字符串。通配符 ***** 表示在搜索词 **"Mimikatz"** 前后可能会有其他字符。
- en: Please note that if you want to query the PowerShell Core log instead, you would
    need to change the **$EventLog** variable to **"PowerShellCore/Operational"**.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，如果你想查询 PowerShell Core 日志，您需要将**$EventLog**变量更改为**"PowerShellCore/Operational"**。
- en: PowerShell remoting versus the -ComputerName parameter
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 远程访问与 -ComputerName 参数
- en: 'It’s worth mentioning that PowerShell remoting can be used to remotely execute
    any cmdlet, regardless of whether the cmdlet has a **-ComputerName** parameter
    or not. This can be particularly useful in cases where the **-ComputerName** parameter
    does not work, due to closed DCOM ports or other reasons. As an example, to retrieve
    log entries from a remote computer, you can use the following command: – **Invoke-Command
    -ComputerName $ComputerName -ScriptBlock { Get-WinEvent -LogName $EventLog | Where-Object
    Id -eq 4104 | Where-Object Message -like "****Mimikatz" }**.'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 值得一提的是，PowerShell远程执行可以用来远程执行任何cmdlet，无论该cmdlet是否有**-ComputerName**参数。这在**-ComputerName**参数因DCOM端口关闭或其他原因无法使用的情况下尤其有用。例如，要从远程计算机检索日志条目，你可以使用以下命令：–
    **Invoke-Command -ComputerName $ComputerName -ScriptBlock { Get-WinEvent -LogName
    $EventLog | Where-Object Id -eq 4104 | Where-Object Message -like "****Mimikatz"
    }**。
- en: 'You could also assess multiple remote hosts by looping them through using **foreach**,
    as shown in the following example:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以通过使用**foreach**循环来评估多个远程主机，如以下示例所示：
- en: '[PRE5]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: You can assess the events collected using the **$LogEntries** variable. To get
    an overview of how many events were collected from which hosts, you can use **Group-Object**
    and group by **MachineName**.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以评估使用**$LogEntries**变量收集的事件。要概览从哪些主机收集了多少事件，你可以使用**Group-Object**并按**MachineName**分组。
- en: Monitoring to bypass powershell.exe
  id: totrans-133
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 监控以绕过powershell.exe
- en: You want to monitor for the execution of PowerShell without the use of the **powershell.exe**
    binary.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 你希望监控没有使用**powershell.exe**二进制文件的PowerShell执行。
- en: Solution
  id: totrans-135
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To monitor the execution of PowerShell without the use of the **powershell.exe**
    binary, there are two solutions. Option number one is to use the Windows PowerShell
    event log and look for the **400** event ID:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 要在不使用**powershell.exe**二进制文件的情况下监控PowerShell的执行，有两种解决方案。第一种方案是使用Windows PowerShell事件日志，并查找**400**事件ID：
- en: '[PRE6]'
  id: totrans-137
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Since there are multiple legitimate reasons to execute PowerShell without the
    **powershell.exe** binary, you might want to adjust this query to your environment.
    On a regular Windows 10 client system, on which the PowerShell ISE is also used,
    the following code snippet could be helpful:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 由于有许多合法的理由需要在没有**powershell.exe**二进制文件的情况下执行PowerShell，你可能需要根据你的环境调整这个查询。在一台常规的Windows
    10客户端系统上，其中也使用了PowerShell ISE，以下代码片段可能会有帮助：
- en: '[PRE7]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'For option number two, you need to have Sysmon installed on all systems on
    which you want to detect the bypass of the **powershell.exe** binary. Sysmon is
    part of the Sysinternals suite and can be downloaded here: [https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon).'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 对于第二种方案，你需要在所有你想要检测**powershell.exe**二进制文件绕过的系统上安装Sysmon。Sysmon是Sysinternals工具包的一部分，可以在这里下载：[https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon)。
- en: 'Once Sysmon is installed and configured, you will need to look for the following
    DLLs using Sysmon’s event ID 7, **"****Image loaded"**:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦Sysmon安装并配置完毕，你将需要通过Sysmon的事件ID 7，**"****加载的镜像"**，查找以下DLL文件：
- en: '**System.Management.Automation.dll**'
  id: totrans-142
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**System.Management.Automation.dll**'
- en: '**System.Management.Automation.ni.dll**'
  id: totrans-143
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**System.Management.Automation.ni.dll**'
- en: 'You can now search for potential bypasses of the **powershell.exe** binary,
    as shown in the following example:'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，你可以搜索潜在的**powershell.exe**二进制文件绕过，如以下示例所示：
- en: '[PRE8]'
  id: totrans-145
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: If you have an EDR in place that helps you detect similar events, you don’t
    need Sysmon to detect the PowerShell .NET assembly calls, of course.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你已经部署了一个可以帮助你检测类似事件的EDR系统，那么你当然不需要Sysmon来检测PowerShell .NET程序集的调用。
- en: Getting specific firewall rules
  id: totrans-147
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 获取特定的防火墙规则
- en: You want to filter specific firewall rules using PowerShell.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 你想使用PowerShell过滤特定的防火墙规则。
- en: Solution
  id: totrans-149
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can get all firewall rules and filter for specific ones using the **Get-NetFirewallRule**
    cmdlet:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以获取所有防火墙规则，并使用**Get-NetFirewallRule** cmdlet过滤特定规则：
- en: '[PRE9]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'There are many parameter filter options available using **Get-NetFirewallRule**.
    To get, for example, all enabled firewall rules that have the direction inbound
    and are allow rules, use the following command:'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**Get-NetFirewallRule**有许多参数过滤选项。例如，要获取所有启用的防火墙规则，这些规则的方向是入站并且是允许规则，可以使用以下命令：
- en: '[PRE10]'
  id: totrans-153
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'You can also use the **Get-NetFirewallProfile** cmdlet, together with **Get-NetFirewallRule**,
    to retrieve all firewall rules that were created for a particular firewall profile.
    By using the following example, you would get all firewall rules that were created
    for the **Public** firewall profile:'
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 您还可以使用**Get-NetFirewallProfile** cmdlet，结合**Get-NetFirewallRule**，来检索为特定防火墙配置文件创建的所有防火墙规则。通过以下示例，您可以获取为**Public**防火墙配置文件创建的所有防火墙规则：
- en: '[PRE11]'
  id: totrans-155
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Allowing PowerShell communication only for private IP address ranges
  id: totrans-156
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 仅允许 PowerShell 通信通过私有 IP 地址范围
- en: You want to restrict PowerShell communication to happen only in your own network
    and avoid PowerShell communicating to potential C2 servers.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 您希望限制 PowerShell 通信仅在您自己的网络内进行，并避免 PowerShell 与潜在的 C2 服务器进行通信。
- en: Solution
  id: totrans-158
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: Create a new firewall rule using **New-NetFirewallRule** to lock down PowerShell
    communication to private IP address ranges only.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**New-NetFirewallRule**创建新的防火墙规则，只允许 PowerShell 通信通过私有 IP 地址范围。
- en: 'The following example creates a new firewall rule, with the name **Block Outbound
    PowerShell connections**, that restricts Windows PowerShell from establishing
    connections with IP addresses outside of the local network:'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例创建了一个新的防火墙规则，名为**Block Outbound PowerShell connections**，它限制 Windows PowerShell
    仅能与本地网络中的 IP 地址建立连接：
- en: '[PRE12]'
  id: totrans-161
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Use this example and adjust it to your needs. As most organizations still use
    Windows PowerShell as their default PowerShell instance, this example also refers
    to Windows PowerShell. If you are using PowerShell Core as your default PowerShell
    instance, you might want to adjust the path to the program.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此示例并根据需要进行调整。由于大多数组织仍然将 Windows PowerShell 作为默认的 PowerShell 实例，因此此示例也参考了 Windows
    PowerShell。如果您使用 PowerShell Core 作为默认的 PowerShell 实例，您可能需要调整程序的路径。
- en: Isolating a compromised system
  id: totrans-163
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 隔离被攻破的系统
- en: You want to isolate a compromised system.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 您希望隔离一个已被攻破的系统。
- en: Solution
  id: totrans-165
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can do this by using the **New-NetFirewallRule** and **Disable-NetAdapter**
    cmdlets. The following code snippet demonstrates how you can remotely isolate
    a device. First, it sends a message to all users that are currently logged on
    **PSSec-PC01**, then it remotely creates firewall rules to block all inbound and
    outbound connections, and then disables all network adapters:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用**New-NetFirewallRule**和**Disable-NetAdapter** cmdlet 来实现。以下代码片段演示了如何远程隔离设备。首先，它向所有当前登录到**PSSec-PC01**的用户发送消息，然后它远程创建防火墙规则，阻止所有进出连接，并禁用所有网络适配器：
- en: '[PRE13]'
  id: totrans-167
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Just replace **PSSec-PC01** with the computer name of your choice, and feel
    free to adjust the message that will be sent to the computer users.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 只需将**PSSec-PC01**替换为您选择的计算机名称，并且可以自由调整将发送给计算机用户的消息。
- en: Checking out installed software remotely
  id: totrans-169
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查远程安装的软件
- en: You want to find out what software is installed on a remote PC.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 您希望查找远程 PC 上安装了哪些软件。
- en: Solution
  id: totrans-171
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: You can check out what software is installed on a remote PC by using the **Get-CimInstance**
    cmdlet.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用**Get-CimInstance** cmdlet 来查看远程 PC 上安装了哪些软件。
- en: 'The following example code will let you connect to a computer named **PSSec-PC01**
    and find out which software it currently has installed:'
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例代码将允许您连接到名为**PSSec-PC01**的计算机，并查找它当前安装了哪些软件：
- en: '[PRE14]'
  id: totrans-174
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Starting a transcript
  id: totrans-175
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 启动转录
- en: You want to enable an over-the-shoulder transcription to track what is happening
    in a PowerShell session.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 您希望启用肩膀上方的转录功能，以跟踪 PowerShell 会话中的操作。
- en: Solution
  id: totrans-177
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'Enable a transcript on the machine on which you want to track what is happening
    in a PowerShell session. This can be done by either enabling the transcript via
    Group Policy by configuring the **Turn on PowerShell Transcription** option under
    **Windows Components** | **Administrative Templates** | **Windows PowerShell**,
    or by configuring it using PowerShell to configure the registry, as shown in the
    blog article *PowerShell* *♥* *the Blue* *Team*: [https://devblogs.microsoft.com/powershell/powershell-the-blue-team/](https://devblogs.microsoft.com/powershell/powershell-the-blue-team/
    )'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 在您希望跟踪 PowerShell 会话中发生的事情的机器上启用转录。这可以通过通过组策略启用转录来实现，方法是配置**开启 PowerShell 转录**选项，路径为**Windows
    组件** | **管理模板** | **Windows PowerShell**，或者通过 PowerShell 配置注册表来实现，如博客文章*PowerShell*
    *♥* *the Blue* *Team* 中所示：[https://devblogs.microsoft.com/powershell/powershell-the-blue-team/](https://devblogs.microsoft.com/powershell/powershell-the-blue-team/)
- en: 'The following code snippet shows the **Enable-PSTranscription** function, which
    originates from this article:'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 以下代码片段展示了**Enable-PSTranscription**功能，源自本文：
- en: '[PRE15]'
  id: totrans-180
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'If you used this function to enable transcription to the **C:\tmp** folder,
    the syntax would look like this:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你使用此功能启用对 **C:\tmp** 文件夹的转录，语法如下：
- en: '[PRE16]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: You can also use a **Universal Naming Convention** (**UNC**) path to save the
    transcript to a network folder. Make sure to secure the path so that a potential
    attacker cannot access and/or delete it.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以使用 **通用命名约定** (**UNC**) 路径将转录保存到网络文件夹。确保保护该路径，以防潜在的攻击者访问和/或删除它。
- en: 'To centralize PowerShell transcripts and maintain a secure audit trail, you
    can, for example, configure the transcript destination as a UNC path with a dynamic
    filename. This involves setting the transcript directory to a network share with
    write-only permission and using the PowerShell profile to log all activity to
    a file with a unique name, based on system and user variables, such as the following:'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 要集中管理 PowerShell 转录并保持安全的审计跟踪，你可以，例如，将转录目标配置为一个带有动态文件名的 UNC 路径。这涉及将转录目录设置为具有写入权限的网络共享，并使用
    PowerShell 配置文件将所有活动记录到一个基于系统和用户变量的唯一文件名中，如下所示：
- en: '[PRE17]'
  id: totrans-185
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: This will create a unique transcript file for each user and computer combination,
    with the current date and time included in the filename. By storing transcripts
    in a centralized location with restricted access, you can ensure that all activity
    is logged and available for review and analysis as needed.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 这将为每个用户和计算机组合创建一个唯一的转录文件，文件名中将包含当前日期和时间。通过将转录存储在具有受限访问权限的集中位置，可以确保所有活动都被记录，并在需要时可以进行审查和分析。
- en: This will write all transcripts to the specified file server location, which
    can then be accessed by authorized personnel for review and analysis.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 这将把所有转录写入指定的文件服务器位置，然后可以由授权人员进行访问，以便进行审查和分析。
- en: Checking for expired certificates
  id: totrans-188
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查过期证书
- en: You want to check for SSL certificates in your certificate store that have already
    expired or will expire in the next 60 days.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 你需要检查证书存储中已经过期或将在未来 60 天内过期的 SSL 证书。
- en: Solution
  id: totrans-190
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use the following script to check for SSL certificates in your certificate
    store that have already expired or will expire in the next 60 days:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用以下脚本检查证书存储中已经过期或将在未来 60 天内过期的 SSL 证书：
- en: '[PRE18]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: You can also alter the path to **Cert:\LocalMachine\My** to only assess certificates
    from the personal store. For certificates from the **root** store, change the
    path to **Cert:\LocalMachine\Root**.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以修改路径 **Cert:\LocalMachine\My** 仅评估个人存储中的证书。对于 **根** 存储中的证书，请将路径更改为 **Cert:\LocalMachine\Root**。
- en: Checking the digital signature of a file or a script
  id: totrans-194
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查文件或脚本的数字签名
- en: You want to check the authenticity and integrity of software or a script by
    checking the digital signature.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 你想通过检查数字签名来验证软件或脚本的真实性和完整性。
- en: Solution
  id: totrans-196
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can check the status of a digital signature by using the **Get-AuthenticodeSignature**
    cmdlet:'
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用 **Get-AuthenticodeSignature** cmdlet 来检查数字签名的状态：
- en: '[PRE19]'
  id: totrans-198
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'Using **Get-AuthenticodeSignature**, you get all sorts of useful information
    about the digital signature, such as the certificate chain, which is demonstrated
    in the following screenshot:'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 **Get-AuthenticodeSignature**，你可以获取有关数字签名的各种有用信息，例如证书链，下面的截图展示了这一点：
- en: '![Figure 9.2 – Query information about the digital signature of a file](image/B16679_09_002.jpg)'
  id: totrans-200
  prefs: []
  type: TYPE_IMG
  zh: '![图 9.2 – 查询文件的数字签名信息](image/B16679_09_002.jpg)'
- en: Figure 9.2 – Query information about the digital signature of a file
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 图 9.2 – 查询文件的数字签名信息
- en: However, if you prefer to query the status only, you can also use the **(Get-AuthenticodeSignature
    "****C:\Windows\notepad.exe").Status** command.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，如果你仅想查询状态，也可以使用 **(Get-AuthenticodeSignature "****C:\Windows\notepad.exe").Status**
    命令。
- en: Checking file permissions of files and folders
  id: totrans-203
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查文件和文件夹的权限
- en: You want to enumerate the access rights of files and folders.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 你想列举文件和文件夹的访问权限。
- en: Solution
  id: totrans-205
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To enumerate the access rights of files and folders, you can use the **Get-ChildItem**
    and **Get-Acl** cmdlets. To enumerate, for example, all files and folders in the
    **Windows Defender** directory recursively, you can use the following code snippet:'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 要列举文件和文件夹的访问权限，你可以使用 **Get-ChildItem** 和 **Get-Acl** cmdlet。例如，要递归列举 **Windows
    Defender** 目录中的所有文件和文件夹，可以使用以下代码片段：
- en: '[PRE20]'
  id: totrans-207
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: If you want to enumerate on one level only, make sure to remove the **-****Recurse**
    parameter.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你只想列举一级，请确保移除 **-Recurse** 参数。
- en: Displaying all running services
  id: totrans-209
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 显示所有正在运行的服务
- en: You want to display all running services and their command paths.
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 你想显示所有正在运行的服务及其命令路径。
- en: Solution
  id: totrans-211
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'Although you can use the **Get-Service** cmdlet to display all running services,
    you can also use **Get-CimInstance** to access the WMI information of the services
    and get even more information, such as the command path or **ProcessId**:'
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管你可以使用**Get-Service** cmdlet来显示所有正在运行的服务，你也可以使用**Get-CimInstance**来访问服务的WMI信息，并获得更多的信息，如命令路径或**ProcessId**：
- en: '[PRE21]'
  id: totrans-213
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Stopping a service
  id: totrans-214
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 停止服务
- en: You want to stop a service from running.
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要停止一个正在运行的服务。
- en: Solution
  id: totrans-216
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To stop a service from running, you can use the **Stop-Service** cmdlet. The
    following example shows you how to combine **Get-Service** with **Stop-Service**
    to stop the **maliciousService** service:'
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 要停止一个正在运行的服务，你可以使用**Stop-Service** cmdlet。以下示例展示了如何将**Get-Service**与**Stop-Service**结合使用，以停止**maliciousService**服务：
- en: '[PRE22]'
  id: totrans-218
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Keep in mind that if you use the **-Confirm:$false** parameter, the confirmation
    prompt will be bypassed, and the command will be executed without any further
    confirmation. It’s recommended to use this parameter with caution and only in
    situations where you are fully aware of the potential risks and consequences.
    It’s important to thoroughly understand the implications of using this parameter
    and make an informed decision based on your specific use case.
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，如果你使用**-Confirm:$false**参数，确认提示将被绕过，命令将在没有任何进一步确认的情况下执行。建议在使用此参数时要小心，并且仅在你完全意识到潜在风险和后果的情况下使用。了解使用此参数的影响非常重要，并根据你的具体用例做出明智的决定。
- en: Displaying all processes
  id: totrans-220
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 显示所有进程
- en: You want to display all processes, including their owners and command lines.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 你想显示所有进程，包括它们的所有者和命令行。
- en: Solution
  id: totrans-222
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can display all processes and more information about them by using **Get-WmiObject
    win32_process**. To display all processes, including their owners and command
    lines, you can use the following code snippet:'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用**Get-WmiObject win32_process**来显示所有进程及其更多信息。要显示所有进程，包括它们的所有者和命令行，你可以使用以下代码片段：
- en: '[PRE23]'
  id: totrans-224
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: Stopping a process
  id: totrans-225
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 停止进程
- en: You want to stop a process.
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要停止一个进程。
- en: Solution
  id: totrans-227
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To stop a process, you can use the **Stop-Process** cmdlet. To stop, for example,
    the process with **Id 8336**, you can use the following code snippet:'
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 要停止一个进程，你可以使用**Stop-Process** cmdlet。比如，要停止**Id 8336**的进程，你可以使用以下代码片段：
- en: '[PRE24]'
  id: totrans-229
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: It is, of course, also possible to select a process by its name with the **-Name**
    parameter of the **Get-Process** cmdlet to stop it. If there is more than one
    process with the same name, it can happen that multiple processes will be stopped.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，你也可以通过**Get-Process** cmdlet的**-Name**参数按名称选择一个进程来停止它。如果有多个同名进程，可能会停止多个进程。
- en: Keep in mind that if you use the **-Confirm:$false** parameter, the confirmation
    prompt will be bypassed, and the command will be executed without any further
    confirmation. It’s recommended to use this parameter with caution and only in
    situations where you are fully aware of the potential risks and consequences.
    It’s important to thoroughly understand the implications of using this parameter
    and make an informed decision based on your specific use case.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，如果你使用**-Confirm:$false**参数，确认提示将被绕过，命令将在没有任何进一步确认的情况下执行。建议在使用此参数时要小心，并且仅在你完全意识到潜在风险和后果的情况下使用。了解使用此参数的影响非常重要，并根据你的具体用例做出明智的决定。
- en: Disabling a local account
  id: totrans-232
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 禁用本地账户
- en: You want to disable a local account.
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 你想禁用一个本地账户。
- en: Solution
  id: totrans-234
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: To disable a local account, you can use the **Disable-LocalUser** cmdlet.
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 要禁用本地账户，你可以使用**Disable-LocalUser** cmdlet。
- en: One way to improve security in Windows is to create a new user with administrative
    privileges and disable the default **Administrator** account. This helps prevent
    brute-force attacks that often target the default account. To achieve this, you
    can use the **Disable-LocalUser** cmdlet.
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 提高Windows安全性的一种方法是创建一个具有管理员权限的新用户，并禁用默认的**Administrator**账户。这有助于防止通常针对默认账户进行的暴力破解攻击。为了实现这一点，你可以使用**Disable-LocalUser**
    cmdlet。
- en: 'Here’s an example that demonstrates how to disable the **Administrator** account
    using the **Disable-LocalUser** cmdlet:'
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个示例，展示了如何使用**Disable-LocalUser** cmdlet禁用**Administrator**账户：
- en: '[PRE25]'
  id: totrans-238
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'After running the command, you can use the **Get-LocalUser** cmdlet to verify
    that the account has been disabled:'
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 运行命令后，你可以使用**Get-LocalUser** cmdlet来验证账户是否已被禁用：
- en: '[PRE26]'
  id: totrans-240
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: Enabling a local account
  id: totrans-241
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 启用本地账户
- en: You want to enable a local account.
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 你想启用一个本地账户。
- en: Solution
  id: totrans-243
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To enable a local account, you can use the **Enable-LocalUser** cmdlet. Using
    the following example, the **Administrator** account would be enabled:'
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 要启用本地账户，你可以使用**Enable-LocalUser** cmdlet。使用以下示例，**Administrator**账户将被启用：
- en: '[PRE27]'
  id: totrans-245
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Using the **Get-LocalUser** cmdlet, you can verify that the account was enabled:'
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**Get-LocalUser** cmdlet，你可以验证该账户是否已启用：
- en: '[PRE28]'
  id: totrans-247
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: Disabling a domain account
  id: totrans-248
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 禁用域账户
- en: You want to disable a domain account.
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
  zh: 你想禁用一个域账户。
- en: Solution
  id: totrans-250
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To disable a domain account, you can use the **Disable-ADAccount** cmdlet,
    which is part of the **ActiveDirectory** module. Using the following example,
    the **vvega** domain account would be disabled:'
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: 要禁用域账户，你可以使用**Disable-ADAccount** cmdlet，它是**ActiveDirectory**模块的一部分。使用以下示例，**vvega**域账户将被禁用：
- en: '[PRE29]'
  id: totrans-252
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'Using the **Get-ADUser** cmdlet, you can verify that the account was disabled:'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**Get-ADUser** cmdlet，你可以验证该账户是否已禁用：
- en: '[PRE30]'
  id: totrans-254
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: Enabling a domain account
  id: totrans-255
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 启用域账户
- en: You want to enable a domain account.
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: 你想启用一个域账户。
- en: Solution
  id: totrans-257
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To enable a domain account, you can use the **Enable-ADAccount** cmdlet, which
    is part of the **ActiveDirectory** module. Using the following example, the **vvega**
    domain account would be enabled:'
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 要启用域账户，你可以使用**Enable-ADAccount** cmdlet，它是**ActiveDirectory**模块的一部分。使用以下示例，**vvega**域账户将被启用：
- en: '[PRE31]'
  id: totrans-259
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'Using the **Get-ADUser** cmdlet, you can verify that the account was disabled:'
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**Get-ADUser** cmdlet，你可以验证该账户是否已禁用：
- en: '[PRE32]'
  id: totrans-261
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: Retrieving all recently created domain users
  id: totrans-262
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 获取所有最近创建的域用户
- en: You want to retrieve all domain users that were recently created.
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: 你想获取最近创建的所有域用户。
- en: Solution
  id: totrans-264
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To retrieve all users that were created in the last 30 days, you can use the
    following code snippet:'
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 要获取过去30天内创建的所有用户，你可以使用以下代码片段：
- en: '[PRE33]'
  id: totrans-266
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: Checking whether a specific port is open
  id: totrans-267
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查特定端口是否开放
- en: You want to check whether a specific port on a remote system is open.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 你想检查远程系统的特定端口是否开放。
- en: Solution
  id: totrans-269
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To find out whether a specific port is open, you can use the following code
    snippet; this example checks whether port **445** is open on the computer **DC01**:'
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 要检查特定端口是否开放，你可以使用以下代码片段；此示例检查计算机**DC01**上的端口**445**是否开放：
- en: '[PRE34]'
  id: totrans-271
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'The following screenshot shows the output of the preceding code snippet:'
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 以下截图显示了前面代码片段的输出：
- en: '![Figure 9.3 – Checking whether port 445 is open on DC01](image/B16679_09_003.jpg)'
  id: totrans-273
  prefs: []
  type: TYPE_IMG
  zh: '![图9.3 – 检查DC01上的445端口是否开放](image/B16679_09_003.jpg)'
- en: Figure 9.3 – Checking whether port 445 is open on DC01
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: 图9.3 – 检查DC01上的445端口是否开放
- en: This method is a good way to test for a single port or for very few ports, as
    the **Test-NetConnection** cmdlet can be very time-consuming if used for a full
    port scan. Therefore, if you want to scan all ports of a remote system, you should
    instead use **nmap**.
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 这种方法是测试单个端口或极少数端口的好方法，因为**Test-NetConnection** cmdlet在进行完整端口扫描时可能非常耗时。因此，如果你想扫描远程系统的所有端口，应该改用**nmap**。
- en: Showing TCP connections and their initiating processes
  id: totrans-276
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 显示TCP连接及其启动进程
- en: You want to display all TCP connections, the initiating processes, as well as
    the command line that was used to open the TCP connection.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 你想显示所有TCP连接、启动进程，以及用于打开TCP连接的命令行。
- en: Solution
  id: totrans-278
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use **Get-NetTCPConnection** and create manual properties by using
    **Get-Process** and **Get-WmiObject** as **Select-Object** expressions:'
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用**Get-NetTCPConnection**并通过使用**Get-Process**和**Get-WmiObject**作为**Select-Object**表达式来创建手动属性：
- en: '[PRE35]'
  id: totrans-280
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: This example shows all TCP connections, the local address and port, the remote
    address and port, the state of the connection, the name of the process, as well
    as the command line that was executed to initiate the connection.
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 这个示例显示了所有TCP连接、当地地址和端口、远程地址和端口、连接状态、进程名称，以及启动连接的命令行。
- en: Showing UDP connections and their initiating processes
  id: totrans-282
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 显示UDP连接及其启动进程
- en: You want to display all UDP connections, the initiating processes, as well as
    the command line that was used to open the UDP connection.
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 你想显示所有UDP连接、启动进程，以及用于打开UDP连接的命令行。
- en: Solution
  id: totrans-284
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use **Get-NetUDPConnection** and create manual properties by using
    **Get-Process** and **Get-WmiObject** as **Select-Object** expressions:'
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用**Get-NetUDPConnection**并通过使用**Get-Process**和**Get-WmiObject**作为**Select-Object**表达式来创建手动属性：
- en: '[PRE36]'
  id: totrans-286
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: This example shows all UDP connections, the creation time, the local address
    and port, the name of the process, as well as the command line that was executed
    to initiate the connection.
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 此示例展示了所有UDP连接、创建时间、地方地址和端口、进程名称以及执行命令行的连接初始化过程。
- en: Searching for downgrade attacks using the Windows event log
  id: totrans-288
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用Windows事件日志搜索降级攻击
- en: You want to search for past downgrade attacks using the Windows event log.
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
  zh: 你希望使用Windows事件日志搜索过去的降级攻击。
- en: Solution
  id: totrans-290
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can search for past downgrade attacks using the Windows event log with
    the following code snippet, which was originally written by Lee Holmes:'
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用以下代码片段，通过Windows事件日志搜索过去的降级攻击，这段代码最初由Lee Holmes编写：
- en: '[PRE37]'
  id: totrans-292
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: Monitor for the **400** event ID in the Windows PowerShell event log. If **EngineVersion**
    is lower than **5**, you should definitely investigate further, as this could
    indicate a downgrade attack.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 在Windows PowerShell事件日志中监控**400**事件ID。如果**EngineVersion**低于**5**，你应该进一步调查，因为这可能表示降级攻击。
- en: Preventing downgrade attacks
  id: totrans-294
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 防止降级攻击
- en: You want to prevent downgrade attacks from happening and, therefore, use **Windows
    Defender Application Control** (**WDAC**) to disable PowerShell version 2 binaries.
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: 你希望防止降级攻击发生，因此使用**Windows Defender应用程序控制**（**WDAC**）来禁用PowerShell版本2二进制文件。
- en: Solution
  id: totrans-296
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 解决方案
- en: PowerShell version 2 cannot load if the **System.Management.Automation.dll**
    and **System.Management.Automation.ni.dll** assemblies are blocked, even if .NET
    Framework version 2 is installed and PowerShell version 2 is enabled.
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 如果**System.Management.Automation.dll**和**System.Management.Automation.ni.dll**程序集被阻止，即使安装了.NET
    Framework版本2并启用了PowerShell版本2，PowerShell版本2也无法加载。
- en: 'Use the following code snippets to find out where those binaries are located
    to block them, using WDAC or another application control software of your choice:'
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下代码片段查找二进制文件的位置并阻止它们，可以使用WDAC或你选择的其他应用程序控制软件：
- en: '[PRE38]'
  id: totrans-299
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: If you remove **-version 2** from the preceding code snippets, you will see
    that there are other binaries used for modern PowerShell versions. Therefore,
    you should not be afraid of breaking anything if your system relies on a modern
    PowerShell version and if you want to prohibit PowerShell version 2 binaries globally.
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: 如果从前面的代码片段中删除**-version 2**，你会发现其他二进制文件被用于现代PowerShell版本。因此，如果你的系统依赖现代PowerShell版本，并且想要全局禁止PowerShell版本2二进制文件，你不必担心会破坏任何东西。
- en: Now that you have located the PowerShell binaries, you can use WDAC to block
    these legacy versions. Make sure to block the native image as well as the **Microsoft
    intermediate language (****MSIL)** assemblies.
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
  zh: 既然你已经找到了PowerShell二进制文件的位置，你可以使用WDAC来阻止这些旧版本。确保阻止本地映像以及**Microsoft中间语言（****MSIL）**程序集。
- en: 'Refer to Lee Holmes’ blog post to learn more about detecting and preventing
    PowerShell downgrade attacks: [https://www.leeholmes.com/detecting-and-preventing-powershell-downgrade-attacks/](https://www.leeholmes.com/detecting-and-preventing-powershell-downgrade-attacks/).'
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
  zh: 请参考Lee Holmes的博客文章，了解更多关于检测和防止PowerShell降级攻击的信息：[https://www.leeholmes.com/detecting-and-preventing-powershell-downgrade-attacks/](https://www.leeholmes.com/detecting-and-preventing-powershell-downgrade-attacks/)。
- en: Summary
  id: totrans-303
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: This chapter first explored the *protect, detect, and respond* approach, emphasizing
    the importance of each pillar and its role in ensuring the security of an organization.
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
  zh: 本章首先探讨了*保护、检测和响应*方法，强调了每个支柱的重要性及其在确保组织安全中的作用。
- en: We then provided a comprehensive overview of commonly used PowerShell tools,
    which are essential for blue teamers to defend an organization against security
    threats.
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: 接着，我们提供了常用PowerShell工具的全面概述，这些工具对蓝队员防御组织免受安全威胁至关重要。
- en: Finally, the blue team cookbook, a collection of scripts and code snippets for
    security analysis and defense, was explored. The cookbook covers a wide range
    of tasks, including checking updates, monitoring bypasses, and analyzing event
    logs, processes, services, and network connections. The blue team cookbook serves
    as a valuable resource for information security practitioners, providing practical
    solutions to various security challenges.
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，探讨了蓝队手册，这是一个用于安全分析和防御的脚本和代码片段的集合。该手册涵盖了广泛的任务，包括检查更新、监控绕过、分析事件日志、进程、服务和网络连接。蓝队手册是信息安全从业人员的宝贵资源，提供了针对各种安全挑战的实用解决方案。
- en: Now that we’ve discussed daily blue team operations, let’s explore further mitigation
    options that can help you secure your environment when using PowerShell. In the
    next chapter, we’ll delve into language modes and **Just Enough** **Administration**
    (**JEA**).
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经讨论了日常蓝队操作，让我们进一步探讨一些可以帮助你在使用PowerShell时保护环境的缓解选项。在下一章中，我们将深入探讨语言模式和**最低权限**
    **管理**（**JEA**）。
- en: Further reading
  id: totrans-308
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 进一步阅读
- en: 'If you want to explore some of the topics that were mentioned in this chapter,
    follow these resources:'
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想深入探讨本章提到的某些主题，可以参考以下资源：
- en: 'Blue Team Notes: https://github.com/Purp1eW0lf/Blue-Team-Notes'
  id: totrans-310
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '蓝队笔记: https://github.com/Purp1eW0lf/Blue-Team-Notes'
- en: 'Blue Team Tips: [https://sneakymonkey.net/blue-team-tips/](https://sneakymonkey.net/blue-team-tips/)'
  id: totrans-311
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 蓝队提示：[https://sneakymonkey.net/blue-team-tips/](https://sneakymonkey.net/blue-team-tips/)
- en: 'A collection of PowerShell functions and scripts a blue teamer might use: [https://github.com/tobor88/PowerShell-Blue-Team](https://github.com/tobor88/PowerShell-Blue-Team)'
  id: totrans-312
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 蓝队员可能使用的PowerShell函数和脚本集合：[https://github.com/tobor88/PowerShell-Blue-Team](https://github.com/tobor88/PowerShell-Blue-Team)
- en: 'Creating and Starting a Windows Service Remotely Using NtObjectManager Via
    Remote Procedure Calls (RPC) Over SMB: [https://blog.openthreatresearch.com/ntobjectmanager_rpc_smb_scm](https://blog.openthreatresearch.com/ntobjectmanager_rpc_smb_scm)'
  id: totrans-313
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过远程过程调用（RPC）通过SMB使用NtObjectManager远程创建和启动Windows服务：[https://blog.openthreatresearch.com/ntobjectmanager_rpc_smb_scm](https://blog.openthreatresearch.com/ntobjectmanager_rpc_smb_scm)
- en: 'Detecting and Preventing PowerShell Downgrade Attacks: [https://www.leeholmes.com/detecting-and-preventing-powershell-downgrade-attacks/](https://www.leeholmes.com/detecting-and-preventing-powershell-downgrade-attacks/)'
  id: totrans-314
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 检测和防止PowerShell降级攻击：[https://www.leeholmes.com/detecting-and-preventing-powershell-downgrade-attacks/](https://www.leeholmes.com/detecting-and-preventing-powershell-downgrade-attacks/)
- en: 'Directory Services Internals Blog: [https://www.dsinternals.com/en/](https://www.dsinternals.com/en/)'
  id: totrans-315
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 目录服务内部博客：[https://www.dsinternals.com/en/](https://www.dsinternals.com/en/)
- en: 'Investigating PowerShell Attacks: [https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf'
  id: totrans-316
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 调查PowerShell攻击：[https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf)
- en: )
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: )
- en: 'PowerForensics - PowerShell Digital Forensics: [https://powerforensics.readthedocs.io/en/latest/](https://powerforensics.readthedocs.io/en/latest/)'
  id: totrans-318
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: PowerForensics - PowerShell数字取证：[https://powerforensics.readthedocs.io/en/latest/](https://powerforensics.readthedocs.io/en/latest/)
- en: 'PowerShell ♥ the Blue Team: [https://devblogs.microsoft.com/powershell/powershell-the-blue-team/](https://devblogs.microsoft.com/powershell/powershell-the-blue-team/)'
  id: totrans-319
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: PowerShell ♥ 蓝队：[https://devblogs.microsoft.com/powershell/powershell-the-blue-team/](https://devblogs.microsoft.com/powershell/powershell-the-blue-team/)
- en: 'Testing adversary technique variations with AtomicTestHarnesses: [https://redcanary.com/blog/introducing-atomictestharnesses/](https://redcanary.com/blog/introducing-atomictestharnesses/)'
  id: totrans-320
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用AtomicTestHarnesses测试对手技术变种：[https://redcanary.com/blog/introducing-atomictestharnesses/](https://redcanary.com/blog/introducing-atomictestharnesses/)
- en: 'Tracking WMI Activity with PSGumshoe: [https://www.darkoperator.com/blog/2022/3/27/tracking-wmi-activity-with-psgumshoe](https://www.darkoperator.com/blog/2022/3/27/tracking-wmi-activity-with-psgumshoe)'
  id: totrans-321
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用PSGumshoe跟踪WMI活动：[https://www.darkoperator.com/blog/2022/3/27/tracking-wmi-activity-with-psgumshoe](https://www.darkoperator.com/blog/2022/3/27/tracking-wmi-activity-with-psgumshoe)
- en: 'Windows Sandbox Attack Surface Analysis: [https://googleprojectzero.blogspot.com/2015/11/windows-sandbox-attack-surface-analysis.html](https://googleprojectzero.blogspot.com/2015/11/windows-sandbox-attack-surface-analysis.html)'
  id: totrans-322
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows沙盒攻击面分析：[https://googleprojectzero.blogspot.com/2015/11/windows-sandbox-attack-surface-analysis.html](https://googleprojectzero.blogspot.com/2015/11/windows-sandbox-attack-surface-analysis.html)
- en: 'You can also find all links mentioned in this chapter in the GitHub repository
    for [*Chapter 9*](B16679_09_Final_PD.xhtml#_idTextAnchor228) – there’s no need
    to manually type in every link: [https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Links.md](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Links.md).'
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以在GitHub仓库的[*第9章*](B16679_09_Final_PD.xhtml#_idTextAnchor228)中找到本章提到的所有链接—无需手动输入每个链接：[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Links.md](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter09/Links.md)。
- en: 'Part 3: Securing PowerShell – Effective Mitigations In Detail'
  id: totrans-324
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第三部分：保护PowerShell—详细的有效缓解措施
- en: In this part, we will mostly concentrate on mitigations that can help you to
    secure your environment efficiently. However, again, although we will focus on
    a lot of blue team stuff, this section also helps red teamers understand how mitigation
    technologies work, what risks they contain, and how adversaries are attempting
    to develop bypasses.
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: 在这一部分，我们将主要集中在帮助您高效保护环境的缓解措施上。然而，尽管我们将重点讲解大量蓝队内容，这一部分同样有助于红队成员了解缓解技术的工作原理，它们包含的风险，以及对手如何尝试开发绕过策略。
- en: First, we’ll explore J**ust Enough Administration** (**JEA**), a feature that
    helps with delegating administrative tasks to non-administrative users. Although
    this feature is not very well known widely, it can be a game-changer. In this
    part, we will dive deep into JEA and its configuration options, and we will learn
    how to simplify the initial deployment.
  id: totrans-326
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们将探索**足够的管理**（**JEA**），这是一个帮助将管理任务委派给非管理员用户的功能。虽然这个功能并不广为人知，但它可能是一个改变游戏规则的工具。在这一部分，我们将深入探讨JEA及其配置选项，并学习如何简化初始部署。
- en: Next, we will look into code signing and Application Control. You will learn
    how to plan for deploying Application Control, and throughout our journey, we
    will work with Microsoft’s Application Control solutions AppLocker and **Windows
    Defender Application Control** (**WDAC**). You will familiarize yourself with
    how those solutions are configured and audited. You will also gain insights into
    how PowerShell will change when Application Control is configured.
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将探讨代码签名和应用程序控制。您将学习如何规划部署应用程序控制，并在整个过程中，我们将使用微软的应用程序控制解决方案AppLocker和**Windows
    Defender应用程序控制**（**WDAC**）。您将熟悉这些解决方案的配置和审计方式。您还将了解到，当配置应用程序控制时，PowerShell将会发生哪些变化。
- en: Dive into the **Antimalware Scan Interface** (**AMSI**) – learn how it works
    and why it is really helpful in the fight against malware. We will also look into
    ways that adversaries bypass this useful feature, by either surrogating it or
    obfuscating their malicious code.
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
  zh: 深入了解**反恶意软件扫描接口**（**AMSI**）—了解它的工作原理以及它在对抗恶意软件中的重要性。我们还将探讨对手如何通过替代或混淆恶意代码来绕过这一有用功能。
- en: Many other features can help you mitigate risk in your environment; therefore,
    at the end of this part, we will glance at many different features that can help
    you improve your posture. We will look into secure scripting, the desired state
    configuration, hardening strategies for systems and environments, and attack detection
    with **endpoint detection and response** (**EDR**) software. We are not diving
    deep in this last section and you are more than welcome to explore some of the
    features mentioned further to learn more about them and possibly use them in your
    environment.
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: 许多其他功能可以帮助您降低环境中的风险；因此，在这一部分结束时，我们将简要介绍许多不同的功能，帮助您提高安全防护。我们将研究安全脚本编写、期望状态配置、系统和环境的加固策略，以及利用**端点检测与响应**（**EDR**）软件进行攻击检测。我们不会在最后一部分深入探讨，您完全可以进一步探索一些提到的功能，了解更多信息，并可能将其应用到您的环境中。
- en: 'This part has the following chapters:'
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
  zh: 本部分包括以下章节：
- en: '[*Chapter 10*](B16679_10_Final_PD.xhtml#_idTextAnchor278), *Language Modes
    and Just Enough Administration (JEA)*'
  id: totrans-331
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[*第10章*](B16679_10_Final_PD.xhtml#_idTextAnchor278)，*语言模式与足够的管理（JEA）*'
- en: '[*Chapter 11*](B16679_11_Final_PD.xhtml#_idTextAnchor306), *AppLocker, Application
    Control, and Code Signing*'
  id: totrans-332
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[*第11章*](B16679_11_Final_PD.xhtml#_idTextAnchor306)，*AppLocker、应用程序控制和代码签名*'
- en: '[*Chapter 12*](B16679_12_Final_PD.xhtml#_idTextAnchor324), *Exploring the Antimalware
    Scan Interface (AMSI)*'
  id: totrans-333
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[*第12章*](B16679_12_Final_PD.xhtml#_idTextAnchor324)，*探索反恶意软件扫描接口（AMSI）*'
- en: '[*Chapter 13*](B16679_13_Final_PD.xhtml#_idTextAnchor341), *What Else? – Further
    Mitigations and Resources*'
  id: totrans-334
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[*第13章*](B16679_13_Final_PD.xhtml#_idTextAnchor341)，*还有什么？—进一步的缓解措施与资源*'
