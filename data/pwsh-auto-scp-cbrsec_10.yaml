- en: '10'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '10'
- en: Language Modes and Just Enough Administration (JEA)
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 语言模式和仅足够管理（JEA）
- en: We have learned that PowerShell offers amazing logging and auditing capabilities
    and explored how to access the local system as well as Active Directory and Azure
    Active Directory. We also looked at daily red and blue team practitioner tasks.
    In this part of the book, we are diving deeper into mitigation features and how
    PowerShell can help you to build a robust and more secure environment.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经学习了PowerShell提供的出色日志记录和审计功能，探索了如何访问本地系统以及Active Directory和Azure Active Directory。我们还查看了日常的红队和蓝队任务。在本书的这一部分，我们将更深入地探讨缓解功能以及PowerShell如何帮助你构建一个强大且更安全的环境。
- en: We will first explore language modes and understand the difference between the
    Constrained Language mode and **Just Enough Administration** (**JEA**). Then,
    we will dive deep into JEA and explore what is needed to configure your first
    very own JEA endpoint.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将首先探讨语言模式，理解受限语言模式和**仅足够管理**（**JEA**）之间的区别。然后，我们将深入了解JEA，并探索配置你自己的第一个JEA端点所需的内容。
- en: You will learn about the role capability and the session configuration file
    and learn how to deploy JEA in your environment. If you have the right tools at
    hand such as JEAnalyzer, creating an initial JEA configuration is not too hard.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 你将学习角色能力和会话配置文件的作用，并学习如何在你的环境中部署JEA。如果你手头有合适的工具，比如JEAnalyzer，创建初始的JEA配置并不困难。
- en: Finally, you will understand how to best leverage logging when working with
    JEA and which risky commands or bypasses you should avoid to harden your JEA configuration
    and your environment.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，你将理解如何在使用JEA时充分利用日志记录，并了解应该避免哪些风险命令或绕过方法，以强化你的JEA配置和环境。
- en: 'In this chapter, you will get a deeper understanding of the following topics:'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你将深入了解以下主题：
- en: What are language modes within PowerShell?
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: PowerShell中的语言模式是什么？
- en: Understanding JEA
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 理解JEA
- en: Simplifying your deployment using JEAnalyzer
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用JEAnalyzer简化你的部署
- en: Logging within JEA sessions
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在JEA会话中的日志记录
- en: Best practices—avoiding risks and possible bypasses
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最佳实践—避免风险和可能的绕过
- en: Technical requirements
  id: totrans-12
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'To get the most out of this chapter, ensure that you have the following:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 为了最大化本章的学习效果，请确保你具备以下内容：
- en: PowerShell 7.3 and above
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: PowerShell 7.3及以上版本
- en: Visual Studio Code installed
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 已安装Visual Studio Code
- en: 'Access to the GitHub repository for **Chapter10**:'
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 访问**第10章**的GitHub仓库：
- en: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter10](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter10)'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter10](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter10)'
- en: What are language modes within PowerShell?
  id: totrans-18
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: PowerShell中的语言模式是什么？
- en: 'A language mode in PowerShell determines which elements of PowerShell are allowed
    and can be used in a session. You can find out the language mode of the current
    session by running **$ExecutionContext.SessionState.LanguageMode**—of course,
    this only works if you are allowed to run this command:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell中的语言模式决定了会话中允许使用哪些PowerShell元素。你可以通过运行**$ExecutionContext.SessionState.LanguageMode**来查看当前会话的语言模式——当然，这只有在你被允许运行该命令时才有效：
- en: '![Figure 10.1 – Querying the language mode](image/B16679_10_001.jpg)'
  id: totrans-20
  prefs: []
  type: TYPE_IMG
  zh: '![图10.1 – 查询语言模式](image/B16679_10_001.jpg)'
- en: Figure 10.1 – Querying the language mode
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.1 – 查询语言模式
- en: In the example shown in the screenshot, the Full Language mode is enabled in
    the current session.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 在截图中显示的示例中，当前会话启用了完整语言模式。
- en: There are four different language modes available, which we will explore a little
    bit deeper in the following sections.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 有四种不同的语言模式可供选择，我们将在接下来的章节中更深入地探讨这些模式。
- en: Full Language (FullLanguage)
  id: totrans-24
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 完整语言（FullLanguage）
- en: The Full Language mode is the default mode for PowerShell. Every command and
    all elements are allowed.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 完整语言模式是PowerShell的默认模式，所有命令和元素都被允许。
- en: The only restrictions that a user may experience would be if they do not have
    the Windows privileges to run a command (such as administrative privileges), but
    this behavior is not restricted by language mode.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 用户可能遇到的唯一限制是，如果他们没有足够的Windows权限来运行某个命令（例如管理员权限），但这种行为不受语言模式的限制。
- en: Restricted Language (RestrictedLanguage)
  id: totrans-27
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 受限语言（RestrictedLanguage）
- en: The Restricted Language mode is a *data-specific form of the PowerShell language*
    that is primarily intended to support the localization files used by **Import-LocalizedData**.
    While cmdlets and functions can be executed in this mode, users are not allowed
    to run script blocks. It is important to note that the Restricted Language mode
    is not intended to be used explicitly in most scenarios and should only be used
    when working with localization files.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 受限语言模式是一种*数据特定形式的 PowerShell 语言*，主要用于支持 **Import-LocalizedData** 使用的本地化文件。虽然在此模式下可以执行
    cmdlet 和函数，但不允许运行脚本块。需要注意的是，受限语言模式并不打算在大多数场景中显式使用，应仅在处理本地化文件时使用。
- en: And beginning with PowerShell 7.2, the **New-Object** cmdlet is disabled if
    the system lockdown mode is configured.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 并且从 PowerShell 7.2 开始，如果配置了系统锁定模式，**New-Object** cmdlet 会被禁用。
- en: 'Only the following variables are allowed by default:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下仅允许以下变量：
- en: '**$****True**'
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**$****True**'
- en: '**$****False**'
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**$****False**'
- en: '**$****Null**'
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**$****Null**'
- en: '**$****PSCulture**'
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**$****PSCulture**'
- en: '**$****PSUICulture**'
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**$****PSUICulture**'
- en: 'Only the following operators are allowed by default:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下仅允许以下运算符：
- en: '**-****eq**'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**-****eq**'
- en: '**-****gt**'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**-****gt**'
- en: '**-****lt**'
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**-****lt**'
- en: Please refer to [*Chapter 2*](B16679_02_Final_PD.xhtml#_idTextAnchor034), *PowerShell
    Scripting Fundamentals*, for more details on operators.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 请参阅 [*第二章*](B16679_02_Final_PD.xhtml#_idTextAnchor034)，*PowerShell 脚本基础*，以了解更多关于运算符的详细信息。
- en: No Language (NoLanguage)
  id: totrans-41
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 无语言模式 (NoLanguage)
- en: The No Language mode can be used via the API only and allows no single kind
    of script.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: “无语言模式”只能通过 API 使用，并且不允许任何类型的脚本。
- en: Similar to the Restricted Language mode, beginning with PowerShell 7.2, the
    **New-Object** cmdlet is disabled if the system lockdown mode is configured.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 类似于受限语言模式，从 PowerShell 7.2 开始，如果配置了系统锁定模式，**New-Object** cmdlet 会被禁用。
- en: Constrained Language (ConstrainedLanguage)
  id: totrans-44
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 受限语言模式 (ConstrainedLanguage)
- en: As we learned earlier in the book in [*Chapter 5*](B16679_05_Final_PD.xhtml#_idTextAnchor110),
    *PowerShell Is Powerful – System and API Access*, some of the most dangerous ways
    to abuse PowerShell are when COM or .NET are abused or if **Add-Type** is used
    to run and reuse code that was written in other languages (such as C#).
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 正如我们在本书的 [*第五章*](B16679_05_Final_PD.xhtml#_idTextAnchor110) 中学到的，*PowerShell
    的强大—系统和 API 访问*，滥用 PowerShell 的最危险方式之一是滥用 COM 或 .NET，或者使用 **Add-Type** 来运行和复用用其他语言（如
    C#）编写的代码。
- en: 'The Constrained Language mode prevents those dangerous scenarios, while it
    still permits the user to use legitimate .NET classes, as well as all cmdlets
    and PowerShell elements. It is designed to support day-to-day administrative tasks,
    but restricts the user from executing risky elements such as—for example—calling
    arbitrary APIs:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 受限语言模式防止了这些危险的场景，同时仍然允许用户使用合法的 .NET 类以及所有 cmdlet 和 PowerShell 元素。它旨在支持日常的管理任务，但限制用户执行风险较大的操作，例如调用任意
    API：
- en: '![Figure 10.2 – Running functions from arbitrary APIs is not possible within
    the constrained language mode](image/B16679_10_002.jpg)'
  id: totrans-47
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.2 – 在受限语言模式下，无法运行来自任意 API 的函数](image/B16679_10_002.jpg)'
- en: Figure 10.2 – Running functions from arbitrary APIs is not possible within the
    constrained language mode
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.2 – 在受限语言模式下，无法运行来自任意 API 的函数
- en: 'To configure a language mode for testing, you can simply set it via the command
    line:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 要配置测试语言模式，可以通过命令行简单设置：
- en: '[PRE0]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Using this particular setting in a production environment is not recommended—if
    an adversary gains access to the system, they could easily change this setting
    to compromise the security of the system:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 在生产环境中使用此设置并不推荐——如果对手获得系统访问权限，他们可以轻易更改此设置，从而危及系统安全：
- en: '[PRE1]'
  id: totrans-52
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'There is also the undocumented **__PSLockDownPolicy** environment variable
    that some blog posts recommend. However, this variable was only implemented for
    debugging and unit testing and should not be used for enforcement, due to the
    same reasons: an attacker can easily overwrite it, and it should only be used
    for testing.'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 还有一个未记录的 **__PSLockDownPolicy** 环境变量，一些博客推荐使用它。然而，这个变量仅用于调试和单元测试，不应用于强制执行，因为同样的原因：攻击者可以轻松覆盖它，且它应仅用于测试。
- en: 'To effectively use the Constrained Language mode to secure your PowerShell
    environment, it is critical to use it in conjunction with a robust application
    control solution such as **Windows Defender Application** **Control** (**WDAC**):'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 为了有效地使用受限语言模式来保护 PowerShell 环境，关键是与强大的应用控制解决方案（如 **Windows Defender 应用控制**（**WDAC**））结合使用：
- en: '[https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/select-types-of-rules-to-create](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/select-types-of-rules-to-create)'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/select-types-of-rules-to-create](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/select-types-of-rules-to-create)'
- en: Without such measures in place, attackers can easily bypass the Constrained
    Language mode by using other scripting engines or by creating custom malware in
    the form of **.exe** or **.****dll** files.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 如果没有采取这些措施，攻击者可以轻松绕过受限语言模式，通过使用其他脚本引擎或创建自定义恶意软件（如 **.exe** 或 **.dll** 文件）来实现。
- en: We will also explore AppLocker and application control further in [*Chapter
    11*](B16679_11_Final_PD.xhtml#_idTextAnchor306), *AppLocker, Application Control,
    and* *Code Signing*.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还将在[*第 11 章*](B16679_11_Final_PD.xhtml#_idTextAnchor306)中进一步探讨 AppLocker 和应用程序控制，*AppLocker、应用程序控制和*
    *代码签名*。
- en: 'Make sure to also refer to the PowerShell team’s blog post on Constrained Language
    mode:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 请务必参考 PowerShell 团队关于受限语言模式的博客文章：
- en: '[https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/)'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/)'
- en: Constrained Language mode is a great option, but wouldn’t it be great to also
    restrict which exact commands and parameters are allowed in a session or by a
    particular user? This is where JEA comes into play.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 受限语言模式是一个很好的选择，但如果能够进一步限制会话中或特定用户允许哪些具体命令和参数，那不是更好吗？这正是 JEA 的作用所在。
- en: Understanding JEA
  id: totrans-61
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 理解 JEA
- en: 'JEA does exactly what its name stands for: it allows you to define which role
    can execute which command and allows just enough administration rights.'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: JEA 完全符合其名称的含义：它允许你定义哪些角色可以执行哪些命令，并只授予足够的管理权限。
- en: 'Imagine you have multiple people working on one server system: there might
    be administrators and supporters who might need to perform certain operations
    such as restarting a service from time to time (for example, restarting the print
    spooler service on a print server). This operation would require administrative
    rights, but for the support person, an admin account would mean too many privileges—privileges
    that could be abused by an attacker in case the support person’s credentials get
    stolen.'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 假设你有多个人在同一服务器系统上工作：可能有管理员和支持人员，他们可能需要执行某些操作，比如不时重启一个服务（例如，在打印服务器上重启打印缓冲服务）。这类操作需要管理员权限，但对支持人员来说，管理员账户意味着过多的权限——如果支持人员的凭证被窃取，这些权限可能会被攻击者滥用。
- en: Using JEA, the system’s administrator can define which commands can be run by
    a certain role and even restrict the parameters. As such, the support person can
    log in via **PowerShell Remoting** (**PSRemoting**), quickly restart the print
    spooler service, and return to their daily business. No other commands can be
    used but those configured.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 JEA，系统管理员可以定义某个角色可以执行哪些命令，甚至可以限制参数。因此，支持人员可以通过 **PowerShell Remoting** (**PSRemoting**)
    登录，快速重启打印缓冲服务，并返回到他们的日常工作中。除了配置的命令，无法使用其他任何命令。
- en: Additionally, JEA relies on PSRemoting, which is also a great way to avoid leaving
    credentials on the target system. There is even a possibility to configure that
    a virtual account is used on the target system on behalf of the operating person.
    Once the session is terminated, the virtual account will be destroyed and can
    no longer be used.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，JEA 依赖于 PSRemoting，这也是避免在目标系统上留下凭证的一个好方法。甚至可以配置在目标系统上使用虚拟账户代表操作人员。一旦会话终止，虚拟账户将被销毁，无法再使用。
- en: An overview of JEA
  id: totrans-66
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: JEA 概述
- en: 'JEA relies on PSRemoting: a technology that lets you connect to defined endpoints
    remotely, which we explored further in [*Chapter 3*](B16679_03_Final_PD.xhtml#_idTextAnchor064),
    *Exploring PowerShell Remote Management Technologies and* *PowerShell Remoting*.'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: JEA 依赖于 PSRemoting：一种让你能够远程连接到定义的端点的技术，我们在[*第 3 章*](B16679_03_Final_PD.xhtml#_idTextAnchor064)中进一步探讨了这一点，*探索
    PowerShell 远程管理技术和* *PowerShell Remoting*。
- en: There are two important files that you need to configure JEA basics—the **role
    capability file** and the **session configuration file**. Using these two files
    within a PSRemoting session allows JEA to let the magic work.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 有两个重要文件需要配置 JEA 基础设置——**角色能力文件**和**会话配置文件**。在 PSRemoting 会话中使用这两个文件，JEA 才能发挥其作用。
- en: Of course, you also need to restrict all other forms of access (such as via
    Remote Desktop) to the target server to restrict users from bypassing your JEA
    restrictions.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，你还需要限制所有其他访问方式（如通过远程桌面）到目标服务器，以防止用户绕过你的 JEA 限制。
- en: 'The following diagram shows an overview of how a JEA connection works:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 下图展示了 JEA 连接的工作原理概述：
- en: '![Figure 10.3 – High-level overview of how to connect with JEA](image/B16679_10_003.jpg)'
  id: totrans-71
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.3 – 如何连接到 JEA 的高级概述](image/B16679_10_003.jpg)'
- en: Figure 10.3 – High-level overview of how to connect with JEA
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.3 – 如何连接到 JEA 的高级概述
- en: Using JEA even allows a non-administrative user to access a server to perform
    administrative tasks that were predefined for this user’s role.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 JEA 甚至可以允许非管理员用户访问服务器，执行为该用户角色预定义的管理任务。
- en: Depending on the configuration, a virtual account can be used on behalf of the
    user to allow non-administrative remote users to accomplish tasks that require
    administrative privileges. And don’t worry; of course, every command that is executed
    under the virtual account is logged and can be mapped back to the originating
    user.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 根据配置，虚拟帐户可以代表用户使用，从而允许非管理员的远程用户完成需要管理员权限的任务。别担心；当然，在虚拟帐户下执行的每个命令都会被记录，并可以追溯到原始用户。
- en: You might have heard much about PSRemoting sessions, but where in this picture
    can you find JEA?
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能听说过很多关于 PSRemoting 会话的内容，但在这幅图中，你能找到 JEA 吗？
- en: Everything begins with starting an interactive session with a remote server—for
    example, by using **Enter-PSSession**.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 一切从启动与远程服务器的交互式会话开始——例如，使用 **Enter-PSSession**。
- en: There’s also a possibility to add session options to the session—is this where
    you can find JEA? No, but session options come in very handy in case you don’t
    want to connect to a *normal* PowerShell session. If you have, for example, a
    proxy to connect against, **-SessionOption** helps you to identify these details.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 你也可以将会话选项添加到会话中——这是你能找到 JEA 的地方吗？不，但会话选项在你不想连接到*普通* PowerShell 会话时非常有用。例如，如果你需要连接到一个代理，**-SessionOption**
    可以帮助你识别这些细节。
- en: 'Session options are great, but they are not part of this chapter. So, if you
    want to learn more about them, refer to the options the **New-PSSessionOption**
    cmdlet provides:'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 会话选项非常有用，但它们不属于本章内容。所以，如果你想了解更多关于它们的信息，请参考 **New-PSSessionOption** cmdlet 提供的选项：
- en: '[https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-pssessionoption](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-pssessionoption)'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-pssessionoption](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-pssessionoption)'
- en: 'Then, there is the option to add a configuration to the session, using the
    **-ConfigurationName** parameter. Is this where JEA hides? Well, almost, but we
    are not there yet. You can see in the following diagram the differences between
    options, configurations, and where JEA finally fits in:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，你可以选择使用 **-ConfigurationName** 参数将配置添加到会话中。这是 JEA 隐藏的地方吗？差不多，但我们还没到那里。你可以在下面的图中看到选项、配置和
    JEA 最终适配的位置：
- en: '![Figure 10.4 – Where JEA resides](image/B16679_10_004.jpg)'
  id: totrans-81
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.4 – JEA 所在位置](image/B16679_10_004.jpg)'
- en: Figure 10.4 – Where JEA resides
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.4 – JEA 所在位置
- en: JEA really comes into play within a configuration, where a role definition was
    created. So, JEA is a part of a session that is established, secured by **Security
    Descriptor Definition Language** (**SDDL**), and with a special role definition.
    SDDLs define the rights a user or group can have to access a resource.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: JEA 真正发挥作用的地方是在配置中，其中创建了角色定义。因此，JEA 是建立的会话的一部分，通过 **安全描述符定义语言**（**SDDL**）保护，并包含特定的角色定义。SDDL
    定义了用户或组对资源访问的权限。
- en: Planning for JEA
  id: totrans-84
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: JEA 规划
- en: Before you can use JEA, there are a few things to consider first. JEA was included
    in PowerShell 5.0, so make sure that the right version is installed (5.0 or higher).
    You can check the current version using **$PSVersionTable.PSVersion**.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用 JEA 之前，有几个事项需要先考虑。JEA 已包含在 PowerShell 5.0 中，因此请确保安装了正确的版本（5.0 或更高版本）。你可以使用
    **$PSVersionTable.PSVersion** 检查当前版本。
- en: Since JEA relies on PSRemoting and WinRM, make sure both are configured and
    enabled. See [*Chapter 3*](B16679_03_Final_PD.xhtml#_idTextAnchor064), *Exploring
    PowerShell Remote Management Technologies and PowerShell Remoting*, for more details.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 由于 JEA 依赖于 PSRemoting 和 WinRM，请确保两者都已配置并启用。有关更多细节，请参见 [*第 3 章*](B16679_03_Final_PD.xhtml#_idTextAnchor064)，*探索
    PowerShell 远程管理技术和 PowerShell 远程连接*。
- en: You also need administrative privileges on the system to be able to configure
    JEA.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 你还需要具有系统的管理员权限，才能配置 JEA。
- en: 'And not only the right PowerShell version needs to be installed, but also the
    right operating system version. The following screenshot shows you all the supported
    versions for server operating systems, and what steps you need to take to make
    sure JEA is working properly:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 不仅需要安装正确的 PowerShell 版本，还需要安装正确的操作系统版本。以下截图显示了服务器操作系统的所有支持版本，以及确保 JEA 正常运行所需采取的步骤：
- en: '![Figure 10.5 – JEA supportability for server operating systems](image/B16679_10_005.jpg)'
  id: totrans-89
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.5 – 服务器操作系统的 JEA 支持性](image/B16679_10_005.jpg)'
- en: Figure 10.5 – JEA supportability for server operating systems
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.5 – 服务器操作系统的 JEA 支持性
- en: 'JEA can also be used on client operating systems. The following screenshot
    shows you which features are available with which version and what you need to
    do to get JEA running on each operating system:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: JEA 也可以在客户端操作系统上使用。以下截图显示了每个版本的可用功能以及在每个操作系统上使 JEA 运行所需的步骤：
- en: '![Figure 10.6 – JEA supportability for client operating systems](image/B16679_10_006.jpg)'
  id: totrans-92
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.6 – 客户端操作系统的 JEA 支持性](image/B16679_10_006.jpg)'
- en: Figure 10.6 – JEA supportability for client operating systems
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.6 – 客户端操作系统的 JEA 支持性
- en: Finally, you need to identify which users and/or groups you want to restrict
    and what rights each one of them should have. This might sound quite challenging.
    In this chapter, you will find some helpful tricks and tools to help you with
    this task.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，你需要确定要限制的用户和/或组，以及每个用户应该拥有的权限。这听起来可能有些挑战。在本章中，你将找到一些有用的技巧和工具，帮助你完成这项任务。
- en: 'But before we dive into that, let’s explore what JEA consists of. First, there
    are two main files behind JEA, as follows:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 但在我们深入探讨之前，让我们先了解一下 JEA 包含了哪些内容。首先，JEA 背后有两个主要文件，如下所示：
- en: The role capability file
  id: totrans-96
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 角色能力文件
- en: The session configuration file
  id: totrans-97
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 会话配置文件
- en: Let’s first explore what the role capability file is about and how to configure
    it.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们首先探索一下角色能力文件是什么，以及如何配置它。
- en: Role capability file
  id: totrans-99
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 角色能力文件
- en: The role capability file determines which commands each role is allowed to run.
    You can specify which actions users in a particular role can perform and restrict
    these roles to using certain cmdlets, functions, providers, and external programs
    only.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 角色能力文件决定了每个角色可以运行哪些命令。你可以指定特定角色中的用户可以执行哪些操作，并将这些角色限制为仅使用某些 cmdlet、函数、提供程序和外部程序。
- en: It is common to define role capability files for certain roles—such as for print
    server admins, DNS admins, tier 1 helpdesk, and many more. Since role capability
    files can be implemented as part of PowerShell modules, you can easily share them
    with others.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 通常会为某些角色定义角色能力文件——例如打印服务器管理员、DNS 管理员、一级帮助台等。由于角色能力文件可以作为 PowerShell 模块的一部分进行实现，因此你可以轻松地与他人共享它们。
- en: 'Using **New-PSRoleCapabilityFile**, you can create your first skeleton JEA
    role capability file:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**New-PSRoleCapabilityFile**，你可以创建你的第一个骨架 JEA 角色能力文件：
- en: '[PRE2]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'An empty file, named **Support.psrc**, is created with prepopulated parameters
    that can be filled and edited:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 一个名为**Support.psrc**的空文件被创建，并预填充了可以填写和编辑的参数：
- en: '![Figure 10.7 – An empty skeleton role capability file](image/B16679_10_007.jpg)'
  id: totrans-105
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.7 – 一个空的骨架角色能力文件](image/B16679_10_007.jpg)'
- en: Figure 10.7 – An empty skeleton role capability file
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.7 – 一个空的骨架角色能力文件
- en: When choosing the name of the role capability file, make sure that it reflects
    the name of the actual role—so, be careful what name you choose for each file.
    In our example, we created the **Support.psrc** role capability file, which is
    a great start to configuring a support role.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 在选择角色能力文件的名称时，请确保它反映了实际角色的名称——因此，请小心选择每个文件的名称。在我们的示例中，我们创建了**Support.psrc**角色能力文件，这是配置支持角色的一个很好的起点。
- en: 'You can find a generated skeleton file without any configuration in the GitHub
    repository of this book:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在本书的 GitHub 仓库中找到一个未配置的生成骨架文件：
- en: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA_SkeletonRoleCapabilityFile.psrc](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA_SkeletonRoleCapabilityFile.psrc)'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA_SkeletonRoleCapabilityFile.psrc](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA_SkeletonRoleCapabilityFile.psrc)'
- en: Allowing PowerShell cmdlets and functions
  id: totrans-110
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 允许 PowerShell cmdlet 和函数
- en: Let’s get started with an easy example of a role capability file. Let’s imagine
    you are the administrator of an organization and the helpdesk reports regular
    issues with the print server. Well, one solution would be to give helpdesk administration
    privileges on all print servers, but that would give all helpdesk employees too
    many privileges on the print servers and probably expose your environment to risk.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从一个简单的角色能力文件例子开始。假设你是一个组织的管理员，帮助台报告了打印服务器的常见问题。那么，一个解决方案是给予帮助台管理员权限，允许他们操作所有打印服务器，但这会给所有帮助台员工过多的权限，并可能使你的环境面临风险。
- en: Therefore, you might want to give the helpdesk employees only the privilege
    to restart services on the print servers.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，你可能只想赋予帮助台员工在打印服务器上重启服务的权限。
- en: 'You might have heard about **Restart-Service**, which serves exactly this purpose:
    to restart services. But was it a *cmdlet* or a *function*? Or even an *alias*?'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能听说过**Restart-Service**，它正是用于这个目的：重启服务。但它是一个*cmdlet*还是一个*function*？还是一个*alias*？
- en: 'If you are unsure about a certain command, the **Get-Command** cmdlet can help
    you in finding out more information:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你对某个命令不确定，**Get-Command** cmdlet可以帮助你查找更多信息：
- en: '![Figure 10.8 – Using Get-Command to find out the command type](image/B16679_10_008.jpg)'
  id: totrans-115
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.8 – 使用Get-Command查找命令类型](image/B16679_10_008.jpg)'
- en: Figure 10.8 – Using Get-Command to find out the command type
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.8 – 使用Get-Command查找命令类型
- en: 'Thanks to **Get-Command**, we now know that **Restart-Service** is a *cmdlet*
    and we can continue to configure it. If you have a look at the generated skeleton
    **.psrc** file, you can see multiple sections that start with **Visible**. Using
    these, you are able to define what will be available in your JEA session. All
    the parameters that you can configure in the role capability file align with the
    parameters that the **New-PSRoleCapabilityFile** cmdlet provides:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 借助**Get-Command**，我们现在知道**Restart-Service**是一个*cmdlet*，我们可以继续配置它。如果你查看生成的骨架**.psrc**文件，你可以看到多个以**Visible**开头的部分。通过这些部分，你可以定义在你的JEA会话中将提供哪些内容。你可以在角色能力文件中配置的所有参数与**New-PSRoleCapabilityFile**
    cmdlet提供的参数一致：
- en: '[PRE3]'
  id: totrans-118
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'For example, if you wanted to configure a simple JEA configuration and only
    make the **Restart-Service** cmdlet available, you could use the following command:'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果你想配置一个简单的JEA配置并只允许**Restart-Service** cmdlet可用，你可以使用以下命令：
- en: '[PRE4]'
  id: totrans-120
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: In this example, we used the **-VisibleCmdlets** parameter to configure the
    **Restart-Service** cmdlet to be available in the **Support** role, so let’s have
    a closer look at what we can do using this configuration option.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，我们使用**-VisibleCmdlets**参数将**Restart-Service** cmdlet配置为在**Support**角色中可用，所以让我们更仔细地看看使用此配置选项时可以做什么。
- en: VisibleCmdlets
  id: totrans-122
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: VisibleCmdlets
- en: Use the **-VisibleCmdlets** parameter to define which *cmdlets* are visible
    and can be used by the configured role. All cmdlets defined need to be available
    on the target system to avoid errors.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**-VisibleCmdlets**参数来定义哪些*cmdlet*是可见的，并且可以被配置的角色使用。所有定义的cmdlet需要在目标系统上可用，以避免错误。
- en: After creating your **Support.psrc** role capability file, it is also possible
    to directly edit it using a text editor of your choice. Not only can you use the
    **-VisibleCmdlets** parameter when creating the role capability file, but you
    can also configure this option directly in the role capability file.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 创建了**Support.psrc**角色能力文件后，你也可以直接使用你选择的文本编辑器编辑它。你不仅可以在创建角色能力文件时使用**-VisibleCmdlets**参数，还可以在角色能力文件中直接配置此选项。
- en: 'If you simply want to configure cmdlets without restricting their parameters,
    you can put them into single quotation marks and separate them with commas. In
    this example, the configured role would be able to restart services as well as
    restart the computer:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你只想配置cmdlet，而不限制其参数，你可以将它们放入单引号中，并用逗号分隔。在这个例子中，配置的角色将能够重启服务以及重启计算机：
- en: '[PRE5]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'When using wildcards to configure cmdlets, it is crucial to be aware of the
    potential risks involved. While it may seem convenient to use a wildcard to allow
    a range of commands, you might unintentionally grant more permissions than necessary,
    creating vulnerabilities in your setup. Using the following command, this role
    would be able to run all commands that start with **Get-**:'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用通配符配置cmdlet时，必须意识到可能涉及的风险。虽然使用通配符来允许一系列命令看似方便，但你可能无意中授予了比必要更多的权限，从而在你的设置中创建了漏洞。使用以下命令时，该角色将能够运行所有以**Get-**开头的命令：
- en: '[PRE6]'
  id: totrans-128
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: But allowing a role to use all commands that start with **Get-** might also
    expose sensitive information through the **Get-Content** cmdlet, even if that
    was not the intended purpose of the role. Therefore, it’s important to carefully
    consider the commands you allow and regularly review and adjust the permissions
    as needed to maintain the security of your system.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 但是，允许一个角色使用所有以 **Get-** 开头的命令也可能会通过 **Get-Content** cmdlet 暴露敏感信息，即使这并不是该角色的预期用途。因此，仔细考虑允许的命令并定期审查和调整权限是非常重要的，以维护系统的安全性。
- en: 'To also restrict the parameters of a cmdlet, you can build simple hash tables,
    like so:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 为了限制 cmdlet 的参数，你可以构建简单的哈希表，如下所示：
- en: '[PRE7]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Using the preceding example, the configured role would be allowed to run three
    commands: the first allowed cmdlet would be **Restart-Service**, but this role
    would be only allowed to restart the **dns** and **spooler** services. The second
    allowed cmdlet empowers the role to also *restart the computer* but only using
    the **-Confirm**, **-Delay**, **-Force**, and **-Timeout** parameters. And last,
    but not least, the third allowed cmdlet is **Get-ChildItem**, but with the configuration
    specified within **ValidatePattern**, a user with this role would only be able
    to query subfolders of the **C:\Users** path.'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 使用前面的示例，配置的角色将允许执行三条命令：第一条允许的 cmdlet 是 **Restart-Service**，但是这个角色只允许重新启动 **dns**
    和 **spooler** 服务。第二条允许的 cmdlet 授权角色也可以*重启计算机*，但仅能使用 **-Confirm**、**-Delay**、**-Force**
    和 **-Timeout** 参数。最后，但同样重要的是，第三条允许的 cmdlet 是 **Get-ChildItem**，但根据 **ValidatePattern**
    中指定的配置，拥有该角色的用户只能查询 **C:\Users** 路径下的子文件夹。
- en: VisibleFunctions
  id: totrans-133
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: VisibleFunctions
- en: '**VisibleFunctions** defines which *functions* are visible and can be used
    by the configured role. All functions defined need to be either available on the
    target system or defined in the **FunctionDefinitions** section of the current
    role capability file to avoid errors.'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: '**VisibleFunctions** 定义了哪些*函数*是可见的，并且可以被配置的角色使用。所有定义的函数需要在目标系统上可用，或者在当前角色能力文件的
    **FunctionDefinitions** 部分定义，以避免错误。'
- en: 'Functions are defined like cmdlets:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 函数的定义方式类似于 cmdlet：
- en: '[PRE8]'
  id: totrans-136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: This example would allow the **Restart-NetAdapter** function; if executed, this
    function restarts a network adapter by disabling and enabling the network adapter
    again.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 这个示例将允许 **Restart-NetAdapter** 函数；如果执行该函数，它会通过禁用并重新启用网络适配器来重新启动网络适配器。
- en: For functions, you can also use hash tables to define more complex restrictions
    and wildcards that also work similarly to cmdlets—these should still be used very
    carefully.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 对于函数，你也可以使用哈希表来定义更复杂的限制和通配符，这些也类似于 cmdlet —— 这些仍然需要非常小心地使用。
- en: VisibleAliases
  id: totrans-139
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: VisibleAliases
- en: '**VisibleAliases** defines which *aliases* are visible and can be used by the
    configured role. All aliases defined need to be either available on the target
    system or defined in the **AliasDefinitions** section of the current role capability
    file to avoid errors:'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: '**VisibleAliases** 定义了哪些*别名*是可见的，并且可以被配置的角色使用。所有定义的别名需要在目标系统上可用，或者在当前角色能力文件的
    **AliasDefinitions** 部分定义，以避免错误：'
- en: '[PRE9]'
  id: totrans-141
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: This example would allow the **cd** alias to allow the **Set-Location** cmdlet
    and the **ls** alias to allow the **Get-ChildItem** cmdlet.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 这个示例将允许 **cd** 别名使用 **Set-Location** cmdlet，**ls** 别名使用 **Get-ChildItem** cmdlet。
- en: Aliases are configured in a similar way to cmdlets and functions in the role
    capability file. Please refer to those sections (*VisibleCmdlets* and *VisibleFunctions*)
    for further examples.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 别名的配置方式与在角色能力文件中的 cmdlet 和函数类似。有关更多示例，请参阅这些部分（*VisibleCmdlets* 和 *VisibleFunctions*）。
- en: VisibleExternalCommands
  id: totrans-144
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: VisibleExternalCommands
- en: '**VisibleExternalCommands** defines which *traditional Windows executables*
    are visible and can be used by the configured role. All defined external commands
    need to be available on the target system to avoid errors. An example of an external
    command is a standalone executable or an installed program. Always test your configuration
    to ensure all dependencies are considered by your configuration.'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: '**VisibleExternalCommands** 定义了哪些*传统的 Windows 可执行文件*是可见的，并且可以被配置的角色使用。所有定义的外部命令需要在目标系统上可用，以避免错误。外部命令的示例包括独立的可执行文件或已安装的程序。始终测试你的配置，确保所有的依赖项都已被配置考虑。'
- en: 'Using this setting, you can allow external commands and PowerShell scripts.
    Using the following example, you would allow an executable file named **putty.exe**,
    which is located under **C:\tmp\putty.exe**, as well as a **myOwnScript.ps1**
    PowerShell script, which can be found under **C:\scripts\myOwnScript.ps1**:'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此设置，你可以允许外部命令和 PowerShell 脚本。使用以下示例，你将允许一个名为**putty.exe**的可执行文件，该文件位于**C:\tmp\putty.exe**，以及一个名为**myOwnScript.ps1**的
    PowerShell 脚本，该脚本位于**C:\scripts\myOwnScript.ps1**：
- en: '[PRE10]'
  id: totrans-147
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Make sure that you have thoroughly reviewed and tested the script you’re exposing
    and that you have implemented appropriate measures to prevent unauthorized tampering.
    If you are exposing a script or an executable, always ensure that you have complete
    control over it and are confident that it will not compromise your configuration.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 确保你已彻底审查并测试了你将暴露的脚本，并且已经实施了适当的措施以防止未经授权的篡改。如果你暴露的是脚本或可执行文件，务必确保你对它有完全的控制，并且确信它不会危及你的配置。
- en: VisibleProviders
  id: totrans-149
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: VisibleProviders
- en: No PowerShell *providers* are available in JEA sessions by default, but by using
    **VisibleProviders**, you can define which ones are visible and can be used by
    the configured role. All providers defined need to be available on the target
    system to avoid errors.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，在 JEA 会话中没有可用的 PowerShell *提供程序*，但通过使用**VisibleProviders**，你可以定义哪些提供程序是可见的，并且可以由配置的角色使用。所有定义的提供程序需要在目标系统上可用，以避免出现错误。
- en: 'To get a full list of providers, run **Get-PSProvider**, as shown in the following
    screenshot:'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 要获取提供程序的完整列表，可以运行**Get-PSProvider**，如以下截图所示：
- en: '![Figure 10.9 – Getting a full list of available providers](image/B16679_10_009.jpg)'
  id: totrans-152
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.9 – 获取可用提供程序的完整列表](image/B16679_10_009.jpg)'
- en: Figure 10.9 – Getting a full list of available providers
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.9 – 获取可用提供程序的完整列表
- en: 'For example, if you want to make the **Registry** provider available and, with
    it, also its **HKEY_LOCAL_MACHINE** (**HKLM**) and **HKEY_CURRENT_USER** (**HKCU**)
    drives, the configuration would look like this:'
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果你希望使**Registry**提供程序可用，并且随之也使其**HKEY_LOCAL_MACHINE**（**HKLM**）和**HKEY_CURRENT_USER**（**HKCU**）驱动器可用，配置将如下所示：
- en: '[PRE11]'
  id: totrans-155
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Only make providers available if it’s really necessary for the role that you
    are configuring. If this role does not operate with the registry on a regular
    basis, consider writing a script or a function instead, if the task is repeatable.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 仅在角色确实需要时才使提供程序可用。如果此角色不经常与注册表操作，考虑编写脚本或函数来代替，如果该任务是可重复的。
- en: ModulesToImport
  id: totrans-157
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ModulesToImport
- en: 'Using the **ModulesToImport** parameter, you can define which modules will
    be imported in the current session. Please note that the modules already need
    to be installed before they can be imported:'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**ModulesToImport**参数，你可以定义当前会话中将要导入的模块。请注意，模块必须事先安装，才能导入。
- en: '[PRE12]'
  id: totrans-159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Again, it is possible to use hash tables to specify more details. The preceding
    example would import the **EventList** module in version *2.0.2*. Please make
    sure to use **VisibleFunctions** and/or **VisibleCmdlets** to restrict which functions
    or cmdlets can be used in this session.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 同样，你可以使用哈希表来指定更多详细信息。前面的示例将导入版本为*2.0.2*的**EventList**模块。请确保使用**VisibleFunctions**和/或**VisibleCmdlets**来限制此会话中可以使用的函数或
    cmdlet。
- en: ScriptsToProcess
  id: totrans-161
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ScriptsToProcess
- en: The specified script file(s) will be executed once the session is established,
    like a startup script. The path to the script needs to be defined as a full or
    an absolute path.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 指定的脚本文件将在会话建立后执行，类似于启动脚本。脚本的路径需要定义为完整路径或绝对路径。
- en: The **ScriptsToProcess** parameter allows you to add configured scripts to this
    role’s JEA session, which then will be run in the context of the session. Of course,
    the script needs to be available on the target system.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: '**ScriptsToProcess** 参数允许你将已配置的脚本添加到该角色的 JEA 会话中，然后在会话的上下文中运行。当然，脚本需要在目标系统上可用。'
- en: 'The script specified is run as soon as a connection to this session is established:'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 指定的脚本会在建立与此会话的连接时立即运行：
- en: '[PRE13]'
  id: totrans-165
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: If **ScriptsToProcess** is configured for a role within the role capability
    file, it only applies to this role. If it’s configured within a session configuration
    file, it applies to all roles that are linked to this particular session.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 如果**ScriptsToProcess**在角色能力文件中为某个角色配置，它仅适用于该角色。如果在会话配置文件中进行配置，则适用于所有与该会话关联的角色。
- en: AliasDefinitions
  id: totrans-167
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: AliasDefinitions
- en: 'You can use this section to define aliases that were not already defined on
    the target system and will be only used in the current JEA session:'
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用此部分定义在目标系统上未定义且仅在当前JEA会话中使用的别名：
- en: '[PRE14]'
  id: totrans-169
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Don’t forget to also add the alias to **VisibleAliases** to make it available
    in the session.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 别忘了还要将别名添加到**VisibleAliases**中，以使其在会话中可用。
- en: FunctionDefinitions
  id: totrans-171
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: FunctionDefinitions
- en: You can use this section to define functions that are not available on the target
    system and will be only used in the current JEA session.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用此部分定义目标系统上不可用且仅在当前JEA会话中使用的函数。
- en: 'If you define a function within **FunctionDefinitions**, make sure to also
    configure it in the **VisibleFunctions** section:'
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你在**FunctionDefinitions**中定义了函数，确保在**VisibleFunctions**部分也进行配置：
- en: '[PRE15]'
  id: totrans-174
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: This example creates a **Restart-PrintSpooler** custom function that first checks
    if the spooler service is running. If it’s running, it will be restarted, and
    if it’s not running, it will attempt to be started.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 这个示例创建了一个**Restart-PrintSpooler**自定义函数，首先检查打印机服务是否正在运行。如果正在运行，它将重新启动；如果没有运行，它将尝试启动。
- en: If you are referring to other modules, use the **fully qualified module name**
    (**FQMN**) instead of aliases.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你引用了其他模块，请使用**完全限定模块名称**（**FQMN**）而不是别名。
- en: Instead of writing a lot of custom functions, it may be easier to write a PowerShell
    script module and configure **VisibleFunctions** and **ModulesToImport**.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 与其编写大量自定义函数，不如编写一个PowerShell脚本模块并配置**VisibleFunctions**和**ModulesToImport**。
- en: VariableDefinitions
  id: totrans-178
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: VariableDefinitions
- en: 'You can use this section to define variables that will be only used in the
    current JEA session. Variables are defined within a hash table. Variables can
    be statically or dynamically set:'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用此部分定义只在当前JEA会话中使用的变量。变量通过哈希表来定义。变量可以静态设置或动态设置：
- en: '[PRE16]'
  id: totrans-180
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'The following code line is an example of a static variable and a dynamic variable
    set using **VariableDefinitions**:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 以下代码行是使用**VariableDefinitions**设置静态变量和动态变量的示例：
- en: '[PRE17]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Two variables would be defined in this example: while the first variable, **$TestShare1**,
    is dynamically set and refers to where the **$Env:TEMP** environment variable
    would lead to, the second one, **$TestShare2**, is static and would always point
    to **''C:\tmp\TestShare''**.'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 这个示例将定义两个变量：第一个变量**$TestShare1**是动态设置的，指向**$Env:TEMP**环境变量所指向的位置；第二个变量**$TestShare2**是静态的，始终指向**'C:\tmp\TestShare'**。
- en: Variables can also have options configured. This parameter is optional and is
    **None** by default. Acceptable parameters are **None**, **ReadOnly**, **Constant**,
    **Private**, or **AllScope**.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 变量也可以配置选项。此参数是可选的，默认值是**None**。可接受的参数有**None**、**ReadOnly**、**Constant**、**Private**或**AllScope**。
- en: EnvironmentVariables
  id: totrans-185
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: EnvironmentVariables
- en: 'You can use this section to define environment variables that will be only
    used in the current JEA session. Environment variables are defined as hash tables:'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用此部分定义仅在当前JEA会话中使用的环境变量。环境变量通过哈希表来定义：
- en: '[PRE18]'
  id: totrans-187
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: The previous example would set the environment **Path** environment variable
    to contain the **'%SYSTEMROOT%\system32; %SYSTEMROOT%\System32\WindowsPowerShell\v1.0\;C:\Program
    Files\PowerShell\7\;C:\Program Files\Git\cmd'** string to enable programs such
    as Windows PowerShell, PowerShell 7, and Git to find their executables and run
    without prompting the user.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 上面的示例会将环境**Path**变量设置为包含**'%SYSTEMROOT%\system32; %SYSTEMROOT%\System32\WindowsPowerShell\v1.0\;C:\Program
    Files\PowerShell\7\;C:\Program Files\Git\cmd'**字符串，从而使像Windows PowerShell、PowerShell
    7和Git等程序能够找到它们的可执行文件并无需提示用户即可运行。
- en: TypesToProcess
  id: totrans-189
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: TypesToProcess
- en: 'You can use **TypesToProcess** to specify **types.ps1xml** files that should
    be added to the configured session. Type files are usually specified as **.ps1xml**
    files. Use the full or absolute path to define type files in the role capability
    file:'
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用**TypesToProcess**来指定应该添加到配置会话中的**types.ps1xml**文件。类型文件通常指定为**.ps1xml**文件。使用完整或绝对路径在角色能力文件中定义类型文件：
- en: '[PRE19]'
  id: totrans-191
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'You can find more information about type files in the official documentation:'
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在官方文档中找到关于类型文件的更多信息：
- en: '[https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_types.ps1xml](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_types.ps1xml)'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_types.ps1xml](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_types.ps1xml)'
- en: FormatsToProcess
  id: totrans-194
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: FormatsToProcess
- en: 'You can use the **FormatsToProcess** parameter to specify which formatting
    files should be loaded in the current session. Similar to type files, formatting
    files are also configured within files that end with **.ps1xml**. Also, for **FormatsToProcess**,
    the path must be specified as a full or an absolute path:'
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用**FormatsToProcess**参数来指定当前会话中应该加载哪些格式化文件。类似于类型文件，格式化文件也配置在以**.ps1xml**结尾的文件中。另外，对于**FormatsToProcess**，路径必须指定为完整路径或绝对路径：
- en: '[PRE20]'
  id: totrans-196
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'You can find more information about formatting files in the official documentation:'
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在官方文档中找到更多关于格式化文件的信息：
- en: '[https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_format.ps1xml](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_format.ps1xml)'
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.microsoft.com/zh-cn/powershell/module/microsoft.powershell.core/about/about_format.ps1xml](https://docs.microsoft.com/zh-cn/powershell/module/microsoft.powershell.core/about/about_format.ps1xml)'
- en: AssembliesToLoad
  id: totrans-199
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: AssembliesToLoad
- en: 'To make the types contained in binary files available for the scripts and functions
    that you write, use the **AssembliesToLoad** parameter to specify the desired
    assemblies. This enables you to leverage the functionality provided by these assemblies
    in the JEA session:'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使二进制文件中包含的类型对你编写的脚本和函数可用，可以使用**AssembliesToLoad**参数来指定所需的程序集。这样，你就可以在JEA会话中利用这些程序集提供的功能：
- en: '[PRE21]'
  id: totrans-201
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'If you want to learn more about role capability files in JEA and more options
    such as creating custom functions especially for one role, please refer to the
    official documentation:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想了解更多关于JEA角色功能文件以及更多选项，比如为某个角色创建专用的自定义函数，请参考官方文档：
- en: '[https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/role-capabilities](https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/role-capabilities)'
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.microsoft.com/zh-cn/powershell/scripting/learn/remoting/jea/role-capabilities](https://docs.microsoft.com/zh-cn/powershell/scripting/learn/remoting/jea/role-capabilities)'
- en: If you want a role capability file to be updated, you can do this at any time
    by simply saving changes to the role capability file. Any new JEA session that
    is established after the changes were made will represent the updated changes.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你希望更新角色功能文件，可以随时通过保存对角色功能文件的更改来完成。任何在更改后建立的新的JEA会话都将反映这些更新的更改。
- en: 'Role capabilities can also be merged when a user is granted access to multiple
    role capabilities. Please refer to the official documentation to learn which permissions
    will be applied in this case:'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 当用户被授予多个角色功能时，这些角色功能也可以合并。请参考官方文档了解在这种情况下将应用哪些权限：
- en: '[https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/role-capabilities](https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/role-capabilities)#how-role-capabilities-are-merged'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.microsoft.com/zh-cn/powershell/scripting/learn/remoting/jea/role-capabilities](https://docs.microsoft.com/zh-cn/powershell/scripting/learn/remoting/jea/role-capabilities)#how-role-capabilities-are-merged'
- en: Now that you have defined your roles—for a better overview, create each one
    in a separate role capability file—it’s time to assign them to certain users and
    groups and define session-specific parameters. This can be done within a session
    configuration file.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经定义了你的角色——为了更好的概览，可以将每个角色创建在单独的角色功能文件中——接下来是将这些角色分配给特定用户和组，并定义会话特定的参数。这可以通过会话配置文件来完成。
- en: Session configuration file
  id: totrans-208
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 会话配置文件
- en: Using a session configuration file, you can specify who is allowed to connect
    to which endpoint. Not only can you map users and groups to specific roles, but
    you can also configure global session settings such as which scripts should be
    executed when connected to the session, logging policies, or which identity will
    be used when you connect (for example, virtual accounts or **group Managed Service
    Accounts** (**gMSAs**)). If you want to, you can configure session files on a
    per-machine basis.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 使用会话配置文件，你可以指定谁可以连接到哪个端点。你不仅可以将用户和组映射到特定的角色，还可以配置全局会话设置，比如连接到会话时应该执行哪些脚本、日志策略或连接时将使用哪个身份（例如，虚拟账户或**组托管服务账户**（**gMSAs**））。如果需要，你还可以按每台机器配置会话文件。
- en: 'You can create a skeleton session configuration file using the **New-PSSessionConfigurationFile**
    cmdlet:'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用**New-PSSessionConfigurationFile** cmdlet创建骨架会话配置文件：
- en: '[PRE22]'
  id: totrans-211
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Similar to creating a skeleton role capability file, a prepopulated session
    configuration file that can be edited is created:'
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 类似于创建骨架角色功能文件，会创建一个可以编辑的预填充会话配置文件：
- en: '![Figure 10.10 – An empty skeleton session configuration file](image/B16679_10_010.jpg)'
  id: totrans-213
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.10 – 一个空的骨架会话配置文件](image/B16679_10_010.jpg)'
- en: Figure 10.10 – An empty skeleton session configuration file
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.10 – 一个空的骨架会话配置文件
- en: 'In the session configuration file, there are again some *general parameters*
    that help you describe this file. Some of them are listed here:'
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 在会话配置文件中，还有一些*通用参数*帮助您描述此文件。以下是其中的一些：
- en: '**SchemaVersion**: Describes the schema version number of this document, which
    is usually **2.0.0.0**, if not specified otherwise.'
  id: totrans-216
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**SchemaVersion**：描述此文档的模式版本号，通常是 **2.0.0.0**，如果没有另行指定。'
- en: '**GUID**: A GUID is a unique, randomly generated UID to identify this file.'
  id: totrans-217
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**GUID**：GUID 是一个唯一的、随机生成的 UID，用于标识此文件。'
- en: '**Author**: The author who created this document.'
  id: totrans-218
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Author**：创建此文档的作者。'
- en: '**Description**: A description of this session configuration file. It makes
    sense to be specific so that you can easily edit and operate your base of growing
    configuration files.'
  id: totrans-219
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Description**：此会话配置文件的描述。最好具体描述，这样您可以轻松编辑和操作日益增长的配置文件库。'
- en: Let’s look at which other options you can configure using the session configuration
    file.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看您还可以使用会话配置文件配置哪些其他选项。
- en: Session type
  id: totrans-221
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 会话类型
- en: The session type indicates what kind of session is created (language mode-wise)
    and which commands are allowed. For a JEA session configuration file, you should
    *always configure* **SessionType = '****RestrictedRemoteServer'**.
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 会话类型指示创建了哪种类型的会话（按语言模式划分）以及允许哪些命令。在 JEA 会话配置文件中，您应该*始终配置* **SessionType = '****RestrictedRemoteServer'**。
- en: 'In regular session files, you can use the following values for this parameter:'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 在常规会话文件中，您可以为此参数使用以下值：
- en: '**Default**: This configuration provides an *unrestricted PowerShell endpoint*.
    This means that users can run *any* command that is available on the system. It
    is not recommended to use this session type when configuring JEA.'
  id: totrans-224
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Default**：此配置提供*不受限制的 PowerShell 终端*。这意味着用户可以运行系统上可用的*任何*命令。在配置 JEA 时不推荐使用此会话类型。'
- en: '**Empty**: No modules and no commands are added to the session. Only if you
    had configured **VisibleCmdlets**, **VisibleFunctions**, and other parameters
    in the session configuration file would your session be populated. Don’t use these
    settings when configuring JEA, unless you have a use case to even restrict the
    cmdlets that are allowed when configuring **RestrictedRemoteServer**.'
  id: totrans-225
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Empty**：会话中未添加任何模块和命令。仅当您在会话配置文件中配置了 **VisibleCmdlets**、**VisibleFunctions**
    和其他参数时，您的会话才会被填充。在配置 JEA 时不要使用这些设置，除非您有用例需要限制在配置 **RestrictedRemoteServer** 时允许的
    cmdlet。'
- en: '**RestrictedRemoteServer**: This value should be used when creating a JEA session
    configuration file. It appropriately limits the language mode and only imports
    a small set of essential commands, such as **Exit-PSSession**, **Get-Command**,
    **Get-FormatData**, **Get-Help**, **Measure-Object**, **Out-Default**, and **Select-Object**,
    which are sufficient for most administrative tasks. This configuration provides
    a higher level of security as it restricts access to potentially dangerous cmdlets
    and functions.'
  id: totrans-226
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**RestrictedRemoteServer**：当创建 JEA 会话配置文件时，应使用此值。它适当地限制了语言模式，并且仅导入一小部分基本命令，如
    **Exit-PSSession**、**Get-Command**、**Get-FormatData**、**Get-Help**、**Measure-Object**、**Out-Default**
    和 **Select-Object**，这些足以完成大多数管理任务。此配置提供更高的安全级别，因为它限制了访问潜在危险的 cmdlet 和函数。'
- en: 'When creating the base session configuration file, you can use the **-SessionType**
    parameter to directly configure the session type, like so:'
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建基础会话配置文件时，您可以使用 **-SessionType** 参数直接配置会话类型，如下所示：
- en: '[PRE23]'
  id: totrans-228
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: TranscriptDirectory
  id: totrans-229
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: TranscriptDirectory
- en: Session transcripts record all commands that are being run in a particular session,
    as well as the output. It is recommended to use session transcripts for every
    user and audit which commands are being executed. This can be achieved by using
    the **TranscriptDirectory** parameter.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 会话记录会记录特定会话中运行的所有命令以及其输出。建议对每个用户使用会话记录并审计正在执行的命令。这可以通过使用 **TranscriptDirectory**
    参数实现。
- en: First, make sure to preconfigure a folder on the JEA endpoint to store the transcripts.
    This folder needs to be a protected folder so that regular users cannot modify
    or delete any data within this folder. Also, make sure that the local system account
    is configured to have read and write access, as this account will be used to create
    transcript files.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，确保在 JEA 端点上预先配置一个文件夹来存储转录文件。此文件夹需要是一个受保护的文件夹，以确保普通用户无法修改或删除该文件夹中的任何数据。此外，确保本地系统帐户已配置为具有读写访问权限，因为该帐户将用于创建转录文件。
- en: In the best case, also make sure that the transcript files are regularly uploaded
    and parsed to your **Security Information and Event Management** (**SIEM**) system
    so that they are in a central location. Also, make sure to implement a mechanism
    to rotate log files so that the hard disk does not run out of space.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 最好确保转录文件定期上传并解析到你的**安全信息和事件管理**（**SIEM**）系统中，以便它们存储在一个集中位置。还要确保实现日志文件轮换机制，以避免硬盘空间耗尽。
- en: 'Everything set up? Good! Now, it’s time to configure the path to the preconfigured
    folder in the session configuration file, as follows:'
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 一切都配置好了吗？很好！现在，是时候在会话配置文件中配置预先配置的文件夹路径了，具体如下：
- en: '[PRE24]'
  id: totrans-234
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: Using the preceding configuration would write all transcripts to the **C:\Jea-Transcripts**
    folder. New files will always be generated using a timestamp so that no file is
    overwritten.
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 使用前述配置将所有转录写入**C:\Jea-Transcripts**文件夹。新文件将始终使用时间戳生成，以确保没有文件被覆盖。
- en: Additional to the **TranscriptDirectory** parameter, also make sure to implement
    proper auditing. See [*Chapter 4*](B16679_04_Final_PD.xhtml#_idTextAnchor090),
    *Detection – Auditing and Monitoring*, for more details.
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 除了**TranscriptDirectory**参数之外，还要确保实现适当的审计。有关详细信息，请参阅[*第 4 章*](B16679_04_Final_PD.xhtml#_idTextAnchor090)，*检测
    – 审计与监控*。
- en: Configuring the JEA identity
  id: totrans-237
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 配置 JEA 身份
- en: When using JEA, you don’t use your regular account on the target system. But
    which account will be used instead?
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 JEA 时，你不会在目标系统上使用常规帐户。那么，实际上会使用哪个帐户呢？
- en: 'With JEA, there are two possibilities when it comes to identities: using either
    a **virtual account** or a **gMSA**. Using a virtual account is the method that
    you should always prefer unless you need access to network resources during the
    JEA session. In the following sections, we will learn more about both options
    and explore why a virtual account is a more secure option.'
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 在 JEA 中，身份有两种选择：使用**虚拟帐户**或**gMSA**。除非在 JEA 会话中需要访问网络资源，否则你应该始终优先选择使用虚拟帐户。在接下来的部分中，我们将详细了解这两种选择，并探讨为什么虚拟帐户是更安全的选项。
- en: Virtual account
  id: totrans-240
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 虚拟帐户
- en: When in doubt, configuring a virtual account should always be your preferred
    option. A virtual account is a temporary administrator account that is created
    at the start of a JEA session and is destroyed once the session ends. This means
    that it only lasts for the duration of the remote session, making it a secure
    option for providing temporary administrative access. A huge advantage is that
    at no point in time do reusable credentials enter the system.
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 如果有疑问，配置虚拟帐户应该始终是你的首选选项。虚拟帐户是一个临时管理员帐户，在 JEA 会话开始时创建，并在会话结束时销毁。这意味着它只在远程会话期间存在，是提供临时管理员访问的安全选项。一个巨大优势是，在任何时候，都没有可重用的凭据进入系统。
- en: When connecting to an endpoint, the non-administrator user connects and runs
    all commands in the session as a privileged virtual account. This account is a
    local administrator or a domain administrator account on **domain controllers**
    (**DCs**) but nevertheless is restricted to running only the commands that are
    allowed for this role.
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 当连接到端点时，非管理员用户会以特权虚拟帐户身份连接并在会话中运行所有命令。此帐户是**域控制器**（**DCs**）上的本地管理员或域管理员帐户，但仍然受到限制，只能运行此角色允许的命令。
- en: To follow this example more easily, I have created a simple script to create
    a **ServerOperator** role and register it together with a session configuration
    that lets the connecting user connect as a virtual account. Let’s use this configuration
    to demonstrate the examples within this chapter.
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 为了更容易跟随这个示例，我创建了一个简单的脚本来创建一个**ServerOperator**角色，并与一个会话配置一起注册，让连接用户以虚拟帐户身份连接。让我们使用这个配置来演示本章中的示例。
- en: You can find the script in the GitHub repository of this book under [https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA-ServerOperator.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA-ServerOperator.ps1).
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在本书的GitHub仓库中找到脚本，地址为[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA-ServerOperator.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA-ServerOperator.ps1)。
- en: In my example, I execute all commands on **PSSec-Srv01**, a Windows 2019 server
    that was joined to the **PSSec** domain.
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 在我的示例中，我在**PSSec-Srv01**上执行所有命令，这是一台加入**PSSec**域的Windows 2019服务器。
- en: First, make sure that the account you want to configure the **ServerOperator**
    role for is present in your environment, and possibly adjust the username in the
    script. In my demo example, the user is **PSSec\mwiesner**.
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，确保你要为其配置**ServerOperator**角色的帐户已存在于你的环境中，并且可能需要调整脚本中的用户名。在我的示例中，用户是**PSSec\mwiesner**。
- en: Then, run the **JEA-ServerOperator.ps1** script from the GitHub repository to
    ensure that the **ServerOperator** JEA endpoint was created successfully.
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，从GitHub仓库运行**JEA-ServerOperator.ps1**脚本，确保**ServerOperator** JEA端点已成功创建。
- en: 'Once the endpoint has been successfully created, establish a session to the
    localhost, using the **ServerOperator** JEA session:'
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦端点成功创建，使用**ServerOperator** JEA会话建立到本地主机的会话：
- en: '[PRE25]'
  id: totrans-249
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'Once a JEA session is established that relies on a virtual account, let’s check
    the actual local user accounts by running the **Get-LocalUser** command from a
    separate elevated PowerShell console. As you can see, there was no additional
    local account created for the JEA connection:'
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦建立了依赖虚拟帐户的JEA会话，让我们通过在单独的提升权限的PowerShell控制台中运行**Get-LocalUser**命令，来检查实际的本地用户帐户。如你所见，没有为JEA连接创建额外的本地帐户：
- en: '![Figure 10.11 – No additional local account was created](image/B16679_10_011.jpg)'
  id: totrans-251
  prefs: []
  type: TYPE_IMG
  zh: '![图10.11 – 未创建额外的本地帐户](image/B16679_10_011.jpg)'
- en: Figure 10.11 – No additional local account was created
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.11 – 未创建额外的本地帐户
- en: 'To verify which virtual accounts are or were signed in during the current uptime
    of the machine, I have written a script to help you see which virtual accounts
    were created for your JEA sessions:'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 为了验证在当前机器运行时间内哪些虚拟帐户已登录或正在登录，我编写了一个脚本，帮助你查看为JEA会话创建了哪些虚拟帐户：
- en: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/Get-VirtualAccountLogons.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/Get-VirtualAccountLogons.ps1)'
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/Get-VirtualAccountLogons.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/Get-VirtualAccountLogons.ps1)'
- en: The script uses **Get-CimInstance** to retrieve information about logged-on
    users and their logon sessions, merges the information, and displays which virtual
    accounts were created and whether the session is still active or inactive.
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本使用**Get-CimInstance**检索有关登录用户及其登录会话的信息，合并这些信息，并显示哪些虚拟帐户已创建以及会话是仍然活跃还是不活跃。
- en: 'The following screenshot shows you the output of the **Get-VirtualAccountLogons.ps1**
    script:'
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: 以下截图展示了**Get-VirtualAccountLogons.ps1**脚本的输出：
- en: '![Figure 10.12 – Virtual account usage for the current uptime can be assessed
    using the Get-VirtualAccountLogons.ps1 script](image/B16679_10_012.jpg)'
  id: totrans-257
  prefs: []
  type: TYPE_IMG
  zh: '![图10.12 – 可以使用Get-VirtualAccountLogons.ps1脚本评估当前运行时间的虚拟帐户使用情况](image/B16679_10_012.jpg)'
- en: Figure 10.12 – Virtual account usage for the current uptime can be assessed
    using the Get-VirtualAccountLogons.ps1 script
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.12 – 可以使用Get-VirtualAccountLogons.ps1脚本评估当前运行时间的虚拟帐户使用情况
- en: 'All virtual accounts that were created until the operating system reboots are
    cached in the **Common Information Model** (**CIM**) tables, therefore you can
    see past as well as current virtual account connections. If the session is still
    established, the script indicates it with **ActiveSession: True**.'
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: '所有在操作系统重启之前创建的虚拟帐户都会缓存到**通用信息模型**（**CIM**）表中，因此你可以看到过去和当前的虚拟帐户连接。如果会话仍然建立，脚本会显示**ActiveSession:
    True**。'
- en: All virtual account names that are generated through an established JEA session
    follow the **"WinRM VA_<number>_<domain>_<username>"** scheme. If multiple sessions
    from the same user account were to be established, the number would be raised
    accordingly.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 所有通过已建立的 JEA 会话生成的虚拟帐户名称都遵循 **"WinRM VA_<number>_<domain>_<username>"** 方案。如果同一用户帐户建立了多个会话，则该数字会相应增加。
- en: Did you know?
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: 你知道吗？
- en: Retrieving a list of all current users is also possible by using the deprecated
    **Get-WmiObject win32_process).GetOwner().User** **Windows Management** **Instrumentation**
    (**WMI**) command.
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 还可以通过使用已弃用的 **Get-WmiObject win32_process).GetOwner().User** **Windows Management**
    **Instrumentation** (**WMI**) 命令来检索当前所有用户的列表。
- en: Therefore, if you don’t need to access network resources, the best option to
    configure the identity of your JEA session is to use a virtual account.
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，如果你不需要访问网络资源，配置 JEA 会话身份的最佳选择是使用虚拟帐户。
- en: gMSA
  id: totrans-264
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: gMSA
- en: If you need to access network resources (for example, other servers or network
    shares), a gMSA is an alternative to a virtual account.
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你需要访问网络资源（例如，其他服务器或网络共享），则 gMSA 是虚拟帐户的替代方案。
- en: 'You can find more information on how to create and configure a gMSA in the
    official documentation:'
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在官方文档中找到有关如何创建和配置 gMSA 的更多信息：
- en: https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview
- en: You can use a gMSA account to authenticate against your domain and therefore
    access resources on any domain-joined machine. The rights a user gets by using
    a gMSA account are determined by the resources that will be accessed. Only if
    a gMSA account was explicitly granted admin privileges causes the user using the
    gMSA account have administrator rights.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用 gMSA 帐户对域进行身份验证，从而访问任何已加入域的计算机上的资源。用户通过 gMSA 帐户获得的权限由将要访问的资源决定。只有在显式授予
    gMSA 帐户管理员权限时，使用该帐户的用户才会拥有管理员权限。
- en: A gMSA is an account that is managed by Active Directory and changes its password
    on a frequent basis. As such, the password could be reused by an adversary—if
    captured—but only for a limited time.
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: gMSA 是由 Active Directory 管理的帐户，并且会定期更改其密码。因此，密码可能会被对手重新使用——如果被捕获——但仅限于有限的时间。
- en: 'In the best case, use a virtual account; only use gMSA accounts when your tasks
    require access to network resources for some particular reasons, such as the following:'
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 最理想的情况是使用虚拟帐户；仅在你的任务确实需要访问某些网络资源时，才使用 gMSA 帐户，典型的情况包括：
- en: It is more difficult to determine who performed which actions under the identity
    of a gMSA as the same account is used by every user connecting to a session with
    the same gMSA account. To determine which user performed which action, you would
    need to correlate PowerShell session transcript files with the according events
    from event logs.
  id: totrans-271
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 gMSA 身份下，确定是谁执行了哪些操作更加困难，因为同一个帐户是所有连接到同一 gMSA 会话的用户共享使用的。要确定是哪位用户执行了哪项操作，你需要将
    PowerShell 会话的转录文件与事件日志中的相应事件进行关联。
- en: There is a possibility to grant more rights than the JEA configuration plans
    to, as a gMSA account might have access to many network resources that are not
    needed. Always follow the least-privilege principle to restrict your JEA sessions
    effectively.
  id: totrans-272
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 有可能授予比 JEA 配置计划更多的权限，因为 gMSA 帐户可能有权访问许多不需要的网络资源。始终遵循最小权限原则，以有效限制你的 JEA 会话。
- en: gMSAs are only available starting from Windows PowerShell 5.1 or higher and
    can only be used on domain-joined machines. Of course, it is also possible to
    use a standalone domain if you don’t want to join the machine to your production
    domain.
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: gMSA 仅适用于从 Windows PowerShell 5.1 或更高版本开始，并且只能在已加入域的计算机上使用。当然，如果你不希望将计算机加入生产域，也可以使用独立域。
- en: Choosing the JEA identity
  id: totrans-274
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 选择 JEA 身份
- en: Once you have chosen the identity you want to use to connect to your JEA session,
    it’s time to configure it. You will need to configure either a virtual account
    or a gMSA, and you can do this in your JEA session configuration file.
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你选择了想要用于连接 JEA 会话的身份，就可以开始配置它。你需要配置一个虚拟帐户或 gMSA，并可以在 JEA 会话配置文件中进行设置。
- en: 'Configure a local virtual account using the following options:'
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下选项配置本地虚拟帐户：
- en: '**RunAsVirtualAccount = $****true**'
  id: totrans-277
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**RunAsVirtualAccount = $****true**'
- en: '**RunAsVirtualAccountGroups = ''****NetworkOperator'', ''NetworkAuditor''**'
  id: totrans-278
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**RunAsVirtualAccountGroups = ''****NetworkOperator'', ''NetworkAuditor''**'
- en: Using the **RunVirtualAccountGroups** parameter, you can define in which groups
    the virtual account should reside. To prevent the virtual account from being added
    to the local or domain administrators group by default, you will need to specify
    one or more security groups.
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**RunVirtualAccountGroups**参数，你可以定义虚拟帐户应该在哪些组中存在。为了防止虚拟帐户默认被添加到本地或域管理员组中，你需要指定一个或多个安全组。
- en: 'Define a gMSA using the **GroupManagedServiceAccount** parameter, like so:'
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**GroupManagedServiceAccount**参数定义gMSA，如下所示：
- en: '[PRE26]'
  id: totrans-281
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'Also, refer to the official session configuration documentation:'
  id: totrans-282
  prefs: []
  type: TYPE_NORMAL
  zh: 另外，参考官方的会话配置文档：
- en: '[https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/session-configurations](https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/session-configurations
    )'
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/session-configurations](https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/session-configurations)'
- en: ScriptsToProcess
  id: totrans-284
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ScriptsToProcess
- en: Similar to **ScriptsToProcess**, which can be configured within the role capability
    file. See the *ScriptsToProcess* subsection of the section entitled *The role
    capability file* to learn more about it and how to configure it.
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 类似于**ScriptsToProcess**，它可以在角色能力文件中进行配置。请参阅名为*角色能力文件*的章节中的*ScriptsToProcess*子节，了解更多信息以及如何配置它。
- en: If **ScriptsToProcess** is configured for a role within the role capability
    file, it only applies to this role. If it’s configured within a session configuration
    file, it applies to all roles that are linked to this particular session.
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
  zh: 如果在角色能力文件中为角色配置了**ScriptsToProcess**，它只适用于该角色。如果在会话配置文件中配置，它适用于所有与此特定会话关联的角色。
- en: RoleDefinitions
  id: totrans-287
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 角色定义
- en: 'Role definitions connect the roles that you have configured in the role capability
    file with the current session configuration file and can be configured within
    a hash table, like so:'
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
  zh: 角色定义将你在角色能力文件中配置的角色与当前会话配置文件连接，并可以在哈希表中进行配置，如下所示：
- en: '[PRE27]'
  id: totrans-289
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: You can assign one or more role capabilities to a user account or to an Active
    Directory group.
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以将一个或多个角色能力分配给用户帐户或活动目录组。
- en: Conditional access
  id: totrans-291
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 条件访问
- en: JEA itself is already a great option to restrict the exact commands a role is
    allowed to execute on an endpoint, but all users or groups that are assigned a
    role are able to run the configured commands. But what if you want to set up more
    restrictions, such as— for example—enforcing the users to also use **multi-factor**
    **authentication** (**MFA**)?
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: JEA本身已经是一个限制角色在终端上执行特定命令的极佳选择，但所有分配了角色的用户或组都能够运行配置的命令。但如果你希望设置更多的限制，比如—例如—强制用户还使用**多因素**
    **认证**（**MFA**）呢？
- en: This is where additional access comes into play. Using the **RequiredGroups**
    parameter, you can enforce that connecting users are part of a defined group—a
    group that you can use to enforce more conditions on the user.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 这时，额外的访问控制起作用了。使用**RequiredGroups**参数，你可以强制要求连接的用户属于一个定义的组——你可以使用这个组来强制对用户施加更多的条件。
- en: Using **And** or **Or** helps you to define more granular rules.
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**And**或**Or**有助于你定义更细化的规则。
- en: 'Using the following example, all connecting users must belong to a security
    group named **MFA-logon**; simply use the **And** condition:'
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下示例，所有连接的用户必须属于名为**MFA-logon**的安全组；只需使用**And**条件：
- en: '[PRE28]'
  id: totrans-296
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'Sometimes, you have different ways to authenticate or to provide additional
    security. So, if you want those connecting users to be either in the **MFA-logon**
    *OR* **smartcard-logon** group, use the **Or** condition, as shown in the following
    example:'
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 有时，你可能有不同的认证方式或额外的安全要求。所以，如果你希望连接的用户属于**MFA-logon** *或* **smartcard-logon**组，可以使用**Or**条件，如以下示例所示：
- en: '[PRE29]'
  id: totrans-298
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: Of course, you can also create more complicated, nested conditions by combining
    **And** and **Or** conditions.
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，你也可以通过结合**And**和**Or**条件来创建更复杂的嵌套条件。
- en: 'In the following example, connecting users need to be part of the **elevated-jea**
    group and need to be either logged in with MFA or a smart card:'
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下示例中，连接的用户需要是**elevated-jea**组的成员，并且需要通过MFA或智能卡进行登录：
- en: '[PRE30]'
  id: totrans-301
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: However, regardless of which configuration option(s) you use, always make sure
    to test that your conditions are applied as planned.
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，无论你使用哪种配置选项，始终确保测试你的条件是否按计划应用。
- en: User drive
  id: totrans-303
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 用户驱动
- en: It is possible to copy files from a JEA session remotely by configuring and
    leveraging a user drive. For example, you can copy log files from your session
    for detailed analysis later on your normal work computer.
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
  zh: 通过配置和利用用户驱动器，可以从JEA会话中远程复制文件。例如，你可以从会话中复制日志文件，以便稍后在你的正常工作计算机上进行详细分析。
- en: 'To configure a user drive with a capacity of 10 MB, use the following configuration:'
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: 要配置一个容量为10MB的用户驱动器，请使用以下配置：
- en: '[PRE31]'
  id: totrans-306
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: After accessing a JEA session that has a user drive configured, you can easily
    copy files from or to the session.
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: 访问已配置用户驱动器的JEA会话后，你可以轻松地从会话中复制文件或将文件复制到会话中。
- en: 'The following example shows how to copy the **myFile.txt** file into your **$ServerOperator**
    JEA session:'
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例展示了如何将**myFile.txt**文件复制到你的**$ServerOperator** JEA会话中：
- en: '[PRE32]'
  id: totrans-309
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'The next example shows how to copy the **access.log** file from the remote
    machine within the **$ServerOperator** JEA session to your local one:'
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个示例展示了如何从**$ServerOperator** JEA会话中的远程计算机复制**access.log**文件到本地会话：
- en: '[PRE33]'
  id: totrans-311
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: Although you can copy files from and into the established JEA session, it is
    not possible to specify the filename or subfolder on the remote machine.
  id: totrans-312
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管你可以从JEA会话中复制文件或将文件复制到该会话中，但无法在远程计算机上指定文件名或子文件夹。
- en: If you want to learn more about PowerShell drives, also have a look at [https://docs.microsoft.com/en-us/powershell/scripting/samples/managing-windows-powershell-drives](https://docs.microsoft.com/en-us/powershell/scripting/samples/managing-windows-powershell-drives).
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想了解更多关于PowerShell驱动器的信息，可以查看[https://docs.microsoft.com/en-us/powershell/scripting/samples/managing-windows-powershell-drives](https://docs.microsoft.com/en-us/powershell/scripting/samples/managing-windows-powershell-drives)。
- en: Access rights (SDDL)
  id: totrans-314
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 访问权限（SDDL）
- en: Access rights to the JEA session are configured per SDDL.
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
  zh: JEA会话的访问权限是通过SDDL进行配置的。
- en: So when you are using JEA, SDDLs will get configured automatically when assigning
    user/group **Access Control Lists (ACL)** to a session configuration. The group
    and the **Security Identifier (SID)** will be both looked up and automatically
    added with the appropriate level of access to the session configuration.
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，当你使用JEA时，SDDL将在为会话配置分配用户/组**访问控制列表（ACL）**时自动进行配置。组和**安全标识符（SID）**会被查找并自动添加到会话配置中，确保拥有适当级别的访问权限。
- en: 'You can find out the SDDL of a session configuration by running the **(Get-PSSessionConfiguration
    –Name <session configuration** **name>).SecurityDescriptorSddl** command:'
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过运行**(Get-PSSessionConfiguration –Name <会话配置名称>).SecurityDescriptorSddl**
    命令来查找会话配置的SDDL：
- en: '![Figure 10.13 – Finding the SDDL of a session configuration](image/B16679_10_013.jpg)'
  id: totrans-318
  prefs: []
  type: TYPE_IMG
  zh: '![图10.13 – 查找会话配置的SDDL](image/B16679_10_013.jpg)'
- en: Figure 10.13 – Finding the SDDL of a session configuration
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.13 – 查找会话配置的SDDL
- en: 'Refer to the official documentation to learn more about the SDDL syntax:'
  id: totrans-320
  prefs: []
  type: TYPE_NORMAL
  zh: 请参考官方文档了解更多关于SDDL语法的信息：
- en: https://docs.microsoft.com/en-us/windows/desktop/secauthz/security-descriptor-definition-language
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
  zh: https://docs.microsoft.com/en-us/windows/desktop/secauthz/security-descriptor-definition-language
- en: Deploying JEA
  id: totrans-322
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 部署JEA
- en: To deploy JEA, you need to understand which commands the users you want to restrict
    are using. If you ask me, this is the hardest part about JEA.
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
  zh: 要部署JEA，你需要了解你想要限制的用户使用了哪些命令。如果你问我，这是JEA中最难的部分。
- en: But there are tools, such as my self-written JEAnalyzer open source project,
    that ease this task massively. I will come back to this tool later in this chapter.
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: 但是有一些工具，例如我自己编写的开源项目JEAnalyzer，可以大大简化这项任务。稍后我会在本章中回到这个工具。
- en: 'Once you have identified the commands used and the users and groups you want
    to restrict, first create a session capability file and a role capability file.
    The following diagram shows the steps you will need to take to deploy JEA:'
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: 确定了要限制的命令和用户/组后，首先创建一个会话能力文件和一个角色能力文件。下图展示了部署JEA所需的步骤：
- en: '![Figure 10.14 – Steps to deploy JEA](image/B16679_10_014.jpg)'
  id: totrans-326
  prefs: []
  type: TYPE_IMG
  zh: '![图10.14 – 部署JEA的步骤](image/B16679_10_014.jpg)'
- en: Figure 10.14 – Steps to deploy JEA
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.14 – 部署JEA的步骤
- en: Once you have created both required files, make sure to check the syntax of
    the session configuration file before deploying the files using the **Test-PSSessionConfigurationFile
    -Path <path to session configuration** **file>** cmdlet.
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
  zh: 创建了两个必需的文件之后，请确保在使用**Test-PSSessionConfigurationFile -Path <会话配置文件的路径>** cmdlet部署文件之前检查会话配置文件的语法。
- en: If a JEA session configuration needs to be changed—for example, to map or remove
    users to or from a role—you will always need to unregister and register the JEA
    session configuration again. If you only want to change roles configured in the
    role capability file, it is enough to simply change the configuration; there’s
    no need to re-register the session configuration.
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: 如果需要更改JEA会话配置，例如，将用户映射或移除到角色中，你将始终需要取消注册并重新注册JEA会话配置。如果只想更改角色能力文件中配置的角色，仅需更改配置，无需重新注册会话配置。
- en: You can also verify which capabilities a specific user would get in a specific
    session by running **Get-PSSessionCapability –ConfigurationName <configuration
    name> -****Username <username>**.
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以通过运行**Get-PSSessionCapability –ConfigurationName <configuration name> -****Username
    <username>**来验证特定用户在特定会话中会获得哪些能力。
- en: Once you are ready to deploy, you will need to decide which deployment mechanism
    you will use. There’s the option to either *register the session manually* or
    to use **Desired State Configuration** (**DSC**) for the deployment.
  id: totrans-331
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦准备好进行部署，你需要决定使用哪种部署机制。可以选择*手动注册会话*或使用**期望状态配置**（**DSC**）进行部署。
- en: Registering manually
  id: totrans-332
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 手动注册
- en: Registering the machine manually is a great option if you just want to test
    your configuration on a few machines or if you only need to administer small environments.
    Of course, you can also script the deployment process using manual registration
    commands, but you still need to find a way to deploy your scripts.
  id: totrans-333
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你只想在少数机器上测试配置，或者只需要管理小型环境，那么手动注册机器是一个不错的选择。当然，你也可以使用手动注册命令来编写部署脚本，但你仍然需要找到一种方法来部署你的脚本。
- en: Therefore for big environments, DSC might be the better solution for you.
  id: totrans-334
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，对于大型环境，DSC可能是更适合的解决方案。
- en: Before registering manually, ensure that at least one role was added to the
    **RoleCapabilities** file and that you created and tested the accompanying session
    configuration file.
  id: totrans-335
  prefs: []
  type: TYPE_NORMAL
  zh: 在手动注册之前，请确保至少向**RoleCapabilities**文件中添加了一个角色，并且已经创建并测试了附带的会话配置文件。
- en: In order to register your JEA configuration successfully, you will need to be
    a local administrator on the system(s).
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
  zh: 为了成功注册JEA配置，你需要在系统上具有本地管理员权限。
- en: 'If everything is in place, adjust the following command to your configuration
    and run it on the endpoint to configure:'
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一切就绪，请根据你的配置调整以下命令并在终端上运行它进行配置：
- en: '[PRE34]'
  id: totrans-338
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'After registering a session, make sure to restart the WinRM service to ensure
    that the new session is loaded and active:'
  id: totrans-339
  prefs: []
  type: TYPE_NORMAL
  zh: 注册会话后，确保重启WinRM服务，以确保新会话已加载并处于活动状态：
- en: '[PRE35]'
  id: totrans-340
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'For a working example, refer to the demo configuration file on this book’s
    GitHub repository:'
  id: totrans-341
  prefs: []
  type: TYPE_NORMAL
  zh: 有关工作示例，请参考本书GitHub仓库中的演示配置文件：
- en: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA-ServerOperator.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA-ServerOperator.ps1)'
  id: totrans-342
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA-ServerOperator.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEA-ServerOperator.ps1)'
- en: Deploying via DSC
  id: totrans-343
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 通过DSC进行部署
- en: In big environments, it might be worthwhile to leverage DSC. DSC is a really
    cool way to tell your remote servers to “make it so” and to apply your chosen
    configuration regularly.
  id: totrans-344
  prefs: []
  type: TYPE_NORMAL
  zh: 在大型环境中，利用DSC可能是值得的。DSC是一种非常酷的方式，可以让你的远程服务器“照做”，并定期应用你选择的配置。
- en: Even if someone were to change the configuration on the server, with DSC configured,
    your servers could reset themselves without any intervention from an administrator,
    as they can pull and adjust their own configuration to your configured baseline
    on a frequent basis.
  id: totrans-345
  prefs: []
  type: TYPE_NORMAL
  zh: 即使有人更改了服务器上的配置，通过配置DSC后，你的服务器也可以自我重置，无需管理员干预，因为它们可以定期拉取并调整其配置，确保与预设的基准一致。
- en: DSC is a big topic, therefore I cannot describe the entire technique in detail,
    but if you want to learn more about it, review [*Chapter 13*](B16679_13_Final_PD.xhtml#_idTextAnchor341)*,
    What Else? – Further Mitigations and Resources*, and have a look at the official
    documentation.
  id: totrans-346
  prefs: []
  type: TYPE_NORMAL
  zh: DSC是一个很大的话题，因此我无法详细描述整个技术，但如果你想了解更多，查看[*第13章*](B16679_13_Final_PD.xhtml#_idTextAnchor341)*，其他内容？–
    进一步的缓解措施和资源*，并查看官方文档。
- en: 'For a basic JEA DSC configuration, please refer to the *Registering JEA* *Configurations*
    documentation:'
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
  zh: 有关基本JEA DSC配置，请参阅*注册JEA* *配置*文档：
- en: '[https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/register-jea?](https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/register-jea?)#multi-machine-configuration-with-dsc'
  id: totrans-348
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/register-jea?](https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/register-jea?)#multi-machine-configuration-with-dsc'
- en: Connecting to the session
  id: totrans-349
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 连接到会话
- en: Once you have set up your JEA sessions, make sure that users that should connect
    to the JEA sessions have the **Access this computer from the network** user right
    configured.
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你设置好 JEA 会话，请确保应该连接到 JEA 会话的用户已配置 **从网络访问此计算机** 的用户权限。
- en: 'Now is the big moment, and you can connect to the JEA session:'
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
  zh: 现在是关键时刻，你可以连接到 JEA 会话了：
- en: '[PRE36]'
  id: totrans-352
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'By default, it is not possible to use *Tab* to autocomplete commands on the
    command line. If you want to have it accessible, nevertheless, it is recommended
    to use **Import-PSSession**, which allows features such as *Tab* completion to
    work without impacting security:'
  id: totrans-353
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，无法在命令行上使用 *Tab* 键自动完成命令。如果你希望能够使用这一功能，建议使用 **Import-PSSession**，它允许像 *Tab*
    补全这样的功能正常工作，而不影响安全性：
- en: '[PRE37]'
  id: totrans-354
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: It is recommended to *not* configure the **TabExpansion2** function as a visible
    function, as this executes all kinds of code and is dangerous for the security
    of your secure environment.
  id: totrans-355
  prefs: []
  type: TYPE_NORMAL
  zh: 不建议将 **TabExpansion2** 函数配置为可见函数，因为它会执行各种代码，对你的安全环境构成风险。
- en: To display all available session configurations on the local machine, run **Get-PSSessionConfiguration**.
  id: totrans-356
  prefs: []
  type: TYPE_NORMAL
  zh: 要显示本地计算机上所有可用的会话配置，运行 **Get-PSSessionConfiguration**。
- en: Once you have successfully configured, deployed, and tested your JEA sessions,
    make sure to remove all other access possibilities for the connecting user. Even
    if you have the best JEA configuration deployed, it’s worth nothing if your users
    can bypass it by leveraging another connection possibility—for example, by connecting
    over Remote Desktop.
  id: totrans-357
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你成功配置、部署并测试了 JEA 会话，确保删除连接用户的所有其他访问方式。即使你部署了最好的 JEA 配置，如果用户可以通过其他连接方式绕过它，那也是毫无意义的——例如，通过远程桌面连接。
- en: Deploying JEA seems like a bunch of work to get it running at first glance,
    right? But don’t worry—there are actually ways that can simplify your work, such
    as JEAnalyzer.
  id: totrans-358
  prefs: []
  type: TYPE_NORMAL
  zh: 部署 JEA 一开始看起来像是需要大量工作，对吧？但别担心——实际上有一些方法可以简化你的工作，比如 JEAnalyzer。
- en: Simplifying your deployment using JEAnalyzer
  id: totrans-359
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 JEAnalyzer 简化你的部署
- en: When I first learned about JEA, I evangelized it and told everyone how awesome
    this solution was. Isn’t it awesome restricting the commands your users are allowed
    to run to exactly to what is needed? Isn’t it amazing to configure virtual accounts
    and completely avoid passing the hash when using JEA and virtual accounts?
  id: totrans-360
  prefs: []
  type: TYPE_NORMAL
  zh: 当我第一次了解 JEA 时，我曾热衷于推广它，并告诉每个人这个解决方案有多么强大。将用户可以运行的命令严格限制为仅需的命令，难道不是很棒吗？通过 JEA
    和虚拟账户完全避免传递哈希值，配置虚拟账户难道不令人惊叹吗？
- en: 'Yes, it is! But when I talked to customers about JEA and how awesome it was,
    I quickly received the same questions over and over again: *How can we find out
    which commands our users and administrators are using? How can we create those
    role capability files in the* *easiest way?*'
  id: totrans-361
  prefs: []
  type: TYPE_NORMAL
  zh: 是的，确实如此！但当我向客户介绍 JEA 和它的强大功能时，我很快就收到了重复的问题：*我们如何找出用户和管理员正在使用哪些命令？我们如何以* *最简单的方式创建这些角色能力文件？*
- en: And this was the time when I had the idea for the JEAnalyzer module. After I
    started the project, my friend Friedrich Weinmann was also very interested in
    this project, and when I switched jobs and barely worked with customers on other
    topics than Microsoft Defender for Endpoint, I was glad that he took over what
    I started and maintained the repository and included our remaining common visions
    for the project.
  id: totrans-362
  prefs: []
  type: TYPE_NORMAL
  zh: 这也是我想到 JEAnalyzer 模块的时刻。在我启动这个项目后，我的朋友 Friedrich Weinmann 也对这个项目产生了浓厚的兴趣。当我换了工作，几乎不再和客户讨论除
    Microsoft Defender for Endpoint 以外的其他话题时，我很高兴他接管了我开始的项目，维护了该仓库，并将我们剩余的共同愿景融入其中。
- en: 'You can find the JEAnalyzer repository on GitHub:'
  id: totrans-363
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在 GitHub 上找到 JEAnalyzer 仓库：
- en: '[https://github.com/PSSecTools/JEAnalyzer](https://github.com/PSSecTools/JEAnalyzer)'
  id: totrans-364
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://github.com/PSSecTools/JEAnalyzer](https://github.com/PSSecTools/JEAnalyzer)'
- en: JEAnalyzer is a PowerShell module that can be easily installed over the PowerShell
    Gallery, using the **Install-Module JEAnalyzer -Force** command. After agreeing
    to all popups, provided by NuGet and others, the module will be installed and
    can be imported using **Import-Module JEAnalyzer**.
  id: totrans-365
  prefs: []
  type: TYPE_NORMAL
  zh: JEAnalyzer 是一个 PowerShell 模块，可以通过 PowerShell Gallery 轻松安装，使用**Install-Module
    JEAnalyzer -Force**命令。安装过程中同意所有弹出窗口，由 NuGet 等提供的弹窗后，模块将被安装并可以使用**Import-Module
    JEAnalyzer**导入。
- en: 'At the time this book was written, the latest version of JEAnalyzer was **1.2.10**
    and consists of 13 functions, as illustrated here:'
  id: totrans-366
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书写作时，JEAnalyzer 的最新版本是 **1.2.10**，包含 13 个功能，如下所示：
- en: '![Figure 10.15 – Available functions of JEAnalyzer](image/B16679_10_015.jpg)'
  id: totrans-367
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.15 – JEAnalyzer 的可用功能](image/B16679_10_015.jpg)'
- en: Figure 10.15 – Available functions of JEAnalyzer
  id: totrans-368
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.15 – JEAnalyzer 的可用功能
- en: Every function is very well documented so I will not describe all functions,
    just the most important ones to find out which commands your users are using and
    how to simply create your first role capability and session configuration files
    with the help of JEAnalyzer.
  id: totrans-369
  prefs: []
  type: TYPE_NORMAL
  zh: 每个功能都有很好的文档说明，因此我不会描述所有功能，只会介绍一些最重要的功能，帮助你找出用户使用的命令，以及如何通过 JEAnalyzer 简单创建你的第一个角色能力和会话配置文件。
- en: Converting script files to a JEA configuration
  id: totrans-370
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 将脚本文件转换为 JEA 配置
- en: If you have a certain script logic that needs to be run within a JEA session
    and simply want to convert the script into an endpoint configuration, JEAnalyzer
    has you covered.
  id: totrans-371
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你有某些脚本逻辑需要在 JEA 会话中运行，并且只想将脚本转换为端点配置，JEAnalyzer 可以帮你实现。
- en: 'As a demo script file, I used the **Export AD Users to CSV** script that was
    originally written by Victor Ashiedu in 2014\. You can find a version of this
    script here:'
  id: totrans-372
  prefs: []
  type: TYPE_NORMAL
  zh: 作为一个示例脚本文件，我使用了**导出 AD 用户到 CSV**脚本，该脚本最初由 Victor Ashiedu 于 2014 年编写。你可以在这里找到该脚本的版本：
- en: '[https://github.com/sacroucher/ADScripts/blob/master/Export_AD_Users_to_CSV.v1.0.ps1](https://github.com/sacroucher/ADScripts/blob/master/Export_AD_Users_to_CSV.v1.0.ps1)'
  id: totrans-373
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://github.com/sacroucher/ADScripts/blob/master/Export_AD_Users_to_CSV.v1.0.ps1](https://github.com/sacroucher/ADScripts/blob/master/Export_AD_Users_to_CSV.v1.0.ps1)'
- en: Download the script and save it under **C:\DEMO\ext\Export_AD_Users_to_CSV.v1.0\Export_AD_Users_to_CSV.v1.0.ps1**.
    Also, create a folder under **C:\JEA\** to store the output files.
  id: totrans-374
  prefs: []
  type: TYPE_NORMAL
  zh: 下载脚本并将其保存在 **C:\DEMO\ext\Export_AD_Users_to_CSV.v1.0\Export_AD_Users_to_CSV.v1.0.ps1**
    路径下。同时，在 **C:\JEA\** 目录下创建一个文件夹来存储输出文件。
- en: After you are well prepared, download the script from this book’s GitHub repository
    and make sure to follow it command after command. Don’t run it as a whole script
    to make sure that you understand every single step—the script is well commented.
  id: totrans-375
  prefs: []
  type: TYPE_NORMAL
  zh: 在做好准备后，从本书的 GitHub 仓库下载脚本，并确保逐条执行命令。不要一次性运行整个脚本，确保你理解每个步骤——脚本有详细的注释。
- en: You can find the script under [https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEAnalyzer-AnalyzeScripts.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEAnalyzer-AnalyzeScripts.ps1).
  id: totrans-376
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在这里找到该脚本：[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEAnalyzer-AnalyzeScripts.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEAnalyzer-AnalyzeScripts.ps1)。
- en: 'The most important commands used from JEAnalyzer for this example are outlined
    here:'
  id: totrans-377
  prefs: []
  type: TYPE_NORMAL
  zh: 本示例中使用的 JEAnalyzer 最重要的命令列出如下：
- en: '**Read-JeaScriptFile**: Parses and analyzes a script file for qualified commands.
    Make sure to specify the script using the **-****Path** parameter.'
  id: totrans-378
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Read-JeaScriptFile**：解析并分析脚本文件中的合格命令。确保使用 **-Path** 参数指定脚本路径。'
- en: '**Export-JeaRoleCapFile**: Converts a list of commands into a JEA role capability
    file.'
  id: totrans-379
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Export-JeaRoleCapFile**：将命令列表转换为 JEA 角色能力文件。'
- en: 'After entering the newly created session and analyzing the commands configured,
    you can see that all the commands used, as well as the standard session functions,
    are allowed within this session:'
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
  zh: 进入新创建的会话并分析配置的命令后，你可以看到所有使用的命令以及标准会话功能在该会话中都是允许的：
- en: '![Figure 10.16 – Displaying all allowed functions and commands](image/B16679_10_016.jpg)'
  id: totrans-381
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.16 – 显示所有允许的功能和命令](image/B16679_10_016.jpg)'
- en: Figure 10.16 – Displaying all allowed functions and commands
  id: totrans-382
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.16 – 显示所有允许的功能和命令
- en: But sometimes, auditing and configuring only script files is not enough; sometimes
    you also need to configure sessions for your users and administrators, allowing
    commonly used commands and functions.
  id: totrans-383
  prefs: []
  type: TYPE_NORMAL
  zh: 但有时，单纯审计和配置脚本文件是不够的；有时你还需要为用户和管理员配置会话，允许使用常用命令和功能。
- en: Using auditing to create your initial JEA configuration
  id: totrans-384
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用审计来创建你的初始 JEA 配置
- en: 'To follow this example, you will need this section’s script from the GitHub
    repository:'
  id: totrans-385
  prefs: []
  type: TYPE_NORMAL
  zh: 要跟随这个示例，你需要从 GitHub 仓库中获取本节的脚本：
- en: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEAnalyzer-AnalyzeLogs.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEAnalyzer-AnalyzeLogs.ps1)'
  id: totrans-386
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEAnalyzer-AnalyzeLogs.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/JEAnalyzer-AnalyzeLogs.ps1)'
- en: Similar to the demo script from the converting script files, don’t run this
    script in its entirety, but make sure to follow it command by command to understand
    the examples.
  id: totrans-387
  prefs: []
  type: TYPE_NORMAL
  zh: 类似于转换脚本文件的演示脚本，不要一次性运行整个脚本，而是逐条命令运行，以便理解示例。
- en: 'As a prerequisite, make sure to install the **ScriptBlockLoggingAnalyzer**
    module, which was created by Dr. Tobias Weltner:'
  id: totrans-388
  prefs: []
  type: TYPE_NORMAL
  zh: 作为先决条件，请确保安装 **ScriptBlockLoggingAnalyzer** 模块，该模块由 Dr. Tobias Weltner 创建：
- en: '[PRE38]'
  id: totrans-389
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: Also, before we can leverage auditing, we need to enable **ScriptBlockLogging**.
    Therefore either enable **ScriptBlockLogging** manually on your local machine
    or make sure to enable it for multiple machines. Refer to [*Chapter 4*](B16679_04_Final_PD.xhtml#_idTextAnchor090),
    *Detection – Auditing and Monitoring*, to learn more about **ScriptBlockLogging**.
  id: totrans-390
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，在我们能够利用审计之前，我们需要启用 **ScriptBlockLogging**。因此，您可以手动在本地计算机上启用 **ScriptBlockLogging**，或者确保在多台计算机上启用它。更多关于
    **ScriptBlockLogging** 的内容，请参见[*第 4 章*](B16679_04_Final_PD.xhtml#_idTextAnchor090)，*检测
    - 审计与监控*。
- en: 'Using these commands, you can enable **ScriptBlockLogging** manually on your
    local machine, like so:'
  id: totrans-391
  prefs: []
  type: TYPE_NORMAL
  zh: 使用这些命令，你可以在本地计算机上手动启用 **ScriptBlockLogging**，如下所示：
- en: '[PRE39]'
  id: totrans-392
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: At some point in the script, you will be asked to run some commands as another
    user. In my demo environment, I run the commands as the **mwiesner** user. If
    you configured another user for your demo purposes, make sure to run this session
    under your customized user account and adjust the script accordingly.
  id: totrans-393
  prefs: []
  type: TYPE_NORMAL
  zh: 在脚本的某些部分，你将被要求以另一个用户身份运行一些命令。在我的演示环境中，我以 **mwiesner** 用户身份运行命令。如果你为演示目的配置了其他用户，请确保在自定义用户账户下运行此会话，并根据需要调整脚本。
- en: To run commands as **mwiesner** or another user, right-click on the PowerShell
    console and select **Run as different user**. Depending on the configuration of
    your system, it might be necessary to press *Shift* and then right-click on the
    PowerShell console to make this option appear.
  id: totrans-394
  prefs: []
  type: TYPE_NORMAL
  zh: 要以 **mwiesner** 或其他用户身份运行命令，请右键单击 PowerShell 控制台并选择 **以不同用户身份运行**。根据系统的配置，可能需要按住
    *Shift* 键并右键单击 PowerShell 控制台，以使此选项显示出来。
- en: Run some demo commands in this session. You can find some examples in the script.
    Just make sure to run one command after the other, and don’t run it as one big
    script block.
  id: totrans-395
  prefs: []
  type: TYPE_NORMAL
  zh: 在此会话中运行一些演示命令。你可以在脚本中找到一些示例。只需确保按顺序运行每个命令，不要将其作为一个大的脚本块运行。
- en: 'Then, follow the script’s examples, analyze the commands, and create an initial
    JEA configuration out of the audited commands. The most important commands used
    in this script are set out here:'
  id: totrans-396
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，按照脚本的示例，分析命令，并从已审计的命令中创建初始的 JEA 配置。此脚本中使用的最重要的命令如下所示：
- en: '**Get-SBLEvent** (**ScriptBlockLoggingAnalyzer** module): Reads **ScriptBlockLogging**
    events from the PowerShell audit log'
  id: totrans-397
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Get-SBLEvent**（**ScriptBlockLoggingAnalyzer** 模块）：从 PowerShell 审计日志中读取 **ScriptBlockLogging**
    事件'
- en: '**Read-JeaScriptblock**: Parses and analyzes passed code for qualified commands,
    when specified using the **-****ScriptCode** parameter'
  id: totrans-398
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Read-JeaScriptblock**：解析并分析传入的代码以获取合格的命令，当使用 **-****ScriptCode** 参数时指定。'
- en: '**Export-JeaRoleCapFile**: Converts a list of commands into a JEA role capability
    file'
  id: totrans-399
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Export-JeaRoleCapFile**：将命令列表转换为 JEA 角色能力文件'
- en: Use the script to explore how to create an initial JEA session out of audited
    commands and adjust the commands used to your needs. In this way, it will be easy
    to create an initial JEA role capability file to adjust and fine-grain later.
  id: totrans-400
  prefs: []
  type: TYPE_NORMAL
  zh: 使用该脚本探索如何从已审计的命令创建初始的 JEA 会话，并根据需要调整使用的命令。这样，你就可以轻松地创建一个初始的 JEA 角色能力文件，并在之后进行调整和精细化。
- en: But also once you have started using JEA, auditing is quite important within
    your JEA sessions. Let’s look in the next section at how you can leverage it and
    link important events related to your users’ JEA sessions.
  id: totrans-401
  prefs: []
  type: TYPE_NORMAL
  zh: 但是，一旦开始使用 JEA，审计在你的 JEA 会话中非常重要。接下来的章节将介绍如何利用审计并链接与你的用户的 JEA 会话相关的重要事件。
- en: Logging within JEA sessions
  id: totrans-402
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在 JEA 会话中的日志记录
- en: When using JEA, logging is of course possible, and you also should implement
    it and regularly review audit logs to make sure your JEA configuration is not
    abused in an unforeseen way.
  id: totrans-403
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 JEA 时，当然可以进行日志记录，且你应该实现它并定期审查审计日志，以确保你的 JEA 配置不会以意外的方式被滥用。
- en: We already covered logging extensively in [*Chapter 4*](B16679_04_Final_PD.xhtml#_idTextAnchor090),
    *Detection – Auditing and Monitoring*, therefore here’s only a little summary
    of what’s important for logging when it comes to JEA.
  id: totrans-404
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经在 [*第 4 章*](B16679_04_Final_PD.xhtml#_idTextAnchor090) 中详细介绍了日志记录，*检测 –
    审计和监控*，因此这里只做一个关于 JEA 日志记录的重要性的小结。
- en: Over-the-shoulder transcription
  id: totrans-405
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 监视记录
- en: Always configure over-the-shoulder transcription for users running commands
    via a JEA session. Over-the-shoulder transcription can be configured within the
    *session configuration file* using the **TranscriptDirectory** parameter, as we
    discussed earlier in the *TranscriptDirectory* section.
  id: totrans-406
  prefs: []
  type: TYPE_NORMAL
  zh: 始终为通过 JEA 会话运行命令的用户配置监视记录。监视记录可以通过 *会话配置文件* 中的 **TranscriptDirectory** 参数进行配置，正如我们在
    *TranscriptDirectory* 部分所讨论的那样。
- en: Make sure to protect the configured folder so that its contents cannot be manipulated
    by an adversary. Also forward, parse, and review the transcripts regularly.
  id: totrans-407
  prefs: []
  type: TYPE_NORMAL
  zh: 确保保护配置的文件夹，以防其内容被对手篡改。同时定期转发、解析并审查转录记录。
- en: Over-the-shoulder transcription records contain information about the user,
    the virtual user, the commands that were run in the session, and more.
  id: totrans-408
  prefs: []
  type: TYPE_NORMAL
  zh: 监视记录包含有关用户、虚拟用户、会话中执行的命令等信息。
- en: PowerShell event logs
  id: totrans-409
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: PowerShell 事件日志
- en: Not only for finding out who runs which commands, PowerShell event logs are
    quite useful; when Script Block Logging is turned on, all PowerShell actions are
    also recorded in regular Windows event logs.
  id: totrans-410
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 事件日志不仅仅用于找出谁运行了哪些命令，当启用脚本块日志记录时，所有 PowerShell 操作也会记录在常规 Windows 事件日志中。
- en: 'Enable Script Block Logging as well as Module Logging and look for event ID
    **4104** in the *PowerShell operational log*. On the remote machine, the user
    you will need to look for is the WinRM virtual user if a virtual account is used.
    If a *gMSA* account was used, make sure to also watch out for this account. The
    following screenshot shows a Script Block Logging event for a virtual account:'
  id: totrans-411
  prefs: []
  type: TYPE_NORMAL
  zh: 启用脚本块日志记录以及模块日志记录，并在 *PowerShell 操作日志* 中查找事件 ID **4104**。在远程机器上，如果使用的是虚拟账户，你需要查找的用户是
    WinRM 虚拟用户。如果使用的是 *gMSA* 账户，则需要注意这个账户。以下截图显示了一个虚拟账户的脚本块日志记录事件：
- en: '![Figure 10.17 – Virtual account is shown as username](image/B16679_10_017.jpg)'
  id: totrans-412
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.17 – 虚拟账户显示为用户名](image/B16679_10_017.jpg)'
- en: Figure 10.17 – Virtual account is shown as username
  id: totrans-413
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.17 – 虚拟账户显示为用户名
- en: Monitor especially for event IDs 4100, 4103, and 4104 in the PowerShell operational
    log. On some occasions, you will see that the connecting user is the actual user,
    while the user specified is the WinRM virtual account.
  id: totrans-414
  prefs: []
  type: TYPE_NORMAL
  zh: 特别关注 PowerShell 操作日志中的事件 ID 4100、4103 和 4104。在某些情况下，你会看到连接的用户是实际用户，而指定的用户是 WinRM
    虚拟账户。
- en: Other event logs
  id: totrans-415
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 其他事件日志
- en: Unlike PowerShell operational logs and transcripts, other logging mechanisms
    will not capture the connected user. To find out which users connected at which
    time, you need to correlate event logs.
  id: totrans-416
  prefs: []
  type: TYPE_NORMAL
  zh: 与 PowerShell 操作日志和转录记录不同，其他日志机制无法捕获连接的用户。要找出哪些用户在何时连接，你需要进行事件日志关联。
- en: 'To do so, look for event ID **193** in the *WinRM operational log* to find
    out which virtual account or gMSA was requested by which user:'
  id: totrans-417
  prefs: []
  type: TYPE_NORMAL
  zh: 要做到这一点，请在 *WinRM 操作日志* 中查找事件 ID **193**，以找出哪个用户请求了哪个虚拟账户或 gMSA：
- en: '![Figure 10.18 – Using the WinRM operational log for correlation](image/B16679_10_018.jpg)'
  id: totrans-418
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.18 – 使用 WinRM 操作日志进行关联](image/B16679_10_018.jpg)'
- en: Figure 10.18 – Using the WinRM operational log for correlation
  id: totrans-419
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.18 – 使用 WinRM 操作日志进行关联
- en: 'You can also get more details out of the security log by looking for event
    IDs **4624** and **4625**. In the following example screenshot, we are looking
    at two events with the ID **4624** (**An account was successfully logged on**.)
    that were generated at the same time—one shows a regular account logon while the
    other shows the logon of the virtual account:'
  id: totrans-420
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以通过查找事件 ID **4624** 和 **4625** 从安全日志中获取更多详细信息。在以下示例截图中，我们看到两个事件 ID 为 **4624**（**账户已成功登录**）的事件，它们是在同一时间生成的——一个显示的是常规账户登录，另一个显示的是虚拟账户登录：
- en: '![Figure 10.19 – Comparing the regular account and the virtual account logon](image/B16679_10_019.jpg)'
  id: totrans-421
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.19 – 比较常规账户与虚拟账户登录](image/B16679_10_019.jpg)'
- en: Figure 10.19 – Comparing the regular account and the virtual account logon
  id: totrans-422
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.19 – 比较常规账户和虚拟账户登录
- en: If you are looking for more activities in other event logs, use the **Logon
    ID** value to correlate activities to identified logon sessions.
  id: totrans-423
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想查找更多其他事件日志中的活动，使用 **Logon ID** 值来关联活动与已识别的登录会话。
- en: An account logoff can be identified by event **4634**. Refer to [*Chapter 4*](B16679_04_Final_PD.xhtml#_idTextAnchor090),
    *Detection – Auditing and Monitoring*, for more information about the Windows
    event log.
  id: totrans-424
  prefs: []
  type: TYPE_NORMAL
  zh: 账户注销可以通过事件**4634**识别。有关更多关于 Windows 事件日志的信息，请参考 [*第4章*](B16679_04_Final_PD.xhtml#_idTextAnchor090)，*检测
    – 审计与监控*。
- en: Best practices – avoiding risks and possible bypasses
  id: totrans-425
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 最佳实践 – 避免风险和可能的绕过方法
- en: JEA is a great option to harden your environment and allow administrators and
    users to only execute the commands that they need for their daily work. But as
    with every other technology, JEA can also be misconfigured, and there are risks
    that you need to watch out for.
  id: totrans-426
  prefs: []
  type: TYPE_NORMAL
  zh: JEA 是加固你的环境的一个好选择，它允许管理员和用户只执行他们日常工作所需的命令。但像其他技术一样，JEA 也可能配置错误，存在一些你需要注意的风险。
- en: Do not grant the connecting user admin privileges to bypass JEA—for example,
    allowing commands to edit admin groups such as **Add-ADGroupMember**, **Add-LocalGroupMember**,
    **net.exe**, and **dsadd.exe**. Rogue administrators or accounts that were compromised
    could easily escalate their privileges.
  id: totrans-427
  prefs: []
  type: TYPE_NORMAL
  zh: 不要授予连接用户管理员权限以绕过JEA——例如，允许命令编辑管理员组，如**Add-ADGroupMember**、**Add-LocalGroupMember**、**net.exe**
    和 **dsadd.exe**。恶意管理员或被攻击的账户可能会轻易提升权限。
- en: Also, don’t allow users to run arbitrary code, such as malware, exploits, or
    custom scripts to bypass protections. Commands that you should especially watch
    out for are (not exclusively) **Start-Process**, **New-Service**, **Invoke-Item**,
    **Invoke-WmiMethod**, **Invoke-CimMethod**, **Invoke-Expression**, **Invoke-Command**,
    **New-ScheduledTask**, **Register-ScheduledJob**, and many more.
  id: totrans-428
  prefs: []
  type: TYPE_NORMAL
  zh: 另外，不要允许用户运行任意代码，如恶意软件、漏洞利用或自定义脚本来绕过保护。你需要特别注意的命令有（但不限于）**Start-Process**、**New-Service**、**Invoke-Item**、**Invoke-WmiMethod**、**Invoke-CimMethod**、**Invoke-Expression**、**Invoke-Command**、**New-ScheduledTask**、**Register-ScheduledJob**等。
- en: If your admins really need one of those risky commands, you can try to fine-grain
    the configuration by also configuring dedicated parameters or by creating and
    allowing a custom function.
  id: totrans-429
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的管理员确实需要其中一些高风险命令，你可以尝试通过配置专用参数或创建并允许自定义函数来细化配置。
- en: Try to avoid wildcard configurations as they could be tampered with, and be
    careful when using tools that help you to create a configuration; always review
    and test the configuration carefully before using it in production.
  id: totrans-430
  prefs: []
  type: TYPE_NORMAL
  zh: 尽量避免使用通配符配置，因为它们可能被篡改，并且在使用帮助你创建配置的工具时要小心；在生产环境中使用之前，务必仔细审查和测试配置。
- en: To protect your role capability and session configuration files from being tampered
    with, use signing. Make sure to implement a proper logging mechanism and secure
    transcript files as well as event logs. Also, review them on a regular basis.
  id: totrans-431
  prefs: []
  type: TYPE_NORMAL
  zh: 为了保护你的角色能力和会话配置文件免受篡改，请使用签名。确保实施适当的日志记录机制，并确保转录文件和事件日志的安全。还要定期审查它们。
- en: And last but not least, when going live, be aware that none of this matters
    if you do not take away admin rights and remote desktop access to the servers!
  id: totrans-432
  prefs: []
  type: TYPE_NORMAL
  zh: 最后但同样重要的是，当系统上线时，要意识到，如果你不撤销管理员权限和远程桌面访问权限，以上所说的任何措施都没有意义！
- en: Summary
  id: totrans-433
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 概述
- en: In this chapter, you have learned what language modes are and how they differ
    from JEA. You have also learned what JEA is and how to set it up.
  id: totrans-434
  prefs: []
  type: TYPE_NORMAL
  zh: 本章中，你了解了语言模式是什么以及它们与 JEA 的区别。你还学习了什么是 JEA 以及如何设置它。
- en: You now know which parameters you can use to create your own customized JEA
    role capability and session configuration files (or at least where to go in the
    book to look for them) and how to register and deploy your JEA endpoints.
  id: totrans-435
  prefs: []
  type: TYPE_NORMAL
  zh: 你现在知道了可以使用哪些参数来创建你自己的定制 JEA 角色能力和会话配置文件（或者至少知道在哪里查找它们），以及如何注册和部署你的 JEA 端点。
- en: Following the examples from this book’s GitHub repository, you have managed
    to create and explore your own JEA sessions, and you have been provided with an
    option on how to create a simple first configuration out of your own environment,
    using JEAnalyzer. Of course, you will still need to fine-tune your configuration,
    but the first step is done easily.
  id: totrans-436
  prefs: []
  type: TYPE_NORMAL
  zh: 按照本书 GitHub 仓库中的示例，你已经成功创建并探索了自己的 JEA 会话，并且你已经获得了如何在自己的环境中使用 JEAnalyzer 创建简单配置的选项。当然，你仍然需要对配置进行微调，但第一步已经轻松完成。
- en: You have explored how to interpret logging files to correlate JEA sessions over
    different event logs and what kinds of risks to look out for when creating your
    JEA configurations.
  id: totrans-437
  prefs: []
  type: TYPE_NORMAL
  zh: 你已经了解了如何解读日志文件，以便在不同的事件日志中关联 JEA 会话，以及在创建 JEA 配置时需要注意的风险。
- en: JEA is a great step to define which commands can be executed by which role,
    but sometimes you might want to completely prohibit a certain application or just
    whitelist allowed applications and scripts in your environment. In our next chapter,
    we will discover how this goal can be achieved using AppLocker, Application Control,
    and script signing.
  id: totrans-438
  prefs: []
  type: TYPE_NORMAL
  zh: JEA 是定义哪些命令可以由哪些角色执行的一个重要步骤，但有时你可能希望完全禁止某个特定应用程序，或者仅允许某些应用程序和脚本在你的环境中运行。在下一章中，我们将探索如何通过
    AppLocker、应用程序控制和脚本签名来实现这一目标。
- en: Further reading
  id: totrans-439
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 进一步阅读
- en: 'If you want to explore some of the topics that were mentioned in this chapter,
    follow these resources:'
  id: totrans-440
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想深入探索本章中提到的一些话题，可以参考以下资源：
- en: 'PowerShell Constrained Language Mode: [https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/)'
  id: totrans-441
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'PowerShell 受限语言模式: [https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/)'
- en: 'about_Language_Modes: [https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes)'
  id: totrans-442
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'about_Language_Modes: [https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes)'
- en: 'Just Enough Administration (official Microsoft documentation): [https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/overview](https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/overview)'
  id: totrans-443
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'Just Enough Administration（官方 Microsoft 文档）: [https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/overview](https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/overview)'
- en: 'JEAnalyzer on GitHub: [https://github.com/PSSecTools/JEAnalyzer](https://github.com/PSSecTools/JEAnalyzer)'
  id: totrans-444
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'GitHub 上的 JEAnalyzer: [https://github.com/PSSecTools/JEAnalyzer](https://github.com/PSSecTools/JEAnalyzer)'
- en: 'PowerShell ♥ the Blue Team: [https://devblogs.microsoft.com/powershell/powershell-the-blue-team/](https://devblogs.microsoft.com/powershell/powershell-the-blue-team/)'
  id: totrans-445
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'PowerShell ♥ 蓝队: [https://devblogs.microsoft.com/powershell/powershell-the-blue-team/](https://devblogs.microsoft.com/powershell/powershell-the-blue-team/)'
- en: 'You can also find all links mentioned in this chapter in the GitHub repository
    for [*Chapter 10*](B16679_10_Final_PD.xhtml#_idTextAnchor278)—there’s no need
    to manually type in every link:'
  id: totrans-446
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以在 GitHub 仓库中找到本章提到的所有链接：[*第 10 章*](B16679_10_Final_PD.xhtml#_idTextAnchor278)——无需手动输入每个链接：
- en: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/Links.md](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/Links.md)'
  id: totrans-447
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/Links.md](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter10/Links.md)'
