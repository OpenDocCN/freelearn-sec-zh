- en: Chapter 9. OS Integration
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第9章 操作系统集成
- en: 'In this chapter, we will cover the following recipes:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将介绍以下教程：
- en: Linux - using `NetworkManager`
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Linux — 使用`NetworkManager`
- en: Linux - using `pull-resolv-conf`
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Linux — 使用`pull-resolv-conf`
- en: Windows - elevated privileges
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows — 提升权限
- en: Windows - using the CryptoAPI store
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows — 使用CryptoAPI存储
- en: Windows - updating the DNS cache
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows — 更新DNS缓存
- en: Windows - running OpenVPN as a service
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows — 将OpenVPN作为服务运行
- en: Windows - public versus private network adapters
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows — 公共与私有网络适配器
- en: Windows - routing methods
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows — 路由方法
- en: Windows 8+- ensuring DNS lookups are secure
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows 8+ — 确保DNS查询是安全的
- en: Android- using the OpenVPN for Android clients
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Android — 使用OpenVPN for Android客户端
- en: Push-peer-info - pushing options to Android clients
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Push-peer-info — 向Android客户端推送选项
- en: Introduction
  id: totrans-13
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 介绍
- en: In this chapter, we will focus on how to use OpenVPN on Linux, Windows, and
    Android. For each operating system, an entire chapter could be written to describe
    the intricacies of running OpenVPN in both the client and server mode, but as
    space is limited, we will focus only on the interaction of the OpenVPN client
    with the OS. The purpose of the recipes in this chapter is to outline some of
    the common pitfalls when running OpenVPN on a particular platform. The recipes
    focus mainly on the configuration of OpenVPN itself, not on how to integrate a
    working VPN setup into the rest of the network infrastructure.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将重点介绍如何在Linux、Windows和Android上使用OpenVPN。对于每个操作系统，都可以单独写一章，详细描述在客户端和服务器模式下运行OpenVPN的细节，但由于篇幅有限，我们将只关注OpenVPN客户端与操作系统的交互。本章中的教程旨在概述在特定平台上运行OpenVPN时常见的陷阱。教程主要集中在OpenVPN本身的配置，而非如何将一个工作中的VPN设置集成到其余的网络基础设施中。
- en: Linux - using NetworkManager
  id: totrans-15
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Linux — 使用NetworkManager
- en: When Linux is used as a desktop operating system, the network configuration
    is configured using the Linux NetworkManager in most of the cases. This package
    allows a non-root user to start and stop the network connections, connect and
    disconnect from wireless networks, and also to set up several types of VPN connections,
    including OpenVPN. In this recipe, we will show how to configure an OpenVPN connection
    using the GNOME variant of the NetworkManager.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 当Linux作为桌面操作系统使用时，网络配置大多数情况下是通过Linux的NetworkManager进行配置的。这个软件包允许非管理员用户启动和停止网络连接，连接和断开无线网络，并且设置多种类型的VPN连接，包括OpenVPN。在这个教程中，我们将展示如何使用GNOME版本的NetworkManager配置OpenVPN连接。
- en: Getting ready
  id: totrans-17
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client was running Fedora 22 Linux and OpenVPN 2.3.11\.
    This version of Linux comes with NetworkManager 1.0.8, including the `NetworkManager-openvpn`
    plugin. The `NetworkManager-openvpn` plugin is not installed by default and needs
    to be explicitly added to the system. Keep the configuration file, `basic-udp-server.conf`,
    in the *Server-side routing* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*,
    at hand.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 使用[第2章](part0025.xhtml#aid-NQU21 "第2章 客户端-服务器IP-only网络")中的第一个教程设置客户端和服务器证书，*客户端-服务器IP-only网络*。在这个教程中，服务器计算机运行的是CentOS
    6 Linux和OpenVPN 2.3.11，客户端计算机运行的是Fedora 22 Linux和OpenVPN 2.3.11。此版本的Linux自带NetworkManager
    1.0.8，并包括`NetworkManager-openvpn`插件。`NetworkManager-openvpn`插件默认没有安装，需要手动添加到系统中。保持[第2章](part0025.xhtml#aid-NQU21
    "第2章 客户端-服务器IP-only网络")中的*服务器端路由*教程中的配置文件`basic-udp-server.conf`，以便随时使用。
- en: How to do it...
  id: totrans-19
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 操作方法...
- en: Start the NetworkManager configuration screen by right-clicking on the NetworkManager
    icon in the taskbar and selecting **Edit Connections**. A window will pop up.
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过右键点击任务栏中的NetworkManager图标并选择**编辑连接**，启动NetworkManager配置界面。会弹出一个窗口。
- en: Choose the **VPN** tab to set up a new VPN connection:![How to do it...](img/image00406.jpeg)
  id: totrans-21
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择**VPN**选项卡来设置一个新的VPN连接：![操作方法...](img/image00406.jpeg)
- en: Click on the **Add** button to bring up the next screen:![How to do it...](img/image00407.jpeg)
  id: totrans-22
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**添加**按钮以进入下一个界面：![操作方法...](img/image00407.jpeg)
- en: Select the **OpenVPN** as the VPN type and click on the **Create...** button.
    If the VPN connection type **OpenVPN** is not available, then the `NetworkManager-openvpn`
    plugin is not installed.
  id: totrans-23
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择**OpenVPN**作为VPN类型，然后点击**创建...**按钮。如果**OpenVPN**连接类型不可用，说明`NetworkManager-openvpn`插件没有安装。
- en: Fill in the details of the **VPN** tab of the next window:![How to do it...](img/image00408.jpeg)
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 填写下一个窗口的**VPN**选项卡中的详细信息：![如何操作...](img/image00408.jpeg)
- en: The **Gateway** is the hostname or IP address of the OpenVPN server. The **Type**
    of authentication is **Certificates** **(TLS****)**. Then, for the **User Certificate**, **CA
    Certificate**, and **Private Key** fields, browse to the directory where the client
    files `client1.crt`, `ca.crt`, and `client1.key` are located, respectively. Fill
    in the **Private Key Password** fields, if required. Do not click on the **Save** button
    just yet, click on **Advanced****...** instead.
  id: totrans-25
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '**网关**是 OpenVPN 服务器的主机名或 IP 地址。身份验证的**类型**是**证书（TLS）**。然后，对于**用户证书**、**CA 证书**和**私钥**字段，分别浏览到包含
    `client1.crt`、`ca.crt` 和 `client1.key` 文件的目录。如果需要，填写**私钥密码**字段。此时不要点击**保存**按钮，而是点击**高级...**。'
- en: In the next window, go to the **Security** tab:![How to do it...](img/image00409.jpeg)
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在下一个窗口中，转到**安全**选项卡：![如何操作...](img/image00409.jpeg)
- en: Select the encryption cipher and HMAC authentication protocol to use for the
    connection and then click on **OK**.
  id: totrans-27
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择要用于连接的加密密码和 HMAC 身份验证协议，然后点击**确定**。
- en: Then, go to the **TLS Authentication** tab.![How to do it...](img/image00410.jpeg)
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后，转到**TLS 身份验证**选项卡。![如何操作...](img/image00410.jpeg)
- en: Enable **Verify peer (server) certificate usage signature**, then select **Use
    additional TLS authentication**, and browse to the location of the `ta.key` file.
    Choose **1** for the key direction.
  id: totrans-29
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启用**验证对等方（服务器）证书使用签名**，然后选择**使用额外的 TLS 身份验证**，并浏览到 `ta.key` 文件的位置。选择**1**作为密钥方向。
- en: Click on **OK** when done and then click on **Apply** to save the new VPN connection.
  id: totrans-30
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 完成后，点击**确定**，然后点击**应用**以保存新的 VPN 连接。
- en: 'Next, start the server:'
  id: totrans-31
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，启动服务器：
- en: '[PRE0]'
  id: totrans-32
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: And finally, on the client, start the VPN connection by clicking on the NetworkManager
    icon, choosing**VPN Connections** and selecting **Example 9-1**:![How to do it...](img/image00411.jpeg)
  id: totrans-33
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，在客户端，通过点击 NetworkManager 图标，选择**VPN 连接**并选择**示例 9-1**来启动 VPN 连接：![如何操作...](img/image00411.jpeg)
- en: You can verify whether the VPN connection is established correctly by pinging
    the VPN server IP.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过 ping VPN 服务器 IP 来验证 VPN 连接是否正确建立。
- en: How it works...
  id: totrans-35
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理...
- en: The `NetworkManager-openvpn` plugin is a GUI for setting up an OpenVPN client
    configuration file. All the settings made are the equivalent of setting up the
    client configuration file as done in the *Server-side routing* recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: '`NetworkManager-openvpn` 插件是一个用于设置 OpenVPN 客户端配置文件的图形用户界面。所有设置相当于按照[第 2 章](part0025.xhtml#aid-NQU21
    "第 2 章 客户端-服务器 IP 专用网络")中的*服务器端路由*方法配置客户端配置文件，*客户端-服务器 IP 专用网络*。'
- en: There's more...
  id: totrans-37
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: 'The `NetworkManager-openvpn` plugin supports some advanced configuration settings:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: '`NetworkManager-openvpn` 插件支持一些高级配置设置：'
- en: Setting up routes using NetworkManager
  id: totrans-39
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用 NetworkManager 设置路由
- en: 'The `NetworkManager-openvpn` plugin can also be used to set up VPN-specific
    routes. Open the main VPN configuration screen again and go to the **IPv4 Settings**
    tab. Click on the **Routes...** button on this screen:'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: '`NetworkManager-openvpn` 插件也可以用来设置特定于 VPN 的路由。再次打开主 VPN 配置屏幕，进入**IPv4 设置**选项卡。点击此屏幕上的**路由...**按钮：'
- en: '![Setting up routes using NetworkManager](img/image00412.jpeg)'
  id: totrans-41
  prefs: []
  type: TYPE_IMG
  zh: '![使用 NetworkManager 设置路由](img/image00412.jpeg)'
- en: 'A new window will appear:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 将会弹出一个新窗口：
- en: '![Setting up routes using NetworkManager](img/image00413.jpeg)'
  id: totrans-43
  prefs: []
  type: TYPE_IMG
  zh: '![使用 NetworkManager 设置路由](img/image00413.jpeg)'
- en: Routes pushed by the server can be overruled using the **Ignore automatically
    obtained routes** option. By default, the `NetworkManager-openvpn` plugin will
    enable `redirect-gateway`, even if it is not pushed by the server. This behavior
    can be overruled by checking the **Use this connection only for resources on its
    network** checkbox.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 通过**忽略自动获取的路由**选项，可以覆盖服务器推送的路由。默认情况下，`NetworkManager-openvpn` 插件会启用 `redirect-gateway`，即使服务器未推送该设置。通过勾选**仅将此连接用于其网络上的资源**复选框，可以覆盖这一行为。
- en: DNS settings
  id: totrans-45
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: DNS 设置
- en: 'The `NetworkManager-openvpn` plugin also updates the `/etc/resolv.conf` file
    if the OpenVPN server pushes out DNS servers using the following directive:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 如果 OpenVPN 服务器通过以下指令推送 DNS 服务器，`NetworkManager-openvpn` 插件还会更新`/etc/resolv.conf`
    文件：
- en: '[PRE1]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Scripting
  id: totrans-48
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 脚本
- en: Note that NetworkManager does not allow scripting or plugins on the client side,
    as they are a security risk when configured by a non-root user.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，NetworkManager 不允许在客户端使用脚本或插件，因为由非 root 用户配置时会带来安全风险。
- en: Linux - using pull-resolv-conf
  id: totrans-50
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Linux - 使用 pull-resolv-conf
- en: One of the most common pitfalls when setting up a VPN connection on Linux is
    when the OpenVPN server pushes out new DNS settings. In the previous recipe, we
    saw that the `NetworkManager-openvpn` plugin also updated the system configuration
    file that contained the DNS setting, `/etc/resolv.conf`. If the command line is
    used, this is not done automatically. By default, OpenVPN comes with two scripts
    to add and remove DNS servers from the `/etc/resolv.conf` file. This recipe will
    show how to use these scripts.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Linux 上设置 VPN 连接时，一个常见的陷阱是 OpenVPN 服务器推送新的 DNS 设置。在之前的例子中，我们看到 `NetworkManager-openvpn`
    插件也会更新包含 DNS 设置的系统配置文件`/etc/resolv.conf`。如果使用命令行，这一过程不会自动进行。默认情况下，OpenVPN 配带了两个脚本，用于将
    DNS 服务器添加到或从`/etc/resolv.conf`文件中移除。这个教程将展示如何使用这些脚本。
- en: Getting ready
  id: totrans-52
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备就绪
- en: 'We will use the following network layout:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用以下网络布局：
- en: '![Getting ready](img/image00414.jpeg)'
  id: totrans-54
  prefs: []
  type: TYPE_IMG
  zh: '![准备就绪](img/image00414.jpeg)'
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client was running Fedora 22 Linux and OpenVPN 2.3.11\.
    Keep the `basic-udp-server.conf` configuration file from the *Server-side routing*
    recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only
    Networks"), *Client-server IP-only Networks*, as well as the  `basic-udp-client.conf`
    client configuration file at hand.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 使用[第 2 章](part0025.xhtml#aid-NQU21 "第 2 章 客户端-服务器仅 IP 网络")中的第一个教程设置客户端和服务器证书，*客户端-服务器仅
    IP 网络*。对于这个例子，服务器计算机运行的是 CentOS 6 Linux 和 OpenVPN 2.3.11，客户端运行的是 Fedora 22 Linux
    和 OpenVPN 2.3.11。请保存`basic-udp-server.conf`配置文件，这来自[第 2 章](part0025.xhtml#aid-NQU21
    "第 2 章 客户端-服务器仅 IP 网络")中的*服务器端路由*教程，以及`basic-udp-client.conf`客户端配置文件。
- en: How to do it...
  id: totrans-56
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Append the following line to the `basic-udp-server.conf` file:'
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将以下行附加到`basic-udp-server.conf`文件中：
- en: '[PRE2]'
  id: totrans-58
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Here, `10.198.0.1` is the address of a DNS server on the VPN server LAN. Save
    it as `example9-2-server.conf`.
  id: totrans-59
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这里，`10.198.0.1`是 VPN 服务器局域网中 DNS 服务器的地址。将其保存为`example9-2-server.conf`。
- en: 'Start the server:'
  id: totrans-60
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动服务器：
- en: '[PRE3]'
  id: totrans-61
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Similarly, for the client, add the following lines to the `basic-udp-client.conf`
    file:'
  id: totrans-62
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 同样，对于客户端，向`basic-udp-client.conf`文件中添加以下行：
- en: '[PRE4]'
  id: totrans-63
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Save it as `example9-2-client.conf`. Copy over the `client.up` and `client.down`
    files from the OpenVPN `contrib` directory and make them executable. On CentOS
    6 and Fedora 22, these files are located in the `/usr/share/doc/openvpn-2.3.11/contrib/pull-resolv-conf`
    directory:'
  id: totrans-64
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将其保存为`example9-2-client.conf`。从 OpenVPN `contrib` 目录中复制`client.up`和`client.down`文件，并使其可执行。在
    CentOS 6 和 Fedora 22 中，这些文件位于`/usr/share/doc/openvpn-2.3.11/contrib/pull-resolv-conf`目录：
- en: '[PRE5]'
  id: totrans-65
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'And finally, start the client:'
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，启动客户端：
- en: '[PRE6]'
  id: totrans-67
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'After the VPN connection comes up, check the contents of the `/etc/resolv.conf`
    file. The first line should contain the DNS server as specified by the OpenVPN
    server:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: VPN 连接建立后，检查`/etc/resolv.conf`文件的内容。第一行应包含 OpenVPN 服务器指定的 DNS 服务器：
- en: '[PRE7]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: When the VPN connection is terminated, the entry is removed again.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 当 VPN 连接结束时，该条目会被移除。
- en: How it works...
  id: totrans-71
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: The scripts supplied with OpenVPN parse the environment variable, `foreign_option_*`,
    and look for DOMAIN and DNS settings. These settings are then written out to the
    beginning of the `/etc/resolv.conf` file. This causes the DNS server and the DOMAIN
    pushed by the OpenVPN server to take precedence over the system's DNS and DOMAIN
    settings.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: OpenVPN 提供的脚本解析环境变量`foreign_option_*`，并查找 DOMAIN 和 DNS 设置。这些设置随后会被写入`/etc/resolv.conf`文件的开头。这使得
    OpenVPN 服务器推送的 DNS 服务器和 DOMAIN 设置优先于系统的 DNS 和 DOMAIN 设置。
- en: When the VPN connection is dropped, the same settings are removed from the `/etc/resolv.conf`
    file.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 当 VPN 连接断开时，相同的设置会从`/etc/resolv.conf`文件中删除。
- en: There's more...
  id: totrans-74
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: Note that when the `NetworkManager-openvpn` plugin is used, these scripts are
    not necessary, as the NetworkManager itself updates the `/etc/resolv.conf` file.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，当使用`NetworkManager-openvpn`插件时，这些脚本不是必需的，因为 NetworkManager 会自行更新`/etc/resolv.conf`文件。
- en: Windows - elevated privileges
  id: totrans-76
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Windows - 提升权限
- en: With the introduction of Windows Vista, Microsoft introduced **User Access Control**
    (**UAC**). UAC is meant to safeguard users from running programs that can modify
    the operating system itself. Before such a program is run, a privilege elevation
    is required even if the user has full administrator rights. A dialog box appears
    that the user must click on before the execution begins. In order to run OpenVPN,
    elevated privileges are needed, as OpenVPN wants to open a system device and start
    a VPN connection. Especially if routes need to be added to the system, elevated
    privileges are essential.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 随着Windows Vista的推出，微软引入了**用户帐户控制**（**UAC**）。UAC旨在保护用户免受可能修改操作系统本身的程序的危害。在运行此类程序之前，即使用户具有完全的管理员权限，也需要提升权限。会出现一个对话框，用户必须点击它才能开始执行。为了运行OpenVPN，需要提升的权限，因为OpenVPN需要打开系统设备并启动VPN连接。尤其是在需要向系统中添加路由时，提升的权限至关重要。
- en: With OpenVPN 2.3+, privilege elevation is built into the OpenVPN GUI application.
    That is, even if the **Run as Administrator** flag is turned off, the OpenVPN
    GUI application will still request elevated privileges when it is launched. This
    recipe will demonstrate this behavior, which was not present in older versions
    of OpenVPN.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 在OpenVPN 2.3+版本中，权限提升功能已内置于OpenVPN GUI应用程序中。也就是说，即使**以管理员身份运行**标志被关闭，启动OpenVPN
    GUI时，应用程序仍会请求提升的权限。本教程将演示这一行为，而这种行为在旧版本的OpenVPN中并不存在。
- en: Getting ready
  id: totrans-79
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client computer was running Windows 7 SP1 and OpenVPN
    2.3.11\. Keep the configuration file, `basic-udp-server.conf`, from the *Server-side
    routing* recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks*. For the client, keep the
    configuration file, `basic-udp-client.ovpn`, from the *Using an ifconfig-pool
    block* recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks* at hand.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 使用[第二章](part0025.xhtml#aid-NQU21 "第二章 客户端-服务器IP专用网络")中的第一个教程设置客户端和服务器证书，*客户端-服务器IP专用网络*。在本教程中，服务器计算机运行CentOS
    6 Linux和OpenVPN 2.3.11，客户端计算机运行Windows 7 SP1和OpenVPN 2.3.11。保留来自[第二章](part0025.xhtml#aid-NQU21
    "第二章 客户端-服务器IP专用网络")中*服务器端路由*教程中的配置文件`basic-udp-server.conf`。对于客户端，保留来自[第二章](part0025.xhtml#aid-NQU21
    "第二章 客户端-服务器IP专用网络")中*使用ifconfig-pool块*教程中的配置文件`basic-udp-client.ovpn`。
- en: How to do it...
  id: totrans-81
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'First, start the server:'
  id: totrans-82
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 首先，启动服务器：
- en: '[PRE8]'
  id: totrans-83
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Make sure that the OpenVPN is not running and that the tray icon is not present.
  id: totrans-84
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确保OpenVPN没有运行，并且托盘图标不存在。
- en: Before starting the OpenVPN GUI, right-click on the OpenVPN GUI icon that was
    placed on your desktop after installing the OpenVPN 2.3.11 installer for Windows.
  id: totrans-85
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在启动OpenVPN GUI之前，右键点击安装OpenVPN 2.3.11 Windows版后放置在桌面上的OpenVPN GUI图标。
- en: In the **Properties** screen that comes up, click on the **Compatibility** tab
    and disable **Run this program as an administrator**:![How to do it...](img/image00415.jpeg)
  id: totrans-86
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在弹出的**属性**窗口中，点击**兼容性**选项卡并禁用**以管理员身份运行此程序**：![如何操作…](img/image00415.jpeg)
- en: Click on **OK**.
  id: totrans-87
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**确定**。
- en: Start the OpenVPN GUI. Note that it will still prompt for permissions (the following
    screenshot is for Windows Vista, but a similar window will pop up for Windows
    7+):![How to do it...](img/image00416.jpeg)
  id: totrans-88
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动OpenVPN GUI。请注意，它仍然会提示权限（以下截图是Windows Vista的界面，但Windows 7+会弹出类似的窗口）：![如何操作…](img/image00416.jpeg)
- en: Click on **Continue** to start the OpenVPN GUI as usual.
  id: totrans-89
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**继续**以按常规启动OpenVPN GUI。
- en: Start the OpenVPN client by launching the `example5-1` configuration file:![How
    to do it...](img/image00417.jpeg)
  id: totrans-90
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过启动`example5-1`配置文件启动OpenVPN客户端：![如何操作…](img/image00417.jpeg)
- en: Verify that the VPN connection is established and that the log file, `c:\temp\openvpn.log`,
    has been created.
  id: totrans-91
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证VPN连接是否已建立，并且日志文件`c:\temp\openvpn.log`是否已创建。
- en: How it works...
  id: totrans-92
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的…
- en: 'When the OpenVPN GUI application is launched, the user must always confirm
    that it can run with elevated privileges. This is now built into the OpenVPN GUI
    application itself, and is visible by noticing the shield at the right bottom
    of the application''s icon:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 启动OpenVPN GUI应用程序时，用户必须始终确认它可以以提升的权限运行。这已内置在OpenVPN GUI应用程序中，可以通过注意应用程序图标右下角的盾牌来看到这一点。
- en: '![How it works...](img/image00418.jpeg)'
  id: totrans-94
  prefs: []
  type: TYPE_IMG
  zh: '![工作原理...](img/image00418.jpeg)'
- en: After that, the OpenVPN GUI can launch other executables that will also inherit
    these privileges. When the GUI launches the `openvpn.exe` process, it can open
    the VPN adapter, alter the routing tables, and run the up and down scripts.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 此后，OpenVPN GUI可以启动其他可执行文件，这些文件也会继承这些权限。当GUI启动`openvpn.exe`进程时，它可以打开VPN适配器，修改路由表，并运行up和down脚本。
- en: Windows - using the CryptoAPI store
  id: totrans-96
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Windows - 使用CryptoAPI存储
- en: OpenVPN has the capability of using the Windows CryptoAPI store to retrieve
    the public and private key needed for setting up a connection. This improves security
    somewhat, as the CryptoAPI store is more secure than the plaintext `.crt` and `.key`
    files that are normally used to set up an OpenVPN connection.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: OpenVPN具有使用Windows CryptoAPI存储来检索设置连接所需的公钥和私钥的功能。这在一定程度上提高了安全性，因为CryptoAPI存储比通常用于设置OpenVPN连接的明文`.crt`和`.key`文件更为安全。
- en: In this recipe, we will configure an OpenVPN client to retrieve the required
    information from the CryptoAPI store when connecting to the server. This recipe
    was tested on Windows 7, but it will also work on other versions of Windows.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个配方中，我们将配置一个OpenVPN客户端，在连接到服务器时从CryptoAPI存储中检索所需的信息。这个配方在Windows 7上进行了测试，但也适用于其他版本的Windows。
- en: Getting ready
  id: totrans-99
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备就绪
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client computer was running Windows 7 SP1 and OpenVPN
    2.3.11\. Keep the configuration file, `basic-udp-server.conf`, from the *Server-side
    routing* recipe in [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks* at hand.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 使用[第2章](part0025.xhtml#aid-NQU21 "第2章 客户端-服务器仅IP网络")中的第一个配方设置客户端和服务器证书，*客户端-服务器仅IP网络*。对于这个配方，服务器计算机运行的是CentOS
    6 Linux和OpenVPN 2.3.11，而客户端计算机运行的是Windows 7 SP1和OpenVPN 2.3.11。保留[第2章](part0025.xhtml#aid-NQU21
    "第2章 客户端-服务器仅IP网络")中*服务器端路由*配方中的配置文件`basic-udp-server.conf`以备使用。
- en: How to do it...
  id: totrans-101
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'First, we need to import the client certificate into the CryptoAPI store. In
    order to do that we must convert the existing `client2.crt` and `client2.key`
    files to PKCS12 format. Open a Windows command shell and change the directory
    to the location where these files are located:'
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 首先，我们需要将客户端证书导入到CryptoAPI存储中。为此，我们必须将现有的`client2.crt`和`client2.key`文件转换为PKCS12格式。打开Windows命令行窗口并切换到这些文件所在的目录：
- en: '[PRE9]'
  id: totrans-103
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Next, import the PKCS12 file into the Windows CryptoAPI store:'
  id: totrans-104
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，将PKCS12文件导入Windows CryptoAPI存储：
- en: '[PRE10]'
  id: totrans-105
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: The certificate import wizard will start.
  id: totrans-106
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 证书导入向导将启动。
- en: Click on **Next** on the first screen and again click on **Next** on the second
    screen. Then, you must supply the export password from the previous step:![How
    to do it...](img/image00419.jpeg)
  id: totrans-107
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在第一个屏幕上点击**下一步**，然后在第二个屏幕上再次点击**下一步**。接下来，您需要提供上一步中的导出密码：![如何操作...](img/image00419.jpeg)
- en: If you select the **Enable strong private key protection. You will be prompted
    every time the private key is used by an application if you enable this option**
    checkbox, the certificate and private key are even better protected, but you will
    be required to retype the password every time OpenVPN starts.
  id: totrans-108
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果您选择了**启用强私钥保护。启用此选项后，每次应用程序使用私钥时都需要提示您输入密码**复选框，证书和私钥将得到更好的保护，但每次OpenVPN启动时，您都需要重新输入密码。
- en: Click on **Next**. In the next screen, select the default option, **Automatically
    select the certificate store**, and click on **Next** once more. By clicking on **Finish**
    in the next screen, the certificate import is completed.![How to do it...](img/image00420.jpeg)
  id: totrans-109
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 单击**下一步**。在下一个屏幕中，选择默认选项**自动选择证书存储**，然后再次单击**下一步**。在下一个屏幕中点击**完成**，证书导入完成。![如何操作...](img/image00420.jpeg)
- en: 'Create the client configuration file:'
  id: totrans-110
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建客户端配置文件：
- en: '[PRE11]'
  id: totrans-111
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Save the configuration file as `example9-4.ovpn`. Start the server:'
  id: totrans-112
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将配置文件保存为`example9-4.ovpn`。启动服务器：
- en: '[PRE12]'
  id: totrans-113
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Start the VPN connection using the OpenVPN GUI.
  id: totrans-114
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用OpenVPN GUI启动VPN连接。
- en: The VPN connection should be established without asking for a private key password.
    If the CryptoAPI option, **Enable strong private key protection**, was enabled,
    a separate dialog will pop up to ask for the CryptoAPI password.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: VPN连接应当能够建立，而无需询问私钥密码。如果启用了CryptoAPI选项，**启用强私钥保护**，将弹出一个单独的对话框，要求输入CryptoAPI密码。
- en: How it works...
  id: totrans-116
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理...
- en: The Windows OpenVPN client software is capable of extracting a certificate and
    public key from the Windows CryptoAPI store if either the certificate subject
    name is specified using the keyword, `SUBJ:`, or if the certificate thumbprint
    or fingerprint is specified using the keyword, `THUMB:`. After retrieving the
    certificate and private key from the CryptoAPI store, the VPN connection is established
    in exactly the same manner as if a plaintext certificate and private key files
    had been used.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: Windows OpenVPN 客户端软件能够从 Windows CryptoAPI 存储中提取证书和公钥，如果指定了证书的主题名称（使用关键字`SUBJ:`）或者指定了证书的指纹（使用关键字`THUMB:`）。在从
    CryptoAPI 存储中检索到证书和私钥后，VPN 连接的建立方式与使用明文证书和私钥文件时完全相同。
- en: There's more...
  id: totrans-118
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: There are several small yet important details when using the Windows CryptoAPI
    store. We will cover this in the following sections.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 Windows CryptoAPI 存储时有几个小而重要的细节，我们将在接下来的章节中详细讲解。
- en: The CA certificate file
  id: totrans-120
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: CA 证书文件
- en: 'Note that it is still required to specify the CA certificate using the following
    line:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，仍然需要使用以下行来指定 CA 证书：
- en: '[PRE13]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: In theory, it would be possible to also retrieve the CA certificate from the
    CryptoAPI store, but this is currently not implemented in OpenVPN. Also, note
    that the CA certificate file needs to contain the certificate authority that was
    used to sign the server-side certificate, not the client-side certificate.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 理论上，也可以从 CryptoAPI 存储中检索 CA 证书，但 OpenVPN 目前没有实现此功能。还需要注意，CA 证书文件需要包含用于签署服务器端证书的证书颁发机构，而不是客户端证书。
- en: Certificate fingerprint
  id: totrans-124
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 证书指纹
- en: Instead of supplying `cryptoapicert SUBJ:<subject name>`, it is also possible
    to specify `cryptoapicert THUMB:<fingerprint>`.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 除了提供 `cryptoapicert SUBJ:<subject name>`，还可以指定 `cryptoapicert THUMB:<fingerprint>`。
- en: 'The fingerprint or thumbprint of an X509 certificate can be retrieved both
    by either looking up the `Thumb` property for the imported certificate in the
    Windows Certificate store or by typing the OpenSSL command:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: X509 证书的指纹或指纹打印可以通过在 Windows 证书存储中查找导入证书的 `Thumb` 属性，或者通过输入 OpenSSL 命令来检索：
- en: '[PRE14]'
  id: totrans-127
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Windows - updating the DNS cache
  id: totrans-128
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Windows - 更新 DNS 缓存
- en: A frequently recurring question on the OpenVPN users mailing lists is related
    to the DNS name resolution on Windows after the VPN connection is established.
    If the OpenVPN server pushes out a new DNS server, then this is automatically
    picked up by the OpenVPN client, yet the name resolution does not always work
    right after establishing the connection. This has little to do with OpenVPN and
    more to do with the way the Windows DNS caching service works. As this question
    comes up quite regularly, a new directive, `register-dns`, was added in OpenVPN
    2.1.3\. When this directive is specified, OpenVPN updates the Windows DNS cache
    and registers the VPN IP address in the Windows DNS tables. As this feature was
    introduced only recently, this recipe will also show how the Windows DNS cache
    can be updated using a script when the VPN connection is established. Some users
    disable the DNS caching service altogether, which seems to have little impact
    on the operating system, except for a small performance penalty when using a slow
    network.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 在 OpenVPN 用户邮件列表中，经常出现一个问题，关于在 VPN 连接建立后 Windows 的 DNS 名称解析。如果 OpenVPN 服务器推送了新的
    DNS 服务器，那么 OpenVPN 客户端会自动获取该 DNS 服务器，但名称解析在建立连接后并不总是正常工作。这与 OpenVPN 关系不大，更多与 Windows
    DNS 缓存服务的工作方式有关。由于这个问题经常出现，因此 OpenVPN 2.1.3 版本中增加了一个新的指令 `register-dns`。当指定此指令时，OpenVPN
    会更新 Windows DNS 缓存，并将 VPN IP 地址注册到 Windows DNS 表中。由于此功能最近才引入，本篇文章也将展示如何在 VPN 连接建立时使用脚本更新
    Windows DNS 缓存。有些用户会完全禁用 DNS 缓存服务，这似乎对操作系统影响不大，除了在使用慢速网络时会有一些小的性能损失。
- en: Getting ready
  id: totrans-130
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client computer was running Windows 7 SP1 and OpenVPN
    2.3.11\. Keep the server configuration file, `example9-2-server.conf`, from the *Linux:
    using pull-resolv-conf* recipe at hand, as well as the client configuration file, `basic-udp-client.ovpn`,
    from the *Using an ifconfig-pool block* recipe in [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*.'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: '使用 [第2章](part0025.xhtml#aid-NQU21 "第2章. 仅限IP的客户端-服务器网络") 中的第一个教程设置客户端和服务器证书，*客户端-服务器仅限IP网络*。在本教程中，服务器计算机运行
    CentOS 6 Linux 和 OpenVPN 2.3.11，客户端计算机运行 Windows 7 SP1 和 OpenVPN 2.3.11。请保留来自
    *Linux: 使用 pull-resolv-conf* 教程中的服务器配置文件 `example9-2-server.conf`，以及来自 *使用 ifconfig-pool
    块* 教程中的客户端配置文件 `basic-udp-client.ovpn`，这些都可以在 [第2章](part0025.xhtml#aid-NQU21 "第2章.
    仅限IP的客户端-服务器网络") 中找到，*客户端-服务器仅限IP网络*。'
- en: How to do it...
  id: totrans-132
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Start the server:'
  id: totrans-133
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动服务器：
- en: '[PRE15]'
  id: totrans-134
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Add a line to the `basic-udp-client.ovpn` configuration file:'
  id: totrans-135
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 `basic-udp-client.ovpn` 配置文件中添加一行：
- en: '[PRE16]'
  id: totrans-136
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Save this configuration file as `example9-5.ovpn`. Start the OpenVPN client.
  id: totrans-137
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将此配置文件保存为 `example9-5.ovpn`。启动 OpenVPN 客户端。
- en: 'The OpenVPN GUI status window will show that the Windows service `dnscache` has
    restarted:'
  id: totrans-138
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: OpenVPN GUI 状态窗口将显示 Windows 服务 `dnscache` 已重新启动：
- en: '![How to do it...](img/image00421.jpeg)'
  id: totrans-139
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![如何操作...](img/image00421.jpeg)'
- en: After the VPN connection is established, verify that the name resolution is
    using the VPN-supplied DNS server, for example, by using the `nslookup` command.
  id: totrans-140
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: VPN 连接建立后，验证名称解析是否使用 VPN 提供的 DNS 服务器，例如通过使用 `nslookup` 命令。
- en: How it works...
  id: totrans-141
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理...
- en: 'When the VPN connection is established, the OpenVPN client software sends a
    DHCP packet to the TAP-Win32 adapter with the IP address, default gateway, and
    the other network-related information, such as a new DNS server. This information
    is picked up by the operating system but the local DNS caching service is not
    notified immediately. The `register-dns` directive executes the following commands:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 当 VPN 连接建立时，OpenVPN 客户端软件将一个 DHCP 数据包发送到 TAP-Win32 适配器，包含 IP 地址、默认网关以及其他网络相关信息，例如新的
    DNS 服务器。操作系统会接收这些信息，但本地 DNS 缓存服务不会立即得到通知。`register-dns` 指令会执行以下命令：
- en: '[PRE17]'
  id: totrans-143
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: By forcing a restart of the DNS caching service, the DNS server supplied by
    the VPN connection is used immediately.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 通过强制重启 DNS 缓存服务，VPN 连接提供的 DNS 服务器会立即生效。
- en: See also
  id: totrans-145
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: The *Windows 8+ - ensuring DNS lookups are secure* recipe later in this chapter,
    which goes into detail of how to ensure that DNS lookups are passed over the VPN
    tunnel only
  id: totrans-146
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本章稍后的 *Windows 8+ - 确保 DNS 查找安全* 教程，详细介绍了如何确保 DNS 查找仅通过 VPN 隧道传输
- en: Windows - running OpenVPN as a service
  id: totrans-147
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Windows - 以服务方式运行 OpenVPN
- en: One of the lesser known features of the Windows version of OpenVPN is its ability
    to run it as a service. This allows OpenVPN to start and establish a VPN connection
    without a user logging in on the system. The OpenVPN service is installed by default,
    but is not started automatically.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: OpenVPN Windows 版本的一个较少为人知的功能是它能够作为服务运行。这允许 OpenVPN 在没有用户登录系统的情况下启动并建立 VPN 连接。OpenVPN
    服务默认安装，但不会自动启动。
- en: In this recipe, we will show how the OpenVPN service can be controlled using
    the OpenVPN GUI application and how to perform troubleshooting on the service.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个教程中，我们将展示如何通过 OpenVPN GUI 应用程序控制 OpenVPN 服务，并如何进行服务故障排除。
- en: Getting ready
  id: totrans-150
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client computer was running Windows 7 SP1 and OpenVPN
    2.3.11\. Keep the configuration file, `basic-udp-server.conf`, from the *Server-side
    routing* recipe in [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks* at hand. For the client,
    keep the configuration file, `basic-udp-client.ovpn`, from the *Using an ifconfig-pool
    block* recipe in [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks* at hand.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 使用[第2章](part0025.xhtml#aid-NQU21 "第2章 客户端-服务器仅IP网络")中的第一个方法设置客户端和服务器证书，*客户端-服务器仅IP网络*。在这个方法中，服务器计算机运行CentOS
    6 Linux和OpenVPN 2.3.11，客户端计算机运行Windows 7 SP1和OpenVPN 2.3.11。保留*服务器端路由*方法中的配置文件`basic-udp-server.conf`，该方法位于[第2章](part0025.xhtml#aid-NQU21
    "第2章 客户端-服务器仅IP网络")，*客户端-服务器仅IP网络*。对于客户端，保留*使用ifconfig-pool块*方法中的配置文件`basic-udp-client.ovpn`，该方法也位于[第2章](part0025.xhtml#aid-NQU21
    "第2章 客户端-服务器仅IP网络")，*客户端-服务器仅IP网络*。
- en: How to do it...
  id: totrans-152
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 操作方法...
- en: 'Start the server:'
  id: totrans-153
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动服务器：
- en: '[PRE18]'
  id: totrans-154
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Before starting the OpenVPN GUI application on the client side, we first launch
    the Windows registry editor, `regedit` (using elevated privileges). Find the `HKEY_LOCAL_MACHINE\SOFTWARE\OpenVPN-GUI`
    key.![How to do it...](img/image00422.jpeg)
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在启动客户端的OpenVPN GUI应用程序之前，我们首先启动Windows注册表编辑器`regedit`（使用提升权限）。找到`HKEY_LOCAL_MACHINE\SOFTWARE\OpenVPN-GUI`键。![操作方法...](img/image00422.jpeg)
- en: Take a note of the `config_dir` registry key, which is normally set to `C:\Program Files\OpenVPN\config`.
  id: totrans-156
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 记下`config_dir`注册表项，通常设置为`C:\Program Files\OpenVPN\config`。
- en: Set the registry key **allow_service** to **1**. Also, take note of the registry
    key, `log_dir`, which is normally set to `C:\Program Files\OpenVPN\log`.
  id: totrans-157
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将注册表项**allow_service**设置为**1**。同时，注意注册表项`log_dir`，通常设置为`C:\Program Files\OpenVPN\log`。
- en: Now, browse to the registry key, `HKEY_LOCAL_MACHINE\SOFTWARE\OpenVPN`, and
    check the `config_dir` and `log_dir` keys again. They should be pointing to the
    same directories as for the OpenVPN GUI application.
  id: totrans-158
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，浏览到注册表项`HKEY_LOCAL_MACHINE\SOFTWARE\OpenVPN`，并再次检查`config_dir`和`log_dir`键。它们应该指向与OpenVPN
    GUI应用程序相同的目录。
- en: Close the registry editor.
  id: totrans-159
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 关闭注册表编辑器。
- en: Launch the OpenVPN GUI. Right-click on the icon in the taskbar. A new menu option
    will have appeared.![How to do it...](img/image00423.jpeg)
  id: totrans-160
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动OpenVPN GUI。右键单击任务栏中的图标。一个新的菜单选项将会出现。![操作方法...](img/image00423.jpeg)
- en: But do not start the service yet.
  id: totrans-161
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 但不要立即启动服务。
- en: 'First, modify the client configuration file, `basic-udp-client.ovpn`, by changing
    the following lines:'
  id: totrans-162
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 首先，修改客户端配置文件`basic-udp-client.ovpn`，更改以下行：
- en: '[PRE19]'
  id: totrans-163
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'Change these to the following:'
  id: totrans-164
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 将这些更改为以下内容：
- en: '[PRE20]'
  id: totrans-165
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE20]'
- en: The `client2.key` client certificate from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*,
    is protected by a password, whereas the `client1.key` file is not. Save the configuration
    file as `example9-6.ovpn`.
  id: totrans-166
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 来自[第2章](part0025.xhtml#aid-NQU21 "第2章 客户端-服务器仅IP网络")，*客户端-服务器仅IP网络*的`client2.key`客户端证书有密码保护，而`client1.key`文件没有。将配置文件保存为`example9-6.ovpn`。
- en: Move all other `.ovpn` files to another directory to make sure that this is
    the only `.ovpn` file in the `config` directory.
  id: totrans-167
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将所有其他`.ovpn`文件移到另一个目录，确保`config`目录中只有此`.ovpn`文件。
- en: Now, start the OpenVPN service. After a while, the VPN connection will be established,
    as can be seen on both the client and the server in the log files.
  id: totrans-168
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，启动OpenVPN服务。过一段时间后，VPN连接将会建立，客户端和服务器的日志文件中都可以看到。
- en: How it works...
  id: totrans-169
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: A Windows service is launched at system startup before a user is logged in.
    The OpenVPN service scans the directory pointed to by the registry key, `HKEY_LOCAL_MACHINE\SOFTWARE\OpenVPN\config_dir`.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 一个Windows服务在系统启动时启动，用户登录之前。OpenVPN服务扫描注册表项`HKEY_LOCAL_MACHINE\SOFTWARE\OpenVPN\config_dir`所指向的目录。
- en: 'This starts an OpenVPN process for each file with the `.ovpn`  extension in
    that directory. The output of each of these processes is logged into the log directory
    pointed to by the registry key:'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 这会为该目录中每个`.ovpn`扩展名的文件启动一个OpenVPN进程。每个进程的输出都会记录到注册表项指向的日志目录：
- en: '[PRE21]'
  id: totrans-172
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Here, the log filename is the same as the configuration name, but now with the `.log`
    extension. For this recipe, the configuration file was `C:\Program Files\OpenVPN\config\example9-6.ovpn`
    and the log file was `C:\Program Files\OpenVPN\log\example9-6.log`.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，日志文件名与配置文件名相同，只是扩展名变成了`.log`。在本例中，配置文件为`C:\Program Files\OpenVPN\config\example9-6.ovpn`，日志文件为`C:\Program
    Files\OpenVPN\log\example9-6.log`。
- en: There is no need to launch the OpenVPN GUI to start these connections, but the
    GUI application does offer a convenient method of managing the OpenVPN service,
    if the right registry key is added.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 启动这些连接不需要启动 OpenVPN GUI，但如果添加了正确的注册表项，GUI 应用程序确实提供了管理 OpenVPN 服务的便捷方法。
- en: There's more...
  id: totrans-175
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: There are a few important notes when using the OpenVPN service, which are outlined
    here.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 OpenVPN 服务时有一些重要注意事项，这里列出了相关内容。
- en: Automatic service startup
  id: totrans-177
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 自动服务启动
- en: 'To make the OpenVPN service start at system startup, open the **Services**
    administrative control panel by navigating to **Control Panel** | **Administrative
    Tools** | **Services**. Double-click on the **OpenVPN Service** to open the properties
    and set the **Startup type** field to **Automatic**:'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 要使 OpenVPN 服务在系统启动时自动启动，请通过以下路径打开**服务**管理控制面板：**控制面板** | **管理工具** | **服务**。双击**OpenVPN
    服务**以打开属性，并将**启动类型**字段设置为**自动**：
- en: '![Automatic service startup](img/image00424.jpeg)'
  id: totrans-179
  prefs: []
  type: TYPE_IMG
  zh: '![自动服务启动](img/image00424.jpeg)'
- en: Click on **OK** and close the **Services** administrative control panel. Reboot
    Windows and verify on the server side that the client is connecting at system
    startup.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 点击**确定**并关闭**服务**管理控制面板。重新启动 Windows，并在服务器端验证客户端是否在系统启动时连接。
- en: OpenVPN user name
  id: totrans-181
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: OpenVPN 用户名
- en: 'When the OpenVPN service is used, the corresponding OpenVPN processes are normally
    run under the account **SYSTEM**, as can be seen in the following screenshot:'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 当使用 OpenVPN 服务时，相应的 OpenVPN 进程通常会以**SYSTEM**账户身份运行，正如以下截图所示：
- en: '![OpenVPN user name](img/image00425.jpeg)'
  id: totrans-183
  prefs: []
  type: TYPE_IMG
  zh: '![OpenVPN 用户名](img/image00425.jpeg)'
- en: This has some implications regarding the permissions on the configuration files.
    Special care also needs to be taken when using the `cryptoapicert` directive,
    as by default, those certificates end up in the user certificate store, which
    is not accessible to the **SYSTEM** account. It is possible to use the `cryptoapicert`
    directive, but the imported certificate must be installed as a (local) system
    certificate and not as a user certificate.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 这与配置文件的权限相关。使用`cryptoapicert`指令时也需要特别小心，因为默认情况下，这些证书会被存储在用户证书存储区，而该存储区对**SYSTEM**账户不可访问。可以使用`cryptoapicert`指令，但导入的证书必须作为（本地）系统证书安装，而不是用户证书。
- en: See also
  id: totrans-185
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: The *Windows - using the CryptoAPI store* recipe earlier in this chapter, which
    explains how to use the Windows CryptoAPI store to store the user certificate
    and private key
  id: totrans-186
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本章前面提到的*Windows - 使用 CryptoAPI 存储*的技巧，解释了如何使用 Windows CryptoAPI 存储来存储用户证书和私钥
- en: Windows - public versus private network adapters
  id: totrans-187
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Windows - 公共网络与私有网络适配器
- en: With Windows Vista and 7, Microsoft introduced the concept of network classes.
    Network interfaces can be part of a **Private** or **Public** network. When using
    OpenVPN, one must be careful in which type of network the adapter is placed. By
    default, OpenVPN's TAP-Win32 adapter is placed in a **Public** network, which
    has a side-effect that it is not possible to mount file shares. In this recipe,
    we will show how to change the network type so that the trusted services such
    as file sharing are possible over a VPN connection. While this has little to do
    with configuring the OpenVPN per se, this issue comes up often enough to warrant
    a recipe.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Windows Vista 和 7 中，微软引入了网络类别的概念。网络接口可以是**私有**网络或**公共**网络的一部分。在使用 OpenVPN
    时，必须小心适配器所处的网络类型。默认情况下，OpenVPN 的 TAP-Win32 适配器被放置在**公共**网络中，这有一个副作用，即无法挂载文件共享。在本例中，我们将展示如何更改网络类型，以便可以在
    VPN 连接上使用文件共享等受信服务。虽然这与配置 OpenVPN 本身关系不大，但这个问题经常出现，值得专门列出一个技巧。
- en: Getting ready
  id: totrans-189
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client computer was running Windows 7 SP1 and OpenVPN
    2.3.11\. Keep the configuration file, `basic-udp-server.conf`, from the *Server-side
    routing* recipe in [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks* at hand. For the client,
    keep the configuration file, `basic-udp-client.ovpn`, from the *Using an ifconfig-pool
    block* recipe in [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks* at hand.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 使用[第2章](part0025.xhtml#aid-NQU21 "第2章. 客户端-服务器IP仅网络")中的第一个食谱来设置客户端和服务器证书，*客户端-服务器IP仅网络*。在此食谱中，服务器计算机运行的是CentOS
    6 Linux和OpenVPN 2.3.11，客户端计算机运行的是Windows 7 SP1和OpenVPN 2.3.11。请将*服务器端路由*食谱中的`basic-udp-server.conf`配置文件保管好，该文件在[第2章](part0025.xhtml#aid-NQU21
    "第2章. 客户端-服务器IP仅网络")，*客户端-服务器IP仅网络*中。对于客户端，请将*使用ifconfig-pool块*食谱中的`basic-udp-client.ovpn`配置文件保管好，该文件也在[第2章](part0025.xhtml#aid-NQU21
    "第2章. 客户端-服务器IP仅网络")，*客户端-服务器IP仅网络*中。
- en: How to do it...
  id: totrans-191
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Append the following line to the `basic-udp-server.conf` file:'
  id: totrans-192
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将以下行附加到`basic-udp-server.conf`文件中：
- en: '[PRE22]'
  id: totrans-193
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Save it as `example9-7-server.conf`. Start the server:'
  id: totrans-194
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将其保存为`example9-7-server.conf`。启动服务器：
- en: '[PRE23]'
  id: totrans-195
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE23]'
- en: On the Windows client, launch the OpenVPN GUI.
  id: totrans-196
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在Windows客户端上，启动OpenVPN GUI。
- en: After the VPN connection is established, a window will pop up asking you what
    type of network this is. For Windows 7, you can choose **Home**, **Work**, or **Public**; for
    Windows 8+, the choice is either **Private** or **Public**.
  id: totrans-197
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在建立VPN连接后，会弹出一个窗口询问您这是哪种类型的网络。对于Windows 7，您可以选择**家庭**、**工作**或**公共**；对于Windows
    8及以上版本，选择是**私人**或**公共**。
- en: Select the **Work** network, and then open the **Network and Sharing Center**:![How
    to do it...](img/image00426.jpeg)
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择**工作**网络，然后打开**网络和共享中心**：![如何操作...](img/image00426.jpeg)
- en: How it works...
  id: totrans-199
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: With Windows 7+, each network type has different access rights. The network
    type with the fewest rights is **Public**, which means that the applications can
    set up TCP/IP connections, but they cannot access any of the resources available
    in the **Work** or **Private** networks, such as local printers and the local
    disks. When sharing resources that are on the same network as the OpenVPN client,
    this can become an issue.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 在Windows 7及以上版本中，每种网络类型有不同的访问权限。权限最少的网络类型是**公共**，这意味着应用程序可以建立TCP/IP连接，但不能访问**工作**或**私人**网络中的任何资源，如本地打印机和本地磁盘。当共享与OpenVPN客户端在同一网络上的资源时，这可能成为一个问题。
- en: Windows determines the type of network by looking at whether a default gateway
    is present for that network. If no default gateway is specified, the network is
    considered to be untrustworthy and hence it is made public. There is no option
    to easily change this afterward.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: Windows通过查看该网络是否具有默认网关来确定网络类型。如果没有指定默认网关，则该网络被视为不可信，因此它被设为公共网络。之后没有简单的选项可以更改此设置。
- en: 'To overcome this peculiarity, we supply a default gateway with a very high
    metric:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 为了克服这一特殊性，我们为其提供了一个具有非常高度量值的默认网关：
- en: '[PRE24]'
  id: totrans-203
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: Using a very high metric, we avoid the problem that all network traffic is routed
    over the VPN, which can lead to *biting-your-own-tail* problems.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 使用非常高的度量值，我们避免了所有网络流量都通过VPN路由的问题，这可能导致*自咬其尾*问题。
- en: See also
  id: totrans-205
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另请参见
- en: The *Windows - elevated privileges* recipe earlier in this chapter, which explains
    in more detail about how to run the OpenVPN GUI application with elevated privileges
  id: totrans-206
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本章前面提到的*Windows - 提升权限*食谱，详细解释了如何以提升权限运行OpenVPN GUI应用程序。
- en: Windows - routing methods
  id: totrans-207
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Windows - 路由方法
- en: 'When routes are pushed to a Windows client, there are two methods for adding
    these routes to the system routing tables:'
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 当路由被推送到Windows客户端时，有两种方法可以将这些路由添加到系统路由表中：
- en: Using the IPAPI helper functions (the default)
  id: totrans-209
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用IPAPI助手函数（默认方法）
- en: Using the `ROUTE.EXE` program
  id: totrans-210
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用`ROUTE.EXE`程序
- en: In most cases, the IPAPI method works fine, but sometimes, it is necessary to
    overrule this behavior. In this recipe, we will show how this is done and what
    to look for in the client log file to verify that the right method has been chosen.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 在大多数情况下，IPAPI方法工作正常，但有时需要覆盖此行为。在本食谱中，我们将展示如何做到这一点，并如何查看客户端日志文件，以验证是否选择了正确的方法。
- en: Getting ready
  id: totrans-212
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client computer was running Windows 7 SP1 and OpenVPN
    2.3.11\. Keep the configuration file, `basic-udp-server.conf`, from the *Server-side
    routing* recipe in [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks* at hand. For the client,
    keep the configuration file, `basic-udp-client.ovpn`, from the *Using an ifconfig-pool
    block* recipe in [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks* at hand.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 使用[第二章](part0025.xhtml#aid-NQU21 "第二章. 客户端-服务器IP仅网络")中的第一个食谱来设置客户端和服务器证书，*客户端-服务器IP仅网络*。在此食谱中，服务器计算机运行CentOS
    6 Linux和OpenVPN 2.3.11，客户端计算机运行Windows 7 SP1和OpenVPN 2.3.11。请随时备好在[第二章](part0025.xhtml#aid-NQU21
    "第二章. 客户端-服务器IP仅网络")中的*服务器端路由*食谱中的配置文件`basic-udp-server.conf`。对于客户端，请随时备好在[第二章](part0025.xhtml#aid-NQU21
    "第二章. 客户端-服务器IP仅网络")中的*使用ifconfig-pool块*食谱中的配置文件`basic-udp-client.ovpn`。
- en: How to do it...
  id: totrans-214
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Start the server:'
  id: totrans-215
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动服务器：
- en: '[PRE25]'
  id: totrans-216
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'Add the following lines to the `basic-udp-client.ovpn` configuration file:'
  id: totrans-217
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将以下行添加到`basic-udp-client.ovpn`配置文件中：
- en: '[PRE26]'
  id: totrans-218
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE26]'
- en: Save this configuration file as `example9-8.ovpn`. Start the OpenVPN client
    with this configuration.
  id: totrans-219
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将此配置文件保存为`example9-8.ovpn`。使用此配置启动OpenVPN客户端。
- en: 'After the connection has been established, bring up the **Show Status** window
    again and look at the last lines of the connection log. The log will show lines
    similar to the following:'
  id: totrans-220
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在连接建立之后，再次打开**显示状态**窗口，并查看连接日志的最后几行。日志会显示类似如下的内容：
- en: '[PRE27]'
  id: totrans-221
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Even though the `route-method` directive was set to `ipapi`, the log file prints
    out the path of the Windows `route.exe` command. The second line shows that the
    route was actually added using the IPAPI helper functions.
  id: totrans-222
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 即使`route-method`指令设置为`ipapi`，日志文件仍然会打印出Windows`route.exe`命令的路径。第二行显示路由实际上是通过IPAPI助手函数添加的。
- en: 'Now, modify the configuration file, `example9-8.ovpn`, to the following:'
  id: totrans-223
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，修改配置文件`example9-8.ovpn`，内容如下：
- en: '[PRE28]'
  id: totrans-224
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE28]'
- en: Restart the OpenVPN client.
  id: totrans-225
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 重启OpenVPN客户端。
- en: 'Look at the last lines of the connection log again. This time the message, **Route
    addition via IPAPI succeeded**, will not be present in the log file, which means
    that the `route.exe` command was used. Instead, you will see something similar
    to this:'
  id: totrans-226
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 再次查看连接日志的最后几行。这一次，日志文件中将不会出现**通过IPAPI添加路由成功**的信息，这意味着使用了`route.exe`命令。相反，您会看到类似以下内容：
- en: '[PRE29]'
  id: totrans-227
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE29]'
- en: The line starting with `env_block` indicates that a set of environment variables
    were set up prior to launching the external `route.exe` command.
  id: totrans-228
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 以`env_block`开头的这一行表示在启动外部`route.exe`命令之前，已经设置了一组环境变量。
- en: How it works...
  id: totrans-229
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: 'The `route-method` directive has three options:'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: '`route-method`指令有三个选项：'
- en: '`adaptive`: First, try the IPAPI method, and fallback to the `route.exe` method
    if IPAPI fails. This is the default.'
  id: totrans-231
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`adaptive`：首先尝试使用IPAPI方法，如果IPAPI失败，则回退到`route.exe`方法。这是默认选项。'
- en: '`ipapi`: Always use the IPAPI helper functions to add routes.'
  id: totrans-232
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`ipapi`：始终使用IPAPI助手函数来添加路由。'
- en: '`exe`: Always use the external program, `route.exe`.'
  id: totrans-233
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`exe`：始终使用外部程序`route.exe`。'
- en: Based on this directive, the OpenVPN client will choose how to add routes to
    the Windows routing tables. Note that if OpenVPN cannot add a route, it will not
    abort the connection. The current OpenVPN GUI does not detect this and will show
    a green icon in the taskbar, suggesting a fully successful connection.
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: 根据该指令，OpenVPN客户端将选择如何向Windows路由表添加路由。请注意，如果OpenVPN无法添加路由，它不会中止连接。当前的OpenVPN
    GUI无法检测到这一点，因此会在任务栏上显示一个绿色图标，表明连接完全成功。
- en: There's more...
  id: totrans-235
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多内容...
- en: 'OpenVPN is preconfigured to look for the `route.exe` program in the directory
    where Windows is installed, usually `C:\WINDOWS\system32`. If Windows is installed
    in a different directory, the `win-sys` directive can be used. The `win-sys` directive
    has two options:'
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: OpenVPN被预配置为在Windows安装目录中查找`route.exe`程序，通常是在`C:\WINDOWS\system32`。如果Windows安装在其他目录中，可以使用`win-sys`指令。`win-sys`指令有两个选项：
- en: The default option, `env`, which means that the OpenVPN client will use the
    contents of the environment variable, `windir`, to locate the Windows operating
    system. This environment variable is always set in a normal Windows setup. Starting
    with OpenVPN 2.3, this is the default setting and a warning message is printed
    if `win-sys env` is specified.
  id: totrans-237
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 默认选项，`env`，表示 OpenVPN 客户端将使用环境变量`windir`的内容来定位 Windows 操作系统。此环境变量在正常的 Windows
    设置中始终会被设置。从 OpenVPN 2.3 开始，这是默认设置，如果指定了`win-sys env`，则会打印警告信息。
- en: The directory name where the Windows operating system can be found, for example, `D:\WINDOWS`.
    This should be used only if the `route.exe` program is in a non-standard location.
  id: totrans-238
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows 操作系统所在的目录名，例如`D:\WINDOWS`。仅在`route.exe`程序位于非标准位置时使用此路径。
- en: Windows 8+ - ensuring DNS lookups are secure
  id: totrans-239
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Windows 8+ - 确保 DNS 查找是安全的
- en: Starting with Windows 8.1, Microsoft introduced a new feature for resolving
    hostnames to IP addresses. Whenever an application wants to resolve a hostname,
    a DNS query is sent out over all network adapters found in the system. The answer
    from the first adapter that responds to the query is used.
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 从 Windows 8.1 开始，微软引入了一个新特性，用于将主机名解析为 IP 地址。每当一个应用程序想要解析主机名时，都会通过系统中找到的所有网络适配器发送一个
    DNS 查询。第一个响应查询的适配器返回的答案将被使用。
- en: If a user wants to tunnel all traffic over a VPN in a secure manner, then this
    feature is not desirable. In a hostile network environment, a bogus IP address
    could be returned or even the fact that a DNS lookup for a particular host is
    made could be considered dangerous.
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 如果用户希望以安全的方式通过 VPN 隧道传输所有流量，那么此功能将不受欢迎。在敌对的网络环境中，可能会返回一个虚假的 IP 地址，甚至可能认为对特定主机进行
    DNS 查找是危险的。
- en: Starting with OpenVPN 2.3.10, a new option, `block-outside-dns`, was added to
    suppress this feature. In this recipe, we will show how to use this option.
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 从 OpenVPN 2.3.10 开始，新增了一个选项，`block-outside-dns`，用于抑制此功能。在此配方中，我们将展示如何使用此选项。
- en: Getting ready
  id: totrans-243
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client computer was running Windows 8.1 and OpenVPN 2.3.11\.
    Keep the configuration file, `basic-udp-server.conf`, from the *Server-side routing*
    recipe in [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only
    Networks"), *Client-server IP-only Networks* at hand. For the client, keep the
    configuration file, `basic-udp-client.ovpn`, from the *Using an ifconfig-pool
    block* recipe in [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks* at hand.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 使用[第 2 章](part0025.xhtml#aid-NQU21 "第 2 章。 客户端-服务器仅 IP 网络")中的第一个配方设置客户端和服务器证书，*客户端-服务器仅
    IP 网络*。对于此配方，服务器计算机运行的是 CentOS 6 Linux 和 OpenVPN 2.3.11，客户端计算机运行的是 Windows 8.1
    和 OpenVPN 2.3.11。保留[第 2 章](part0025.xhtml#aid-NQU21 "第 2 章。 客户端-服务器仅 IP 网络")中的*服务器端路由*配方中的配置文件`basic-udp-server.conf`，并随时可用。对于客户端，保留[第
    2 章](part0025.xhtml#aid-NQU21 "第 2 章。 客户端-服务器仅 IP 网络")中*使用 ifconfig-pool 块*配方中的配置文件`basic-udp-client.ovpn`。
- en: How to do it...
  id: totrans-245
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Start the server:'
  id: totrans-246
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动服务器：
- en: '[PRE30]'
  id: totrans-247
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'Add the following lines to the `basic-udp-client.ovpn` configuration file:'
  id: totrans-248
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将以下行添加到`basic-udp-client.ovpn`配置文件中：
- en: '[PRE31]'
  id: totrans-249
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE31]'
- en: Save this configuration file as `example9-9.ovpn`. Start the OpenVPN client
    with this configuration.
  id: totrans-250
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将此配置文件保存为`example9-9.ovpn`。使用此配置启动 OpenVPN 客户端。
- en: After the connection has been established, bring up the **Show Status** window
    again and look at the last lines of the connection log. The output should be similar
    to the following:![How to do it...](img/image00427.jpeg)
  id: totrans-251
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 连接建立后，再次打开**显示状态**窗口，查看连接日志的最后几行。输出应类似于以下内容：![如何操作...](img/image00427.jpeg)
- en: In this log file, the **Windows Filtering Platform** (**WFP**) is initialized
    and special rules are added to block DNS traffic.
  id: totrans-252
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在此日志文件中，**Windows 过滤平台**（**WFP**）被初始化，并添加了特殊规则以阻止 DNS 流量。
- en: 'Stop the OpenVPN client and check the log file again. You should see a line
    indicating that the WFP engine is shut down, thereby removing the filtering rules
    added by OpenVPN:'
  id: totrans-253
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 停止 OpenVPN 客户端并再次检查日志文件。您应该看到一行显示 WFP 引擎已关闭，从而移除 OpenVPN 添加的过滤规则：
- en: '[PRE32]'
  id: totrans-254
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE32]'
- en: How it works...
  id: totrans-255
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: With the `block-outside-dns` directive, a set of Windows filtering rules are
    created after the VPN connection has been established. These filter (or firewalling)
    rules prevent DNS lookups from being sent over all network adapters found on the
    Windows client, except for queries made over the TAP adapter. When the OpenVPN
    connection is terminated, the WFP rules are removed.
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 `block-outside-dns` 指令，在 VPN 连接建立后创建一组 Windows 过滤规则。这些过滤（或防火墙）规则阻止 DNS 查找通过
    Windows 客户端上所有网络适配器发送，除了通过 TAP 适配器发出的查询。当 OpenVPN 连接终止时，WFP 规则将被删除。
- en: There's more...
  id: totrans-257
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: Be careful when using this option with OpenVPN 2.3 when you have multiple simultaneous
    tunnels open. In some cases, the WFP rules that are added by the first tunnel
    are not restored properly when the second tunnel is shut down, thereby blocking
    all DNS traffic.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用 OpenVPN 2.3 并同时开启多个隧道时，务必小心此选项。在某些情况下，第一个隧道添加的 WFP 规则在第二个隧道关闭时没有正确恢复，从而阻止所有
    DNS 流量。
- en: Android - using the OpenVPN for Android clients
  id: totrans-259
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Android - 使用 OpenVPN for Android 客户端
- en: OpenVPN can also be used on mobile devices, such as Android or iPhone smartphones.
    In this recipe, we will show how to set up a basic configuration file for the
    OpenVPN for the Android app. The same configuration can be used on iPhones and
    iPads.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: OpenVPN 也可以在移动设备上使用，如 Android 或 iPhone 智能手机。在本食谱中，我们将展示如何为 Android 应用设置 OpenVPN
    的基本配置文件。相同的配置也可以用于 iPhone 和 iPad。
- en: Getting ready
  id: totrans-261
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client device was running Android 4.2 and OpenVPN for
    Android version 0.6.57\. Keep the configuration file, `basic-udp-server.conf`,
    from the *Server-side routing* recipe in [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*
    at hand. For the client, keep the configuration file, `basic-udp-client.ovpn`,
    from the *Using an ifconfig-pool block* recipe in [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*
    at hand.
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 [第 2 章](part0025.xhtml#aid-NQU21 "第 2 章. 客户端-服务器仅IP网络") 中的第一个食谱设置客户端和服务器证书，*客户端-服务器仅IP网络*。在这个食谱中，服务器计算机运行的是
    CentOS 6 Linux 和 OpenVPN 2.3.11。客户端设备运行的是 Android 4.2 和 OpenVPN for Android 版本
    0.6.57。保留来自 [第 2 章](part0025.xhtml#aid-NQU21 "第 2 章. 客户端-服务器仅IP网络")，*服务器端路由* 食谱中的配置文件
    `basic-udp-server.conf`。对于客户端，保留来自 [第 2 章](part0025.xhtml#aid-NQU21 "第 2 章. 客户端-服务器仅IP网络")，*使用
    ifconfig-pool 块* 食谱中的配置文件 `basic-udp-client.ovpn`。
- en: How to do it...
  id: totrans-263
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Start the server:'
  id: totrans-264
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动服务器：
- en: '[PRE33]'
  id: totrans-265
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'Create the OpenVPN app profile by converting the `basic-udp-client.ovpn` file
    to an inline configuration file. This is done by replacing all references to external
    files with the inline blobs. We then add these inline blobs by copying the contents
    from the external files. The resulting configuration file will look similar to
    this:'
  id: totrans-266
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过将 `basic-udp-client.ovpn` 文件转换为内联配置文件来创建 OpenVPN 应用配置文件。此过程通过将所有引用外部文件的部分替换为内联块来完成。然后，我们通过复制外部文件的内容将这些内联块添加到配置文件中。最终的配置文件将类似于以下内容：
- en: '[PRE34]'
  id: totrans-267
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE34]'
- en: Save this configuration file as `example9-10.ovpn`.
  id: totrans-268
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将此配置文件保存为 `example9-10.ovpn`。
- en: Transfer the app configuration file to the Android smartphone.
  id: totrans-269
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将应用配置文件传输到 Android 智能手机。
- en: Start the OpenVPN for Android app and import the `example9-10.ovpn` profile.
    If all goes well, you should see an output similar to this:![How to do it...](img/image00428.jpeg)
  id: totrans-270
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动 OpenVPN for Android 应用并导入 `example9-10.ovpn` 配置文件。如果一切顺利，你应该看到类似以下内容的输出：![如何操作...](img/image00428.jpeg)
- en: 'Launch the OpenVPN profile. After the connection has been established, the
    app will show the current status and log with the top line showing **Connected:
    SUCCESS, 10.200.0.2, 192.168.96.101, 1194:**![How to do it...](img/image00429.jpeg)'
  id: totrans-271
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '启动 OpenVPN 配置文件。在连接建立后，应用会显示当前状态和日志，顶部显示 **Connected: SUCCESS, 10.200.0.2,
    192.168.96.101, 1194:** ![如何操作...](img/image00429.jpeg)'
- en: How it works...
  id: totrans-272
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理...
- en: The OpenVPN for Android app is based on the same source code as the open source
    OpenVPN software. Hence, almost all options that can be specified in a normal
    configuration file can also be specified in an OpenVPN app profile. However, it
    is recommended to include all certificate and keying information inside the profile,
    as it makes it much easier to transfer the configuration to the device.
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: OpenVPN for Android 应用基于与开源 OpenVPN 软件相同的源代码。因此，几乎所有可以在常规配置文件中指定的选项也可以在 OpenVPN
    应用配置文件中指定。然而，建议将所有证书和密钥信息包含在配置文件中，因为这样更便于将配置文件传输到设备。
- en: There's more...
  id: totrans-274
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多内容...
- en: If you want to transfer the app profile by uploading it to a web server first,
    then make sure that the file type and extensions remain intact. The mobile device
    will treat the configuration file as a plain text file if it does not recognize
    it as an OpenVPN profile and you will not be able to import it into the OpenVPN
    for Android app. In such cases, it may be desirable to transfer the `.ovpn` file
    inside a ZIP (`.zip`) file.
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你希望通过先将应用配置文件上传到 web 服务器的方式进行传输，那么请确保文件类型和扩展名保持不变。如果移动设备无法将其识别为 OpenVPN 配置文件，它将把配置文件视为普通文本文件，这样你将无法将其导入到
    OpenVPN for Android 应用中。在这种情况下，建议将 `.ovpn` 文件放入 ZIP（`.zip`）文件中进行传输。
- en: See also
  id: totrans-276
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: The *Inline certificates* recipe in the next chapter, which goes into detail
    on using inline certificates
  id: totrans-277
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 下一章中的 *Inline certificates* 配方，详细介绍了如何使用内联证书
- en: Push-peer-info - pushing options to Android clients
  id: totrans-278
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Push-peer-info - 向 Android 客户端推送选项
- en: This recipe is a continuation of the previous recipe. When integrating mobile
    clients into an existing OpenVPN setup, it is often necessary to treat these mobile
    clients differently from the regular OpenVPN clients. In some cases, it will be
    necessary to redirect all traffic for mobile clients over the VPN tunnel or a
    different encryption scheme needs to be used to optimize the OpenVPN app on the
    Android device. In this recipe, we will demonstrate how to push an option to an
    Android client, while leaving the options for all other clients unchanged.
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 这个配方是前一个配方的延续。在将移动客户端集成到现有的 OpenVPN 设置中时，通常需要将这些移动客户端与常规的 OpenVPN 客户端区分开来。在某些情况下，可能需要将所有移动客户端的流量通过
    VPN 隧道进行重定向，或者需要使用不同的加密方案来优化 Android 设备上的 OpenVPN 应用程序。在这个配方中，我们将演示如何将选项推送到 Android
    客户端，同时保持所有其他客户端的选项不变。
- en: Getting ready
  id: totrans-280
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.4\. The client device was running Android 4.2 and OpenVPN for Android
    version 0.6.57\. Keep the configuration file, `basic-udp-server.conf`, from the *Server-side
    routing* recipe in [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks* at hand. For the client,
    keep the configuration file, `example9-10.ovpn`, from previous recipe at hand.
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 使用[第 2 章](part0025.xhtml#aid-NQU21 "第 2 章 客户端-服务器 IP-only 网络")中的第一个配方设置客户端和服务器证书，*客户端-服务器
    IP-only 网络*。对于这个配方，服务器计算机运行 CentOS 6 Linux 和 OpenVPN 2.4。客户端设备运行 Android 4.2 和
    OpenVPN for Android 版本 0.6.57。请保留来自[第 2 章](part0025.xhtml#aid-NQU21 "第 2 章 客户端-服务器
    IP-only 网络")，*客户端-服务器 IP-only 网络* 配方中的配置文件 `basic-udp-server.conf`。对于客户端，保留来自前一个配方的配置文件
    `example9-10.ovpn`。
- en: How to do it...
  id: totrans-282
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Append the following lines to the `basic-udp-server.conf` server configuration
    file:'
  id: totrans-283
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将以下行追加到 `basic-udp-server.conf` 服务器配置文件中：
- en: '[PRE35]'
  id: totrans-284
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'Save it as `example9-11-server.conf`. Next, create the connect script:'
  id: totrans-285
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将其保存为`example9-11-server.conf`。接下来，创建连接脚本：
- en: '[PRE36]'
  id: totrans-286
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'Save this file as `example9-11.sh`. Make sure that the script is executable
    and start the server:'
  id: totrans-287
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将此文件保存为 `example9-11.sh`。确保该脚本是可执行的并启动服务器：
- en: '[PRE37]'
  id: totrans-288
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE37]'
- en: Start the OpenVPN for Android app and establish the VPN connection.
  id: totrans-289
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动 OpenVPN for Android 应用并建立 VPN 连接。
- en: After the connection has been established, use another app, such as Fing, to
    ensure that all traffic is redirected via the OpenVPN tunnel:![How to do it...](img/image00430.jpeg)
  id: totrans-290
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在连接建立后，使用另一个应用程序（如 Fing）确保所有流量都通过 OpenVPN 隧道重定向：![如何操作...](img/image00430.jpeg)
- en: The first address in the traceroute output is `10.200.0.1`, demonstrating that
    the traffic is redirected via the OpenVPN server.
  id: totrans-291
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 路由跟踪输出中的第一个地址是 `10.200.0.1`，这表明流量通过 OpenVPN 服务器进行了重定向。
- en: How it works...
  id: totrans-292
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理...
- en: In the OpenVPN for Android configuration, we added the `push-peer-info` option.
    This causes the OpenVPN client to send configuration details to the server. Starting
    with OpenVPN 2.4, these configuration details are available both inside plugins
    and scripts. The `client-connect` script examines the environment variable, `IV_PLAT`,
    and pushes a `redirect-gateway` if an Android client is connecting.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 在 OpenVPN for Android 配置中，我们添加了 `push-peer-info` 选项。这使得 OpenVPN 客户端可以将配置信息发送到服务器。从
    OpenVPN 2.4 开始，这些配置信息可以在插件和脚本中使用。`client-connect` 脚本检查环境变量 `IV_PLAT`，并在 Android
    客户端连接时推送 `redirect-gateway`。
- en: There's more...
  id: totrans-294
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: 'The `push-peer-info` option is available in all OpenVPN 2.3 clients. However,
    support on the server side to actually process this information was added in version
    2.4\. The following peer information is sent to the server:'
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: '`push-peer-info` 选项在所有 OpenVPN 2.3 客户端中都可用。然而，服务器端处理此信息的支持是在 2.4 版本中添加的。以下对等信息被发送到服务器：'
- en: '`IV_COMP_STUB=1, IV_COMP_STUBv2=1`: This indicates that the client supports
    compression stubs. It also means that the server can push compression options
    to the client.'
  id: totrans-296
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`IV_COMP_STUB=1, IV_COMP_STUBv2=1`：这表示客户端支持压缩存根。这也意味着服务器可以将压缩选项推送给客户端。'
- en: '`IV_GUI_VER=de.blinkt.openvpn_0.6.57`: This indicates the client GUI version.
    In this case, the OpenVPN for Android client version 0.6.57 was used.'
  id: totrans-297
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`IV_GUI_VER=de.blinkt.openvpn_0.6.57`：这表示客户端的 GUI 版本。在这种情况下，使用的是 OpenVPN for
    Android 客户端版本 0.6.57。'
- en: '`IV_HWADDR=00:00:00:00:00:00`: This indicates the client''s Ethernet hardware
    address. On Android clients, this option is always `00:00:00`, but on other platforms
    the MAC address of the TUN/TAP adapter is transmitted.'
  id: totrans-298
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`IV_HWADDR=00:00:00:00:00:00`：这表示客户端的以太网硬件地址。在 Android 客户端上，该选项始终为`00:00:00`，但在其他平台上，TUN/TAP
    适配器的 MAC 地址会被传输。'
- en: '`IV_LZ4=1, IV_LZ4v2=1, IV_LZO=1`: This indicates that the client supports LZ4,
    LZ4v2, and LZO compression.'
  id: totrans-299
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`IV_LZ4=1, IV_LZ4v2=1, IV_LZO=1`：这表示客户端支持 LZ4、LZ4v2 和 LZO 压缩。'
- en: '`IV_NCP=2`: This indicates that the client supports encryption cipher negotiation.
    This allows the client and server to negotiate the most optimal compression and
    HMAC algorithms.'
  id: totrans-300
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`IV_NCP=2`：这表示客户端支持加密密码协商。这允许客户端和服务器协商出最优的压缩和 HMAC 算法。'
- en: '`IV_PLAT=android`: This indicates the client platform.'
  id: totrans-301
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`IV_PLAT=android`：这表示客户端平台。'
- en: '`IV_PROTO=2`: This indicates the version of the push-peer-info format. In the
    future, the format or set of variables sent to the server might change, which
    would warrant an increase in the version number.'
  id: totrans-302
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`IV_PROTO=2`：这表示推送对等信息格式的版本。未来，发送到服务器的格式或变量集可能会发生变化，这将需要版本号的增加。'
- en: '`IV_RGI6=1`: This indicates that the client supports redirection of the IPv6
    gateway address.'
  id: totrans-303
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`IV_RGI6=1`：这表示客户端支持重定向 IPv6 网关地址。'
- en: '`IV_SSL=OpenSSL_1.0.2h__3_May_2016`: This indicates the SSL library and version
    that is used by the OpenVPN client. This could be important to determine whether
    a particular client is susceptible to a crypto library vulnerability.'
  id: totrans-304
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`IV_SSL=OpenSSL_1.0.2h__3_May_2016`：这表示 OpenVPN 客户端使用的 SSL 库及其版本。这对于确定某个客户端是否易受加密库漏洞的影响可能非常重要。'
- en: '`IV_VER=2.4_master`: This indicates the version of the OpenVPN software on
    the client.'
  id: totrans-305
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`IV_VER=2.4_master`：这表示客户端上 OpenVPN 软件的版本。'
