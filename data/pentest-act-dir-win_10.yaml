- en: '10'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '10'
- en: Taking Over WSUS and SCCM
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 接管WSUS和SCCM
- en: In this final chapter of the book, we will focus on attacking infrastructure
    management solutions. These are valuable and attractive targets for an adversary
    as such systems are operated under highly privileged accounts with access to almost
    every piece of the target environment. **Windows Server Update Services** (**WSUS**)
    is a service to deploy updates to the client computers in a centralized manner.
    **Microsoft Endpoint Configuration Management** (**MECM**) – formerly known as
    **System Center Configuration Manager** (**SCCM**) – is an on-premises management
    solution for endpoints. This product helps IT professionals run system inventory,
    patching, software deployment, and so on.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书的最后一章中，我们将重点攻击基础设施管理解决方案。这些系统是对攻击者非常有价值和有吸引力的目标，因为这些系统通常由高度特权账户操作，几乎可以访问目标环境的所有部分。**Windows服务器更新服务**（**WSUS**）是一种以集中方式向客户端计算机部署更新的服务。**Microsoft
    Endpoint Configuration Management**（**MECM**）——前身为**System Center Configuration
    Manager**（**SCCM**）——是一种本地端点管理解决方案。该产品帮助IT专业人员进行系统清单管理、补丁管理、软件部署等。
- en: 'We will start by discussing known attacks on WSUS and then show how it can
    be abused for lateral movement. However, the main focus of this chapter is on
    SCCM. After the introduction and necessary theory, we will move on to the deployment
    stage. When our lab is ready, it is time to go through the kill chain one more
    time: reconnaissance, privilege escalation, and lateral movement. As usual, our
    main attention will be on the service-specific techniques. We will finish the
    chapter with defensive recommendations.'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将从讨论已知的针对WSUS的攻击开始，然后展示如何利用它进行横向移动。然而，本章的主要重点是SCCM。在介绍和必要的理论之后，我们将进入部署阶段。当我们的实验室准备好后，就可以再次走过攻击链：侦察、特权提升和横向移动。像往常一样，我们的主要关注点将是特定服务的技术。我们将以防御性建议结束本章。
- en: 'In this chapter, we are going to cover the following main topics:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将涵盖以下主要内容：
- en: Abusing WSUS
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 滥用WSUS
- en: Introduction to and deployment of MECM/SCCM
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: MECM/SCCM的介绍和部署
- en: Reconnaissance
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 侦察
- en: Privilege escalation
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 特权提升
- en: Lateral movement
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 横向移动
- en: Defensive recommendations
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 防御性建议
- en: Technical requirements
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'In this chapter, you will need to have access to the following:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 本章您需要访问以下内容：
- en: VMware Workstation or Oracle VirtualBox with at least 16 GB of RAM, 8 CPU cores,
    and at least 55 GB of total space (more if you take snapshots)
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: VMware Workstation或Oracle VirtualBox，至少16 GB的RAM，8个CPU核心，至少55 GB的总空间（如果进行快照，则需要更多空间）
- en: Linux-based operating system is strongly recommended
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 强烈推荐使用基于Linux的操作系统
- en: From GOADv2 project we will use DC01, SRV01
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们将从GOADv2项目中使用DC01、SRV01
- en: From DetectionLab we will use DC, WEF, Win10.
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们将从DetectionLab使用DC、WEF、Win10。
- en: Abusing WSUS
  id: totrans-17
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 滥用WSUS
- en: 'In most corporate environments, updates are distributed and installed centrally
    by administrators. For Windows-based infrastructure, the way to go is to install
    a WSUS server role on one of the servers in the network and force clients and
    servers to use it as a source of updates. WSUS can help to eliminate risks related
    to missing patches but can also be a target for compromise. The reason is simple:
    attackers can use it to distribute malicious code that will be automatically downloaded
    and installed and looks legitimate and trustworthy. Clients will get all the required
    information about the WSUS server by querying the registry key values in **HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate**.
    In essence, WSUS is a **Simple Object Access Protocol** (**SOAP**) XML web service.
    All updates must be signed by Microsoft, and WSUS checks the digital signature
    and hash of every update. However, **Transport Layer Security** (**TLS**) is not
    enabled by default, opening the first opportunity for compromise.'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 在大多数企业环境中，更新是由管理员集中分发和安装的。对于基于Windows的基础设施，推荐的方法是在网络中的一台服务器上安装WSUS服务器角色，并强制客户端和服务器使用它作为更新的来源。WSUS有助于消除缺少补丁所带来的风险，但也可能成为攻击的目标。原因很简单：攻击者可以利用它分发恶意代码，这些代码将被自动下载并安装，看起来合法且值得信赖。客户端将通过查询**HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate**中的注册表键值获取关于WSUS服务器的所有必要信息。从本质上讲，WSUS是一个**简单对象访问协议**（**SOAP**）XML
    Web服务。所有更新必须由微软签名，WSUS会检查每个更新的数字签名和哈希值。然而，**传输层安全性**（**TLS**）默认情况下没有启用，这为攻击者提供了第一个可乘之机。
- en: Unencrypted communication can lead to a **Man-in-the-Middle** (**MitM**) attack
    depending on the attacker’s position in the network. Firstly, we need to check
    the **WUServer** registry value for the HTTP protocol presence, which means that
    TLS is not in use and the attack is possible Then, we can try to perform **Address
    Resolution Protocol** (**ARP**) spoofing and deliver a signed binary such as **PsExec**.
    The attack consists of two parts – MitM and distribution. **GoSecure** developed
    a malicious update distribution tool called **PyWSUS**[1]. To carry out the MitM
    attack, **bettercap**[2] was recommended in the research[3].
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 未加密的通信可能导致**中间人**(**MitM**)攻击，具体取决于攻击者在网络中的位置。首先，我们需要检查**WUServer**注册表值是否包含HTTP协议，这意味着TLS未启用，攻击是可能的。然后，我们可以尝试进行**地址解析协议**(**ARP**)欺骗，并传递签名二进制文件，例如**PsExec**。攻击分为两部分——MitM和分发。**GoSecure**开发了一种恶意更新分发工具，名为**PyWSUS**[1]。为了执行MitM攻击，研究中推荐了**bettercap**[2][3]。
- en: Another vector we should not miss is vulnerabilities in the client itself. For
    example, CVE-2020-1013 allows us to modify local user proxy settings, so we can
    run **PyWSUS** locally, executing code with **SYSTEM** privileges on the machine.
    The tool to run this attack – called **WSuspicious** – was published in the *GoSecure*
    GitHub repository[4].
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个我们不应忽视的攻击面是客户端本身的漏洞。例如，CVE-2020-1013允许我们修改本地用户的代理设置，从而可以在本地运行**PyWSUS**，以**SYSTEM**权限在机器上执行代码。执行此攻击的工具——名为**WSuspicious**——已发布在*GoSecure*的GitHub仓库[4]中。
- en: Also, if we target any Windows-based environment, the **New Technology LAN Manager**
    (**NTLM**) relay attack is always somewhere nearby. As discussed previously, we
    can redirect the client’s WSUS requests toward a malicious WSUS server, so nothing
    stops us from requesting NTLM authentication and the client will automatically
    do so.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，如果我们针对任何基于Windows的环境，**新技术LAN管理器**(**NTLM**)中继攻击总是在某个地方潜伏。如前所述，我们可以将客户端的WSUS请求重定向到恶意的WSUS服务器，因此没有任何东西阻止我们请求NTLM身份验证，客户端将自动执行此操作。
- en: Note
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'This technique is described by *GoSecure* here: [https://www.gosecure.net/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks/](https://www.gosecure.net/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks/).'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 该技术由*GoSecure*在这里描述：[https://www.gosecure.net/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks/](https://www.gosecure.net/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks/)。
- en: The main takeaway from all the attacks so far described is to enforce WSUS updates
    only over secure HTTPS transport.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止描述的所有攻击的主要结论是，确保WSUS更新仅通过安全的HTTPS传输进行。
- en: The last attack in our scope is the distribution of malicious updates to the
    client if the attacker has compromised the WSUS server itself. For this purpose,
    we will deploy WSUS on **castelrock.sevenkingdoms.local** and install a malicious
    update on **kingslanding.sevenkingdoms.local**, getting a reverse shell. We need
    to deploy WSUS in our lab following the guide provided by Microsoft[5].
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的攻击范围内的最后一个攻击是如果攻击者已入侵WSUS服务器本身，则向客户端分发恶意更新。为此，我们将在**castelrock.sevenkingdoms.local**上部署WSUS，并在**kingslanding.sevenkingdoms.local**上安装恶意更新，获得反向Shell。我们需要根据Microsoft提供的指南[5]在实验室中部署WSUS。
- en: Role installation is straightforward. The next step is service configuration.
    We will untick all OS versions and software in the suggested update target list
    as we do not want WSUS to pull updates from the internet. Lastly, we need to configure
    Group Policy, so the **domain controller** (**DC**) will pull updates from WSUS[6].
    It is important to mention that we must use a **fully qualified domain name**
    (**FQDN**) with a port number for the WSUS server in the Group Policy parameter.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 角色安装很简单。接下来的步骤是服务配置。我们将取消选中所有操作系统版本和软件的更新目标列表，因为我们不希望WSUS从互联网上拉取更新。最后，我们需要配置组策略，使**域控制器**(**DC**)从WSUS拉取更新[6]。值得一提的是，在组策略参数中，我们必须使用**完全限定域名**(**FQDN**)和端口号来指定WSUS服务器。
- en: 'To compromise the DC, we can utilize the **SharpWSUS**[7] or **wsuspendu**[8]
    tools. The plan is to host a reverse shell script on our web server, and download
    and execute it by using **PsExec**[9] as a payload (as it is signed by Microsoft):'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 为了攻陷DC，我们可以利用**SharpWSUS**[7]或**wsuspendu**[8]工具。计划是将反向Shell脚本托管在我们的Web服务器上，并使用**PsExec**[9]作为有效载荷下载并执行它（因为它由Microsoft签名）。
- en: '[PRE0]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Then, the update is installed on the DC, and we obtain the reverse shell as
    **SYSTEM**:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，更新被安装到DC上，我们获得了作为**SYSTEM**的反向Shell：
- en: '![Figure 10.1 – Reverse shell on the DC as SYSTEM](image/B18964_10_01.jpg)'
  id: totrans-30
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.1 – 作为 SYSTEM 在 DC 上的反向 shell](image/B18964_10_01.jpg)'
- en: Figure 10.1 – Reverse shell on the DC as SYSTEM
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.1 – 作为 SYSTEM 在 DC 上的反向 shell
- en: In this section, we discussed the most common compromise vectors for WSUS such
    as MitM, missing patches, and NTLM relay attacks. Also, we demonstrated how compromised
    WSUS can be abused for lateral movement, effectively giving the attacker the possibility
    of a complete infrastructure takeover.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们讨论了 WSUS 最常见的攻陷路径，如中间人攻击（MitM）、缺失的补丁和 NTLM 中继攻击。我们还演示了如何利用被攻陷的 WSUS 进行横向移动，实际上使攻击者有可能完全接管基础设施。
- en: In the next section, we will start with systems management software developed
    by Microsoft. It is now called MECM, but we often still use the old name, which
    is SCCM.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 在接下来的部分，我们将介绍微软开发的系统管理软件。它现在被称为 MECM，但我们仍然经常使用旧名称 SCCM。
- en: Introduction to MECM/SCCM
  id: totrans-34
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: MECM/SCCM 简介
- en: SCCM is a complicated piece of software with its own hierarchy and terms. We
    will start with the required theory. In essence, SCCM utilizes client-server architecture,
    where an agent is installed on endpoints and then called back to the server.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: SCCM 是一款复杂的软件，具有自己的层次结构和术语。我们将从必要的理论开始。本质上，SCCM 采用客户端-服务器架构，其中一个代理程序安装在终端上，然后回调到服务器。
- en: Note
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'Hierarchy designs are described by Microsoft here: [https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/design-a-hierarchy-of-sites](https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/design-a-hierarchy-of-sites).'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 层次结构设计由微软在此处描述：[https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/design-a-hierarchy-of-sites](https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/design-a-hierarchy-of-sites)。
- en: 'In our lab, we will deploy a single standalone **primary site**. The **secondary
    site** can be added for scalability purposes in a bigger environment. Also, if
    there are more than two primary sites, you will need a **central administration
    site**, which is used only for managing sites, not the clients. Every site has
    a three-letter **site code**. Clients are grouped in **boundary groups** based
    on, surprise, boundaries. Network range or **Active Directory** (**AD**) group
    membership are good examples of boundaries. Also, it is possible to perform discovery
    tasks and automatically assign clients to the group, depending on certain criteria.
    **Management point** (**MP**) is a role providing clients with policies and configurations
    to communicate with the site server. It is installed on the primary site server
    by default. Next, clients need to know the **distribution point** (**DP**) to
    be able to get updates, software, and so on. All information about the clients
    is stored on the **site database server**, which is Microsoft SQL Server. Communication
    between the primary server and the database is the responsibility of the **SMS
    provider** component. In our lab, we will install an SMS provider and database
    server on our primary site server. There is an excellent visualization diagram
    of a hierarchy[10] next:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的实验室中，我们将部署一个单独的独立**主站点**。为了在更大的环境中实现可扩展性，可以添加**次级站点**。另外，如果有多个主站点，就需要一个**中央管理站点**，该站点仅用于管理站点，而不是客户端。每个站点都有一个三字母的**站点代码**。客户端根据**边界组**进行分组，边界组是基于，没错，边界的。网络范围或**Active
    Directory**（**AD**）组成员资格是边界的典型示例。并且，可以执行发现任务，并根据某些标准自动将客户端分配到组中。**管理点**（**MP**）是为客户端提供策略和配置，以便与站点服务器进行通信的角色。默认情况下，它安装在主站点服务器上。接下来，客户端需要知道**分发点**（**DP**），才能获取更新、软件等。所有关于客户端的信息都存储在**站点数据库服务器**上，该服务器是微软的
    SQL Server。主服务器和数据库之间的通信由**SMS提供程序**组件负责。在我们的实验室中，我们将在主站点服务器上安装 SMS 提供程序和数据库服务器。接下来是一个很好的层次结构可视化图：[10]如下：
- en: '![Figure 10.2 – Typical SCCM hierarchy](image/B18964_10_02.jpg)'
  id: totrans-39
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.2 – 典型的 SCCM 层次结构](image/B18964_10_02.jpg)'
- en: Figure 10.2 – Typical SCCM hierarchy
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.2 – 典型的 SCCM 层次结构
- en: There are many ways to install clients on target machines in the boundary group.
    The default way is a **client push installation**. This uses client push installation
    accounts, which are service accounts with administrative rights on the computer.
    During installation, it authenticates using that account and installs the client.
    If there are a few accounts configured, the server will try to authenticate each
    of them, one by one. Another promising account from an adversary’s point of view
    is a **Network Access Account** (**NAA**). This account is utilized when a non-domain-joined
    client wants to access content from a DP.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 在边界组中的目标机器上，有多种安装客户端的方式。默认方式是**客户端推送安装**。这使用客户端推送安装账户，它们是具有计算机管理权限的服务账户。在安装过程中，使用该账户进行身份验证并安装客户端。如果配置了几个账户，服务器会依次尝试对每个账户进行身份验证。另一个从攻击者的角度来看很有前景的账户是**网络访问账户**（**NAA**）。当非域加入客户端想要从DP访问内容时，会使用该账户。
- en: Our next task is to deploy SCCM in **DetectionLab**. I will install it on a
    WEF machine.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的下一个任务是将SCCM部署到**DetectionLab**中。我将在一台WEF机器上安装它。
- en: Deployment
  id: totrans-43
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 部署
- en: Deployment is quite a lengthy process. I suggest having a 2–3-hour timeframe
    for adding CPU and memory to the WEF virtual machine.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 部署过程相当漫长。我建议为在WEF虚拟机上添加CPU和内存预留2到3小时的时间。
- en: Note
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: To deploy SCCM, I used two resources. The first one is made by *Benoit Lecours*
    from System Center Dudes ([https://www.systemcenterdudes.com/complete-sccm-installation-guide-and-configuration/](https://www.systemcenterdudes.com/complete-sccm-installation-guide-and-configuration/))
    and the second one is an adapted version of the preceding one, by *HTTP418* ([https://http418infosec.com/grow-your-own-sccm-lab](https://http418infosec.com/grow-your-own-sccm-lab)).
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 为了部署SCCM，我使用了两个资源。第一个由*Benoit Lecours*制作，来自System Center Dudes ([https://www.systemcenterdudes.com/complete-sccm-installation-guide-and-configuration/](https://www.systemcenterdudes.com/complete-sccm-installation-guide-and-configuration/))，第二个是前一个版本的改编版，由*HTTP418*提供
    ([https://http418infosec.com/grow-your-own-sccm-lab](https://http418infosec.com/grow-your-own-sccm-lab))。
- en: 'I will not put a step-by-step guide here; however, I will briefly cover my
    journey:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 我不会在此提供逐步指南；然而，我会简要地讲述我的过程：
- en: On the WEF machine, enable the **Windows Installer** and **Windows Module**
    **Installer** services.
  id: totrans-48
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在WEF机器上，启用**Windows Installer**和**Windows Module** **Installer**服务。
- en: Perform schema extension using **extadsch.exe**.
  id: totrans-49
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用**extadsch.exe**执行架构扩展。
- en: Create a container and accounts in AD as per the HTTP418 guide.
  id: totrans-50
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按照HTTP418指南在AD中创建容器和账户。
- en: Use **Group Policy** to push firewall rules and add a client push installation
    account to the local **Administrators** group on target machines.
  id: totrans-51
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用**组策略**推送防火墙规则，并将客户端推送安装账户添加到目标机器的本地**管理员**组中。
- en: Install required Windows features.
  id: totrans-52
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装所需的Windows功能。
- en: Install the Windows **Assessment and Deployment** **Kit** (**ADK**).
  id: totrans-53
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装Windows **评估和部署** **工具包**（**ADK**）。
- en: Install Microsoft SQL Server in evaluation mode.
  id: totrans-54
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 以评估模式安装Microsoft SQL Server。
- en: Set required SPNs.
  id: totrans-55
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 设置所需的SPN。
- en: I skipped database creation and only enabled listening on the IP address for
    SQL Server.
  id: totrans-56
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我跳过了数据库创建，只在SQL Server上启用了IP地址监听。
- en: Install the evaluation version of SCCM.
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装SCCM的评估版。
- en: 'After the installation is complete, configuration is required. I followed the
    guide and was finally able to run a script on a WIN10 computer, as shown in the
    following screenshot:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 安装完成后，需要进行配置。我按照指南操作，最终能够在一台WIN10计算机上运行脚本，如下图所示：
- en: '![Figure 10.3 – Running a script on a WIN10 client from the configuration console](image/B18964_10_03.jpg)'
  id: totrans-59
  prefs: []
  type: TYPE_IMG
  zh: '![图10.3 – 从配置控制台在WIN10客户端上运行脚本](image/B18964_10_03.jpg)'
- en: Figure 10.3 – Running a script on a WIN10 client from the configuration console
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.3 – 从配置控制台在WIN10客户端上运行脚本
- en: Now the deployment is over, we should have a minimal working environment for
    attack simulation.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 现在部署完成，我们应该有一个最小的工作环境，用于攻击模拟。
- en: Note
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'A great review of the SCCM attack surface with nicely structured schema was
    created by *0xcsandker* in his blog post here: [https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/](https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/).'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: '*0xcsandker*在他的博客中创建了一个关于SCCM攻击面的大量回顾，并附有精心结构化的架构图，可以在此链接查看：[https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/](https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/)。'
- en: As usual, our first step will be reconnaissance. We will focus on exploring
    SCCM infrastructure and host enumeration.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 和往常一样，我们的第一步将是侦察。我们将重点探索SCCM基础设施和主机枚举。
- en: Reconnaissance
  id: totrans-65
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 侦察
- en: In this section, we will discuss reconnaissance, as well as enumeration. We
    will briefly cover how to identify SCCM only with network access and then dive
    deeper into the *assume* *breach* scenario.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 在这一节中，我们将讨论侦察和枚举。我们将简要介绍如何仅通过网络访问识别SCCM，然后深入探讨*假设* *突破*场景。
- en: To identify SCCM infrastructure from a non-domain-joined machine, the attacker
    may perform a simple port scan looking for TCP ports **8530** and **8531** (Software
    Update point), **10123** (Management point), and **4022** and **1433** (SQL Server).
    Also, the UDP port **4011** might be an indicator of the **Preboot Execution Environment**
    (**PXE**) boot media being offered. SCCM can be deployed with or without a PXE
    offering called **Operating System Deployment** (**OSD**). We do not have PXE
    deployed in our lab, but there are some promising vectors to consider.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 为了从未加入域的机器中识别SCCM基础设施，攻击者可能会执行一个简单的端口扫描，寻找TCP端口**8530**和**8531**（软件更新点）、**10123**（管理点）、**4022**和**1433**（SQL服务器）。此外，UDP端口**4011**可能是提供**预启动执行环境**（**PXE**）启动介质的指示器。SCCM可以部署有或没有PXE提供的**操作系统部署**（**OSD**）。我们的实验室中没有部署PXE，但有一些有前景的向量值得考虑。
- en: To check whether PXE is available in the environment, there is a tool called
    **PXEThief**[11]. This tool sends a DHCP discover request to search for PXE servers
    and fetch PXE boot files. If PXE media is encrypted, then the attacker needs to
    guess or crack the password to decrypt it. After decryption, the tool will parse
    files for NAA accounts and credentials in **task sequences** or stored within
    **collection variables**. In OSD, there is a task sequence functionality. This
    functionality, in a nutshell, is a defined list of steps to deploy the machine
    correctly. Some of the steps, such as *Task sequence domain join account*, will
    use domain user credentials. Also, collection variables in task sequence steps
    may use hardcoded credentials. The tool will extract these credentials for you.
    Alternatively, the attacker can wait till the OS installation begins and check
    the **C:\Windows\panther\unattend\unattend.xml** file for the set of domain credentials.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 要检查环境中是否支持PXE，可以使用一个叫做**PXEThief**[11]的工具。该工具会发送一个DHCP发现请求，搜索PXE服务器并获取PXE启动文件。如果PXE介质被加密，攻击者需要猜测或破解密码来进行解密。解密后，工具会解析文件中**任务序列**或存储在**集合变量**中的NAA账户和凭据。在OSD中，有一个任务序列功能。简而言之，这个功能是一个定义好的步骤列表，用于正确部署机器。其中一些步骤，如*任务序列域加入账户*，会使用域用户凭据。此外，任务序列步骤中的集合变量可能会使用硬编码凭据。该工具将为你提取这些凭据。或者，攻击者可以等到操作系统安装开始，然后检查**C:\Windows\panther\unattend\unattend.xml**文件，获取一组域凭据。
- en: A way to obtain NAA credentials was shown by *Raiona_ZA* during his DEFCON talk[12].
    If *F8-Debugging* is not disabled, an adversary can invoke the **SYSTEM** shell
    by repeatedly pressing *F8*, then run a Visual Basic Script to dump environment
    variables and search there for **_SMSTSReserved1** (username) and **_SMSTSReserved2**
    (password) values. These are your NAA credentials.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 一种获取NAA凭据的方法是由*Raiona_ZA*在DEFCON演讲中展示的[12]。如果*F8-调试*未被禁用，攻击者可以通过反复按*F8*调用**SYSTEM**
    shell，然后运行一个Visual Basic脚本来转储环境变量，并在其中搜索**_SMSTSReserved1**（用户名）和**_SMSTSReserved2**（密码）值。这些就是你的NAA凭据。
- en: 'Now, let us do some hands-on discovery and enumeration from the context of
    the compromised domain user. I will stick to the **SharpSCCM**[13] tool made by
    *Mayyhem* throughout this chapter. We can find the SCCM MP and site code in two
    different ways – PowerShell and WMI (**SharpSCCM** uses WMI):'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们从已被攻破的域用户的背景下进行一些实践性发现和枚举。在本章中，我将一直使用*Mayyhem*制作的**SharpSCCM**[13]工具。我们可以通过两种不同的方式找到SCCM
    MP和站点代码——PowerShell和WMI（**SharpSCCM**使用WMI）：
- en: '[PRE1]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'The result of the **SharpSCCM** command execution is as follows:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: '**SharpSCCM**命令执行结果如下：'
- en: '![Figure 10.4 – SharpSCCM shows the MP and site name](image/B18964_10_04.jpg)'
  id: totrans-73
  prefs: []
  type: TYPE_IMG
  zh: '![图10.4 – SharpSCCM显示MP和站点名称](image/B18964_10_04.jpg)'
- en: Figure 10.4 – SharpSCCM shows the MP and site name
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.4 – SharpSCCM显示MP和站点名称
- en: 'Also, the MP can be extracted from logs that are stored in **C:\Windows\CCM\Logs**
    on the machine. **SharpSCCM** has the following command:'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 另外，MP可以从存储在机器上**C:\Windows\CCM\Logs**的日志中提取。**SharpSCCM**有以下命令：
- en: '[PRE2]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Probably the last thing that an adversary can do locally without administrative
    privileges is to examine previously executed scripts only if PowerShell logging
    is enabled. This will allow the retrieval of script content from a Windows event.
    The following PowerShell command will go through events in Windows PowerShell
    logs and look for event ID **4104** (*PowerShell Script* *Block Logging*):'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 可能攻击者在没有管理员权限的情况下能做的最后一件事就是检查之前执行过的脚本，前提是启用了 PowerShell 日志记录。这样可以通过 Windows
    事件检索脚本内容。以下 PowerShell 命令会查阅 Windows PowerShell 日志中的事件，并寻找事件 ID **4104**（*PowerShell
    脚本* *块日志记录*）：
- en: '[PRE3]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'For example, we can see our preceding reconnaissance command:'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，我们可以看到之前的侦察命令：
- en: '![Figure 10.5 – Result of the PowerShell logging](image/B18964_10_05.jpg)'
  id: totrans-80
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.5 – PowerShell 日志记录的结果](image/B18964_10_05.jpg)'
- en: Figure 10.5 – Result of the PowerShell logging
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.5 – PowerShell 日志记录的结果
- en: Scripts executed from the primary site are stored on the client side in the
    **C:\Windows\CCM\ScriptStore** folder. But to read the content of the scripts
    in this folder, **SYSTEM** privileges are required.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 从主站点执行的脚本存储在客户端的 **C:\Windows\CCM\ScriptStore** 文件夹中。但要读取此文件夹中脚本的内容，必须具备 **SYSTEM**
    权限。
- en: Also, we can try to pull files from the **SCCMContentLib$** share on the DP.
    There is a tool called **CMLoot**[14] that will create a list of files on shares
    and download them.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，我们还可以尝试从 DP 上的 **SCCMContentLib$** 共享中拉取文件。有一个名为 **CMLoot**[14] 的工具，可以列出共享中的文件并下载它们。
- en: We will now move to the next section, which is about privilege escalation techniques.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将进入下一节，讨论特权提升技术。
- en: Privilege escalation
  id: totrans-85
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 特权提升
- en: This section will be focused on privilege escalation via credential harvesting
    and authentication coercion. For harvesting, we will need a local Administrator
    account.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 本节将重点讨论通过凭证收集和认证强制进行的特权提升。对于凭证收集，我们将需要一个本地管理员账户。
- en: Client push authentication coercion
  id: totrans-87
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 客户端推送认证强制
- en: As we did in previous chapters, here, we will split hash capture and relay phases
    as well. Our goal is to coerce client push installation account authentication
    against our controlled machine to capture the NTLM response.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 和之前章节中一样，这里我们也将哈希捕获和转发阶段分开。我们的目标是通过控制的机器强制进行客户端推送安装账户认证，从而捕获 NTLM 响应。
- en: Note
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Coercion attacks were presented by *Mayyhem* in his blog post at [https://posts.specterops.io/coercing-ntlm-authentication-from-sccm-e6e23ea8260a](https://posts.specterops.io/coercing-ntlm-authentication-from-sccm-e6e23ea8260a).
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 强制攻击由 *Mayyhem* 在他的博客文章中提出，地址为 [https://posts.specterops.io/coercing-ntlm-authentication-from-sccm-e6e23ea8260a](https://posts.specterops.io/coercing-ntlm-authentication-from-sccm-e6e23ea8260a)。
- en: The important fact is that the attack does not require administrative privileges;
    the captured client push installation account’s NTLM response will grant administrative
    access to all other machines where such an account has been used. The main prerequisites
    are automatic client assignment for a boundary group, automatic site-wide push
    installation, and allowed connection fallback to NTLM. Also, we need to make sure
    the **HTTPS Only** option for communication security is not enabled. We have enforced
    all these options during the configuration.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 重要的一点是，这种攻击不需要管理员权限；被捕获的客户端推送安装账户的 NTLM 响应将授予对所有使用过该账户的其他机器的管理员访问权限。主要的前提条件是边界组的自动客户端分配、站点范围内的自动推送安装以及允许回退到
    NTLM 连接。此外，我们需要确保通信安全的**仅限 HTTPS**选项未启用。在配置过程中，我们已强制启用了所有这些选项。
- en: 'The attacker sends a new device registration request to the MP followed by
    a heartbeat **Data Discovery Record** (**DDR**) saying that the client is not
    installed on the machine with a listener. The site server tries to install the
    client using the client push installation accounts and eventually its machine
    account. This attack is a part of **SharpSCCM** as well:'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击者向 MP 发送新的设备注册请求，随后发送一个心跳 **数据发现记录**（**DDR**），告知客户端尚未在带有监听器的机器上安装。站点服务器尝试使用客户端推送安装账户并最终使用其机器账户来安装客户端。此攻击也是
    **SharpSCCM** 的一部分：
- en: '[PRE4]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'On the client, the attack looks like the following screenshot:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 在客户端，攻击呈现如下截图：
- en: '![Figure 10.6 – Step-by-step successful coercion attack](image/B18964_10_06.jpg)'
  id: totrans-95
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.6 – 成功强制攻击的逐步过程](image/B18964_10_06.jpg)'
- en: Figure 10.6 – Step-by-step successful coercion attack
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.6 – 成功强制攻击的逐步过程
- en: 'On the controlled machine, we captured both NTLM responses for the client push
    installation account and the MP computer account:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 在被控制的机器上，我们捕获了客户端推送安装账户和 MP 计算机账户的 NTLM 响应：
- en: '![Figure 10.7 – Captured NTLM responses](image/B18964_10_07.jpg)'
  id: totrans-98
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.7 – 捕获的 NTLM 响应](image/B18964_10_07.jpg)'
- en: Figure 10.7 – Captured NTLM responses
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.7 – 捕获的 NTLM 响应
- en: 'The administrator will detect such an attack because the IP address of our
    controlled machine will appear in the console, as shown in the following screenshot:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 管理员将会检测到这样的攻击，因为我们控制的机器的 IP 地址将出现在控制台中，以下截图展示了这一点：
- en: '![Figure 10.8 – Captured machine IP address appears in the console](image/B18964_10_08.jpg)'
  id: totrans-101
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.8 – 控制台中显示捕获的机器 IP 地址](image/B18964_10_08.jpg)'
- en: Figure 10.8 – Captured machine IP address appears in the console
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.8 – 控制台中显示捕获的机器 IP 地址
- en: If we have administrative privileges on the MP, we can use the **--as-admin**
    option to perform cleanup for us.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们在 MP 上具有管理员权限，我们可以使用**--as-admin**选项来为我们执行清理操作。
- en: Credential harvesting
  id: totrans-104
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 凭证收集
- en: We will focus on three credential types here – device collection variables,
    task sequence variables, and NAA credentials.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将专注于三种凭证类型 – 设备集合变量、任务序列变量和 NAA 凭证。
- en: 'What is device collection? In simple words, it is a group of devices. There
    are some pre-defined groups, but we can also create our own. In the case of collection,
    we may add variables for specific purposes. Then, these variables can be used
    by task sequences. An adversary can extract them as well. First of all, let us
    add a collection variable. These are in **Assets and Compliance** | **Device Collections**
    | **Choose your collection** | **Properties**. The screenshot of my example is
    shown here:'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 什么是设备集合？简单来说，它就是一组设备。有一些预定义的组，但我们也可以创建自己的组。在集合的情况下，我们可以为特定目的添加变量。然后，这些变量可以被任务序列使用。攻击者也可以提取它们。首先，让我们添加一个集合变量。这些变量在
    **资产与合规性** | **设备集合** | **选择您的集合** | **属性** 中。我的示例截图如下所示：
- en: '![Figure 10.9 – Device collection variable](image/B18964_10_09.jpg)'
  id: totrans-107
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.9 – 设备集合变量](image/B18964_10_09.jpg)'
- en: Figure 10.9 – Device collection variable
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.9 – 设备集合变量
- en: 'We have discussed task sequences and NAA before. **SharpSCCM** can pull this
    information locally or remotely. Using WMI, the adversary queries blobs from different
    classes (**CCM_CollectionVariable**, **CCM_TaskSequence**, and **CCM_NetworkAccessAccount**)
    of the **root\ccm\policy\Machine\ActualConfig** WMI namespace. Another way is
    to extract blobs from the **Common Information Model** (**CIM**) store. To get
    clear-text credentials, local administrator privileges are required because NAA
    credentials are protected with a DPAPI master key. Lastly, the remote option will
    request a machine policy from the MP via HTTP and decrypt secrets:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 我们之前讨论过任务序列和 NAA。**SharpSCCM**可以本地或远程提取这些信息。通过 WMI，攻击者从 **root\ccm\policy\Machine\ActualConfig**
    WMI 命名空间中的不同类（**CCM_CollectionVariable**、**CCM_TaskSequence** 和 **CCM_NetworkAccessAccount**）查询
    Blob。另一种方法是从 **公共信息模型**（**CIM**）存储中提取 Blob。为了获取明文凭证，需要本地管理员权限，因为 NAA 凭证是通过 DPAPI
    主密钥进行保护的。最后，远程选项将通过 HTTP 请求从 MP 获取机器策略并解密机密：
- en: '[PRE5]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'The result of the last command execution is in the following screenshot:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 上一个命令执行的结果如下截图所示：
- en: '![Figure 10.10 – Credential harvesting](image/B18964_10_10.jpg)'
  id: totrans-112
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.10 – 凭证收集](image/B18964_10_10.jpg)'
- en: Figure 10.10 – Credential harvesting
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.10 – 凭证收集
- en: Note
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Another way to obtain NAA depending on the **Machine Account Quota** (**MAQ**)
    value was shown by *http418* in his blog post at – [https://http418infosec.com/offensive-sccm-summary#Credential_Access_%E2%80%93_NAA](https://http418infosec.com/offensive-sccm-summary#Credential_Access_%E2%80%93_NAA).
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 另一种获取 NAA 的方法，取决于 **机器账户配额**（**MAQ**）值，在 *http418* 的博客文章中展示过，链接如下 – [https://http418infosec.com/offensive-sccm-summary#Credential_Access_%E2%80%93_NAA](https://http418infosec.com/offensive-sccm-summary#Credential_Access_%E2%80%93_NAA)。
- en: In our next section, we will focus on ways to perform lateral movement based
    only on SCCM infrastructure.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 在接下来的部分，我们将专注于仅基于 SCCM 基础设施执行横向渗透的方法。
- en: Lateral movement
  id: totrans-117
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 横向渗透
- en: SCCM by design is an excellent software for lateral movement. Agents are installed
    throughout the environment; highly privileged accounts are used to perform administrative
    tasks. Also, it is a good opportunity to blend in legitimate traffic and activities.
    We will start our discussion about lateral movement by extending coercion authentication
    to relay attacks.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: SCCM 设计上是一个非常适合横向渗透的软件。代理被安装在整个环境中；高权限账户用于执行管理任务。此外，它是融合合法流量和活动的好机会。我们将从将强制认证扩展到中继攻击开始讨论横向渗透。
- en: Client push authentication relay attack
  id: totrans-119
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 客户端推送认证中继攻击
- en: 'This attack is very similar to the one we did in the *Privilege escalation*
    section previously. The only difference is that this time, we would like to relay
    the captured NTLM response to another machine. (Just a reminder: the relay requires
    signing to be disabled). On the client side, the attack is exactly the same. On
    our listening machine, we start **ntlmrelayx**:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 该攻击与我们在*权限提升*部分进行的攻击非常相似。唯一的区别是这次我们想将捕获的 NTLM 响应中继到另一台机器上。（温馨提示：中继要求禁用签名）。在客户端，这个攻击过程完全相同。在我们的监听机器上，我们启动**ntlmrelayx**：
- en: '[PRE6]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'After enforcing the client push installation, we relayed it to the Exchange
    server and dumped SAM hashes, as shown in the following screenshot:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 在强制客户端推送安装后，我们将其中继到 Exchange 服务器并转储 SAM 哈希值，如下图所示：
- en: '![Figure 10.11 – Successful NTLM relay attack](image/B18964_10_11.jpg)'
  id: totrans-123
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.11 – 成功的 NTLM 中继攻击](image/B18964_10_11.jpg)'
- en: Figure 10.11 – Successful NTLM relay attack
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.11 – 成功的 NTLM 中继攻击
- en: If the client push installation account has not been defined, then by default,
    the SCCM server’s machine account will be used to push clients. Obviously, this
    computer account has to be in the local **Administrators** group for every computer.
    In this scenario, the attack will be the same as previously; the only difference
    is the account that will be used for the relay.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 如果未定义客户端推送安装账户，则默认情况下，SCCM 服务器的计算机账户将用于推送客户端。显然，这个计算机账户必须是每台计算机的本地 **Administrators**
    组的成员。在这种情况下，攻击过程将与之前相同，唯一的区别是将用于中继的账户。
- en: Site takeover
  id: totrans-126
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 站点接管
- en: There are two site takeover techniques. Unfortunately, we will not be able to
    replicate them in our lab because SQL Server and the SMS provider role are installed
    on the primary site server.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 有两种站点接管技术。遗憾的是，由于 SQL Server 和 SMS 提供程序角色已安装在主站点服务器上，我们无法在实验室中复制这些技术。
- en: The first technique is based on the fact that the computer account of the primary
    site server should be in a local **Administrators** group for SQL Server and MP
    servers. Then, an adversary coerces NTLM authentication from the primary site
    server and relays it to SQL Server. Next, it is possible to grant a **Full Administrator**
    SCCM role using SQL queries; the **sccmhunter**[15] tool can also do this for
    you.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 第一种技术基于主站点服务器的计算机账户应在 SQL Server 和 MP 服务器的本地 **Administrators** 组中的事实。然后，攻击者强制从主站点服务器进行
    NTLM 认证，并将其中继到 SQL Server。接下来，可以使用 SQL 查询授予 **完全管理员** SCCM 角色；**sccmhunter**[15]
    工具也可以为你完成这项工作。
- en: Note
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'This technique is well-described in the *SCCM Site Takeover via Automatic Client
    Push Installation* blog post by *Mayyhem*: [https://posts.specterops.io/sccm-site-takeover-via-automatic-client-push-installation-f567ec80d5b1](https://posts.specterops.io/sccm-site-takeover-via-automatic-client-push-installation-f567ec80d5b1).'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 该技术在 *Mayyhem* 的博文 *SCCM 站点通过自动客户端推送安装接管* 中有很好的描述：[https://posts.specterops.io/sccm-site-takeover-via-automatic-client-push-installation-f567ec80d5b1](https://posts.specterops.io/sccm-site-takeover-via-automatic-client-push-installation-f567ec80d5b1)。
- en: The second technique leverages the **AdminService** API for SCCM site takeover.
    This API is hosted by an SMS provider. Each provider has a local group called
    **SMS Admins**. By default, the primary site server computer account is a member
    of this group. Now, the takeover attack will be the same as the preceding one.
    Coerce authentication via any method you like, capture and relay the primary site
    computer account NTLM response to the **AdminService** API hosted on the SMS provider,
    and add a user as **Full Administrator**.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 第二种技术利用 **AdminService** API 来接管 SCCM 站点。该 API 由 SMS 提供程序托管。每个提供程序都有一个本地组，名为
    **SMS Admins**。默认情况下，主站点服务器计算机账户是该组的成员。现在，接管攻击将与之前的攻击相同。通过任何你喜欢的方式强制认证，捕获并将主站点计算机账户的
    NTLM 响应中继到托管在 SMS 提供程序上的 **AdminService** API，并将一个用户添加为 **完全管理员**。
- en: Note
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'The original research by *Garrett Foster* can be found here: [https://posts.specterops.io/site-takeover-via-sccms-adminservice-api-d932e22b2bf](https://posts.specterops.io/site-takeover-via-sccms-adminservice-api-d932e22b2bf).'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: '*Garrett Foster* 的原始研究可以在这里找到：[https://posts.specterops.io/site-takeover-via-sccms-adminservice-api-d932e22b2bf](https://posts.specterops.io/site-takeover-via-sccms-adminservice-api-d932e22b2bf)。'
- en: Both techniques work after default installation and require only network connectivity
    and standard user credentials.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 这两种技术在默认安装后均可工作，仅需要网络连接和标准用户凭据。
- en: Abuse of Microsoft SQL Server
  id: totrans-135
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 滥用 Microsoft SQL Server
- en: 'After the site takeover, or if an adversary obtained access to the Microsoft
    SQL Server that is used by the primary site, new venues are opened. First of all,
    it is possible to decrypt SCCM users’ credentials that are stored in the **SC_UserAccount**
    table. In our case, I will run the query using the SQL Server Management Studio.
    The query is shown here:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 在站点接管后，或者如果攻击者获得了主站点使用的Microsoft SQL Server的访问权限，将会打开新的途径。首先，可以解密存储在**SC_UserAccount**表中的SCCM用户凭据。在我们的案例中，我将使用SQL
    Server Management Studio运行查询。查询如下所示：
- en: '[PRE7]'
  id: totrans-137
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Then, I will utilize the **SCCMDecryptPoc**[16] tool by *XPN*. The result of
    the decryption is shown here:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我将使用**SCCMDecryptPoc**[16]工具，由*XPN*开发。解密结果如下所示：
- en: '![Figure 10.12 – Decrypted password of the sccm_cli_push account](image/B18964_10_12.jpg)'
  id: totrans-139
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.12 – sccm_cli_push帐户的解密密码](image/B18964_10_12.jpg)'
- en: Figure 10.12 – Decrypted password of the sccm_cli_push account
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.12 – sccm_cli_push帐户的解密密码
- en: Another information-gathering activity is to dump tables related to task sequences
    and look for credentials. The output will be obfuscated, but the **DeObfuscateSecretString**
    tool in the **SharpSCCM** repository by *Mayyhem* will be able to help.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个信息收集活动是转储与任务序列相关的表格，并查找凭据。输出将被混淆，但**SharpSCCM**库中由*Mayyhem*开发的**DeObfuscateSecretString**工具将能够提供帮助。
- en: 'Lastly, there is a stored procedure called **sp_CP_GenerateCCRByName** that
    can be used to force client push installation and the MP machine account to authenticate
    to the **ADMIN$** share on the machine of our choice. The code is as follows:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，有一个名为**sp_CP_GenerateCCRByName**的存储过程，可以用来强制客户端推送安装，并使MP机器帐户对我们选择的机器上的**ADMIN$**共享进行身份验证。代码如下：
- en: '[PRE8]'
  id: totrans-143
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'The result is a forced authentication attempt, as you can see here:'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 结果是强制身份验证尝试，如下所示：
- en: '![Figure 10.13 – Forced authentication as a result of stored procedure execution](image/B18964_10_13.jpg)'
  id: totrans-145
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.13 – 存储过程执行导致的强制身份验证](image/B18964_10_13.jpg)'
- en: Figure 10.13 – Forced authentication as a result of stored procedure execution
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.13 – 存储过程执行导致的强制身份验证
- en: Realistically, these post-exploitation actions are not required, as all of these
    actions were shown in earlier stages. The idea was to emphasize the fact that
    the primary site SQL Server also needs to be well hardened and maintained.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 实际上，这些后期利用行为并非必须执行，因为所有这些行为在早期阶段都已展示过。目的是强调主站点的SQL Server也需要进行良好的加固和维护。
- en: Deploying an application
  id: totrans-148
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 部署应用程序
- en: This is the last scenario for lateral movement. It can also be treated as a
    persistence technique. A common scenario is to deploy malicious applications throughout
    the environment or on specific targets. However, we will try another scenario.
    The application installation from the controlled UNC path is triggered, so we
    can capture the domain administrator NTLM response.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 这是横向移动的最后一个场景。它也可以作为持久性技术来处理。一个常见场景是将恶意应用程序部署到整个环境或特定目标上。然而，我们将尝试另一个场景。从受控的UNC路径触发应用程序安装，因此我们可以捕获域管理员的NTLM响应。
- en: Note
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'The original research by *Mayyhem* can be found here: [https://posts.specterops.io/relaying-ntlm-authentication-from-sccm-clients-7dccb8f92867](https://posts.specterops.io/relaying-ntlm-authentication-from-sccm-clients-7dccb8f92867).'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: '*Mayyhem*的原创研究可以在这里找到：[https://posts.specterops.io/relaying-ntlm-authentication-from-sccm-clients-7dccb8f92867](https://posts.specterops.io/relaying-ntlm-authentication-from-sccm-clients-7dccb8f92867)。'
- en: 'I will grant the **vinegrep** user **Full Administrator** rights; however,
    just **Application Administrator** should be enough. New permissions can be verified
    by running the following command:'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 我将授予**vinegrep**用户**完全管理员**权限；然而，**应用管理员**权限应该足够了。可以通过运行以下命令验证新权限：
- en: '[PRE9]'
  id: totrans-153
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'The result of the command execution is next:'
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 命令执行的结果如下：
- en: '![Figure 10.14 – New permissions were applied](image/B18964_10_14.jpg)'
  id: totrans-155
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.14 – 新权限已应用](image/B18964_10_14.jpg)'
- en: Figure 10.14 – New permissions were applied
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.14 – 新权限已应用
- en: 'Our plan is to find an active device with a client installed where the primary
    user is **Administrator**. We will extract the resource ID for the next step.
    The following commands will provide the required information:'
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的计划是找到一个已安装客户端且主用户为**Administrator**的活动设备。我们将提取资源ID以进行下一步。以下命令将提供所需的信息：
- en: '[PRE10]'
  id: totrans-158
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'The result of the commands’ execution is in the following screenshot:'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 命令执行结果如下截图所示：
- en: '![Figure 10.15 – The WIN10 machine is our target device](image/B18964_10_15.jpg)'
  id: totrans-160
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.15 – WIN10机器是我们的目标设备](image/B18964_10_15.jpg)'
- en: Figure 10.15 – The WIN10 machine is our target device
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.15 – WIN10机器是我们的目标设备
- en: 'The attack consists of the following steps:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击包括以下步骤：
- en: Create a new device collection.
  id: totrans-163
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个新的设备集合。
- en: Add a target machine to this collection.
  id: totrans-164
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将目标机器添加到此集合中。
- en: Create an application with a UNC path to the attacker’s machine.
  id: totrans-165
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个带有UNC路径指向攻击者机器的应用程序。
- en: Task the target device from the collection to install the new application.
  id: totrans-166
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让该集合中的目标设备安装新应用程序。
- en: 'The following command will automate the preceding steps:'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 以下命令将自动执行上述步骤：
- en: '[PRE11]'
  id: totrans-168
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'The attack execution is as follows:'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击执行过程如下：
- en: '![Figure 10.16 – Successful attack execution](image/B18964_10_16.jpg)'
  id: totrans-170
  prefs: []
  type: TYPE_IMG
  zh: '![图10.16 – 成功的攻击执行](image/B18964_10_16.jpg)'
- en: Figure 10.16 – Successful attack execution
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.16 – 成功的攻击执行
- en: 'After some time, we captured the NTLM response, as shown in the following screenshot:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 经过一段时间，我们捕获了NTLM响应，如下图所示：
- en: '![Figure 10.17 – Successful relay to Exchange server](image/B18964_10_17.jpg)'
  id: totrans-173
  prefs: []
  type: TYPE_IMG
  zh: '![图10.17 – 成功的中继到Exchange服务器](image/B18964_10_17.jpg)'
- en: Figure 10.17 – Successful relay to Exchange server
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.17 – 成功的中继到Exchange服务器
- en: This attack may also be used against a lot of users. If required, the computer
    account can also be forced to authenticate with the **--run-as-system** flag.
    The last section will explain defensive recommendations.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 此攻击也可以针对多个用户进行。如果需要，计算机帐户还可以强制使用**--run-as-system**标志进行身份验证。最后一节将解释防御性建议。
- en: Defensive recommendations
  id: totrans-176
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 防御性建议
- en: 'Defensive recommendations are a part of the great **SharpSCCM** wiki. Here,
    we will cover the ones that are most effective but also easy to implement. I will
    not repeat things such as install updates, ensure that privileged accounts use
    strong passwords, audit activities, enforce signing if possible, and so on. Let’s
    look at some defensive recommendations:'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 防御性建议是**SharpSCCM**维基的一部分。在这里，我们将介绍最有效且易于实施的建议。我不会重复诸如安装更新、确保特权帐户使用强密码、审核活动、尽可能强制签名等内容。让我们来看一些防御性建议：
- en: To prevent coercion, NTLM fallback should be disabled
  id: totrans-178
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为防止强制攻击，应禁用NTLM回退
- en: Disable NAAs in the domain and use enhanced HTTP instead
  id: totrans-179
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在域中禁用NAAs，并改用增强HTTP
- en: Use the **Software Update** functionality to install clients instead of Automatic
    site-wide client push installation
  id: totrans-180
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用**软件更新**功能安装客户端，而不是自动站点范围客户端推送安装
- en: Clean task sequences and device collection variables from sensitive data
  id: totrans-181
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 清理任务序列和设备集合变量中的敏感数据
- en: For PXE, set a strong password for media and disable **F8 Debugging**
  id: totrans-182
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于PXE，设置媒体的强密码并禁用**F8调试**
- en: Check service accounts to ensure the least privileges principle is applied
  id: totrans-183
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 检查服务帐户，以确保应用最小特权原则
- en: Do not run the web client service to avoid HTTP coercion
  id: totrans-184
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 不要运行Web客户端服务，以避免HTTP强制攻击
- en: Enable multi-factor authentication for SMS provider calls[17]
  id: totrans-185
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 启用SMS提供商调用的多因素认证[17]
- en: Require **Extended Protection for Authentication** (**EPA**) on the site database
    to avoid relays to MS SQL Server
  id: totrans-186
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要求站点数据库启用**身份验证扩展保护**（**EPA**），以避免中继到MS SQL Server
- en: The first three recommendations will significantly decrease your risk of being
    compromised. There is also a guide on how to use SCCM as a hunting tool for malicious
    activity[18].
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 前三条建议将显著降低您被攻击的风险。此外，还有一份关于如何使用SCCM作为恶意活动狩猎工具的指南[18]。
- en: Summary
  id: totrans-188
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: This chapter covered techniques and attacks on IT administration software. We
    have briefly discussed ways to compromise WSUS and the available tooling for such
    adversary activity. Furthermore, we had a deep dive into the SCCM ecosystem and
    saw in practice how misconfiguration can lead to the complete overtake of the
    environment. Later, in the *Defensive recommendations* section, I stressed the
    three most important recommendations to improve the SCCM security posture.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 本章介绍了针对IT管理软件的技术和攻击。我们简要讨论了如何危害WSUS以及进行此类敌对活动的工具。此外，我们深入探讨了SCCM生态系统，并实际展示了配置错误如何导致环境的完全接管。稍后，在*防御性建议*部分，我强调了三条最重要的建议，用以改善SCCM的安全态势。
- en: Overall, this entire book should demonstrate how complex Windows-based infrastructure
    is, and how many hidden parts it has. Clearly, new vulnerabilities and attack
    vectors will appear regularly, but there are enough security mechanisms to make
    the life of an adversary much harder.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 总体而言，本书旨在展示基于Windows的基础设施有多复杂，以及它包含了多少隐藏的部分。显然，新的漏洞和攻击向量将定期出现，但也有足够的安全机制使敌对者的攻击变得更加困难。
- en: References
  id: totrans-191
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 参考文献
- en: '**PyWSUS**: [https://github.com/GoSecure/pywsus](https://github.com/GoSecure/pywsus)'
  id: totrans-192
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**PyWSUS**：[https://github.com/GoSecure/pywsus](https://github.com/GoSecure/pywsus)'
- en: '**bettercap**: [https://github.com/bettercap/bettercap](https://github.com/bettercap/bettercap)'
  id: totrans-193
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**bettercap**：[https://github.com/bettercap/bettercap](https://github.com/bettercap/bettercap)'
- en: 'WSUS Attacks: [https://www.gosecure.net/blog/2020/09/03/wsus-attacks-part-1-introducing-pywsus/](https://www.gosecure.net/blog/2020/09/03/wsus-attacks-part-1-introducing-pywsus/)'
  id: totrans-194
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: WSUS 攻击：[https://www.gosecure.net/blog/2020/09/03/wsus-attacks-part-1-introducing-pywsus/](https://www.gosecure.net/blog/2020/09/03/wsus-attacks-part-1-introducing-pywsus/)
- en: '**WSuspicious**: [https://github.com/GoSecure/WSuspicious](https://github.com/GoSecure/WSuspicious)'
  id: totrans-195
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**WSuspicious**：[https://github.com/GoSecure/WSuspicious](https://github.com/GoSecure/WSuspicious)'
- en: 'Deploy WSUS: [https://learn.microsoft.com/en-us/windows-server/administration/windows-server-update-services/deploy/deploy-windows-server-update-services](https://learn.microsoft.com/en-us/windows-server/administration/windows-server-update-services/deploy/deploy-windows-server-update-services)'
  id: totrans-196
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 部署 WSUS：[https://learn.microsoft.com/en-us/windows-server/administration/windows-server-update-services/deploy/deploy-windows-server-update-services](https://learn.microsoft.com/en-us/windows-server/administration/windows-server-update-services/deploy/deploy-windows-server-update-services)
- en: 'WSUS Group Policy Settings to Deploy Updates: [https://woshub.com/group-policy-settings-to-deploy-updates-using-wsus/](https://woshub.com/group-policy-settings-to-deploy-updates-using-wsus/)'
  id: totrans-197
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 WSUS 部署更新的组策略设置：[https://woshub.com/group-policy-settings-to-deploy-updates-using-wsus/](https://woshub.com/group-policy-settings-to-deploy-updates-using-wsus/)
- en: '**SharpWSUS**: [https://github.com/nettitude/SharpWSUS](https://github.com/nettitude/SharpWSUS)'
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**SharpWSUS**：[https://github.com/nettitude/SharpWSUS](https://github.com/nettitude/SharpWSUS)'
- en: '**WSUSpendu**: [https://github.com/alex-dengx/WSUSpendu](https://github.com/alex-dengx/WSUSpendu)'
  id: totrans-199
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**WSUSpendu**：[https://github.com/alex-dengx/WSUSpendu](https://github.com/alex-dengx/WSUSpendu)'
- en: '**PSExec**: [https://learn.microsoft.com/en-us/sysinternals/downloads/psexec](https://learn.microsoft.com/en-us/sysinternals/downloads/psexec)'
  id: totrans-200
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**PSExec**：[https://learn.microsoft.com/en-us/sysinternals/downloads/psexec](https://learn.microsoft.com/en-us/sysinternals/downloads/psexec)'
- en: '*The Hacker Recipes* website: [https://www.thehacker.recipes/ad/movement/sccm-mecm](https://www.thehacker.recipes/ad/movement/sccm-mecm)'
  id: totrans-201
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '*黑客食谱* 网站：[https://www.thehacker.recipes/ad/movement/sccm-mecm](https://www.thehacker.recipes/ad/movement/sccm-mecm)'
- en: '**PXEThief**: [https://github.com/MWR-CyberSec/PXEThief](https://github.com/MWR-CyberSec/PXEThief)'
  id: totrans-202
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**PXEThief**：[https://github.com/MWR-CyberSec/PXEThief](https://github.com/MWR-CyberSec/PXEThief)'
- en: 'Christopher Panayi, *Pulling Passwords out of Configuration* *Manager*: [https://media.defcon.org/DEF%20CON%2030/DEF%20CON%2030%20presentations/Christopher%20Panayi%20-%20Pulling%20Passwords%20out%20of%20Configuration%20Manager%20Practical%20Attacks%20against%20Microsofts%20Endpoint%20Management%20Software.pdf](https://media.defcon.org/DEF%20CON%2030/DEF%20CON%2030%20presentations/Christopher%20Panayi%20-%20Pulling%20Passwords%20out%20of%20Configuration%20Manager%20Practical%20Attacks%20against%20Microsofts%20Endpoint%20Management%20Software.pdf)'
  id: totrans-203
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: Christopher Panayi，*从配置管理器中提取密码*：[https://media.defcon.org/DEF%20CON%2030/DEF%20CON%2030%20presentations/Christopher%20Panayi%20-%20Pulling%20Passwords%20out%20of%20Configuration%20Manager%20Practical%20Attacks%20against%20Microsofts%20Endpoint%20Management%20Software.pdf](https://media.defcon.org/DEF%20CON%2030/DEF%20CON%2030%20presentations/Christopher%20Panayi%20-%20Pulling%20Passwords%20out%20of%20Configuration%20Manager%20Practical%20Attacks%20against%20Microsofts%20Endpoint%20Management%20Software.pdf)
- en: '**SharpSCCM**: [https://github.com/Mayyhem/SharpSCCM/](https://github.com/Mayyhem/SharpSCCM/)'
  id: totrans-204
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**SharpSCCM**：[https://github.com/Mayyhem/SharpSCCM/](https://github.com/Mayyhem/SharpSCCM/)'
- en: '**CMLoot**: [https://github.com/1njected/CMLoot](https://github.com/1njected/CMLoot)'
  id: totrans-205
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**CMLoot**：[https://github.com/1njected/CMLoot](https://github.com/1njected/CMLoot)'
- en: 'The **sccmhunter** tool: [https://github.com/garrettfoster13/sccmhunter#mssql](https://github.com/garrettfoster13/sccmhunter#mssql)'
  id: totrans-206
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**sccmhunter** 工具：[https://github.com/garrettfoster13/sccmhunter#mssql](https://github.com/garrettfoster13/sccmhunter#mssql)'
- en: 'The **sccmdecryptpoc** tool: [https://gist.github.com/xpn/5f497d2725a041922     c427c3aaa3b37d1](https://gist.github.com/xpn/5f497d2725a041922c427c3aaa3b37d1)'
  id: totrans-207
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**sccmdecryptpoc** 工具：[https://gist.github.com/xpn/5f497d2725a041922c427c3aaa3b37d1](https://gist.github.com/xpn/5f497d2725a041922c427c3aaa3b37d1)'
- en: 'Enable MFA for SMS Provider calls: [https://learn.microsoft.com/en-us/troubleshoot/mem/configmgr/setup-migrate-backup-recovery/enable-mfa-for-sms-provider-calls](https://learn.microsoft.com/en-us/troubleshoot/mem/configmgr/setup-migrate-backup-recovery/enable-mfa-for-sms-provider-calls)'
  id: totrans-208
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启用 MFA 以供 SMS 提供程序调用：[https://learn.microsoft.com/en-us/troubleshoot/mem/configmgr/setup-migrate-backup-recovery/enable-mfa-for-sms-provider-calls](https://learn.microsoft.com/en-us/troubleshoot/mem/configmgr/setup-migrate-backup-recovery/enable-mfa-for-sms-provider-calls)
- en: 'SCCM for DFIR: [https://informationonsecurity.blogspot.com/2015/11/microsofts-accidental-enterprise-dfir.xhtml](https://informationonsecurity.blogspot.com/2015/11/microsofts-accidental-enterprise-dfir.xhtml)'
  id: totrans-209
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: SCCM for DFIR：[https://informationonsecurity.blogspot.com/2015/11/microsofts-accidental-enterprise-dfir.xhtml](https://informationonsecurity.blogspot.com/2015/11/microsofts-accidental-enterprise-dfir.xhtml)
- en: Further reading
  id: totrans-210
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 进一步阅读
- en: 'These aids for further study will let you dive deeper into the attacks covered
    in the chapter:'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 以下进一步学习的资源将帮助你更深入地了解本章涉及的攻击：
- en: 'Gabriel Prud’homme, *SCCM Exploitation: The First Cred Is the Deepest* *II*:
    [https://www.youtube.com/watch?v=W9PC9erm_pI](https://www.youtube.com/watch?v=W9PC9erm_pI)'
  id: totrans-212
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'Gabriel Prud’homme，*SCCM Exploitation: The First Cred Is the Deepest* *II*：[https://www.youtube.com/watch?v=W9PC9erm_pI](https://www.youtube.com/watch?v=W9PC9erm_pI)'
- en: 'Chris Thompson, *SharpSCCM Demos at 2023 Black Hat USA* *Arsenal*: [https://www.youtube.com/watch?v=uyI5rgR0D-s](https://www.youtube.com/watch?v=uyI5rgR0D-s)'
  id: totrans-213
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Chris Thompson，*SharpSCCM Demos at 2023 Black Hat USA* *Arsenal*：[https://www.youtube.com/watch?v=uyI5rgR0D-s](https://www.youtube.com/watch?v=uyI5rgR0D-s)
- en: 'Christopher Panayi, *Identifying and retrieving credentials from SCCM/MECM
    Task* *Sequences*: [https://www.mwrcybersec.com/research_items/identifying-and-retrieving-credentials-from-sccm-mecm-task-sequences](https://www.mwrcybersec.com/research_items/identifying-and-retrieving-credentials-from-sccm-mecm-task-sequences)'
  id: totrans-214
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Christopher Panayi，*Identifying and retrieving credentials from SCCM/MECM Task*
    *Sequences*：[https://www.mwrcybersec.com/research_items/identifying-and-retrieving-credentials-from-sccm-mecm-task-sequences](https://www.mwrcybersec.com/research_items/identifying-and-retrieving-credentials-from-sccm-mecm-task-sequences)
- en: 'HTTP418InfoSec, *Offensive SCCM* *Summary*: [https://http418infosec.com/offensive-sccm-summary](https://http418infosec.com/offensive-sccm-summary)'
  id: totrans-215
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: HTTP418InfoSec，*Offensive SCCM* *Summary*：[https://http418infosec.com/offensive-sccm-summary](https://http418infosec.com/offensive-sccm-summary)
