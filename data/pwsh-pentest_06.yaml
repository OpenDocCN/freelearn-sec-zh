- en: '6'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '6'
- en: SMB, Active Directory, LDAP and Kerberos
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: SMB、活动目录、LDAP 和 Kerberos
- en: In this chapter, we will explore how PowerShell can be used as part of a comprehensive
    penetration test on **Server Message Block** (**SMB**), **Active Directory** (**AD**),
    and **Lightweight Directory Access Protocol** (**LDAP**). We will delve into the
    powerful capabilities of PowerShell to conduct thorough security assessments and
    identify potential vulnerabilities in these critical components of enterprise
    networks.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将探讨如何使用 PowerShell 作为全面渗透测试的一部分，测试**服务器消息块**（**SMB**）、**活动目录**（**AD**）和**轻量级目录访问协议**（**LDAP**）。我们将深入研究
    PowerShell 在进行彻底的安全评估和识别这些企业网络关键组件潜在漏洞方面的强大能力。
- en: PowerShell, as a scripting language developed by Microsoft, offers a wide array
    of tools and cmdlets that can be harnessed by security professionals and penetration
    testers to assess the security posture of SMB shares, user accounts, group memberships,
    and directory services. Through a series of worked examples, we will illustrate
    how PowerShell can be leveraged to enumerate, profile, and exploit weaknesses
    in these systems.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 作为 Microsoft 开发的脚本语言，PowerShell 提供了广泛的工具和 cmdlet，安全专家和渗透测试人员可以利用这些工具评估 SMB 共享、用户账户、组成员资格和目录服务的安全状况。通过一系列实际示例，我们将展示如何使用
    PowerShell 来枚举、分析并利用这些系统中的弱点。
- en: Our journey begins with SMB, where we will demonstrate how PowerShell can be
    used to assess SMB versioning, enumerate shared resources, and test for weak passwords.
    We will then transition to Active Directory, where we will showcase PowerShell’s
    capabilities in auditing user account security, identifying inactive accounts,
    and evaluating group memberships.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的旅程从 SMB 开始，在这里我们将展示如何使用 PowerShell 来评估 SMB 版本、枚举共享资源以及测试弱密码。接着，我们将转向活动目录，展示
    PowerShell 在审核用户账户安全、识别不活跃账户和评估组成员资格方面的能力。
- en: Moving on to LDAP, we will explore how PowerShell can be employed to assess
    LDAP permissions, test authentication, and monitor LDAP traffic. Each step of
    our exploration will be accompanied by practical examples, empowering you to apply
    these techniques effectively in your own security assessments.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将转向 LDAP，探讨如何利用 PowerShell 来评估 LDAP 权限、测试认证以及监控 LDAP 流量。我们将通过实际示例伴随每一步的探索，帮助您有效地在自己的安全评估中应用这些技术。
- en: By the end of this chapter, you will have a comprehensive understanding of how
    PowerShell can be an invaluable tool in the arsenal of penetration testers and
    security professionals. It will equip you with the knowledge and skills to proactively
    identify vulnerabilities, assess security configurations, and ultimately, enhance
    the resilience of SMB, AD, and LDAP implementations within your organizations.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 到本章结束时，您将全面了解 PowerShell 如何成为渗透测试人员和安全专家工具库中一项无价的工具。它将使您具备识别漏洞、评估安全配置并最终增强 SMB、AD
    和 LDAP 实施的韧性的知识和技能。
- en: 'The following are the main topics we will cover in this chapter:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是我们将在本章中涵盖的主要内容：
- en: PowerShell and SMB
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: PowerShell 和 SMB
- en: PowerShell, AD, and LDAP
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: PowerShell、AD 和 LDAP
- en: PowerShell and Kerberos
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: PowerShell 和 Kerberos
- en: PowerShell and SMB
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: PowerShell 和 SMB
- en: PowerShell can be effectively employed to perform security tests against network
    services such as the SMB protocol, which is commonly used for file sharing and
    resource access in Windows environments. In this section, we’ll explore how PowerShell
    can be used to conduct a security test against SMB, identify vulnerabilities,
    and bolster network defenses.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可有效用于对网络服务进行安全测试，例如 SMB 协议，该协议通常用于 Windows 环境中的文件共享和资源访问。在本节中，我们将探讨如何使用
    PowerShell 对 SMB 进行安全测试，识别漏洞，并加强网络防御。
- en: The SMB protocol is a critical component of Windows-based networks, facilitating
    file and printer sharing, as well as access to various resources. While SMB is
    vital for seamless data exchange, it can also present security risks if not adequately
    configured. These risks include unauthorized access, data leakage, and susceptibility
    to ransomware attacks. To ensure the robust security of your network, it’s essential
    to conduct thorough security testing of SMB implementations.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: SMB 协议是基于 Windows 网络的关键组成部分，支持文件和打印共享以及各种资源的访问。尽管 SMB 对无缝的数据交换至关重要，但如果配置不当，它也可能带来安全风险。这些风险包括未经授权的访问、数据泄露和勒索病毒攻击的易感性。为了确保网络的强大安全性，进行全面的
    SMB 安全测试至关重要。
- en: Enumerating SMB shares
  id: totrans-14
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 枚举 SMB 共享
- en: 'A fundamental aspect of SMB security testing is discovering shared resources
    on a remote server. PowerShell provides cmdlets such as **Get-SmbShare** that
    allow you to enumerate SMB shares:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: SMB 安全测试的一个基本方面是发现远程服务器上的共享资源。PowerShell 提供了诸如**Get-SmbShare**的 cmdlet，允许你列举
    SMB 共享：
- en: '[PRE0]'
  id: totrans-16
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This command lists all the available shares on a remote server, providing information
    about share names, paths, and access permissions. Security testers can use this
    information to assess share permissions, identify misconfigurations, and determine
    which shares may be vulnerable.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令列出远程服务器上所有可用的共享，提供共享名称、路径和访问权限的信息。安全测试人员可以利用这些信息评估共享权限，识别配置错误，并确定哪些共享可能存在漏洞。
- en: An SMB version assessment
  id: totrans-18
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: SMB 版本评估
- en: 'To identify potential vulnerabilities related to outdated or insecure SMB versions,
    PowerShell can be used to check the SMB version running on a remote system. The
    **Get-SmbConnection** cmdlet reveals details about SMB connections, including
    the dialect version:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 为了识别与过时或不安全的 SMB 版本相关的潜在漏洞，PowerShell 可以用来检查远程系统上运行的 SMB 版本。**Get-SmbConnection**
    cmdlet 显示有关 SMB 连接的详细信息，包括方言版本：
- en: '[PRE1]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: This command provides insights into the SMB version in use, helping you evaluate
    whether your network is running secure and up-to-date versions of SMB.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令提供有关正在使用的 SMB 版本的见解，帮助你评估你的网络是否运行安全且最新的 SMB 版本。
- en: Testing for weak passwords
  id: totrans-22
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 测试弱密码
- en: 'Weak or default passwords can be a significant security risk in SMB environments.
    PowerShell can be employed to perform password audits by attempting to connect
    to SMB shares using a list of commonly used or known weak passwords. The following
    script automates this process:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 弱密码或默认密码可能在 SMB 环境中构成重大安全风险。可以使用 PowerShell 执行密码审计，尝试使用常见的或已知的弱密码列表连接到 SMB 共享。以下脚本自动化此过程：
- en: '[PRE2]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: This script attempts to connect to each computer in the list using a set of
    passwords and logs any failed attempts, helping you identify weak or unchanged
    default credentials.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本尝试使用一组密码连接列表中的每台计算机，并记录任何失败的尝试，帮助你识别弱密码或未更改的默认凭据。
- en: SMB vulnerability scanning
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: SMB 漏洞扫描
- en: 'PowerShell can be leveraged to perform SMB vulnerability scanning using third-party
    modules or scripts. Tools such as **Invoke-SMBScanner** can be integrated into
    PowerShell to identify SMB vulnerabilities on target systems:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可以通过第三方模块或脚本执行 SMB 漏洞扫描。像**Invoke-SMBScanner**这样的工具可以集成到 PowerShell
    中，以识别目标系统上的 SMB 漏洞：
- en: '[PRE3]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Such tools perform scans for common SMB vulnerabilities, including known exploits
    such as EternalBlue or SMBGhost, and provide insights into potential risks.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 这样的工具会扫描常见的 SMB 漏洞，包括已知的漏洞，如 EternalBlue 或 SMBGhost，并提供潜在风险的见解。
- en: Assessing SMB signing and encryption
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 评估 SMB 签名和加密
- en: 'SMB signing and encryption are crucial to ensure data integrity and confidentiality.
    PowerShell allows you to check whether SMB signing and encryption are enabled
    on a remote server. The **Get-SmbClientConfiguration** cmdlet can be used to retrieve
    SMB client configuration, including signing and encryption settings:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: SMB 签名和加密对确保数据完整性和机密性至关重要。PowerShell 允许你检查远程服务器是否启用了 SMB 签名和加密。可以使用**Get-SmbClientConfiguration**
    cmdlet 获取 SMB 客户端配置，包括签名和加密设置：
- en: '[PRE4]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Inspect the **RequireSecuritySignature** and **EncryptData** properties to verify
    whether these security features are enabled. Securely configured SMB servers should
    have both signing and encryption enabled to enhance network security.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 检查**RequireSecuritySignature**和**EncryptData**属性，以验证这些安全功能是否已启用。配置良好的 SMB 服务器应启用签名和加密功能，以增强网络安全性。
- en: The enumeration of active SMB sessions
  id: totrans-34
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 活动 SMB 会话的枚举
- en: 'PowerShell can be used to enumerate active SMB sessions, providing insights
    into who is currently accessing shared resources. The **Get-SmbSession** cmdlet
    allows you to retrieve information about SMB sessions on a local or remote system:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可以用来列举活动的 SMB 会话，提供关于谁当前访问共享资源的见解。**Get-SmbSession** cmdlet 允许你获取有关本地或远程系统上的
    SMB 会话的信息：
- en: '[PRE5]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: By analyzing session data, security professionals can identify unauthorized
    or suspicious connections.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 通过分析会话数据，安全专家可以识别未经授权或可疑的连接。
- en: Checking for guest access
  id: totrans-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查访客访问
- en: 'Guest access to SMB shares can be a significant security risk. PowerShell can
    be used to verify whether guest access is allowed on a remote system. The **Get-SmbShare**
    cmdlet can be customized to check for guest access:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 访客访问 SMB 共享可能会带来重大安全风险。PowerShell 可以用于验证远程系统是否允许访客访问。**Get-SmbShare** cmdlet
    可以定制化检查访客访问：
- en: '[PRE6]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: This command lists shares that only allow guest access, highlighting potential
    security concerns.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令列出了只允许访客访问的共享，突出显示了潜在的安全问题。
- en: Evaluating share permissions
  id: totrans-42
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 评估共享权限
- en: 'PowerShell enables security testers to evaluate share permissions and **Access
    Control Lists** (**ACLs**) for SMB shares. The **Get-Acl** cmdlet can be used
    to retrieve and analyze the ACL of a specific share:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 使安全测试人员能够评估共享权限和**访问控制列表**（**ACLs**）以进行 SMB 共享的安全测试。可以使用 **Get-Acl**
    cmdlet 来检索和分析特定共享的 ACL：
- en: '[PRE7]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: This command displays the share’s security descriptor, helping you identify
    overly permissive or misconfigured share permissions.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令显示共享的安全描述符，帮助你识别权限过于宽松或配置错误的共享权限。
- en: SMB session monitoring
  id: totrans-46
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: SMB 会话监控
- en: 'PowerShell can be employed to set up continuous monitoring of SMB sessions.
    By periodically running commands to retrieve active sessions, you can spot any
    unexpected or suspicious connections over time. Consider using a scheduled task
    to automate session monitoring:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可用于设置对 SMB 会话的持续监控。通过定期运行命令来检索活动会话，你可以在一段时间内发现任何意外或可疑的连接。考虑使用计划任务来自动化会话监控：
- en: '[PRE8]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: This script continually retrieves SMB session information and can be run as
    a background task to monitor for any unauthorized or suspicious access.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本持续获取 SMB 会话信息，并可以作为后台任务运行，用于监控任何未经授权或可疑的访问。
- en: Automated ransomware detection
  id: totrans-50
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 自动化勒索病毒检测
- en: 'PowerShell can be used to detect suspicious or rapid changes in files that
    may indicate ransomware activity. Scripts can be written to monitor file attributes,
    such as file size and modification time, and raise alerts when unexpected changes
    occur:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可用于检测文件中可疑或迅速变化的内容，这可能表明勒索病毒活动。可以编写脚本来监控文件属性，如文件大小和修改时间，并在发生意外变化时发出警报：
- en: '[PRE9]'
  id: totrans-52
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: This script monitors the size of a specific file and raises an alert if the
    file size changes unexpectedly, which could indicate ransomware activity.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本监控特定文件的大小，并在文件大小发生意外变化时发出警报，这可能表明勒索病毒活动。
- en: PowerShell provides a robust set of tools and techniques for conducting security
    tests against SMB implementations. By leveraging these capabilities, security
    professionals can proactively identify vulnerabilities, assess share permissions,
    monitor SMB activity, and strengthen network defenses. It’s crucial to conduct
    these tests with proper authorization and compliance with applicable laws and
    regulations. Regularly auditing SMB configurations and actively monitoring for
    suspicious activity can help organizations secure their network services effectively
    and mitigate potential threats to SMB.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 提供了一整套强大的工具和技术，供安全测试人员对 SMB 实现进行安全测试。通过利用这些能力，安全专家可以主动识别漏洞、评估共享权限、监控
    SMB 活动并加强网络防御。进行这些测试时，必须获得适当授权，并遵守相关法律法规。定期审计 SMB 配置并积极监控可疑活动，有助于组织有效地保护其网络服务，并减轻
    SMB 潜在威胁。
- en: PowerShell, AD, and LDAP
  id: totrans-55
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: PowerShell、AD 和 LDAP
- en: PowerShell can be harnessed to perform comprehensive security tests against
    AD and LDAP services. In this extensive guide, we’ll delve into how PowerShell
    can be used to conduct security tests against AD and LDAP, identify vulnerabilities,
    and bolster the security of directory services.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可以用于对 AD 和 LDAP 服务进行全面的安全测试。在本指南中，我们将深入探讨如何使用 PowerShell 对 AD 和 LDAP
    进行安全测试，识别漏洞并加强目录服务的安全性。
- en: AD is Microsoft’s directory service used in Windows environments to manage users,
    groups, computers, and other network resources. LDAP is a protocol used to access
    and manage directory services, including AD. Both AD and LDAP are critical components
    of many enterprise networks, and securing them is paramount to maintaining a secure
    environment.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: AD 是 Microsoft 在 Windows 环境中用于管理用户、组、计算机和其他网络资源的目录服务。LDAP 是一种协议，用于访问和管理目录服务，包括
    AD。AD 和 LDAP 都是许多企业网络的关键组成部分，保护它们对于维持安全的环境至关重要。
- en: Before diving into the specifics of security testing, let’s briefly understand
    the core concepts of AD and LDAP.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 在深入了解安全测试的具体内容之前，我们简要了解一下 AD 和 LDAP 的核心概念。
- en: '**AD**: AD is a directory service developed by Microsoft for Windows domain
    networks. It stores and manages information about network resources, including
    user accounts, groups, and computers. AD plays a central role in authentication,
    authorization, and resource management in Windows environments.'
  id: totrans-59
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**AD**：AD 是 Microsoft 为 Windows 域网络开发的目录服务。它存储和管理关于网络资源的信息，包括用户账户、组和计算机。AD
    在 Windows 环境中的身份验证、授权和资源管理中起着核心作用。'
- en: '**LDAP**: LDAP is a protocol used to access and manage directory services,
    including AD. It provides a standardized way to query, update, and administer
    directory information. LDAP is commonly used in various network services and applications
    to access directory data.'
  id: totrans-60
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**LDAP**：LDAP 是一种用于访问和管理目录服务的协议，包括 AD。它提供了一种标准化的方式来查询、更新和管理目录信息。LDAP 通常用于各种网络服务和应用程序中，用以访问目录数据。'
- en: The enumeration of active directory objects
  id: totrans-61
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 枚举活动目录对象
- en: 'AD contains a wealth of information about users, groups, and computers. PowerShell
    allows you to enumerate these objects to gain insights into your AD structure.
    The **Get-ADObject** cmdlet is a powerful tool for this purpose – for example,
    to list all user objects in a specific **Organizational** **Unit** (**OU**):'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: AD 包含关于用户、组和计算机的大量信息。PowerShell 允许你枚举这些对象，从而深入了解你的 AD 结构。**Get-ADObject** cmdlet
    是一个强大的工具，例如，要列出特定**组织单位**（**OU**）中的所有用户对象：
- en: '[PRE10]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: This command retrieves all user objects within the specified OU, providing details
    such as usernames and distinguished names. Enumeration is the first step in understanding
    your AD environment, and it can help identify objects that shouldn’t be accessible
    or exist.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令检索指定 OU 中的所有用户对象，提供诸如用户名和区分名等详细信息。枚举是理解你的 AD 环境的第一步，它有助于识别那些不应被访问或不存在的对象。
- en: Assessing user account security
  id: totrans-65
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 评估用户账户安全性
- en: 'User accounts are a primary target for attackers. PowerShell can be used to
    assess user account security by checking for common issues, such as password complexity
    and expiration settings. For instance, the following can be used to list users
    whose passwords never expire:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 用户账户是攻击者的主要目标。PowerShell 可用于评估用户账户的安全性，检查常见问题，如密码复杂性和过期设置。例如，可以使用以下命令列出密码永不过期的用户：
- en: '[PRE11]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: This command identifies users with accounts set to never expire, which may be
    a security risk. Security testing often involves evaluating password policies,
    account lockout settings, and other security-related attributes.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令识别那些设置为永不过期的用户账户，这可能是一个安全风险。安全测试通常涉及评估密码策略、账户锁定设置和其他与安全相关的属性。
- en: Identifying inactive user accounts
  id: totrans-69
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 识别非活动用户账户
- en: 'Inactive user accounts can be exploited by attackers. PowerShell can help identify
    and disable or remove inactive accounts by checking the last login date. Here’s
    an example of finding users who haven’t logged in for 90 days:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 非活动用户账户可能会被攻击者利用。PowerShell 可以通过检查最后一次登录日期来帮助识别和禁用或删除非活动账户。以下是查找 90 天内未登录的用户的示例：
- en: '[PRE12]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: This script identifies users who haven’t logged in for the specified period,
    allowing you to take appropriate action, such as disabling or deleting the accounts.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 此脚本识别那些在指定期间内未登录的用户，允许你采取适当的措施，如禁用或删除这些账户。
- en: Auditing group memberships
  id: totrans-73
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 审计组成员资格
- en: 'Group memberships can grant users access to sensitive resources. PowerShell
    can audit group memberships to ensure they adhere to the principle of least privilege.
    For instance, to list the members of a specific group, the following command can
    be used:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 组成员资格可以授予用户访问敏感资源的权限。PowerShell 可以审计组成员资格，以确保它们符合最小权限原则。例如，要列出特定组的成员，可以使用以下命令：
- en: '[PRE13]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: This command retrieves all members of the **ITAdmins** group, helping you verify
    that only authorized individuals have access to administrative privileges.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令检索所有**ITAdmins**组的成员，帮助你验证只有授权的人员才有管理员权限。
- en: Identifying privileged accounts
  id: totrans-77
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 识别特权账户
- en: 'Privileged accounts, such as administrators, require extra scrutiny. PowerShell
    can help identify and review privileged accounts. To list all users with administrative
    roles, use the following command:'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 特权账户，如管理员账户，需要额外的审查。PowerShell 可以帮助识别和审查特权账户。要列出所有具有管理角色的用户，请使用以下命令：
- en: '[PRE14]'
  id: totrans-79
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: This command provides a list of all users in the **Administrators** group, allowing
    you to review their roles and permissions.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令提供了**管理员**组中所有用户的列表，允许你审查他们的角色和权限。
- en: Auditing password policy
  id: totrans-81
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 审计密码策略
- en: 'Password policies are crucial for security. PowerShell can be used to check
    the password policy settings in your domain. For example, to retrieve the password
    policy for your domain, use the following command:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 密码策略对于安全至关重要。可以使用PowerShell检查域中的密码策略设置。例如，要检索域的密码策略，请使用以下命令：
- en: '[PRE15]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: This command provides details about password complexity requirements, length,
    and other policy settings.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令提供有关密码复杂度要求、长度和其他策略设置的详细信息。
- en: Assessing LDAP permissions
  id: totrans-85
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 评估LDAP权限
- en: 'LDAP permissions can also be assessed using PowerShell. You can query AD to
    determine which users or groups have specific LDAP permissions. For instance,
    to find users with read access to the **CN=Users** container, use the following
    command:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 也可以使用PowerShell评估LDAP权限。您可以查询AD以确定哪些用户或组具有特定的LDAP权限。例如，要查找具有**CN=Users**容器读取权限的用户，可以使用以下命令：
- en: '[PRE16]'
  id: totrans-87
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: This command identifies users or groups that have read access to the **CN=Users**
    container. You can adapt this approach to check other permissions as well.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令识别具有读取**CN=Users**容器权限的用户或组。您可以根据此方法检查其他权限。
- en: Testing LDAP authentication
  id: totrans-89
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 测试LDAP身份验证
- en: 'PowerShell can be employed to test LDAP authentication by attempting to bind
    to the LDAP directory with different credentials. This can help identify weak
    or unprotected accounts. Here’s an example:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用PowerShell通过尝试使用不同的凭据绑定到LDAP目录来测试LDAP身份验证。这有助于识别弱或未保护的账户。以下是一个示例：
- en: '[PRE17]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: This script attempts to bind to the LDAP directory using the specified credentials
    and reports whether the authentication was successful.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 此脚本尝试使用指定的凭据绑定到LDAP目录，并报告身份验证是否成功。
- en: Identifying unsecured LDAP ports
  id: totrans-93
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 识别不安全的LDAP端口
- en: 'Attackers often target unsecured LDAP ports. PowerShell can be used to check
    whether LDAP services are exposed on unsecured ports. You can use the **Test-NetConnection**
    cmdlet to test LDAP connectivity:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击者通常会攻击不安全的LDAP端口。可以使用PowerShell检查LDAP服务是否暴露在不安全的端口上。您可以使用**Test-NetConnection**
    cmdlet来测试LDAP连接：
- en: '[PRE18]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: This command checks whether the LDAP service runs on the default unsecured port
    (**389**). If it is, consider securing LDAP with TLS or SSL.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令检查LDAP服务是否运行在默认的不安全端口（**389**）上。如果是，请考虑使用TLS或SSL加密LDAP。
- en: Monitoring LDAP traffic
  id: totrans-97
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 监控LDAP流量
- en: 'PowerShell can be employed to monitor LDAP traffic for unusual or suspicious
    activities. Tools such as the **Get-WinEvent** cmdlet can help you analyze event
    logs for LDAP-related events:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用PowerShell监控LDAP流量中的不寻常或可疑活动。像**Get-WinEvent** cmdlet这样的工具可以帮助您分析包含LDAP相关事件的事件日志：
- en: '[PRE19]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: This command retrieves security event logs containing LDAP channel binding failures,
    which may indicate unauthorized access attempts.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令检索包含LDAP通道绑定失败的安全事件日志，这可能表示未授权的访问尝试。
- en: Testing LDAP with LDAPS
  id: totrans-101
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用LDAPS测试LDAP
- en: '**LDAP over SSL** (**LDAPS**) is a secure way to access directory services.
    PowerShell can be used to verify whether LDAPS is properly configured. Here’s
    an example:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: '**基于SSL的LDAP**（**LDAPS**）是安全访问目录服务的方式。可以使用PowerShell验证LDAPS是否已正确配置。以下是一个示例：'
- en: '[PRE20]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: This command checks whether the LDAPS service runs on port **636**. LDAPS should
    be used to encrypt LDAP traffic for enhanced security.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令检查LDAPS服务是否运行在端口**636**上。应使用LDAPS加密LDAP流量，以增强安全性。
- en: Identifying anomalies with PowerShell scripts
  id: totrans-105
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用PowerShell脚本识别异常
- en: 'Custom PowerShell scripts can be created to identify anomalies and potential
    security breaches in AD and LDAP. For example, you can create a script that regularly
    checks for unusual login patterns, such as multiple failed login attempts, and
    sends alerts when detected:'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 可以创建自定义的PowerShell脚本来识别AD和LDAP中的异常情况和潜在安全漏洞。例如，您可以创建一个脚本，定期检查不寻常的登录模式，如多次失败的登录尝试，并在检测到时发送警报：
- en: '[PRE21]'
  id: totrans-107
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: This script monitors the security event log for multiple failed login attempts
    and sends an alert if the threshold is exceeded.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 此脚本监控安全事件日志中的多个失败的登录尝试，并在超过阈值时发送警报。
- en: PowerShell is an invaluable tool for conducting security tests against AD and
    LDAP services. By using these PowerShell commands and scripts, security professionals
    can proactively identify vulnerabilities, assess user account security, audit
    group memberships, and monitor directory service activity. However, it’s essential
    to conduct these tests with proper authorization and in compliance with applicable
    laws and regulations. Regularly auditing and securing AD and LDAP configurations
    can help organizations strengthen their directory services’ security and defend
    against potential threats.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 是进行 AD 和 LDAP 服务安全测试的宝贵工具。通过使用这些 PowerShell 命令和脚本，安全专业人员可以主动识别漏洞，评估用户账户安全，审计组成员身份，并监控目录服务活动。然而，必须在适当授权的情况下并遵守相关法律法规进行这些测试。定期审计和确保
    AD 和 LDAP 配置的安全可以帮助组织加强目录服务的安全性，并防御潜在的威胁。
- en: PowerShell and Kerberos
  id: totrans-110
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: PowerShell 和 Kerberos
- en: PowerShell can be effectively used to perform a wide range of security tests
    against Kerberos, a widely used authentication protocol. In this section, we will
    explore how PowerShell can be employed to assess the security of Kerberos implementations,
    identify vulnerabilities, and enhance system defenses.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可以有效地用于对 Kerberos 这一广泛使用的身份验证协议进行广泛的安全测试。在本节中，我们将探讨如何使用 PowerShell
    评估 Kerberos 实现的安全性，识别漏洞，并增强系统防御。
- en: Kerberos is a network authentication protocol that uses secret-key cryptography
    to authenticate users and services on a network. It’s employed in many Windows-based
    environments and is known for its robust security mechanisms. However, like any
    technology, Kerberos can have vulnerabilities that could be exploited by malicious
    actors. PowerShell can be utilized to uncover these vulnerabilities proactively.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: Kerberos 是一种网络身份验证协议，利用对称密钥加密对网络中的用户和服务进行身份验证。它在许多基于 Windows 的环境中应用，且以其强大的安全机制而闻名。然而，像任何技术一样，Kerberos
    也可能存在被恶意行为者利用的漏洞。可以通过 PowerShell 主动发现这些漏洞。
- en: The enumeration of Kerberos tickets
  id: totrans-113
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Kerberos 票证枚举
- en: 'PowerShell provides cmdlets such as **Get-KerberosTicket** that allow security
    testers to enumerate Kerberos tickets, revealing valuable information about active
    sessions and potential attack vectors, such as the following:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 提供了如 **Get-KerberosTicket** 这样的 cmdlet，允许安全测试人员枚举 Kerberos 票证，揭示有关活动会话和潜在攻击向量的有价值信息，例如：
- en: '[PRE22]'
  id: totrans-115
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: This command lists the active Kerberos tickets, providing insights into which
    users and services are authenticated and when these tickets expire.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令列出了活动的 Kerberos 票证，提供有关哪些用户和服务已通过身份验证以及这些票证何时到期的信息。
- en: Service Principal Name (SPN) enumeration
  id: totrans-117
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 服务主体名称（SPN）枚举
- en: 'PowerShell can be used to discover SPNs associated with services, which are
    crucial for Kerberos authentication. Attackers may target misconfigured SPNs to
    gain unauthorized access. Use **Get-ADServiceAccount** to list service accounts
    and their SPNs:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可用于发现与服务关联的 SPN，这对于 Kerberos 身份验证至关重要。攻击者可能会针对配置错误的 SPN 进行攻击，从而获得未授权访问。使用
    **Get-ADServiceAccount** 来列出服务账户及其 SPN：
- en: '[PRE23]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: This can help to identify any unnecessary or improperly configured SPNs.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 这有助于识别任何不必要或配置错误的 SPN。
- en: Credential harvesting with Mimikatz
  id: totrans-121
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用 Mimikatz 提取凭证
- en: 'Mimikatz, a powerful post-exploitation tool, can be integrated into PowerShell
    to extract credentials from memory. By loading the **Mimikatz** module, you can
    access its functions to harvest credentials, including Kerberos tickets:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: Mimikatz 是一个强大的后期利用工具，可以集成到 PowerShell 中，从内存中提取凭证。通过加载**Mimikatz**模块，您可以访问其功能来提取凭证，包括
    Kerberos 票证：
- en: '[PRE24]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: This can expose stored Kerberos tickets and plaintext passwords, highlighting
    the importance of securing sensitive credentials.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 这可能暴露存储的 Kerberos 票证和明文密码，突显出保护敏感凭证的重要性。
- en: Detecting golden ticket attacks
  id: totrans-125
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检测黄金票证攻击
- en: 'PowerShell can be employed to detect golden ticket attacks, a sophisticated
    threat vector where an attacker forges a Kerberos **Ticket Granting Ticket** (**TGT**).
    Tools such as PowerShellMafia/PowerSploit offer modules to check the integrity
    of TGTs and identify potential compromises:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可用于检测黄金票证攻击，这是一种复杂的威胁方式，攻击者伪造 Kerberos **票证授予票证**（**TGT**）。像 PowerShellMafia/PowerSploit
    这样的工具提供了检查 TGT 完整性的模块，帮助识别潜在的安全妥协：
- en: '[PRE25]'
  id: totrans-127
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: This command checks for vulnerable TGTs that can be cracked offline, helping
    to identify potential attacks.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令检查可以离线破解的易受攻击的 TGT，帮助识别潜在的攻击。
- en: Kerberos ticket renewal analysis
  id: totrans-129
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Kerberos 票证更新分析
- en: 'Kerberos tickets are typically renewed during a user’s session. PowerShell
    scripts can monitor ticket renewals and highlight anomalies. For instance, you
    can use the **New-TimeSpan** cmdlet to calculate the duration between ticket issuance
    and renewal:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: Kerberos 票证通常在用户会话期间更新。PowerShell 脚本可以监控票证的续期并突出显示异常。例如，你可以使用**New-TimeSpan**
    cmdlet 来计算票证发放和续期之间的持续时间：
- en: '[PRE26]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: This can help detect prolonged sessions that might be indicative of unauthorized
    access.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 这有助于检测可能表明未经授权访问的长时间会话。
- en: Analyzing event logs
  id: totrans-133
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 分析事件日志
- en: 'PowerShell can parse Windows event logs to identify suspicious Kerberos-related
    events. The **Get-WinEvent** cmdlet can be used to filter and analyze security
    event logs for specific Kerberos events:'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可以解析 Windows 事件日志，以识别可疑的与 Kerberos 相关的事件。可以使用**Get-WinEvent** cmdlet
    来筛选和分析安全事件日志中的特定 Kerberos 事件：
- en: '[PRE27]'
  id: totrans-135
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: This allows security professionals to identify failed authentication attempts
    or other unusual activities.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 这使得安全专家能够识别失败的身份验证尝试或其他异常活动。
- en: Password spray attacks
  id: totrans-137
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 密码喷洒攻击
- en: 'PowerShell can be employed to conduct password spray attacks against Kerberos.
    Tools such as **Invoke-SprayKerberos** can be used to test the strength of user
    passwords and identify weak credentials:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可以用于对 Kerberos 进行密码喷洒攻击。像**Invoke-SprayKerberos**这样的工具可以用来测试用户密码的强度并识别弱密码：
- en: '[PRE28]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: This helps to highlight users with weak passwords that could be exploited.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 这有助于突出显示可能被利用的弱密码用户。
- en: PowerShell serves as a versatile and indispensable tool to conduct security
    tests against Kerberos implementations. By leveraging its capabilities, security
    professionals can proactively identify vulnerabilities, detect potential threats,
    and enhance the security of their network infrastructure. However, it’s important
    to note that security testing should always be conducted with proper authorization
    and in compliance with applicable laws and regulations. Regularly auditing Kerberos
    configurations and monitoring for anomalies can play a vital role in safeguarding
    sensitive authentication mechanisms and preventing unauthorized access.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 是一款多功能且不可或缺的工具，用于对 Kerberos 实现进行安全测试。通过利用其功能，安全专家可以主动识别漏洞、检测潜在威胁，并加强网络基础设施的安全性。然而，重要的是要注意，安全测试应始终在适当授权下进行，并遵守相关法律法规。定期审计
    Kerberos 配置并监控异常，对于保护敏感的身份验证机制和防止未经授权的访问至关重要。
- en: Summary
  id: totrans-142
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: This chapter delved into the multifaceted applications of PowerShell in penetration
    testing across SMB, AD, and LDAP. Through a series of practical examples, we unveiled
    how PowerShell serves as an indispensable tool to enumerate, profile, and exploit
    vulnerabilities in these critical components of enterprise networks.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 本章探讨了 PowerShell 在 SMB、AD 和 LDAP 渗透测试中的多方面应用。通过一系列实践示例，我们揭示了 PowerShell 如何作为不可或缺的工具，在这些企业网络的关键组件中枚举、分析和利用漏洞。
- en: In the next chapter, we will learn about how PowerShell can be used as part
    of a vulnerability assessment against SQL databases. Particular attention will
    be paid to Microsoft SQL, PostgreSQL, and MySQL.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将学习如何将 PowerShell 用于 SQL 数据库的漏洞评估。特别关注 Microsoft SQL、PostgreSQL 和 MySQL。
