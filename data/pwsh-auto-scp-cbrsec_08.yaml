- en: '8'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '8'
- en: Red Team Tasks and Cookbook
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 红队任务与食谱
- en: This chapter is meant to be a quick and dirty reference for red teamers that
    want to use PowerShell for their engagements. It is by no means complete but should
    help you get started.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章旨在为红队成员提供一个快速参考，帮助他们使用 PowerShell 进行任务。虽然内容不完整，但应当能帮助你入门。
- en: After a short introduction to the phases of attack, we are going to look at
    what tools are usually used by red teamers for PowerShell-based engagements. After
    that, we will provide a PowerShell cookbook that covers most typical red team
    scenarios when it comes to PowerShell.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在简要介绍攻击阶段后，我们将讨论红队成员在基于 PowerShell 的任务中通常使用哪些工具。接下来，我们将提供一个 PowerShell 食谱，涵盖大多数典型的红队场景。
- en: 'In this chapter, we will discuss the following topics:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将讨论以下主题：
- en: Phases of an attack
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 攻击的阶段
- en: Common PowerShell red team tools
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 常用 PowerShell 红队工具
- en: Red team cookbook
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 红队食谱
- en: Technical requirements
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'To get the most out of this chapter, ensure that you have the following:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 为了充分利用本章内容，请确保你具备以下条件：
- en: Windows PowerShell 5.1
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows PowerShell 5.1
- en: PowerShell 7.3 and above
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: PowerShell 7.3 及以上版本
- en: Visual Studio Code installed
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 已安装 Visual Studio Code
- en: 'Access to the GitHub repository for this chapter: [https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter08](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter08)'
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本章 GitHub 仓库的访问链接：[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter08](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/tree/master/Chapter08)
- en: Phases of an attack
  id: totrans-14
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 攻击的阶段
- en: When it comes to an attack, the same pattern is usually repeated over and over
    again. These phases are also reflected when it comes to a professional penetration
    test, which is performed by red teamers.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 当谈到攻击时，通常会重复相同的模式。这些阶段也反映在由红队员执行的专业渗透测试中。
- en: 'The following diagram illustrates the phases of an attack:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 以下图表展示了攻击的各个阶段：
- en: '![Figure 8.1 – Phases of an attack](image/B16679_08_001.jpg)'
  id: totrans-17
  prefs: []
  type: TYPE_IMG
  zh: '![图 8.1 – 攻击的各个阶段](image/B16679_08_001.jpg)'
- en: Figure 8.1 – Phases of an attack
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.1 – 攻击的各个阶段
- en: In the first phase, known as **reconnaissance**, the red teamer tries to get
    as much information as possible about the target. Once this phase has been completed,
    vulnerabilities are identified (**vulnerability identification**) that can be
    used for **exploitation** and getting access to the target.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在第一阶段，称为**侦察**阶段，红队员尽力收集关于目标的尽可能多的信息。一旦该阶段完成，便会识别出可以用于**利用**并获取目标访问权限的漏洞（**漏洞识别**）。
- en: Once a target has been successfully exploited, usually, credentials are collected,
    which can be used for **lateral movement** and to collect even more identities.
    Part of **post-exploitation** is to gain **persistence**, which means that the
    red teamer can reconnect without the need to exploit vulnerabilities once more.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦成功利用了一个目标，通常会收集凭证，这些凭证可以用于**横向移动**并收集更多身份信息。**后渗透**的一部分是获得**持久性**，这意味着红队成员可以在不需要再次利用漏洞的情况下重新连接。
- en: Lateral movement can also occur by finding more vulnerabilities that can be
    exploited, for example by finding and exploiting a vulnerability in other connected
    systems that wasn’t accessible through the primary point of entry and cannot simply
    be reached by just gathering and abusing identities.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 横向移动还可以通过发现更多可利用的漏洞来实现，例如，通过发现并利用其他连接系统中的漏洞，这些系统不能通过主要入口点访问，也不能仅通过收集和滥用身份信息来轻易达到。
- en: 'While moving laterally, the goal is usually to find a very valuable identity
    that has high privileges, such as a domain administrator account, which can then
    be used to gain control of the entire environment to achieve the actual **goal**
    of the engagement: in real-world adversary scenarios, this could be either to
    encrypt all possible systems to demand a ransom (as is done by **ransomware**)
    or to stay in the environment undetected as long as possible to **extract information**.'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 在横向移动时，目标通常是寻找具有高权限的非常有价值的身份，例如域管理员账户，接着可以利用该身份控制整个环境，达到参与的实际**目标**：在现实世界的对抗场景中，这可能是加密所有可能的系统以勒索赎金（如**勒索软件**所做的那样），或者尽可能长时间地保持在环境中不被检测到，以**提取信息**。
- en: Last but not least, adversaries try to **cover their tracks** in a real-world
    scenario. This step is – of course – not necessary if we are talking about a penetration
    test engagement; in this case, the pentester usually writes a **report** as a
    last step to present their findings.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 最后但同样重要的是，攻击者会在真实世界的场景中尝试**掩盖他们的踪迹**。这个步骤——当然——在我们讨论渗透测试时并不必要；在这种情况下，渗透测试人员通常会在最后一步写一份**报告**来呈现他们的发现。
- en: All these steps might sound quite time-consuming, but in reality, most of the
    steps are already scripted, and it is only a matter of a few hours or even minutes
    until the entire environment is compromised. So long as the attack hasn’t started,
    the adversary has as much time as they like to do their reconnaissance to find
    out as much as possible about the target and prepare.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 所有这些步骤听起来可能相当耗时，但实际上，大部分步骤已经被编写成脚本，只需要几个小时甚至几分钟，整个环境就可以被攻破。只要攻击没有开始，攻击者就有足够的时间进行侦察，尽可能多地了解目标并做好准备。
- en: Once the first host has been compromised, it usually does not take longer than
    24 to 48 hours until a domain administrator account is compromised. But usually,
    depending on the organization and the industry, it takes some time until it is
    discovered that an actual attack has happened… if it is detected at all…
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦第一个主机被攻破，通常不会超过 24 到 48 小时，域管理员账户就会被攻破。但通常情况下，根据组织和行业的不同，发现实际攻击发生通常需要一段时间……如果能够检测到的话……
- en: If adversaries are launching a ransomware campaign, they will not remain unnoticed
    once they start encrypting systems and demanding ransom. But usually, they still
    go unnoticed for a significant time to prepare for their attack.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 如果攻击者正在发起勒索软件攻击活动，一旦他们开始加密系统并要求赎金，通常不会不被注意。但通常，他们仍会在攻击准备阶段保持隐匿一段相当长的时间。
- en: For red teamers, PowerShell is a great tool as it is built into every modern
    Windows operating system and offers a mechanism for remote command execution.
    It also offers full access to system APIs via WMI and .NET Framework and can be
    used for fileless code execution, meaning that malicious code can be executed
    in memory without the need to write it to disk if intended. Additionally, it can
    be used to evade **antivirus** (**AV**), as well as **intrusion prevention** **systems**
    (**IPSs**).
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 对于红队成员来说，PowerShell 是一个非常棒的工具，因为它内置于每个现代 Windows 操作系统中，并提供了远程命令执行的机制。它还通过 WMI
    和 .NET Framework 提供了对系统 API 的完全访问，可以用于无文件代码执行，这意味着恶意代码可以在内存中执行，而无需写入磁盘。此外，它还可以用来规避**杀毒软件**（**AV**）以及**入侵防御系统**（**IPS**）。
- en: Although there are many commands that red teamers can leverage for their purposes,
    there is also a plethora of open source tools that provide several capabilities
    that are very helpful in red team engagements, as well as in real-world scenario
    attacks.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管红队成员可以利用许多命令来实现他们的目的，但也有大量的开源工具提供了多种功能，这些功能在红队任务和现实世界中的攻击场景中都非常有帮助。
- en: Common PowerShell red team tools
  id: totrans-29
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 常见的 PowerShell 红队工具
- en: Many tools have been released that are written in PowerShell that can help you
    with your red team engagements – too many for you to make use of every single
    one. In this section, we will look at some of the most well-known and helpful
    tools to get you started and provide you with an overview of what is out there
    to help.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 已经发布了许多 PowerShell 编写的工具，能够帮助你完成红队任务——这些工具太多了，以至于你不可能使用每一个。在本节中，我们将介绍一些最著名且有帮助的工具，帮助你入门，并为你提供一个概览，看看有哪些工具可以为你提供帮助。
- en: PowerSploit
  id: totrans-31
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: PowerSploit
- en: '**PowerSploit** is a collection of PowerShell modules and scripts that can
    help red teamers during a penetration testing engagement. It was originally developed
    by Matt Graeber. It is no longer supported, but there are still many useful tools
    and scripts that are helpful. PowerSploit can be downloaded from GitHub: https://github.com/PowerShellMafia/PowerSploit.'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: '**PowerSploit** 是一套 PowerShell 模块和脚本，旨在帮助红队成员在渗透测试过程中使用。最初由 Matt Graeber 开发。虽然它不再受到支持，但仍有许多有用的工具和脚本可以派上用场。PowerSploit
    可以从 GitHub 下载：https://github.com/PowerShellMafia/PowerSploit。'
- en: While most functions work fine in Windows PowerShell, they don’t in PowerShell
    7 and above. Some functionalities that PowerSploit made use of from .NET Framework
    were not ported into .NET Core, on which PowerShell 7 relies. So, when running
    PowerSploit from PowerShell 7 and above, you will likely experience errors. Therefore,
    we will be using Windows PowerShell for demonstration purposes in this chapter.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然大多数功能在Windows PowerShell中工作正常，但在PowerShell 7及以上版本中并不适用。PowerSploit使用的某些功能是基于.NET
    Framework的，而这些功能并未移植到PowerShell 7所依赖的.NET Core中。因此，在PowerShell 7及以上版本中运行PowerSploit时，您可能会遇到错误。因此，本章演示时我们将使用Windows
    PowerShell。
- en: 'PowerSploit is a very extensive collection, so we will not deep-dive into it.
    It comes with several subfolders, which group its PowerShell modules into the
    following categories:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: PowerSploit是一个非常广泛的工具集，因此我们不会深入探讨它。它包含几个子文件夹，将其PowerShell模块分为以下类别：
- en: '**CodeExecution**'
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**CodeExecution**'
- en: '**ScriptModification**'
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**ScriptModification**'
- en: '**Persistence**'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Persistence**'
- en: '**AntivirusBypass**'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**AntivirusBypass**'
- en: '**Exfiltration**'
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Exfiltration**'
- en: '**Mayhem**'
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Mayhem**'
- en: '**Privesc** (privilege escalation)'
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Privesc**（权限提升）'
- en: '**Recon** (reconnaissance)'
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Recon**（侦察）'
- en: You can either load the entire collection as a module or just load parts of
    it; it is possible to just copy and paste one of the subfolders into your module
    folder and load it.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以选择将整个集合作为模块加载，或仅加载其中的部分内容；也可以将其中一个子文件夹复制并粘贴到您的模块文件夹中，然后加载它。
- en: 'As usual, you can find all the related functions and aliases of PowerSploit
    by running the following command:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 与往常一样，您可以通过运行以下命令查找PowerSploit的所有相关功能和别名：
- en: '[PRE0]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'To make the most out of it, you can refer to the official documentation: [https://powersploit.readthedocs.io/en/latest/](https://powersploit.readthedocs.io/en/latest/).'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 为了充分利用它，您可以参考官方文档：[https://powersploit.readthedocs.io/en/latest/](https://powersploit.readthedocs.io/en/latest/)。
- en: One tool within PowerSploit that might be worth taking a second look at is PowerView.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: PowerSploit中的一个值得重新审视的工具是PowerView。
- en: PowerView
  id: totrans-48
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: PowerView
- en: 'You can find the **PowerView** script within the **Recon** folder on GitHub:
    https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1.'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在GitHub上的**Recon**文件夹中找到**PowerView**脚本：[https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)。
- en: You can either import and load the entire **Recon** folder or you can just download
    and run the **PowerView.ps1** script, which might be easier in engagements when
    you need to execute your payloads from memory and not from disk.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以选择导入并加载整个**Recon**文件夹，或者只下载并运行**PowerView.ps1**脚本，这在您需要从内存而非磁盘执行有效载荷时，可能会更方便。
- en: 'PowerView has many built-in features, some of which are as follows:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: PowerView有许多内置功能，其中一些功能如下：
- en: Enumeration and gathering information about domains, **domain controllers**
    (**DCs**), users, groups, computers, global catalogs, directory service sites,
    and trusts
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 列举和收集有关域、**域控制器**（**DCs**）、用户、组、计算机、全局目录、目录服务站点和信任的信息
- en: Enumeration of permission and access control of domain resources
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 列举域资源的权限和访问控制
- en: Identifying where in the domain specific users are logged on and which machines
    the current user has access to
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 确定特定域中用户登录的位置以及当前用户可以访问的机器
- en: 'You can find a full overview of PowerView in the official documentation: [https://powersploit.readthedocs.io/en/latest/Recon/](https://powersploit.readthedocs.io/en/latest/Recon/).'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在官方文档中找到PowerView的完整概述：[https://powersploit.readthedocs.io/en/latest/Recon/](https://powersploit.readthedocs.io/en/latest/Recon/)。
- en: Invoke-Mimikatz
  id: totrans-56
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Invoke-Mimikatz
- en: '**Mimikatz** is a well-known tool in the cybersecurity world. It helps you
    extract and reuse credentials, such as hashes or tickets from the **local security
    authority** (**LSA**), which enables red teamers to conduct a **Pass-the-Hash**
    (**PtH**) or **Pass-the-Ticket** (**PtT**) attack.'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: '**Mimikatz**是网络安全领域的一个知名工具。它帮助您从**本地安全机构**（**LSA**）提取并重用凭据，如哈希值或票证，这使得红队人员可以进行**Pass-the-Hash**（**PtH**）或**Pass-the-Ticket**（**PtT**）攻击。'
- en: 'Mimikatz itself was written in C by Benjamin Delpy. However, Joseph Bialek
    managed to wrap it into a PowerShell script, which was included in PowerSploit,
    Nishang, and many other toolkits. I believe that the script that was hosted in
    Nishang was the latest version that I could find when writing this book: [https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1](https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1).'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: Mimikatz 本身是由 Benjamin Delpy 用 C 编写的。然而，Joseph Bialek 成功地将其封装成一个 PowerShell
    脚本，并将其包含在 PowerSploit、Nishang 和许多其他工具包中。我相信，当我写这本书时，Nishang 中托管的脚本是我能找到的最新版本：[https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1](https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1)。
- en: After loading the **Invoke-Mimikatz.ps1** script into the current session, you
    can just call Mimikatz’s function by executing **Invoke-Mimikatz** on the PowerShell
    command line.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 在将 **Invoke-Mimikatz.ps1** 脚本加载到当前会话中后，只需在 PowerShell 命令行执行 **Invoke-Mimikatz**
    即可调用 Mimikatz 的功能。
- en: 'For the official Mimikatz documentation, please refer to the C Mimikatz version’s
    GitHub repository: https://github.com/gentilkiwi/mimikatz.'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 有关官方 Mimikatz 文档，请参考 C 版本 Mimikatz 的 GitHub 仓库：[https://github.com/gentilkiwi/mimikatz](https://github.com/gentilkiwi/mimikatz)。
- en: At the time of writing, Mimikatz is very well known by defenders and anti-malware
    solutions, so you should not just assume that **Invoke-Mimikatz** will just work
    without being detected or alerted. To make it work successfully, you will want
    to obfuscate it – and even then it will often be detected.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 在写作时，Mimikatz 已经为防御者和反恶意软件解决方案广为人知，因此你不应当仅仅假设 **Invoke-Mimikatz** 会在不被检测或警报的情况下正常工作。为了使其成功运行，你需要对其进行混淆——即使如此，它仍然很可能会被检测到。
- en: Empire
  id: totrans-62
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Empire
- en: '**PowerShell Empire** is a post-exploitation framework and was developed by
    Will Schroeder, Justin Warner, Matt Nelson, Steve Borosh, Alexander Rymdeko-Harvey,
    and Chris Ross. It is not supported any longer but still contains a lot of good
    stuff, nevertheless.'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: '**PowerShell Empire** 是一个后渗透框架，由 Will Schroeder、Justin Warner、Matt Nelson、Steve
    Borosh、Alexander Rymdeko-Harvey 和 Chris Ross 开发。虽然现在已经不再维护，但它仍然包含许多有用的功能。'
- en: 'It was built to provide red teamers a platform to perform post-exploitation
    tasks, similar to Metasploit, and contains features such as the following:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 它的构建目的是为红队成员提供一个平台，用于执行后渗透任务，类似于 Metasploit，并包含以下特性：
- en: The ability to generate payloads to compromise systems
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 生成有效负载以攻陷系统的能力。
- en: The possibility to import and use third-party tools such as Mimikatz
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 导入并使用第三方工具（如 Mimikatz）的能力。
- en: A **Command and Control** (**C2**) server, which can be used for communication
    with compromised hosts.
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个**命令与控制**（**C2**）服务器，可用于与被攻陷的主机进行通信。
- en: A library of post-exploitation modules that can be used for many tasks, such
    as information gathering, privilege escalation, and establishing persistence
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一组可以用于多种任务的后渗透模块库，例如信息收集、权限提升和建立持久性。
- en: 'Empire can be downloaded from GitHub: https://github.com/EmpireProject/Empire.'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: Empire 可以从 GitHub 下载：[https://github.com/EmpireProject/Empire](https://github.com/EmpireProject/Empire)。
- en: 'To quickly get started, there is even a QuickStart guide: https://github.com/EmpireProject/Empire/wiki/Quickstart.'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 为了快速入门，甚至提供了一个快速入门指南：[https://github.com/EmpireProject/Empire/wiki/Quickstart](https://github.com/EmpireProject/Empire/wiki/Quickstart)。
- en: Inveigh
  id: totrans-71
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Inveigh
- en: '**Inveigh** is a .NET IPv4/IPv6 machine-in-the-middle tool that was developed
    by Kevin Robertson. It was originally developed in PowerShell but later ported
    to C#, which made it available cross-platform. The latest PowerShell version of
    Inveigh is 1.506 and is no longer developed at the time of writing, but it is
    still available on GitHub. The latest C# version is 2.0.9.'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: '**Inveigh** 是一个 .NET 平台下的 IPv4/IPv6 中间人工具，由 Kevin Robertson 开发。它最初是在 PowerShell
    中开发的，但后来被移植到了 C#，从而使其支持跨平台使用。Inveigh 的最新 PowerShell 版本是 1.506，且在写作时已不再开发，但仍然可以在
    GitHub 上获取。最新的 C# 版本是 2.0.9。'
- en: 'Here are the main features of the PowerShell version:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是 PowerShell 版本的主要特性：
- en: Domain Name System (DNS)/Active Directory Integrated DNS (ADIDNS)/Link-Local
    Multicast Name Resolution (LLMNR)/Multicast DNS (mDNS)/NetBIOS Name Service (NBNS)
    spoofing
  id: totrans-74
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 域名系统（DNS）/活动目录集成 DNS（ADIDNS）/链接本地多播名称解析（LLMNR）/多播 DNS（mDNS）/NetBIOS 名称服务（NBNS）欺骗。
- en: Inveigh can listen for and respond to LLMNR/mDNS/NBNS requests via .NET packet
    sniffing
  id: totrans-75
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Inveigh 可以通过 .NET 数据包嗅探监听并响应 LLMNR/mDNS/NBNS 请求。
- en: Inveigh can capture NTLMv1/NTLMv2 authentication attempts over SMB
  id: totrans-76
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Inveigh 可以捕获通过 SMB 进行的 NTLMv1/NTLMv2 认证尝试。
- en: Inveigh provides HTTP/HTTPS/proxy listeners to capture incoming authentication
    requests
  id: totrans-77
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Inveigh 提供 HTTP/HTTPS/代理监听器，用于捕获传入的认证请求。
- en: 'It can be downloaded from GitHub: https://github.com/Kevin-Robertson/Inveigh.'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 它可以从GitHub下载：https://github.com/Kevin-Robertson/Inveigh。
- en: PowerUpSQL
  id: totrans-79
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: PowerUpSQL
- en: '**PowerUpSQL** was developed by Scott Sutherland and is a PowerShell module
    for attacking SQL servers. Although it offers a variety of possibilities, it does
    not support SQL injection yet.'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: '**PowerUpSQL**是由Scott Sutherland开发的PowerShell模块，用于攻击SQL服务器。尽管它提供了多种可能性，但目前尚不支持SQL注入。'
- en: 'Here’s an overview of PowerUpSQL’s capabilities:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是PowerUpSQL功能的概览：
- en: Enumerate SQL Server instances and databases, as well as users, roles, and permissions
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 枚举SQL Server实例和数据库，以及用户、角色和权限。
- en: Weak configuration auditing
  id: totrans-83
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 弱配置审计
- en: Privilege escalation and obtaining system-level access
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 权限提升和获取系统级访问权限。
- en: 'You can find this project and its documentation on GitHub: https://github.com/NetSPI/PowerUpSQL.'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在GitHub上找到此项目及其文档：https://github.com/NetSPI/PowerUpSQL。
- en: AADInternals
  id: totrans-86
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: AADInternals
- en: '**AADInternals**, developed by Nestori Syynimaa, is an extensive PowerShell
    module that offers a huge range of capabilities for administrating, enumerating,
    and exploiting Azure AD and Office 365 environments.'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: '**AADInternals**是由Nestori Syynimaa开发的一个广泛的PowerShell模块，提供了丰富的功能，用于管理、枚举和利用Azure
    AD和Office 365环境。'
- en: 'Some of its features are as follows:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 它的一些特性如下：
- en: Enumerate Azure AD and Office 365 environments; review and modify permissions
    and access rights.
  id: totrans-89
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 枚举Azure AD和Office 365环境；审查并修改权限和访问权。
- en: Create backdoor users.
  id: totrans-90
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 创建后门用户。
- en: Exfiltrate credentials, such as PRTs.
  id: totrans-91
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 提取凭证，如PRT（持久令牌）。
- en: Extract or change the Azure AD connector account password.
  id: totrans-92
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 提取或更改Azure AD连接器帐户密码。
- en: Tamper with authentication options.
  id: totrans-93
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 篡改认证选项。
- en: Extract encryption keys.
  id: totrans-94
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 提取加密密钥。
- en: Create users in Azure AD.
  id: totrans-95
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在Azure AD中创建用户。
- en: And many more.
  id: totrans-96
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 以及更多。
- en: 'You can simply install it from the PowerShell command line using **Install-Module
    AADInternals**. You can download it from PowerShell Gallery: https://www.powershellgallery.com/packages/AADInternals/.'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过PowerShell命令行简单地使用**Install-Module AADInternals**来安装它。您可以从PowerShell Gallery下载：
    https://www.powershellgallery.com/packages/AADInternals/。
- en: 'You can also find this project on GitHub: https://github.com/Gerenios/AADInternals.'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 您也可以在GitHub上找到该项目：https://github.com/Gerenios/AADInternals。
- en: Red team cookbook
  id: totrans-99
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 红队工具书
- en: In this section, you will find some handy code snippets for your red team engagement.
    Please also refer to [*Chapter 9*](B16679_09_Final_PD.xhtml#_idTextAnchor228),
    *Blue Team Tasks and Cookbook*, as you will find many blue teamer code snippets
    and scripts there. These can sometimes also be useful for a red teamer.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，您将找到一些适用于红队任务的便捷代码片段。请同时参考[*第9章*](B16679_09_Final_PD.xhtml#_idTextAnchor228)，*蓝队任务与工具书*，在那里您将找到许多蓝队员的代码片段和脚本。这些有时也对红队员有所帮助。
- en: Please note that this cookbook is not a complete red team reference as this
    would fill an entire book. Rather, it intends to be a helpful source to help you
    get started with PowerShell-related red teaming.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，这本工具书并不是一个完整的红队参考资料，因为那样会填满一本书。它的目的是作为一个有用的资源，帮助您开始进行与PowerShell相关的红队任务。
- en: To make it easier to understand for people starting in cybersecurity, this cookbook
    has been categorized into **MITRE ATT&CK** areas. Please note that you will not
    find *all* the MITRE ATT&CK areas in this cookbook.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 为了让刚接触网络安全的人更容易理解，本工具书已根据**MITRE ATT&CK**领域进行分类。请注意，您在本工具书中找不到*所有*的MITRE ATT&CK领域。
- en: 'You can find the full MITRE ATT&CK enterprise matrix on the official MITRE
    web page: https://attack.mitre.org/matrices/enterprise/.'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在官方MITRE网页上找到完整的MITRE ATT&CK企业矩阵：https://attack.mitre.org/matrices/enterprise/。
- en: Reconnaissance
  id: totrans-104
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 侦察
- en: Usually, every attack starts with reconnaissance, the initial phase in which
    an adversary gathers information about a target system, network, or organization.
    Every little bit of information helps with planning the next phases of the attack
    and gaining insights and knowledge, identifying valuable targets, and executing
    a more targeted and successful attack or assessment.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，每次攻击都始于侦察，这是敌对方收集目标系统、网络或组织信息的初始阶段。每一小块信息都有助于规划攻击的下一阶段，获得洞察和知识，识别有价值的目标，从而执行更有针对性和成功的攻击或评估。
- en: Finding out whether an AAD/Entra ID user exists and viewing their cloud-specific
    details
  id: totrans-106
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 查找AAD/Entra ID用户是否存在并查看其特定于云的详细信息。
- en: You want to find out whether an Azure/Entra ID user exists and you wish to view
    their cloud-specific details. You also want to find out whether Federated Active
    Directory is in use or whether the company uses O365.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 你想查找是否存在 Azure/Entra ID 用户，并希望查看他们的云端详细信息。你还想了解是否使用了联合 Active Directory，或者公司是否使用了
    O365。
- en: Solution
  id: totrans-108
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To do this, you can query one of Azure AD’s/Entra IDs APIs:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 为此，你可以查询其中一个 Azure AD/Entra ID 的 API：
- en: '[PRE1]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: You can find more information about this API and the XML values it returns in
    [*Chapter 7*](B16679_07_Final_PD.xhtml#_idTextAnchor179), *Hacking the Cloud –
    Exploiting Azure Active* *Directory/Entra ID*.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在 [*第 7 章*](B16679_07_Final_PD.xhtml#_idTextAnchor179) 中找到更多关于这个 API 以及它返回的
    XML 值的信息，*黑客云端 – 利用 Azure Active* *Directory/Entra ID*。
- en: Execution
  id: totrans-112
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 执行
- en: In the execution phase of an attack, the malicious activities are carried out
    by the attacker. The execution phase can be combined with other phases, such as
    executing an obfuscated PowerShell command, which is used to gather more information
    on another host.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 在攻击的执行阶段，攻击者会进行恶意活动。执行阶段可以与其他阶段结合，如执行混淆的 PowerShell 命令，用于收集另一台主机的更多信息。
- en: Evading execution policies
  id: totrans-114
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 绕过执行策略
- en: You come across a system on which execution policies are enforced; they keep
    you from running a script, so you want to evade them.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 你遇到了一个执行策略被强制执行的系统；它们阻止你运行脚本，所以你想要绕过它们。
- en: 'There are several ways to configure an execution policy: it can be configured
    locally or via management solutions such as Group Policy. Depending on how it
    is configured, the solution differs.'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 配置执行策略有多种方式：可以在本地配置，或通过组策略等管理解决方案进行配置。根据配置方式的不同，解决方案也有所不同。
- en: Solution
  id: totrans-117
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: As discussed in detail in [*Chapter 1*](B16679_01_Final_PD.xhtml#_idTextAnchor016),
    *Getting Started with PowerShell*, an execution policy is not a security control
    and does not keep adversaries from running malicious code. Rather, it is a feature
    to prevent users from unintentionally executing scripts. However, there are several
    ways to avoid an execution policy.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 如 [*第 1 章*](B16679_01_Final_PD.xhtml#_idTextAnchor016) 中详细讨论的那样，*PowerShell
    入门*，执行策略并非一种安全控制，不会阻止对手运行恶意代码。它只是一个功能，用来防止用户不小心执行脚本。然而，有多种方法可以避免执行策略。
- en: 'If the execution policy was *not* enforced using Group Policy, you can easily
    set it to **Unrestricted** if you are a local administrator:'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 如果执行策略*没有*通过组策略强制执行，你可以轻松地将其设置为 **Unrestricted**，前提是你是本地管理员：
- en: '[PRE2]'
  id: totrans-120
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'If you are *not* a local administrator, and the execution policy was *not*
    enforced using GPO (only set locally), you can use the following code:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你*不是*本地管理员，并且执行策略*没有*通过 GPO 强制执行（仅本地设置），你可以使用以下代码：
- en: '[PRE3]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Regardless of whether you are a local administrator or not, as well as regardless
    of how the execution policy was configured, these commands will always work and
    run your code:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 无论你是否是本地管理员，也无论执行策略如何配置，这些命令始终有效，并会运行你的代码：
- en: '[PRE4]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: There are many solutions to this problem and they are not all listed here. If
    you want to bypass an execution policy, this should not be an issue and can be
    done easily in several ways.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 针对此问题有许多解决方案，且这里并未列出所有方案。如果你想绕过执行策略，这不应该成为问题，并且可以通过多种方式轻松实现。
- en: Opening a PowerShell command line to execute a command
  id: totrans-126
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 打开 PowerShell 命令行以执行命令
- en: You want to pass a command directly to a new PowerShell session without opening
    a new shell and typing the command.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 你想直接将命令传递给一个新的 PowerShell 会话，而无需打开新的 shell 并键入命令。
- en: Solution
  id: totrans-128
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can achieve this by using **powershell.exe** with the **-c**/**-Command**
    parameter, followed by your command:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过使用 **powershell.exe** 配合 **-c**/**-Command** 参数，后跟你的命令，来实现这一点：
- en: '[PRE5]'
  id: totrans-130
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The **-c** option will execute the supplied command wrapped in double quotes
    as if it were typed at the PowerShell prompt.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: '**-c** 选项将执行所提供的命令，并将其包装在双引号中，就像在 PowerShell 提示符下键入一样。'
- en: Avoiding loading settings from the PowerShell user profile
  id: totrans-132
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 避免从 PowerShell 用户配置文件加载设置
- en: The PowerShell user profile contains non-desirable settings that you will want
    to avoid.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 用户配置文件包含不希望出现的设置，你需要避免它们。
- en: Solution
  id: totrans-134
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'Use the **-NoProfile** or **-nop** parameter, which results in PowerShell not
    loading the PowerShell user profile. The **-nop** argument is short for **-NoProfile**:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 **-NoProfile** 或 **-nop** 参数，这样 PowerShell 就不会加载 PowerShell 用户配置文件。**-nop**
    参数是 **-NoProfile** 的简写：
- en: '[PRE6]'
  id: totrans-136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Downloading a file using PowerShell cmdlets
  id: totrans-137
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用 PowerShell cmdlet 下载文件
- en: You want to download a file to a specified folder on your system.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 你想将一个文件下载到系统中的指定文件夹。
- en: Solution
  id: totrans-139
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'There are multiple ways to download a file using PowerShell cmdlets:'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 使用PowerShell cmdlet下载文件有多种方法：
- en: '**Invoke-WebRequest**'
  id: totrans-141
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Invoke-WebRequest**'
- en: For all of the following examples, download the following script, which can
    be found at [https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-CyberSecurity/master/Chapter01/HelloWorld.ps1),
    and save it to the C:\Users\Administrator\Downloads\HelloWorld**.ps1** path.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 对于以下所有示例，请下载以下脚本，可在[https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-CyberSecurity/master/Chapter01/HelloWorld.ps1)找到，并将其保存到C:\Users\Administrator\Downloads\HelloWorld**.ps1**路径。
- en: 'To download a file using **Invoke-WebRequest**, you can use the following code
    snippet:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用**Invoke-WebRequest**下载文件，您可以使用以下代码片段：
- en: '[PRE7]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Make sure you replace **<source>** and **<destination>** appropriately with
    the source of the file and where it should be downloaded, respectively, as shown
    in the following example:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 确保您适当地替换**<source>**和**<destination>**，分别表示文件的来源和下载位置，如下例所示：
- en: '[PRE8]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'It is also possible to use its alias, **iwr**:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 也可以使用其别名**iwr**：
- en: '[PRE9]'
  id: totrans-148
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '**Invoke-RestMethod**'
  id: totrans-149
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Invoke-RestMethod**'
- en: 'You can also use **Invoke-RestMethod** to return the content of scripts from
    the internet:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 您还可以使用**Invoke-RestMethod**从互联网返回脚本的内容：
- en: '[PRE10]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: '**Invoke-RestMethod** intends to retrieve data from **Representational State
    Transfer** (**REST**) web services. Depending on the data type, PowerShell formats
    the answer accordingly: if it’s a **JSON** or **XML** file, the content is returned
    as **[PSCustomObject]**, but it can also retrieve and return single items, as
    shown in the following example:'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: '**Invoke-RestMethod**旨在从**表述性状态转移**（**REST**）Web服务中检索数据。根据数据类型，PowerShell相应地格式化答案：如果是**JSON**或**XML**文件，则内容以**[PSCustomObject]**形式返回，但也可以检索和返回单个项目，如下例所示：'
- en: '[PRE11]'
  id: totrans-153
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: In this case, the file will not be downloaded; instead, it will be displayed
    as output.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，文件将不会被下载；而是作为输出显示。
- en: '**Start-BitsTransfer**'
  id: totrans-155
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Start-BitsTransfer**'
- en: 'To download a file using **Start-BitsTransfer**, you can use the following
    code snippet:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用**Start-BitsTransfer**下载文件，您可以使用以下代码片段：
- en: '[PRE12]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Make sure you replace **<source>** and **<destination>** appropriately with
    the source of the file and where it should be downloaded, respectively, as shown
    in the following example:'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 确保您适当地替换**<source>**和**<destination>**，分别表示文件的来源和下载位置，如下例所示：
- en: '[PRE13]'
  id: totrans-159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Downloading a file and executing it in memory
  id: totrans-160
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 下载文件并在内存中执行
- en: You want to download a file but rather than saving it to disk, you want to execute
    it in memory.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 您想要下载一个文件，但不是将其保存到磁盘，而是在内存中执行它。
- en: 'Please be aware of the security implications: if you are downloading and executing
    a script that you don’t control, an adversary can replace the content, which can
    cause arbitrary code to be run.'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意安全性影响：如果您下载并执行一个您无法控制的脚本，对手可以替换内容，这可能导致运行任意代码。
- en: It is also important to note that even though an in-memory approach may seem
    more stealthy, it does not guarantee complete stealthiness due to PowerShell’s
    security transparency and excellent event logging.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 还需要注意，即使内存中的方法可能看起来更隐蔽，由于PowerShell的安全透明性和出色的事件记录，它并不能完全保证隐匿性。
- en: Solution
  id: totrans-164
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can achieve this using the following code snippets:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用以下代码片段实现这一点：
- en: '[PRE14]'
  id: totrans-166
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Please note that in this example, we are using **Invoke-WebRequest** to download
    the script, but you can use any other option that lets you download a script as
    well. Using **Invoke-Expression** or its alias, **iex**, you can directly execute
    the script.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，在此示例中，我们使用**Invoke-WebRequest**下载脚本，但您也可以使用任何其他允许您下载脚本的选项。使用**Invoke-Expression**或其别名**iex**，您可以直接执行脚本。
- en: It is even possible to execute a command from the script that was exported when
    running the script.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 甚至可以在运行脚本时执行从脚本中导出的命令。
- en: 'For this example, we will use the **HelloWorld.ps1** script from **Chapter01**:
    [https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1).'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，我们将使用来自**Chapter01**的**HelloWorld.ps1**脚本：[https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1)。
- en: 'The following example shows how you can simply download and execute a file:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例展示了你如何简单地下载并执行文件：
- en: '[PRE15]'
  id: totrans-171
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Using this example, you can download and execute **PowerView** to run the **Get-NetDomain**
    command directly, which comes with **PowerView**:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 使用这个示例，你可以下载并执行**PowerView**，直接运行**Get-NetDomain**命令，该命令包含在**PowerView**中：
- en: '[PRE16]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Downloading and executing a file using COM
  id: totrans-174
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用COM下载并执行文件
- en: You want to download and execute a file from the internet using a COM object.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要通过COM对象从互联网下载并执行文件。
- en: Solution
  id: totrans-176
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'For this example, we will use the **HelloWorld.ps1** script from **Chapter01**:
    [https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-CyberSecurity/master/Chapter01/HelloWorld.ps1).'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，我们将使用来自**Chapter01**的**HelloWorld.ps1**脚本：[https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-CyberSecurity/master/Chapter01/HelloWorld.ps1)。
- en: 'You can use the following code snippet to achieve your goal:'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用以下代码片段来实现你的目标：
- en: '[PRE17]'
  id: totrans-179
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'You can also change the user agent of your request:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 你也可以更改请求的用户代理：
- en: '[PRE18]'
  id: totrans-181
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Simply execute the preceding line before sending your request – of course, modify
    it first to reflect the user agent of your choice.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 只需在发送请求之前执行前面的命令——当然，首先修改它以反映你选择的用户代理。
- en: Downloading and executing a file using .NET classes
  id: totrans-183
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用.NET类下载并执行文件
- en: You want to download and execute a file from the internet using .NET classes.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要使用.NET类从互联网下载并执行文件。
- en: Solution
  id: totrans-185
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'There are multiple ways to download a file using PowerShell cmdlets:'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 使用PowerShell cmdlet下载文件有多种方法：
- en: '**System.Net.WebClient**'
  id: totrans-187
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**System.Net.WebClient**'
- en: 'To download a file using the **System.Net.WebClient** class, you can use the
    following code snippet:'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用**System.Net.WebClient**类下载文件，可以使用以下代码片段：
- en: '[PRE19]'
  id: totrans-189
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: Make sure you replace **<source>** and **<destination>** appropriately with
    the source of the file and where it should be downloaded, respectively.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 确保适当替换**<source>**和**<destination>**，分别为文件的源位置和应该下载到的位置。
- en: 'For this example, we will use the **HelloWorld.ps1** script from **Chapter01**:
    [https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-CyberSecurity/master/Chapter01/HelloWorld.ps1).'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，我们将使用来自**Chapter01**的**HelloWorld.ps1**脚本：[https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-CyberSecurity/master/Chapter01/HelloWorld.ps1)。
- en: 'The following example shows how the **HelloWorld.ps1** script is downloaded
    in the administrator’s **Downloads** folder:'
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例展示了如何将**HelloWorld.ps1**脚本下载到管理员的**下载**文件夹：
- en: '[PRE20]'
  id: totrans-193
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'If you want to execute a file from the internet without actually saving it
    to a file, you can also leverage **DownloadString()**:'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想从互联网执行文件，而不将其实际保存为文件，你还可以使用**DownloadString()**：
- en: '[PRE21]'
  id: totrans-195
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'We can use the following code to execute our script from the GitHub repository:'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用以下代码从GitHub仓库执行我们的脚本：
- en: '[PRE22]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Using this method, it is also possible to change the user agent:'
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 使用这种方法，你还可以更改用户代理：
- en: '[PRE23]'
  id: totrans-199
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: Please note that the user agent needs to be set before *every* request.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，用户代理需要在*每次*请求之前设置。
- en: '**System.Xml.XmlDocument**'
  id: totrans-201
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**System.Xml.XmlDocument**'
- en: You can also load an XML document and execute specific nodes. This is particularly
    useful if the commands in the nodes are encoded.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以加载XML文档并执行特定的节点。这在节点中的命令被编码时特别有用。
- en: 'In this example, we will use an XML file, which you can find in this book’s
    GitHub repository: [https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter08/XmlDocument-Demo.xml](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-CyberSecurity/master/Chapter08/XmlDocument-Demo.xml).'
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，我们将使用一个 XML 文件，你可以在本书的 GitHub 仓库中找到它：[https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter08/XmlDocument-Demo.xml](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-CyberSecurity/master/Chapter08/XmlDocument-Demo.xml)。
- en: 'First, we must load the URL of the XML file in the **$****Xml** variable:'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们必须将 XML 文件的 URL 加载到 **$****Xml** 变量中：
- en: '[PRE24]'
  id: totrans-205
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'Once the XML object is available, you can easily access the nodes and execute
    commands that were saved in the XML file:'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦 XML 对象可用，你可以轻松访问节点并执行保存在 XML 文件中的命令：
- en: '[PRE25]'
  id: totrans-207
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: '**System.NET.WebRequest**'
  id: totrans-208
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**System.NET.WebRequest**'
- en: The best method for downloading and executing a script in memory only is by
    using the **System.NET.WebRequest** class.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 下载并仅在内存中执行脚本的最佳方法是使用 **System.NET.WebRequest** 类。
- en: 'For this example, we will use the **HelloWorld.ps1** script from **Chapter01**:
    [https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-CyberSecurity/master/Chapter01/HelloWorld.ps1).'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这个示例，我们将使用 **第 1 章** 中的 **HelloWorld.ps1** 脚本：[https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/master/Chapter01/HelloWorld.ps1](https://raw.githubusercontent.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-CyberSecurity/master/Chapter01/HelloWorld.ps1)。
- en: 'The following code snippet demonstrates how to create a web request to get
    the content of the **HelloWorld.ps1** script and execute it in memory:'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 以下代码片段展示了如何创建一个 web 请求来获取 **HelloWorld.ps1** 脚本的内容并在内存中执行它：
- en: '[PRE26]'
  id: totrans-212
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'By creating and sending a web request, it is also possible to set a custom
    user agent:'
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 通过创建并发送 web 请求，也可以设置自定义用户代理：
- en: '[PRE27]'
  id: totrans-214
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Executing C# code from PowerShell
  id: totrans-215
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 从 PowerShell 执行 C# 代码
- en: You want to execute your custom C# code from PowerShell.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 你希望从 PowerShell 执行自定义的 C# 代码。
- en: Solution
  id: totrans-217
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'There are various ways to execute C# code from PowerShell. One of them is by
    using the **Add-Type** cmdlet to load and run your own .NET Framework classes:'
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 有多种方法可以从 PowerShell 执行 C# 代码。其中一种方法是使用 **Add-Type** cmdlet 加载并运行你自己的 .NET Framework
    类：
- en: '[PRE28]'
  id: totrans-219
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: In this example, first, I have defined a little C# code snippet in the **$Source**
    variable. By using **Add-Type**, the C# class is loaded into memory. Now, we can
    directly access the C# function using PowerShell without the need to ever compile
    the C# code. By executing **[SayHello]::Main()**, the **Hello World!** string
    will be written to the output.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，我首先在 **$Source** 变量中定义了一个小的 C# 代码片段。通过使用 **Add-Type**，C# 类被加载到内存中。现在，我们可以直接通过
    PowerShell 访问 C# 函数，而无需编译 C# 代码。通过执行 **[SayHello]::Main()**，**Hello World!** 字符串将被写入输出。
- en: There are also other ways to execute C# code from PowerShell. Please refer to
    [*Chapter 6*](B16679_06_Final_PD.xhtml#_idTextAnchor150), *Active Directory –
    Attacks and Mitigation*, for more information.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 还有其他方法可以从 PowerShell 执行 C# 代码。请参阅[*第 6 章*](B16679_06_Final_PD.xhtml#_idTextAnchor150)，*活动目录
    – 攻击与缓解*，了解更多信息。
- en: Persistence
  id: totrans-222
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 持久化
- en: Once a system has been successfully compromised, adversaries want to establish
    persistence so that their malicious code will be automatically executed so that
    they don’t lose control over the system. Various methods can be used to establish
    persistence. We will look at some of them in the following sections.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦系统成功被攻破，攻击者会希望建立持久性，以确保他们的恶意代码会自动执行，从而不会失去对系统的控制。有多种方法可以建立持久性。我们将在接下来的章节中探讨其中的一些方法。
- en: Establishing persistence using the registry
  id: totrans-224
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用注册表建立持久性
- en: You want to ensure that your PowerShell code is automatically executed on startup
    and want to use the registry for this purpose.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 你希望确保你的 PowerShell 代码在启动时自动执行，并希望使用注册表来实现这一目的。
- en: Solution
  id: totrans-226
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can achieve this by creating a registry key in the **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run**
    registry path:'
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过在 **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run**
    注册表路径下创建一个注册表项来实现这一点：
- en: '[PRE29]'
  id: totrans-228
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'This example shows how a registry key can be created to run the **C:\windows\system32\HelloWorld.ps1**
    script while using PowerShell as an autorun script:'
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 这个示例展示了如何创建一个注册表项来运行 **C:\windows\system32\HelloWorld.ps1** 脚本，同时使用 PowerShell
    作为自动运行脚本：
- en: '[PRE30]'
  id: totrans-230
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: The command is stored under **NotSuspiciousAtAll**; whenever autostart is triggered,
    the script is executed using PowerShell in a noninteractive and hidden command
    line that is configured to bypass the execution policy.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令存储在**NotSuspiciousAtAll**下；每当自动启动被触发时，脚本将在 PowerShell 中以非交互和隐藏的命令行执行，并且配置为绕过执行策略。
- en: Establishing persistence using the startup folder
  id: totrans-232
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用启动文件夹建立持久性
- en: You want to establish persistence by using the startup folder. Using this method,
    it is simple to establish persistence but also simple to detect it.
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 你想通过使用启动文件夹来建立持久性。使用这种方法，建立持久性简单，但也容易被检测到。
- en: Solution
  id: totrans-234
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can add your script to one of the following startup folders:'
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以将你的脚本添加到以下启动文件夹之一：
- en: '**$****env:PROGRAMDATA\Microsoft\Windows\Start Menu\Programs\Startup**'
  id: totrans-236
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**$****env:PROGRAMDATA\Microsoft\Windows\Start Menu\Programs\Startup**'
- en: '**$****env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup**'
  id: totrans-237
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**$****env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup**'
- en: '**$****env:ALLUSERSPROFILE\Microsoft\Windows\Start Menu\Programs\StartUp**'
  id: totrans-238
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**$****env:ALLUSERSPROFILE\Microsoft\Windows\Start Menu\Programs\StartUp**'
- en: 'You can download it directly into the startup folder, as shown here:'
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以直接将其下载到启动文件夹中，如下所示：
- en: '[PRE31]'
  id: totrans-240
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'Alternatively, you can create a new file and fill it with content:'
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，你可以创建一个新文件并填充内容：
- en: '[PRE32]'
  id: totrans-242
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: Establishing persistence using scheduled tasks
  id: totrans-243
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用计划任务建立持久性
- en: You want to establish persistence using scheduled tasks.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 你想通过使用计划任务来建立持久性。
- en: Solution
  id: totrans-245
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use **schtasks** to create a scheduled task:'
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用**schtasks**来创建一个计划任务：
- en: '[PRE33]'
  id: totrans-247
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: The **/create** parameter indicates that you want to create a new scheduled
    task. Using **/tn**, you can specify the task name. Red teamers and adversaries
    usually try to pick a name that does not raise suspicion and that would easily
    be overlooked by a blue teamer if they were to investigate it. Using **/tr**,
    you can specify which command should be executed when this scheduled task is being
    run; **/sc** defines when the task is being executed. In this case, the task is
    scheduled every time the system starts up.
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: '**/create** 参数表示你想要创建一个新的计划任务。使用**/tn**，你可以指定任务名称。红队成员和攻击者通常会尝试选择一个不会引起怀疑且如果蓝队调查时容易被忽视的名称。使用**/tr**，你可以指定在执行该计划任务时应运行的命令；**/sc**
    定义任务的执行时间。在这种情况下，任务被设置为每次系统启动时执行。'
- en: Establishing persistence using the PowerShell profile
  id: totrans-249
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用 PowerShell 配置文件建立持久性
- en: You want to establish persistence using the PowerShell profile. This method
    is harder to detect but your script will not run if **-noprofile** is specified
    whenever PowerShell starts, but using this method also means that it doesn’t trigger
    until the user runs PowerShell – which might never happen in many cases.
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
  zh: 你想通过 PowerShell 配置文件来建立持久性。此方法较难被检测到，但如果在 PowerShell 启动时指定了 **-noprofile**，你的脚本将不会运行；然而，使用此方法也意味着它只有在用户运行
    PowerShell 时才会触发——而在很多情况下，用户可能永远不会运行 PowerShell。
- en: Solution
  id: totrans-251
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: PowerShell supports per-user profiles, which means each user has their own profile
    that will be loaded once they initiate a PowerShell session. These profiles are
    usually stored under C:\Users\<USERNAME>\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1.
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 支持每个用户的配置文件，这意味着每个用户都有自己的配置文件，一旦他们启动 PowerShell 会话，就会加载该配置文件。这些配置文件通常存储在
    **C:\Users\<USERNAME>\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1**
    下。
- en: 'If you were to add content to the current user profile, you could use **-Path
    $Profile** and add either your script or your command:'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想将内容添加到当前用户的配置文件中，可以使用 **-Path $Profile** 并添加你的脚本或命令：
- en: 'Add a script to the current profile:'
  id: totrans-254
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将脚本添加到当前配置文件：
- en: '[PRE34]'
  id: totrans-255
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'Add a command to execute the current profile:'
  id: totrans-256
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 添加命令以执行当前配置文件：
- en: '[PRE35]'
  id: totrans-257
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'To add your payload to every user profile on the current host, you could also
    iterate through all user profiles and add your script or command:'
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 要将你的有效负载添加到当前主机的每个用户配置文件中，你还可以遍历所有用户配置文件并添加你的脚本或命令：
- en: '[PRE36]'
  id: totrans-259
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: In this example, first, we’ll look for all PowerShell user profiles in the **C:\User**
    folder to iterate through them and add the **HelloWorld.ps1** script, which is
    located under **C:\windows\system32\**.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，首先，我们会在 **C:\User** 文件夹中查找所有 PowerShell 用户配置文件，遍历它们并添加 **HelloWorld.ps1**
    脚本，该脚本位于 **C:\windows\system32\** 下。
- en: 'Additionally, there is also a global profile that applies to all users on the
    system, which is located under **$PSHOME\Profile.ps1**. **$PSHOME** is an automatic
    variable that contains the path to the directory where PowerShell is installed:'
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，还有一个适用于系统上所有用户的全局配置文件，位于 **$PSHOME\Profile.ps1** 下。**$PSHOME** 是一个自动变量，包含
    PowerShell 安装目录的路径：
- en: '[PRE37]'
  id: totrans-262
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: This command will edit the global profile and add your script to it to be executed
    whenever a PowerShell session on this host is initiated.
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: 这个命令将编辑全局配置文件，并将你的脚本添加进去，以便每次在此主机上启动PowerShell会话时执行。
- en: 'There are several other profiles, depending on the system or scenario. You
    can find more information on profiles in the official documentation: https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_profiles.'
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 根据系统或场景的不同，还有其他几种配置文件。你可以在官方文档中找到有关配置文件的更多信息：https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_profiles。
- en: Establishing persistence using WMI
  id: totrans-265
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用WMI建立持久性
- en: You want to establish persistence by using WMI. This is one of the most covert
    methods and is also provided as a feature in PowerSploit.
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 你希望通过WMI建立持久性。这是最隐蔽的方法之一，也作为PowerSploit中的一项功能提供。
- en: Solution
  id: totrans-267
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: To establish persistence using WMI, you could register a permanent event filter
    and consumer that will run on a system periodically unless they are unregistered.
    This section will show you how this can be achieved.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 要通过WMI建立持久性，可以注册一个永久的事件过滤器和消费者，它们将在系统上定期运行，除非被注销。此部分将展示如何实现这一点。
- en: 'First, create a WMI event filter that specifies the events that need to occur
    to trigger the script to run:'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，创建一个WMI事件过滤器，指定需要发生的事件以触发脚本运行：
- en: '[PRE38]'
  id: totrans-270
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: In this example, the **WMIPersistenceFilter** event filter has been created.
    To create persistence, it is useful to use an event that is guaranteed to occur
    regularly. Therefore, in this example, the event will be triggered whenever the
    system time is *07:00*.
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，已经创建了**WMIPersistenceFilter**事件过滤器。为了建立持久性，使用一个定期触发的事件是非常有用的。因此，在此示例中，事件将在系统时间为*07:00*时触发。
- en: 'Next, create a WMI command-line event consumer. This command is meant to be
    executed whenever the event filter returns data:'
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，创建一个WMI命令行事件消费者。此命令旨在每当事件过滤器返回数据时执行：
- en: '[PRE39]'
  id: totrans-273
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: In our example, the consumer is called **WMIPersistenceConsumer** and it is
    configured to bypass the execution policy and run the **C:\windows\system32\HelloWorld.ps1**
    script.
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的示例中，消费者被称为**WMIPersistenceConsumer**，它的配置是绕过执行策略并运行**C:\windows\system32\HelloWorld.ps1**脚本。
- en: 'Last, but not least, we need to *bind* them both together – that is, the filter
    and the consumer:'
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 最后但同样重要的是，我们需要将它们*绑定*在一起——即，过滤器和消费者：
- en: '[PRE40]'
  id: totrans-276
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: Now that the binding has been created, the PowerShell script will be executed
    every day at 7:00 A.M.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 现在绑定已经创建，PowerShell脚本将每天早上7:00执行。
- en: Establishing persistence using Group Policy Objects
  id: totrans-278
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用组策略对象建立持久性
- en: You compromised the DC and want to establish persistence using **Group Policy
    Objects** (**GPOs**). This has the advantage that GPOs are applied over and over
    again on all configured systems. If the GPO is not removed or altered, your payload
    will always be run on thousands of systems.
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 你已攻破了DC，并希望通过**组策略对象**（**GPOs**）建立持久性。这样做的好处是，GPO会反复应用到所有已配置的系统。如果GPO没有被删除或修改，你的payload将在成千上万的系统上始终执行。
- en: Solution
  id: totrans-280
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You need to create a new GPO that runs your PowerShell script or command on
    startup. This can be done using the **Group Policy Management Console** (**GPMC**)
    or PowerShell. In this example, we are using PowerShell to create the GPO:'
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 你需要创建一个新的GPO，在启动时运行你的PowerShell脚本或命令。这可以通过**组策略管理控制台**（**GPMC**）或PowerShell来完成。在这个示例中，我们使用PowerShell来创建GPO：
- en: '[PRE41]'
  id: totrans-282
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: In this example, we create a GPO named **PersistentScript**. Next, we add a
    Group Policy registry value in the startup folder and configure it to run our
    script via PowerShell (using the **ExecutionPolicy Bypass** parameter) every time
    the system starts. By doing so, the script will run on every system the Group
    Policy applies to at startup, regardless of how the execution policy is configured.
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，我们创建了一个名为**PersistentScript**的GPO。接下来，我们在启动文件夹中添加一个组策略注册表值，并将其配置为每次系统启动时通过PowerShell（使用**ExecutionPolicy
    Bypass**参数）运行我们的脚本。这样，脚本将在组策略应用的每个系统启动时运行，无论执行策略如何配置。
- en: 'Finally, the newly created GPO only needs to be applied to one or more target
    systems. This can be done using the **New-GPLink** cmdlet:'
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，刚创建的GPO只需要应用到一个或多个目标系统。这可以通过**New-GPLink** cmdlet来完成：
- en: '[PRE42]'
  id: totrans-285
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: 'Modifying an existing GPO is also an option that attackers are likely to use
    if the permissions are not restrictive enough. While a newly created GPO might
    raise suspicion, modifying an existing GPO might fall under the radar of the blue
    team:'
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
  zh: 修改现有的 GPO 也是攻击者可能使用的选项，尤其是在权限不够严格的情况下。虽然新创建的 GPO 可能引起怀疑，但修改现有的 GPO 可能会避开蓝队的监控：
- en: '[PRE43]'
  id: totrans-287
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: Note that using GPOs as a method to establish persistence only works if you
    have the appropriate privileges.
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，使用 GPO 作为建立持久性的手段，仅在你拥有适当的权限时有效。
- en: Creating a new user account and adding it to a group
  id: totrans-289
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 创建一个新的用户帐户并将其添加到一个组中
- en: You want to create a new user account and add it to a group.
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: 你想创建一个新的用户帐户并将其添加到一个组中。
- en: Solution
  id: totrans-291
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'There are multiple ways to achieve your goal. You can, for example, use **New-LocalUser**
    in combination with **Add-LocalGroupMember** to create a new user and add it to
    an existing group:'
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: 有多种方法可以实现你的目标。例如，你可以结合使用 **New-LocalUser** 和 **Add-LocalGroupMember** 来创建一个新用户并将其添加到现有组中：
- en: '[PRE44]'
  id: totrans-293
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: 'Alternatively, you can use **net.exe** to succeed:'
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 另外，你可以使用 **net.exe** 来成功实现：
- en: '[PRE45]'
  id: totrans-295
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: Defense evasion
  id: totrans-296
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 防御规避
- en: Usually, red teamers want to avoid being detected and try to hide and obfuscate
    their tracks as much as possible. This phase is known as **defense evasion**.
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，红队成员希望避免被检测到，并尽可能隐藏和混淆他们的踪迹。这一阶段被称为 **防御规避**。
- en: Avoiding creating a window on the desktop
  id: totrans-298
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 避免在桌面上创建窗口
- en: You want to avoid creating PowerShell windows on the user’s desktop when executing
    PowerShell commands and scripts.
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: 你想在执行 PowerShell 命令和脚本时避免在用户桌面上创建 PowerShell 窗口。
- en: Solution
  id: totrans-300
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can achieve this by using **-w hidden** to determine **WindowStyle**, which
    is short for **-WindowStyle**:'
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过使用 **-w hidden** 来设置 **WindowStyle**，它是 **-WindowStyle** 的简写：
- en: '[PRE46]'
  id: totrans-302
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: Executing a Base64-encoded command using powershell.exe
  id: totrans-303
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用 powershell.exe 执行 Base64 编码的命令
- en: You want to supply a Base64-encoded command as a command-line argument.
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
  zh: 你想将一个 Base64 编码的命令作为命令行参数提供。
- en: Solution
  id: totrans-305
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'A Base64-encoded string can be executed in PowerShell using the following syntax:'
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用以下语法在 PowerShell 中执行 Base64 编码的字符串：
- en: '[PRE47]'
  id: totrans-307
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: The **-e** parameter (short for **-EncodedCommand**) allows you to supply a
    Base64-encoded command directly as a command-line argument.
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: '**-e** 参数（**-EncodedCommand** 的简写）允许你直接将 Base64 编码的命令作为命令行参数提供。'
- en: 'Just replace **<Base64 string>** with your Base64-encoded command, as shown
    in the following example:'
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
  zh: 只需将 **<Base64 string>** 替换为你的 Base64 编码命令，如以下示例所示：
- en: '[PRE48]'
  id: totrans-310
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: In this example, the Base64-encoded string would be executed in PowerShell,
    and **“Hello World!”** would be written to the command line. This is because this
    Base64 string translates to **"Write-Host '****Hello World!'"**.
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，Base64 编码的字符串将在 PowerShell 中执行，并且 **“Hello World!”** 会被写入命令行。这是因为这个 Base64
    字符串转换为 **"Write-Host '****Hello World!'"**。
- en: Converting a string into a Base64 string
  id: totrans-312
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 将字符串转换为 Base64 字符串
- en: You want to convert a string into a Base64 string to obfuscate your commands.
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
  zh: 你想将一个字符串转换为 Base64 字符串，以混淆你的命令。
- en: Solution
  id: totrans-314
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can convert a string into a Base64 string by using the following code snippet;
    just replace **<text>** with the string that you want to convert:'
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用以下代码片段将字符串转换为 Base64 字符串；只需将 **<text>** 替换为你想要转换的字符串：
- en: '[PRE49]'
  id: totrans-316
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'The following example would convert the **"Write-Host ''Hello World!''"** string
    into a Base64 string:'
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例将 **"Write-Host 'Hello World!'"** 字符串转换为 Base64 字符串：
- en: '[PRE50]'
  id: totrans-318
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: 'In the preceding example, we converted a Unicode string into a Base64 string.
    It is also possible to convert an ASCII string:'
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
  zh: 在前面的示例中，我们将一个 Unicode 字符串转换为 Base64 字符串。也可以将一个 ASCII 字符串进行转换：
- en: '[PRE51]'
  id: totrans-320
  prefs: []
  type: TYPE_PRE
  zh: '[PRE51]'
- en: Converting a Base64 string into a human-readable string
  id: totrans-321
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 将 Base64 字符串转换为可读字符串
- en: You want to convert a Base64 string back into a human-readable format.
  id: totrans-322
  prefs: []
  type: TYPE_NORMAL
  zh: 你想将 Base64 字符串转换回可读格式。
- en: Solution
  id: totrans-323
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use the following code snippet to convert a Base64 string back into
    a human-readable string. Replace **"<Base64 string>"** with the actual Base64
    string:'
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用以下代码片段将 Base64 字符串转换回可读的字符串。将 **"<Base64 string>"** 替换为实际的 Base64 字符串：
- en: '[PRE52]'
  id: totrans-325
  prefs: []
  type: TYPE_PRE
  zh: '[PRE52]'
- en: 'The following example demonstrates how the **"VwByAGkAdABlAC0ASABvAHMAdAAgACc**
    **ASABlAGwAbABvACAAVwBvAHIAbABkACEAJwA="** string would be translated back into
    a human-readable format:'
  id: totrans-326
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例演示了如何将 **"VwByAGkAdABlAC0ASABvAHMAdAAgACcASABlAGwAbABvACAAVwBvAHIAbABkACEAJwA="**
    字符串转换回可读格式：
- en: '[PRE53]'
  id: totrans-327
  prefs: []
  type: TYPE_PRE
  zh: '[PRE53]'
- en: This would result in the **"Write-Host 'Hello** **World!'"** string.
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
  zh: 这将得到 **"Write-Host 'Hello** **World!'"** 字符串。
- en: 'Often, an ASCII string is encoded into a Base64 string. If you were to use
    Unicode to decode the string, you would not receive the desired output, as shown
    in the following screenshot:'
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，ASCII 字符串会被编码成 Base64 字符串。如果你使用 Unicode 解码该字符串，你将无法获得期望的输出，正如下图所示：
- en: '![Figure 8.2 – If you are not using the correct format, you will get a corrupted
    output](image/B16679_08_002.jpg)'
  id: totrans-330
  prefs: []
  type: TYPE_IMG
  zh: '![图 8.2 – 如果你使用了不正确的格式，将会得到损坏的输出](image/B16679_08_002.jpg)'
- en: Figure 8.2 – If you are not using the correct format, you will get a corrupted
    output
  id: totrans-331
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.2 – 如果你使用了不正确的格式，将会得到损坏的输出
- en: 'Use the following command to convert a Base64 string back into an ASCII string:'
  id: totrans-332
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下命令将 Base64 字符串转换回 ASCII 字符串：
- en: '[PRE54]'
  id: totrans-333
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: This would also result in the **"Write-Host 'Hello** **World!'"** string.
  id: totrans-334
  prefs: []
  type: TYPE_NORMAL
  zh: 这也将导致**"Write-Host 'Hello** **World!'"** 字符串。
- en: Performing a downgrade attack
  id: totrans-335
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 执行降级攻击
- en: You want to bypass security mechanisms such as event logging that were introduced
    with newer PowerShell versions and therefore want to run a downgrade attack.
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
  zh: 你想绕过新版本 PowerShell 中引入的安全机制，如事件日志，因此你想进行降级攻击。
- en: Solution
  id: totrans-337
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'A downgrade attack can be executed by specifying PowerShell’s version number
    when running **powershell.exe**:'
  id: totrans-338
  prefs: []
  type: TYPE_NORMAL
  zh: 通过在运行**powershell.exe**时指定 PowerShell 的版本号，可以执行降级攻击：
- en: '[PRE55]'
  id: totrans-339
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: If the specified version is installed, the command will run while using the
    deprecated binary, which implies that only security features that were already
    introduced to this version are applied.
  id: totrans-340
  prefs: []
  type: TYPE_NORMAL
  zh: 如果指定的版本已安装，则命令将在使用过时的二进制文件时运行，这意味着仅会应用已在该版本中引入的安全功能。
- en: 'If you try to run **powershell.exe -version 2** and you get an error message
    similar to the one shown in the following code snippet, stating that version 2
    of .NET Framework is missing, that means that .NET Framework 2.0 hasn’t been installed
    on the system yet:'
  id: totrans-341
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你尝试运行**powershell.exe -version 2**并且收到类似以下代码片段的错误消息，表示缺少 .NET Framework 2.0
    版本，这意味着 .NET Framework 2.0 尚未安装在系统中：
- en: '[PRE56]'
  id: totrans-342
  prefs: []
  type: TYPE_PRE
  zh: '[PRE56]'
- en: '.NET Framework 2.0 can be installed manually. To evaluate whether PowerShell
    version 2 is enabled or disabled, run the following command:'
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
  zh: .NET Framework 2.0 可以手动安装。要评估 PowerShell 版本 2 是否启用或禁用，请运行以下命令：
- en: '[PRE57]'
  id: totrans-344
  prefs: []
  type: TYPE_PRE
  zh: '[PRE57]'
- en: In this example, it seems like PowerShell version 2 is still enabled on this
    machine. So, if the missing .NET Framework 2.0 were to be installed, this system
    would be vulnerable to a downgrade attack.
  id: totrans-345
  prefs: []
  type: TYPE_NORMAL
  zh: 在此示例中，似乎 PowerShell 版本 2 仍然在此机器上启用。因此，如果缺少的 .NET Framework 2.0 被安装，该系统将容易受到降级攻击。
- en: Disabling Microsoft Defender
  id: totrans-346
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 禁用 Microsoft Defender
- en: You want to disable Microsoft Defender and most of its security features.
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
  zh: 你想禁用 Microsoft Defender 及其大多数安全功能。
- en: Solution
  id: totrans-348
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use **Set-MpPreference** to achieve your goal:'
  id: totrans-349
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用**Set-MpPreference**来实现你的目标：
- en: '[PRE58]'
  id: totrans-350
  prefs: []
  type: TYPE_PRE
  zh: '[PRE58]'
- en: This command disables real-time monitoring, intrusion prevention systems, **Internet
    Outbound AntiVirus** (**IOAV**) protection, and script scanning. It sets network
    protection to Audit Mode only (so that it’s not enforced any longer), disables
    **Microsoft Active Protection Service** (**MAPS**) reporting, sets the consent
    to never send samples, and disables controlled folder access. The **-Force** parameter
    ensures that the changes are applied without additional prompts.
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令禁用实时监控、入侵防御系统、**Internet Outbound AntiVirus**（**IOAV**）保护和脚本扫描。它将网络保护设置为仅审核模式（因此不再强制执行），禁用**Microsoft
    Active Protection Service**（**MAPS**）报告，将同意设置为永不发送样本，并禁用受控文件夹访问。**-Force** 参数确保在没有额外提示的情况下应用这些更改。
- en: 'Please refer to the **Set-MpPreference** documentation if you want to tamper
    with features other than the ones shown in this example: https://learn.microsoft.com/en-us/powershell/module/defender/set-mppreference.'
  id: totrans-352
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想篡改本示例中未显示的其他功能，请参阅**Set-MpPreference**文档：https://learn.microsoft.com/en-us/powershell/module/defender/set-mppreference。
- en: Clearing logs
  id: totrans-353
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 清除日志
- en: You want to clear all event logs, regardless of which PowerShell version is
    deployed on the target system.
  id: totrans-354
  prefs: []
  type: TYPE_NORMAL
  zh: 无论目标系统上部署的是哪个 PowerShell 版本，你都希望清除所有事件日志。
- en: Solution
  id: totrans-355
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can clear all event logs by using the following code snippet:'
  id: totrans-356
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用以下代码片段清除所有事件日志：
- en: '[PRE59]'
  id: totrans-357
  prefs: []
  type: TYPE_PRE
  zh: '[PRE59]'
- en: Credential access
  id: totrans-358
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 凭证访问
- en: The credential access phase is all about stealing credentials (for example,
    usernames and passwords). Those credentials can be used later to move laterally
    and authenticate against other targets.
  id: totrans-359
  prefs: []
  type: TYPE_NORMAL
  zh: 凭证访问阶段是关于窃取凭证（例如用户名和密码）的。这些凭证稍后可以用来进行横向移动并在其他目标上进行身份验证。
- en: Exfiltrating the ntds.dit file
  id: totrans-360
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 导出 ntds.dit 文件
- en: You want to exfiltrate the **ntds.dit** file, which contains all identities
    and hashes within Active Directory.
  id: totrans-361
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要窃取包含所有身份和哈希值的**ntds.dit**文件，这些信息存在于Active Directory中。
- en: Solution
  id: totrans-362
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'As the **ntds.dit** file is constantly used by Active Directory and therefore
    locked, you need to find a way to access **ntds.dit**. One way is to create a
    shadow copy, create a symbolic link, and extract the file from it:'
  id: totrans-363
  prefs: []
  type: TYPE_NORMAL
  zh: 由于**ntds.dit**文件被Active Directory不断使用并因此被锁定，你需要找到访问**ntds.dit**的方法。一种方法是创建影像副本，创建符号链接，并从中提取该文件：
- en: '[PRE60]'
  id: totrans-364
  prefs: []
  type: TYPE_PRE
  zh: '[PRE60]'
- en: 'You can now access the **ntds.dit** file without errors and either extract
    it or proceed with extracting identities. In this example, we will simply copy
    it to **C:\tmp** for further use:'
  id: totrans-365
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你可以无错误地访问**ntds.dit**文件，并提取它或继续提取身份。在这个示例中，我们将其复制到**C:\tmp**以供进一步使用：
- en: '[PRE61]'
  id: totrans-366
  prefs: []
  type: TYPE_PRE
  zh: '[PRE61]'
- en: 'Once you’ve done this, you can delete the symbolic link and proceed with your
    penetration test:'
  id: totrans-367
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦完成此操作，你可以删除符号链接并继续进行渗透测试：
- en: '[PRE62]'
  id: totrans-368
  prefs: []
  type: TYPE_PRE
  zh: '[PRE62]'
- en: Discovery
  id: totrans-369
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 发现阶段
- en: 'The discovery phase is similar to the reconnaissance phase: its goal is to
    gather as much information as possible about potential targets. The discovery
    phase usually occurs after a red teamer has gained access to a system and plans
    their next steps.'
  id: totrans-370
  prefs: []
  type: TYPE_NORMAL
  zh: 发现阶段类似于侦察阶段：其目标是收集尽可能多的关于潜在目标的信息。发现阶段通常发生在红队员已获得系统访问权限并规划下一步时。
- en: Finding out which user is currently logged on
  id: totrans-371
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 查找当前登录的用户
- en: You want to find out which user is currently logged on and want to display their
    username and domain (or computer name if it’s a local account).
  id: totrans-372
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要查找当前登录的用户，并显示他们的用户名和域名（如果是本地账户，则显示计算机名）。
- en: Solution
  id: totrans-373
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To achieve your goal, you can use the **whoami** command:'
  id: totrans-374
  prefs: []
  type: TYPE_NORMAL
  zh: 为了实现你的目标，你可以使用**whoami**命令：
- en: '[PRE63]'
  id: totrans-375
  prefs: []
  type: TYPE_PRE
  zh: '[PRE63]'
- en: Enumerating users (local and domain)
  id: totrans-376
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 枚举用户（本地和域）
- en: You want to find out which user accounts exist on the current system or in the
    current domain.
  id: totrans-377
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要查找当前系统或当前域中存在的用户账户。
- en: Solution
  id: totrans-378
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: Depending on your goal, there are multiple ways to enumerate users.
  id: totrans-379
  prefs: []
  type: TYPE_NORMAL
  zh: 根据你的目标，有多种方法可以枚举用户。
- en: 'You can use WMI/CIM to enumerate all users, regardless of whether they are
    local or domain users:'
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用WMI/CIM枚举所有用户，无论他们是本地用户还是域用户：
- en: '[PRE64]'
  id: totrans-381
  prefs: []
  type: TYPE_PRE
  zh: '[PRE64]'
- en: 'To enumerate local users only, you can use **Get-LocalUser** or **net users**:'
  id: totrans-382
  prefs: []
  type: TYPE_NORMAL
  zh: 为了仅枚举本地用户，你可以使用**Get-LocalUser**或**net users**：
- en: '[PRE65]'
  id: totrans-383
  prefs: []
  type: TYPE_PRE
  zh: '[PRE65]'
- en: 'There are multiple ways to enumerate domain users only. If the **ActiveDirectory**
    module is present, you can use **Get-ADUser**:'
  id: totrans-384
  prefs: []
  type: TYPE_NORMAL
  zh: 有多种方法仅枚举域用户。如果存在**ActiveDirectory**模块，你可以使用**Get-ADUser**：
- en: '[PRE66]'
  id: totrans-385
  prefs: []
  type: TYPE_PRE
  zh: '[PRE66]'
- en: 'But in most cases, the **ActiveDirectory** module will not be present, so you
    can leverage **adsisearcher** to enumerate all domain users instead:'
  id: totrans-386
  prefs: []
  type: TYPE_NORMAL
  zh: 但在大多数情况下，**ActiveDirectory**模块不会存在，所以你可以利用**adsisearcher**枚举所有域用户：
- en: '[PRE67]'
  id: totrans-387
  prefs: []
  type: TYPE_PRE
  zh: '[PRE67]'
- en: 'It is also possible to use **net** to enumerate all domain users:'
  id: totrans-388
  prefs: []
  type: TYPE_NORMAL
  zh: 也可以使用**net**来枚举所有域用户：
- en: '[PRE68]'
  id: totrans-389
  prefs: []
  type: TYPE_PRE
  zh: '[PRE68]'
- en: Enumerating groups (local and domain)
  id: totrans-390
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 枚举组（本地和域）
- en: You want to find out which local or domain groups exist.
  id: totrans-391
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要查找存在的本地组或域组。
- en: Solution
  id: totrans-392
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: Depending on whether you want to enumerate local or domain groups, there are
    multiple ways to achieve your goal.
  id: totrans-393
  prefs: []
  type: TYPE_NORMAL
  zh: 根据你是想枚举本地组还是域组，有多种方法可以实现你的目标。
- en: 'You can use WMI/CIM to enumerate all groups, regardless of whether they are
    local or domain groups:'
  id: totrans-394
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用WMI/CIM枚举所有组，无论它们是本地组还是域组：
- en: '[PRE69]'
  id: totrans-395
  prefs: []
  type: TYPE_PRE
  zh: '[PRE69]'
- en: 'To enumerate local groups only, you can use **Get-LocalGroup** or **net localgroups**:'
  id: totrans-396
  prefs: []
  type: TYPE_NORMAL
  zh: 为了仅枚举本地组，你可以使用**Get-LocalGroup**或**net localgroups**：
- en: '[PRE70]'
  id: totrans-397
  prefs: []
  type: TYPE_PRE
  zh: '[PRE70]'
- en: 'There are multiple ways to enumerate domain users only. If the **ActiveDirectory**
    module is present, you can use **Get-ADGroup**:'
  id: totrans-398
  prefs: []
  type: TYPE_NORMAL
  zh: 有多种方法仅枚举域用户。如果存在**ActiveDirectory**模块，你可以使用**Get-ADGroup**：
- en: '[PRE71]'
  id: totrans-399
  prefs: []
  type: TYPE_PRE
  zh: '[PRE71]'
- en: 'Since this is not the case most of the time, you can also leverage **net**
    to find out which domain groups exist:'
  id: totrans-400
  prefs: []
  type: TYPE_NORMAL
  zh: 由于大多数情况下并非如此，你也可以利用**net**来查找存在的域组：
- en: '[PRE72]'
  id: totrans-401
  prefs: []
  type: TYPE_PRE
  zh: '[PRE72]'
- en: 'You can also use **adsisearcher** to enumerate all domain groups, as shown
    in the following code snippet:'
  id: totrans-402
  prefs: []
  type: TYPE_NORMAL
  zh: 你也可以使用**adsisearcher**枚举所有域组，如下所示的代码片段所示：
- en: '[PRE73]'
  id: totrans-403
  prefs: []
  type: TYPE_PRE
  zh: '[PRE73]'
- en: Retrieving information about the current system
  id: totrans-404
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 获取当前系统的信息
- en: You want to retrieve information about the current system.
  id: totrans-405
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要获取当前系统的信息。
- en: Solution
  id: totrans-406
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'Using the **hostname** command, you can find out the hostname of the current
    machine:'
  id: totrans-407
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**hostname**命令，你可以查找当前机器的主机名：
- en: '[PRE74]'
  id: totrans-408
  prefs: []
  type: TYPE_PRE
  zh: '[PRE74]'
- en: 'By using the **systeminfo** command, you can retrieve detailed system configuration
    information about the current machine:'
  id: totrans-409
  prefs: []
  type: TYPE_NORMAL
  zh: 通过使用**systeminfo**命令，你可以检索当前机器的详细系统配置信息：
- en: '[PRE75]'
  id: totrans-410
  prefs: []
  type: TYPE_PRE
  zh: '[PRE75]'
- en: '**Systeminfo** lets you collect various pieces of information about the current
    system, such as hardware properties, the current operating system version, hostname,
    BIOS version, boot time, and much more valuable information.'
  id: totrans-411
  prefs: []
  type: TYPE_NORMAL
  zh: '**Systeminfo** 让你收集有关当前系统的各种信息，如硬件属性、当前操作系统版本、主机名、BIOS 版本、启动时间等有价值的信息。'
- en: Enumerating network-related information
  id: totrans-412
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 枚举与网络相关的信息
- en: You want to learn more about the network-related information of the current
    system. What is its IP address and which other devices are connected to the current
    machine?
  id: totrans-413
  prefs: []
  type: TYPE_NORMAL
  zh: 你想了解当前系统的网络相关信息。它的 IP 地址是什么？还有哪些其他设备与当前机器连接？
- en: Solution
  id: totrans-414
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use the following commands to enumerate network-related information:'
  id: totrans-415
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用以下命令来枚举与网络相关的信息：
- en: '[PRE76]'
  id: totrans-416
  prefs: []
  type: TYPE_PRE
  zh: '[PRE76]'
- en: '**ipconfig /all** displays detailed information about all network interfaces
    (including IP addresses, subnet masks, default gateways, DNS servers, and more)
    configured on the system:'
  id: totrans-417
  prefs: []
  type: TYPE_NORMAL
  zh: '**ipconfig /all** 显示有关系统上所有网络接口的详细信息（包括 IP 地址、子网掩码、默认网关、DNS 服务器等）：'
- en: '[PRE77]'
  id: totrans-418
  prefs: []
  type: TYPE_PRE
  zh: '[PRE77]'
- en: 'Using **Get-NetAdapter**, you can retrieve information about network adapters
    and their properties, such as their interface index, name, MAC address, and more:'
  id: totrans-419
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**Get-NetAdapter**，你可以检索网络适配器及其属性的信息，如接口索引、名称、MAC 地址等：
- en: '[PRE78]'
  id: totrans-420
  prefs: []
  type: TYPE_PRE
  zh: '[PRE78]'
- en: '**route print** displays the routing table on the system and shows the network
    destinations, associated gateway addresses, and interface information:'
  id: totrans-421
  prefs: []
  type: TYPE_NORMAL
  zh: '**route print** 显示系统的路由表，展示网络目标、相关的网关地址以及接口信息：'
- en: '[PRE79]'
  id: totrans-422
  prefs: []
  type: TYPE_PRE
  zh: '[PRE79]'
- en: '**arp -a** displays the **Address Resolution Protocol** (**ARP**) cache, which
    contains mappings of IP addresses to MAC addresses for devices on the local network.
    By doing this, you can easily find out potential targets for lateral movement.'
  id: totrans-423
  prefs: []
  type: TYPE_NORMAL
  zh: '**arp -a** 显示**地址解析协议**（**ARP**）缓存，其中包含将 IP 地址映射到本地网络设备的 MAC 地址。通过这样做，你可以轻松发现潜在的横向移动目标。'
- en: Enumerating domain information
  id: totrans-424
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 枚举域信息
- en: You want to enumerate the current domain and want to find out more about the
    forest and the domain and forest trusts.
  id: totrans-425
  prefs: []
  type: TYPE_NORMAL
  zh: 你想枚举当前域并了解更多关于林和域与林的信任关系的信息。
- en: Solution
  id: totrans-426
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can leverage the **System.DirectoryServices.ActiveDirectory** namespace
    to enumerate the current domain and forest:'
  id: totrans-427
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以利用**System.DirectoryServices.ActiveDirectory**命名空间来枚举当前域和林：
- en: '[PRE80]'
  id: totrans-428
  prefs: []
  type: TYPE_PRE
  zh: '[PRE80]'
- en: 'The **GetCurrentDomain()** command retrieves the current domain object in Active
    Directory and returns information such as the domain name, domain controllers,
    and other properties:'
  id: totrans-429
  prefs: []
  type: TYPE_NORMAL
  zh: '**GetCurrentDomain()** 命令检索 Active Directory 中的当前域对象，并返回域名、域控制器以及其他属性的信息：'
- en: '[PRE81]'
  id: totrans-430
  prefs: []
  type: TYPE_PRE
  zh: '[PRE81]'
- en: 'The **GetCurrentDomain()).GetAllTrustRelationships()** command retrieves all
    trust relationships established by the current domain in Active Directory, providing
    information about trusted domains and their properties:'
  id: totrans-431
  prefs: []
  type: TYPE_NORMAL
  zh: '**GetCurrentDomain()).GetAllTrustRelationships()** 命令检索当前域在 Active Directory
    中建立的所有信任关系，并提供受信任域及其属性的信息：'
- en: '[PRE82]'
  id: totrans-432
  prefs: []
  type: TYPE_PRE
  zh: '[PRE82]'
- en: 'The **GetCurrentForest()** command retrieves the current forest object in Active
    Directory and returns information such as the forest name, domain trees, and other
    properties:'
  id: totrans-433
  prefs: []
  type: TYPE_NORMAL
  zh: '**GetCurrentForest()** 命令检索 Active Directory 中的当前林对象，并返回林名、域树和其他属性的信息：'
- en: '[PRE83]'
  id: totrans-434
  prefs: []
  type: TYPE_PRE
  zh: '[PRE83]'
- en: The preceding command retrieves all trust relationships for a specific forest
    in Active Directory and provides information about trusted domains within that
    forest, as well as their properties.
  id: totrans-435
  prefs: []
  type: TYPE_NORMAL
  zh: 前面的命令检索特定林中所有的信任关系，并提供有关该林内受信任域及其属性的信息。
- en: Enumerating domain controllers (DCs)
  id: totrans-436
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 枚举域控制器（DC）
- en: You want to enumerate the DCs of a domain and find out which DC was used for
    the current authenticated session.
  id: totrans-437
  prefs: []
  type: TYPE_NORMAL
  zh: 你想枚举一个域的 DC，并找出当前认证会话使用的是哪个 DC。
- en: Solution
  id: totrans-438
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use **nltest** to query and list all DCs available in the specified
    domain:'
  id: totrans-439
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用**nltest**查询并列出指定域中所有可用的 DC：
- en: '[PRE84]'
  id: totrans-440
  prefs: []
  type: TYPE_PRE
  zh: '[PRE84]'
- en: 'To retrieve and display a list of all DCs in the current domain, use the following
    command:'
  id: totrans-441
  prefs: []
  type: TYPE_NORMAL
  zh: 要检索并显示当前域中所有 DC 的列表，请使用以下命令：
- en: '[PRE85]'
  id: totrans-442
  prefs: []
  type: TYPE_PRE
  zh: '[PRE85]'
- en: 'To determine which DC was used to authenticate the current session, run the
    following command:'
  id: totrans-443
  prefs: []
  type: TYPE_NORMAL
  zh: 要确定用于验证当前会话的 DC，请运行以下命令：
- en: '[PRE86]'
  id: totrans-444
  prefs: []
  type: TYPE_PRE
  zh: '[PRE86]'
- en: Listing installed antivirus (AV) products
  id: totrans-445
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 列出已安装的防病毒（AV）产品
- en: You want to list all AV products that were installed on the current system.
  id: totrans-446
  prefs: []
  type: TYPE_NORMAL
  zh: 你想列出当前系统上安装的所有 AV 产品。
- en: Solution
  id: totrans-447
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can enumerate all installed AV products by using WMI/CIM:'
  id: totrans-448
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用 WMI/CIM 枚举所有已安装的 AV 产品：
- en: '[PRE87]'
  id: totrans-449
  prefs: []
  type: TYPE_PRE
  zh: '[PRE87]'
- en: Lateral movement
  id: totrans-450
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 横向移动
- en: Once an initial foothold has been achieved, a red teamer usually tries to move
    laterally from one host to another, exploring and exploiting additional targets
    within the network. Lateral movement allows the attacker to explore the network,
    escalate privileges, access valuable resources, and ultimately gain control over
    critical systems or data.
  id: totrans-451
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦获得初步控制，红队通常会尝试从一个主机横向移动到另一个主机，探索并利用网络中的其他目标。横向移动使攻击者能够探索网络、提升权限、访问有价值的资源，并最终控制关键系统或数据。
- en: Executing a single command or binary on a remote machine
  id: totrans-452
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 在远程机器上执行单个命令或二进制文件
- en: You want to execute a single command or binary on a remote machine.
  id: totrans-453
  prefs: []
  type: TYPE_NORMAL
  zh: 你想在远程机器上执行单个命令或二进制文件。
- en: Solution
  id: totrans-454
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To execute a single command or binary on a remote (or local) machine, you can
    leverage **Invoke-Command**:'
  id: totrans-455
  prefs: []
  type: TYPE_NORMAL
  zh: 要在远程（或本地）机器上执行单个命令或二进制文件，可以利用**Invoke-Command**：
- en: '[PRE88]'
  id: totrans-456
  prefs: []
  type: TYPE_PRE
  zh: '[PRE88]'
- en: 'The following example shows how you can execute the **Get-Process** cmdlet,
    as well as the **mimikatz.exe** binary, on the remote host, **PSSec-PC01**:'
  id: totrans-457
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例展示了如何在远程主机**PSSec-PC01**上执行**Get-Process** cmdlet和**mimikatz.exe**二进制文件：
- en: '[PRE89]'
  id: totrans-458
  prefs: []
  type: TYPE_PRE
  zh: '[PRE89]'
- en: If you want to use **Invoke-Command** against an IP address, ensure that the
    remote host’s IP is present in **TrustedHosts** and is configured for remote access.
  id: totrans-459
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想对一个IP地址使用**Invoke-Command**，确保远程主机的IP已出现在**TrustedHosts**中，并且已配置为远程访问。
- en: Initiating a remote interactive PowerShell session
  id: totrans-460
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 启动远程交互式PowerShell会话
- en: You want to initiate a remote PowerShell session in which you can interactively
    run PowerShell commands.
  id: totrans-461
  prefs: []
  type: TYPE_NORMAL
  zh: 你想启动一个远程PowerShell会话，在该会话中你可以交互式地运行PowerShell命令。
- en: Solution
  id: totrans-462
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can use **Enter-PSSession** to initiate an interactive remote PowerShell
    session:'
  id: totrans-463
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用**Enter-PSSession**来启动一个交互式远程PowerShell会话：
- en: '[PRE90]'
  id: totrans-464
  prefs: []
  type: TYPE_PRE
  zh: '[PRE90]'
- en: 'In this case, we would establish a PowerShell session to the remote host, **PSSec-PC01**:'
  id: totrans-465
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，我们将建立到远程主机**PSSec-PC01**的PowerShell会话：
- en: '[PRE91]'
  id: totrans-466
  prefs: []
  type: TYPE_PRE
  zh: '[PRE91]'
- en: Command and Control (C2)
  id: totrans-467
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 命令与控制（C2）
- en: In this phase, the red teamer is trying to communicate with its victim hosts
    to control them.
  id: totrans-468
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个阶段，红队员正在尝试与受害主机进行通信以控制它们。
- en: Opening a reverse shell
  id: totrans-469
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 打开反向Shell
- en: You want to open a reverse shell on a remote system.
  id: totrans-470
  prefs: []
  type: TYPE_NORMAL
  zh: 你想在远程系统上打开一个反向Shell。
- en: A reverse shell is a shell that a red teamer can use to establish a connection
    to a remote system without the need to initiate a remote session. In the case
    of a reverse shell, usually, a payload is somehow stored on the victim system.
    Once the payload is executed, the victim establishes the connection back to the
    server that was specified by the red teamer, on which usually a listener is listening
    for incoming connections.
  id: totrans-471
  prefs: []
  type: TYPE_NORMAL
  zh: 反向Shell是红队员用来建立连接到远程系统的Shell，无需发起远程会话。在反向Shell的情况下，通常会在受害者系统上存储一个有效负载。一旦该有效负载被执行，受害者会建立到由红队员指定的服务器的连接，通常在该服务器上有一个监听器等待传入的连接。
- en: Solution
  id: totrans-472
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To reproduce this using PowerShell, first, create and start a listener on your
    C2 server:'
  id: totrans-473
  prefs: []
  type: TYPE_NORMAL
  zh: 要通过PowerShell重现此操作，首先在C2服务器上创建并启动监听器：
- en: '[PRE92]'
  id: totrans-474
  prefs: []
  type: TYPE_PRE
  zh: '[PRE92]'
- en: Once the listener has been started, it waits for a connection, which it accepts
    immediately, and stores the session in the **$****client** variable.
  id: totrans-475
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦监听器启动，它会等待连接，并立即接受连接，并将会话存储在**$****client**变量中。
- en: 'Have the **victim machine** execute your payload. This could look something
    like this:'
  id: totrans-476
  prefs: []
  type: TYPE_NORMAL
  zh: 让**受害者机器**执行你的有效负载。可能会是这样的形式：
- en: '[PRE93]'
  id: totrans-477
  prefs: []
  type: TYPE_PRE
  zh: '[PRE93]'
- en: This code creates a new TCP socket, connects to the server on the **172.29.0.20**
    IP address on port **4444**, and waits for input once connected. The client can
    now either read incoming commands or write to the command line.
  id: totrans-478
  prefs: []
  type: TYPE_NORMAL
  zh: 这段代码创建一个新的TCP套接字，连接到**172.29.0.20** IP地址上的**4444**端口，一旦连接成功，它会等待输入。客户端现在可以读取传入的命令或写入命令行。
- en: 'Again, on the C2 server, you can now send commands over the stream:'
  id: totrans-479
  prefs: []
  type: TYPE_NORMAL
  zh: 再次，在C2服务器上，你现在可以通过流发送命令：
- en: '[PRE94]'
  id: totrans-480
  prefs: []
  type: TYPE_PRE
  zh: '[PRE94]'
- en: 'Once the connection needs to be terminated, just send the following command
    from the C2 server:'
  id: totrans-481
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦需要终止连接，只需从C2服务器发送以下命令：
- en: '[PRE95]'
  id: totrans-482
  prefs: []
  type: TYPE_PRE
  zh: '[PRE95]'
- en: 'You can find this code in this chapter’s GitHub repository:'
  id: totrans-483
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在本章的GitHub仓库中找到这段代码：
- en: 'Client: [https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/RevShell_Client.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/RevShell_Client.ps1)'
  id: totrans-484
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 客户端：[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/RevShell_Client.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/RevShell_Client.ps1)
- en: 'Server: [https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/RevShell_Server.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/RevShell_Server.ps1)'
  id: totrans-485
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 服务器：[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/RevShell_Server.ps1](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/RevShell_Server.ps1)
- en: Of course, there are also tools such as PowerShell Empire and Metasploit that
    already have modules to generate payloads automatically and open a reverse shell.
  id: totrans-486
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，也有一些工具，如 PowerShell Empire 和 Metasploit，已经有模块可以自动生成有效负载并打开反向 shell。
- en: Exfiltration
  id: totrans-487
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 导出
- en: In the exfiltration phase, the red teamer tries to steal and exfiltrate data
    from the victim’s network.
  id: totrans-488
  prefs: []
  type: TYPE_NORMAL
  zh: 在导出阶段，红队员尝试从受害者的网络中窃取并导出数据。
- en: Exfiltrating a file and uploading it to a web server
  id: totrans-489
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 导出文件并将其上传到 Web 服务器
- en: You want to exfiltrate the content of a file and upload it to a web server.
  id: totrans-490
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要导出一个文件的内容并将其上传到 Web 服务器。
- en: Solution
  id: totrans-491
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can achieve your goal by reading the bytes of the desired file, converting
    them into a **Base64** string, and uploading them to a web server using **Invoke-WebRequest**:'
  id: totrans-492
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过读取目标文件的字节，将它们转换为**Base64**字符串，并使用**Invoke-WebRequest**将其上传到 Web 服务器来实现目标：
- en: '[PRE96]'
  id: totrans-493
  prefs: []
  type: TYPE_PRE
  zh: '[PRE96]'
- en: In this example, we are uploading the Base64-encoded **ntds.dit** file that
    we extracted earlier as a shadow copy to **http://PSSec-example.com/upload** (which
    does not exist; we just made up for this example).
  id: totrans-494
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，我们将之前提取的Base64编码的**ntds.dit**文件作为影像副本上传到**http://PSSec-example.com/upload**（该网址并不存在，我们只是为了这个示例虚构的）。
- en: 'It is also possible to use the **System.NET.WebClient** class to extract and
    upload a file. The following code snippet demonstrates how this could be achieved:'
  id: totrans-495
  prefs: []
  type: TYPE_NORMAL
  zh: 也可以使用**System.NET.WebClient**类来提取和上传文件。以下代码片段展示了如何实现这一目标：
- en: '[PRE97]'
  id: totrans-496
  prefs: []
  type: TYPE_PRE
  zh: '[PRE97]'
- en: Impact
  id: totrans-497
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 影响
- en: Recipes in the impact phase are determined to cause mayhem; the red teamer is
    trying to interrupt, destroy, or manipulate systems or data.
  id: totrans-498
  prefs: []
  type: TYPE_NORMAL
  zh: 影响阶段的配方旨在引发混乱；红队员试图中断、破坏或操控系统或数据。
- en: Stopping a service
  id: totrans-499
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 停止服务
- en: You want to stop a service.
  id: totrans-500
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要停止一个服务。
- en: Solution
  id: totrans-501
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'To do this, you can use the **Stop-Service** cmdlet:'
  id: totrans-502
  prefs: []
  type: TYPE_NORMAL
  zh: 为此，你可以使用**Stop-Service** cmdlet：
- en: '[PRE98]'
  id: totrans-503
  prefs: []
  type: TYPE_PRE
  zh: '[PRE98]'
- en: If executed, the preceding command would stop the **Spooler** service. By using
    the **-Force** parameter, the service will be stopped abruptly without prompting
    for confirmation.
  id: totrans-504
  prefs: []
  type: TYPE_NORMAL
  zh: 如果执行该命令，之前的命令将停止**Spooler**服务。使用**-Force**参数时，服务将会在没有确认提示的情况下被强制停止。
- en: Shutting down a system
  id: totrans-505
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 关闭系统
- en: You want to shut down a system.
  id: totrans-506
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要关闭系统。
- en: Solution
  id: totrans-507
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 解决方案
- en: 'You can achieve your goal using several methods. One of them is by using the
    **Stop-Computer** cmdlet:'
  id: totrans-508
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过多种方法来实现你的目标。其中一种方法是使用**Stop-Computer** cmdlet：
- en: '[PRE99]'
  id: totrans-509
  prefs: []
  type: TYPE_PRE
  zh: '[PRE99]'
- en: Using the **-ComputerName** parameter, you can specify whether the local or
    a remote host should be shut down.
  id: totrans-510
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**-ComputerName**参数，你可以指定是否要关闭本地计算机或远程主机。
- en: 'You can also use the **shutdown** command:'
  id: totrans-511
  prefs: []
  type: TYPE_NORMAL
  zh: 你也可以使用**shutdown**命令：
- en: '[PRE100]'
  id: totrans-512
  prefs: []
  type: TYPE_PRE
  zh: '[PRE100]'
- en: The **/s** parameter indicates that the system will be shut down. The **/t**
    parameter indicates how many seconds will pass until the command is executed.
    In this case, the system is shut down immediately.
  id: totrans-513
  prefs: []
  type: TYPE_NORMAL
  zh: '**/s**参数表示系统将关闭。**/t**参数表示命令执行前会经过多少秒。在此案例中，系统会立即关闭。'
- en: Summary
  id: totrans-514
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, you learned about the different phases of an attack. You were
    provided with an overview of common PowerShell red team tools and were presented
    with a red team cookbook, which can help you during your next red team engagements.
  id: totrans-515
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你学习了攻击的不同阶段。你了解到了一些常见的 PowerShell 红队工具，并获得了一本红队食谱，可以帮助你在下次红队演习中使用。
- en: This red team cookbook contained many helpful code snippets that helped you
    learn about a bunch of important options when using **powershell.exe**, how to
    create obfuscation using Base64, how to download files, and how to execute scripts
    in memory only. You were reminded of how to execute commands on remote machines,
    as well as how to open a session.
  id: totrans-516
  prefs: []
  type: TYPE_NORMAL
  zh: 这本红队食谱包含了许多有用的代码片段，帮助你了解使用**powershell.exe**时的一些重要选项，如何使用Base64进行混淆，如何下载文件，以及如何只在内存中执行脚本。它还提醒你如何在远程机器上执行命令，以及如何打开会话。
- en: We looked at several options regarding how persistence can be established using
    PowerShell and how a downgrade attack can be performed. You also got a refresher
    on how in-memory injection works and how to open a reverse shell without any of
    the common red teaming tools. Last but not least, you learned how to clear logs.
  id: totrans-517
  prefs: []
  type: TYPE_NORMAL
  zh: 我们查看了如何使用PowerShell建立持久性以及如何执行降级攻击的几种选项。你还复习了内存注入的工作原理，以及如何在没有任何常见红队工具的情况下打开反向
    shell。最后，你学会了如何清除日志。
- en: Now that we’ve explored various red teamer tasks and recipes, in the next chapter,
    we’ll explore blue team and infosec practitioner tasks and recipes.
  id: totrans-518
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经探讨了各种红队任务和方案，在下一章中，我们将探讨蓝队和信息安全从业者的任务和方案。
- en: Further reading
  id: totrans-519
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 进一步阅读
- en: 'If you want to explore some of the topics that were mentioned in this chapter,
    take a look at these resources:'
  id: totrans-520
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想探索本章中提到的某些话题，可以查看以下资源：
- en: '**Abusing WMI to build a persistent asynchronous and** **fileless backdoor**:'
  id: totrans-521
  prefs: []
  type: TYPE_NORMAL
  zh: '**滥用WMI建立持久性异步无文件后门**：'
- en: https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf
  id: totrans-522
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf
- en: https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor.pdf
  id: totrans-523
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor.pdf
- en: '**New-GPLink**:'
  id: totrans-524
  prefs: []
  type: TYPE_NORMAL
  zh: '**New-GPLink**：'
- en: https://learn.microsoft.com/en-us/powershell/module/grouppolicy/new-gplink
  id: totrans-525
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: https://learn.microsoft.com/en-us/powershell/module/grouppolicy/new-gplink
- en: '**PowerUpSQL**:'
  id: totrans-526
  prefs: []
  type: TYPE_NORMAL
  zh: '**PowerUpSQL**：'
- en: https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet
  id: totrans-527
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet
- en: https://github.com/NetSPI/PowerUpSQL/wiki
  id: totrans-528
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: https://github.com/NetSPI/PowerUpSQL/wiki
- en: 'You can find all the links mentioned in this chapter in the GitHub repository
    for [*Chapter 8*](B16679_08_Final_PD.xhtml#_idTextAnchor204) – there’s no need
    to manually type in every link: [https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/Links.md](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/Links.md).'
  id: totrans-529
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在GitHub仓库的[*第8章*](B16679_08_Final_PD.xhtml#_idTextAnchor204)中找到本章提到的所有链接，无需手动输入每个链接：[https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/Links.md](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity/blob/master/Chapter08/Links.md)。
