- en: '14'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '14'
- en: Command and Control
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 命令与控制
- en: In the ever-evolving landscape of cybersecurity, harnessing the power of PowerShell
    has become a cornerstone in the toolkit of penetration testers seeking to replicate
    real-world scenarios. This chapter delves into the art and science of utilizing
    PowerShell for **Command and Control** (**C2**) during penetration testing, where
    security professionals simulate attacks to evaluate the robustness of their defenses.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在不断变化的网络安全环境中，掌握PowerShell的力量已经成为渗透测试人员工具包中的基石，尤其是那些希望复制现实世界场景的人员。本章深入探讨了在渗透测试过程中使用PowerShell进行**命令与控制**（**C2**）的艺术与科学，在渗透测试中，安全专家模拟攻击以评估防御的强度。
- en: PowerShell, a task automation framework from Microsoft, has emerged as a double-edged
    sword – a tool for both defenders and attackers. As organizations fortify their
    defenses, adversaries leverage PowerShell’s versatility to navigate through networks
    stealthily, establish persistent connections, and execute malicious commands.
    This chapter navigates the intricate landscape of PowerShell in a penetration
    testing context, unraveling its capabilities for C2 operations.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell，微软的任务自动化框架，已经成为一把双刃剑——既是防御者的工具，也是攻击者的工具。随着组织加强防御，攻击者利用PowerShell的多功能性，悄无声息地穿越网络、建立持久连接并执行恶意命令。本章将引导你了解PowerShell在渗透测试背景下的复杂应用，揭示其在C2操作中的能力。
- en: We begin by exploring foundational concepts, understanding how PowerShell can
    be weaponized for post-exploitation activities. The chapter unveils the myriad
    ways penetration testers can emulate adversarial tactics, from leveraging built-in
    cmdlets and scripts to executing sophisticated obfuscation techniques. Practical
    examples guide you through the intricacies of executing commands, manipulating
    systems, and evading detection – all within the controlled framework of a penetration
    test.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 我们首先探讨基础概念，了解PowerShell如何被武器化用于后期利用活动。本章揭示了渗透测试人员如何模拟对抗战术的多种方式，从利用内置的cmdlet和脚本到执行复杂的混淆技术。实用的示例将引导你了解执行命令、操作系统和规避检测的复杂性——这一切都在渗透测试的受控框架内进行。
- en: As we journey through this chapter, you will gain insights into the proactive
    use of PowerShell to strengthen defensive strategies. Understanding an adversary’s
    perspective is crucial in fortifying cyber defenses, and this chapter equips security
    professionals with the knowledge to navigate the dynamic landscape of PowerShell-based
    C2 during penetration tests.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章的学习过程中，你将深入了解如何积极使用PowerShell来加强防御策略。理解对手的视角对于加强网络防御至关重要，本章为安全专家提供了在渗透测试中使用PowerShell进行C2操作的知识，帮助他们应对动态变化的安全威胁。
- en: 'The following are the main topics covered in this chapter:'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖的主要内容如下：
- en: Post-exploitation, C2, and the cyber kill chain
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 后期利用、C2和网络杀伤链
- en: PowerShell components used for C2
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用于C2的PowerShell组件
- en: Using Empire for C2
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用Empire进行C2
- en: Using Meterpreter and PowerShell for C2
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用Meterpreter和PowerShell进行C2
- en: Post-exploitation, C2, and the cyber kill chain
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 后期利用、C2和网络杀伤链
- en: Post-exploitation, C2, and the cyber kill chain are fundamental concepts in
    cybersecurity. Together, they form a framework that helps you understand, respond
    to, and mitigate cyber threats. Post-exploitation is the phase after an initial
    breach, where attackers aim to maintain access, escalate privileges, collect intelligence,
    and move laterally within a compromised system. This phase involves deploying
    malware implants, exploiting vulnerabilities, stealing credentials, and utilizing
    living-off-the-land techniques to evade detection.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 后期利用、C2和网络杀伤链是网络安全中的基本概念。它们共同构成了一个框架，帮助你理解、响应和减轻网络威胁。后期利用是初次入侵后的阶段，攻击者旨在保持访问权限、提升特权、收集情报并在被攻陷的系统中横向移动。此阶段涉及部署恶意软件植入、利用漏洞、窃取凭据以及使用"地面生活"技术来规避检测。
- en: C2 is the infrastructure and communication mechanisms that enable attackers
    to manage compromised systems remotely. This includes command servers, communication
    protocols, encryption, and payload delivery. Attackers use **Domain Generation
    Algorithms** (**DGAs**), staged payloads, fast flux, and encrypted communication
    to establish and maintain control over compromised environments.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: C2是使攻击者能够远程管理被攻陷系统的基础设施和通信机制。这包括命令服务器、通信协议、加密和有效载荷传递。攻击者使用**域生成算法**（**DGAs**）、分阶段有效载荷、快速变化的DNS和加密通信来建立和维持对被攻陷环境的控制。
- en: The cyber kill chain provides a strategic model that outlines the stages of
    a cyberattack, from reconnaissance to achieving the attacker’s objectives. The
    stages include reconnaissance, weaponization, delivery, exploitation, installation,
    C2, and actions on objectives. Understanding the cyber kill chain helps organizations
    develop targeted defenses at each stage to prevent, detect, and respond to cyber
    threats. In post-exploitation, organizations must focus on establishing persistence,
    privilege escalation, data collection, and lateral movement. Defenses involve
    robust endpoint protection, regular patching, and comprehensive monitoring.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 网络攻击链提供了一个战略模型，概述了从侦察到实现攻击者目标的网络攻击阶段。这些阶段包括侦察、武器化、交付、利用、安装、C2（指挥与控制）和目标执行。理解网络攻击链有助于组织在每个阶段制定针对性的防御措施，以防止、检测和响应网络威胁。在后期利用阶段，组织必须专注于建立持久性、特权升级、数据收集和横向移动。防御措施包括强大的终端保护、定期补丁更新和全面的监控。
- en: C2 defenses require identifying and blocking communication channels, monitoring
    for anomalous behavior, and employing encryption inspection. Proactive measures
    such as threat intelligence, user education, and incident response planning are
    crucial along the cyber kill chain. Organizations can bolster their cybersecurity
    posture by comprehensively addressing post-exploitation, C2, and the cyber kill
    chain. This involves a combination of technological solutions, proactive measures,
    and a well-defined incident response strategy to effectively navigate and mitigate
    the complex challenges posed by cyber threats.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: C2防御要求识别并阻止通信通道，监控异常行为，并进行加密检查。积极的措施，如威胁情报、用户教育和事件响应规划，对于应对网络攻击链至关重要。组织可以通过全面解决后期利用、C2和网络攻击链来加强其网络安全态势。这需要结合技术解决方案、积极措施以及一个明确定义的事件响应策略，以有效应对和缓解网络威胁所带来的复杂挑战。
- en: PowerShell components used for C2
  id: totrans-16
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 用于C2的PowerShell组件
- en: PowerShell, a powerful and extensible scripting language, is increasingly leveraged
    by attackers during post-exploitation to establish C2 channels. In this exploration,
    we’ll delve into specific PowerShell components that can be used for C2 purposes,
    providing detailed examples to illustrate their implementation.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell是一种功能强大且可扩展的脚本语言，攻击者在后期利用过程中越来越多地使用它来建立C2通道。在这次探索中，我们将深入研究可以用于C2目的的PowerShell组件，并提供详细示例来说明它们的实现。
- en: Cmdlets for network communication
  id: totrans-18
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 网络通信的Cmdlets
- en: 'PowerShell offers cmdlets that enable communication with external servers,
    facilitating the establishment of C2 channels. The **Invoke-RestMethod** cmdlet,
    for instance, can be employed to interact with web services. Consider the following
    example:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell提供了允许与外部服务器进行通信的cmdlets，从而促进C2通道的建立。例如，**Invoke-RestMethod** cmdlet可以用于与Web服务进行交互。考虑以下示例：
- en: '[PRE0]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: In this example, the PowerShell script sends the local system’s process list
    to a C2 server and executes commands received in response.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，PowerShell脚本将本地系统的进程列表发送到C2服务器，并执行收到的命令。
- en: Scripting for payload delivery
  id: totrans-22
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 有效负载交付的脚本
- en: 'Attackers often use PowerShell scripts to download and execute malicious payloads
    from external sources. The following example demonstrates how a script can download
    a payload and execute it:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击者常常使用PowerShell脚本从外部源下载并执行恶意有效负载。以下示例演示了一个脚本如何下载并执行有效负载：
- en: '[PRE1]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: In this scenario, the PowerShell script fetches a malicious payload from the
    C2 server and executes it on the compromised system.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个场景中，PowerShell脚本从C2服务器获取恶意负载并在受感染的系统上执行。
- en: Encoded payloads to evade detection
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 为了规避检测而编码的有效负载
- en: 'To evade detection, attackers often encode their payloads. The Base64 encoding,
    for example, can be utilized to obfuscate malicious scripts. Consider the following:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 为了规避检测，攻击者常常对其有效负载进行编码。例如，Base64编码可以用来模糊化恶意脚本。考虑以下情况：
- en: '[PRE2]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: In this example, the script decodes a Base64-encoded payload and executes the
    decoded PowerShell commands.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，脚本解码一个Base64编码的有效负载并执行解码后的PowerShell命令。
- en: Dynamic code loading with functions
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用函数的动态代码加载
- en: 'Attackers can dynamically load code into memory during post-exploitation. PowerShell
    functions provide a means to achieve this. Here’s an example:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击者可以在后期利用过程中动态地将代码加载到内存中。PowerShell函数提供了一种实现此目的的方法。以下是一个示例：
- en: '[PRE3]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: In this case, the script defines a function with malicious actions, which can
    be invoked at any point during post-exploitation.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，脚本定义了一个带有恶意操作的函数，可以在后期利用阶段的任何时刻调用。
- en: DNS tunneling for covert communication
  id: totrans-34
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 用于隐蔽通信的 DNS 隧道
- en: 'PowerShell can be used for DNS tunneling, allowing attackers to establish covert
    communication channels. The following example showcases a simple DNS tunneling
    approach:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可以用于 DNS 隧道技术，使攻击者能够建立隐蔽的通信通道。以下示例展示了一种简单的 DNS 隧道方法：
- en: '[PRE4]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: In this example, the PowerShell script encodes data and uses DNS requests to
    send information to the C2 server.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，PowerShell 脚本编码数据并使用 DNS 请求将信息发送到 C2 服务器。
- en: Living-off-the-land techniques
  id: totrans-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 利用现有工具技术
- en: 'PowerShell allows attackers to use legitimate system tools for malicious purposes,
    making detection challenging. The following example illustrates living-off-the-land
    techniques:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 允许攻击者利用合法的系统工具进行恶意用途，使得检测变得具有挑战性。以下示例说明了利用现有工具技术：
- en: '[PRE5]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: In this instance, the attacker leverages the built-in **certutil** Windows tool
    to download a payload, demonstrating the use of legitimate tools for malicious
    activities.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个实例中，攻击者利用内置的 **certutil** Windows 工具下载一个有效载荷，展示了使用合法工具进行恶意活动。
- en: PowerShell components provide attackers with a versatile toolkit to implement
    C2 during post-exploitation. Understanding these components is crucial for defenders
    to detect and mitigate such threats effectively. By monitoring PowerShell activities,
    employing behavioral analysis, and implementing robust security measures, organizations
    can enhance their resilience against PowerShell-based C2 attacks in the post-exploitation
    phase.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 组件为攻击者提供了一个多功能工具包，用于在后期利用过程中实施 C2。了解这些组件对于防御者有效地检测和缓解此类威胁至关重要。通过监控
    PowerShell 活动、采用行为分析并实施强有力的安全措施，组织可以增强其抵御基于 PowerShell 的 C2 攻击的能力。
- en: Using Empire for C2
  id: totrans-43
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 Empire 进行 C2
- en: PowerShell Empire is an open source, post-exploitation framework that has gained
    popularity among penetration testers and red teamers for its versatile capabilities.
    This comprehensive exploration delves into its intricacies and demonstrates how
    it is used to implement (C2) during post-exploitation.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell Empire 是一个开源的后期利用框架，因其多功能性而在渗透测试人员和红队成员中广受欢迎。本次全面的探索深入剖析了其复杂性，并演示了它如何在后期利用过程中实施（C2）。
- en: An introduction to PowerShell Empire
  id: totrans-45
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: PowerShell Empire 简介
- en: PowerShell Empire is a post-exploitation framework designed to simulate **Advanced
    Persistent Threat** (**APT**) scenarios for security professionals. It leverages
    PowerShell to provide a modular and extensible platform for offensive security
    operations.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell Empire 是一个后期利用框架，旨在为安全专业人员模拟 **高级持续性威胁**（**APT**）场景。它利用 PowerShell
    提供一个模块化和可扩展的平台，用于进攻性安全操作。
- en: Installation and setup
  id: totrans-47
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 安装和设置
- en: 'Before diving into examples, let’s walk through the installation and setup
    of PowerShell Empire:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 在深入探讨示例之前，让我们先了解一下 PowerShell Empire 的安装和设置：
- en: '[PRE6]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Once installed, launch the Empire console:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 安装完成后，启动 Empire 控制台：
- en: '[PRE7]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: This opens the Empire console, where the operator can interact with various
    modules and configure listeners for C2.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 这将打开 Empire 控制台，操作员可以在其中与各种模块交互并配置 C2 的监听器。
- en: Listeners for C2
  id: totrans-53
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: C2 的监听器
- en: 'Empire uses listeners to establish C2 channels. Let’s create a basic HTTP listener:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: Empire 使用监听器来建立 C2 通道。让我们创建一个基本的 HTTP 监听器：
- en: '[PRE8]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: This sets up an HTTP listener, allowing agents (compromised systems) to communicate
    with the Empire server.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 这将设置一个 HTTP 监听器，允许代理（受感染的系统）与 Empire 服务器进行通信。
- en: Generating and delivering payloads
  id: totrans-57
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 生成和交付有效载荷
- en: 'Empire generates payloads that serve as agents on compromised systems. These
    agents communicate with the Empire server. Generate a PowerShell payload for a
    Windows target:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: Empire 生成的有效载荷充当受感染系统上的代理。这些代理与 Empire 服务器进行通信。为 Windows 目标生成一个 PowerShell 有效载荷：
- en: '[PRE9]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: This produces a PowerShell one-liner payload. You deliver this payload to the
    target system through various means, such as phishing or exploitation.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 这将生成一个 PowerShell 单行有效载荷。你可以通过多种方式将此有效载荷传送到目标系统，例如通过钓鱼或漏洞利用。
- en: Executing commands on compromised systems
  id: totrans-61
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在受感染的系统上执行命令
- en: 'Once the payload is executed on a target system, it establishes a connection
    to the Empire server. You interact with the agent to execute commands:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦有效载荷在目标系统上执行，它就会与 Empire 服务器建立连接。你可以与代理进行交互并执行命令：
- en: '[PRE10]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: This demonstrates executing a simple command (in this case, retrieving the current
    user) on the compromised system.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 这展示了在受感染系统上执行一个简单命令（在此案例中，获取当前用户）。
- en: Post-exploitation modules for advanced tasks
  id: totrans-65
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 用于高级任务的后期利用模块
- en: 'Empire includes a vast array of post-exploitation modules for advanced operations.
    Let’s use the **mimikatz** module to extract credentials from the compromised
    system:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: Empire包括了大量后期利用模块，用于执行高级操作。我们来使用**mimikatz**模块从被攻陷的系统中提取凭证：
- en: '[PRE11]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: This example showcases using a specialized module to perform credential extraction
    on the compromised system.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 这个示例展示了如何使用一个专用模块在被攻陷系统上进行凭证提取。
- en: Exfiltrating data
  id: totrans-69
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 数据外泄
- en: 'Empire provides modules to exfiltrate data from compromised systems. The **powershell/clipboard/paste**
    module can be used to exfiltrate data stored in the clipboard:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: Empire提供模块来从被攻陷系统中提取数据。**powershell/clipboard/paste**模块可以用来提取存储在剪贴板中的数据：
- en: '[PRE12]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: This demonstrates, using an Empire module, how an operator can exfiltrate sensitive
    data, such as clipboard contents, from the compromised system.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 这展示了如何使用Empire模块，演示操作员如何从被攻陷的系统中提取敏感数据，如剪贴板内容。
- en: Web drive-by attacks
  id: totrans-73
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 网页驱动攻击
- en: 'Empire allows operators to conduct web drive-by attacks, leveraging malicious
    scripts hosted on a web server. Here’s an example of setting up a web server within
    Empire and delivering a malicious payload to a target:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: Empire允许操作员进行网页驱动攻击，利用托管在网页服务器上的恶意脚本。下面是一个在Empire中设置网页服务器并将恶意有效载荷交付给目标的示例：
- en: '[PRE13]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: This sets up a web server and generates a BAT file that executes the payload
    when accessed by a target, establishing a connection back to the Empire server.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 这将设置一个网页服务器，并生成一个BAT文件，目标访问时执行有效载荷，建立与Empire服务器的连接。
- en: Evading antivirus detection
  id: totrans-77
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 避免杀毒软件检测
- en: 'PowerShell Empire provides capabilities to evade antivirus detection through
    obfuscation techniques. Let’s demonstrate obfuscating a PowerShell script:'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell Empire通过混淆技术提供逃避杀毒软件检测的功能。我们来演示如何混淆一个PowerShell脚本：
- en: '[PRE14]'
  id: totrans-79
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: This example shows how an operator can use Empire’s obfuscation module to obfuscate
    a simple PowerShell script.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 这个示例展示了操作员如何使用Empire的混淆模块来混淆一个简单的PowerShell脚本。
- en: Dynamic scripting
  id: totrans-81
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 动态脚本编写
- en: 'PowerShell Empire supports dynamic scripting, allowing operators to run scripts
    on the fly. Here’s an example of running a dynamic PowerShell script on a compromised
    system:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell Empire支持动态脚本编写，允许操作员在运行时执行脚本。下面是一个在被攻陷的系统上运行动态PowerShell脚本的示例：
- en: '[PRE15]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Operators can use this feature to run custom PowerShell scripts on the compromised
    systems during post-exploitation.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 操作员可以利用此功能在后期利用阶段（post-exploitation）在被攻陷系统上运行自定义的PowerShell脚本。
- en: Defensive measures
  id: totrans-85
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 防御措施
- en: Defenders must employ robust security measures to detect and mitigate PowerShell
    Empire activities. Implementing network monitoring, application whitelisting,
    and endpoint protection solutions is crucial. Regular security training for users
    to recognize social engineering tactics can also enhance defenses.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 防御者必须采用强大的安全措施来检测和缓解PowerShell Empire的活动。实施网络监控、应用白名单和端点保护解决方案至关重要。定期的安全培训可以帮助用户识别社会工程攻击，从而增强防御能力。
- en: PowerShell Empire is a robust post-exploitation framework that allows security
    professionals to simulate real-world scenarios and test the resilience of their
    systems against advanced threats. While it provides an effective tool for red
    teaming and penetration testing, it also highlights the need for organizations
    to implement strong defensive measures to protect against such sophisticated attacks.
    Understanding PowerShell Empire’s capabilities is essential for defenders and
    security professionals to strengthen their cybersecurity posture in the face of
    evolving threats.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell Empire是一个强大的后期利用框架，允许安全专家模拟真实世界的场景，并测试系统抵御高级威胁的能力。虽然它为红队演练和渗透测试提供了一个有效的工具，但也突出了组织实施强大防御措施的重要性，以防御这种复杂的攻击。了解PowerShell
    Empire的功能对于防御者和安全专家来说至关重要，有助于在面对不断变化的威胁时加强网络安全防护。
- en: Using Meterpreter and PowerShell for C2
  id: totrans-88
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用Meterpreter和PowerShell进行C2
- en: Meterpreter, a potent payload in the Metasploit framework, coupled with PowerShell,
    offers a potent combination for post-exploitation (C2). In this detailed exploration,
    we’ll explore how Meterpreter can be utilized alongside PowerShell to establish
    and maintain control over compromised systems.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: Meterpreter是Metasploit框架中的一个强大有效载荷，结合PowerShell，提供了一个强有力的后期利用（C2）组合。在这个详细的探讨中，我们将探讨如何将Meterpreter与PowerShell结合使用，以建立并维持对被攻陷系统的控制。
- en: An introduction to Meterpreter
  id: totrans-90
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Meterpreter简介
- en: Meterpreter is a post-exploitation payload within the Metasploit framework.
    It is designed to provide powerful features to interact with and control compromised
    systems. One notable advantage of Meterpreter is its versatility and the ability
    to run in-memory, making detection challenging for traditional security measures.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: Meterpreter 是 Metasploit 框架中的一个后期利用有效载荷。它旨在提供强大的功能，以与被破坏的系统进行交互和控制。Meterpreter
    的一个显著优势是其多功能性和可以在内存中运行，使得传统安全措施难以检测到它。
- en: Setting up the attack environment
  id: totrans-92
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置攻击环境
- en: 'Before we dive into examples, let’s set up a basic environment using Metasploit
    to understand the fundamentals:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们深入研究示例之前，让我们使用 Metasploit 设置一个基础环境，以了解基本概念：
- en: '[PRE16]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Exploiting a vulnerability
  id: totrans-95
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 利用漏洞
- en: 'Let’s assume we’ve identified a vulnerability in a target system for demonstration
    purposes. We’ll use the EternalBlue exploit to compromise a Windows machine (note
    that this is a hypothetical scenario and should only be performed in a controlled
    environment where you have permission):'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 假设我们已经在目标系统中发现了一个漏洞用于演示目的。我们将使用 EternalBlue 漏洞攻击来破坏一台 Windows 机器（请注意，这是一个假设场景，应该仅在您获得许可的受控环境中执行）：
- en: '[PRE17]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: This exploits the EternalBlue vulnerability to gain unauthorized access to the
    target system.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 这是利用 EternalBlue 漏洞对目标系统进行未经授权的访问。
- en: Utilizing Meterpreter
  id: totrans-99
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 利用 Meterpreter
- en: 'Once we have exploited the target successfully, we can leverage Meterpreter
    to establish a connection and gain control:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦我们成功利用目标系统的漏洞，就可以利用 Meterpreter 建立连接并获得控制：
- en: '[PRE18]'
  id: totrans-101
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: This creates a reverse TCP connection to the attacker’s machine, providing a
    Meterpreter shell on the compromised system.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 这将创建一个反向 TCP 连接到攻击者的机器，在被破坏的系统上提供一个 Meterpreter shell。
- en: Post-exploitation with Meterpreter
  id: totrans-103
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用 Meterpreter 进行后期利用
- en: Meterpreter provides a wide range of functionalities for post-exploitation activities.
    Let’s explore some common tasks.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: Meterpreter 提供了广泛的功能，用于后期利用活动。让我们探索一些常见任务。
- en: Filesystem manipulation
  id: totrans-105
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 文件系统操作
- en: 'In the following, we will use Meterpreter to list a series of files, upload
    a file from a server to the target, and download a file from the target to a server:'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将使用 Meterpreter 列出一系列文件，将文件从服务器上传到目标，并将文件从目标下载到服务器：
- en: '[PRE19]'
  id: totrans-107
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: System information gathering
  id: totrans-108
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 系统信息收集
- en: 'We can use Meterpreter to profile a target system using the **sysinfo** and
    **getsystem** commands. These commands create a detailed report documenting the
    capabilities of a target system:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用 Meterpreter 通过 **sysinfo** 和 **getsystem** 命令对目标系统进行分析。这些命令会生成一份详细报告，记录目标系统的功能：
- en: '[PRE20]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: Privilege escalation
  id: totrans-111
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 权限提升
- en: 'We can use Meterpreter to load modules that support a wide variety of functions.
    In the following, we will use Meterpreter to load a module that will attempt privilege
    escalation:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用 Meterpreter 加载支持各种功能的模块。接下来，我们将使用 Meterpreter 加载一个模块，尝试进行权限提升：
- en: '[PRE21]'
  id: totrans-113
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Integrating PowerShell for enhanced capabilities
  id: totrans-114
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 集成 PowerShell 以增强功能
- en: 'To enhance post-exploitation capabilities, we can utilize PowerShell within
    the Meterpreter shell. This allows us to use PowerShell’s extensive functionalities
    for stealthier and more flexible operations:'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 为了增强后期利用能力，我们可以在 Meterpreter shell 中利用 PowerShell。这使我们能够利用 PowerShell 的广泛功能进行更加隐蔽和灵活的操作：
- en: '[PRE22]'
  id: totrans-116
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Now, we have a PowerShell prompt within the Meterpreter shell:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们在 Meterpreter shell 中有了一个 PowerShell 提示符：
- en: 'Command execution with PowerShell:'
  id: totrans-118
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 PowerShell 执行命令：
- en: '[PRE23]'
  id: totrans-119
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE23]'
- en: This example retrieves the computer name using PowerShell within the Meterpreter
    session.
  id: totrans-120
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这个示例展示了如何在 Meterpreter 会话中使用 PowerShell 获取计算机名。
- en: 'Download and execute PowerShell scripts:'
  id: totrans-121
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 下载并执行 PowerShell 脚本：
- en: '[PRE24]'
  id: totrans-122
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE24]'
- en: This demonstrates how PowerShell can be used within Meterpreter to download
    and execute malicious scripts.
  id: totrans-123
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这个示例展示了如何在 Meterpreter 中使用 PowerShell 下载并执行恶意脚本。
- en: Obfuscating PowerShell commands
  id: totrans-124
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 混淆 PowerShell 命令
- en: 'To evade detection, attackers often obfuscate PowerShell commands. In the context
    of Meterpreter, PowerShell commands can be obfuscated to make analysis more challenging:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 为了避免被检测到，攻击者通常会混淆 PowerShell 命令。在 Meterpreter 的上下文中，可以混淆 PowerShell 命令，使得分析更加困难：
- en: '[PRE25]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: This example showcases obfuscation using base64 encoding.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 这个示例展示了如何使用 base64 编码进行混淆。
- en: Using PowerShell for C2
  id: totrans-128
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用 PowerShell 进行 C2（命令与控制）
- en: 'Now, let’s explore using PowerShell within Meterpreter for C2\. This involves
    establishing a persistent connection between the attacker and the compromised
    system. Assuming PowerShell Empire has been staged on an external server, we can
    download and execute it within Meterpreter:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们探索在 Meterpreter 中使用 PowerShell 进行 C2 操作。这涉及在攻击者和被攻陷系统之间建立持久连接。假设 PowerShell
    Empire 已经部署在外部服务器上，我们可以在 Meterpreter 中下载并执行它：
- en: '[PRE26]'
  id: totrans-130
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: This demonstrates how Meterpreter, once established, can leverage PowerShell
    to download and execute more advanced post-exploitation frameworks.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 这演示了 Meterpreter 在建立后，如何利用 PowerShell 下载并执行更高级的后期利用框架。
- en: Defensive measures
  id: totrans-132
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 防御措施
- en: 'To defend against attacks leveraging Meterpreter and PowerShell, organizations
    should implement robust security measures:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 为了防御利用 Meterpreter 和 PowerShell 进行的攻击，组织应实施强有力的安全措施：
- en: '**Network monitoring**: Employ network monitoring tools to detect unusual traffic
    patterns or connections'
  id: totrans-134
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**网络监控**：使用网络监控工具检测异常的流量模式或连接'
- en: '**Endpoint protection**: Utilize endpoint protection solutions to detect and
    block malicious activities'
  id: totrans-135
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**端点保护**：利用端点保护解决方案检测并阻止恶意活动'
- en: '**Application whitelisting**: Restrict the execution of unauthorized applications,
    including PowerShell scripts'
  id: totrans-136
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**应用程序白名单**：限制未经授权的应用程序的执行，包括 PowerShell 脚本'
- en: '**Regular audits and patching**: Regularly audit systems for vulnerabilities
    and apply patches to mitigate known security issues'
  id: totrans-137
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**定期审计和补丁管理**：定期审计系统漏洞并应用补丁，以减轻已知的安全问题'
- en: '**User education**: Educate users about the risks of opening unknown files
    or clicking on suspicious links'
  id: totrans-138
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**用户教育**：教育用户了解打开未知文件或点击可疑链接的风险'
- en: In summary, the combination of Meterpreter and PowerShell poses a significant
    threat in the hands of attackers during post-exploitation. Understanding their
    functionalities and employing effective defensive measures is crucial for organizations
    to mitigate the risks associated with such sophisticated attack techniques. Regularly
    updating systems, monitoring network traffic, and educating users are essential
    to maintaining a resilient security posture.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 总结来说，Meterpreter 和 PowerShell 的结合在攻击者进行后期利用时构成了重大威胁。理解它们的功能并采取有效的防御措施，对于组织减轻与这些复杂攻击技术相关的风险至关重要。定期更新系统、监控网络流量和教育用户是保持安全韧性的关键。
- en: Summary
  id: totrans-140
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, we navigated the intricate realm of using PowerShell for C2
    in the context of penetration testing. Beginning with foundational insights, we
    explored how PowerShell, a tool designed for legitimate administrative tasks,
    can be harnessed by both defenders and attackers. The chapter unveiled the artistry
    behind weaponizing PowerShell for post-exploitation activities, offering practical
    examples that guided you through the nuances of executing commands, infiltrating
    systems, and evading detection. From leveraging built-in cmdlets to executing
    complex obfuscation techniques, you gained a comprehensive understanding of the
    tactics employed by adversaries during penetration tests. This chapter emphasized
    PowerShell’s dual nature – a powerful asset for defenders seeking to fortify their
    cybersecurity measures and a potent weapon for adversaries navigating networks.
    Practical scenarios allowed you to emulate adversarial tactics within a controlled
    environment, empowering you to strengthen your defenses proactively. As we delved
    into the adversary’s perspective, the chapter provided actionable insights for
    security professionals, enabling them to fortify their cyber defenses proactively.
    By mastering the dynamic landscape of PowerShell-based C2, you gained a strategic
    advantage in the perpetual cat-and-mouse penetration testing game. The knowledge
    imparted in this chapter is a valuable resource for security practitioners aiming
    to stay one step ahead in the ever-evolving cybersecurity landscape.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 本章中，我们探讨了在渗透测试背景下使用 PowerShell 进行 C2 控制的复杂领域。从基础知识开始，我们探索了如何将 PowerShell ——
    这一为合法管理任务设计的工具 —— 被防御者和攻击者同时利用。本章揭示了将 PowerShell 武器化用于后渗透活动的艺术性，提供了实际案例，指导你了解执行命令、渗透系统以及规避检测的细节。从利用内置
    cmdlet 到执行复杂的混淆技术，你对攻击者在渗透测试中采用的策略有了全面的理解。本章强调了 PowerShell 的双重特性 —— 它是防御者加强网络安全防护的强大资产，同时也是攻击者穿越网络的有力武器。通过实际场景，你能够在受控环境中模拟攻击者的战术，主动强化防御。随着我们深入了解攻击者的视角，本章为安全专业人士提供了可操作的见解，帮助他们主动加强网络防御。通过掌握基于
    PowerShell 的 C2 控制的动态格局，你在永无止境的渗透测试猫鼠游戏中获得了战略优势。本章传授的知识是安全从业人员希望在不断变化的网络安全环境中保持领先一步的重要资源。
- en: In the next chapter, we will delve into the powerful realm of post-exploitation
    using PowerShell in the Microsoft Windows environment.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将深入探讨在 Microsoft Windows 环境中使用 PowerShell 进行后渗透操作的强大领域。
