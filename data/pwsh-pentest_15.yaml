- en: '15'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '15'
- en: Post-Exploitation in Microsoft Windows
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 微软Windows中的后期利用
- en: In this chapter, we delve into the powerful realm of post-exploitation using
    PowerShell in the Microsoft Windows environment. Post-exploitation is a critical
    phase where adversaries aim to maintain control, escalate privileges, and extract
    valuable information after breaching a system. Harnessing the robust capabilities
    of PowerShell, we explore advanced techniques for navigating Windows networks,
    manipulating permissions, and concealing activities. From privilege escalation
    and lateral movement to data exfiltration and covering tracks, PowerShell serves
    as a versatile toolset for both defenders and attackers. Join us as we unravel
    the intricacies of post-exploitation, demonstrating how PowerShell scripts can
    be strategically employed to simulate real-world threats and enhance our understanding
    of Windows security landscapes. Through detailed examples and practical insights,
    this chapter equips you with the knowledge to assess, defend, and strategically
    navigate the post-exploitation phase in Microsoft Windows environments.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章深入探讨了在微软Windows环境中使用PowerShell进行后期利用的强大领域。后期利用是一个关键阶段，攻击者的目标是在突破系统后维持控制、提升权限并提取有价值的信息。借助PowerShell的强大功能，我们将探索用于浏览Windows网络、操控权限和隐蔽活动的高级技术。从权限提升、横向移动到数据窃取和掩盖痕迹，PowerShell作为一个多功能工具集，服务于防御者和攻击者。请与我们一起揭开后期利用的复杂性，展示如何策略性地使用PowerShell脚本模拟现实威胁，并加深对Windows安全环境的理解。通过详细的示例和实用的见解，本章将帮助你获得评估、防御并策略性应对微软Windows环境中后期利用阶段的知识。
- en: 'The following are the main topics to be covered in this chapter:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将涵盖以下主要内容：
- en: The role of post-exploitation in Microsoft Windows on a penetration test
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 后期利用在微软Windows渗透测试中的作用
- en: Post-exploitation on Microsoft Windows
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 微软Windows中的后期利用
- en: Profiling a user with PowerShell on Microsoft Windows
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用PowerShell在微软Windows中对用户进行分析
- en: File permissions in Microsoft Windows
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 微软Windows中的文件权限
- en: Using PowerShell for privilege escalation on Microsoft Windows
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在微软Windows中使用PowerShell进行权限提升
- en: The role of post-exploitation in Microsoft Windows on a penetration test
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 后期利用在微软Windows渗透测试中的作用
- en: Post-exploitation is a critical phase in a penetration test, especially when
    targeting Microsoft Windows environments. This phase occurs after an attacker
    has successfully breached a system or network, gaining unauthorized access. The
    primary objective during post-exploitation is to maintain control, escalate privileges,
    and gather valuable information without triggering detection mechanisms.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 后期利用是渗透测试中的关键阶段，尤其是在针对微软Windows环境时。此阶段发生在攻击者成功突破系统或网络、获得未经授权的访问权限后。后期利用的主要目标是保持控制、提升权限并收集有价值的信息，同时不触发检测机制。
- en: One crucial aspect of post-exploitation on Microsoft Windows is understanding
    the operating system’s architecture and security mechanisms. Windows environments
    often have multiple interconnected systems, making lateral movement a key focus.
    Attackers aim to traverse the network, escalating privileges to gain greater control
    over resources.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 微软Windows中后期利用的一个关键方面是理解操作系统的架构和安全机制。Windows环境通常由多个相互连接的系统组成，这使得横向移动成为重点。攻击者的目标是穿越网络，提升权限以获得对更多资源的控制。
- en: Privilege escalation is a common goal during post-exploitation. Windows systems
    typically operate with different user accounts, each with varying permissions.
    Exploiting vulnerabilities to elevate privileges allows attackers to access sensitive
    data, install malicious software, or manipulate system configurations. Tools such
    as Mimikatz frequently extract and leverage credentials stored in memory, facilitating
    privilege escalation.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 提升权限是后期利用中的常见目标。Windows系统通常使用不同的用户账户，每个账户具有不同的权限。利用漏洞提升权限可以让攻击者访问敏感数据、安装恶意软件或操控系统配置。像Mimikatz这样的工具常常提取并利用存储在内存中的凭证，从而促进权限提升。
- en: Maintaining persistence is another crucial aspect of post-exploitation. Attackers
    seek to ensure continued access to compromised systems even after initial exploitation.
    Techniques such as backdoors, scheduled tasks, or registry modifications are commonly
    employed to establish persistence. This ensures that even if the initial point
    of entry is discovered and patched, the attacker can still regain access.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 持久性维护是后期利用中的另一个关键方面。攻击者试图确保在初始利用后，仍能持续访问被攻破的系统。常用的技术包括后门、计划任务或注册表修改，用以建立持久性。这确保了即使最初的入口点被发现并修补，攻击者仍然可以重新获得访问权限。
- en: Data exfiltration is a significant concern during post-exploitation. Once inside
    a network, attackers may target sensitive information such as intellectual property,
    customer data, or login credentials. Various tools and techniques, including covert
    channels and encrypted communication, are utilized to exfiltrate data without
    raising suspicion.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 数据外泄是后期利用中的一个重要问题。一旦进入网络，攻击者可能会针对敏感信息进行攻击，比如知识产权、客户数据或登录凭证。使用各种工具和技术，包括隐蔽通道和加密通信，攻击者能够在不引起怀疑的情况下外泄数据。
- en: During post-exploitation, security professionals must emulate real-world adversaries
    to assess the effectiveness of defenses and incident response capabilities. Red
    teamers often use tools such as Cobalt Strike or Metasploit to simulate advanced
    persistent threats, testing the organization’s ability to detect and respond to
    sophisticated attacks.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在后期利用过程中，安全专家必须模拟现实世界中的对手，以评估防御和事件响应能力的有效性。红队人员通常使用如Cobalt Strike或Metasploit等工具，模拟高级持续威胁，测试组织在检测和响应复杂攻击方面的能力。
- en: Post-exploitation also involves thorough reconnaissance. Attackers aim to gather
    intelligence about the network, its architecture, and the roles of different systems
    and users. This information helps in making informed decisions about further exploitation
    and lateral movement.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 后期利用还包括彻底的侦察。攻击者的目标是收集关于网络、架构以及不同系统和用户角色的信息。这些信息有助于做出关于进一步利用和横向渗透的明智决策。
- en: In summary, post-exploitation is a critical phase in a penetration test focused
    on Microsoft Windows environments. It involves privilege escalation, persistence,
    data exfiltration, and reconnaissance to simulate real-world threats, providing
    valuable insights into an organization’s security posture and identifying areas
    for improvement.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 总之，后期利用是针对微软Windows环境渗透测试的一个关键阶段。它涉及特权提升、持久性、数据外泄和侦察，以模拟现实世界的威胁，为组织的安全态势提供有价值的见解，并识别需要改进的领域。
- en: Post-exploitation on Microsoft Windows
  id: totrans-18
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 微软Windows上的后期利用
- en: PowerShell, a powerful scripting language and shell developed by Microsoft,
    is often leveraged during post-exploitation activities on the Microsoft Windows
    platform. Its flexibility, integration with Windows components, and ability to
    execute commands and scripts make it a preferred choice for attackers.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell是由微软开发的一种强大的脚本语言和Shell，通常在后期利用活动中被用来在微软Windows平台上执行。它的灵活性、与Windows组件的集成以及执行命令和脚本的能力使其成为攻击者的首选工具。
- en: There are also frameworks that support post-exploitation. PowerShell Empire
    is a post-exploitation framework that provides a range of tools and modules for
    performing post-exploitation activities on Windows systems.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 还有一些框架支持后期利用。PowerShell Empire是一个后期利用框架，提供一系列工具和模块，用于在Windows系统上执行后期利用活动。
- en: The following are detailed examples of how PowerShell can be used for various
    post-exploitation tasks.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是PowerShell在执行各种后期利用任务时的详细示例。
- en: Privilege escalation
  id: totrans-22
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 特权提升
- en: 'PowerShell can be used to check for privilege escalation opportunities. For
    instance, the following PowerShell command checks for the current user’s privileges:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用PowerShell检查特权提升的机会。例如，以下PowerShell命令检查当前用户的权限：
- en: '[PRE0]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This command reveals information about the current user, including their group
    memberships and privileges.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令显示当前用户的信息，包括其组成员身份和权限。
- en: Credential dumping
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 凭证转储
- en: 'PowerShell is commonly used to dump credentials from memory. The following
    example demonstrates the use of the **Mimikatz** PowerShell module, which is a
    popular tool for credential extraction:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell常被用于从内存中转储凭证。以下示例演示了使用**Mimikatz** PowerShell模块，这是一款流行的凭证提取工具：
- en: '[PRE1]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: This script imports the **Mimikatz** module and executes the **Invoke-Mimikatz**
    cmdlet to dump credentials from memory.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本导入**Mimikatz**模块并执行**Invoke-Mimikatz** cmdlet，从内存中提取凭据。
- en: Persistence
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 持久性
- en: 'PowerShell can be employed to establish persistence on a compromised system.
    For example, the following script adds a registry entry to execute a PowerShell
    script at system startup:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell可以用来在被攻击的系统上建立持久性。例如，以下脚本会添加一个注册表项，在系统启动时执行PowerShell脚本：
- en: '[PRE2]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: This script creates a registry key that ensures the execution of a PowerShell
    script every time the user logs in.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本创建一个注册表项，确保每次用户登录时都会执行PowerShell脚本。
- en: Lateral movement
  id: totrans-34
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 横向移动
- en: 'PowerShell’s ability to execute commands remotely makes it valuable for lateral
    movement within a network. The following example uses PowerShell remoting to execute
    a command on a remote machine:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell能够远程执行命令，这使得它在网络中进行横向移动时非常有价值。以下示例使用PowerShell远程执行命令：
- en: '[PRE3]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: In this example, PowerShell remoting is enabled on the target machine, and then
    a command (**Get-Process**) is executed remotely. It should be noted that many
    cmdlets support the **-ComputeName** parameter. This allows for the remote execution
    of the specific command on the target system.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在此示例中，目标机器上启用了PowerShell远程功能，然后执行一个命令（**Get-Process**）。需要注意的是，许多cmdlet都支持**-ComputeName**参数，这使得可以在远程系统上执行特定命令。
- en: Data exfiltration
  id: totrans-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 数据外泄
- en: 'PowerShell can be employed for data exfiltration using various techniques.
    One standard method is to encode data into Base64 and send it over the network.
    The following script demonstrates this:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell可以通过各种技术进行数据外泄。一个常见的方法是将数据编码为Base64并通过网络发送。以下脚本演示了这一过程：
- en: '[PRE4]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: This script encodes the **SensitiveData** string into Base64 and sends it to
    an attacker-controlled server.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本将**SensitiveData**字符串编码为Base64，并将其发送到攻击者控制的服务器。
- en: Covering tracks
  id: totrans-42
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 掩盖踪迹
- en: 'PowerShell can also cover its tracks by deleting logs or modifying event entries.
    The following example demonstrates the removal of event logs:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell还可以通过删除日志或修改事件条目来掩盖其踪迹。以下示例演示了如何删除事件日志：
- en: '[PRE5]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: This script clears the security event log, removing traces of activities.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本清除安全事件日志，删除活动痕迹。
- en: In summary, PowerShell is a versatile tool for post-exploitation on the Microsoft
    Windows platform. It enables attackers to escalate privileges, dump credentials,
    establish persistence, move laterally, exfiltrate data, and cover tracks. Defenders
    should be vigilant in monitoring PowerShell activities and implementing security
    measures to mitigate the risks associated with its misuse.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 总之，PowerShell是一个功能强大的工具，适用于Microsoft Windows平台上的后渗透操作。它使攻击者能够提权、提取凭据、建立持久性、进行横向移动、外泄数据以及掩盖踪迹。防御者应该警惕监控PowerShell活动，并采取安全措施以缓解其误用带来的风险。
- en: Profiling a user with PowerShell on Microsoft Windows
  id: totrans-47
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在Microsoft Windows上使用PowerShell进行用户分析
- en: Profiling a user with PowerShell on Microsoft Windows involves gathering detailed
    information about the user’s activities, permissions, and system interactions.
    This process is crucial for security professionals performing penetration tests
    and attackers seeking to exploit vulnerabilities. The following are examples of
    how PowerShell can be used to profile a user on a Windows system.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 使用PowerShell在Microsoft Windows上进行用户分析，涉及收集用户的活动、权限和系统交互的详细信息。这个过程对于进行渗透测试的安全专家以及寻求利用漏洞的攻击者至关重要。以下是一些使用PowerShell在Windows系统上分析用户的示例。
- en: User information
  id: totrans-49
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 用户信息
- en: 'PowerShell can retrieve detailed information about a user, including their
    account properties and group memberships. The following example demonstrates how
    to gather user information:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell可以获取用户的详细信息，包括其账户属性和组成员资格。以下示例演示了如何收集用户信息：
- en: '[PRE6]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: This script retrieves information about the currently logged-in user, including
    properties such as username, full name, and group memberships.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本获取当前登录用户的信息，包括用户名、全名和组成员资格等属性。
- en: Running processes
  id: totrans-53
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 正在运行的进程
- en: 'Profiling involves understanding the processes a user is running. PowerShell
    allows the retrieval of running processes and associated details:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 用户分析涉及了解用户正在运行的进程。PowerShell允许检索运行中的进程及其相关的详细信息：
- en: '[PRE7]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: This command provides information about processes, including the username associated
    with each process.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令提供有关进程的信息，包括与每个进程相关的用户名。
- en: Network connections
  id: totrans-57
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 网络连接
- en: 'Profiling includes examining network connections established by a user. PowerShell
    can be used to retrieve information about active network connections about processes
    owners by a specific user:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 分析包括检查用户建立的网络连接。可以使用 PowerShell 检索有关特定用户进程所有者的活动网络连接信息：
- en: '[PRE8]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: This script identifies active network connections associated with processes
    owned by the current user.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 此脚本识别与当前用户拥有的进程相关的活动网络连接。
- en: File and directory access
  id: totrans-61
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 文件和目录访问
- en: 'Profiling involves understanding a user’s file and directory access. PowerShell
    can be used to list files and directories a user has access to:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 分析涉及了解用户的文件和目录访问情况。可以使用 PowerShell 列出用户具有访问权限的文件和目录：
- en: '[PRE9]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: This command lists files and directories in the user’s home directory.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令列出用户主目录中的文件和目录。
- en: Installed software
  id: totrans-65
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 已安装的软件
- en: 'PowerShell allows querying installed software on a system, providing insights
    into the tools and applications:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 允许查询系统上已安装的软件，提供有关工具和应用程序的见解：
- en: '[PRE10]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: This command retrieves a list of installed software associated with the current
    user.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令检索与当前用户相关的已安装软件列表。
- en: Recent activities
  id: totrans-69
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 最近的活动
- en: 'Profiling involves understanding a user’s recent activities. PowerShell can
    query event logs to gather information about when a user logs in, when system
    changes occur, and other relevant events. In the following snippet, we will focus
    on when a user logs in and logs out:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 分析涉及了解用户的最近活动。PowerShell 可以查询事件日志以收集有关用户登录、系统更改以及其他相关事件的信息。在以下片段中，我们将重点关注用户登录和登出时的情况：
- en: '[PRE11]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: This script retrieves recent security events related to the current user, such
    as successful logins and logouts.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 此脚本检索与当前用户相关的最近安全事件，如成功的登录和登出。
- en: In summary, profiling a user with PowerShell on Microsoft Windows involves using
    various cmdlets and commands to gather information about the user’s account, running
    processes, network connections, file access, installed software, and recent activities.
    This comprehensive approach helps security professionals assess user behaviors
    and identify potential security risks.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 总结来说，使用 PowerShell 在微软 Windows 中分析用户涉及使用各种 cmdlet 和命令收集有关用户账户、运行进程、网络连接、文件访问、已安装软件和最近活动的信息。这种全面的方法帮助安全专业人员评估用户行为并识别潜在的安全风险。
- en: File permissions in Microsoft Windows
  id: totrans-74
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 微软 Windows 中的文件权限
- en: File permissions in Microsoft Windows play a crucial role in controlling access
    to files and folders, ensuring data security and integrity. Understanding how
    to manage and manipulate file permissions is essential for system administrators,
    security professionals, and users. The following sections are detailed examples
    illustrating how file permissions work in Windows.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 在微软 Windows 中，文件权限在控制文件和文件夹访问、确保数据安全性和完整性方面起着至关重要的作用。理解如何管理和操作文件权限对系统管理员、安全专业人员和用户至关重要。以下部分将详细示范文件权限在
    Windows 中的工作方式。
- en: Viewing file permissions
  id: totrans-76
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 查看文件权限
- en: 'PowerShell can view the existing file permissions on a file or folder. The
    following example shows how to retrieve the current permissions for a file:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可以查看文件或文件夹的现有文件权限。以下示例演示了如何检索文件的当前权限：
- en: '[PRE12]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: This script uses the **Get-Acl** cmdlet to retrieve the **Access Control List**
    (**ACL**) for the specified file and then formats the output for better readability.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 此脚本使用 **Get-Acl** cmdlet 检索指定文件的 **访问控制列表**（**ACL**），然后格式化输出以提高可读性。
- en: Granting file permissions
  id: totrans-80
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 授予文件权限
- en: 'PowerShell enables users to grant specific permissions to users or groups.
    The following example demonstrates how to grant read and execute permissions to
    a specific user:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 使用户能够授予用户或组特定的权限。以下示例演示了如何授予特定用户读取和执行权限：
- en: '[PRE13]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: This script creates a new access rule, specifying the user, the type of permission
    (**ReadAndExecute**), and whether to allow or deny the permission. The rule is
    then added to the file’s ACL.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 此脚本创建一个新的访问规则，指定用户、权限类型（**ReadAndExecute**）以及是否允许或拒绝该权限。然后将该规则添加到文件的 ACL。
- en: Modifying file permissions
  id: totrans-84
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 修改文件权限
- en: 'Existing file permissions can be modified using PowerShell. The following example
    shows how to add write permissions to an existing user:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用 PowerShell 修改现有的文件权限。以下示例演示了如何为现有用户添加写权限：
- en: '[PRE14]'
  id: totrans-86
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: This script retrieves the current ACL, disables inheritance and protection,
    adds a new access rule for write permission, and then applies the modified ACL
    to the file.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本检索当前的 ACL，禁用继承和保护，添加一个新的写入权限访问规则，然后将修改后的 ACL 应用到文件。
- en: Revoking file permissions
  id: totrans-88
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 撤销文件权限
- en: 'PowerShell can be used to revoke or remove file permissions. The following
    example demonstrates how to remove read permissions from a specific user:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可用于撤销或删除文件权限。以下示例演示了如何从特定用户中删除读取权限：
- en: '[PRE15]'
  id: totrans-90
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: In this script, the existing access rule for the specified user and read permission
    is identified and removed from the ACL.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 在此脚本中，指定用户的现有访问规则及读取权限被识别并从 ACL 中删除。
- en: Understanding and effectively managing file permissions in Windows is critical
    for maintaining a secure and organized filesystem. PowerShell provides a powerful
    and scriptable interface for performing these tasks efficiently.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Windows 中理解和有效管理文件权限对于维护安全且有序的文件系统至关重要。PowerShell 提供了一个强大且可脚本化的接口，可以高效地执行这些任务。
- en: Using PowerShell for privilege escalation on Microsoft Windows
  id: totrans-93
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 PowerShell 在 Microsoft Windows 上进行权限提升
- en: Privilege escalation is a critical aspect of penetration testing and security
    assessment. PowerShell, a powerful scripting language in the Windows environment,
    can be used for various privilege escalation techniques. The following are detailed
    examples illustrating how PowerShell can be employed for privilege escalation
    on Microsoft Windows.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 权限提升是渗透测试和安全评估中的关键方面。PowerShell 是 Windows 环境中的一种强大脚本语言，可以用于多种权限提升技术。以下是详细示例，展示了如何在
    Microsoft Windows 上使用 PowerShell 进行权限提升。
- en: Checking the current user’s privileges
  id: totrans-95
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查当前用户的权限
- en: 'Before attempting privilege escalation, it’s crucial to understand the current
    user’s privileges. PowerShell can be used to retrieve detailed information about
    the current user:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 在尝试权限提升之前，了解当前用户的权限至关重要。PowerShell 可用于检索有关当前用户的详细信息：
- en: '[PRE16]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: This command provides extensive information about the current user, including
    group memberships and privileges.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令提供有关当前用户的广泛信息，包括组成员身份和权限。
- en: Enumerating local administrators
  id: totrans-99
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 枚举本地管理员
- en: 'Identifying local administrators is a common step in privilege escalation.
    PowerShell allows for the enumeration of local administrators:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 识别本地管理员是权限提升中的一个常见步骤。PowerShell 允许枚举本地管理员：
- en: '[PRE17]'
  id: totrans-101
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: This command lists the members of the **Administrators** group, helping identify
    users with elevated privileges.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令列出了**管理员**组的成员，有助于识别具有提升权限的用户。
- en: Exploiting unquoted service paths
  id: totrans-103
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 利用未加引号的服务路径
- en: 'Some services on Windows may have unquoted paths, allowing an attacker to manipulate
    the service execution path and potentially escalate privileges. PowerShell can
    be used to identify such services:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 上的一些服务可能具有未加引号的路径，攻击者可以利用该路径操控服务执行路径，进而提升权限。PowerShell 可用于识别这些服务：
- en: '[PRE18]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: This script identifies services with unquoted paths, which could be exploited
    for privilege escalation.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本识别具有未加引号路径的服务，这些服务可能被用于权限提升。
- en: Exploiting insecure service permissions
  id: totrans-107
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 利用不安全的服务权限
- en: 'In some cases, service configurations may have insecure permissions, allowing
    modification by non-privileged users. PowerShell can be used to identify and exploit
    such misconfigurations:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 在某些情况下，服务配置可能具有不安全的权限，允许非特权用户修改。PowerShell 可用于识别并利用这些错误配置：
- en: '[PRE19]'
  id: totrans-109
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: This script checks the permissions of services in the registry and alerts if
    any have weak permissions that could be exploited.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本检查注册表中服务的权限，并在发现任何可被利用的弱权限时发出警报。
- en: DLL hijacking
  id: totrans-111
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: DLL 劫持
- en: 'DLL hijacking involves replacing a legitimate DLL with a malicious one, which
    can lead to privilege escalation when a process loads that DLL. PowerShell can
    be used to identify potential DLL hijacking opportunities:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: DLL 劫持涉及用恶意 DLL 替换合法 DLL，当进程加载该 DLL 时，可能导致权限提升。PowerShell 可用于识别潜在的 DLL 劫持机会：
- en: '[PRE20]'
  id: totrans-113
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'This script checks each running process for potential DLL hijacking opportunities
    and alerts if any are found. We can also use the **PowerSploit** module for code
    execution:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本检查每个运行的进程，寻找潜在的 DLL 劫持机会，并在发现时发出警报。我们还可以使用 **PowerSploit** 模块进行代码执行：
- en: '**Invoke-DllInjection**: Injects a DLL into the process ID of your choosing'
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Invoke-DllInjection**：将 DLL 注入到您选择的进程 ID 中'
- en: '**Invoke-ReflectivePEInjection**: Reflectively loads a Windows PE file (DLL/EXE)
    into the PowerShell process or reflectively injects a DLL into a remote process'
  id: totrans-116
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Invoke-ReflectivePEInjection**：通过反射方式将 Windows PE 文件（DLL/EXE）加载到 PowerShell
    进程中，或者通过反射方式将 DLL 注入到远程进程。'
- en: '**Invoke-Shellcode**: Injects shellcode into the process ID of your choosing
    or within PowerShell locally'
  id: totrans-117
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Invoke-Shellcode**：将 shellcode 注入到你选择的进程 ID 中，或者在本地 PowerShell 中注入。'
- en: '**Invoke-WmiCommand**: Executes a PowerShell ScriptBlock on a target computer
    and returns its formatted output using WMI as a C2 channel'
  id: totrans-118
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Invoke-WmiCommand**：在目标计算机上执行 PowerShell 脚本块，并使用 WMI 作为 C2 通道返回格式化的输出。'
- en: Registry manipulation
  id: totrans-119
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 注册表操作
- en: 'PowerShell can be used to manipulate registry settings related to user privileges.
    For example, modifying the **AlwaysInstallElevated** registry key can lead to
    privilege escalation:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: PowerShell 可用于操作与用户权限相关的注册表设置。例如，修改 **AlwaysInstallElevated** 注册表键可能导致权限提升：
- en: '[PRE21]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: This script creates the necessary registry path and sets the **AlwaysInstallElevated**
    key to **1**, which can lead to the installation of packages with elevated privileges.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本创建所需的注册表路径并将 **AlwaysInstallElevated** 键设置为 **1**，这可能导致以提升权限安装包。
- en: Exploiting weak folder permissions
  id: totrans-123
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 利用弱文件夹权限
- en: 'Weak folder permissions can be exploited for privilege escalation. PowerShell
    can be used to identify folders with insecure permissions:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 弱文件夹权限可以被利用进行权限提升。PowerShell 可用于识别权限不安全的文件夹：
- en: '[PRE22]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: This script searches for folders with weak permissions (modify rights for **Users**)
    and alerts if any are found.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本会搜索权限较弱的文件夹（修改 **Users** 权限）并在找到时进行提醒。
- en: Scheduled task exploitation
  id: totrans-127
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 利用计划任务
- en: 'Windows scheduled tasks can be manipulated for privilege escalation. PowerShell
    can be used to identify and modify scheduled tasks:'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 计划任务可用于进行权限提升。PowerShell 可用于识别和修改计划任务：
- en: '[PRE23]'
  id: totrans-129
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: This script identifies scheduled tasks running as **SYSTEM** and alerts if any
    are found, providing an opportunity for privilege escalation.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本识别以 **SYSTEM** 身份运行的计划任务，并在找到时发出警报，提供权限提升的机会。
- en: Exploiting unattended installations
  id: totrans-131
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 利用无人值守安装
- en: 'Unattended installations may contain sensitive information such as passwords
    in unencrypted files. PowerShell can be used to search for such files:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 无人值守安装可能包含敏感信息，如未加密的密码文件。PowerShell 可用于搜索此类文件：
- en: '[PRE24]'
  id: totrans-133
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: This script searches for **unattend.xml** files recursively and alerts if any
    potentially containing sensitive information are found.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本递归搜索 **unattend.xml** 文件，并在找到可能包含敏感信息的文件时发出警报。
- en: These examples showcase how PowerShell can be employed for privilege escalation
    on Microsoft Windows systems. However, it’s essential to note that these techniques
    should only be used in ethical hacking or penetration testing scenarios within
    legal and authorized environments. Unauthorized privilege escalation attempts
    are illegal and can have severe consequences. Security professionals and administrators
    should actively monitor and secure systems to prevent vulnerabilities and unauthorized
    access.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 这些示例展示了如何在 Microsoft Windows 系统中使用 PowerShell 进行权限提升。然而，需要注意的是，这些技术应仅在合法授权的环境下用于道德黑客或渗透测试。未经授权的权限提升尝试是非法的，可能会导致严重后果。安全专家和管理员应积极监控和保护系统，防止漏洞和未经授权的访问。
- en: Summary
  id: totrans-136
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, we explored the dynamic landscape of post-exploitation using
    PowerShell in Microsoft Windows. Emphasizing the significance of this phase in
    security assessments, we navigated through privilege escalation, lateral movement,
    and data exfiltration techniques, all powered by the versatility of PowerShell
    scripting. From uncovering weak permissions and exploiting service configurations
    to manipulating the registry and covering tracks, PowerShell emerged as a central
    tool for ethical hackers and defenders. The chapter provided a comprehensive overview
    of how PowerShell facilitates sophisticated post-exploitation maneuvers, enabling
    users to simulate and understand real-world threats. By employing detailed examples,
    the chapter equipped readers with the skills to assess and fortify Windows security,
    ensuring a holistic understanding of post-exploitation dynamics and the role of
    PowerShell in navigating and securing complex Windows environments.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们探讨了在微软Windows中使用PowerShell进行后渗透的动态环境。强调了这一阶段在安全评估中的重要性，我们深入分析了权限提升、横向移动和数据外泄技术，所有这些都依赖于PowerShell脚本的多功能性。从揭示弱权限和利用服务配置到操控注册表和掩盖痕迹，PowerShell作为道德黑客和防御者的核心工具显现出来。本章提供了PowerShell如何促进复杂的后渗透操作的全面概述，使用户能够模拟和理解现实世界的威胁。通过详细的示例，本章使读者具备评估和强化Windows安全的能力，确保全面理解后渗透动态以及PowerShell在复杂Windows环境中导航和保护的作用。
- en: In the next chapter, we will explore the potent synergy between PowerShell and
    Linux in the realm of post-exploitation.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将探索PowerShell与Linux在后渗透领域的强大协同作用。
