- en: Chapter 8. KRACK Attacks
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第 8 章 KRACK 攻击
- en: '|   | *"Disregard mountains. Acquire empires"* |   |'
  id: totrans-1
  prefs: []
  type: TYPE_TB
  zh: '|   | *"无视山脉，获取帝国"* |   |'
- en: '|   | --*Hannibal (probably)* |'
  id: totrans-2
  prefs: []
  type: TYPE_TB
  zh: '|   | --*汉尼拔（可能）* |'
- en: '*This chapter discusses the recently identified KRACK vulnerabilities and explores
    the current state of the tools that enable the identification of vulnerable devices.
    This chapter is a deep dive into the inner workings of the WPA2 handshake and
    is recommended for advanced readers.*'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '*本章讨论了最近发现的 KRACK 漏洞，并探讨了当前能够识别易受攻击设备的工具的状态。本章深入分析了 WPA2 握手的内部工作原理，推荐给高级读者。*'
- en: KRACK attack overview
  id: totrans-4
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: KRACK 攻击概述
- en: '**KRACK** stands for **Key Reinstallation AttaCKs**. It''s a tranche of vulnerabilities
    publicly disclosed in October 2017 by a team from KU Leuven. The attack is the
    exploitation of a fundamental flaw in the WPA2 handshake, allowing resending of
    a stage of the handshake in order to overwrite cryptographic data. This chapter
    will cover the attack at a theoretical level and provide some guidance on the
    successful identification and exploitation of this vulnerability.'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: '**KRACK** 代表 **密钥重安装攻击**。这是一个在 2017 年 10 月由 KU Leuven 团队公开披露的漏洞集合。该攻击利用了 WPA2
    握手中的基本缺陷，允许重新发送握手的某个阶段，以便覆盖加密数据。本章将从理论层面介绍该攻击，并提供成功识别和利用此漏洞的一些指导。'
- en: 'Let''s look at the WPA2 handshake, the standard for which can be found in the
    IEEE 802.11 standards, accessible here: [http://ieeexplore.ieee.org/document/7792308/](http://ieeexplore.ieee.org/document/7792308/).
    For this explanation we are starting post-association and authentication stage
    as the vulnerability is not affected by those.'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看 WPA2 握手，标准可以在 IEEE 802.11 标准中找到，链接如下：[http://ieeexplore.ieee.org/document/7792308/](http://ieeexplore.ieee.org/document/7792308/)。在此解释中，我们从关联和身份验证后的阶段开始，因为该漏洞不受这些阶段的影响。
- en: 'The **Pairwise Transient Key** (**PTK**) used for encryption is made up of
    five attributes:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 用于加密的 **对等临时密钥** (**PTK**) 由五个属性组成：
- en: A shared secret key known as the Pairwise Master Key (PMK)
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个共享的秘密密钥，称为对等主密钥 (PMK)
- en: A nonce value created by the access point (ANonce)
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 由接入点创建的一个随机数值 (ANonce)
- en: A nonce value created by the user station (SNonce)
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 由用户站点创建的一个随机数值 (SNonce)
- en: The access point MAC address (APMAC)
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 接入点 MAC 地址 (APMAC)
- en: The user station MAC address (STAMAC)
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用户站点 MAC 地址 (STAMAC)
- en: 'Throughout the process, **Message Identification Codes** (**MIC**) are used
    to provide a level of integrity and security. While these are integral to the
    process, they are not used in the resulting cryptographic data. Here''s a representation:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 在整个过程中，**消息标识码** (**MIC**) 被用来提供一定程度的完整性和安全性。尽管它们在过程中至关重要，但在最终的加密数据中并未使用。以下是一个表示：
- en: '![KRACK attack overview](graphics/B09903_08_01.jpg)'
  id: totrans-14
  prefs: []
  type: TYPE_IMG
  zh: '![KRACK 攻击概述](graphics/B09903_08_01.jpg)'
- en: 'At this time, as a result of the initial authentication and association process,
    both the user station and the access point have the PMK, the access point MAC
    address, and the user station MAC address. In addition, each stage will have a
    Key Replay Counter keeping track of the order of packets; this will come into
    play later:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 此时，由于初始的身份验证和关联过程，用户站点和接入点都拥有 PMK、接入点 MAC 地址和用户站点 MAC 地址。此外，每个阶段将有一个密钥重放计数器，跟踪数据包的顺序；这将在稍后发挥作用：
- en: '**Stage 1**: The access point transmits the **ANonce** value to the user station,
    which provides the user station with everything it needs to generate the PTK.
    The user station creates the PTK and now holds the key it will use for encryption.'
  id: totrans-16
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**阶段 1**：接入点将 **ANonce** 值传输给用户站点，这为用户站点提供了生成 PTK 所需的一切。用户站点创建 PTK，并持有将用于加密的密钥。'
- en: '**Stage 2**: The user station sends back its own nonce value along with a MIC.
    The access point now holds everything that it needs to create the PTK. The access
    point creates the PTK and is in the same state as the user station.'
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**阶段 2**：用户站点返回其自己的随机数值和 MIC。接入点现在持有创建 PTK 所需的一切。接入点创建 PTK，并处于与用户站点相同的状态。'
- en: '**Stage 3**: The access point creates and sends the **Group Temporal Key**
    (**GTK**) to the user, which enables the reading of non-directed traffic such
    as multicast/broadcast traffic.'
  id: totrans-18
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**阶段 3**：接入点创建并发送 **组临时密钥** (**GTK**) 给用户，使其能够读取非定向流量，如多播/广播流量。'
- en: '**Stage 4**: The user station returns an acknowledged statement.'
  id: totrans-19
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**阶段 4**：用户站点返回一个确认的声明。'
- en: Following the four-stage handshake, the user station can now send encrypted
    data to the access point and have it accepted. At this point, the negotiation
    phase is complete and the user station is free to use the network.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 在四阶段握手完成后，用户站点现在可以向接入点发送加密数据，并被接纳。在此时，协商阶段已完成，用户站点可以自由使用网络。
- en: '*What just happened?*'
  id: totrans-21
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '*刚刚发生了什么？*'
- en: We discussed the four-stage handshake in preparation for the explanation of
    the KRACK attacks. This should be a revisit at this stage, but it is important
    to cover the basics before launching into the technical nitty-gritty of the exploit.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在为KRACK攻击的解释做准备时讨论了四阶段握手。到这一阶段时应该是回顾，但在深入技术细节之前，复习基础是很重要的。
- en: The four-way handshake KRACK attack
  id: totrans-23
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 四阶段握手KRACK攻击
- en: Keeping in mind what we just discussed, you may now be surprised to find that
    this process is vulnerable to attack! However, the issue is not the core concept,
    but the practical implementation of the standard. As with most technical standards,
    sacrifices were made to the security of the solution in order to make it user-friendly.
    In specific, the sacrifice that was made to make the solution usable was making
    certain stages in the handshake replayable in the event of a missed message.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 记住我们刚才讨论的内容，你现在可能会惊讶地发现这个过程容易受到攻击！然而，问题并不在于核心概念，而是在于标准的实际实施。与大多数技术标准一样，为了使其易于使用，安全性在某些方面被妥协。具体而言，为了使解决方案可用，妥协的部分是使握手中的某些阶段在消息丢失时可以重放。
- en: While this is not a huge issue for most of the process, Stage 3 is replayable
    and can have a dramatic effect on the security of the overall solution. By placing
    themselves in a **Man-in-the-Middle** (**MITM**) position during the authentication
    process, an attacker can block the correctly negotiated PTK and install their
    own in certain circumstances. The Key Replay Counter and associated nonce values
    are reset when a key is negotiated. So by blocking certain packets, an MITM attacker
    can predict what counter and nonce values are going to be by forcing a key reinstall.
    This will enable future attackers to perform malicious actions such as decryption,
    spoofing, and packet replay.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管对大多数过程而言这不是一个大问题，但第三阶段是可重放的，可能会对整体解决方案的安全性产生重大影响。通过在身份验证过程中处于**中间人**(**MITM**)位置，攻击者可以在某些情况下阻止正确协商的PTK，并安装他们自己的PTK。密钥协商时会重置密钥重放计数器和相关的nonce值。因此，通过阻止某些数据包，MITM攻击者可以预测密钥重装时计数器和nonce值，并强迫重新安装密钥。这将使未来的攻击者能够执行恶意操作，例如解密、伪造和数据包重放。
- en: However, in deference to how the security industry operates, researchers have
    wisely only released **Proof of Concept** (**PoC**) scripts showing that the attack
    can be performed on client devices, and they have not released full-attack scripts
    to fully carry out the attacks against established networks. It should be noted,
    however, that they have announced that Android and Linux distributions are vulnerable
    to a key reinstall attack that forces the use of an all-zero key, effectively
    making traffic decryption trivial.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，考虑到安全行业的运作方式，研究人员明智地只发布了**概念验证**(**PoC**)脚本，显示攻击可以在客户端设备上执行，并且他们没有发布完整的攻击脚本来完全对已建立的网络进行攻击。值得注意的是，他们已经宣布，Android和Linux发行版易受密钥重装攻击的影响，该攻击迫使使用全零密钥，从而使流量解密变得轻而易举。
- en: Time for action – getting KRACKing
  id: totrans-27
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 行动时间 – 开始破解KRACK
- en: We will now go through using the scripts as distributed through Mathy VanHoef's
    GitHub page.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在将通过Mathy VanHoef的GitHub页面分发的脚本进行操作。
- en: First, open a terminal in Kali and type the command as shown in the following
    screenshot:![Time for action – getting KRACKing](graphics/B09903_08_02.jpg)
  id: totrans-29
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 首先，在Kali中打开终端并输入如下面截图所示的命令：![行动时间 – 开始破解KRACK](graphics/B09903_08_02.jpg)
- en: 'We will have to install the dependencies that the project relies upon. This
    will be achieved with the following command:'
  id: totrans-30
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们需要安装项目所依赖的依赖项。我们将通过以下命令来实现：
- en: '[PRE0]'
  id: totrans-31
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Change into the created `krackattacks-scripts` directory and check the contents.
    It should look like the following:![Time for action – getting KRACKing](graphics/B09903_08_03.jpg)
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 进入创建的`krackattacks-scripts`目录并检查其中的内容。它应该如下所示：![行动时间 – 开始破解KRACK](graphics/B09903_08_03.jpg)
- en: In this folder you can see the body of testing scripts and the solution Mathy
    and the team have put together. Before we can start playing with them, though,
    we need to compile `hostapd` in the format that they need.
  id: totrans-33
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在这个文件夹中，你可以看到测试脚本的主体和Mathy以及团队共同编写的解决方案。不过，在开始使用它们之前，我们需要将`hostapd`编译成它们需要的格式。
- en: The script itself provides these instructions on first use. However, I've written
    them here for clarity.
  id: totrans-34
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 脚本本身在首次使用时会提供这些说明。不过，我在这里写出来以便更清楚。
- en: Change into the `hostapd` directory using the commands shown in the following
    screenshot:![Time for action – getting KRACKing](graphics/B09903_08_04.jpg)
  id: totrans-35
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令进入`hostapd`目录，如下截图所示：![Action Time – getting KRACKing](graphics/B09903_08_04.jpg)
- en: 'This will have compiled `hostapd` for use in the KRACK attack PoC scripts.
    To verify that it''s built correctly, the folder should look like the following:'
  id: totrans-36
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将编译出可供KRACK攻击PoC脚本使用的`hostapd`。要验证它是否正确构建，文件夹应该如下所示：
- en: '![Time for action – getting KRACKing](graphics/B09903_08_05.jpg)'
  id: totrans-37
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![Action Time – getting KRACKing](graphics/B09903_08_05.jpg)'
- en: Change into the `krackattack` directory in the project root directory. It should
    look like the following screenshot:![Time for action – getting KRACKing](graphics/B09903_08_06.jpg)
  id: totrans-38
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 进入项目根目录下的`krackattack`目录。它应该看起来像以下截图所示：![Action Time – getting KRACKing](graphics/B09903_08_06.jpg)
- en: The scripts will recommend executing the `disable-hwcrypto.sh` script upon first
    use. However, after using an Alfa AWUS051NH and a Kali Linux VM, I found that
    this script would only crash the VM and the scripts worked regardless. It is a
    user's choice whether to carry this step out, but discretion is advised.
  id: totrans-39
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 脚本建议首次使用时执行`disable-hwcrypto.sh`脚本。然而，在使用Alfa AWUS051NH和Kali Linux虚拟机时，我发现这个脚本会导致虚拟机崩溃，而脚本本身仍然能正常工作。是否执行这一步是用户的选择，但建议谨慎操作。
- en: There are three other important files in this directory. Firstly, `hostapd.conf`
    defines the Wi-Fi details of the network to be generated. The defaults are `testnetwork`
    as the SSID and `abcdefgh` as the passphrase. Feel free to change these to your
    satisfaction.
  id: totrans-40
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 该目录中还有另外三个重要的文件。首先，`hostapd.conf`定义了要生成的网络的Wi-Fi细节。默认值为`testnetwork`作为SSID和`abcdefgh`作为密码短语。可以根据需要更改这些设置。
- en: Second, the `krack-test-client.py` script is the script that we will be using
    to identify vulnerable devices. This is the main focus of this chapter.
  id: totrans-41
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 第二个，`krack-test-client.py`脚本是我们用来识别易受攻击设备的脚本。这是本章的主要内容。
- en: Finally, there is the `krack-ft-test.py` which we will not cover the usage of
    in this chapter due to its application to niche wireless devices outside of the
    standard distribution.
  id: totrans-42
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 最后，有一个`krack-ft-test.py`脚本，由于它适用于一些特殊的无线设备，本章不会讲解如何使用它。
- en: Next, we actually get *KRACKing*.
  id: totrans-43
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 接下来，我们就开始*KRACKing*。
- en: 'We will need to disable network manager to avoid conflicts using the following
    commands:'
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们需要禁用网络管理器，以避免冲突，使用以下命令：
- en: '[PRE1]'
  id: totrans-45
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'We can then execute the `krack-test-client.py` script with the following command:'
  id: totrans-46
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后，我们可以使用以下命令执行`krack-test-client.py`脚本：
- en: '[PRE2]'
  id: totrans-47
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'You will then see the following screenshot:'
  id: totrans-48
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 然后你将看到以下截图：
- en: '![Time for action – getting KRACKing](graphics/B09903_08_07.jpg)'
  id: totrans-49
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![Action Time – getting KRACKing](graphics/B09903_08_07.jpg)'
- en: Now get hold of a test device, any Wi-Fi-enabled device, and connect to the
    created network with the credentials described earlier or whatever you've set
    it to.
  id: totrans-50
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在拿起一台测试设备，任何支持Wi-Fi的设备，并使用之前描述的凭据或你自己设置的凭据连接到创建的网络。
- en: 'The terminal will fill with text, but the script will helpfully mark any successful
    attacks in green as shown in the following screenshot:'
  id: totrans-51
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 终端将显示大量文本，但脚本会友好地将任何成功的攻击标记为绿色，如下截图所示：
- en: '![Time for action – getting KRACKing](graphics/B09903_08_08.jpg)'
  id: totrans-52
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![Action Time – getting KRACKing](graphics/B09903_08_08.jpg)'
- en: The script will iterate through the potential attacks and inform the user whether
    the device tested is vulnerable.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本将遍历潜在的攻击并通知用户所测试的设备是否存在漏洞。
- en: '*What just happened?*'
  id: totrans-54
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '*刚刚发生了什么？*'
- en: We successfully retrieved the PoC from Mathy VanHoef's GitHub page and tested
    a user device to see if it's vulnerable.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 我们成功地从Mathy VanHoef的GitHub页面获取了PoC，并测试了一个用户设备，看看它是否存在漏洞。
- en: Summary
  id: totrans-56
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, we've gone over the new KRACK attack, covered how the WPA2
    handshake works, and saw how to perform a PoC check against a device. The KRACK
    attack will develop as time goes on and more scripts are released into the wild.
    Readers should keep up with the community and monitor for new and interesting
    applications of this research.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们已经讲解了新的KRACK攻击，介绍了WPA2握手的工作原理，并展示了如何对设备进行PoC检查。随着时间的推移，KRACK攻击会不断发展，更多的脚本会被释放到网络中。读者应关注社区，保持对这一研究的新应用和有趣发展的关注。
- en: Readers should also visit the researcher's web page at [https://www.krackattacks.com/](https://www.krackattacks.com/).
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 读者还应访问研究人员的网页：[https://www.krackattacks.com/](https://www.krackattacks.com/)。
- en: Also, read the white paper for a greater understanding found at [https://papers.mathyvanhoef.com/ccs2017.pdf](https://papers.mathyvanhoef.com/ccs2017.pdf).
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，阅读白皮书以便更好地理解，白皮书地址为：[https://papers.mathyvanhoef.com/ccs2017.pdf](https://papers.mathyvanhoef.com/ccs2017.pdf)。
