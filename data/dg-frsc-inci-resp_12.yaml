- en: '12'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '12'
- en: Analyzing Log Files
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 分析日志文件
- en: '[*Chapter 3*](B18571_03.xhtml#_idTextAnchor046) contained a detailed discussion
    of Dr. Edmond Locard and his exchange principle. For review purposes, the central
    premise of Locard’s Exchange Principle is that when two objects come into contact
    with each other, they leave a trace. In the world of digital forensics, we have
    discussed the various locations and techniques that can be leveraged by responders
    in uncovering these traces from memory, hard drives, and network traffic. One
    location that provides a wealth of data that can be leveraged is that of log files.
    Actions are logged across a wide range of hardware and software. What is needed
    is for responders to understand how to acquire these logs, how to examine them,
    and what they detail. In doing so, they may be able to ascertain a good deal about
    the root cause of an incident.'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: '[*第 3 章*](B18571_03.xhtml#_idTextAnchor046)详细讨论了埃德蒙·洛卡尔博士及其交换原理。为了复习，洛卡尔交换原理的核心前提是，当两个物体接触时，它们会留下痕迹。在数字取证的世界中，我们讨论了响应者如何利用各种位置和技术，从内存、硬盘和网络流量中发现这些痕迹。一个可以提供大量数据并可供利用的位置是日志文件。广泛的硬件和软件都会记录操作。所需的是响应者理解如何获取这些日志，如何检查它们，以及它们详细记录了什么。在这样做时，他们可能能够找出事件的根本原因。'
- en: In this chapter, the discussion will focus on logs and log management, using
    log aggregation tools such as a **Security Information and Event Management**
    (**SIEM**) system, the Windows event logs, and – finally – analyzing Windows event
    logs. It is hoped that, by discussing some of these techniques, responders will
    be able to articulate how logs are critical to an incident investigation, while
    also being able to examine them as part of a larger incident investigation.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将重点讨论日志和日志管理，使用日志聚合工具，如**安全信息与事件管理**（**SIEM**）系统、Windows 事件日志，最后——分析 Windows
    事件日志。希望通过讨论这些技术，响应者能够清晰地阐明日志在事件调查中的重要性，并能够将其作为更大范围事件调查的一部分进行分析。
- en: 'We will cover the following topics in this chapter:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将涵盖以下主题：
- en: Logs and log management
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 日志和日志管理
- en: Working with SIEMs
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 与 SIEM 配合工作
- en: Windows Event Logs
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows 事件日志
- en: Analyzing Windows Event Logs
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 分析 Windows 事件日志
- en: Logs and log management
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 日志和日志管理
- en: The lifeblood of a good incident investigation is evidence from a wide range
    of sources. Even something such as a malware infection on a host system requires
    corroboration from a variety of sources. One common challenge with incident response,
    especially in smaller networks, is how the organization handles log management.
    For a comprehensive investigation, incident response analysts need access to as
    much network data as possible. All too often, organizations do not dedicate the
    proper resources so that comprehensive logs can be collected from network devices
    and other systems.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 一次良好的事件调查的核心是来自多种来源的证据。即使是主机系统上的恶意软件感染，也需要从多个来源获得证据。一项常见的挑战，尤其是在较小的网络中，是组织如何处理日志管理。为了进行全面的调查，事件响应分析师需要访问尽可能多的网络数据。然而，许多组织没有投入足够的资源，以便从网络设备和其他系统收集全面的日志。
- en: Before any incident, it is critical to clearly define how and what an organization
    will log, as well as how it will maintain those logs. This should be established
    within a log management policy and associated procedure. The **Computer Security
    Incident Response Team** (**CSIRT**) personnel should be involved in any discussion
    as to which logs are necessary or not, as they will often have insight into the
    value of one log source over another.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 在任何事件发生之前，明确组织将如何记录以及如何维护这些日志是至关重要的。这应该在日志管理政策及相关程序中进行定义。**计算机安全事件响应团队**（**CSIRT**）的人员应参与讨论哪些日志是必要的，因为他们通常能够深入了解某个日志来源相较于其他日志来源的价值。
- en: NIST logging guidance
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: NIST 日志管理指南
- en: The **National Institute of Standards and Technology** (**NIST**) has published
    a short guide to log management, available at [http://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-92.pdf](http://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-92.pdf).
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: '**国家标准与技术研究院**（**NIST**）已发布一份简短的日志管理指南，可通过以下链接访问：[http://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-92.pdf](http://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-92.pdf)。'
- en: 'Aside from the technical issues regarding log management, there are legal issues
    that must be addressed. The following are some issues that should be addressed
    by the CSIRT and its legal support before any incident:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 除了日志管理的技术问题外，还有法律问题必须解决。以下是CSIRT及其法律支持团队在任何事件发生前应当解决的若干问题：
- en: '**Establish logging as a normal business practice**: Depending on the type
    of business and the jurisdiction, users may have a reasonable expectation of privacy
    absent from any expressly stated monitoring policy. In addition, if logs are enabled
    strictly to determine a user’s potential malicious activity, there may be legal
    issues. As a result, the logging policy should establish that logging network
    activity is part of normal business activity and that users do not have a reasonable
    expectation of privacy.'
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**将日志记录作为常规商业实践**：根据业务类型和管辖区域，用户可能有合理的隐私期待，除非有明确声明的监控政策。此外，如果日志仅用于确定用户是否存在恶意活动，可能会涉及法律问题。因此，日志政策应当明确，日志记录网络活动是正常商业活动的一部分，且用户不应期望有隐私保护。'
- en: '**Logging close to the event**: This is not so much an issue with automated
    logging, as logs are often created almost as the event occurs. From an evidentiary
    standpoint, logs that are not created close to the event lose their value as evidence
    in a courtroom.'
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**事件发生时近距离记录日志**：这在自动化日志记录中不是问题，因为日志通常会在事件发生时几乎同时创建。从证据角度来看，未在事件发生时近距离创建的日志，在法庭上的证据价值会大打折扣。'
- en: '**Knowledgeable personnel**: The value of logs is often dependent on who created
    the entry, and whether or not they were knowledgeable about the event. In the
    case of logs from network devices, the logging software addresses this issue.
    So long as the software can be demonstrated to be functioning properly, there
    should be no issue.'
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**有经验的人员**：日志的价值通常取决于谁创建了日志条目，以及他们是否了解事件。在网络设备的日志情况下，日志软件会解决这个问题。只要能够证明软件正常运行，就不应该存在问题。'
- en: '**Comprehensive logging**: Enterprise logging should be configured for as much
    of the enterprise as possible. In addition, logging should be consistent. A pattern
    of logging that is random will have less value in a court than a consistent pattern
    of logging across the entire enterprise.'
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**全面日志记录**：企业日志记录应当尽可能覆盖整个企业。此外，日志记录应该保持一致。随机的日志记录模式在法庭上的价值不如在整个企业中保持一致的日志记录模式。'
- en: '**Qualified custodian**: The logging policy should name a data custodian. This
    individual would speak for the logging procedure and the types of software utilized
    to create the logs. They would also be responsible for testifying to the accuracy
    of the logs and the logging software used.'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**合格的保管人**：日志政策应当指定一名数据保管人。该人员将代表日志处理程序和用于创建日志的软件类型。他们还将负责证明日志的准确性以及所用日志软件的正确性。'
- en: '**Document failures**: Prolonged failures, or a history of failures when logging
    events, may diminish their value in a courtroom. A logging failure must be documented,
    and a reason associated with the failure.'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**记录故障**：持续的故障或在记录事件时的历史性故障，可能会降低它们在法庭上的价值。记录故障必须被文档化，并且需要附上故障的原因。'
- en: '**Log file discovery**: Organizations should be made aware that logs utilized
    within a courtroom proceeding are going to be made available to the opposing legal
    counsel.'
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**日志文件发现**：组织应当意识到，在法庭程序中使用的日志将会提供给对方的法律顾问。'
- en: '**Logs from compromised systems**: Logs that originate from a known compromised
    system are suspect. If these logs are to be introduced as evidence, the custodian
    or incident responder will often have to testify at length concerning the veracity
    of the data contained within the logs.'
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**来自被攻破系统的日志**：来自已知被攻破系统的日志存在可疑性。如果这些日志要作为证据提交，日志的保管人或事件响应者通常需要对日志中包含数据的真实性进行详细的证词陈述。'
- en: '**Original copies are preferred**: Log files can be copied from the log source
    to storage media. As a further step, any logs should be archived off the system.
    Incident responders should establish a chain of custody for each log file used
    throughout the incident, and these logs should be maintained as part of the case
    until an order from the court is obtained, allowing for their destruction.'
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**优先使用原始副本**：日志文件可以从日志源复制到存储介质。作为进一步的步骤，任何日志应该从系统中归档。事件响应者应为每个日志文件建立证据链，并在案件处理过程中保持这些日志，直到获得法院指令允许销毁这些日志。'
- en: A log management process addresses the foundational elements required to identify
    those events that an organization deems necessary. From here, the next major component
    of a proper log management strategy is the technology that is leveraged for aggregation
    and review. This involves integrating a SIEM system as part of the overall structure
    of the log management process.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 日志管理过程解决了识别组织认为必要的事件所需的基础元素。从这里开始，适当的日志管理策略的下一个关键组成部分是用于汇总和审查的技术。这涉及将SIEM系统集成到日志管理过程的整体结构中。
- en: Working with SIEMs
  id: totrans-25
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用SIEM
- en: A significant challenge that a great many organizations have is the nature of
    logging on network devices. With limited space, log files are often rolled over,
    whereby new log files are written over older log files. The result is that, in
    some cases, an organization may only have a few days’, or even a few hours’, worth
    of important logs. If a potential incident happened several weeks ago, the incident
    response personnel will be without critical pieces of evidence.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 许多组织面临的一个重大挑战是网络设备日志的管理。由于空间有限，日志文件通常会被覆盖，新日志会覆盖旧的日志文件。结果是，在某些情况下，组织可能只保留几天，甚至几小时的重要日志。如果潜在的事件发生在几周前，事件响应人员将无法获得关键证据。
- en: One tool that has been embraced by a wide range of enterprises is a SIEM system.
    This appliance can aggregate log and event data from network sources and combine
    them into a single location. This allows the CSIRT and other security personnel
    to observe activity across the entire network, without having to examine individual
    systems.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 一种被广泛接受的工具是SIEM系统。这个设备可以汇总来自网络来源的日志和事件数据，并将其合并到一个位置。这使得CSIRT和其他安全人员能够观察整个网络的活动，而无需检查单个系统。
- en: 'The following diagram illustrates how a SIEM system integrates into the overall
    network:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 下图展示了SIEM系统如何集成到整体网络中：
- en: '![Figure 12.1 – SIEM and logging architecture ](img/Image_B18571_12_01.jpg)'
  id: totrans-29
  prefs: []
  type: TYPE_IMG
  zh: '![图12.1 – SIEM与日志架构](img/Image_B18571_12_01.jpg)'
- en: Figure 12.1 – SIEM and logging architecture
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.1 – SIEM与日志架构
- en: A variety of sources, from security controls to SQL databases, are configured
    to send logs to SIEM. In this case, the SQL database located at `10.100.20.18`
    indicates that the `USSalesSyncAcct` user account was utilized to copy a database
    to the remote host, located at `10.88.6.12`. SIEM allows a quick examination of
    this type of activity. For example, if it is determined that the `USSalesSyncAcct`
    account has been compromised, CSIRT analysts can quickly query SIEM for any usage
    of that account. From there, they would be able to see the log entry that indicated
    a copy of a database to the remote host.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 各种来源，从安全控制到SQL数据库，都被配置为将日志发送到SIEM。在这种情况下，位于`10.100.20.18`的SQL数据库显示`USSalesSyncAcct`用户帐户被用来将数据库复制到远程主机，位于`10.88.6.12`。SIEM可以快速检查此类活动。例如，如果确定`USSalesSyncAcct`帐户已被入侵，CSIRT分析人员可以迅速查询SIEM中该帐户的任何使用记录。然后，他们可以查看日志条目，显示数据库被复制到远程主机的情况。
- en: Without that SIEM, CSIRT analysts would have to search each system that might
    have been accessed, a process that may be prohibitive.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 如果没有SIEM，CSIRT分析人员必须检查可能已被访问的每个系统，这一过程可能非常耗时。
- en: 'From the SIEM platform, security and network analysts can perform several different
    tasks related to incident response, as follows:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 从SIEM平台，安全和网络分析人员可以执行与事件响应相关的几项任务，如下所示：
- en: '**Log aggregation**: Typical enterprises have several thousand devices within
    the internal network, each with logs; SIEM can be deployed to aggregate these
    logs in a central location.'
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**日志汇总**：典型的企业内部网络中有几千台设备，每台设备都有日志；SIEM可以部署来将这些日志汇总到一个中心位置。'
- en: '**Log retention**: Another key feature that SIEM platforms provide is a platform
    to retain logs. Compliance frameworks, such as the **Payment Card Industry Data
    Security Standard** (**PCI-DSS**), stipulate that system logs should be maintained
    for 1 year, with 90 days’ worth immediately available. SIEM platforms can aid
    with log management by providing a system that archives logs in an orderly fashion
    and allow them to be retrieved immediately.'
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**日志保留**：SIEM平台提供的另一个关键功能是日志保留平台。合规性框架，如**支付卡行业数据安全标准**（**PCI-DSS**），规定系统日志应保持1年，且90天的日志应立即可用。SIEM平台可以通过提供一个系统来有序存档日志并允许立即检索来帮助进行日志管理。'
- en: '**Routine analysis**: It is advisable when using a SIEM platform to conduct
    periodic reviews of the information. SIEM platforms often provide a dashboard
    that highlights key elements, such as the number of connections, data flow, and
    any critical alerts. SIEM platforms also allow reporting so that stakeholders
    can keep informed about the activity.'
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**常规分析**：在使用 SIEM 平台时，建议定期审查信息。SIEM 平台通常提供一个仪表盘，突出显示关键要素，如连接数、数据流量和任何重要的警报。SIEM
    平台还允许生成报告，以便利益相关者了解活动情况。'
- en: '**Alerting**: SIEM platforms can alert to specific conditions that may indicate
    malicious activity. This can include alerting from security controls such as antivirus
    and intrusion prevention or detection systems. Another key feature of SIEM platforms
    is event correlation. This technique examines the log files and determines whether
    there is a link or any commonality between the events. SIEM can then alert to
    these types of events. For example, if a user account attempts multiple logins
    across several systems in the enterprise, SIEM can identify that activity and
    alert the relevant parties to it.'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**警报**：SIEM 平台可以在特定条件下发出警报，这些条件可能表示恶意活动的存在。这可以包括来自安全控制的警报，例如防病毒软件和入侵防御或检测系统。SIEM
    平台的另一个关键特性是事件关联。该技术检查日志文件，并确定事件之间是否存在关联或共同点。SIEM 随后可以对这些类型的事件发出警报。例如，如果一个用户账户在多个系统中尝试多次登录，SIEM
    可以识别这一活动并向相关方发出警报。'
- en: '**Threat hunting**: Modern adversaries can embed themselves into target networks
    or leverage previously unidentified vulnerabilities. Threat hunting is the practice
    of leveraging digital forensics techniques to uncover these types of long-term
    attacks. SIEM platforms allow threat hunters to search for **Indicators of** **Compromise**
    (**IOCs**).'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**威胁狩猎**：现代对手可以潜伏在目标网络中或利用之前未被发现的漏洞。威胁狩猎是利用数字取证技术揭露这些长期攻击的做法。SIEM 平台允许威胁狩猎者搜索**妥协指示器**（**IOCs**）。'
- en: '**Incident response**: As SIEM becomes the single point for log aggregation
    and analysis, CSIRT analysts will often make use of SIEM during an incident. CSIRT
    analysis will often make queries on the platform, as well as download logs for
    offline analysis. Because of the centralization of log files, the time to conduct
    searches and event collection is significantly reduced. For example, let’s say
    a CSIRT analysis has indicated a user account has been compromised. Without a
    SIEM, the CSIRT analyst would have to check various systems for any activity concerning
    that user account. With a SIEM in place, the analyst simply searches that user
    account on the SIEM platform, which has aggregated user account activity in logs
    from systems all over the enterprise. The result is that the analyst has a clear
    idea of the user account activity, in a fraction of the time it would have taken
    to examine logs from various systems throughout the enterprise.'
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**事件响应**：随着 SIEM 成为日志聚合和分析的单一平台，CSIRT 分析师通常会在事件发生时使用 SIEM。CSIRT 分析师常常会在平台上进行查询，并下载日志进行离线分析。由于日志文件的集中管理，进行搜索和事件收集的时间显著减少。例如，假设
    CSIRT 分析表明一个用户账户已经被妥协。没有 SIEM 的情况下，CSIRT 分析师需要检查各个系统，查看与该用户账户相关的活动。而有了 SIEM，分析师只需在
    SIEM 平台上搜索该用户账户，SIEM 已经汇总了来自企业各系统的用户账户活动日志。结果是，分析师能够在极短的时间内清楚地了解该用户账户的活动，而无需查看企业各系统中的日志。'
- en: SIEM platforms do entail a good deal of time and money to purchase and implement.
    Added to that cost are the constant upkeep, maintenance, and having to modify
    the necessary rules. From an incident response perspective, though, a properly
    configured and maintained SIEM is vital to gathering network-based evidence promptly.
    In addition, the features and capabilities of SIEM platforms can significantly
    reduce the time it takes to determine the root cause of an incident once it has
    been detected.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: SIEM 平台的购买和实施确实需要投入大量的时间和金钱。除此之外，还有持续的维护、保养以及必须修改的规则。从事件响应的角度来看，配置和维护得当的 SIEM
    对于及时收集基于网络的证据至关重要。此外，SIEM 平台的功能和能力能够显著减少在检测到事件后，确定事件根本原因所需的时间。
- en: SIEM use cases
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: SIEM 用例
- en: 'The following article provides an excellent breakdown of the use cases of SIEM
    platforms in enterprise environments: [https://www.sumologic.com/blog/why-modern-siem/](https://www.sumologic.com/blog/why-modern-siem/).'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 以下文章提供了 SIEM 平台在企业环境中的应用案例的详细解析：[https://www.sumologic.com/blog/why-modern-siem/](https://www.sumologic.com/blog/why-modern-siem/)。
- en: Splunk
  id: totrans-43
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Splunk
- en: 'Splunk is a commercial tool that is used in a wide range of organizations across
    all types of enterprises. The platform utilizes a log forwarder application to
    aggregate logs and ships them to a central server, either on-premise or in a cloud
    instance. From here, analysts can review logs and craft alerts that identify and
    escalate potential malicious activity. The one drawback to Splunk is the commercial
    licensing required. This licensing is based on the amount of data and logs that
    are sent to the platform. Most organizations can’t send every single log from
    every single system on the network. Therefore, organizations need to be judicious
    with the logs that are sent:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: Splunk 是一个商业工具，广泛应用于各种类型的企业和组织。该平台利用日志转发应用程序来聚合日志，并将其发送到中央服务器，可以是本地服务器也可以是云实例。从这里，分析人员可以审查日志并创建警报，以识别和升级潜在的恶意活动。Splunk
    的一个缺点是需要商业许可。这些许可基于发送到平台的数据和日志量。大多数组织无法将网络中每个系统的每一条日志都发送到平台。因此，组织需要在发送日志时谨慎选择：
- en: '![Figure 12.2 – The Splunk platform ](img/Image_B18571_12_02.jpg)'
  id: totrans-45
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.2 – Splunk 平台 ](img/Image_B18571_12_02.jpg)'
- en: Figure 12.2 – The Splunk platform
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.2 – Splunk 平台
- en: Elastic Stack
  id: totrans-47
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Elastic Stack
- en: Another open-source option for SIEM is the Elastic Stack (or the ELK Stack,
    as it is commonly known). The Elastic Stack is a combination of three tools in
    one. The open-source tools Elasticsearch, Logstash, and Kibana are combined to
    provide threat hunters with an open-source platform that ingests data and then
    transforms it into a format that can be viewed and analyzed via the Kibana GUI.
    This allows threat hunters to visualize log data from multiple systems at once.
    The Elastic Stack is built into several different open source security tools,
    including the Security Onion platform, which we will discuss shortly. The Elastic
    Stack can also be configured as a standalone SIEM solution, with tools such as
    Winlogbeat, which forwards Windows event logs to the Elastic Stack.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个开源的 SIEM 选项是 Elastic Stack（或常称为 ELK Stack）。Elastic Stack 是三个工具的组合。开源工具 Elasticsearch、Logstash
    和 Kibana 合并在一起，为威胁猎人提供一个开源平台，用于摄取数据并将其转化为可以通过 Kibana 图形界面查看和分析的格式。这使得威胁猎人可以同时可视化来自多个系统的日志数据。Elastic
    Stack 被集成到多个不同的开源安全工具中，包括我们接下来将讨论的 Security Onion 平台。Elastic Stack 也可以配置为独立的 SIEM
    解决方案，并结合如 Winlogbeat 等工具，后者将 Windows 事件日志转发到 Elastic Stack。
- en: 'The following is the most visible portion of the Elastic Stack – that is, the
    Kibana interface. This interface allows data visualization and searching, as can
    be seen here:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是 Elastic Stack 中最直观的部分——即 Kibana 界面。这个界面允许数据可视化和搜索，正如在这里所见：
- en: '![Figure 12.3 – The Kibana platform ](img/Image_B18571_12_03.jpg)'
  id: totrans-50
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.3 – Kibana 平台 ](img/Image_B18571_12_03.jpg)'
- en: Figure 12.3 – The Kibana platform
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.3 – Kibana 平台
- en: SIEM platforms are an excellent way for responders to examine a wide range of
    logs from many systems. One facet where this becomes critical is examining Windows
    event logs. The next section will examine a variety of Windows event logs and
    the insight they can provide responders into account and application usage.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: SIEM 平台是响应人员检查来自多个系统的各种日志的绝佳方式。一个至关重要的方面是检查 Windows 事件日志。下一节将探讨各种 Windows 事件日志及其为响应人员提供的关于账户和应用程序使用的洞察。
- en: Security Onion
  id: totrans-53
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Security Onion
- en: Security Onion is an open-source multi-tool platform that can serve as both
    a network **Intrusion Detection System** (**IDS**) and a SIEM. Security Onion
    ties a wide range of security tools – such as OSSEC, Suricata, and Zeek – into
    a single platform.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: Security Onion 是一个开源的多工具平台，可以作为网络 **入侵检测系统**（**IDS**）和 SIEM。Security Onion 将多种安全工具（如
    OSSEC、Suricata 和 Zeek）集成到一个平台中。
- en: 'Security Onion also has features such as dashboards and tools for deep analysis
    of log files. The following screenshot shows the level of detail that’s available:'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: Security Onion 还具有仪表板和用于深入分析日志文件的工具。以下屏幕截图显示了可用的详细程度：
- en: '![Figure 12.4 – The Security Onion platform ](img/Image_B18571_12_04.jpg)'
  id: totrans-56
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.4 – Security Onion 平台 ](img/Image_B18571_12_04.jpg)'
- en: Figure 12.4 – The Security Onion platform
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.4 – Security Onion 平台
- en: Although installing and deploying the Security Onion platform may require some
    resources in terms of time, it is a powerful, low-cost alternative, providing
    a solution to organizations that cannot deploy a full-featured SIEM solution (the
    Security Onion platform and its associated documentation are available at [https://securityonion.net/](https://securityonion.net/)).
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然安装和部署 Security Onion 平台可能需要一些时间和资源，但它是一个强大的、低成本的替代方案，适用于那些无法部署全功能 SIEM 解决方案的组织（Security
    Onion 平台及其相关文档可在 [https://securityonion.net/](https://securityonion.net/) 获取）。
- en: Windows Logs
  id: totrans-59
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Windows 日志
- en: The most prevalent endpoint operating system that responders will have to examine
    related to an incident is by far the Windows OS. Due to the overwhelming market
    share that Microsoft has, most enterprise endpoints will be Microsoft desktop/laptop,
    server, or virtual systems. As a result, responders must have a solid understanding
    of how to leverage the Windows Event and System Monitor logs for incident analysis.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 响应人员最常需检查的端点操作系统是 Windows 操作系统。由于微软在市场上的巨大份额，大多数企业端点将是微软的桌面/笔记本电脑、服务器或虚拟系统。因此，响应人员必须充分了解如何利用
    Windows 事件和系统监视器日志进行事件分析。
- en: Windows Event Logs
  id: totrans-61
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Windows 事件日志
- en: Windows event logs provide extensive data on the actions of the operating systems,
    connections from other systems, and credential use, along with the use of PowerShell.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 事件日志提供了操作系统的活动、来自其他系统的连接、凭证使用情况以及 PowerShell 使用的广泛数据。
- en: Adversarial tactics from initial compromise using malware or other exploits,
    credential accessing, and elevation and lateral movement using the Windows operating
    system’s internal tools are often captured via Windows event logs.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 从初始入侵使用恶意软件或其他漏洞、凭证访问，以及使用 Windows 操作系统内部工具进行权限提升和横向移动的对抗性战术，通常通过 Windows 事件日志进行捕获。
- en: The specific logs that are captured during the operating system’s activities
    are largely dependent on how the organization has configured them. Most enterprises
    utilize the Group Policy settings to configure which actions the system logs,
    as well as the storage space allocated for log files. Depending on the organization’s
    log management practices, the Windows OS can be configured to log the use of PowerShell,
    **Server Message Block** (**SMB**) usage, application activity, DHCP client administration,
    and Task Scheduler maintenance.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 操作系统活动中捕获的具体日志在很大程度上取决于组织如何配置它们。大多数企业利用组策略设置来配置系统记录哪些操作，以及为日志文件分配的存储空间。根据组织的日志管理实践，Windows
    操作系统可以配置为记录 PowerShell 使用、**服务器消息块**（**SMB**）使用、应用程序活动、DHCP 客户端管理以及任务调度程序维护。
- en: Most often, log management configurations are managed via Windows Group Policy.
    Here, administrators can manage a wide range of systems via one policy.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 日志管理配置通常通过 Windows 组策略来管理。在这里，管理员可以通过一项策略管理多个系统。
- en: The Windows OS has included the Event Viewer so that users or systems administrators
    can determine what logs are available on the system, as well as perform a cursory
    review.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 操作系统包括了事件查看器，用户或系统管理员可以通过它查看系统上可用的日志，并进行初步审查。
- en: 'To access the Windows Event Viewer, use the Windows search function for Event
    Viewer and click on the icon. This will open the **Event** **Viewer** window:'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 要访问 Windows 事件查看器，可以使用 Windows 搜索功能查找“事件查看器”，然后点击图标。这将打开**事件** **查看器**窗口：
- en: '![Figure 12.5 – Microsoft Windows Event Viewer ](img/Image_B18571_12_05.jpg)'
  id: totrans-68
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.5 – 微软 Windows 事件查看器](img/Image_B18571_12_05.jpg)'
- en: Figure 12.5 – Microsoft Windows Event Viewer
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.5 – 微软 Windows 事件查看器
- en: 'From this viewer, the responder can get a good sense of what is being logged
    and can even search for specific log entries. To access the logs directly for
    offline analysis, navigate to the default file path for log storage at `C:\Windows\System32\winevt\logs`.
    This will show the variety of events that can be logged, as follows:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 通过这个查看器，响应人员可以清楚了解哪些内容正在被记录，甚至可以搜索特定的日志条目。要直接访问日志以进行离线分析，可以导航到日志存储的默认文件路径`C:\Windows\System32\winevt\logs`。这将显示可记录的各种事件，具体如下：
- en: '![Figure 12.6 – Windows Event Log directory ](img/Image_B18571_12_06.jpg)'
  id: totrans-71
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.6 – Windows 事件日志目录](img/Image_B18571_12_06.jpg)'
- en: Figure 12.6 – Windows Event Log directory
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.6 – Windows 事件日志目录
- en: 'As previously stated, there are Windows event logs for a wide range of activities
    performed by the operating system. For this chapter, the focus will be on three
    of the more pertinent Windows Event Log types. These types cover a wide range
    of activities and are useful in determining which actions have taken place on
    a potentially compromised system. These are detailed as follows:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，Windows 事件日志记录了操作系统执行的广泛活动。在本章中，将重点介绍三种更相关的 Windows 事件日志类型。这些类型涵盖了广泛的活动，并在确定潜在被入侵系统上发生了哪些操作时非常有用。详细说明如下：
- en: '**Security logs**: These logs contain data entries concerning the security
    of the system. This includes logons, logoffs, security group membership, and program
    execution.'
  id: totrans-74
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**安全日志**：这些日志包含与系统安全相关的数据条目，包括登录、注销、安全组成员身份以及程序执行。'
- en: '**Application logs**: Application developers determine which types of activity
    applications will log. These are aggregated in the application log file.'
  id: totrans-75
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**应用程序日志**：应用程序开发者决定应用程序会记录哪些类型的活动。这些活动被汇总到应用程序日志文件中。'
- en: '**System logs**: Often utilized to troubleshoot non-malicious activity, the
    system logs maintain data that the Windows OS creates.'
  id: totrans-76
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**系统日志**：系统日志通常用于排除非恶意活动的故障，记录的是 Windows 操作系统创建的数据。'
- en: 'There are over 100 Windows Event Log IDs. Depending on how the operating system
    is used, some of these are seldom – if ever – observed on the system. Others can
    be very common and are seen constantly in use, even in normal circumstances. The
    following are some of the more useful Windows event log types for responders:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 事件日志 ID 总共有 100 多种。根据操作系统的使用方式，某些事件在系统上很少甚至从未出现过。另一些则非常常见，即使在正常情况下也会频繁出现。以下是响应者可能需要用到的一些更有用的
    Windows 事件日志类型：
- en: '**4624 and 4634 – logon and logoff**: These event log entries show the use
    of credentials on a potentially compromised system. In addition, the 4624 event
    IDs can show whether the logon was performed on the local system or through a
    remote connection, which is critical to finding lateral movement using the Windows
    SMB protocol.'
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**4624 和 4634 – 登录与注销**：这些事件日志条目显示了在潜在被入侵的系统上使用凭证的情况。此外，4624 事件 ID 可以显示登录是本地系统执行的还是通过远程连接进行的，这对于通过
    Windows SMB 协议寻找横向移动非常重要。'
- en: '**4625 – account failed logon**: One or two of these entries may not mean much.
    A few entries of this nature may indicate a fat-fingered logon here and there,
    but an excessive amount of these log entries is indicative of an adversary attempting
    to brute-force credentials.'
  id: totrans-79
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**4625 – 账户登录失败**：一两条此类日志条目可能没有太大意义。几条此类条目可能表示偶尔的登录错误，但大量此类日志条目则表明攻击者正在尝试暴力破解凭证。'
- en: '**4672 – special privileges assigned to new logon**: This is the Windows OS
    equivalent of a user account attempting to elevate to root- or administrator-level
    privileges. This can be used to determine if an adversary is escalating privileges
    with a compromised account.'
  id: totrans-80
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**4672 – 特权分配给新登录**：这是 Windows 操作系统中用户账户尝试提升到根权限或管理员权限的等价物。可以用来判断攻击者是否通过被入侵的账户提升了权限。'
- en: '`PsExec`, `CMD.EXE`, or `Whami.exe`, to zero in on potentially malicious behavior.'
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`PsExec`、`CMD.EXE` 或 `Whami.exe`，用以深入分析潜在的恶意行为。'
- en: '**4768-4773 – Kerberos service**: Several well-known exploits are used by adversaries
    where a Kerberos Ticket Granting Ticket is utilized for elevated privileges. This
    attack – often referred to as Kerberoasting – is particularly devastating, as
    it allows attackers to run through the network with valid credentials.'
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**4768-4773 – Kerberos 服务**：攻击者使用一些著名的漏洞，利用 Kerberos 票证授予票证（TGT）来提升权限。这种攻击，通常被称为
    Kerberoasting，尤其具有破坏性，因为它允许攻击者在网络中通过有效凭证横行。'
- en: '**5140 – a network share object was accessed**: This activity is logged when
    a user account first logs on to a network share. Anomalies in time or user activity
    may be indicative of an adversary attempting to obtain confidential data, or ransomware
    attempting to infect network shares.'
  id: totrans-83
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**5140 – 网络共享对象已访问**：当用户账户首次登录到网络共享时，会记录此活动。时间或用户活动的异常可能表明攻击者试图获取机密数据，或者勒索软件试图感染网络共享。'
- en: '**7045 – a new service was installed**: This log entry occurs when a new service
    was installed by the user indicated within the log entry. Some strains of malware
    will install themselves as a service. A review of these log entries may indicate
    the presence of malicious code.'
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**7045 – 安装了新服务**：当用户在日志条目中指明的用户安装了新服务时，会记录此日志条目。某些恶意软件会将自己作为服务安装。检查这些日志条目可能会揭示恶意代码的存在。'
- en: Windows Event Log reference
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 事件日志参考
- en: Specific details on every event log ID are outside the scope of this chapter.
    A good reference for the specific IDs is available at [https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/default.aspx](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/default.aspx).
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 每个事件日志 ID 的具体细节超出了本章的范围。有关具体 ID 的良好参考资料可以访问 [https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/default.aspx](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/default.aspx)。
- en: As previously stated, there are over 100 specific Windows event types available.
    The specific ones in use are often determined by the organization and have to
    be weighed against the amount of storage space that is available, as well as against
    the usefulness of the specific log entries during an investigation.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，Windows 事件类型超过 100 种。使用的特定类型通常由组织决定，并且需要在可用存储空间和事件调查期间特定日志条目的实用性之间进行权衡。
- en: Several resources can be leveraged to better understand Windows event logs.
    The first of these is the site `ultimatewindowssecurity.com`. This site provides
    a searchable database of the various Windows event log types by event ID. This
    is very useful in those circumstances where responders may come across a more
    obscure event ID. The MITRE Corporation also provides the ATT&CK knowledge database.
    This knowledge base can be searched for Windows event log IDs that may be pertinent
    to an investigation – for example, a responder is examining a system for indications
    that the system has been infected with the Carbanak malware. From the ATT&CK knowledge
    database, the responder can determine that Carbanak has created an account, and
    the Windows event ID for that is 4720\. From here, the responder would be able
    to search systems for that specific event ID and determine if any additional accounts
    appeared to be suspicious.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 可以利用多个资源来更好地理解 Windows 事件日志。第一个是 `ultimatewindowssecurity.com` 网站。该网站提供了一个可搜索的数据库，按事件
    ID 列出了各种 Windows 事件日志类型。当响应者可能遇到较为晦涩的事件 ID 时，这一点非常有用。MITRE 公司还提供了 ATT&CK 知识库。可以在该知识库中搜索与调查相关的
    Windows 事件日志 ID——例如，响应者正在检查某个系统，寻找是否有系统感染 Carbanak 恶意软件的迹象。在 ATT&CK 知识库中，响应者可以确定
    Carbanak 已经创建了一个账户，而相关的 Windows 事件 ID 是 4720。然后，响应者可以在系统中搜索该特定事件 ID，查看是否有其他账户显得可疑。
- en: As can be seen, the Windows operating system has a significant number of log
    event types and IDs. The following section will provide the responder with a way
    to collect and analyze these log files.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 如上所示，Windows 操作系统有大量的日志事件类型和 ID。以下部分将为响应者提供收集和分析这些日志文件的方法。
- en: Analyzing Windows Event Logs
  id: totrans-90
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 分析 Windows 事件日志
- en: Analyzing Windows event logs is a detailed process. One challenge that is often
    encountered by responders is the sheer number of logs that they may have to potentially
    analyze during an incident. In the case of multiple systems, the responder may
    have to contend with millions of separate event log entries. Cutting them down
    requires using specialized tools and processes, starting with acquisition, moving
    into triage, and then, finally, focusing on analyzing the key event logs that
    are pertinent to the incident investigation.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 分析 Windows 事件日志是一个详细的过程。响应者经常遇到的一个挑战是，事件发生时可能需要分析的日志数量。对于多个系统，响应者可能需要处理数百万条独立的事件日志条目。减少这些日志的数量需要使用专门的工具和流程，从获取开始，进入分诊阶段，最后聚焦于分析与事件调查相关的关键事件日志。
- en: Acquisition
  id: totrans-92
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 获取
- en: There are several methods that a responder can utilize in the acquisition of
    Windows event logs. Ideally, log files should be sent to a SIEM, to allow the
    responders to search log entries across the enterprise. Unfortunately, many organizations
    face a significant hurdle in terms of storage costs with commercial, or even open
    source, platforms. The result is that they often must trade off the cost of aggregating
    these logs by allowing the local systems to handle storage.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 响应者在获取 Windows 事件日志时可以使用几种方法。理想情况下，日志文件应发送到 SIEM，以便响应者能够在整个企业范围内搜索日志条目。不幸的是，许多组织面临着存储成本的重大障碍，无论是使用商业平台，还是开源平台。结果是，它们往往不得不通过让本地系统处理存储来权衡聚合这些日志的成本。
- en: Since most of these logs are on the local system, responders will need to use
    techniques to gather them. The first of these techniques is to simply copy the
    event logs from the local system to some type of removable media. Simply navigate
    to the default directory, `C:\Windows\System32\winevt\Logs`, and copy the pertinent
    logs. This method does require local access and a good deal of interaction with
    the local system. It is incumbent on the responder to document every action they
    took on the system, for proper reporting.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 由于大多数日志位于本地系统中，响应者需要使用技术手段来收集它们。第一种技术是直接将事件日志从本地系统复制到某种可移动媒体。只需导航到默认目录 `C:\Windows\System32\winevt\Logs`，并复制相关日志。此方法确实需要本地访问，并且与本地系统的互动较多。响应者有责任记录他们在系统上采取的每个操作，以便进行适当的报告。
- en: 'Responders also have the option of scripting the acquisition of log files through
    simple batch scripts. This acquisition can take place along with other actions
    to acquire evidence from a local system. For example, the following screenshot
    shows the acquisition of four Windows event log types from a local system:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 响应者还可以选择通过简单的批处理脚本编写日志文件采集脚本。此采集可以与其他本地系统证据采集操作一起进行。例如，以下屏幕截图展示了从本地系统获取四种 Windows
    事件日志类型的操作：
- en: '![Figure 12.7 – Event log CMD acquisition ](img/Image_B18571_12_07.jpg)'
  id: totrans-96
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.7 – 事件日志 CMD 采集](img/Image_B18571_12_07.jpg)'
- en: Figure 12.7 – Event log CMD acquisition
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.7 – 事件日志 CMD 采集
- en: These types of scripts can be run from a USB device or through remote sessions,
    thereby reducing the amount of interaction with the system.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 这些类型的脚本可以通过 USB 设备或远程会话运行，从而减少与系统的互动。
- en: '[*Chapter 6*](B18571_06.xhtml#_idTextAnchor105) introduced the `CyLR.exe` tool
    for the local acquisition of evidence. One of the key sets of evidence that `CyLR.exe`
    acquires is Windows event logs. As was previously indicated, these log files can
    be acquired from the local system and exported to a USB. Another option that will
    be explored in this section is the use of `CyLR.exe` to acquire Windows event
    logs and forward them to the Skadi log review platform. Skadi will be addressed
    later in this section, but first, `CyLR.exe` will be run against a system, and
    the output will be sent to the Skadi server.'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: '[*第 6 章*](B18571_06.xhtml#_idTextAnchor105)介绍了用于本地采集证据的 `CyLR.exe` 工具。`CyLR.exe`
    获取的关键证据之一是 Windows 事件日志。如前所述，这些日志文件可以从本地系统中获取并导出到 USB。此部分将探索的另一个选项是使用 `CyLR.exe`
    获取 Windows 事件日志并将其转发到 Skadi 日志审查平台。稍后会讨论 Skadi，但首先，`CyLR.exe` 将针对一个系统运行，并将输出发送到
    Skadi 服务器。'
- en: 'To acquire the log files from a local system and send them to a Skadi instance,
    proceed as follows:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 要从本地系统获取日志文件并将其发送到 Skadi 实例，请按以下步骤操作：
- en: Open the Windows Command Prompt as an administrator.
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 以管理员身份打开 Windows 命令提示符。
- en: Navigate to the directory where the `CyLR.exe` file is located.
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 导航到存放 `CyLR.exe` 文件的目录。
- en: 'Enter the following command into the Command Prompt:'
  id: totrans-103
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在命令提示符中输入以下命令：
- en: '[PRE0]'
  id: totrans-104
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'In the previous command, `-s` is the IP address or domain name of the remote
    system where `CyLR.exe` output is sent. In this case, this compressed evidence
    file will be sent to the system, `192.168.207.130`, via SFTP. `-u` is the username
    of the account utilized to access the remote system, and, finally, `-p` is the
    password for the account related to the remote system. Just as with a local acquisition,
    `CyLR.exe` will run, and the following will be visible in the Command Prompt:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 在之前的命令中，`-s` 是远程系统的 IP 地址或域名，`CyLR.exe` 的输出会发送到该系统。在此情况下，该压缩的证据文件将通过 SFTP 发送到系统
    `192.168.207.130`。`-u` 是用于访问远程系统的帐户的用户名，最后，`-p` 是与远程系统相关的帐户的密码。与本地采集一样，`CyLR.exe`
    将运行，命令提示符中将显示以下内容：
- en: '![Figure 12.8 – CyLR.exe execution output ](img/Image_B18571_12_08.jpg)'
  id: totrans-106
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.8 – CyLR.exe 执行输出](img/Image_B18571_12_08.jpg)'
- en: Figure 12.8 – CyLR.exe execution output
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.8 – CyLR.exe 执行输出
- en: This remote capture technique can be accomplished via any remote access tool
    available. The one distinct advantage of this method is the ability to acquire
    log data along with the other evidence that `CyLR.exe` captures, and automatically
    forward it to a central repository. This central repository can be the Skadi instance,
    or simply an SFTP server that has been configured to accept this data.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 这种远程捕获技术可以通过任何可用的远程访问工具来实现。此方法的一个显著优点是能够获取日志数据和`CyLR.exe`捕获的其他证据，并自动将其转发到中央存储库。该中央存储库可以是
    Skadi 实例，也可以是一个已配置为接受此数据的 SFTP 服务器。
- en: Depending on the type of incident and the number of systems involved, there
    may be a significant amount of data. Sometimes, it may be too much for a responder
    to examine manually. In those cases, it is necessary to triage that data to determine
    what log entries are most important.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 根据事件的类型和涉及的系统数量，可能会有大量数据。有时，对于响应人员来说，手动检查这些数据可能过于繁琐。在这种情况下，需要对数据进行初步筛选，以确定哪些日志条目最为重要。
- en: Triage
  id: totrans-110
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 初步筛选
- en: As discussed previously, depending on the incident, responders may be examining
    multiple Windows systems. Each of these systems may contain several thousand,
    or even a hundred thousand, event log entries. There is no possible way for a
    responder or team of responders to be able to examine that many individual entries.
    This equates to the often-used saying *it’s like finding a needle in a haystack*.
    To address the large datasets that are often encountered in Windows event log
    analysis, responders can utilize the DeepBlueCLI tool. This PowerShell script,
    developed by Eric Conrad, detects suspicious Windows event log entries, such as
    service creation, account creation, a high number of login failures, and malicious
    PowerShell usage. By focusing on these more critical event types, responders will
    be able to analyze more log files and potentially identify suspicious activity.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，响应人员可能需要检查多个 Windows 系统。每个系统可能包含数千条，甚至数十万条事件日志条目。响应人员或响应小组不可能检查那么多单独的条目。这就像人们常说的*大海捞针*。为了处理
    Windows 事件日志分析中常遇到的大数据集，响应人员可以使用 DeepBlueCLI 工具。由 Eric Conrad 开发的这个 PowerShell
    脚本能够检测可疑的 Windows 事件日志条目，例如服务创建、账户创建、大量登录失败和恶意 PowerShell 使用。通过关注这些更为关键的事件类型，响应人员将能够分析更多的日志文件，并有可能识别出可疑的活动。
- en: 'To run DeepBlueCLI, proceed as follows:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 要运行 DeepBlueCLI，请按以下步骤操作：
- en: Download the PowerShell script from its GitHub site at [https://github.com/sans-blue-team/DeepBlueCLI](https://github.com/sans-blue-team/DeepBlueCLI).
    Once downloaded, uncompressed the file.
  id: totrans-113
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从其 GitHub 网站下载 PowerShell 脚本：[https://github.com/sans-blue-team/DeepBlueCLI](https://github.com/sans-blue-team/DeepBlueCLI)。下载后，解压该文件。
- en: Open PowerShell and navigate to the directory containing `DeepBlue.ps1`.
  id: totrans-114
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开 PowerShell 并导航到包含 `DeepBlue.ps1` 的目录。
- en: 'Execute the `DeepBlue.ps1` PowerShell script by pointing it to a specific Windows
    event log file – in this case, the Windows security event log, as shown here:'
  id: totrans-115
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过将 `DeepBlue.ps1` PowerShell 脚本指向特定的 Windows 事件日志文件（在此案例中为 Windows 安全事件日志）来执行该脚本，如下所示：
- en: '[PRE1]'
  id: totrans-116
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'The screenshot for reference is as follows:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 参考截图如下：
- en: '![Figure 12.9 – DeepBlueCLI suspicious security event logs ](img/Image_B18571_12_09.jpg)'
  id: totrans-118
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.9 – DeepBlueCLI 可疑的安全事件日志](img/Image_B18571_12_09.jpg)'
- en: Figure 12.9 – DeepBlueCLI suspicious security event logs
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.9 – DeepBlueCLI 可疑的安全事件日志
- en: 'The Windows event logs may also contain entries that are indicative of malicious
    activity. Run the DeepBlueCLI PowerShell script against the system logs with the
    following command:'
  id: totrans-120
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: Windows 事件日志还可能包含表示恶意活动的条目。使用以下命令运行 DeepBlueCLI PowerShell 脚本，检查系统日志：
- en: '[PRE2]'
  id: totrans-121
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'This will produce the following output:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 这将生成以下输出：
- en: '![Figure 12.10 – DeepBlueCLI suspicious system event log entry ](img/Image_B18571_12_10.jpg)'
  id: totrans-123
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.10 – DeepBlueCLI 可疑的系统事件日志条目](img/Image_B18571_12_10.jpg)'
- en: Figure 12.10 – DeepBlueCLI suspicious system event log entry
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.10 – DeepBlueCLI 可疑的系统事件日志条目
- en: 'As we already discussed, the amount of Windows Event logs is extensive. One
    log source that often provides key data points, especially in ransomware attacks,
    is the Windows PowerShell Operational logs. This log will often capture malicious
    PowerShell scripts that are used as part of multistage ransomware attacks. Use
    the following command to triage the PowerShell logs:'
  id: totrans-125
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 正如我们之前讨论过的，Windows 事件日志的数量是庞大的。其中一个经常提供关键数据点的日志来源，特别是在勒索软件攻击中，是 Windows PowerShell
    操作日志。该日志通常会捕捉到作为多阶段勒索软件攻击一部分使用的恶意 PowerShell 脚本。使用以下命令对 PowerShell 日志进行初步筛选：
- en: '[PRE3]'
  id: totrans-126
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'This command produces the following output:'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令生成以下输出：
- en: '![Figure 12.11 – DeepBlueCLI PowerShell event log entry ](img/Image_B18571_12_11.jpg)'
  id: totrans-128
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.11 – DeepBlueCLI PowerShell 事件日志条目](img/Image_B18571_12_11.jpg)'
- en: Figure 12.11 – DeepBlueCLI PowerShell event log entry
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.11 – DeepBlueCLI PowerShell 事件日志条目
- en: 'In the preceding screenshot, we can see a PowerShell script that is larger
    than 1,000 bytes, which may indicate that it is malicious. A review of the script
    indicates that it opens a network socket to an IP address with the port set to
    `4443`:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 在前面的截图中，我们可以看到一个超过 1,000 字节的 PowerShell 脚本，这可能表明它是恶意的。对该脚本的审查表明，它打开了一个网络套接字，连接到一个
    IP 地址，并且端口设置为 `4443`：
- en: '![Figure 12.12 – PowerShell network socket ](img/Image_B18571_12_12.jpg)'
  id: totrans-131
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.12 – PowerShell 网络套接字](img/Image_B18571_12_12.jpg)'
- en: Figure 12.12 – PowerShell network socket
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.12 – PowerShell 网络套接字
- en: This type of behavior may be legitimate but should be followed up on as various
    post-exploitation tools such as **PowerSploit** and **Cobalt Strike** make extensive
    use of PowerShell. We will examine ransomware attacks in later chapters.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 这种行为可能是合法的，但应当进一步跟进，因为诸如**PowerSploit**和**Cobalt Strike**等各种后渗透工具广泛使用 PowerShell。我们将在后续章节中讨论勒索软件攻击。
- en: DeepBlueCLI is an excellent resource for conducting an initial pass on event
    logs. The two drawbacks are that analysts will still need to examine the initial
    log entries with additional tools and that DeepBlueCLI may miss actual malicious
    activity. It is advisable to start with this tool and then progress to more detailed
    examination methods and tools. In these instances, tools such as Event Log Explorer
    and Skadi are useful for gaining a much more detailed analysis.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: DeepBlueCLI 是进行事件日志初步分析的一个优秀工具。它的两个缺点是分析人员仍然需要使用其他工具检查初始日志条目，并且 DeepBlueCLI
    可能会漏掉实际的恶意活动。建议从这个工具开始，然后过渡到更详细的检查方法和工具。在这些情况下，像 Event Log Explorer 和 Skadi 这样的工具非常有助于进行更详细的分析。
- en: Detailed Event Log analysis
  id: totrans-135
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 详细事件日志分析
- en: 'As highlighted previously, the use of triage tools is a useful first step,
    but any incident investigation where event logs are available will require the
    use of specialized tools to dig deeper into the data that they provide. The Windows
    operating system has a native event log viewer. In the experience of many responders,
    that viewer is more suited to limited troubleshooting than to a deep analysis
    of the event logs. There are several tools, either open source or commercial,
    that can be leveraged for event log analysis. SIEM tools provide one of the best
    types of tools, especially if they can analyze offline event logs or those logs
    that have been acquired through scripts or other tools. In this chapter, two tools
    will be discussed: Event Log Explorer and Skadi. Each of these tools is useful
    for event log analysis but has unique features that make it suited for different
    aspects of event log analysis.'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，使用初步筛查工具是一个有用的第一步，但任何可以访问事件日志的事件调查都需要使用专业工具深入挖掘它们提供的数据。Windows 操作系统有一个本地的事件日志查看器。根据许多响应者的经验，这个查看器更适合于有限的故障排除，而不适合深入分析事件日志。有几个工具，无论是开源的还是商业的，都可以用于事件日志分析。SIEM
    工具提供了最好的工具类型之一，特别是当它们能够分析离线事件日志或通过脚本或其他工具获取的日志时。本章将讨论两个工具：Event Log Explorer 和
    Skadi。这些工具都适用于事件日志分析，但具有独特的功能，使其适合不同方面的事件日志分析。
- en: For example, Event Log Explorer allows better filtering of results, along with
    its string searching ability. Event Log Explorer can also combine multiple sources.
    Other tools, such as Skadi, allow the remote acquisition of log files and can
    combine log entries with other data, such as MFT entries and registry key settings.
    The one drawback with Skadi is the time necessary to ingest and process the data
    for review. Therefore, it is up to the responder to choose which tool best fits
    the incident under investigation.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，Event Log Explorer 提供了更好的结果筛选功能，并具有字符串搜索能力。Event Log Explorer 还可以合并多个来源。其他工具，如
    Skadi，允许远程获取日志文件，并可以将日志条目与其他数据（如 MFT 条目和注册表键设置）结合起来。Skadi 的一个缺点是需要一定的时间来获取和处理数据以供审查。因此，具体使用哪个工具取决于调查人员选择最适合当前事件的工具。
- en: Event Log Explorer
  id: totrans-138
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 事件日志浏览器
- en: Event Log Explorer is an event log analysis tool that has more features and
    an easy-to-navigate GUI. Available as a commercial tool, the creators of Event
    Log Explorer, FSPro Labs, provide a 30-day trial period in which to test the tool.
    The tool can be downloaded from the website at [https://eventlogxp.com/](https://eventlogxp.com/)
    and can be installed on the Windows operating system.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 事件日志浏览器是一款功能更强大、易于操作的事件日志分析工具。作为一款商业工具，Event Log Explorer 的开发者 FSPro Labs 提供了一个
    30 天的试用期供用户测试。该工具可以从[https://eventlogxp.com/](https://eventlogxp.com/)官网下载安装，并可安装在
    Windows 操作系统上。
- en: 'In this section, we will continue examining log files obtained from the storage
    we analyzed in the previous chapter:'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将继续分析在上一章节中分析的存储中获取的日志文件：
- en: 'Open **Event Log Explorer**; the following window will appear:'
  id: totrans-141
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开**事件日志浏览器**，以下窗口将会出现：
- en: '![Figure 12.13 – Event Log Explorer GUI ](img/Image_B18571_12_13.jpg)'
  id: totrans-142
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.13 – 事件日志浏览器图形用户界面](img/Image_B18571_12_13.jpg)'
- en: Figure 12.13 – Event Log Explorer GUI
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.13 – 事件日志浏览器图形用户界面
- en: The GUI has three main areas. The center pane contains the individual log entries
    that are contained within the Windows event log type. The lower pane contains
    the details contained within each log entry. Finally, the left-hand pane includes
    the Windows event log types that are under analysis.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 图形用户界面有三个主要区域。中间窗格包含 Windows 事件日志类型中的单个日志条目。下方窗格包含每个日志条目中的详细信息。最后，左侧窗格包含正在分析的
    Windows 事件日志类型。
- en: Event Log Explorer will automatically import the localhost’s Windows event logs.
    To remove these logs, right-click on the computer’s name and click **Remove Computer**.
    Click **YES**. This will remove the existing Windows event logs.
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 事件日志浏览器将自动导入本地主机的 Windows 事件日志。要移除这些日志，右键点击计算机名称并点击**移除计算机**。点击**是**。这将移除现有的
    Windows 事件日志。
- en: 'To import an event log file or files, click on **File** | **Open Log File**
    | **Standard**. Navigate to the appropriate folder where the event logs have been
    extracted. From here, load the log file from a directory. In this case, we will
    examine the Windows Security Event Logs. Select and click **Open**, as shown here:'
  id: totrans-146
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要导入事件日志文件或多个文件，请点击**文件** | **打开日志文件** | **标准**。导航到已提取事件日志的相应文件夹。从这里加载日志文件。此处，我们将查看
    Windows 安全事件日志。选择并点击**打开**，如下所示：
- en: '![Figure 12.14 – Opening Windows event logs ](img/Image_B18571_12_14.jpg)'
  id: totrans-147
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.14 – 打开 Windows 事件日志](img/Image_B18571_12_14.jpg)'
- en: Figure 12.14 – Opening Windows event logs
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.14 – 打开 Windows 事件日志
- en: 'This will load all the log entries for that log file. In this example, we are
    going to examine the **New User Added** entry that was identified in the DeepBlueCLI
    triage. That output identified not only the Event ID but also the account, two
    pieces of data we can filter on. To open the filter, look for the funnel icon
    on the taskbar:'
  id: totrans-149
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这将加载该日志文件的所有日志条目。在此示例中，我们将查看 DeepBlueCLI 筛查中识别出的 **新用户添加** 条目。该输出不仅识别了事件 ID，还识别了账户，这是我们可以用来筛选的两项数据。要打开筛选器，请查找任务栏上的漏斗图标：
- en: '![Figure 12.15 – Event Log Explorer – creating a filter ](img/Image_B18571_12_15.jpg)'
  id: totrans-150
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.15 – 事件日志浏览器 – 创建筛选器](img/Image_B18571_12_15.jpg)'
- en: Figure 12.15 – Event Log Explorer – creating a filter
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.15 – 事件日志浏览器 – 创建筛选器
- en: 'The filter screen will then. From here, we can filter the event logs on a variety
    of specific attributes. This includes the event types, event IDs, and even keyword
    searching in the text of the log file entry. In this case, we will examine the
    log entries for `minecraftsteve`. This was identified with the DeepBlueCLI triage
    script. Enter the event ID as `4720` and, in the `minecraftsteve`, as follows:'
  id: totrans-152
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后会显示筛选器屏幕。在这里，我们可以根据多种特定属性过滤事件日志，包括事件类型、事件 ID，甚至在日志文件条目的文本中进行关键字搜索。在本例中，我们将查看
    `minecraftsteve` 的日志条目。这是通过 DeepBlueCLI 筛查脚本识别出来的。输入事件 ID 为 `4720`，并在 `minecraftsteve`
    中如下所示：
- en: '![Figure 12.16 – Event Log Explorer filter parameters ](img/Image_B18571_12_16.jpg)'
  id: totrans-153
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.16 – 事件日志浏览器筛选器参数](img/Image_B18571_12_16.jpg)'
- en: Figure 12.16 – Event Log Explorer filter parameters
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.16 – 事件日志浏览器筛选器参数
- en: 'The output, after clicking **OK**, shows the event log entries that match the
    filters that were entered. The details of the event log entries include additional
    details about the account creation:'
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**确定**后，输出将显示与输入筛选条件匹配的事件日志条目。事件日志条目的详细信息包括有关账户创建的附加细节：
- en: '![Figure 12.17 – Event log details ](img/Image_B18571_12_17.jpg)'
  id: totrans-156
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.17 – 事件日志详情](img/Image_B18571_12_17.jpg)'
- en: Figure 12.17 – Event log details
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.17 – 事件日志详情
- en: 'Again, returning to the results of the DeepBlueCLI script, there was an additional
    entry with Event ID 4732 that indicated elevated privileges for the `minecraftsteve`
    account. By going back to the filter and replacing the event ID of 4720 with 4732
    and removing the `minecraftsteve` account, we can see that the account SID was
    not only moved into the administrator’s group but also moved into the **Remote
    Management** **Users** group:'
  id: totrans-158
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 再次回到 DeepBlueCLI 脚本的结果，发现有一个附加条目，事件 ID 为 4732，表示 `minecraftsteve` 账户具有提升的权限。通过返回筛选器，将事件
    ID 从 4720 更改为 4732，并移除 `minecraftsteve` 账户，我们可以看到该账户的 SID 不仅被移动到管理员组中，还被移动到 **远程管理**
    **用户**组中：
- en: '![Figure 12.18 – Event log entry description ](img/Image_B18571_12_18.jpg)'
  id: totrans-159
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.18 – 事件日志条目描述](img/Image_B18571_12_18.jpg)'
- en: Figure 12.18 – Event log entry description
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.18 – 事件日志条目描述
- en: In this short example, we were able to correlate the creation of a new user
    account and the elevation of its privileges to both the administrator’s group
    and the remote management users. While this may not be malicious, if there is
    no ability to tie this new account to a legitimate user, it may be indicative
    of an adversary creating an account and adding it to the administrator’s group.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个简短的示例中，我们能够将新用户账户的创建与其权限提升到管理员组和远程管理用户相关联。虽然这可能不是恶意的，但如果无法将这个新账户与合法用户联系起来，它可能表明有攻击者创建了一个账户并将其加入管理员组。
- en: 'One Windows Event Log that may be available to analysts is the Windows Defender
    Operational Event Log. These entries contain information concerning Windows Defender
    malware prevention and can provide additional information concerning updates and
    detections. Opening the file shows that there are several warnings:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 一个可能对分析员可用的 Windows 事件日志是 Windows Defender 操作事件日志。这些条目包含有关 Windows Defender
    恶意软件防护的信息，并且可以提供有关更新和检测的额外信息。打开文件后可以看到几个警告：
- en: '![Figure 12.19 – Windows Defender entries ](img/Image_B18571_12_19.jpg)'
  id: totrans-163
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.19 – Windows Defender 条目](img/Image_B18571_12_19.jpg)'
- en: Figure 12.19 – Windows Defender entries
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.19 – Windows Defender 条目
- en: 'A review of one of the warnings indicates that Defender has detected the use
    of Meterpreter, a well-known post-exploitation tool:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 对其中一个警告的回顾表明，Defender 已检测到 Meterpreter 的使用，这是一个著名的后期利用工具：
- en: '![Figure 12.20 – Windows Defender Meterpreter detection ](img/Image_B18571_12_20.jpg)'
  id: totrans-166
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.20 – Windows Defender Meterpreter 检测](img/Image_B18571_12_20.jpg)'
- en: Figure 12.20 – Windows Defender Meterpreter detection
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.20 – Windows Defender Meterpreter 检测
- en: Event Log Explorer has a great deal of functionality that cannot be addressed
    in this volume. Some of its other features include building custom views, filtering
    on specific data points, and finding text within log entries across multiple event
    log files. Even with these features, Event Log Explorer does have some minor limitations.
    First, responders have to gather the logs onto the system for analysis and load
    them manually. The second is that, depending on the file size, Event Log Explorer
    may have performance issues, including freezing. Responders should ensure they
    do not overload the application. Regardless, Event Log Explorer is an excellent
    tool for responders to include in their toolkits.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: Event Log Explorer 拥有很多功能，无法在本书中详细讲解。它的其他一些功能包括构建自定义视图、对特定数据点进行筛选，以及在多个事件日志文件中查找日志条目中的文本。即使有这些功能，Event
    Log Explorer 仍然存在一些小的局限性。首先，响应人员必须将日志收集到系统中进行分析，并手动加载它们。其次，视文件大小而定，Event Log Explorer
    可能会出现性能问题，包括卡顿。响应人员应确保不会过度加载该应用程序。尽管如此，Event Log Explorer 仍然是响应人员工具包中非常优秀的工具。
- en: Skadi and Kabana
  id: totrans-169
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Skadi 和 Kabana
- en: Incidents often involve multiple systems across an enterprise network. Correlating
    this activity is often very difficult without analyzing the event logs from multiple
    systems. This is where the previously discussed SIEM appliances are helpful. Another
    option, if SIEM is not preconfigured to ingest and analyze event logs, is the
    Skadi platform. This open-source platform, available from GitHub at [https://github.com/orlikoski/Skadi](https://github.com/orlikoski/Skadi),
    is a group of applications and forensics installed on an Ubuntu 16.04 LTS server
    base image.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 事件通常涉及企业网络中的多个系统。没有分析多个系统的事件日志，相关联这些活动往往非常困难。这时，之前讨论的 SIEM 设备就非常有用。如果 SIEM 没有预配置以获取和分析事件日志，另一种选择是
    Skadi 平台。这个开源平台可以从 GitHub 获取，网址是 [https://github.com/orlikoski/Skadi](https://github.com/orlikoski/Skadi)，它是一组安装在
    Ubuntu 16.04 LTS 服务器基础镜像上的应用程序和取证工具。
- en: The primary tool that this chapter will focus on is the Elastic Stack, which
    is included as part of the Skadi platform. The other major feature that Skadi
    offers is the ability to ingest logs and other forensic data that is acquired
    through `CyLR.exe`. As previously discussed, `CyLR.exe` can be configured to send
    its output via SFTP to a remote system. Skadi combines an additional tool with
    `CyLR.exe`, to produce a dataset that is ingestible by the Elastic Stack on Skadi.
    This feature allows responders to run `CyLR.exe` on several different systems
    and have it sent directly to Skadi, where it can then be processed, indexed, searched,
    and correlated.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将重点介绍的主要工具是 Elastic Stack，它是 Skadi 平台的一部分。Skadi 还提供的另一个主要功能是能够接收通过`CyLR.exe`获取的日志和其他取证数据。如前所述，`CyLR.exe`可以配置为通过
    SFTP 将输出发送到远程系统。Skadi 将一个附加工具与`CyLR.exe`结合，生成一个可由 Skadi 上的 Elastic Stack 接收的数据集。此功能允许响应者在多个不同系统上运行`CyLR.exe`，并直接将其发送到
    Skadi，之后可以对其进行处理、索引、搜索和关联。
- en: 'After `CyLR.exe` has finished, the responder will log into the Skadi console.
    From here, the **Cold Disk Quick Response** (**CDQR**) tool will be run to convert
    the data that’s been acquired into a format that can be ingested by the Elasticsearch
    tool. The following command starts the processing with CDQR:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 在`CyLR.exe`完成后，响应者将登录到 Skadi 控制台。从这里，**Cold Disk Quick Response**（**CDQR**）工具将运行，将已获取的数据转换为
    Elasticsearch 工具可以接收的格式。以下命令启动 CDQR 处理：
- en: '[PRE4]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'CDQR takes the input, `jsmith-pc.zip`, from `CyLR.exe` and outputs it to the
    `Results` folder. The `-p` argument selects the parser. In this case, since `DESKTOP-SKPTDIO`
    is a Microsoft Windows system, the `win` parser is selected. Next is `--max_cpu`.
    This argument allows analysts to throttle the CPU usage of the Skadi machine.
    If multiple `CyLR.exe` outputs are being processed, the analyst should omit this
    argument. The next argument, `-z`, indicates that the file is a ZIP file. Finally,
    the `--ex_kb` argument tells CDQR to output the results into Kibana with an index
    name of `DESKTOP-SKPTDIO`. This indexing allows analysts to differentiate between
    systems within the Kabana application:'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: CDQR 从`CyLR.exe`接收输入文件`jsmith-pc.zip`，并将其输出到`Results`文件夹。`-p`参数选择解析器。在此情况下，由于`DESKTOP-SKPTDIO`是一个
    Microsoft Windows 系统，因此选择`win`解析器。接下来的参数是`--max_cpu`。此参数允许分析人员限制 Skadi 机器的 CPU
    使用率。如果正在处理多个`CyLR.exe`输出，分析人员应省略此参数。接下来的`-z`参数表示文件是一个 ZIP 文件。最后，`--ex_kb`参数告诉
    CDQR 将结果输出到 Kibana，索引名称为`DESKTOP-SKPTDIO`。这个索引允许分析人员在 Kibana 应用程序中区分不同的系统：
- en: '![Figure 12.21 – CDQR execution ](img/Image_B18571_12_21.jpg)'
  id: totrans-175
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.21 – CDQR 执行](img/Image_B18571_12_21.jpg)'
- en: Figure 12.21 – CDQR execution
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.21 – CDQR 执行
- en: 'After this process has finished, the results can be viewed in the Kibana GUI,
    as follows:'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 处理完成后，结果可以在 Kibana GUI 中查看，如下所示：
- en: 'Navigate to the IP address of the Skadi server and enter the username and password.
    The default is `skadi:skadi`. This opens the portal shown in the following screenshot:'
  id: totrans-178
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 导航到 Skadi 服务器的 IP 地址，并输入用户名和密码。默认是`skadi:skadi`。这将打开如下截图所示的门户：
- en: '![Figure 12.22 – Skadi portal ](img/Image_B18571_12_22.jpg)'
  id: totrans-179
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.22 – Skadi 门户](img/Image_B18571_12_22.jpg)'
- en: Figure 12.22 – Skadi portal
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.22 – Skadi 门户
- en: 'Click on **Kibana**; the following screen will appear:'
  id: totrans-181
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**Kibana**，以下屏幕将会出现：
- en: '![Figure 12.23 – Kibana GUI ](img/Image_B18571_12_23.jpg)'
  id: totrans-182
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.23 – Kibana GUI](img/Image_B18571_12_23.jpg)'
- en: Figure 12.23 – Kibana GUI
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.23 – Kibana GUI
- en: 'From here, click **Discover**. In the top right-hand corner, set the date to
    an appropriate time range. Kibana defaults to the last 15 minutes of data. For
    offline data, set the time range that is applicable or simply click **Last 2 years**,
    as follows:'
  id: totrans-184
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从这里，点击**Discover**。在右上角，设置日期为合适的时间范围。Kibana 默认显示过去 15 分钟的数据。对于离线数据，设置适用的时间范围，或者直接点击**过去
    2 年**，如下所示：
- en: '![Figure 12.24 – Kibana’s Discover dashboard ](img/Image_B18571_12_24.jpg)'
  id: totrans-185
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.24 – Kibana 的 Discover 仪表板](img/Image_B18571_12_24.jpg)'
- en: Figure 12.24 – Kibana’s Discover dashboard
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.24 – Kibana 的 Discover 仪表板
- en: 'Kibana is feature-rich and provides a wide range of options in terms of analyzing
    data. This includes the use of customer queries, event IDs, keywords, and XML
    strings. In this case, the responder will focus on event ID 4104, which indicates
    that a PowerShell command was run remotely. Then, look at adding an XML filter
    on the IP address associated with the DeepBlueCLI output. In this case, select
    `4104` and click **Save**. This will run the command:'
  id: totrans-187
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: Kibana 功能丰富，提供了广泛的数据分析选项。这包括使用自定义查询、事件 ID、关键字和 XML 字符串。在这种情况下，响应者将专注于事件 ID 4104，该事件
    ID 指示远程运行 PowerShell 命令。然后，查看在与 DeepBlueCLI 输出关联的 IP 地址上添加 XML 筛选器。在这种情况下，选择 `4104`
    并单击 **保存**。这将运行命令：
- en: '![Figure 12.25 – Filter on Event ID ](img/Image_B18571_12_25.jpg)'
  id: totrans-188
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.25 – 根据事件 ID 筛选 ](img/Image_B18571_12_25.jpg)'
- en: Figure 12.25 – Filter on Event ID
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.25 – 根据事件 ID 筛选
- en: 'This produces a total of 176 total entries with that event identification.
    To reduce this further, let’s go ahead and add the second filter for the XML data,
    `192.168.191.253`:'
  id: totrans-190
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这将产生 176 个总共的带有该事件标识的条目。为了进一步减少这个数量，让我们继续添加第二个用于 XML 数据的筛选器，`192.168.191.253`：
- en: '![Figure 12.26 – Filter on IP address ](img/Image_B18571_12_26.jpg)'
  id: totrans-191
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.26 – 根据 IP 地址筛选 ](img/Image_B18571_12_26.jpg)'
- en: Figure 12.26 – Filter on IP address
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.26 – 根据 IP 地址筛选
- en: This produces two results. An analysis of the results confirms the results that
    were shown in DeepBlueCLI.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 这样就产生了两个结果。对结果的分析确认了在 DeepBlueCLI 中显示的结果。
- en: 'What can be helpful is to see if there are additional results with that IP
    address. In the `192.168.191.253`. By drilling into an entry with Event ID 600,
    an additional PowerShell entry shows that a version of PowerCat, a PowerShell
    script that has the functionality of the popular hacking tool Netcat, was run:'
  id: totrans-194
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 看到是否有与该 IP 地址相关的额外结果可能会有所帮助。通过深入研究具有事件 ID 600 的条目，可以看到额外的 PowerShell 条目显示，这是
    PowerCat 的一个版本，PowerCat 是一款具有类似于流行黑客工具 Netcat 功能的 PowerShell 脚本：
- en: '![Figure 12.27 – Meterpreter event entry ](img/Image_B18571_12_27.jpg)'
  id: totrans-195
  prefs: []
  type: TYPE_IMG
  zh: '![图 12.27 – Meterpreter 事件条目 ](img/Image_B18571_12_27.jpg)'
- en: Figure 12.27 – Meterpreter event entry
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12.27 – Meterpreter 事件条目
- en: Skadi, combined with `CyLR.exe`, provides the responder with the ability to
    acquire and analyze log files from several systems involved in the incident. The
    ability to pivot off specific Event IDs or keywords makes Skadi a powerful tool
    to zero in on specific log entries that are important in identifying additional
    evidence in an incident investigation. By analyzing these events, we can see that
    an adversary was able to remotely execute PowerShell and install a remote network
    service.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: Skadi 结合 `CyLR.exe`，为响应者提供了从涉及事件的几个系统中获取和分析日志文件的能力。通过特定的事件 ID 或关键字进行透视，使 Skadi
    成为在识别事件调查中重要的特定日志条目的强大工具。通过分析这些事件，我们可以看到攻击者能够远程执行 PowerShell 并安装远程网络服务。
- en: Summary
  id: totrans-198
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: At the heart of log analysis is the assumption that actions by an adversary
    will leave a trace. Just as in the physical world, responders’ ability to see
    these traces is based upon the tools and techniques that are used. This chapter
    explored the foundational elements of logs and log management, as well as tools
    such as SIEM to aggregate and review these logs, and, finally, looked at the tools
    and techniques to examine the most prevalent logs that originate from the Windows
    OS. This chapter has only scratched the surface concerning how logs play an integral
    part in an incident investigation.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 在日志分析的核心是一种假设，即攻击者的行动会留下痕迹。正如在物理世界中一样，响应者能够看到这些痕迹的能力基于所使用的工具和技术。本章探讨了日志和日志管理的基础元素，以及诸如
    SIEM 之类的工具来聚合和审查这些日志，最后还审视了用于检查源自 Windows 操作系统的最常见日志的工具和技术。本章仅仅是浅尝辄止，介绍了日志在事件调查中起着重要作用的一部分。
- en: In keeping with the theme of understanding the traces of an adversary attack,
    the next chapter will examine the role that malware analysis plays in incident
    response.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 符合理解对手攻击痕迹主题的要求，下一章将探讨恶意软件分析在事件响应中的作用。
- en: Questions
  id: totrans-201
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 问题
- en: 'Answer the following questions to test your knowledge of this chapter:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 回答以下问题来测试你对本章的了解：
- en: For effective log management, an organization should establish logging as a
    normal business practice.
  id: totrans-203
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为了有效的日志管理，组织应将日志记录作为正常的业务实践。
- en: 'True'
  id: totrans-204
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 'True'
- en: 'False'
  id: totrans-205
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 'False'
- en: Which is not one of the functions of a SIEM?
  id: totrans-206
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 下列哪项不是 SIEM 的功能之一？
- en: Log retention
  id: totrans-207
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 日志保留
- en: Automated response
  id: totrans-208
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 自动响应
- en: Alerting
  id: totrans-209
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: Alerting
- en: Log aggregation
  id: totrans-210
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 日志聚合
- en: Which of these is not part of the Elastic Stack?
  id: totrans-211
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 下列哪个不是 Elastic Stack 的一部分？
- en: Kibana
  id: totrans-212
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: Kibana
- en: Elasticsearch
  id: totrans-213
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: Elasticsearch
- en: Log response
  id: totrans-214
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 日志响应
- en: Logstash
  id: totrans-215
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: Logstash
- en: Locard’s exchange principle states that when two objects come into contact with
    each other, they leave traces.
  id: totrans-216
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 洛卡尔交换原理指出，当两个物体相互接触时，它们会留下痕迹。
- en: 'True'
  id: totrans-217
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 真
- en: 'False'
  id: totrans-218
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 假
- en: Further reading
  id: totrans-219
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 进一步阅读
- en: 'For more information about the topics that were covered in this chapter, refer
    to the following resources:'
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 有关本章所涵盖主题的更多信息，请参考以下资源：
- en: 'Windows Security Log Events: [https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/)'
  id: totrans-221
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'Windows 安全日志事件: [https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/)'
- en: 'Graylog: [https://github.com/Graylog2](https://github.com/Graylog2)'
  id: totrans-222
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'Graylog: [https://github.com/Graylog2](https://github.com/Graylog2)'
- en: 'Skadi: [https://github.com/orlikoski/Skadi](https://github.com/orlikoski/Skadi)'
  id: totrans-223
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'Skadi: [https://github.com/orlikoski/Skadi](https://github.com/orlikoski/Skadi)'
- en: 'Applied Incident Response Windows Event Log Analysis: [https://forwarddefense.com/media/attachments/2021/05/15/windows-event-log-analyst-reference.pdf](https://forwarddefense.com/media/attachments/2021/05/15/windows-event-log-analyst-reference.pdf)'
  id: totrans-224
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '应用事件响应 Windows 事件日志分析: [https://forwarddefense.com/media/attachments/2021/05/15/windows-event-log-analyst-reference.pdf](https://forwarddefense.com/media/attachments/2021/05/15/windows-event-log-analyst-reference.pdf)'
