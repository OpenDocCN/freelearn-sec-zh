# 第二章：网络基础知识

在我们能够将 Nmap 作为工具使用之前，我们首先需要了解它的基本工作原理。为了扫描网络（包括互联网），我们必须首先了解构建所有网络的概念。尽管本书不会深入描述网络概念 - 通过学习使用 Nmap，你不会成为*数据包忍者* - 但我们确实需要确保我们能够解释标准和高级 Nmap 扫描的扫描结果。没有网络基础，我们将无法进行扫描！

本章将涵盖以下主题：

+   网络如何工作

+   TCP 和 UDP 的区别

+   端口简介

+   端口扫描的工作原理

+   服务版本检测和横幅抓取的工作原理

# 互联网的结构

在我们深入了解网络软件的一些复杂性之前，了解互联网本身的设计是很重要的。在许多方面，互联网的功能与您家或办公室可能拥有的大型网络相同 - 当然，不同之处在于，互联网具有面向互联网的服务，而不是工作站。例如，大多数家庭在同一个**局域网**（**LAN**）上有许多计算机，但在互联网上只有一个 IP 地址。如果有人从他们的互联网连接设备扫描这个网络，他们只会看到面向互联网的服务 - 而不是每个家庭成员的个人计算机。这一点很重要，因为在互联网上，只有转发到某台机器的端口才能在给定的 IP 地址上访问。我们将在稍后看到一些例外情况。

然而，在您的局域网上扫描计算机时，通常可以看到所有打开的端口。这是因为当数据包在本地网络上传输时，而不是通过互联网传输时，您可以直接访问目标机器 - 您不必经过会阻止所有这些端口的路由器或交换机。这就是为什么，例如，在局域网聚会上托管服务器时，没有人需要在第三方设备中转发任何端口。

在本书的其余部分进行扫描时，请记住，有几个不同的因素可能有助于或阻止扫描检测到每个正在监听的服务。我们将在后面的章节中介绍一些问题，并在可能的情况下提供有用的解决方法。

# OSI 模型

要理解数据包（即从一台机器传输到另一台机器的信息位）如何运行网络，最好先对**开放系统互连**（**OSI**）模型有一个基本的了解。这是一种概念上的方式，可以理解网络在不同层上的工作方式。从物理上来说，网络只是带有电信号的硬件部件；实际上，理解开发人员和网络运营人员（以及计算机）使用的逻辑网络要困难得多。

最简单的解释是，不同的协议和信息位在模型的不同层上工作，并相互配合。下图简要解释了每个层次执行哪些角色，以便我们能够理解本章后面将介绍的服务横幅和端口的工作原理。

![OSI 模型](img/4065OS_02_01.jpg)

要有效地使用 Nmap 并解释准确的扫描结果，并不需要完全理解 OSI 模型或低级网络，但需要意识到并非所有的网络信息都是平等的 - 有些信息在某些时候是容易获得的，而在其他时候则更难获得。如果您有兴趣从深入的角度了解更多关于网络的知识，值得查看一些可以捕获数据包或在传输中查看数据包的工具，比如 Wireshark。

# 端口扫描

Nmap 是一个端口扫描器，但我们还没有涵盖端口实际上是什么。顾名思义，端口是访问计算机上的网络服务的一种方式。每台计算机有 65535 个端口，可以随时打开或关闭。一些服务，如 HTTP（用于提供网页）或 FTP（允许文件传输），有默认关联的端口。HTTP 运行在端口 80 上，FTP 运行在端口 21 上，依此类推。我们可以稍后参考常用端口的大型列表，幸运的是，Nmap 已经将这些列表包含在其分发包中。

概念化端口的一种方式是想象一栋公寓楼。在这个类比中，一栋公寓楼就是一个 IP 地址，楼内的每个公寓就是一个不同的端口。在这种情况下，这栋楼将有 65535 个公寓，是一个相当大的物业！

当您访问一个 IP 地址时，就像给公寓楼送披萨一样；您知道它在世界上的位置，但不知道确切的位置。这就是端口的作用！端口类似于公寓号码；使用端口号，我们将知道我们要去 5505 Internet St，公寓 443，以传送 HTTPS 流量！

端口通常通过在 IP 地址后加冒号来识别。如果您看到类似 127.0.0.1:22 的地址，那么您可以安全地假设您被指向 IP 地址 127.0.0.1 和端口 22。

# TCP 和 UDP

关于网络的一个重要概念是网络服务可以使用的两种主要协议：TCP 和 UDP。服务可以使用这些端口监听任一协议，而且经常这样做。TCP（经常显示为 TCP/IP）用于需要特定顺序的连接，例如加载网页。然而，UDP 是一种无连接的协议；无连接意味着 UDP 连接就像从一个 IP 地址（源地址）到另一个 IP 地址（目标地址）的数据高压水枪。由于互联网的工作方式，它是一个大型分组交换网络，这些数据包并不总是按顺序到达。对于像加载网页这样的事情，这将是一个巨大的问题。然而，对于其他用途，让数据以任何顺序到达是完全合理的。

例如，**VoIP**（语音 IP）通话通常使用 UDP 协议。对于数据到达其源的重要性更大，即使数据包丢失或顺序错乱。这样，虽然连接可能会出现轻微的听觉中断，但不会因等待数据加载而出现滞后。我们将在本书中研究的大多数服务都是基于 TCP 的，但是使用 Nmap 扫描 UDP 服务也是可能的（使用`-sU`标志）。然而，UDP 在成功传输数据包后不会收到回复；因此，要找出服务是否实际上正在监听给定的 UDP 端口，或者根本没有回复，可能需要花费很长时间。

# 服务横幅

现在我们了解了网络、端口、TCP 和 UDP 的基础知识，我们可以开始学习 Nmap 的复杂性——这是一个强大的工具，利用计算机和网络通信的各种不同元素，帮助我们获取有关各种不同计算机正在运行的服务的有用信息。

Nmap 最常见的用途，也是它最初的设计，是一个简单的端口扫描器。端口扫描器只是一种尝试连接到每个特定目标端口并查看该端口是否打开的软件，以确定是否可以建立 TCP 三次握手。

TCP 三次握手是在应用程序开始相互通信之前建立网络连接的简单方法。结构非常简单，如果现在这些标志对你来说意义不大也不用担心。正如你所期望的，三次握手是在两个通信方（我们称他们为 Alice 和 Bob）之间进行的三个步骤。握手的过程如下：

+   Alice 正在请求与 Bob 建立连接。Alice 向指定端口发送**SYN**给 Bob。

+   如果 Bob 想要建立这个连接，Bob 会向 Alice 发送**SYN/ACK**的响应。

+   Alice 接收到**SYN/ACK**，并通过发送**ACK**给 Bob 来验证连接是否建立。

你可以通过参考以下图表来直观地理解这是如何工作的：

![服务横幅](img/4065OS_02_02.jpg)

一旦你理解了如何在特定端口上建立连接，就相对容易理解最基本的 Nmap 端口扫描——即 SYN 扫描是如何工作的。Nmap 向范围内的每个端口（通常是最常见的 1000 个端口，或者主机上的全部 65535 个端口）发送一个**SYN**请求，并等待**SYN/ACK**响应。如果收到了**SYN/ACK**响应，那么该开放端口上有一个服务在监听。恭喜！我们现在已经介绍了基本端口扫描的工作原理。不仅仅是 SYN 扫描，还有许多不同类型的扫描，但请求/响应模型的基本思想现在应该相当清晰了。

然而，当我们扫描端口时，通常我们感兴趣的不仅仅是端口是否在线。虽然大多数 Web 服务器监听在端口 80 上（这是 HTTP 分配的端口），但有人也可以将 Web 服务器放在端口 12345 或 1337 上。重要的不仅仅是了解端口是否开放，还要了解实际监听的是什么服务。

幸运的是，Nmap 自带了一个内置的服务版本检测模块。这个功能通过创建到实际监听服务的连接，并寻找服务横幅来实现。几乎每个基于网络的服务都可以通过其初始服务横幅来识别；即使不能，协议检测也允许 Nmap 识别正在运行的协议，即使不是确切的服务器版本。我们将在下一章学习如何进行基本扫描，包括服务版本检测。

# 总结

阅读完本章后，你应该对计算机网络的工作原理有了基本的了解。具体来说，了解 TCP 和 UDP 的区别以及端口扫描本身的功能是很重要的。现在你知道互联网是一个非常庞大的计算机网络，你也可以在本地局域网上扫描机器，你应该有了一个坚实的基础，继续学习 Nmap 的工作原理以及你可以在各种情况下使用的高级功能。

在下一章中，我们将学习如何进行基本的 Nmap 扫描，以便在最常见的情况下获得结果。下一章将让你开始扫描不同类型的端口和服务！
