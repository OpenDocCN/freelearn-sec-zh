

# 第十章：GCP 中的安全功能

欢迎来到**谷歌云平台**，简称`GCP`。GCP 是本书中提到的三大最流行云平台中的最后一个。GCP 的工作方式与 AWS 和 Azure 非常相似，但也有一些独特的方面，渗透测试人员在进行平台渗透测试之前需要了解。

首先，让我们来看看 GCP 生态系统中一些最常用的方面。在本章中，你将了解最受欢迎的 GCP 服务、应用和功能，以及它们的用途。接下来，我们将深入探讨 GCP 的**软件即服务**（**SaaS**）、**基础设施即服务**（**IaaS**）和**平台即服务**（**PaaS**）功能。最后，我们将讨论谷歌自有的 GCP 安全工具以及第三方安全工具。

在我们进行 GCP 渗透测试之前，了解我们所在公司可能如何使用 GCP，以及谷歌提供的哪些安全功能可以帮助渗透测试人员了解他们所使用的 GCP 部署的安全态势，会有所帮助。

本章涵盖以下主要主题：

+   GCP 简介

+   常用的 GCP SaaS 应用

+   GCP IaaS 服务

+   GCP PaaS 服务

+   GCP 安全控制和工具

让我们开始吧！

# GCP 简介

谷歌推出的第一项服务是它的同名搜索引擎。那是在 1998 年，当时普通人开始大量使用互联网。创始人拉里·佩奇和谢尔盖·布林使用的第一台服务器（[`infolab.stanford.edu/pub/voy/museum/pictures/display/0-4-Google.htm`](http://infolab.stanford.edu/pub/voy/museum/pictures/display/0-4-Google.htm)）配备了 10 个 4GB 的硬盘，它们的硬件放在由乐高积木搭建的框架中！他们的第一台服务器运行在斯坦福大学的网络基础设施和场地上。

谷歌专为企业客户推出的第一项服务是其 AdWords 广告平台，现在称为 Google Ads（[`ads.google.com/home/`](https://ads.google.com/home/)）。此后几年，它推出了许多仍然非常流行的服务，例如 Gmail，并且它也关闭了更多的服务（[`killedbygoogle.com/`](https://killedbygoogle.com/)）。

一项应该能持续发展并进化多年的服务集合是 GCP。

GCP 最初只是 2008 年的 App Engine ([`cloudplatform.googleblog.com/2008/04/introducing-google-app-engine-our-new.html`](https://cloudplatform.googleblog.com/2008/04/introducing-google-app-engine-our-new.html))。那是亚马逊推出 AWS（我们现在所知的版本）大约两年之后。App Engine 是一个让企业和其他实体能够在 Google 平台内推出自己网络应用程序的方式。在 App Engine 初期，Google 将其使用限制在 10,000 个客户。这样，Google 有机会修复漏洞，并逐步扩展其基础设施，以便与亚马逊的 AWS 和微软的 Azure 更具竞争力。

到 2011 年 11 月，Google 将 App Engine 作为正式支持的产品，提供给任何愿意为其服务付费并遵守其政策的个人或实体。Google 逐步推出更多云服务，而 App Engine 成为 GCP 旗下多个产品中的一个。

截至 2023 年，GCP 的免费套餐提供的磁盘存储（5 GB 的云存储）比 Google 第一台服务器机器中单个 HDD 的整个容量（4 GB）还要大。Google 服务 25 年来，我们的进步确实不小！

在 GCP 进行任何渗透测试之前，重要的是要审查 Google 的*Google Cloud Platform 可接受使用政策*，以确保我们遵守该政策。以下内容来自 Google Cloud ([`cloud.google.com/terms/aup?sjid=12831346254261876451-NA`](https://cloud.google.com/terms/aup?sjid=12831346254261876451-NA))：

*客户同意不使用，也不允许第三方使用* *服务：*

+   *侵犯或鼓励侵犯他人法律权利* *的行为；*

+   *从事、宣传或鼓励非法活动，包括儿童性剥削、儿童虐待或恐怖主义或暴力行为，这些行为可能对个人或群体* *造成死亡、严重伤害或伤害；*

+   *出于任何非法、侵入性、侵权、诽谤或欺诈目的，包括非自愿明确图像（NCEI）、侵犯他人知识产权、网络钓鱼或创建* *金字塔骗局；*

+   *传播病毒、蠕虫、木马、损坏文件、骗局或其他具有破坏性或* *欺骗性质的项目；*

+   *未经授权访问、干扰或削弱客户、授权经销商或其他* *授权用户使用服务或提供服务的设备；*

+   *禁用、干扰或规避任何服务、软件或用于提供服务的设备的任何方面；*

+   *生成、传播、发布或促进未经请求的大宗电子邮件、促销、广告或其他 solicitations（“**垃圾邮件**”）；或*

+   *使用服务或与服务提供的任何接口，以违反其他 Google 产品或服务的服务条款的方式访问任何其他 Google 产品* *或服务。*

简而言之，你可以在 GCP 上进行渗透测试，而无需请求 Google 的许可。但你被允许做的事情是有限制的。你绝对不能进行任何可能对其他 GCP 客户造成干扰的渗透测试。这意味着不能进行 DDoS 攻击模拟，不能分发恶意软件，不能尝试访问你所在公司拥有的资产以外的内容，而且——显然——不能违反法律。鼓励非法活动和分发恶意软件还可能会危害到不使用 GCP 的人群。漏洞扫描、查找公司所拥有资源中的暴露和未受保护的敏感数据是被允许的。只要确保你的公司已经书面授权你进行这些操作。

现在，让我们探索一下 GCP 提供的内容。

# 常用的 GCP SaaS 应用

GCP 生态系统中有大量的应用和服务，其中许多被归类为 SaaS。这意味着 Google 提供了基础设施、平台和运行在其上的应用。作为用户或组织，你只需对输入到应用中的代码或数据负责。

由于 Google 对其 SaaS 服务有更大的责任和控制，因此你在遵守其政策的前提下，进行渗透测试的能力非常有限，甚至几乎没有。Google 支持团队表示如下内容（[`support.google.com/cloud/answer/6262505?hl=en#zippy=%2Cdo-i-need-to-notify-google-that-i-plan-to-do-a-penetration-test-on-my-project`](https://support.google.com/cloud/answer/6262505?hl=en#zippy=%2Cdo-i-need-to-notify-google-that-i-plan-to-do-a-penetration-test-on-my-project)）：

*我是否需要通知 Google，我计划对* *我的项目进行渗透测试？*

*如果你计划通过渗透测试评估你的云平台基础设施的安全性，你无需联系我们。你需要遵守云平台可接受使用政策和服务条款，并确保你的测试只影响你的项目（而不是其他客户的应用）。如果发现漏洞，请通过漏洞* *奖励计划* 进行报告。

这与基础设施有关，而非应用程序。你将拥有更多自由来渗透测试和漏洞扫描 Google 的 PaaS 和 IaaS 服务。

尽管如此，云渗透测试人员仍然需要了解 GCP 生态系统中有哪些 SaaS 服务。理解 GCP 中的 SaaS 有助于你了解你所在的组织如何整体使用 GCP。组织通常会使用一些 PaaS 或 IaaS 服务，除了 SaaS 之外，GCP 服务也能够互相连接。而且，有时，组织的 IaaS 和 PaaS 应用会与 GCP 的 SaaS 应用接口。如果一个组织的数据从 IaaS 或 PaaS 应用流向 SaaS 应用，那么这些数据的安全性可能会从 IaaS 或 PaaS 端进行渗透测试。

以下是一些最常用的 GCP SaaS 服务。

## Google Workspace

`Google Workspace` ([`workspace.google.com/`](https://workspace.google.com/)) 在某种程度上相当于谷歌的 Microsoft 365 for Business。Google Workspace 的特点是它将谷歌知名的生产力应用程序整合在一起，例如 Gmail、Google Calendar、Google Meet、Google Chat、Google Drive、Google Docs、Google Sheets、Google Slides 和 Google Forms。

如果这些听起来很熟悉，那是因为这个套件以前被称为 G Suite。谷歌确实喜欢不时地更改品牌名称！这让我们保持警觉！无论企业是否订阅 GCP，第一次使用 Google Workspace 时，都会获得 14 天的免费试用期。Google Workspace 及其组件具有更大的使用容量和企业特定功能，而这些功能在 Gmail、Google Docs 等消费者版本中是没有的。

## Google App Engine

`Google App Engine` 在本章开头提到过，因为它是谷歌为企业市场提供的首个云服务，也是首个 GCP 组件。

App Engine ([`cloud.google.com/appengine`](https://cloud.google.com/appengine)) 是一种在谷歌基础设施上部署 Web 应用程序的“无服务器”方式。虽然技术上有服务器，但 App Engine 用户不需要管理或配置它。

由于 App Engine 用户不管理其平台或基础设施，因此它本质上是一个 SaaS 服务。App Engine 用户可以使用 Node.js、Java、Ruby、C#、Go、Python 和 PHP 等常用的应用程序开发技术来构建应用程序。如果开发人员在其他平台上已经熟练掌握这些语言之一或多个，那么学习如何使用 App Engine 应该是相当容易的。

## Cost Management

AWS 和 Azure 都提供供其平台用户使用的应用程序，用于管理在这些平台上的云服务开支。谷歌也为 GCP 提供了类似的应用程序——`Cost Management`。

Cost Management ([`cloud.google.com/cost-management`](https://cloud.google.com/cost-management)) 不仅仅是简单地说“你上个月花费了 $364.24。”相反，它提供了大量的图表和图形，让你能够理解自己在使用每个 GCP 组件时的开支趋势。

当我带你完成在 *第十一章* 中部署 GCP 环境以进行渗透测试教育时，我强烈建议定期检查 Cost Management，以确保不会产生意外费用。如果不小心，免费服务可能会变成付费服务！

## Google Cloud app

`Google Cloud app` ([`cloud.google.com/app`](https://cloud.google.com/app)) 可以安装在你的 iPhone 或 Android 手机上，让你随时随地轻松查看你的 GCP 服务和网络。

配备物理键盘的笔记本电脑或台式 PC 是进行详细开发和管理工作时最理想的界面。但 Google Cloud 应用程序可以帮助您理解并发现生产问题，管理您的资源，如项目、计费、App Engine 应用和计算引擎虚拟机，接收和响应与生产相关的警报，并对您的 GCP 部署进行一般更改。

Google Cloud 应用程序的功能包括警报、错误报告、事件管理、可自定义的仪表板、计费以及检查您在计算引擎、云存储、云 SQL 和 App Engine 中的使用情况。

## Google 营销平台

Google 最早的盈利模式是基于广告收入（Google AdWords，现在称为 Google Ads）和为广告商提供数据挖掘服务。因此，Google 不仅懂技术，也非常了解营销。因此，**Google 营销平台**对于企业来说是非常有用的。

Google 营销平台 ([`marketingplatform.google.com/about/enterprise/`](https://marketingplatform.google.com/about/enterprise/)) 包括用于衡量用户如何使用您的应用程序的 Analytics 360，针对营销需求测试应用程序的 Optimize 360，帮助更好理解营销活动效果的 Search Ads 360，用于了解您在营销中使用的标签效果的 Tag Manager 360，以及帮助了解每个营销活动的效果的 Campaign Manager 360。

现在，让我们深入了解 IaaS。这些是提供给企业最多控制权的云服务，同时也将操作和确保服务安全的责任最大程度地委托给它们。

# GCP IaaS 服务

使用 GCP IaaS 服务，您可以获得最大的控制权，但同时也承担最大的责任。Google 提供其网络基础设施以及用于部署虚拟机的硬件和工具。

使用 IaaS 服务与部署本地云网络之间的主要区别在于，您所在的组织无法物理接触到基础设施。您所在的组织中的任何人都不允许触碰 GCP 数据中心中任何计算机的物理电源按钮。您甚至不被允许物理进入这些数据中心。

但是，在 IaaS 服务中，您有更多的自由来进行渗透测试活动。您仍然需要确保遵守 *Google Cloud Platform 可接受使用政策*。不过不用担心，因为我在*第十一章*和*第十二章*中提供的所有渗透测试教程都是符合政策的！

以下是 GCP 组件，它们为您的组织提供了 Google 的基础设施，并让您的组织完成其余工作。（这些服务有时也可以与其他服务结合，用于 PaaS 和 SaaS 提供的服务。）

## 计算引擎

`Compute Engine` ([`cloud.google.com/compute`](https://cloud.google.com/compute)) 是 GCP 组件，允许你的组织在 Google 的基础设施上运行虚拟机。Compute Engine 就是字面意思，它处理计算处理。Compute Engine 也推动了许多 GCP 的 PaaS 和 SaaS 服务。但如果你只是使用 Compute Engine 和 Cloud Storage，那你得到的就是一个 IaaS 解决方案。

Compute Engine 对于广泛的云网络应用场景非常有用，因为 Google 在其 GCP 数据中心拥有的硬件远远超过大多数公司能拥有的硬件。Compute Engine 特别适用于大量的 DevOps 和 **持续集成/持续部署**（**CI/CD**）需求。但你也可以在 Compute Engine 中部署简单的虚拟机（VM）。

## Cloud Storage

虽然 Compute Engine 基本上负责 CPU 功能，`Cloud Storage` ([`cloud.google.com/storage`](https://cloud.google.com/storage)) 负责磁盘功能。许多 SaaS 和 PaaS 解决方案也使用 Cloud Storage，但 Cloud Storage 也可以直接用于 IaaS 设置。

Google 说，使用 Cloud Storage，你可以存储任何数量的数据，并且可以随时检索。这个说法很大胆，但 Google 拥有存储 PB 级别数据的基础设施，如果你需要的话。只是不能免费提供——会收费的！当我们在下一章部署 GCP 网络用于教育目的时，我会免费获得 5 GB 的存储空间。这对于我的临时测试需求已经足够了。

## 受保护虚拟机（Shielded VMs）

如果你的组织处理的是额外敏感的数据，比如——例如——你在医疗、法律或公共部门工作，受保护虚拟机可能是最适合你云安全和合规需求的解决方案。

**受保护虚拟机**（Shielded VMs）([`cloud.google.com/shielded-vm`](https://cloud.google.com/shielded-vm)) 是专门配置的，用来实施防止启动病毒和根工具的安全控制。根工具是授予攻击者恶意管理员权限的恶意软件，而启动病毒是能够在操作系统启动过程中持久执行的恶意软件。

受保护虚拟机（Shielded VMs）运行在专用硬件上，使用特殊的 **统一可扩展固件接口**（**UEFI**）固件（该固件用于在物理机器启动操作系统或虚拟机监控程序前启动机器），虚拟可信平台模块和完整性监控。

在 GCP 的标准 Compute Engine 配置中，你可以以非常安全且符合规定的方式运行虚拟机，但受保护虚拟机通过其专用硬件和其他功能更进一步。如果一个组织的安全需求特别高，并且有相应预算，他们通常会选择多花点钱购买受保护虚拟机。尝试渗透测试受保护虚拟机中的额外安全控制将会带来麻烦，所以不要考虑这样做！

## 独占节点（Sole-tenant nodes）

**独占节点**是另一种可能非常昂贵的 IaaS 选项，用于在 Google 的基础设施上部署超敏感的应用程序。

像 GCP 这样的云平台可以用来部署公共云和私有云。大多数 GCP 用户实现的是公共云服务，这意味着我们的应用程序运行在同样也供其他 GCP 客户使用的硬件上。每当我在本书中向你讲解如何部署云网络用于教育目的时，我们使用的都是公共云服务。

私有云可以托管在公司自己的场所，但 GCP 和其他云平台也提供可以仅供单一客户使用的机器。这里所说的“客户”是指订阅云服务以托管自己应用程序的个人或公司，而不是指客户的客户，如果这样说清楚的话。假设我是一个 GCP 客户，我可以支付 GCP 服务费用来托管我的鞋店电子商务网站。我从我的 GCP 托管站点购买鞋子的顾客，在这个意义上并不是 GCP 客户；我才是 GCP 客户。呼！

不管怎样，GCP 所称的独占节点（[`cloud.google.com/compute/docs/nodes/sole-tenant-nodes`](https://cloud.google.com/compute/docs/nodes/sole-tenant-nodes)）是另一种在 GCP 生态系统中部署私有云服务的方式。某些行业和公司出于合规性要求必须仅使用私有云服务。因此，他们可能会支付高额费用给 Google，以确保他们的机器不会与其他 GCP 客户共享。

所以，那些是可以用于 IaaS 部署的 GCP 服务。现在，轮到 PaaS 了。

# GCP PaaS 服务

PaaS 介于 SaaS 和 IaaS 之间。SaaS 意味着你基本上只是在 Google 的应用程序中运行你的代码、命令、文档或媒体，运行在 Google 的平台和基础设施上。IaaS 意味着 Google 允许你使用它的硬件，但你负责提供自己的平台和应用程序。PaaS 意味着 Google 提供一个平台，你可以在其上运行自己的应用程序。

PaaS 的责任和工作量不如 IaaS 部署那样大，但它仍然比 SaaS 更具工作量。以下是 GCP 中的一些服务，它们为客户提供 Google 的平台，以支持客户自己的定制应用程序。

## 云 SDK

`Cloud SDK`（[`cloud.google.com/sdk`](https://cloud.google.com/sdk)）是开发人员的标准开发工具包。它包括 Java、Python、Node.js、Ruby、Go、.NET、C++、PHP 和 **高级商业应用编程**（**ABAP**）的客户端库。它具有可以集成到 Google Cloud CLI 中的特殊工具。

简而言之，Cloud SDK 是一组工具，开发人员可以使用它们来开发自己的定制应用程序，利用 GCP 生态系统中的各种技术。

## Cloud SQL

`Cloud SQL` 用于在 GCP 上托管 **结构化查询语言**（**SQL**）数据库。绝大多数后台驱动的应用程序，无论是基于 Web 的还是其他类型的，都至少需要一个数据库。而如今，绝大多数数据库都使用某种类型的 SQL。

Cloud SQL ([`cloud.google.com/sql`](https://cloud.google.com/sql)) 是一个托管的关系数据库服务，支持 MySQL、PostgreSQL 和 SQL Server。它消除了许多部署 SQL 服务器的麻烦。Cloud SQL 简化了 SQL 服务器的部署和管理过程。

## Cloud Run

`Cloud Run` ([`cloud.google.com/run`](https://cloud.google.com/run)) 使得部署容器化应用程序变得更加容易。如果需要，Cloud Run 可以使用 Docker 镜像。（不过，`Google Kubernetes Engine`（**GKE**）可能是 Kubernetes 部署的更好选择。）

Cloud Run 支持 Go、Python、Java、Node.js、.NET、Ruby 以及其他许多流行的应用开发编程语言。

## GKE

所以，这自然过渡到了 GKE。

Kubernetes 是一个容器编排平台，建立在 Docker 核心功能的基础上。Kubernetes 是开源的，并使用许多开源标准，但最初是由 Google 的一个团队开发的，包括 Joe Beda、Brendan Burns 和 Craig McLuckie。因此，尽管可以在 AWS 和 Azure 上通过原生支持部署 Kubernetes，但可以说 GCP 才是 Kubernetes 的真正家园。GKE ([`cloud.google.com/kubernetes-engine`](https://cloud.google.com/kubernetes-engine)) 是在 GCP 中部署 Kubernetes 最便捷的方式。

## Anthos

`Anthos` ([`cloud.google.com/anthos`](https://cloud.google.com/anthos)) 旨在帮助组织部署多云和混合云网络。

正如本书前两章所解释的，混合云是指公司在云平台上拥有服务，并在本地拥有服务器，两者互相集成。多云是指组织使用多个云服务提供商，并且来自多个提供商的云服务相互集成。

所以，一个组织可能拥有 GCP 服务和一些自有服务器，这就是混合云。它们可能在 AWS、Azure 和 GCP 上都有服务，这就是多云。它们也可能有自有服务器和 AWS、Azure、GCP 上的服务，这就是同时拥有混合云和多云的情况。这就是混合多云！

Anthos 使得管理这些不同类型的云配置变得更加简单。

接下来，让我们看看一些重要的 GCP 安全控制和应用程序。

# GCP 安全控制和工具

让我们来看看 Google 为 GCP 客户提供的一些应用和功能，以提升他们的安全性。你的组织真应该使用这些功能！然后，我们将讨论一些有用的第三方安全工具。

## 安全控制

Google 提供了许多有用的应用程序，可以帮助我们管理 GCP 中的安全态势。让我们来看看它们。

### 身份与访问管理

**身份与访问管理**（**IAM**）（[`cloud.google.com/iam`](https://cloud.google.com/iam)）是云安全的重要组成部分，GCP 也不例外。

用户和用户组会被授予有关他们可以对公司文件、应用程序和其他云资源执行哪些操作的权限。您的组织应当实施**最小权限原则**（**PoLP**），确保用户和用户组仅拥有执行工作所需的最小访问权限，而不会过度访问。

IAM 与 Cloud Identity 配合使用，用于在应用和项目之间同步用户帐户。**双因素认证**（**2FA**）可以直接通过 Google 管理控制台进行设置。这非常有用，因为云安全基准和一些数据法规要求用户除了密码外，还必须提供其他认证方式。

要求启用 2FA（或**多因素认证**，**MFA**）并不是为了让管理员和用户烦恼的愚蠢规定。密码被认为是一种弱认证方式，因为它们经常被破解或泄露。增加另一个认证因素可以像用户在手机上安装 Google Authenticator，并在登录公司 GCP 服务时输入该应用生成的 OTP 一样简单。

IAM 还具有强大的详细用户帐户日志功能。每个用户都必须对自己的行为负责，IAM 使管理员能够看到每个用户的操作记录。这些日志还可以传送到其他安全工具中，如**入侵检测系统**（**IDS**）。

### Cloud IDS

说到 IDS，有`Cloud IDS`，这是 GCP 的原生 IDS。

当正确使用 Cloud IDS（[`cloud.google.com/intrusion-detection-system`](https://cloud.google.com/intrusion-detection-system)）时，它可以检测许多种恶意软件攻击和从**命令与控制**（**C2**）服务器发起的网络攻击。

Cloud IDS 可以监控 GCP 部署中的东西向流量和南北向流量。东西向流量是在云网络内部不同服务和机器之间的流量，而南北向流量则是云网络与公共互联网及其他外部网络之间的流量。网络攻击可以在东西向和南北向流量中传播！

Cloud IDS 可以生成警报，帮助管理员在攻击发生时及时应对。

Cloud IDS 生成的数据也可以在网络安全事件发生后用于调查。

### Cloud Firewall

`Cloud Firewall` 可以配置为过滤或限制云网络内某些类型的流量或网络活动。

谷歌表示，Cloud Firewall ([`cloud.google.com/firewall`](https://cloud.google.com/firewall)) 可以提供“*精细控制，包括无需重新架构网络的微分段*”。这是一堆复杂的计算机网络术语，我很乐意将其翻译成简单的英语——Cloud Firewall 让管理员可以控制非常小的活动以及更大活动中的小组件，包括在不需要完全改变网络设置的情况下，将一个网络划分为更小的管理区段。

防火墙有很多方式来管理流量，包括 Cloud Firewall。流量可以根据其 TCP/IP 端口、IP 地址、域名和用户账户来管理。Cloud Firewall 可以利用 **威胁情报**（**TI**）来自第三方，来确定需要阻止的 IP 地址、域名和用户。

### Secret Manager

`Secret Manager` ([`cloud.google.com/secret-manager`](https://cloud.google.com/secret-manager)) 为 GCP 用户提供了一种安全的管理其秘密的方式。这些秘密并不是指“我小时候数学课上不允许用计算器时偷偷用了计算器”这样的事，而是 Secret Manager 保护的是如密码、加密证书、API 密钥（它们让应用程序之间进行通信）以及其他各种敏感的身份验证数据。

因此，当您为 web 服务器设置 TLS 证书，或者用户通过 IAM 创建账户密码时，这些信息会被存储在 Secret Manager 中。可以把它当作一个巨大的银行保险库，里面有一扇厚重的防弹门，而所有的密钥都保存在里面。保护这些密钥是至关重要的，防止黑客和其他恶意实体对您的 GCP 应用程序和数据做出不良行为。

### Cloud DLP

`Cloud DLP`（即**数据丢失防护**）（[`cloud.google.com/dlp`](https://cloud.google.com/dlp)) 帮助确保您的 GCP 中的重要数据不会丢失！没错—它的名字正好描述了它的功能，但显然，它所使用的技术需要更多的描述。

Cloud DLP 可以使用掩码和令牌化来模糊化您的数据。例如，如果一个信用卡号码通过您的电子商务应用的**销售点**（**POS**）系统，而它的号码是 `G2F69`，Cloud DLP 可能会将其伪装成 `B7K31`（请注意，实际信用卡号码不会使用这种格式；这里我为了安全起见做了额外的保守处理！）

Cloud DLP 还可以向安全管理员展示某段数据是如何从这里经过，然后那里再经过，最后从另一个更远的组件流出的。当然，这不是那么模糊。Cloud DLP 还可以追踪数据离开云端的路径，并防止那些不应该离开云端的敏感数据被泄露。

### 安全指挥中心

`Security Command Center` ([`cloud.google.com/security-command-center`](https://cloud.google.com/security-command-center)) 是一个统一的界面，将这些 GCP 安全控制与其他 GCP 安全控制结合在一起。

理论上，你可以在一台显示器上打开一个 IAM 面板，独立于另一台显示器上显示的 Cloud Firewall 面板。

然而，当所有这些安全应用程序相互集成时，它对安全管理员的帮助非常大。当管理员能够看到一个安全组件如何与另一个组件协同工作，或者网络攻击如何尝试做一种坏事，然后再做另一种坏事时，这对于防御网络攻击帮助巨大。

Security Command Center 使得识别安全配置错误和多种类型的安全漏洞成为可能，从而能够尽快有效地解决这些问题。

除了帮助管理员检测网络威胁外，Security Command Center 还可以设置以帮助公司确保他们遵守适用于他们的数据安全法规。

现在，进入你在 GCP 中进行漏洞扫描和渗透测试时可以使用的第三方工具。

## 安全工具

许多非常有才华的渗透测试人员开发了旨在 GCP 中使用的第三方渗透测试和安全测试工具。此处提到的所有工具都是开源的，并可以通过 GitHub 获得。在本节中，你将找到我认为最有用的 GCP 渗透测试工具。

### GCPBucketBrute

`GCPBucketBrute` ([`github.com/RhinoSecurityLabs/GCPBucketBrute`](https://github.com/RhinoSecurityLabs/GCPBucketBrute)) 是由 Rhino Security Labs 开发的。你可能已经注意到，在本书中，Rhino Security Labs 还开发了一些我提到过的其他渗透测试工具，如 Pacu 和 CloudScraper。

GCPBucketBrute 是一个脚本，用于列举 Google Storage 桶，查看哪些组件和实体有权访问它们，以及是否可以提升权限。如果网络犯罪分子能够访问你组织的桶，尤其是当他们能够提升权限做任何他们想做的事情时，这非常危险。因此，渗透测试人员应该运行此工具，在坏人发现这些漏洞和攻击路径之前先找出这些问题。

根据 README 文件（[`github.com/RhinoSecurityLabs/GCPBucketBrute/blob/master/README.md`](https://github.com/RhinoSecurityLabs/GCPBucketBrute/blob/master/README.md)），脚本执行以下步骤来查找安全问题：

1.  *给定一个关键词，这个脚本会根据从* *关键词生成的多个排列组合来列举 Google Storage 桶。*

1.  *然后，任何发现的桶都会* *被输出。*

1.  *然后，任何你被授予的权限（如果有）对任何已发现的桶都会* *被输出。*

1.  *然后脚本将检查这些权限是否存在权限提升（storage.buckets.setIamPolicy），并输出任何有趣的信息（例如公开可列出、公开可写、经过身份验证可列出、权限提升等）。*

### Scout Suite

我之前提到过 nccgroup 的 Scout Suite ([`github.com/nccgroup/ScoutSuite`](https://github.com/nccgroup/ScoutSuite))。它也与 GCP 配合得很好，所以我再提一下。正如 README 所说：

“*ScoutSuite 是一个开源的多云安全审计工具，能够对云环境进行安全态势评估。通过使用云服务商公开的 API，Scout Suite 收集配置数据供人工检查，并突出显示风险区域。与在 Web 控制台上浏览数十页不同，Scout Suite 自动呈现攻击面视图。*”

和我提到的许多工具一样，您可以直接从每个平台使用的 CLI 运行 ScoutSuite。

### Hayat

`Hayat` ([`github.com/DenizParlak/hayat`](https://github.com/DenizParlak/hayat)) 由 Deniz Parlak 开发。Hayat 在土耳其语中意为“生命”，开发者还将其脚本命名为自己侄女的名字，真甜！

Hayat 是一款可以审计 Cloud SQL 实例、IAM、Cloud Storage、网络配置、VM、日志和监控系统以及 Kubernetes 集群的脚本。

Parlak 说这 *暂时* 就是这些，这似乎意味着将来会添加更多功能。我等不及了！

### gcp_firewall_enum

Chris Moberly 的 `gcp_firewall_enum` ([`gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp_firewall_enum`](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp_firewall_enum)) 解析您的 GCP 数据输出，列举出通过其网络端口暴露在互联网上的计算实例！过多这种暴露肯定是个坏事。

然后，gcp_firewall_enum 根据结果生成 Nmap 脚本。Nmap 是最常用的网络安全测试工具之一；它是一个网络映射器，可以用来绘制网络图。我喜欢这些描述性的名字——它们非常方便。

### Gcploit

`Gcploit` ([`github.com/dxa4481/gcploit`](https://github.com/dxa4481/gcploit)) 是一套用于渗透测试的工具集，旨在发现 GCP 中的安全漏洞。

让我们来看看它们吧！

+   `BFS Search` 是一款威胁建模工具。它可以帮助您找出威胁行为者可能如何攻击您的 GCP 应用程序。

+   `Mock Graph` 也可以用于威胁建模。

+   然后，主要的 Gcploit 组件执行两个特定的漏洞利用，`actAs` 和 `dataproc`。Dataproc API 用于配置数据资源，actAs 是一个可以用来进行恶意访问的漏洞利用。

Gcploit 基于 Dylan Ayrey 和 Allison D 在 2020 年 Black Hat 上的演示。在 Gcploit 的 README 中，他们提到过其他他们希望添加的漏洞，但尚未实现。

### gcp-iam-role-permissions

Brad Geesaman 和 Josh Larsen 的 `gcp-iam-role-permissions` ([`github.com/darkbitio/gcp-iam-role-permissions`](https://github.com/darkbitio/gcp-iam-role-permissions)) 是一个脚本，用于查找 GCP IAM 角色及其权限，包括基本角色和预定义角色。

在设置 GCP 中的用户帐户时，必须非常小心，保持默认设置通常是非常糟糕的主意，因为攻击者可能会尝试基于这些设置的漏洞。用户帐户及其访问权限应该根据一些与更改默认密码相同的原因进行定制。

Geesaman 和 Larsen 的工具帮助渗透测试人员在坏人之前检测出这些类型的漏洞。

### GCP Scanner

`GCP Scanner` ([`github.com/google/gcp_scanner`](https://github.com/google/gcp_scanner)) 拥有许多不同的贡献者，并且它在 Google 的官方 GitHub 账户下发布。但 README 的开头有这样的免责声明：

“*这个项目不是官方的 Google 项目。它不受 Google 支持，Google 特此声明不对其质量、适销性或特定用途的适用性承担任何保证。*”

那肯定和 Google 的律师有关。这就像 Google 在说：“这是一个很酷的渗透测试工具，但如果它不能正常工作，别怪我们。”我觉得你还是应该尝试一下，尤其是如果你想在 GCP 部署中尝试，作为自己的教育用途。

GCP Scanner 可以帮助你确定在 GCP 网络和应用程序中某些凭据的访问级别。你可以将 GCP Scanner 的结果用于渗透测试报告，也可以用来加强你组织在配置 IAM 时的安全性。

GCP Scanner 可与以下类型的凭据一起使用：

+   GCP VM 实例元数据

+   存储在 Google Cloud (**gcloud**) 配置文件中的用户凭据

+   授予云平台范围的 OAuth2 刷新令牌

+   GCP 服务帐户密钥（JSON 格式）

GCP Scanner 可以测试 Compute Engine、App Engine、Cloud Storage、GKE、Bigtable、BigQuery 和 Cloud Functions。

我们一定会在 CLI 中运行 GCP Scanner，具体见 *第十一章*；应该会很有趣！

# 摘要

GCP 的根源可以追溯到 2008 年 Google 发布了 App Engine，这是一个让企业和其他实体可以在 Google 平台上发布自己 Web 应用程序的方式。App Engine 被证明非常受欢迎。因此，随着时间的推移，Google 发布了大量额外的云服务，企业和组织可以使用这些服务来管理其生产网络和网络应用程序。

GCP 是 Google 与 Amazon 的 AWS 和 Microsoft Azure 竞争的方式。然而，许多组织部署了多云网络，使用所有这些云平台以及更多平台。

在 IaaS 中使用的两个最重要的 GCP 组件（但也可以在 SaaS 和 PaaS 中使用）是 Compute Engine 和 Cloud Storage。Compute Engine 就像 CPU，Cloud Storage 就是你的磁盘。

Google 还提供了许多非常有用的安全控制，您的组织应该利用这些工具来增强抵御网络攻击的能力。它们包括云防火墙、IAM、密钥管理器、云 IDS 以及一些其他应用程序。管理员可以通过安全指挥中心的集成界面，全面实时查看组织的安全状态、安全事件和漏洞。

有许多第三方工具可用于对 GCP 进行渗透测试。它们包括 Scout Suite、GCPBucketBrute、Hayat、GCP Scanner、Gcploit 和 gcp_firewall_enum。

在我们已大致了解了如何对 GCP 进行渗透测试后，在下一章中，我们将对 GCP 中的 Docker 和 Kubernetes 集群进行渗透测试。

# 深入阅读

若要了解本章中涵盖的主题，您可以访问以下链接：

+   *GCP 免费* *套餐*: [`cloud.google.com/free`](https://cloud.google.com/free)

)

+   *Google Cloud* *产品*: [`cloud.google.com/products`](https://cloud.google.com/products)

)

+   *Google Cloud 平台服务条款*: [`cloud.google.com/terms/`](https://cloud.google.com/terms/)
