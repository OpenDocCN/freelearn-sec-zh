# 第九章：使用 Metasploit（Nessus）进行漏洞评估

在本章中，我们将介绍使用 Nessus 桥接 Metasploit 框架进行漏洞评估的一些方法。Nessus 是 Tenable 公司开发的漏洞扫描器。它被广泛用于进行网络安全评估。Nessus 桥接允许 Metasploit 解析和导入 Nessus 的扫描结果到其自己的数据库进行进一步分析和利用。我们甚至可以使用桥接在 Metasploit 内部启动 Nessus 扫描。

在本章中，我们将涵盖以下主题：

+   Nessus 简介

+   使用 Metasploit 的 Nessus

+   基本命令

+   修补 Metasploit 库

+   通过 Metasploit 执行 Nessus 扫描

+   使用 Metasploit DB 进行 Nessus 扫描

+   在 Metasploit DB 中导入 Nessus 扫描

# 技术要求

本章的先决条件如下：

+   Metasploit 框架

+   *nix 系统/微软 Windows 系统用于主机机器

+   Nessus Home Edition 或 Professional Edition

# Nessus 简介

Nessus 是由 Tenable 开发的最常见和易于使用的漏洞扫描器之一。这种漏洞扫描器通常用于对网络进行漏洞评估，Tenable Research 已发布了 138,005 个插件，涵盖了 53,957 个 CVE ID 和 30,392 个 Bugtraq ID。大量的 Nessus 脚本（NASL）帮助测试人员扩大他们发现漏洞的范围。Nessus 的一些特点如下：

+   漏洞扫描（网络、Web、云等）

+   资产发现

+   配置审计（MDM、网络等）

+   目标配置

+   恶意软件检测

+   敏感数据发现

+   补丁审计和管理

+   策略合规审计

Nessus 可以从[`www.tenable.com/downloads/nessus`](https://www.tenable.com/downloads/nessus)下载。安装完成后，我们必须激活该工具。激活可以通过[`www.tenable.com/products/nessus/activation-code`](https://www.tenable.com/products/nessus/activation-code)上的代码完成。

# 使用 Metasploit 的 Nessus

许多渗透测试人员使用 Nessus，因为它可以与 Metasploit 一起使用。我们可以将 Nessus 与 Metasploit 集成，通过 Metasploit 执行其扫描。在本节中，我们将按照以下步骤将 Nessus 与臭名昭著的 Metasploit 集成：

1.  在继续之前，请确保您已成功安装 Nessus，并且可以从浏览器访问 Nessus Web 界面：

![](img/b533025a-f883-481b-82c4-7eada2d01b4c.png)

1.  在 Metasploit 中，我们首先要使用`load nessus`命令在 msfconsole 中加载 Nessus 插件。这将加载 Metasploit 的 Nessus 桥接，如下所示：

![](img/806d0da9-4606-4566-bebf-b8ff7aa0a828.png)

1.  要查看插件提供的命令，请在 msfconsole 中执行`nessus_help`命令，如下所示：

![](img/a784d701-d6b8-4e69-8124-4b3eeae27467.png)

在我们可以对 Nessus 进行漏洞扫描之前，我们需要首先对其进行身份验证，这将在下一小节中完成。

# 通过 Metasploit 进行 Nessus 身份验证

Metasploit 使用 Nessus RESTful API 与 Nessus Core Engine 进行交互，只有在成功验证后才能完成。可以按以下方式完成：

1.  我们可以使用以下命令语法对 Nessus 进行身份验证：

```
nessus_connect username:password@hostname:port <ssl_verify/ssl_ignore> 
```

以下屏幕截图显示了前面命令的输出：

![](img/7baf7045-fc1b-45ee-9526-a2443628007f.png)

`用户名`和`密码`是我们用来登录 Nessus Web 前端的。`主机名`可以是 Nessus 服务器的 IP 地址或 DNS 名称，`端口`是 Nessus Web 前端运行的 RPC 端口。默认情况下，它是 TCP 端口`8834`。

`ssl_verify`用于验证 Nessus 前端使用的 SSL 证书。默认情况下，服务器使用自签名证书，因此用户应该使用`ssl_ignore`。如果我们不想一遍又一遍地使用相同的命令，我们可以将凭据保存在 Metasploit 可以用于与 Nessus 进行身份验证的配置文件中。

1.  要保存凭据，我们可以执行`nessus_save`命令。这将以 YAML 文件格式保存凭据，如下所示：

![](img/05ae4a10-2efd-484c-83ab-0c5396eff77c.png)

此 YAML 配置文件的内容如下：

![](img/9e1f9f47-54f2-4516-b360-e9648f4a5902.png)

如果我们想要注销，我们可以在 msfconsole 中执行`nessus_logout`命令，如下所示：

![](img/792ac3d5-6492-476b-8130-381ac7d3bbee.png)

现在我们已经成功通过 Nessus RESTful API 进行了身份验证，我们可以执行一些基本命令来开始。

# 基本命令

假设我们在一个组织中工作，并且只能通过 Metasploit 终端提供的凭据来访问 Nessus。在这种情况下，最好运行一些基本命令，以了解我们可以做什么和不能做什么。让我们在接下来的步骤中看看这些命令：

1.  我们可以在 msfconsole 中执行的第一个命令是`nessus_server_properties`。此命令将为我们提供有关扫描仪（类型、版本、UUID 等）的详细信息。根据扫描仪的类型，我们可以设置我们的扫描首选项，如下所示：

![](img/a4cfe25a-287b-4fbf-a9be-437521e7f606.png)

1.  `nessus_server_status`命令用于确认扫描仪的状态，以便我们可以确定它是否已准备就绪。这在组织使用具有分布式扫描仪代理的基于云的 Nessus 时非常有帮助。该命令的输出如下截图所示：

![](img/faa12f16-6646-4c7b-86fa-292f9421971a.png)

1.  `nessus_admin`命令用于检查经过身份验证的用户是否是管理员，如下所示：

![](img/29b246f1-0669-4f5e-b8c9-d95e88c76880.png)

1.  `nessus_folder_list`命令用于查看 Nessus 中可供我们使用的目录。运行该命令将给出以下输出：

![](img/12bc1b14-a19e-47d6-96cb-cfbc7fe0a5f1.png)

1.  `nessus_template_list`命令用于列出 Nessus 中所有可用的模板。（**注意**：我们可以使用`-h`标志来查看此命令的帮助部分）。可访问的模板将“Subscription Only”设置为`TRUE`。要使用所有模板，我们必须在线查找订阅。上述命令的输出如下截图所示：

![](img/aa697452-e348-4f96-a401-dd7c73df44ac.png)

在前面的截图中，`-h`标志用于查看命令的帮助部分。

1.  要查看在 Nessus 中配置的类别列表，我们执行`nessus_family_list`命令。执行此命令后，我们将看到所有可用类别（Family Names）及其相应的 Family ID 和插件数量，如下所示：

![](img/1f78a5a8-5858-43dd-a4b2-9e952e039606.png)

1.  要列出某个类别中的所有插件，我们可以执行`nessus_plugin_list <family ID>`命令。这将显示我们在 Nessus 中可以使用的所有插件，如下截图所示：

![](img/5df58389-a68d-415c-8a58-acbf98847830.png)

1.  要详细了解插件，我们可以在 msfconsole 中执行`nessus_plugin_details <plugin ID>`命令，如下所示：

![](img/45106ddc-01a7-4e64-ad27-0b3f739b93b2.png)

1.  要列出所有可用的自定义策略，我们可以执行`nessus_policy_list`命令。这将给我们提供策略 UUID，我们将使用它来执行漏洞扫描。这些策略用于执行自定义扫描。策略 UUID 可用于区分使用多个策略执行的不同扫描，如下所示：

![](img/dab12abf-4214-4360-a790-ed57b3287ee7.png)

要开始扫描，我们首先需要修补 Metasploit Gem，它负责与 Nessus RESTful API 通信（因为官方补丁尚未发布），以应对我们在运行扫描时可能遇到的错误。这是由`@kost`（[`github.com/kost`](https://github.com/kost)）开发的一个解决方法。如果不修补，Metasploit 将会抛出错误，如下截图所示：

![](img/56f16c03-eab5-4f53-9075-425ba3779b3e.png)

在下一节中，我们将看一下修补 Metasploit 库。

# 修补 Metasploit 库

自 Nessus 7.0 版本以来，状态更改请求（例如，创建/启动/暂停/停止/删除扫描）受到新的身份验证机制的保护。为了让 Metasploit 遵循新更新的用户身份验证机制，我们需要修补`nessus_rest` RubyGem。要做到这一点，只需在`RubyGems`目录中搜索`nessus_rest.rb`文件。不与 Nessus 的新身份验证机制交互的代码可以在**第 152 行**找到：

![](img/736150c9-b043-4bfc-93f1-3de027cf4841.png)

我们需要用这里给出的代码替换**第 152 行**的代码：

![](img/0071c2f0-8e20-4b9c-893a-6d9092f8e223.png)

代码可以在这里找到：[`github.com/kost/nessus_rest-ruby/pull/7/files`](https://github.com/kost/nessus_rest-ruby/pull/7/files)。

接下来，我们将执行 Nessus 扫描。

# 通过 Metasploit 执行 Nessus 扫描

现在我们已经修补了 Metasploit 库，让我们使用 Metasploit 进行 Nessus 扫描：

1.  修补完 gem 后，我们现在可以使用`nessus_scan_new <策略的 UUID> <扫描名称> <描述> <目标>`命令创建一个漏洞扫描任务，如下所示：

![](img/97bdcdbd-be5e-445c-9940-af9e77c55c23.png)

1.  任务创建后，我们可以通过执行`nessus_scan_list`命令来确认。`扫描 ID`将用于启动任务，所以让我们记下来，如下所示：

![](img/6bd1ef53-48fd-467a-848c-c4f240d6c57f.png)

1.  让我们通过访问 Nessus web 界面来确认一下相同的内容：

![](img/594d7e0a-1ed7-4daf-8745-96d0ef4f7029.png)

正如我们在前面的截图中看到的，扫描任务已经创建，但尚未启动。

1.  要启动扫描任务，我们需要执行`nessus_scan_launch <扫描 ID>`命令：

![](img/8f794d63-38e1-41a8-b51b-d8e9dead0134.png)

我们已经成功启动了扫描任务。

1.  让我们在 Nessus web 界面上确认一下：

![](img/71927e81-7c25-465b-83ae-b13fc120bed4.png)

1.  我们可以通过执行`nessus_scan_details <扫描 ID> <类别>`命令在 msfconsole 中看到与前面截图相同的详情：

![](img/2f367d5e-fbc5-4d6d-b8e8-a4c73898c017.png)

可以用以下可用类别来查看扫描详情：

+   **信息**：一般的扫描信息，包括扫描状态，用于扫描的策略，扫描名称，扫描目标，以及扫描的开始和结束时间

+   **漏洞**：Nessus 在给定目标上发现的漏洞列表，其中包括用于扫描目标的插件名称及其插件 ID，插件家族（类别）以及在目标上找到的实例总数

以下截图显示了漏洞命令的输出：

![](img/1ceddb0e-6408-4179-ae60-298e19ab0433.png)

+   **历史**：这是上次启动相同扫描任务的时间。这包括**历史 ID**，扫描的**状态**，**创建日期**和**最后修改日期**。

以下截图显示了历史命令的输出：

![](img/1c121956-c0b3-420a-af2d-abec8b45a95a.png)

1.  让我们从 Nessus web 界面上确认一下扫描详情：

![](img/07936ea5-dfe1-4e8c-b025-4c4b3586b0f3.png)

1.  现在让我们执行`nessus_report_hosts <扫描 ID>`命令来查看扫描的总体摘要，如下所示：

![](img/b2abc66d-6678-489c-b477-c6909e353624.png)

1.  要获取已识别的漏洞列表，可以执行`nessus_report_vulns <scan ID>`命令，如下所示：

![](img/2a2c4965-d5f9-4f84-bfda-3b0a755a6cd3.png)

使用 Metasploit 中的 Nessus 带来了一个好处：能够使用 Metasploit DB 进行扫描。在我们有一个存储在 Metasploit DB 中的目标列表并且想要对这些目标进行漏洞扫描的情况下，这可能非常有用。

# 使用 Metasploit DB 进行 Nessus 扫描

通过`nessus_db_scan <policy ID> <scan name> <scan description>`命令，可以将存储在 Metasploit DB 中的所有目标传递给 Nessus。在我们的情况下，我们在 Metasploit DB 中存储了目标`192.168.2.1` IP；执行此命令后，Nessus 将开始对存储在 Metasploit DB 中的目标 IP 进行扫描（不仅创建任务，还启动任务）：

![](img/fc616bc7-03e5-4007-97f8-ef2ab16bf3c1.png)

按照以下步骤进行：

1.  让我们通过 Nessus web 界面确认前面的执行：

![](img/dde21120-d705-479b-9b54-a45d5bfafd2d.png)

1.  正如我们在前面的截图中所看到的，扫描正在进行中。在我们管理 Metasploit 工作区的情况下，我们可以使用`nessus_db_scan_workspace`命令。在下面的截图中，我们有一个目标 IP 存储在`NESSUS-WEB`工作区中：

![](img/a8de8828-a0a6-46c0-94fb-2a3cd001da59.png)

1.  让我们执行`nessus_db_scan_workspace <policy ID> <scan name> <scan description> <workspace>`命令，在`192.168.2.1`上运行扫描，该扫描存储在`NESSUS-WEB`工作区中：

![](img/c485dc8e-4dc7-4955-abd7-19be1825f05c.png)

正如我们在前面的截图中所看到的，我们已经成功创建了一个扫描任务，将扫描存储在`NESSUS-WEB`工作区中的所有主机。

如果我们执行`nessus_db_scan_workspace`命令，就必须手动启动扫描任务。

1.  让我们使用`nessus_scan_launch <scan ID>`命令启动扫描。成功启动扫描任务后，我们将再次使用`nessus_scan_details`命令获取扫描状态：

![](img/3478944c-f855-4383-9f16-80523def20f7.png)

正如我们从前面的截图中所看到的，扫描已完成。

扫描结果不会保存在工作区中；相反，我们可以手动导入结果，或者使用`nessus_db_import`命令导入结果。请记住，只有在使用 Nessus Manager 时，才能访问一些功能。

现在我们已经介绍了如何使用 Metasploit DB 执行 Nessus 扫描，让我们继续下一部分，介绍如何将 Nessus 扫描结果导入 Metasploit DB。

# 在 Metasploit DB 中导入 Nessus 扫描

当我们没有访问 REST API 时，就会使用这种方法，这些 API 负责将结果直接导入到 DB 中。简单的解决方法如下：

1.  首先，将 Nessus 结果导出到文件中，下载文件，然后使用`db_import`命令导入相同的文件。

1.  要导出结果，请使用`nessus_scan_export <scan ID> <export format>`命令。（可用的导出格式为 Nessus、HTML、PDF、CSV 或 DB）。在过程中将分配文件 ID。

1.  导出准备就绪后，执行`nessus_scan_report_download <scan ID> <file ID>`命令：

![](img/dc195a73-c979-431d-a94f-4e13f721f335.png)

正如我们在前面的截图中所看到的，我们已将结果导出为 Nessus 格式并下载了文件。

1.  现在，使用`db_import`命令导入相同的文件。

1.  接下来，让我们执行`vulns`命令，确认 Nessus 结果是否已成功导入到 DB 中：

![](img/b7c13ac1-a15c-4c16-8904-3576687ef4cc.png)

1.  我们还可以通过执行`hosts`和`services`命令来确认前面的方法是否有效，如下所示：

![](img/49f77ce9-ff96-4809-9d3b-2c979476a66b.png)

如果使用正确，我们可以通过点击按钮（当然，还包括自定义的 Metasploit 脚本来管理项目和自动化）来高效地管理 VA 项目。

# 总结

在本章中，我们首先介绍了 Nessus 桥。然后我们学习了如何配置桥接。接下来，我们看到了如何从 Metasploit 控制台启动 Nessus 扫描，最后，我们学习了如何将扫描结果导入 Metasploit 数据库以供进一步使用。

在下一章中，我们将学习如何对**内容管理系统**（**CMS**）进行渗透测试，首先从流行的系统 WordPress 开始。

# 问题

1.  我需要在系统上安装 Nessus 才能与 Metasploit 一起运行吗？

1.  我可以在 Metasploit 中使用其他漏洞扫描器代替 Nessus 吗？

1.  Nessus 专业版可以与 Metasploit 一起使用吗？

1.  我可以通过 Metasploit 扫描多少个系统？

# 进一步阅读

以下链接是关于 Nessus 的官方博客文章，解释了为什么以及如何将 Nessus 与 Metasploit 一起使用：

[`www.tenable.com/blog/using-nessus-and-metasploit-together`](https://www.tenable.com/blog/using-nessus-and-metasploit-together)
