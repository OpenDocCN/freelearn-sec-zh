# 第八章：使用 WMAP 进行漏洞扫描

漏洞评估是识别、排名和分类网络或应用程序中的漏洞的过程。它为组织提供了对其资产和面临的风险的理解。在使用 Metasploit 时，可以使用单独的辅助模块或可用的插件进行漏洞扫描。Metasploit 框架还允许我们添加自己的自定义插件，如果我们有自己的漏洞扫描器（内部）。

WMAP 是 Metasploit 的插件，它使用户可以根据扫描中使用的 Metasploit 模块对目标进行漏洞扫描。此插件的最佳功能之一是能够根据测试人员的要求使用尽可能多的 Metasploit 模块（包括自定义模块）进行漏洞扫描。测试人员可以创建多个配置文件以适应不同的情况。

在本章中，我们将学习以下主题：

+   了解 WMAP

+   WMAP 扫描过程

+   WMAP 模块执行顺序

+   向 WMAP 添加模块

+   使用 WMAP 进行集群扫描

# 技术要求

本章的先决条件如下：

+   Metasploit 框架（[`github.com/rapid7/metasploit-framework`](https://github.com/rapid7/metasploit-framework)）

+   基于*nix 系统或 Microsoft Windows 系统

+   Metasploit 的 WMAP 插件

# 了解 WMAP

**WMAP**是用于扫描 Web 应用程序漏洞的*扫描器*插件。它不像 Burp Suite 或 Acunetix 那样是真正的扫描器，但它确实有自己的优势。在详细了解 WMAP 之前，让我们先试着了解其架构。

WMAP 架构简单而强大。WMAP 是作为插件加载到 MSF 中的迷你框架。它连接到 Metasploit 数据库以获取任何先前完成的扫描的结果。从数据库加载的结果（如主机名、URL、IP 等）将用于 Web 应用程序扫描。WMAP 使用 Metasploit 模块（如下图所示）来运行扫描，模块可以是任何类型的-辅助、利用等。一旦 WMAP 开始扫描目标，找到的所有工件和关键信息都将存储在 MSF 数据库中。WMAP 最强大的功能之一是其分布式（集群）扫描功能（在本章的*使用 WMAP 进行集群扫描*部分中介绍），它帮助 WMAP 通过*n*个节点（MSF 从属）扫描任意数量的 Web 应用程序。

![](img/0f0e2571-82d4-43d8-b1ae-f2d64273b510.png)

在详细了解如何使用 WMAP 之前，让我们先了解一下流程。

# WMAP 扫描过程

使用 WMAP 非常容易。我们在本节中为想要学习如何使用此插件的初学者定义了一个过程。扫描过程可以分为四个阶段-**数据侦察**、**加载扫描器**、**WMAP 配置**和**启动**。

![](img/c82f7da4-5c77-4725-87c3-41cc241700bc.png)

让我们先看看第一阶段-数据侦察。

# 数据侦察

在这个阶段，使用爬虫、代理和其他来源收集与目标相关的信息。然后将数据保存在 MSF 数据库中以供进一步使用。可以使用任何第三方工具获取数据，例如 Burp Suite 或 Acunetix。数据可以使用`db_import`命令导入到 MSF 中，因为 MSF 支持许多第三方工具。让我们看一个 Burp 扫描如何导入到 Metasploit 的例子。

以下截图显示了`db_import`命令的输出：

![](img/08c4d6cc-0cfc-467e-b51d-b43750ead426.png)

以下是将 Burp Suite 数据导出并导入到 Metasploit 的步骤：

1.  打开先前完成的域名扫描。它可以是主动的也可以是被动的。在我们的案例中，我们将使用[prod.packtpub.com](https://www.packtpub.com/in/)的被动扫描示例。以下截图的“问题”选项卡显示了 Burp 发现的各种问题：

![](img/37c9bd5a-bb81-40e4-8591-5f5129e8a3c7.png)

1.  然后，我们将选择要传输到 Metasploit 的问题，右键单击。然后，我们选择“报告所选问题”选项，如下所示：

![](img/ef205eb2-3506-4913-9cf2-df2ada166d01.png)

1.  将打开一个新窗口，要求我们选择报告的格式。我们选择 XML 并单击下一步：

![](img/8d67cba3-7ccf-4a59-8fdc-79c0243c86d0.png)

1.  在下一步中，我们可以指定报告中要包含的详细信息，然后单击下一步：

![](img/e0177741-3a97-4c63-be4f-30ca1c932cd2.png)

1.  然后，我们选择是否要包括来自扫描器的所选问题的请求和响应。我们选择两者并单击下一步：

![](img/6be9aec2-0f03-4679-9498-0df9a9d37019.png)

1.  接下来，它将要求我们选择要导出的所有问题。我们选择需要的问题并单击下一步：

![](img/043ec93e-6fd7-4101-a0ea-b71485a1285b.png)

1.  在最后一步中，我们可以指定报告的目标路径和文件名，然后单击下一步：

![](img/df71def4-7c78-40b0-a671-a16ebea1cdf5.png)

1.  报告现在将被导出，一旦导出完成，我们可以关闭窗口：

![](img/e889d21b-1d47-4f8b-b356-dac2ea24903b.png)

1.  要将 Burp Suite 报告导入 Metasploit，我们可以简单地使用以下命令：

```
db_import test.xml
```

以下截图显示了前述命令的输出：

![](img/512555e5-3c08-4fed-8e30-34e458375036.png)

1.  导入完成后，我们可以使用`hosts`命令查看报告中的所有主机，如下所示：

![](img/b07927dc-cbd9-476d-a745-31fed3c3b146.png)

1.  要查看从 Burp Suite 扫描器导入的漏洞，我们可以使用`vulns`命令，如下截图所示：

![](img/ce941dcb-54f9-480c-b236-7ddd7d926ce6.png)

现在信息已经导入到 Metasploit 中，WMAP 将自动检测和加载相同的信息，这意味着 Metasploit 中的主机现在将自动添加为 WMAP 模块中的站点。

# 加载扫描器

正如我们之前提到的，WMAP 实际上是一个加载在 MSF 中的插件。您可以通过输入`load`命令并按*Tab*键来查看 MSF 上的所有插件，如下所示：

![](img/b72d574b-ed9a-4aa7-bdfe-46d72177c230.png)

开始加载过程，以下是要遵循的步骤：

1.  让我们使用`load wmap`命令加载 WMAP 插件：

![](img/8f638269-1723-4c07-ae13-3ec2e3736b5d.png)

1.  一旦插件加载完成，您可以使用`?`或`help`命令查看帮助部分，如下所示：

![](img/627fdbbf-3eb5-44e7-b039-24033371096c.png)

接下来，我们将看一下 WMAP 配置。

# WMAP 配置

您已经学会了如何在数据侦察阶段自动将目标添加到 WMAP 中。还有另一种方式可以将数据加载到 WMAP 中，那就是手动定义目标：

1.  让我们从创建一个新站点或工作空间开始执行我们的扫描。让我们看看我们用于站点创建的所有选项。键入`wmap_sites -h`：

![](img/b67d7216-7520-4363-ba22-a6b55ca38446.png)

1.  现在让我们添加站点。有两种添加站点的方式 - 一种是直接通过 URL 或 IP。可以使用以下命令完成：

```
wmap_sites -a 151.101.21.32
```

以下截图显示了前述命令的输出：

![](img/a02c7f92-2c8c-4e45-8715-7b3bb68a0e17.png)

1.  第二种方法是使用虚拟主机。当我们必须扫描多个虚拟主机时，这是非常有用的。要添加虚拟主机，我们可以使用以下命令：

```
wmap_sites -a <subdomain> , <IP Address>
```

以下是前述命令的输出：

![](img/773cf787-2e54-4eda-bd85-a35e37c46bd3.png)

1.  添加站点后，我们可以以类似的方式添加目标，可以是 IP/域名或虚拟主机（虚拟主机/域）。要通过 IP 添加目标，我们可以使用以下命令：

```
wmap_targets -t <IP Address>
```

以下屏幕截图显示了前面命令的输出：

![](img/a46ef0c7-a418-4e60-bbb1-e568b6e226dc.png)

1.  要通过虚拟主机添加目标，我们使用以下命令：

```
wmap_targets -t <subdomain > , <IP Address>
```

以下屏幕截图显示了前面命令的输出：

![](img/f62fa43f-8d36-4503-8d5f-577b0c60aef8.png)

1.  要查看将由 WMAP 运行的所有模块的列表，我们可以使用`wmap_modules -l`命令。命令的输出如下屏幕截图所示：

![](img/ceb4af93-7df2-4cee-bd1c-84ccbf69cbb1.png)

以下屏幕截图显示了文件/目录测试的模块：

![](img/372aa366-a906-4d73-ade6-4a4906333fb6.png)

此阶段还包括 WMAP 扫描节点，可以配置这些节点，以便进行分布式 WMAP 扫描。可以使用`wmap_nodes`命令管理和配置节点。关于这一点将在本章的*使用 WMAP 进行集群扫描*部分进行讨论。完成最终配置后，下一阶段是启动 WMAP。

# 启动 WMAP

默认情况下，WMAP 在目标上运行所有模块，但您可以更改模块执行的顺序（这将在下一个主题中介绍）：

1.  要运行 WMAP，请执行以下命令：

```
wmap_run -e
```

以下屏幕截图显示了前面命令的输出：

![](img/7612dd18-1fe0-4cf7-84d3-abb68db0f4bc.png)

执行前面的命令后，加载模块的执行将开始。在 WMAP 中没有暂停或恢复选项，所以你要么等待扫描完成，要么可以通过按*Ctrl*+*C*来中断扫描过程。

1.  要了解有关`wmap_run`命令的更多信息，可以执行`wmap_run -h`命令，以查看在启动时可以使用的其他可用选项：

![](img/7288d4c7-fc33-43ab-83fd-1fab75d5b628.png)

甚至可以基于模块使用关键字字符串或正则表达式启动 WMAP 扫描。在这种情况下，我们使用一个字符串，将在加载的模块列表中搜索任何`version`关键字：

![](img/4d19d169-16d6-4a59-a8ff-ac114b952897.png)

我们可以根据需要使用正则表达式。现在我们已经了解了 WMAP 扫描过程的不同阶段。在下一节中，我们将了解 WMAP 中的执行顺序。

# WMAP 模块执行顺序

WMAP 按特定顺序运行加载的模块。顺序由数字值定义。默认情况下，用于 Web 扫描的第一个模块是`http_version`，其`OrderID=0`，`open_proxy`模块的`OrderID=1`。这也意味着`http_version`模块将首先执行，然后是`open_proxy`。测试人员可以通过相应地更改`OrderID`来改变模块执行的默认行为：

1.  模块执行顺序可以根据我们的需要进行更改。我们可以通过执行`wmap_modules -l`命令来获取`OrderID`。

以下屏幕截图显示了前面命令的输出：

![](img/5873a26b-4a50-4a01-94cc-0124ec4b7f64.png)

1.  `OrderID`在 Metasploit 模块代码中设置。让我们看看`http_version`模块的`OrderID`：

![](img/a615294e-6a77-4085-beb7-bf5d987084f2.png)

可以使用`register_wmap_options()`方法调整 WMAP 模块的执行顺序。

1.  让我们使用这种方法来更改`http_version`模块的`OrderID`：

![](img/f68ed1e0-0c1e-4b3a-959c-30e883e396c6.png)

1.  现在让我们重新加载模块：

![](img/6e7213e5-dbfc-418e-9cf0-0e9cdc28b75a.png)

1.  重新加载后，我们使用`wmap_modules -l`命令列出模块，以查看更新后的模块执行顺序：

![](img/fb6d6b1d-8ed6-441c-87ab-eee5d3f0b655.png)

从前面的屏幕截图中，我们可以看到`OrderID`现在已经更改。现在我们已经了解了模块执行顺序，让我们在下一节中向 WMAP 添加一个模块。

# 向 WMAP 添加模块

WMAP 允许我们添加自己的模块。这可以是来自 MSF 的模块，也可以完全从头开始制作我们自己的模块。让我们以 SSL 模块为例。以下截图显示了 WMAP 当前正在使用的两个模块：

![](img/3048bafb-ed99-49d5-8d73-1aa2f951bf38.png)

我们还可以添加基于 SSL 的扫描器模块（除了 MSF 中可用的 SSL Labs 模块）：

1.  我们将使用`ssllabs_scan`模块，它将使用 Qualys SSL Labs 的在线 SSL 扫描仪通过 Qualys 提供的公共 API 执行 SSL 扫描：

![](img/3a58652e-4bbc-4216-9b2c-9a5634eac3f2.png)

1.  现在我们编辑此模块的源代码，以便我们可以添加可以在扫描中使用的必要库和方法：

![](img/949c388f-d114-4a8b-95f7-2a8d0d0cbf06.png)

1.  我们在`MetasploitModule`类下面添加以下行：

```
include Msf::Auxiliary::WmapScanSSL
```

上述 WMAP 库提供了包含在扫描中的 WMAP SSL 扫描器模块的方法。这可以在以下截图中看到：

![](img/0bf01544-0647-460d-955d-90cee289b593.png)

仅添加库是不够的；仅添加库运行模块将导致错误：

![](img/951d7ab6-2094-48a9-af2d-c004db2c5508.png)

原因是这是`HOSTNAME`数据存储，它是`ssllabs_scan`模块选项，并且 WMAP 插件根本没有捕获它。插件只定义了以下方法（参考`metasploit-framework/lib/msf/core/auxiliary/wmapmodule.rb`文件）：

![](img/f12637ea-e809-4b66-a1e2-84b8ebeefde8.png)

在这种情况下，我们需要找到 WMAP 识别`ssllabs_scan`模块的`HOSTNAME`数据存储的方法。可能有很多变通方法，但我们将使用这个，因为对我们来说很方便：

![](img/c7ab1b1c-c6ad-4e7a-8d71-28b2e4b22fa9.png)

1.  我们将数据存储更改为从`datastore['HOSTNAME']`到`datastore['VHOST']`：

![](img/41cfd927-e255-4abd-88ac-2b67f1090152.png)

存储来自`HOSTNAME`数据存储的数据的变量将保存来自`VHOST`数据存储的数据。同时，WMAP 将通过`wmap_target_vhost()`方法识别`VHOST`数据存储：

![](img/ba6c51a3-0128-449a-9bf7-189146eee632.png)

1.  现在我们保存代码并返回到我们的 Metasploit 控制台，并通过输入`reload`重新加载模块：

![](img/0bbfedbf-cda2-4c90-8b51-0b015c690255.png)

我们还使用以下命令重新加载 WMAP 模块：

```
wmap_modules -r
```

以下截图显示了上述命令的输出：

![](img/aa0cf6f4-0ebd-43d3-8dcb-82a4d9e5d881.png)

1.  现在让我们列出模块：

![](img/c16b8210-783e-4272-9143-d0428c3c58f0.png)

模块已加载！

以下是可以在任何模块中使用的混合类型：

| **混合** | **描述** |
| --- | --- |
| **WmapScanSSL** | 对 SSL 服务运行一次扫描 |
| **WmapScanServer** | 对 Web 服务运行一次扫描 |
| **WmapScanDir** | 对目标中找到的每个目录运行扫描 |
| **WmapScanFile** | 对目标中找到的每个文件运行扫描 |
| **WmapScanUniqueQuery** | 对目标的每个请求中找到的每个唯一查询运行扫描 |
| **WmapScanQuery** | 对目标的每个请求中找到的每个查询运行扫描 |
| **WmapScanGeneric** | 在扫描完成后运行的模块（被动分析） |

1.  更新 WMAP 模块的操作：

![](img/70b42d1e-692d-4ba0-b9c5-7c74342b5a64.png)

模块发现的漏洞保存在数据库中，可以通过执行`wmap_vulns -l`命令查看：

![](img/957d009a-359f-4547-a573-3bbb5fd51955.png)

在下一节中，我们将看一下 WMAP 的分布式扫描功能。

# 使用 WMAP 进行集群扫描

WMAP 还可以用于对目标进行分布式评估。此功能允许在不同服务器上运行的多个 WMAP 实例以主从模型一起工作，如下所示：

![](img/ac8c7517-bd02-414e-b365-7a32af79d0fd.png)

WMAP 主服务器会自动将目标分发到从服务器上，形成作业。作业完成后，将结果报告给主服务器，并将结果存储在主服务器的数据库中：

1.  让我们添加一个站点进行扫描：

![](img/ab4ab1aa-1782-4c28-bd3a-d18146283184.png)

1.  使用`auxiliary/scanner/http/crawler`模块在站点上使用爬虫；相应地设置选项：

![](img/3c8c5b0d-d211-4663-824a-9542f360af52.png)

1.  运行爬虫以收集表单和页面：

![](img/20210f40-6890-42a9-b769-5f941603cfe9.png)

1.  使用`wmap_sites -l`命令确认从爬行中找到的页面/表单的数量：

![](img/355c8523-4ea1-44bb-a17d-fe8d8d73ecbc.png)

1.  让我们为分布式扫描设置 WMAP 节点。我们将在节点上使用`msfrpcd -U <user> -P <password>`命令运行`msfrpcd`。此命令将在后台启动 RPC 服务器，以便 WMAP 与 Metasploit 进行交互：

![](img/1dbec482-1a53-4d29-9d71-7a6538ff7575.png)

1.  一旦节点配置好，我们将使用`wmap_nodes`命令来管理和利用这些节点：

![](img/b16830b8-b948-49e6-8d83-02ee119eef68.png)

1.  我们将使用以下命令将节点添加到 WMAP 中：

```
wmap_nodes -a <IP> <RPC port> <SSL status - true/false> <rpc user> < rpc pass>
```

以下屏幕截图显示了上述命令的输出：

![](img/688f0888-7136-4396-aa52-6d8d35b0abcb.png)

1.  一旦节点连接，我们可以使用`wmap_nodes -l`命令列出节点：

![](img/51b815d3-b8d9-491d-91f4-8c8aa2ab9655.png)

1.  现在一切都设置好了。我们只需要为扫描程序定义目标。可以使用`wmap_targets`命令完成：

![](img/905131a1-cec9-494a-93e7-77a1bc6c0f28.png)

在本例中，我们使用了`-d`开关来根据 ID 添加目标。可以使用`wmap_sites -l`命令检索 ID。当前设置的问题是，所有在节点上执行的模块都将保存数据在节点上。

1.  如果要将数据保存在节点上，需要将节点连接到本地 MSF 数据库。可以使用以下命令完成：

```
wmap_nodes -d <local msf db IP> <local msf db port> <msf db user> <msf db pass> <msf db database name>
```

以下屏幕截图显示了上述命令的输出：

![](img/60acf6d3-8476-44ef-a267-e98b79e71e1c.png)

1.  现在使用`wmap_run -e`命令运行 WMAP：

![](img/b1d8f76a-87c6-45cd-ba7a-5d3f6a4a0f2e.png)

WMAP 加载的每个模块都将相应地分布和在节点上执行。

WMAP 每个节点的**作业限制为 25 个**。这是为了防止节点负担过重。

1.  我们可以通过输入`wmap_nodes -l`来查看连接的节点列表，如下所示：

![](img/43943310-effc-4806-a765-3bd2760b9a21.png)

1.  我们还可以使用 WMAP 仅运行单个模块；例如，如果我们想要运行`dir_scanner`模块，可以使用以下命令：

```
wmap_run -m dir_scanner
```

以下是输出：

![](img/d4f6ac23-f36e-4b35-962c-92fddf67382c.png)

以下屏幕截图显示了发现的目录的输出：

![](img/b4e22c65-1b53-48aa-8357-da525dd9dab8.png)

1.  如前面的屏幕截图所示，该模块开始列出找到的目录。要以树形结构查看输出，请使用此命令：

```
wmap_sites -s 1
```

以下屏幕截图显示了上述命令的输出：

![](img/a42133a9-5e66-4a55-8a1e-4252229114b4.png)

1.  要查看分配给节点的当前作业，可以使用此命令：

```
wmap_nodes -j
```

以下屏幕截图显示了上述命令的输出：

![](img/35fb3358-59be-4936-aa07-021560c45a48.png)

1.  要删除节点，我们可以使用此命令：

```
wmap_nodes -c 1
```

这将从列表中删除节点 1。

# 总结

在本章中，我们了解了 WMAP 及其架构和扫描过程。接下来，我们学习了如何将来自不同工具（如 Burp Suite）的输出导入 Metasploit，并继续加载、配置和使用 WMAP 模块进行扫描。在本章末尾，我们看了如何在 WMAP 中使用集群扫描。

在下一章中，我们将研究 WordPress 的渗透测试。

# 问题

1.  分布式扫描可以使用多少个 WMAP 实例？

1.  WMAP 插件支持报告吗？

1.  我可以导入其他服务器日志和报告到 Metasploit 中，然后在 WMAP 中使用吗？

1.  我想进一步定制 WMAP 以适应我们组织的环境。我该怎么做？

1.  WMAP 支持每个节点多少个作业？

# 进一步阅读

+   有关 WMAP 网络扫描程序的更多信息，请访问以下链接：

[`www.offensive-security.com/metasploit-unleashed/wmap-web-scanner/`](https://www.offensive-security.com/metasploit-unleashed/wmap-web-scanner/)
