# 十、管理 TCP 连接

最重要的，但最不为人所知的，**传输控制协议** ( **TCP** )概念之一是三次握手。TCP 握手启动连接并设置参数。在此过程完成之前，不会交换任何数据。与握手类似的是当两个端点交换一系列**finish**(**FIN**)包时的拆卸，这表示会话完成。

在这一章中，我们将更详细地看看握手和由此产生的套接字创建。为了让您能够专注于单个 TCP 流，我们将进行大规模捕获，并对数据包进行子集化、标记和过滤，以便我们能够检查 TCP 握手。随着本章的深入，我们将对握手过程中交换的 TCP 选项有更深入的了解。我们将了解它们的含义，以及为什么它们需要在今天的网络上进行对话。此外，我们将看到如何轻松地修改协议首选项，例如通过简单的右键单击来分析 TCP 序列号。最后，我们将检查 TCP 拆卸过程，并了解 FIN 标志如何指示数据传输的结束。

本章将通过涵盖以下内容来解决所有这些问题:

*   剖析三次握手
*   发现 TCP 选项
*   了解 TCP 协议首选项
*   识别 TCP 拆除

# 剖析三次握手

在计算中，握手是设备之间的信息交换，它设置了对话的参数。每一方发送可用的内容，在交换任何数据之前，两个端点就条款达成一致。

在大多数情况下，*客户端*会通过发送**同步** ( **SYN** )数据包来发起与*服务器*的对话；*服务器*以**同步确认** ( **SYN-ACK** )响应，*客户端*随后以**确认** ( **ACK** 完成握手。TCP 握手如下:

![Figure 10.1 – The TCP three-way handshake
](img/B18389_10_001.jpg)

图 10.1–TCP 三次握手

握手完成后，将会进行数据交换。

要进一步了解三方握手，请访问[。一旦到了那里，下载`bigFlows.pcap`以便你可以跟随。BigFlows 是一个包含许多协议和对话的大型捕获，如下面的屏幕截图所示:](http://tcpreplay.appneta.com/wiki/captures.html#bigflows-pcap)

![Figure 10.2 – bigFlows.pcap
](img/B18389_10_002.jpg)

图 10.2–big flows . pcap

BigFlows 有*791615*个数据包，如图*图 10.2* 中状态栏的右下方所示。虽然您可以在技术上处理整个捕获，但是在下一节中，我们将隔离一个单独的流，然后创建一个更小、更易于管理的文件。

## 隔离单个流

当捕获流量时，Wireshark 会跟踪所有数据流。在一个`bigFlows.pcap`大小的文件中，会有很多 TCP 和**用户数据报协议** ( **UDP** )流。虽然我们可以过滤任何流，但是现在，让我们用`TCP stream 312`来过滤，因为这包括握手、选项、数据，然后 FIN 交换来结束会话。

要仅显示流 312，转到显示过滤器并输入`tcp.stream eq 312`，然后按*输入*。因为这是一个很大的文件，Wireshark 需要几秒钟来运行过滤器。完成后，您将看到一个完整的 TCP 流示例，如下所示:

![Figure 10.3 – tcp.stream eq 312
](img/B18389_10_003.jpg)

图 10.3–TCP . stream eq 312

既然我们已经有了一个单独的流，我们将希望对捕获进行子集化，并将其保存为一个更小的文件。要子集*只需*中的`TCP stream 312`，转到**文件** | **导出指定数据包**。

这将打开一个对话框，提供各种导出指定数据包的方法，如以下屏幕截图所示:

![Figure 10.4 – Select the All packets and Displayed options
](img/B18389_10_004.jpg)

图 10.4–选择所有数据包和显示选项

在对话框的底部附近，您会看到一个标题，**数据包范围**，您可以在这里选择。如果您已经过滤了捕获，Wireshark 将假设您只想导出*显示的数据包*，并且**显示的单选按钮**将被激活。

选择**所有数据包**和**显示的**，如截图所示，然后另存为`Flow312.pcapng`。

关闭`bigFlows.pcap`并清除显示过滤器，然后打开新创建的文件。在下一节中，让我们关注握手，并检查交换的每个数据包。

### 标记 TCP 握手

在 Wireshark 中隔离一系列数据包的方法之一是对其进行标记，这将修改数据包，使其具有白底黑字。一旦我们标记了它们，我们就可以根据标记的数据包进行过滤，以专注于握手。

在文件中，我们将通过标记数据包来识别握手。我们知道，要开始一个会话，TCP 从握手开始，握手使用三个数据包，如下所示:

1.  客户端向服务器发送一个 SYN 数据包。
2.  服务器通过发送 SYN ACK 数据包进行响应。
3.  客户端发送最后一个 ACK 包。

握手完成后，数据流开始。

Wireshark 将通过在 info 列中显示交易详细信息来识别三次握手和数据包交换(如果您激活了此列标题)。在`Flow312.pcapng`捕获中，数据包 1、2 和 3 代表握手。

一旦握手被识别，我们将标记三个数据包中的每一个。要标记数据包，选择每个数据包并右键单击**标记/取消标记数据包**子菜单选项，如以下屏幕截图所示:

![Figure 10.5 – Mark/Unmark Packet
](img/B18389_10_005.jpg)

图 10.5–标记/取消标记数据包

标记数据包后，背景将变为黑色，文本将变为白色，如下所示:

![Figure 10.6 – Results of marking a packet
](img/B18389_10_006.jpg)

图 10.6–标记数据包的结果

之后，我们将希望通过在显示过滤器中输入`frame.marked==1`并按下 *Enter* 来仅查看标记的数据包。进入**编辑** | **清除所有显示的标记**，这样我们就可以开始分析握手了。

既然我们已经挑出了三次握手，让我们来看看三个数据包中的每一个。

## 识别握手数据包

在这一节中，我们将看一下每个包并检查标志，以及序列和确认号。让我们从 SYN 包开始。

### 发送 SYN 数据包

在第一个包中，客户机将通过向服务器发送一个 SYN 包来启动连接，然后等待响应。

要查看所有字段值，请转到**帧 1** ，并展开 TCP 报头，如下图所示:

![Figure 10.7 – The Flow312.pcapng TCP header in Frame 1
](img/B18389_10_007.jpg)

图 10.7–第 1 帧中的 Flow312.pcapng TCP 报头

在**帧 1** 中，您将看到源端口和目的端口以及报头中的其他字段值。这包括序列号和 ACK 号，如下所示:

*   `Sequence number: 0 (relative sequence number)`
*   `Acknowledgment Number: 0`

如果我们展开标志，我们会看到`Syn`标志是`set`，如下面的屏幕截图所示。请记住，在握手的前两个数据包中，`Syn`标志将*仅*用于同步序列号:

![ Figure 10.8 – The TCP Syn flag set
](img/B18389_10_008.jpg)

图 10.8–TCP Syn 标志集

虽然握手的三个包都很重要，但是前两个包设置了对话的参数。选择**帧 1** 并在**数据包细节**窗格中查看 TCP 报头。然后，选择 TCP 报头，我们会在底部的状态栏中看到`Transmission Control Protocol (tcp), 40 bytes`，如下面的截图所示:

![Figure 10.9 – TCP header 40 bytes
](img/B18389_10_009.jpg)

图 10.9–TCP 报头 40 字节

正常的 TCP 报头是 20 字节，而这个报头是 40 字节。TCP 报头更大，因为它包含添加到报头的选项。

注意

在大多数情况下，您会在三次握手的前两个数据包中看到较大的报头。当 TCP 报头包含选项时，您可能还会在后续帧中看到更大的报头。

此外，在字段值中，我们看到 Wireshark 将这个对话标识为`[Stream: 0]`。在客户端，操作系统会创建一个 IP 地址和端口号组合为`172.16.133.132: 50405`的本地套接字来接收数据。

现在我们已经看到了三次握手的第一个数据包，让我们来看看第二个数据包，SYN-ACK 数据包。

### 返回 SYN-ACK 数据包

一旦服务器同意加入连接，服务器将返回一个 SYN-ACK 并等待最后的 ACK 来启动连接。

在**帧 2** 中，您将看到字段值。在这种情况下，ACK 号已经改变。**帧 2** 中的序列和 ACK 号如下:

*   `Sequence number: 0 (relative sequence number)`
*   `Acknowledgment Number: 1`

此外，TCP 标志现在设置为 SYN-ACK，如下面的屏幕截图所示:

![Figure 10.10 – Viewing the TCP SYN-ACK flags set
](img/B18389_10_010.jpg)

图 10.10–查看 TCP SYN-ACK 标志集

在交换任何数据之前，握手必须与 ACK 包一起完成，如下所述。

### 用 ACK 包结束

**第 3 帧**是三次握手中的最后一个数据包。此时，序列号和 ACK 号如下:

*   `Sequence number: 1 (relative sequence number)`
*   `Acknowledgment Number: 1`

要查看详细信息，请转到**帧 3** ，然后转到 TCP 报头，然后展开 TCP 标志，这些标志现在设置为 ACK，如下面的屏幕截图所示:

![Figure 10.11 – The TCP ACK flag set
](img/B18389_10_011.jpg)

图 10.11–TCP ACK 标志集

此外，我们还可以在底部的状态栏中看到`Transmission Control Protocol (tcp), 32 Bytes`，如前面截图中的所示。同样，这是因为该连接具有 TCP 选项，这增加了 TCP 报头的长度。

在许多情况下，TCP 报头选项概述并进一步定义了对话的参数。在下一部分中，我们将大致了解 TCP 选项，然后重点关注`Flow312.pcapng`中的 TCP 对话选项。

# 学习 TCP 选项

虽然 TCP 已经是一个令人惊叹的协议，但它也允许将各种选项添加到 TCP 报头中以扩展功能。完整的列表最后一次更新于 2021 年 2 月，可在[https://www . iana . org/assignments/TCP-parameters/TCP-parameters . txt](https://www.iana.org/assignments/tcp-parameters/tcp-parameters.txt)上找到。

请记住以下关于 TCP 选项的内容:

*   并非所有选项都被使用。
*   有些选择是实验性的。
*   有些用于特定原因，没有关联的**意见征询** ( **RFC** )。
*   有些是在没有得到适当的**互联网号码分配机构** ( **IANA** )分配的情况下开发和使用的。

下表列出了七个最常见的选项:

![Table 10.1 – TCP options
](img/B18389_Table_10.1.jpg)

表 10.1–TCP 选项

前三个，EOL、NOP 和 MSS，来自最初的 TCP RFC 793。其他的是随着时间的推移发展起来的。任何选项都将跟随 TCP 报头，并且是 8 位(或 1 字节)的倍数。为了存储器对齐，整个报头必须是 32 位或 4 字节的倍数。因此，在某些情况下，需要填充以确保报头是 4 字节的倍数。为了存储器对齐，整个报头必须是 32 位的倍数(或四个 4 字节)。

要查看`Flow312.pcap`的 TCP 选项，选择**帧 1** 中的选项标题，其中列出了附加的对话参数，如下所示:

![Figure 10.12 – Flow312 Frame 1 options
](img/B18389_10_012.jpg)

图 10.12–流程 312 框架 1 选项

为了让您对七个常见选项中的每一个都有更好的理解，让我们从 EOL 选项开始逐一了解一下。

## 抓住 EOL 选项

EOL 是选项列表末尾使用的单个字节。要查看示例，打开`Flow312.pcap`数据包捕获，将`tcp.option_kind == 0`放入显示过滤器，按*进入*。Wireshark 将显示**帧 2** 。展开 TCP 报头选项，这将在列表末尾显示`EOL`:

![Figure 10.13 – Flows312 Frame 2 options list
](img/B18389_10_013.jpg)

图 10.13–流程 312 框架 2 选项列表

另一个 TCP 选项是 NOP，它根本不是一个选项，而是一种占用空间的方式，我们接下来会看到。

## 使用 NOP

NOP 本质上是一个占位符，用来分隔不同的选项。NOP 的使用方式和取决于操作系统。例如，如前面的截图所示，我们可以看到在`Window Scale`和`Timestamps`选项之间放置了两个 nop。

除了使用 NOP 来分隔各种选项之外，NOP 还用于确保 options 报头是 32 位的倍数(或四个 4 字节)，以便进行内存对齐。

例如，如果有一个 3 字节的选项，如窗口缩放，将添加一个单个 1 字节的 NOP，使选项的长度总计为 4 字节。

接下来，我们将查看一个选项，它有助于概述可接受的接收段大小，这在许多方面都很重要。

## 定义 MSS

MSS 是一个定义最大(接收)段大小的选项。这个值很重要，原因有几个。

在端点之间的会话期间，TCP 监控连接以确保发送最佳数据，从而不浪费带宽。查看典型帧时，我们可以看到 TCP MSS 和**互联网协议** ( **IP** ) **最大传输单元** ( **MTU** )之间的差异，如下图所示:

![Figure 10.14 – Comparing the MSS with the MTU
](img/B18389_10_014.jpg)

图 10.14–比较 MSS 和 MTU

在数据处理过程中，TCP 跟踪以下值:

*   **窗口大小** ( **WS** )，用于流量控制，以免淹没接收主机。
*   **网络**，使用**拥塞窗口** ( **CWND** )进行拥塞取证。当需要的时候，服务器会对数据传输进行节流。
*   **MTU** 因此主机只发送*网络*能够处理的数据量，以避免需要对数据报进行分段。

在网络上，发送主机监控这些值，因为它只能发送三个值中最小的*。*

 *例如，主机需要发送 1，800 字节的数据。网络限制如下:

*   **CWND** : 900 bytes
*   **MTU** : 1,500 bytes
*   **WS**:1800 字节

根据列出的值，TCP 必须发送最小值，即 **CWND** : 900 字节。

MSS 并不总是包含在选项标题中。如果不使用此选项，服务器可以发送任意大小的数据段，同时保持符合网络限制。

正如我们所见，MSS 提供了确保最佳数据流的基本信息。现在让我们回顾另一个常见的选项，WS。

## 缩放 WS

TCP 是一种全双工通信协议，其中发送方和接收方不断地相互通信。**流量控制**是一种端到端控制方法，其中主机传输一个带有每个 ACK 的 WS，指示它可以接受多少字节，因此发送方不会传输太多数据而使主机不堪重负。

窗口缩放是一个选项，它允许根据从三次握手期间交换的 TCP 选项中获得的缩放因子来扩展 ws。WS 值用于增加允许的最大 WS。尽管这是可选的，但它为服务器提供了更准确的 WS 值的信息。

让我们概括一下为什么这是一个重要的选择。在 TCP 报头中，`window`字段值是 16 位，这允许 2^16(或 65，535)字节的最大大小。TCP 的原始 RFC 是在 20 世纪 80 年代早期编写的，当时缓冲区很小，所以这个值是有意义的。然而，随着时间的推移，显然需要更大的值，窗口缩放选项提供了一种真正表示该值的方法。

使用窗口缩放选项时，总值可达 2^30.当数据传输时，尤其是在高带宽的广域网链路上，这个值作为一个度量是有益的。较大的 WS 将提高性能。中间设备可以被调整以接受更大的 WS；例如，当配置支持窗口缩放的 Cisco 路由器时，您可以将该值调整到 1，073，741，823 字节。

为了说明这一点，下图显示了一个连接，其中客户端公布了一个 35，000 字节的 ws。服务器开始按照 WS:

![Figure 10.15 – Server sending data in line with a smaller WS
](img/B18389_10_015.jpg)

图 10.15–服务器按照较小的 WS 发送数据

在连接过程中，如果 WS 开始掉线，服务器将需要控制数据，以免淹没客户机。但是，如果客户端使用缩放，现在公布 70，000 字节的 WS，服务器可以发送两倍的数据包，如下图所示:

![Figure 10.16 – A larger WS allows the server to send more data
](img/B18389_10_016.jpg)

图 10.16-较大的 WS 允许服务器发送更多的数据

增加 WS 将利用所有可用的带宽，并提供更有效的数据传输。

网络可能不稳定，数据传输也不总是有序的。这个下一个选项概述了客户端如何有选择地确认收到的数据，因此服务器只需重新传输丢失的字节。

## 允许麻袋

随着时间的推移，TCP/IP 协议套件也有所改进。其中一个改进就是 SACK。在 SACK 的情况下，如果有丢失的数据包，客户端将只通知服务器*T2，目的是保持数据流动。让我们讨论一下这个选项是如何改善数据流的。*

TCP 是面向连接的协议。在传输过程中，所有数据都经过排序和确认，以确保该会话所需的所有数据都能完整传输。这是通过以下方式实现的。

服务器向客户端发送数据后，客户端将确认数据已收到，并准备好接受更多数据。这通过发送指示下一个预期字节的 ACK 来传达给服务器。为了确保完整的数据传输，服务器会监控确认。但是，有时传输会有间隙。

例如，服务器收到 ACK 1-100，然后收到 ACK 151-200。在这种情况下，存在 ACK 101-150 的感知间隙，并且服务器认为客户端丢失了字节 101-150。

服务器不知道为什么在传输中会有间隙，并且会重新发送它认为丢失的所有数据。这种差距可能是由以下原因之一造成的:

*   客户端*没有*收到数据。
*   客户端*收到了数据，但是服务器没有收到确认。*

这可能导致不必要的数据重传。

通过使用 SACK，服务器只需重新发送任何丢失的数据。使用 SACK 时，在三次握手的前两个数据包中发送两个选项，如下所示:

*   SACK-permitted 选项表示可以在建立连接后使用 SACK。
*   SACK 选项允许有选择地确认数据。

TCP SACK 选项使用两个 16 位字段，因此客户端可以指示它已经接收到的字节。

例如，打开的`bigFlows.pcap`捕获，并使用`tcp.stream eq 198`滤镜。在`tcp.stream 198`中，我们看到了一些问题的迹象，例如一个**重复确认** ( **Dup ACK** )以及几个`Out-Of-Order`数据包，如下面的截图所示:

![Figure 10.17 – Stream 198 
](img/B18389_10_017.jpg)

图 10.17–流 198

在**画面 4006** 中，客户端使用了`TCP option – SACK 10852-11096`，如下图所示:

![Figure 10.18 – TCP SACK option evident in bigFlows.pcap
](img/B18389_10_018.jpg)

图 10.18–big flows . pcap 中明显的 TCP SACK 选项

在 SACK 选项中，我们看到以下值，它们表示传输中的间隙:

*   `left edge = 10852 (relative)`
*   `right edge = 11096 (relative)`

通过使用 SACK，服务器只需要发送从序列号`10852`到`11096`的数据，可以防止不必要的重传，保持数据流动。

另一个 TCP 选项是时间戳，它监视传输并跟踪数据交换期间的往返时间。

## 使用时间戳

TCP 依赖时间作为流量控制和可靠数据传输功能的一部分。数据通过局域网和广域网传输。每个网络都是不同的，TCP 需要了解每个网络上的延迟程度，以便设置适当的 ACK 超时值。

使用`Timestamps`选项，TCP 可以监控往返时间。这样，如果发送主机没有及时收到 ACK，它就可以重新传输数据包。

在**帧 2** 的`Flow312.pcap`截图中，打开选项查看时间戳选项，如以下截图所示:

![Figure 10.19 – Viewing the TCP Timestamps option
](img/B18389_10_019.jpg)

图 10.19–查看 TCP 时间戳选项

在该选项中，有以下值:

*   **种类** : (1 字节)该字段表示选项的类型，在本例中，值为`(8)`，即时间戳选项。
*   **Length** : (1 字节)表示该选项头的长度，以字节为单位；在这种情况下，它是`10`字节。
*   **时间戳值** ( **TSval** ): (4 字节)这是发送方的时间戳时钟。值为`1707407197`。
*   **时间戳回应回复** ( **TSecr** ): (4 字节)这是远程主机发送的回应回复。该值在**帧 2** 中，为`131517608`。

TCP 使用时间戳值来监控路径中各段的往返时间。必须在握手期间设置时间戳选项。之后，您将在对话期间看到报告选项。

正如我们所看到的，TCP 可以在握手过程中设置各种选项，这些选项进一步定义了对话的参数。

使用 Wireshark 时，协议响应或配置的方式可能会有偏好。我们可以修改许多协议首选项，我们将在接下来看到。

# 了解 TCP 协议偏好

在 Wireshark 中，根据我们的偏好，我们可以修改几个协议来显示数据。要修改协议的显示方式，选择一个标题，右键查看**协议首选项**，如下图所示:

![Figure 10.20 – Viewing TCP protocol preferences
](img/B18389_10_020.jpg)

图 10.20–查看 TCP 协议首选项

在首选项列表的顶部，有另一个选项，**打开传输控制协议首选项...**，这将打开 Wireshark 首选项，如以下截图所示:

![Figure 10.21 – TCP preferences
](img/B18389_10_021.jpg)

图 10.21–TCP 首选项

一旦**首选项**对话框打开，您可以选择和修改一些 TCP 选项。

## 修改 TCP 首选项

当在 TCP 的首选项对话框中时，您将看到一个概述您的选择的列表，如下所示:

*   **在协议树**中显示 TCP 摘要:选中时，该选项将显示该数据包中发生的事件的摘要。
*   **如果可能，验证 TCP 校验和** : TCP 有一个用于错误检测的校验和。在大多数情况下，不选择此选项，因为校验和将卸载到 NIC，值将无效并指示错误。
*   **允许子分配器重组 TCP 流**:选中时，允许上层协议重组 TCP 流。
*   **重新组装无序段**:选中时，会将段按正确的顺序排列，以有序的形式显示。默认情况下，此选项是禁用的，因为使用它会消耗过多的内存。
*   **分析 TCP 序列号**:此选项有助于分析，因为 Wireshark 会监控序列号，帮助识别故障，如 TCP 重新传输、重复 ack 和零窗口。
*   **相对序列号(需要“分析 TCP 序列号”)**:使用时，该功能有助于使序列号更容易读取和比较。对于每个流中的第一个数据包，相对序列号从零开始，然后从该点开始递增。
*   **当从捕获**中不可用时使用的缩放因子:窗口缩放用于增加允许的最大 WS。该选项在第 9 章 、*解码 TCP 和 UDP* 中有详细介绍。
*   **跟踪飞行中的字节数**:要查看飞行中的字节，在`Flow312.pcapng`中，使用`tcp.analysis.bytes_in_flight`显示过滤器，这将产生两帧。选择**帧 5** ，展开 SEQ/ACK 分析，查看传输中的字节，如下所示:

![Figure 10.22 – Calculating TCP bytes in flight 
](img/B18389_10_022.jpg)

图 10.22–正在计算 TCP 字节

*   **计算会话时间戳**:该选项将监控时间值，有助于发现 TCP 会话期间的延迟。
*   **首先尝试启发式子解析器**:此选项有助于 Wireshark 通过使用端口号来正确解析数据包，从而尝试识别所使用的应用类型。这是根据展示的*行为*完成的，Wireshark *认为*是合适的协议。
*   **忽略 TCP 时间戳摘要** : Wireshark 从操作系统内核获取时间戳。如果您觉得时间戳可能不准确，请使用此选项。
*   **快速重传取代无序解释**:在繁忙的网络中，数据包会丢失并出现延迟。使用此选项，您可以修改 Wireshark 在分析过程中优先考虑的方式，并在任何乱序数据包之前对快速重传进行解释。
*   **不要为错误数据包调用子拦截器** : Wireshark 会尽最大努力根据 RFC 正确解析每个协议。在某些情况下，解剖者可能会错误地识别错误。因此，最好选中此选项，这样 Wireshark 就不会继续错误地解析数据包并抛出更多错误。
*   **带有幻数**的 TCP 实验选项:在某些情况下，捕获可能包括一个会话，其中 TCP 选项是实验性的，可能用于测试。因为选项是实验性的，而不是标准的，Wireshark 需要使用一个幻数来标识选项，所以可以对其进行适当的剖析。
*   **Display process information via IPFIX**: **Internet Protocol Flow Information Export** (**IPFIX**) is a format used to analyze network traffic. When selected, Wireshark will display the process information that can be used to analyze and troubleshoot IPFIX flows.

    注意

    对于任何更改默认值的选项，请小心使用！您输入的内容可能会被*粘住*，并且可能不允许您在没有重新安装的情况下撤销该选项。

在分析过程中，Wireshark 会尝试调查协议行为的所有方面。如您所见，可以个性化您的偏好并定制 TCP 的解释方式。

这最后一节提供了 TCP 拆除的概述，它正确地关闭了两个端点之间的连接。

# 拆除连接

当一个 TCP 连接完成时，TCP 通过交换一系列 FIN 包，关闭端口，并拒绝任何更多的通信请求来断开连接。让我们看一下整个过程。

两台主机通信时，TCP 会话会经历几个阶段:

*   TCP 从(三次)握手开始建立会话。在许多情况下，还有额外的标题选项来进一步定义参数。
*   在会话期间，TCP 监控通信并确认收到的所有字节，以确保数据的完整传递。
*   会话结束后，TCP 通过在两个端点之间交换 FIN 数据包来结束会话，这表示会话已完成。

现在让我们看看 Wireshark 是如何表示会话拆除的。

在`Flows312.pcapng`捕获中，数据包`6, 7, 8,`和`9`代表会话拆除，如下所示:

![Figure 10.23 – The four-packet FIN exchange
](img/B18389_10_023.jpg)

图 10.23–四包 FIN 交换

为了关闭会话，TCP 使用 FIN 标志，如下面的屏幕截图所示，这表示没有数据要发送:

![Figure 10.24 – The TCP FIN flag set
](img/B18389_10_024.jpg)

图 10.24–TCP FIN 标志集

如 RFC 793 中所述，为了完全关闭连接，TCP 从已建立状态前进到`FIN-WAIT-1`、`FIN-WAIT-2`、`CLOSE-WAIT`、`CLOSING`、`TIME-WAIT`，然后是`CLOSED`。

注意

有些应用(比如 Outlook 和 Exchange)会关闭一个 TCP 连接，用**Reset**(**)和 FIN 来尝试，防止端口耗尽。**

 **TCP 会等到双方说了最后的再见并发送了 FIN 包，然后操作系统会关闭套接字。今后任何交流的尝试都将被拒绝。

# 总结

建立面向连接的会话的一个重要概念是在交换任何数据之前概述会话的参数。在本章中，我们学习了 TCP 如何通过三次握手开始对话，然后进一步了解了握手的每一步。我们看到了一旦握手完成，操作系统如何创建一个套接字以便进行数据交换。

此外，我们还回顾了在三次握手过程中交换的 TCP 选项，如 SACK、MSS 和时间戳。本章还解释了 TCP 协议首选项，并概述了如何在 Wireshark 中修改 TCP 首选项。最后，我们看了 TCP 是如何通过交换 FIN 数据包来结束会话的，FIN 数据包会向每台主机发出关闭会话的信号。

IP 是 TCP/IP 套件中的另一个主要协议。在下一章中，我们将仔细研究 IPv4 和 IPv6。为了让您更好地理解这种网络层协议，我们将从 IPv4 的全面概述开始，研究报头格式以及每个字段值。然后我们将看看 IPv6 以及相应的报头格式和字段值。此外，由于 IPv4 是与 IPv6 完全不同的格式，我们将通过在双栈环境中使用各种隧道协议来解决两者如何共存的问题。

# 问题

现在是时候检查你的知识了。选择最佳答案，然后检查您的答案，这些答案可在*评估*附录中找到:

1.  要仅过滤您在 Wireshark 中标记的数据包，请在显示过滤器中使用 _____。
    1.  `marked:all`
    2.  `frame = black`
    3.  `frame.marked==1`
    4.  `marked: on`
2.  ____ 用于增加允许的最大 WS。
    1.  nototherwiseprovided（for）除非另有规定
    2.  窗口比例
    3.  时间戳
    4.  解雇
3.  使用 _____ 时，如果有任何丢失的数据包，接收方将通知发送方。
    1.  nototherwiseprovided（for）除非另有规定
    2.  窗口比例
    3.  时间戳
    4.  解雇
4.  TCP 通过交换数据包来结束会话，表示每一端都应该关闭各自的套接字。TCP 使用 _____ 标志来表示会话的结束。
    1.  结束
    2.  synchronizing 同步
    3.  鳍状物
    4.  紧急的
5.  如果 TCP 报头中的序列号为 1，下一个序列号为 937，则该数据包包含 _____ 字节的数据。
    1.  Thirty-two
    2.  Three hundred and eighty
    3.  Nine hundred and thirty-six
    4.  Thirty-three thousand three hundred and four
6.  使用 TCP 选项时，_____ 是在选项末尾使用的单个字节。
    1.  寿命终止
    2.  解雇
    3.  nototherwiseprovided（for）除非另有规定
    4.  《华盛顿明星报》(Washington Star)
7.  使用 _____ 选项，TCP 可以监控往返时间。这样，如果发送主机没有及时收到 ACK，它就可以重新传输数据包。
    1.  寿命终止
    2.  SACL
    3.  nototherwiseprovided（for）除非另有规定
    4.  时间戳

# 延伸阅读

请参考以下链接了解更多信息:

*   在[https://tools.ietf.org/html/rfc793](https://tools.ietf.org/html/rfc793)发现的原始 RFC 793 中详细描述了 TCP 三次握手。
*   有关 SACK 的更多信息，请访问 https://packet life . net/blog/2010/jun/17/TCP-selective-acknowledges-SACK/。
*   请访问[https://www . Wireshark . org/docs/wsug _ html _ chunked/chadvtcpanalysis . html](https://www.wireshark.org/docs/wsug_html_chunked/ChAdvTCPAnalysis.html)，了解更多有关 Wireshark 如何通过提供数据传输的高级分析来帮助排除故障的信息。***