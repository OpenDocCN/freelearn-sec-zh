# 十三、潜入 DNS

**域名系统** ( **DNS** )将人类可读的主机名转换成**互联网协议** ( **IP** )地址。它是当今最常用的应用层协议之一，对任何网络都至关重要。在这一章中，我们将回顾 DNS 的目的和简史，以便你能更好地理解它是如何开始的。然后我们将介绍不同类型的服务器，比如根服务器、权威服务器和递归服务器。此外，我们将比较解析 IP 地址和更新区域文件时 DNS 记录的传输方式。

为了更好地理解这个协议，我们将回顾一下**资源记录** ( **RRs** )的一些常见类型和类别。我们还将通过使用 Wireshark 深入查看报头和查询部分来检查 DNS 数据包结构。您将能够识别关键字段值，例如交易**标识** ( **ID** )和标题标志。此外，您将能够分解 DNS 如何呈现查询的答案。然后，我们将逐步完成将主机名解析为 IP 地址的过程。您将了解到**操作系统** ( **OS** )如何存储已解析的地址，以及它可以在缓存中保留多长时间。我们还将介绍 Wireshark 如何在故障排除时帮助您计算 DNS 响应时间，并以讨论保护 DNS 的方式结束。

本章将涵盖以下内容:

*   认识 DNS 的目的
*   比较不同类型的记录
*   查看 DNS 数据包
*   评估查询和响应

# 认识域名系统的目的

任何上过基本网络课程的人都会熟悉 DNS。这个众所周知的协议提供了一个基本的服务，将人类可读的主机名翻译成机器可读的数字 IP 地址。

在这一节中，我们将介绍 DNS 如何工作的概念，以及它是如何开始的简短历史。然后，我们将继续回顾解析 IP 地址所涉及的不同类型的服务器，最后比较 DNS 的传输方式。

让我们先讨论一下为什么 DNS 如此重要。

## 映射 IP 地址

DNS 解析主机和服务的地址，以及连接到互联网的任何对象。此外，还需要发送电子邮件，防御垃圾邮件，或发起**基于互联网协议的语音** ( **VoIP** )对话。

每当主机发出访问资源的请求时，该过程就会通过一系列服务器进行名称解析。操作系统将首先搜索本地缓存，如果没有找到答案，它将搜索范围扩大到其他服务器，直到找到解决方案。

但是这一切是从哪里开始的呢？在下一节中，让我们回顾一下 DNS 的历史。

### 反思 DNS 的起源

对于我们大多数人来说，DNS 似乎已经存在很久了。但是曾经有一段时间，当互联网还年轻的时候，所有用来定位主机的都是一个纯文本文件。从早期的**高级研究计划局网络** ( **ARPANET** )到 1987 年，DNS 的发展取得了几项重大进展，如图所示:

![Figure 13.1 – Key moments in DNS history
](img/B18389_13_001.jpg)

图 13.1–DNS 历史上的关键时刻

阿帕网始于 1969 年，在整个 20 世纪 70 年代，这个小小的网络开始扩大，每天都在增加主机。类似于我们今天识别主机的方式，ARPANET 基础设施使用数字地址。为了定位另一台主机，科学家们设计了一个名为`hosts.txt`的文件，将主机名映射到它们的网络地址。

在 https://datatracker.ietf.org/doc/html/rfc597 的[发现的`Host Status`文件包括如下条目:](https://datatracker.ietf.org/doc/html/rfc597)

```
101      65     UCLA-CCn        IBM 360/91      Server
```

```
204     132     UTAH-TIP                        TIP
```

在 ARPANET 的早期，每台主机都保存着网络上的系统列表。除了网络地址之外，他们还为它们分配了人类可读的名称，以便更容易识别它们。

然后，该文件由人工维护并分发给所有成员。在接下来的二十年中，映射的处理方式发生了重大变化:

*   1973 年:随着 ARPANET 的扩展，科学家们认识到集中管理文件的局限性，并开始探索共享主机信息的替代方案。
*   **1983** : **征求意见** ( **RFC** ) 882 和 RFC 883 概述了 DNS 作为分布式(而非集中式)系统的开端。
*   **1984 年** : **Berkeley 互联网域名** ( **BIND** )发布，提供了一种存储和检索关于对象和资源信息的方式。BIND 仍然是世界上最广泛使用的管理主机的方法。
*   **1987** : RFC 1034 和 RFC 1035 概述了我们今天所知的 DNS 框架。

虽然 DNS 以分布式方式工作，但是有一个使用区域的结构化层次结构。区域代表一个区域，管理员可以在其中提供对 DNS 对象的粒度控制。

搜索 IP 地址可能很复杂；然而，所有的起点是 DNS 根区域。我们来探讨一下这个概念。

### 从根开始

根服务器是响应根区域内查询的名称服务器。服务器是解析地址的重要组成部分，这样数据就可以在互联网上传输。根服务器的结构是顶层是根服务器，后面是**顶级域名** ( **TLD** )服务器，如图所示:

![Figure 13.2 – The DNS root server hierarchy
](img/B18389_13_002.jpg)

图 13.2–DNS 根服务器层级

DNS 根区域由全球 13 台根服务器和大约 600 台冗余根服务器组成。TLD 服务器代表域名的扩展，并提供一种组织数据的方式，以便更容易解析查询。离开 TLD，您将看到特定域的服务器，后面是它们各自的子域，如果有的话。

举个例子，如果我们从 TLD.org 开始，我们会看到以下内容:

*   该域的服务器[wikipedia.org](http://wikipedia.org)
*   接着是各自的子域，[en.wikipedia.org](http://en.wikipedia.org)和【as.wikipedia.org】T2。

虽然根服务器有着重要的作用，但是当发出 DNS 请求时，还会涉及到其他服务器。接下来我们来考察一下这个概念。

## DNS 服务器的类型

当请求一个 IP 地址时，有两种主要类型的服务器参与事务，**权威**和**递归**。

首先，让我们看看在解析 IP 地址时，权威服务器是如何发挥重要作用的。

### 作为权威

在任何 DNS 结构中，都必须有一个权威的 DNS 服务器。权威服务器保存该域的主记录集，并在发生变化时进行更新。

在每个区域中，都有一个权威服务器。在大多数情况下，存在多个冗余。不同的类型如下:

*   主服务器将存储所有可靠的域记录，包括 IP 地址和管理员名称，以及特定于域的 RRs。
*   辅助服务器将存放区域文件的只读副本。它会定期通过请求区域转移来获取文件的更新版本。
*   存根服务器只包含**名称服务器** ( **NS** )数据，因为它的主要作用是向递归服务器发送请求。

需要一个主要权威服务器。辅助权威服务器是可选的。但是，在高请求量期间，通过分担负载来提供冗余和减少依赖性是一种很好的做法。

另一种类型的 DNS 服务器是递归服务器。

### 使用递归服务器

递归的服务器是一个非权威的服务器，保存普通来回用户查询的缓存副本。

当客户端请求 IP 地址时，查询可以是以下任何一种:

*   **递归**是指 DNS 服务器将完成获取响应的工作。
*   **迭代**是指客户端必须完成获取响应的工作。

在大多数情况下，当客户端发出 DNS 请求时，它将被定向到递归服务器。如果服务器没有请求的 IP 地址，它将代表客户端继续搜索响应。来自递归服务器的请求以迭代的方式完成，直到它们到达所请求的域的权威 DNS 名称服务器，如图所示:

![Figure 13.3 – A DNS query using a recursive server
](img/B18389_13_003.jpg)

图 13.3–使用递归服务器的 DNS 查询

使用递归查询，`GE.com`的 IP 地址解析过程如下:

1.  客户端为`GE.com`请求一个 IP 地址。
2.  如果递归服务器在缓存中没有答案，它将需要查询根 DNS 服务器。
3.  根服务器将把递归服务器指向`.com`的 TLD。
4.  TLD 服务器将指示递归服务器向权威域名服务器查询`GE.com`域名。
5.  递归服务器然后将结果返回给客户端。

显而易见，DNS 过程涉及许多组件来解析 IP 地址。但是 DNS 是如何与其他主机通信的呢？正如我们所知，许多协议使用专用的传输方法。例如，**动态主机配置协议** ( **DHCP** )使用**用户数据报协议** ( **UDP** )作为其传输协议。然而，在下一节中，我们将了解 DNS 如何根据任务使用端口`53`使用**传输控制协议** ( **TCP** )和 UDP 。

## 传输域名系统

两个主要的传输层协议是 TCP 和 UDP。区别如下:

*   UDP 是一种无连接的轻量级协议，用于需要快速传输数据的情况。
*   TCP 是一种面向连接的协议，能够在监控拥塞和提供流量控制的同时确保完整的数据传输。

传输数据时，DNS 可以使用 TCP 或 UDP。首先，让我们研究一下为什么 UDP 是发出请求时主要使用的协议。

### 提供快速解决方案

在大多数情况下，DNS 对主要或反向 DNS 请求使用 UDP。一个关键原因是，当主机发送查询时，目标是提供快速的解决方案。UDP 不经过握手过程；它只是请求解决方案并等待响应。

此外，UDP 是一种轻量级协议，使用小于 512 字节的数据包传输少量数据。大多数情况下，DNS 查询或响应都远远低于这个限制。

使用 UDP 是传输协议的最佳选择，因为 DNS 服务器必须快速响应并能够响应传入的查询，如果服务器必须保持 TCP 连接，这是不可能的。

虽然 UDP 是使用 DNS 时的主要传输协议，但 DNS 使用 TCP 的原因有几个。

### 确保完全转移

使用 DNS 时，TCP 可能被用作传输协议有两个原因:

*   完成区域转移时，因为准确性比速度更重要。使用面向连接的流程将确保传输完成。
*   每当有效负载大于 512 字节时，应用必须使用 TCP。

所有 DNS 记录都不相同。在下一节中，让我们比较一些 DNS RRs。

# 比较 RRs 的类型和分类

DNS 的核心是 RR，它包括请求资源的名称、类型、**生存时间** ( **TTL** )和 IP 地址等信息。在这一节中，我们将回顾一些不同类型的 RR，并研究其中一种的结构。

让我们从回顾一些不同类型的 RRs 开始。

## 分解 DNS 类型

每当您向 DNS 服务器发送请求时，请求将包含要返回的记录类型。尽管有许多类型的 DNS RR，我们还是来看看一些常见的类型，如下表所示:

![Table 13.1 – The types of DNS RRs
](img/B18389_table_13.1.jpg)

表 13.1–DNS RR 的类型

如所示，这些是普通记录；然而，还有更多。有关 DNS 类型的完整列表，请访问 https://phoenixnap.com/kb/dns-record-types。

注意

一个 AAAA 类型的 RR 是一个 IPv6 地址，也被称为四元 T2。此类型使用四个 As，因为 IPv6 地址的长度是 IPv4 地址的四倍。

现在您已经了解了一些 RR 类型，让我们来看看 RR 的结构。

## 检查 RR 结构

所有 RR 的结构包含描述 RR 的元素，如下表所示:

![Table 13.2 – The elements in a DNS RR
](img/B18389_table_13.2.jpg)

表 13.2–DNS RR 中的元素

接下来，我们来看一个 DNS 响应包中 RR 应答的例子。为了让你能跟上，我们将从 CloudShark(【https://www.cloudshark.org/captures/13833cdd14ba】)获取一个数据包捕获。下载文件`DNS Question & Answer.pcapng`，并在 Wireshark 中打开它。选择**帧 2** ，展开 DNS 头。然后，展开`Queries`部分的第一个 RR，如下图所示:

![Figure 13.4 – A DNS RR answer 
](img/B18389_13_004.jpg)

图 13.4–DNS RR 答案

在任何交易中，您都会在 DNS 数据包的结构中发现大量信息。接下来让我们对此进行调查。

# 查看 DNS 数据包

DNS 是一种客户端-服务器模型，用于将主机名解析为 IP 地址。要查看一个完整的 DNS 包，请转到`DNS Question & Answer.pcapng`并展开**帧 2** 中的`Domain Name System (response)`插入符号，如下所示:

![Figure 13.5 – Expanded DNS packet
](img/B18389_13_005.jpg)

图 13.5-扩展的 DNS 数据包

正如您所看到的，DNS 数据包有几个部分，如下所示:

*   第一部分( **1** )是 DNS 头。
*   第二节( **2** )总结内容。
*   第三部分( **3** )是查询部分。
*   第四部分( **4** )是 Wireshark 特定的引用。

在本节中，我们将回顾 DNS 报头中的字段值，回顾 DNS 数据包的结构，然后比较 DNS 问答部分。

让我们从检查 DNS 头元素开始。

## 检查割台

客户端或服务器的报头*结构*是相同的。不同的是每个报头的*字段值*，它将标识消息是查询还是响应，并包括事务的其他参数。

进入`DNS Question & Answer.pcapng`后，展开**第 2 帧**中的`Flags`插入符号，如以下截图所示:

![Figure 13.6 – The expanded DNS header
](img/B18389_13_006.jpg)

图 13.6–扩展的 DNS 头

检查标题字段时，您会看到两个主要部分:

*   `Transaction ID`
*   `Flags`

`Transaction ID`是 DNS 数据包的基本元素，因为它在查询和响应数据包的交换过程中识别特定的 DNS 事务。Wireshark 跟踪`Transaction ID`，以便您可以轻松地引用事务的各个部分。例如，在**框 2** 的底部，您会看到以下指示灯:

![Figure 13.7 – Wireshark-created indicators
](img/B18389_13_007.jpg)

图 13.7-Wireshark 创建的指示器

`Request In: 1`是一个超链接，它将把您带到`Transaction ID: 0x0003`的请求包。

注意

`Time`部分列出了查询和结果响应之间经过的时间。

在`Transaction ID`之后，您将看到`Flags`部分，它提供了交易的细节。但是，您会注意到，客户端的标志与服务器的标志不同。接下来我们来探讨一下。

### 比较标志

当比较 DNS 报头中的标志时，您会发现来自客户端的数据包和来自服务器的数据包有明显的不同。

来自*客户端*的标志如下:

*   **响应**:设置为`0`，其中表示该消息为查询。
*   **操作码**:对于大多数请求，**操作码** ( **操作码**)为`0`，表示这是一个标准查询。
*   **截断**:当设置为`0`时，表示消息没有被截断。
*   **期望递归**:设置为`1`时，表示客户端请求递归。
*   **Z** :过时 DNS 实现中使用的弃用标志。
*   **未认证数据**:设置为`0`，因为该标志仅用于响应数据包。

来自*服务器*的标志是如下的:

*   **响应**:设置为`1`，表示该消息为响应。
*   **操作码**:对于大多数响应，操作码是`0`，这表明这是一个标准查询。
*   **权威**:表示该服务器是否是该域的权威。当设置为`0`时，表示该服务器不是该域的授权机构。
*   **截断**:当设置为`0`时，表示消息没有被截断。
*   **期望递归**:设置为`1`时，表示客户端请求递归。
*   **递归可用**:设置为`1`时，表示服务器可以进行递归查询。
*   **Z** :过时 DNS 实现中使用的弃用标志。
*   **答案认证**:表示答案/权限部分是否通过服务器认证。
*   **非认证数据**:用于响应包。如果该值被设置为`1`，这将表明所包含的所有数据都已经过 DNS 服务器的认证。
*   **Reply code**: `0` will indicate that there is no error.

    注意

    设置后，截断标志将指示消息是否因超出 UDP 数据包 512 字节的限制而被缩短。

操作码标志将指示正在发送的消息的类型，因为它向 DNS 服务器发出命令来执行一些动作。让我们来看看。

### 定义操作码

在大多数情况下当检查操作码值时，值将被设置为`0`，表示这是一个标准查询。但是，也可以设置其他值，如下所示:

![Table 13.3 – DNS OpCode
](img/B18389_table_13.3.jpg)

表 13.3–DNS 操作码

一些操作码，如 3 和 7–15 等,目前尚未分配。但是，这种情况可能会发生变化，例如，操作码 6 DSO 是一个较新的操作码，在有活动状态时使用，例如在 TLS 会话期间。

最有可能在查询中的`1`处设置的一个标志是递归标志。让我们来讨论一下这面旗帜的意义。

### 请求递归

DNS 中有两种类型的查询——**递归**和**迭代**。每当客户端提交一个 DNS 查询时，通常会看到下面的标志集—`Recursion desired: Do query recursively`。

递归查询是首选选项，因为当可用时，DNS 服务器将完成获取响应的工作。相反，迭代查询适用于客户端必须获取响应的情况。

当服务器响应时，它将使用以下任一方式进行回复:

*   `Recursion Available`其中标志设置为`1`，这意味着服务器将完成一个递归查询
*   `Recursion Not Available`其中标志设置为`0`，这意味着服务器不会完成递归查询，因为不支持这种类型的查询

当查看请求或回复的 DNS 头时，消息头后面有四个部分。接下来我们就来探讨一下这些。

## 剖析数据包结构

对于查询或响应，DNS 头后面的四个部分如下:

*   `Questions`:请求的分辨率
*   `Answers RRs`:提供答案的 RR 的数量
*   `Authority RRs`:提供权威 NS 的 IP 地址的 RR 的数量
*   `Additional RRs`:包含附加信息的 RRs 的数量

举个例子，如内容摘要中的下图所示(如 **2** 部分所示)，我们可以看到有 **1** 问题，它返回了 **11** RRs:

![Figure 13.8 – The DNS summary section
](img/B18389_13_008.jpg)

图 13.8–DNS 摘要部分

沿着数据包结构，您会发现查询部分，它用于发送问题或提供响应。

## 概述查询部分

当查看 DNS 头详细信息时，DNS 问题的格式不同于 DNS 答案，如下所示:

![Figure 13.9 – DNS questions and answers
](img/B18389_13_009.jpg)

图 13.9–DNS 问题和答案

当客户端向 DNS 服务器发出请求时，它是在请求解析。如果我们从客户端转到`DNS Question & Answer.pcapng`并展开第 1 帧请求中的`Queries`插入符号，我们将看到以下信息:

![Figure 13.10 – The DNS client query
](img/B18389_13_010.jpg)

图 13.10–DNS 客户端查询

第一部分( **1** )是 Wireshark 对查询部分的总结。第二部分( **2** )是 DNS 问题部分，包含以下内容:

*   **名称**:请求的分辨率。在这种情况下，客户希望分辨率为`Google.com`。
*   **类型**:RR 的类型。在这种情况下，客户端请求一个`A`类型或 A 类型(IPv4)地址。
*   **类别**:请求的 RR 的类别。在这种情况下，类被列为`IN`，这是最常见的 QClass 请求。

当服务器回复 DNS 请求时，它将返回客户端的查询，并(在大多数情况下)返回答案。如果我们从服务器转到`DNS Question & Answer.pcapng`并在第 2 帧的响应中选择`Answers`插入符号，我们将看到以下信息:

![Figure 13.11 – The DNS server answers
](img/B18389_13_011.jpg)

图 13.11–DNS 服务器应答

当然，来自服务器的答案可能会有所不同。然而，在这种情况下，服务器返回了 11 个 RR。

现在您已经了解了 DNS 数据包的要素，让我们看看 DNS 进行解析时的其他一些考虑事项。

# 评估查询和响应

DNS 查询和响应非常简单。客户端向 DNS 服务器发送 IP 地址查询，服务器用该信息进行响应。在本节中，我们将了解事务期间的一些行为，例如缓存响应，以及使用 Wireshark 监视事务期间的平均响应时间。

然后，我们将评估当我们需要对 DNS 进行故障诊断时会发生什么，以及`nslookup`如何帮助检查和验证响应。最后，我们将看看欺骗 DNS，以及我们如何保护这个过程。

让我们从了解缓存如何在 DNS 过程中发挥作用开始。

## 缓存响应

网络上的任何事情都有时间限制。DNS 也不例外。当服务器返回响应时，答案中有几个元素。该响应中包含 TTL 值，它反映了记录在消失之前可以在缓存中存在多长时间。

TTL 值因系统而异，但通常由域名所有者设置。

在*图 13.4* 中，我们可以看到`Time to live: 4 (4 seconds)`，这意味着响应可以在缓存中存在 4 秒钟。

注意

请记住，DNS RR 中的 TTL 值不同于 IPv4 报头中的 TTL 值。DNS RR 中的 TTL 是响应可以在缓存中存在多长时间。IP 报头中的 TTL 表示数据包在被路由器丢弃之前可以经过多少跳。

DNS RRs 的 TTL 值变化很大是很常见的。要在 Windows 机器上检查自己的缓存，打开命令提示符并键入`ipconfig /displaydns`。这将显示缓存中保存的您自己的 DNS RRs 的列表，例如，在运行命令后，我选择了其中一个记录，如下所示:

api.wildtangent.com

-

记录名称。。。。。:api.wildtangent.com

记录类型。。。。。: 1

是时候活下去了。。。。: 17

数据长度。。。。。: 4

部分。。。。。。。:回答

(主)记录。。。: 34.210.94.123

在响应中，我们可以看到`api.wildtangent.com`的 RR 答案的`Time To Live`值为`17`(秒)。

如果 17 秒后，操作系统需要`api.wildtangent.com`的 IP 地址，而 DNS 信息不在缓存中，它必须发出另一个 DNS 查询。

大多数 DNS 查询和响应都在 120 毫秒(ms 或 msec)或 0.12 秒以下；然而，一些响应可能需要更长时间。接下来，让我们看看如何使用 Wireshark 来计算响应时间。

## 计算响应时间

DNS 响应时间可能有所不同；然而，有时回应似乎比平时要长。为了测试响应时间，网络管理员有多种工具。例如，要测试你的 DNS 提供商的速度，去 https://www.dnsperf.com/dns-speed-benchmark 的。一旦出现，在域名字段中输入`example.com`，然后选择**运行测试**。该网站将显示世界各地服务器的响应时间。向下滚动，您将看到如下结果:

*   `36 ms [United States] United States, Dallas (DC139)`
*   `14 ms [United States] United States, Asheville (DC82)`
*   `126 ms [Egypt] Egypt, Cairo (DC225)`

您还可以使用 Wireshark 生成的统计数据来查看响应时间。让我们来看看。

### 查看 DNS 响应时间

为了向您展示一个更长 DNS 响应时间的可视化示例，我们将使用`bigFlows.pcap`。你可以在[http://tcpreplay . app neta . com/wiki/captures . html # big flow-pcap](http://tcpreplay.appneta.com/wiki/captures.html#bigflows-pcap)找到 big flow。

打开`bigFlows.pcap`后，应用以下过滤器:

```
(((((dns) && (dns.flags.response == 1)) && !(sflow)) && !(icmp)) && !(dns.flags.rcode == 2)) && (dns.time > 0.2)
```

该过滤器将执行以下操作:

*   使用`dns`过滤器显示所有 DNS 流量
*   使用`dns.flags.response == 1`过滤器仅显示*的* DNS 响应
*   使用`!(dns.flags.rcode == 2)`忽略任何 DNS 服务器错误
*   使用`!(sflow)) && !(icmp)`过滤器移除所有管理流量，例如**互联网控制消息协议** ( **ICMP** )和**采样流量** ( **sFlow** )流量
*   使用`dns.time > 0.2`过滤器缩小搜索范围，仅显示响应时间大于 0.2 秒的数据包

运行过滤器后，可以添加一个列标题来显示响应时间。

要添加列标题，请先展开 DNS 标题以查看详细信息。接下来，找到 Wireshark 生成的值`Time`，如下所示:

![Figure 13.10 – The DNS server answers
](img/B18389_13_012.jpg)

图 13.10–DNS 服务器应答

右键单击该值并选择**应用为列**。要调整和编辑列以便更好地可视化数据，右键单击任何列标题并选择**列首选项…** 。

在那里，您可以通过单击并拖动列标题到所需的位置来移动列。为了显示响应时间，我重命名了快捷方式`DNS Response time`并禁用了一些列标题，如下所示:

![Figure 13.11 – Column preferences
](img/B18389_13_013.jpg)

图 13.11–列首选项

在您调整了列的标题后，您可以通过单击一次 **DNS 响应时间**标题来对 DNS 响应时间进行排序，以显示最长的时间值。结果如下所示:

![Figure 13.12 – BigFlows showing DNS response times
](img/B18389_13_014.jpg)

图 13.12–显示 DNS 响应时间的大流量

如图所示，DNS 响应时间可能会有所不同。虽然这是意料之中的，但查看 DNS 服务健康状况的另一种方法是检查统计数据。为此，进入**统计** | **DNS** ，这将打开 DNS 统计窗口。我应用了`!(dns.flags.rcode == 2)`过滤器，然后删除了服务器故障错误，如下所示:

![Figure 13.13 – BigFlows DNS statistics
](img/B18389_13_015.jpg)

图 13.13–大流量 DNS 统计

在统计窗口中，您可以看到各种计算值。窗口中央是服务统计数据。我们可以从这个(过滤后的)捕获中看到，以毫秒为单位的请求-响应时间如下:

*   平均请求-响应时间–**69.67**毫秒
*   最短请求-响应时间–**0.082000**毫秒
*   Maximum request-response time – **509.076996** milliseconds

    注意

    在大多数情况下，您会希望看到服务器故障错误。然而，在这个捕获中，有太多的错误扭曲了响应时间统计。

DNS 统计在故障排除过程中是一个非常有用的工具。例如，值得研究以下问题:

*   请求-响应时间过长或响应失败的查询可能表明 DNS 服务器有问题，例如瓶颈或失败的**网络接口卡** ( **NIC** )。
*   如果您看到异常大量的请求和响应，这可能表明 DNS 隧道。
*   大量请求和响应也可能表示主机正在与**命令和控制** ( **C & C** )服务器通信，该服务器用于远程控制受感染的主机。
*   经历不成比例的大量 DNS 响应可以表明 DNS **拒绝服务** ( **DoS** )可能在起作用。

接下来，让我们来看看`nslookup`，这是一个可以在排除 DNS 故障时使用的命令行工具。

## 使用 nslookup 进行测试

设置和维护 DNS 服务器是一项挑战。 DNS 服务是必不可少的，如果配置不当，这可能会导致主机之间的通信能力出现严重问题。此外，如果 DNS 缓存已中毒，这也将阻止主机通信，并可能将客户端误导到恶意站点。

在 Windows 机器上进行快速测试的一个方法是使用`nslookup`，这是一个命令行工具，主要用于解决 DNS 问题。

要使用`nslookup`，请转到*启动*，然后输入`Run`。进入应用后，输入`cmd`，如下图所示:

![Figure 13.14 – Using Run
](img/B18389_13_016.jpg)

图 13.14–使用运行

一旦进入命令行界面，键入`nslookup example.com`，然后按*进入*。一旦运行，我的输出如下:

c:\ > nslookup example.com

服务器:cdns01.comcast.net

地址:2001:558:feed::1

非权威回答:

姓名:example.com

地址:2606:2800:220:1:248:1893:25 c8:1946

93.184.216.34

请求首先到我的**互联网服务提供商** ( **ISP** )，然后`cdns01.comcast.net`解析 IP 地址。

注意

在 macOS 和/或 Linux 上，使用`dig`命令将提供类似的结果。

DNS 可能遭受恶意活动。在下一节中，让我们讨论一些与 DNS 相关的安全问题。

## 保护域名系统

DNS 已经被用来解析地址很多年了。在互联网的早期，没有任何保护协议的考虑。因此，它可能会遭受缓存中毒和欺骗等攻击。

首先，让我们概述一下如果恶意行为者毒害缓存会发生什么。

### 毒害缓存

DNS 对任何网络都是必不可少的。当客户端请求 IP 地址时，它们相信服务器会提供准确的地址。如果地址不正确，客户端可能会被重定向到一个虚假的站点。

DNS RRs 有一个 TTL 值，表示它们可以在缓存中存在多长时间，缓存是 DNS 记录的临时保存区域。缓存是一个重要的概念，因为它提供了一种对查询发送更快响应的方式。

缓存中毒将欺骗信息注入到 DNS 服务器的缓存中。恶意行为者利用这种攻击来误导请求 DNS 解析的客户端。攻击的结果将取决于中毒的服务器。在一个**局域网** ( **局域网**)上，所有本地用户都会受到影响。然而，毒害 ISP 服务器的缓存将会产生广泛的影响。

防范破坏 DNS 的攻击至关重要。让我们研究一下实现这一点的方法。

### 捍卫 DNS

DNS 服务器代表易受攻击的目标。为了保护服务器，网络管理员可以采用一些技术:

*   使用缓存锁定，它控制如何以及何时可以覆盖缓存。
*   将区域传送限制为只响应受信任的服务器。
*   使用 **DNS 安全扩展** ( **DNSSEC** )，由提供数据认证和完整性。

此外，应使用所有其他保护 DNS 服务器的标准良好实践技术。技术包括保持服务器更新和修补，并使用防火墙，限制访问只有授权的实体。

# 总结

在本章中，我们概述了 DNS 的用途，回顾了服务器的类型，然后比较了 DNS 的传输方式。然后，我们评估 RR 的类型和类别，然后分析 RR 中包含的结构和信息。接下来，我们检查了一个 DNS 数据包，深入研究了报头字段和标志，分析了数据包结构，并回顾了查询部分。

到目前为止，您应该对 DNS 查询和响应过程有了很好的理解，并且能够识别 TTL 值，该值表示该值可以在缓存中保留多长时间。此外，我们还了解了如何在 Wireshark 中检查 DNS 统计数据，以及如何使用`nslookup`和`dig`等工具测试 DNS。然后，我们通过讨论潜在威胁以及如何保护 DNS 的一般建议进行了总结。

在下一章中，我们将首先解释**动态主机配置协议** ( **DHCP** )的必要性，并回顾这一基本协议的目的。为了让您理解如何从 DHCP 服务器获得 IP 地址，我将概述一下**发现提供请求确认** ( **DORA** )过程。然后，我将剖析 DHCP 报头，查看所有字段值标志和端口号，然后以一个 DHCP 示例结束。

# 问题

现在，是时候检查你的知识了。选择最佳答案，然后检查您的答案，这些答案可在*评估*附录中找到:

1.  _____ 服务器是响应根区域内查询的名称服务器，是解析地址的重要组成部分。
    1.  递归的
    2.  根
    3.  多余的
    4.  贮藏
2.  在任何 DNS 结构中，都必须有一个(n)_ _ _ _ _ _ DNS 服务器来保存域的主记录集，并在发生变化时进行更新。
    1.  递归的
    2.  多余的
    3.  命令式的
    4.  贮藏
3.  DNS RR 有很多种。类型 12 _____ 将 IP 地址转换为域名。
    1.  AXFR
    2.  麦克斯韦(maxwellˌ磁通量单位)ˌ中性(Middlesex)
    3.  AAAA
    4.  中石油
4.  当被设置时，____ 标志将指示消息是否因为超过了 UDP 数据包 512 字节的限制而被缩短。
    1.  递归的
    2.  贮藏
    3.  变钝
    4.  缩短了的
5.  经历不成比例的大量 DNS 响应可能表明可能存在 DNS _____ 攻击。
    1.  电子欺骗
    2.  两个
    3.  缩短
    4.  储藏毒药
6.  在 DNS 问题部分，____ 是请求的解决方案。
    1.  名字
    2.  类型
    3.  班级
    4.  隐藏物
7.  在 Windows 机器上解决 DNS 问题的一种方法是使用 _____ 命令行工具。
    1.  `baseline`
    2.  `boost`
    3.  `nslookup`
    4.  `dig`

# 延伸阅读

请参考以下链接了解更多信息:

*   请访问[https://www . cloud flare . com/learning/dns/glossary/DNS-root-server/](https://www.cloudflare.com/learning/dns/glossary/dns-root-server/)了解有关 DNS 根服务器的更多信息。
*   Verisign 对 DNS 的工作原理进行了深刻的讨论。请访问[https://www . verisign . com/en _ US/website-presence/online/how-DNS-works/index . XHTML](https://www.verisign.com/en_US/website-presence/online/how-dns-works/index.xhtml)了解更多信息。
*   访问[https://www.cloudns.net/blog/dns-history-creation-first/](https://www.cloudns.net/blog/dns-history-creation-first/)了解 DNS 的简史。
*   要查看所有参与创建和完善我们今天使用的 DNS 协议的 RFC 的详细信息图，请访问:[https://emaillab.jp/dns/dns-rfc/](https://emaillab.jp/dns/dns-rfc/)。
*   要查看简单区域文件的示例，请访问[https://docs . Fedora project . org/en-US/Fedora/12/html/Deployment _ Guide/S2-bind-zone-examples . html](https://docs.fedoraproject.org/en-US/Fedora/12/html/Deployment_Guide/s2-bind-zone-examples.html)。
*   有关 Wireshark 中 DNS 统计的更多信息，请访问[https://www . Wireshark . org/docs/wsug _ html _ chunked/chstatdns . html](https://www.wireshark.org/docs/wsug_html_chunked/ChStatDNS.html)。
*   访问[https://datatracker.ietf.org/doc/html/rfc1035](https://datatracker.ietf.org/doc/html/rfc1035)了解有关域名以及如何正确实施和配置 DNS 生态系统的详细信息。
*   如需深入了解 DNS，请访问[https://www2 . cs . duke . edu/courses/fall 16/compsci 356/DNS/DNS-primer . pdf](https://www2.cs.duke.edu/courses/fall16/compsci356/DNS/DNS-primer.pdf)。
*   要全面查看 DNS 头中的字段值，请访问[https://isc . sans . edu/forums/diary/When+attackers+use+your+DNS+to+check+for+sites+you+is+visiting/16955/](https://isc.sans.edu/forums/diary/When+attackers+use+your+DNS+to+check+for+the+sites+you+are+visiting/16955/)。
*   要了解更多关于如何使用 DNS 截断标志，请访问[https://support.f5.com/csp/article/K91537308](https://support.f5.com/csp/article/K91537308)。
*   要了解更多关于 DNS 响应时间的信息，请访问[https://www.keycdn.com/support/reduce-dns-lookups](https://www.keycdn.com/support/reduce-dns-lookups)。
*   请访问[https://security trails . com/blog/8-tips-to-prevent-DNS-attacks](https://securitytrails.com/blog/8-tips-to-prevent-dns-attacks)，了解保护 DNS 服务器安全的方法。
*   要查看 DNS 参数列表，请访问[https://www . iana . org/assignments/DNS-parameters/DNS-parameters . XHTML # DNS-parameters-5](https://www.iana.org/assignments/dns-parameters/dns-parameters.xhtml#dns-parameters-5)。
*   访问[https://www . DNS filter . com/blog/C2-server-command-and-control-attack](https://www.dnsfilter.com/blog/c2-server-command-and-control-attack)了解如何使用 C & C 服务器与受感染的主机进行通信。