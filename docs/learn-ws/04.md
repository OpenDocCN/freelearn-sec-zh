# 二、使用 Wireshark

Wireshark 是一种协议分析器，可以捕获流量，然后以人类可读的格式呈现出来。在本章中，您将深入了解 Wireshark 的整体功能，并了解如何排除网络流量故障、监控安全问题以及调试应用。我们首先来看看这个界面的一些特性。我们还将介绍在哪里可以找到快捷方式列表，这样您就可以自信而快速地捕获和分析数据包。

为了让您更好地了解 Wireshark 的成果，我们还将回顾一下参与此项目的众多作者的名单，他们帮助 Wireshark 成为一款出色的工具。我们还将看到您可以在界面的什么地方找到链接，这些链接提供了关于如何更好地使用 Wireshark 的有用信息。

为了更好地理解数据包分析过程，我们将简要回顾一下所涉及的每个阶段:*收集*、*解码*、*显示*，以及*分析*。然后我们将回顾补充 Wireshark 基本功能的内置**命令行界面** ( **CLI** )工具。最后，我们将仔细研究一下`tshark`，这是一个轻量级 CLI 应用，您可以在需要捕获流量时使用它，而无需使用 Wireshark 的资源密集型开销。

本章将通过涵盖以下主题来解决所有这些问题:

*   检查 Wireshark 接口
*   了解数据包分析的各个阶段
*   了解如何使用 Wireshark CLI 工具

# 检查 Wireshark 接口

Wireshark 为分析网络流量提供了一个全面的框架，它在大多数操作系统上都表现良好。界面简洁直观，提供快捷方式和方法，使导航更容易，并让您开始分析流量。在本节中，我们将了解 Wireshark 如何显示信息，以及在哪里可以找到键盘快捷键列表。我们还将看看使这个应用成为可能的许多作者，并描述一些您可以获得帮助和了解更多关于 Wireshark 的方法。

让我们先简要了解一下 Wireshark 接口。

## 简化界面

当您第一次启动 Wireshark 时，您会看到一个活动的接口列表。有些界面旁边有一个迷你图(或移动的图形符号)。当迷你图出现时，表示正在积极交换数据，您可以选择该接口并开始捕获流量。

如下图所示，Wi-Fi 和 **VMware** 网络接口都有活动迷你图:

![Figure 2.1 – The Wireshark interface
](img/B18389_02_001.jpg)

图 2.1–Wireshark 界面

在分析过程中，Wireshark 有许多方法可以改善您的体验。例如，在 Wireshark 中处理数据包捕获时，您可以轻松地向界面添加列。只需右键单击数据包详细信息区域中的一个值，然后选择 **Apply as 列**，如下面的屏幕截图所示。选择此选项会将`Flags`字段添加为一列:

![Figure 2.2 – Applying as a column
](img/B18389_02_002.jpg)

图 2.2–作为列应用

Wireshark 还包括**智能滚动条**，它位于数据包列表的右侧。当着色规则打开时，您可以看到问题的迹象，并快速找到问题点，这些问题点显示为深黑线。在下面的截图中， *1* 突出了这一点:

![Figure 2.3 – The Wireshark interface with enhanced features
](img/B18389_02_003.jpg)

图 2.3–具有增强功能的 Wireshark 界面

其他一些特性包括:

*   有增强的图形，例如，易于使用的流程图和 I/O 图。
*   有着色规则，很容易创建和编辑。
*   显示相关数据包–您只需点击即可查看相关数据包(即虚线，如前面截图左侧的 *2* 所示)。
*   它能被翻译成几种不同的语言。

凭借每年数百万的下载量，Wireshark 已经成为一个重要的工具。作为一个开源工具，它已经被证明是灵活的，并鼓励开发人员添加功能，以及改善整体外观。

每个新版本都改进了应用。改进可以包括修复简单的视觉或显示问题，以解决可能导致应用崩溃的更重要的问题，例如有故障的解剖器。当您更新 Wireshark 时，请花点时间阅读注意事项，其中包括如下信息:

*   怎么样
*   错误修复
*   新的和更新的功能
*   新协议支持
*   更新的协议支持
*   新的和更新的捕获文件支持
*   新的和更新的捕获接口支持
*   获得帮助
*   常见问题

除了许多优点和功能之外，Wireshark 还提供了一种使用键盘进行导航的方法。接下来我们来考察一下这个概念。

## 发现键盘快捷键

每个人都有与 Wireshark 交互的偏好。有些人更喜欢使用键盘，因为它比使用鼠标更快更直观。

Wireshark 有一个键盘快捷键列表，可以通过选择**帮助**菜单选项，然后点击**关于 Wireshark** 并选择**键盘快捷键**选项卡找到，如下所示:

![Figure 2.4 – Keyboard shortcuts
](img/B18389_02_004.jpg)

图 2.4–键盘快捷键

例如，当使用数据包捕获时，很多时候我会选择 *Ctrl + +* ，这将放大界面中的主要文本。

由于开源社区的慷慨，这些年来所有这些改进都是可能的。以下部分概述了如何查看谁参与了 Wireshark 的创建。

## 认识 Wireshark 作者

Wireshark 是开源的，在**GNU**通用公共许可证 ( **GPL** )下发布。它的成功归功于多年来为它贡献时间的许多开发人员。

当 Gerald Combs 和最初的开发团队首次发布 Ethereal T1 时，它的功能有限，只能解码不到六个协议。然而，多年来，开发人员增加了解剖器、功能和易用性。因此，Wireshark 已经成为当今最主要的网络协议分析器之一。

许多作者通过提供应用的持续开发和维护，为 Wireshark 的成功做出了贡献。一些人不断地加入他们的专业知识，而其他人只在他们需要特定的协议剖析者时才做出贡献。

任何人都可以参与，因为有大量关于如何添加基本解剖器的文档。如果您确实修改了 Wireshark 以添加解剖器或视觉增强，请与 Wireshark 团队分享您的工作，这样每个人都可以受益。

要查看 Wireshark 作者的当前列表，进入**帮助**菜单选项，点击**关于 Wireshark** 并选择**作者**选项卡，如以下截图所示:

![Figure 2.5 – The list of Wireshark authors
](img/B18389_02_005.jpg)

图 2.5–Wireshark 作者列表

Wireshark 开发人员今天的目标是确保在 **Windows** 、 **macOS** 和 **Linux** 上的功能。您可以根据需要在任意数量的计算机上使用 Wireshark。所有的源代码都在 GPL 下，可以在当前的 Wireshark 源代码库中找到。

有时，你可能需要更多的信息或帮助来完成一项任务。在该界面中，有一个链接列表，将带您到外部资源。

## 查找信息

在 Wireshark 欢迎界面右侧的底部，您会看到**学习**标签，在那里您会找到**用户指南**、**维基**、**问答**和**邮件列表**链接。在链接下方，Wireshark 会列出您正在运行的版本，以及您是否正在接收自动更新。

为了让您更好地理解使用 Wireshark 时会发生什么，下一节将介绍分析数据包的过程。

# 了解数据包分析的各个阶段

**数据包分析**是收集网络流量，对其进行解码并解析原始位，并以人类可读的格式进行分析的过程，如下图所示:

![Figure 2.6 – The phases of packet analysis
](img/B18389_02_006.jpg)

图 2.6–数据包分析的各个阶段

无论使用何种软件，数据包分析都有四个主要阶段:*收集*，*解码*，*显示*，以及*分析*。在本节中，我们将回顾每个阶段，从第一步*收集*开始，在这里我们从网络收集数据。

## 收集网络流量

当您启动 Wireshark 时，欢迎屏幕会显示您当前设备上可用的网络连接列表。在大多数情况下，您将拥有不止一个接口。要立即开始捕获，您可以选择一个活动的迷你图并开始捕获。

或者，您可以进入**捕获**菜单，然后进入**选项**选项卡。这将打开以下窗口:

![Figure 2.7 – The Capture Options window
](img/B18389_02_007.jpg)

图 2.7–捕获选项窗口

请记住，有两个关键领域将使您能够收集流量:以混杂模式捕获和使用捕获引擎。让我们首先讨论为什么在捕获之前启用混杂模式很重要。

### 以混杂模式捕获

使用 Wireshark 收集流量时，您可以在所有接口上捕获。但是，为了让您可以看到进入网络接口卡的所有流量，请确保在**捕获选项**对话框的**输入**选项卡中选择以下选项之一:

*   勾选**混杂**列标题下界面旁边的框，如**捕获选项**对话框中间所示。
*   勾选**启用所有接口的混杂模式**框，如**捕获选项**对话框左下角所示。

选择要监听的接口并将其置于混杂模式后，该接口会收集网络流量。为此，需要一个捕获引擎。接下来我们来探讨一下这个概念。

### 使用捕获引擎

有效地捕获流量的一部分是安装适当的**数据包捕获** ( **pcap** )引擎。pcap 引擎提供了一个**应用编程接口** ( **API** )，可以从网络中捕获流量，以便操作系统能够对其进行处理。

因此，在安装 Wireshark 时，您会看到一个窗口出现，提示您安装 **Npcap** 。通常，人们不确定是否应该安装 Npcap。然而，如以下截图所示，Wireshark 需要 Npcap 或 **WinPcap** 来捕获数据:

![Figure 2.8 – The Wireshark prompt to install Npcap
](img/B18389_02_008.jpg)

图 2.8–安装 Npcap 的 Wireshark p rompt

如果您没有安装 Npcap 或 WinPcap，Wireshark 将不会按预期运行。

注意

虽然 WinPcap 可供下载，但它不再被主动维护。因此，在 Windows 机器上安装 Wireshark 时，Npcap 是首选的捕获引擎。

一旦您收集了流量，下一步就是转换原始位并将它们解码成适当的协议。

## 解码原始比特

流量以二进制形式进入网络接口卡，一次一帧。下图说明了如何将位转换为人类可读的格式:

![Figure 2.9 – Converting bits into a human-readable format
](img/B18389_02_009.jpg)

图 2.9–将比特转换成人类可读的格式

在这个阶段，Wireshark 使用**增强型数据包分析器** ( **EPAN** )，将比特解码为人类可读的形式。

### 穿越 EPAN

在 2006 年之前，Wireshark 被称为 Ethereal。名字后来变了，但是，主要核心是一样的。EPAN 是 Wireshark 的数据包分析引擎，它使用解析器(也称为解码器)。解析器提供关于如何根据适当的**征求意见稿** ( **RFC** )或其他规范以适当的格式重新创建协议的信息。EPAN 包含四个主要的 API，如下图所示:

![Figure 2.10 – The contents of the EPAN
](img/B18389_02_010.jpg)

图 2.10–EPAN 的内容

EPAN 组件描述如下:

*   **协议树**:显示单个数据包的详细分析。
*   解析器:这些提供信息关于如何将协议分解成合适的格式。
*   **剖析器插件**:这些插件使用剖析器作为独立的功能。
*   **显示过滤器**:这些允许你过滤捕获的数据。

在大多数情况下，Wireshark 能够正确识别和解析协议。但是，有时您需要帮助 Wireshark 解码协议。您可以通过右键单击该帧并选择**解码为…** 来实现，这将弹出以下窗口:

![Figure 2.11 – The Decode As... window
](img/B18389_02_011.jpg)

图 2.11–解码为...窗户

在此窗口中，您可以修改值以匹配适当的协议。当协议没有专用端口或者它们运行在与通常不同的端口上时，这个函数非常有用。例如，当 HTTP 在端口`8080`而不是端口`80`上运行时，您应该使用 **Decode As…** 。

一旦比特被转换成适当的格式，下一步就是以人类可读的格式显示结果。

## 显示捕获的数据

在 Wireshark 和许多其他数据包分析工具中，有许多选项可以增强您的图形化体验。当您在 Wireshark 中打开数据包捕获时，主显示的默认布局在三个面板中，如以下屏幕截图所示:

![Figure 2.12 – Wireshark’s main display, showing three panels
](img/B18389_02_012.jpg)

图 2.12–Wireshark 的主显示屏，显示三个面板

三个面板定义如下:

*   **数据包列表**:这是一个所有捕获的数据包的列表，每行代表一个数据包。如果的数据包太多，无法在面板中显示，用户可以使用右边的滚动条浏览捕获。
*   **数据包详细信息**:显示单个数据包的详细信息，包括协议和字段值。它还显示 Wireshark 特定的提示。以为例，当检查一个**传输控制协议** ( **TCP** )报头时，你会看到在源端口和目的端口下面列出了`[Stream index: n]`。然而，没有名为*流索引*的字段值。*流*是两个端点之间的通信，包括以下内容:
    *   端点 A 的套接字[IP 地址和端口]
    *   端点 B 的套接字[IP 地址和端口]

为了帮助跟踪所有数据流，Wireshark 在 TCP 报头中列出了每个数据流。如下图所示:

![Figure 2.13 – A packet details panel
](img/B18389_02_013.jpg)

图 2.13–数据包详细信息面板

*   **数据包字节**:这是单个数据包的十六进制表示，如数据包细节面板所示。任何纯文本数据都显示在右侧，如下面的屏幕截图所示:

![Figure 2.14 – A packet bytes panel
](img/B18389_02_014.jpg)

图 2.14–数据包字节面板

注意

数据包字节面板的默认视图是十六进制。但是，您可以通过右键单击面板中的任意位置并选择**将字节显示为位**，将视图更改为位。

虽然默认布局是三个面板，但您可以随时个性化此视图。

### 更改布局

要更改主窗口的外观，进入**编辑**菜单选项，然后选择**首选项**。进入**首选项**窗口后，选择**布局**，在这里您可以将布局更改为多种不同配置中的一种，如下所示:

![Figure 2.15 – Preferences | Layout
](img/B18389_02_015.jpg)

图 2.15–首选项|布局

Wireshark 显示捕获结果后，我们进入数据包分析的最后阶段:*分析*。

## 分析数据包捕获

分析阶段可以实时进行，也可以通过使用预捕获的文件对捕获的流量进行故障排除和检查。可以使用 Wireshark 中的许多内置工具进行分析，其中包括:

*   过滤流量以显示特定类型的流量，如 DNS 或 HTTP 流量
*   搜索特定数据包，例如`tcp.port == 443`
*   打开着色规则或使用专家系统轻松发现问题
*   跟随流来查看单个对话的细节
*   对各个帧进行深入的数据包分析，并检查每个报头的字段值

Wireshark 的**统计**菜单选项可以从基本信息功能(如**捕获文件属性**)到更详细的分析(如**对话**、**流图**和**流图**)。

除了 Wireshark 中的工具，您还可以对数据进行子集划分，以便与同事共享较小的文件，并为整个文件或单个框架添加注释。

尽管 GUI 易于使用和理解，但 Wireshark 界面及其所有增强功能、着色规则和快捷方式可能会占用大量资源。因此，最好熟悉一些 CLI 工具，我们将在下一节介绍这些工具。

# 将 CLI 工具与 Wireshark 配合使用

Wireshark 有几个 CLI 工具来补充的基本功能，并允许您执行几项任务，如编辑、分割和操纵数据包捕获。下表总结了一些可用的工具:

![Table 2.1 – Wireshark’s built-in CLI tools
](img/B18389_Table_2.1.jpg)

表 2.1–Wireshark 的内置 CLI 工具

所有的 CLI 工具都内置在 Wireshark 中，但是，在处理数据包捕获的工作时，它们也可以用作轻量级解决方案。

接下来，让我们来看看`tshark`，当你需要保存资源时，这是一个很好的选择。

## 探索沙克

Ethereal 开发过程的一部分包括**终端 Ethereal** ( **终端 ethereal** )，这是一个 CLI 工具。Tethereal 后来改名为**终端 Wireshark** ( **tshark** )。

要在 Windows 机器上使用`tshark`进行捕获，进入 CLI 并构建命令，如下例所示:

c:\ Program Files \ Wireshark > t shark-I " Ethernet 2 "-w Test-t shark . pcap-a 时长:10

请记住，如果您有多个接口，您将需要使用`ipconfig`来找到哪个接口是活动的。

注意

Windows 计算机上的命令不区分大小写。

要运行和`tshark`示例，请遵循的以下步骤:

1.  以`tshark`开始命令。
2.  使用`-i`识别接口，然后输入接口名称。
3.  要写入文件，使用`-w`，然后输入文件名和路径。请确保添加了扩展名。
4.  要设置持续时间，使用`-a`，它是捕获自动停止，并以秒为单位设置持续时间。
5.  按下*键进入*开始捕获。

完成后，在 Wireshark 中找到并打开`pcap`文件。如果您不将输出发送到文件，您将在屏幕上看到捕获的数据包列表:

![Figure 2.15 – Output from running tshark
](img/B18389_02_016.jpg)

图 2.15–运行 tshark 的输出

位于 https://www . Wireshark . org/docs/wsug _ html _ chunked/chcustcommandline . html 的 Wireshark 文档列出了许多与`tshark`一起使用的开关。许多选项与您在使用 GUI 时可以使用的选项相同，例如添加过滤器和特定字段值，包括以下内容:

![Table 2.2 – tshark options
](img/B18389_Table_2.2.jpg)

表 2.2–t shark 选项

CLI 工具可以评估任何可以被 Wireshark 剖析的协议。如果您不确定是否支持特定的协议，您可以查看**首选项**对话框中的协议列表。

## 解剖协议

Wireshark 加载了数百个要分析的协议，并且每年都会添加新的协议。要查看是否支持特定协议，请转到**编辑**，然后转到**首选项**(如下图所示)，并滚动查看所需协议:

![Figure 2.17 – The Wireshark Preferences dialog with the list of protocols
](img/B18389_02_017.jpg)

图 2.17–带有协议列表的 Wireshark 首选项对话框

一旦进入协议**首选项**窗口，您就可以修改 Wireshark 解析协议的方式。例如，在前面的截图中，AOL Instant Messager 使用 TCP 端口`5190`，如果要使用另一个端口，可以更改该端口。

# 总结

在本章中，我们简要了解了 Wireshark 接口。我们了解了如何通过点击迷你图快速开始捕获，轻松地向界面添加列，以及使用智能滚动条颜色来识别故障点。现在，您可以体会到 Wireshark 的每个新版本是如何在众多开发人员不断更新软件的帮助下得到改进的。我们还介绍了在哪里可以找到键盘快捷键和其他信息。

然后，我们探讨了数据包捕获的各个阶段，从收集网络流量到将其处理成人类可读的格式进行分析。最后，我们看到了由于 Wireshark 可能是资源密集型的，因此有时使用 CLI 工具(如用于捕获数据包的轻量级应用`tshark`)会更好。

在下一章中，我们将探索在各种操作系统上下载和安装 Wireshark，如 Windows、macOS 和 Linux。然后，我们将花时间探索不同的捕获引擎，并浏览 Windows 安装，比较不同的下载选项。最后，我们将看看在[https://www.wireshark.org/](https://www.wireshark.org/)可获得的各种资源。

# Questions

Now, it’s time to check your knowledge. Select the best response, then check your answers, which can be found in the *Assessments appendix*:

1.  (n)_ _ _ _ _ _ _(或移动的图形符号)表示主动交换数据。如果存在，您可以选择该接口并开始捕获流量。
    1.  （同 gramsperlitre）克/升
    2.  迷你图
    3.  应用接口
    4.  维基网
2.  为了能够看到进入网络接口卡的所有流量，请确保该卡处于 _____ 模式。
    1.  迷你图
    2.  请求评论
    3.  慷慨的
    4.  杂乱的
3.  ____ 引擎提供了一个 API，用于在操作系统处理流量之前捕获网络流量。
    1.  计算机辅助控制工程
    2.  pcap
    3.  tcap
    4.  首都信息
4.  _____ 提供了有关如何根据适当的 RFC 或其他规范将协议分解成适当格式的信息。
    1.  协议树
    2.  解剖过滤器
    3.  首都信息
    4.  解剖器
5.  Wireshark 有几个补充基本功能的 CLI 工具，可以将多个捕获文件合并成一个文件。
    1.  `tshark`
    2.  首都信息
    3.  mergecap
    4.  text2pcap
6.  如果您没有安装适当的 _____，如 Npcap 或 WinPcap，Wireshark 将不会按预期运行。
    1.  捕获引擎
    2.  captap
    3.  EPAN
    4.  字节牧马人
7.  在 Windows 机器上运行`tshark`之前，您需要使用 _____ 命令确定哪个接口是活动的。
    1.  netstat
    2.  用于查看本机的 IP 信息
    3.  砰
    4.  powercfg