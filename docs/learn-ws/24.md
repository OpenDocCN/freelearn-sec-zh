# 十八、子集化、保存和导出捕获

并非每个数据包捕获都是您需要分析的数据的完美大小或代表。无论是您自己捕获的流量，还是有人向您发送文件进行检查，一些数据包捕获都很大而且很麻烦。很多时候，为了进行有效的分析，大文件必须被细分成更小的文件。此外，完成后，您很可能需要保存文件，或者在某些情况下，将捕获导出为特定的格式。

在这一章中，我们将介绍几种可以用来处理数据包捕获的方法和技术。因此，您可以将一个大文件缩小到更易于管理的大小，我们将查看过滤捕获以缩小结果。您将了解 Wireshark 在导出不同的捕获组件方面是多么的灵活。最后，您将看到如何导出文件，以及指定的包、包解析和对象。此外，您将发现向单个数据包或整个捕获添加注释的原因和方法。

本章将通过涵盖以下内容来解决所有这些问题:

*   发现子集流量的方法
*   了解保存文件的选项
*   识别导出组件的方法
*   确定添加注释的原因和方式

# 发现子集流量的方法

数据包分析用于各种原因，包括故障排除、测试、监控和网络基线。虽然我们可以在开始分析之前通过使用捕获过滤器来减小文件大小，但很多时候我们会收集所有的流量，以便不会错过任何重要的细节。然后，一旦捕获，该文件就可以与团队的其他成员共享，以便进一步分析或指出具体问题。

在捕获流量时，最好是捕获大小合适的数据包，并且只包含有问题的数据包。然而，情况并非总是如此。有时，您可能会发现您必须处理一个大文件，原因有很多，包括:

*   您已经从具有大量通信量的网络设备获取了捕获。接入网络，即使时间很短，也会产生大量的数据包。即使您在获取文件时使用了捕获过滤器，您最终仍可能会获得大量数据。
*   你收到了一份来自好心人的文件，他认为大量的捕获将有助于你的分析。例如，您从一位同事那里收到了一个很大的文件，该文件捕获了服务器的流量，他们需要您帮助分析一个特定的问题。

无论您使用什么方法来获取捕获，您都需要在 Wireshark 中使用它。请记住，虽然 Wireshark 可以加载一个大文件，但它可能非常耗费资源并且响应缓慢。这是因为 Wireshark 会在显示捕获之前尝试分析所有协议。此外，当您对大型捕获应用显示过滤器时，需要一段时间来过滤流量。因此，最好的选择是对捕获进行子集划分，并关注问题区域。

当我们对流量进行子集划分时，我们会将其分解为较小的文件进行分析。有许多方法可以对流量进行细分或子集化，包括按 IP 地址、端口号、协议或特定流进行子集化。

我们可以一起研究使用`bigFlows.pcap`拆分一个大文件的方法，位于这里:[http://tcpreplay . app neta . com/wiki/captures . html # big flows-pcap](http://tcpreplay.appneta.com/wiki/captures.html#bigflows-pcap)。在那里，下载文件并在 Wireshark 中打开它，这样您就可以跟着做了。

当您打开`bigFlows.pcap`时，您可以很容易地看到处理一个大文件是多么麻烦，因为这个捕获有 791，615 个包。例如，即使进入一个简单的过滤器，仅显示**传输控制协议** ( **TCP** )流量，Wireshark 也需要时间来重新扫描捕获并显示数据。Wireshark 有一个状态栏，指示重新扫描捕获时的过程，如以下屏幕截图的左下角所示:

![Figure 18.1 – Rescanning the capture
](img/B18389_18_001.jpg)

图 18.1–重新扫描捕获

根据用于分析捕获的系统，它可能运行得非常慢，冻结，甚至关闭 Wireshark。

打开文件后，您需要计划要添加哪些数据。实现的方法有很多，真的要看你想分析什么了。在这一节中，我们将看看几种分解大型捕获的方法。首先，我们将研究如何使用一个**互联网协议** ( **IP** )地址来子集化流量。

## 通过 IP 地址剖析

分解大型捕获的一种方法是过滤特定的 IPv4 或 IPv6 地址，然后使用子集进行分析。例如，您怀疑某台特定主机导致了过多的突发流量。通过追踪特定 IP 地址的活动，您可以更好地解决问题。

让我们回顾一下如何缩小搜索范围。在任何大型捕获中，您很可能已经收集了许多 IP 地址。转到**统计**菜单的底部，在这里您会看到 **IPv4 统计**和 **IPv6 统计**的菜单选项，如以下截图所示:

![Figure 18.2 – IPv4 and IPv6 statistics
](img/B18389_18_002.jpg)

图 18.2–IP v4 和 IPv6 统计数据

对于 IPv4 或 IPv6，IP 统计有四种选择，包括:

*   **所有地址**:提供一个可排序的 IP 地址列表，如图所示:

![Figure 18.3 – Statistics: All Addresses
](img/B18389_18_003.jpg)

图 18.3–统计数据:所有地址

*   **目的地和端口**:这个报告显示了一个详细的列表，该列表分解了每个 IP 地址以及关于 TCP 和**用户数据报协议** ( **UDP** )的附加统计信息，如该屏幕截图所示:

![Figure 18.4 – Statistics: Destinations and Ports
](img/B18389_18_004.jpg)

图 18.4–统计数据:目的地和端口

*   **IP 协议类型**:该报表按照 IP 头后面的协议进行细分，可以是`TCP`、`UDP`或`NONE`，如图所示:

![Figure 18.5 – Statistics: IP Protocol Types
](img/B18389_18_005.jpg)

图 18.5–统计数据:IP 协议类型

*   **源和目的地地址**:根据源和目的地 IP 地址分解所有地址。【T2![Figure 18.6 – Statistics: IP Protocol Types
    ](img/B18389_18_006.jpg)

图 18.6–统计数据:IP 协议类型

所有过滤器都有附加信息，如**计数**和**突发率**，以及过滤和排序的能力。此外，您可以选择**另存为...**以多种文件类型保存任何统计数据，如下所示:

![Figure 18.7 – Statistics: Save as
](img/B18389_18_007.jpg)

图 18.7–统计数据:另存为

虽然按 IP 地址划分流量子集可能有助于锁定有问题的主机，但另一种分解大规模捕获的方法是使用会话。

## 通过对话缩小范围

对话是两个相互通信的端点。在大型捕获中，您很可能会有许多对话。要查看列表，进入**统计**菜单，选择**对话**，如图所示:

![Figure 18.8 – Displaying all conversations 
](img/B18389_18_008.jpg)

图 18.8–显示所有对话

进入**对话**对话框后，我们可以按列进行排序，以确定最大流量者，这是交换最多数据的两个端点。我们还可以选择两个已知端点之间的对话，比如一个**IP 语音** ( **VoIP** )客户端和服务器交换数据。一旦确定，我们就可以使用这些数据来创建图表和流程图进行分析。

在窗口中，您会看到顶部的选项卡，允许您查看特定类型的对话，如**以太网**、 **IPv4** 、 **TCP** 和 **UDP** 。选择一个对话，如`172.16.133.95`和`157.56.240.102`之间的对话。选择后，您可以过滤结果，以便只看到您希望用作子集的流量，如以下屏幕截图所示:

![Figure 18.9 – Conversations: Filter options
](img/B18389_18_009.jpg)

图 18.9–对话:过滤器选项

在一次捕获中，可能会有多次对话。虽然您可能会发现通过对话设置大型捕获的子集很有帮助，但有时您可能会希望专注于特定的*端口*并将其用作您的子集。下一节说明了如何通过端口号进行过滤，以便处理生成的较小文件。

## 按端口号最小化

虽然按 IP 地址或会话划分子集可能会有所帮助，但有时您可能想研究一个特定的端口。您可能会在 **TCP** 或 **UDP** 标签下浏览对话，并识别可疑的端口使用。或者您可能希望在检查突发流量时进一步调查多播流中使用的特定端口。

按端口号划分子集有很多原因。在 Wireshark 中，您可以在几个区域找到 UDP/TCP 端口列表，包括以下内容:

*   **对话**
*   **终点**
*   **IPv4 或 IPv6 目的地和端口**
*   **UDP 组播流**

例如，返回`bigFlows.pcap`，然后进入**统计**，然后进入 **UDP 组播流**，如图所示:

![Figure 18.10 – UDP Multicast Streams
](img/B18389_18_010.jpg)

图 18.10–UDP 多播流

运行报告后，您可以隔离想要分析的端口，应用过滤器，并只选择想要用作子集的流量。

剖析大型捕获的另一种方法是根据特定协议进行过滤。让我们来看看。

## 按协议分解

Wireshark 能够解析数百个协议。要查看列表，请转到**统计**，然后转到**协议层次**，这将提供在捕获中出现的协议列表。与许多其他选项一样，在**协议层次统计**中，您可以应用过滤器并创建您的子集，如以下截图所示:

![Figure 18.11 – Protocol Hierarchy: Apply as Filter
](img/B18389_18_011.jpg)

图 18.11–协议层次结构:作为过滤器应用

此外，如果您知道要查看的协议，您可以使用显示过滤器，输入特定的协议，并将其用作子集。

分析流量的一种常见方法是检查特定的流量。在最后一部分，我们将看到通过使用“跟随流”功能可以查看哪些捕获元素。

## 按流子集化

有时，您可能只想查看单个流量流的详细信息。在 Wireshark 中，一种简单的方法是使用 follow the stream 选项。

您必须首先选择 TCP 或 UDP 对话，右键单击并选择**跟随**，然后选择适当的流，如 TCP、UDP、TLS 或 HTTP。

对于我们的例子，我们将使用`bigFlows.pcap`。在显示过滤器中，输入`tcp.stream eq 946`。过滤需要一段时间。完成后，您将看到通信流的内容，这是一个网页，如下面的屏幕截图所示:

![Figure 18.12 – Follow TCP Stream 946
](img/B18389_18_012.jpg)

图 18.12–跟随 TCP 流 946

现在，我们已经通过使用前面的任何方法对流量进行子集化，将文件减小到更易于管理的大小，下一步是以某种方式保存文件。您可以将文件保存为默认的`.pcapng`格式，或者保存为近年来增加和增强的许多其他格式中的一种。

使用 Wireshark，有许多方法可以将文件子集化到更实用的大小。在您子集化了捕获之后，您很可能想要保存文件以保存您的工作。以下部分提供了在 Wireshark 中保存文件的各种方法。

# 了解保存文件的选项

每当您运行并停止捕获时，Wireshark 会将捕获保存在一个临时文件中。Wireshark 将在界面左下方的**状态栏**中显示临时文件名。此外，在顶部，您将看到捕获中使用的接口名称和一个星号，如下面的屏幕截图所示:

![Figure 18.13 – Temporary file in Wireshark
](img/B18389_18_013.jpg)

图 18.13–Wireshark 中的临时文件

在某些时候，您很可能想要保存文件。要保存文件，进入**文件**菜单选择，然后点击**保存**。保存文件后，文件名将出现在 Wireshark 界面的顶部，如以下屏幕截图所示:

![Figure 18.14 – File saved in Wireshark
](img/B18389_18_014.jpg)

图 18.14–保存在 Wireshark 中的文件

当你进入**文件**，然后**保存**时，你会发现 Wireshark 允许你以多种不同的格式保存捕获文件，如下所述。

## 使用另存为

**文件**菜单选择有很多处理文件的常用选项，比如**打开**、**导入**、**保存**、**打印**、**导出**。当您需要将文件保存为除默认扩展名`.pcapng`之外的其他文件时，一个选项是使用**另存为**。

当你准备好保存文件时，进入**文件**菜单选择**另存为**，会打开一个对话框，如下图所示:

![Figure 18.15 – The Save Capture File As dialog box 
](img/B18389_18_015.jpg)

图 18.15–将捕获文件另存为对话框

多年来，开发人员已经向 Wireshark 添加了许多不同的文件格式。因此，当您点击**另存为类型**下拉菜单时，您将看到所有支持的文件格式列表。以下屏幕截图显示了可用格式的部分列表:

![Figure 18.16 – Partial list of Save as selections 
](img/B18389_18_016.jpg)

图 18.16–另存为选择的部分列表

一些可用的格式包括微软 NetMon ( `.cap`)、Novell LANalyzer ( `.tr1`)、Sniffer (Windows: `.caz`)和 K12 文本文件(`.txt`)。虽然有些格式是遗留的，可能永远不会被使用，但知道您有多种选择还是很好的。

**另存为**菜单选项的一个常见用途是以一种格式打开文件，然后以另一种格式保存。一个例子是获得一个扩展名为`.pcap`的文件。虽然您可以用一个`.pcap`文件做很多事情，但是这种格式是有限制的。例如，当分析一个`.pcap`格式的文件时，您不能保存任何注释。如果您添加了任何注释，当您关闭文件时，Wireshark 会提示您另存为`.pcapng`，如果您想保留您的注释。

因此，在大多数情况下，另存为`.pcapng`是一个更好的选择，因为这种格式有几个增强，能够更好地剖析和显示有效载荷。

虽然存储整个文件很常见，但您可能只想导出文件的一部分。下一节将介绍导出特定包的各种方法，以及捕获文件中的各种对象，比如图像或网页。

# 识别导出组件的方式

我们讨论了许多方法，您可以对捕获进行子集化，以将文件减小到更实际的大小，例如通过 IP 地址、端口号或流。另一种选择是将子集导出为指定的数据包或数据包解析，甚至导出捕获中存在的各种对象。

让我们看看 Wireshark 提供的许多导出选项，从指定的数据包开始。

## 选择指定的数据包

过滤捕获后，您可能希望导出捕获的一部分。使用 Wireshark，您可以非常具体地选择要导出的内容。让我们看一个例子。

返回到`bigFlows.pcap`捕获，并在显示过滤器中输入`tcp.stream eq 946`。一旦运行了过滤器，就可以保留这个子集了。在这种情况下，我们将进入**文件**菜单选择然后选择**导出指定数据包**。打开后，您会看到有几种导出文件组件的方法，如下面的屏幕截图所示:

![Figure 18.17 – Export Specified Packets
](img/B18389_18_017.jpg)

图 18.17–导出指定的数据包

在对话框底部附近，您会看到一个名为**数据包范围**的标题，您可以在其中进行选择。如果您已经过滤了捕获，Wireshark 将假设您想要仅导出*显示的*数据包，并且**显示的**的单选按钮将被激活。然而，如果你想导出*所有的*数据包，选择**捕获的**。

在此之下，您将看到您想要的数据包范围的其他选项。这些选项包括以下内容:

*   **所有数据包**:这将导出所有数据包。Wireshark 将显示有多少**被抓获**或**被显示**。
*   **仅选定的数据包**:仅导出选定的数据包。在大多数情况下，您会将光标放在其中一个数据包上，因此 Wireshark 会认为您已经选择了该数据包。这也是为什么在*图 18.17* 中，Wireshark 只在**选择包**选项中显示一个( **1** )包的原因。
*   **仅标记数据包**:标记数据包允许您右击并标记感兴趣的一个或多个指定数据包，使数据包变黑。选择此选项时，Wireshark 将只处理标记的数据包。
*   **第一个到最后一个标记**:如果您在捕获中标记了几个数据包，Wireshark 将导出所有标记的数据包，从第一个到最后一个。
*   **范围**:这将允许您指定数据包范围。例如，如果您输入`233-799`，Wireshark 将只导出该范围。
*   **删除忽略的数据包**:如果在捕获中您忽略了某些数据包(参见 [*第 4 章*](B18389_04_ePub.xhtml#_idTextAnchor077) 、*探索 Wireshark 接口*，在*标记或忽略数据包*部分下)并且您选择了此选项，Wireshark 将不会在导出中包含忽略的数据包。

TCP 流`946`是从一个旅游网站获取的网页，因此我们将该文件命名为`Web Page`。当导出时，您将需要强制文件格式为`.pcapng`，因为 Wireshark 将默认为原始文件格式，对于`bigFlows.pcap`为`.pcap`。要仅导出 TCP 流`946`，请遵循以下步骤:

1.  进入**文件选择**菜单然后点击**导出指定数据包**。
2.  保持默认值不变，如图*图 18.17* 所示。
3.  选择保存文件的位置。
4.  在**文件名**中，输入`Web Page`。
5.  在**另存为类型**的下拉菜单下，选择**Wireshark/…–PCA png**。

一旦导出完成，关闭`bigFlows.pcap`，然后打开新创建的文件:`Web Page.pcapng`。

在**文件的**菜单选项中，我们还会发现**的导出**，其中包括几个选项。选项包括导出特定包或字节、TLS 会话密钥和其他对象的能力，如下所述。

## 导出各种对象

使用捕获时，文件中可能有各种对象。Wireshark 重新组装对象，只要对象是未加密的，就可以收集和分析这些对象。

您可能需要在捕获文件中收集对象有几个原因。例如，在主动恶意软件调查期间，您可能需要查看正在传输的文件类型。或者可能有人担心某个人可能会将敏感信息发送到组织之外。Wireshark 使导出对象变得容易，这样您就可以更仔细地查看通过网络发送的流量类型。

可以导出的一些可能对象包括以下协议中确定的对象:

*   **医学数字成像与通信** ( **DICOM** )
*   **超文本传输协议** ( **HTTP** )
*   **互联网报文格式** ( **IMF** )
*   **服务器消息块** ( **中小企业**)
*   **琐碎的文件传输协议** ( **TFTP** )

如果您怀疑前面的任何协议包含对象，您可以通过进入**文件**菜单选项，然后选择**导出对象**来导出它们进行检查，如下面的屏幕截图所示:

![Figure 18.18 – Export Objects
](img/B18389_18_018.jpg)

图 18.18-导出对象

例如，打开`bigFlows.pcap`文件。打开后，选择**导出对象**，然后选择 **HTTP...**。Wireshark 将定位所有对象，如**文本/css** 、**应用/javascript** 、图像和**文本/html** 。这将需要几秒钟的时间，取决于文件的大小。Wireshark 将显示一个列表，如下所示:

![Figure 18.19 – HTTP object list
](img/B18389_18_019.jpg)

图 18.19–HTTP 对象列表

在对话框中，您可以搜索文本字符串。在左下角，你会看到一个**文本过滤器**标签。输入`footstesp-to-the-summit.jpg`【原文如此】，完全如以下截图所示:

![Figure 18.20 – Searching footstesp-to-the-summit.jpg
](img/B18389_18_020.jpg)

图 18.20-搜索 footstesp-to-the-summit.jpg

选择**保存**，当对话框打开时，输入文件名和适当的扩展名。在这种情况下，我使用了`footstesp-to-the-summit.jpg`。保存对象后，您可以定位、打开和查看图像。

如果还有其他感兴趣的对象，您也可以单独保存它们。或者，您可以选择**保存所有**，Wireshark 将保存文件中找到的所有对象。

显然，Wireshark 提供了许多保存和导出组件和对象的方法。但是当你处理完一个文件后会发生什么呢？

在进行分析时，您可能知道为什么要进行特定的捕获。然而，当您返回到文件时，您可能不记得是什么导致您首先查看该捕获。此外，如果您与同事共享该文件，他们可能无法识别该文件为何如此重要。在这两种情况下，最好通过添加注释来确定关键元素和关注点。

为了保留文件重要的原因，Wireshark 提供了添加注释的方法，如下一节所述。

# 确定添加评论的原因和方式

当使用跟踪文件时，您可能需要对单个数据包或整个捕获做一个记录，以供将来参考。

Wireshark 在处理注释时有选项。您可以添加注释来保存整个捕获或单个数据包的详细信息，如下所述。

## 提供文件和数据包注释

在 Wireshark 中，您可以对整个捕获进行注释，以记录您在文件中发现的内容。你可以保存这些信息，或者是为你自己保存，或者是在团队工作时与他人分享。让我们看一个使用`Web Page.pcapng`子集添加注释的例子。

要向文件添加注释，您可以执行以下操作之一:

*   选择左下角的注释图标，它看起来像一个便笺簿和铅笔。
*   进入**统计** | **采集文件属性**，在**采集文件评论**下方的空白处填写您的评论。

比如在我的`Web Page.pcapng`文件里，我去**统计** | **抓取文件属性**，输入评论`HTTP traffic with interesting images`。然后我点击了**保存评论**，如下图所示:

![Figure 18.21 – Capture file comments
](img/B18389_18_021.jpg)

图 18.21–捕获文件注释

请记住，添加注释时，Wireshark 不会突出显示拼写错误。因此，如果您希望文件中的注释看起来更专业，请花时间检查您的拼写。

向整个文件添加注释非常方便。然而，有时您可能希望在文件中保存您感兴趣的一个或多个包的细节。向单个数据包添加注释类似于向整个文件添加注释。但是，在*单个数据包*中，进入**编辑**菜单选项，选择**数据包注释**，如以下截图所示:

![Figure 18.22 – Packet Comments selection
](img/B18389_18_022.jpg)

图 18.22–数据包注释选择

Wireshark 将打开一个表单，您可以在其中添加评论。如果您想在以后添加更多评论，只需选择同一个数据包，然后重复添加原始评论的步骤。

此外，您可以通过进入**编辑**菜单选择**删除所有数据包评论**来删除所有数据包评论，如图*图 18.22* 所示。

添加或编辑注释后，您需要保存它们，以便以后查看，如下所述。

## 保存和查看评论

一旦您完成了对整个文件或单个数据包的添加注释，您会看到文件名在名称的前面有一个星号*，如 Wireshark 界面顶部所示:*

![Figure 18.23 – Filename with an asterisk
](img/B18389_18_023.jpg)

图 18.23–带星号的文件名

星号提醒您已经修改了捕获。当您关闭捕获时，Wireshark 会提示您保存修改后的文件。需要注意的是，使用注释时必须保存为`.pcapng`格式。

一旦保存，有几种方法可以查看评论:

*   要查看对*文件*的评论，请进入**统计** | **捕获文件属性**。这将打开一个对话框，如图*图 18.21* 所示。
*   要查看*单个数据包*的评论，请转到**专家信息**并选择控制台右下方的**显示评论**。然后，您将看到列出的注释，如下所示:

![Figure 18.24 – Expert Information: show comments
](img/B18389_18_024.jpg)

图 18.24-专家信息:显示注释

显然，向整个捕获或单个数据包添加评论是很容易的，这样您或您的团队可以在以后查看评论。

# 总结

在这一章中，我们发现了如何把一个大的、难以管理的文件变成一个更小的、更易于管理的文件。一旦缩小，我们就可以与同事分享文件或保存捕获供将来参考。您了解了对流量进行子集划分的许多方法，包括按 IP 地址、会话、端口号或流进行过滤。我们发现，在处理数据包捕获后，Wireshark 中有许多选项和格式可用于保存捕获。此外，您现在知道了导出文件、对象、会话密钥和包字节的许多方法。最后，为了保留文件重要的原因，我们发现了如何向单个数据包或整个捕获添加注释。

在下一章中，我们将首先发现 **Statistics** 菜单在分析捕获文件时可以帮助我们的许多方式。我们还将学习如何创建基本的 I/O 图来帮助可视化网络问题，例如掉线、丢帧和重复确认。然后，我们将看看在使用 I/O 图时，可以修改设置和其他选项的方法。我们将通过比较不同的 TCP 流图如何提供流的可视化表示来进行总结。

# 问题

现在，是时候检查你的知识了。选择最佳答案，然后将您的答案与*评估*附录中的答案进行核对:

1.  Wireshark 中的 _____ 表示相互通信的两个端点。
    1.  赛末点
    2.  元组
    3.  会话
    4.  过滤器
2.  Wireshark 能够解析数百个协议。要查看给定捕获中出现的所有协议的列表，请转到 **Statistics** ，然后转到 _____。
    1.  **协议层级**
    2.  **对话**
    3.  **IPv4 统计数据**
    4.  **赛点**
3.  目前，当您保存文件时，Wireshark 中的默认文件格式是 _____。
    1.  `snoop.gz`
    2.  `.pcapng`
    3.  `.pcap`
    4.  `erf.gz`
4.  处理数据包时，右键单击指定的数据包或感兴趣的数据包，并选择 _____，这将使选定的数据包变黑。
    1.  **忽略**
    2.  **探听**
    3.  **飞溅**
    4.  **标记**
5.  当您选择**导出对象** _____，Wireshark 将定位并包含所有包含**应用/javascript** 、图像和**文本/html** 的对象，然后显示找到的对象列表。
    1.  **DNS**
    2.  **DICOM**
    3.  **HTTP**
    4.  **中小企业**
6.  在保存已运行的捕获之前，您会在界面顶部看到捕获中使用的界面名称和一个(n)_ _ _ _ _ _ _。
    1.  `.temp`扩展
    2.  铅笔图标
    3.  长破折号
    4.  星号
7.  要为整个捕获文件添加注释，您可以进入 _____ 菜单选项，然后选择**捕获文件属性**，并在**捕获文件注释**下方的空白处添加您的注释。
    1.  **统计数据**
    2.  **视图**
    3.  **编辑**
    4.  **文件**