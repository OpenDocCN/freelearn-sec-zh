# 第一章：基于目标的渗透测试

新冠疫情改变了世界的运作方式。各类组织纷纷将工作方式从没有或部分远程工作转变为全员采用这种工作方式。在这种*新常态*下，远程技术对工作和个人生活变得至关重要。我们可以毫不犹豫地称之为*虚拟世界*，过去在封闭空间中进行的机密活动，现在都转移到了互联网中。这显著增加了至少五倍的网络威胁数量。威胁行为者利用这种数字化转型，利用用户和公司犯下的错误作为其进入点，进行财务收益、声誉损害或其他任何目的。此类活动表现为勒索软件、网络钓鱼和数据泄露。

为了理解当前和未来的工作方式，让我们从探讨威胁行为者的不同目标开始。本章将讨论不同类型的威胁行为者及其基于目标的渗透测试的重要性；我们还会探讨误解以及没有目标的漏洞扫描、渗透测试和红队演练如何失败。本章还提供了安全测试概述，并设置了验证实验室，重点介绍定制 Kali 以支持渗透测试中的一些高级方面。通过本章学习，你将覆盖以下内容：

+   不同类型的威胁行为者

+   安全测试概述

+   漏洞扫描、渗透测试和红队演练的误解

+   Kali Linux 的历史与目的

+   更新和组织 Kali

+   在各种服务上安装 Kali（亚马逊 Web 服务/谷歌云平台/安卓）

+   设置明确的目标

+   构建验证实验室

让我们从那些利用技术基础设施的威胁行为者类型开始。

# 不同类型的威胁行为者

威胁行为者指的是对影响另一个实体的事件或事故负责的个体或实体。了解不同类型的威胁行为者及其常见动机非常重要，这将帮助我们在本书中理解不同的视角。*表 1.1* 提供了常见的威胁行为者、他们的动机和典型目标。

| **威胁行为者** | **常见动机** | **目标** |
| --- | --- | --- |
| 国家或政府资助的行为者 | 军事、政治和技术议程 | 网络间谍活动、数据盗窃或任何其他国家为其经济利益而感兴趣的活动 |
| 有组织犯罪或网络犯罪分子 | 财务收益和利润 | 资金和有价值的数据 |
| 黑客活动分子/网络极端分子 | 动机重叠 | 关注曝光秘密和破坏他们认为对社会不利的服务/组织（黑客活动分子）；关注造成伤害和破坏，以推动他们的事业（极端分子） |
| 内部人员 | 报复 | 金钱或数据勒索或造成收入损失 |

表 1.1：各种威胁行为者及其动机

我们现在已经总结了四种主要的威胁行为者及其动机，可以在基于目标的渗透测试和红队演习中使用它们，以模拟真实的威胁场景。

# 安全测试的概念概览

现在我们已经了解了不同的威胁行为者；接下来，让我们理解一下*组织究竟在保护什么，且是为了防范谁？* 如果你问 100 位安全顾问*什么是安全测试？*，很可能你会收到 100 个不同的回答。

安全测试最简单的形式是一个过程，用来确认任何信息资产或系统是受到保护的，并且其功能按预期保持不变。

# 漏洞评估、渗透测试和红队演习的常见陷阱

在这一部分，我们将讨论一些关于传统/经典漏洞扫描、渗透测试和红队演习的误解和局限性。接下来，让我们用简单的术语来理解这三者的实际含义及其局限性：

+   **漏洞评估** **(VA)**：通过漏洞扫描仪识别系统或网络中的漏洞或安全漏洞的过程。关于 VA 的一个误解是，它能够帮助你找到所有已知的漏洞；但这并不正确。VA 的局限性在于，它只能找到潜在的漏洞，并且完全取决于你使用的扫描器类型。它也可能包含许多误报，而且对于企业所有者来说，无法明确指出哪些漏洞不构成实际风险，哪些漏洞会被攻击者用来获取访问权限。VA 的最大陷阱是漏报，也就是扫描器没有发现系统或应用程序存在的问题。

+   **渗透测试** **(pentesting)**：通过利用漏洞安全地模拟黑客场景的过程，对现有网络或业务的影响较小。由于测试人员会验证漏洞并尝试利用它们，因此假阳性较少。渗透测试的一个局限性是它仅使用当前已知的、公开的漏洞；这些漏洞大多专注于项目测试。我们经常在评估过程中听到渗透测试人员说，*太棒了！获得 Root 权限了*——但我们从不听到这样的问题，*你能用它做什么？* 这可能是由于各种原因，如项目限制，包括将高风险问题立即报告给客户，或者客户只对网络的某一部分感兴趣，并且只希望测试该部分。

    关于渗透测试的一个误解是，它为攻击者提供了网络的完整视图，并且一旦渗透测试完成，你就可以放心了。但当攻击者发现你的安全应用程序中的业务流程漏洞时，情况并非如此。

+   **红队演习** **(RTE)**：一种集中评估组织防御网络威胁和通过任何可能手段提高安全性的有效性过程；在 RTE 期间，我们可以发现多种实现项目目标/场景和目标的方法，如通过定义的项目目标对活动的全面覆盖，包括网络钓鱼（诱使受害者通过电子邮件输入敏感信息或下载恶意内容）、语音钓鱼（通过电话诱使受害者提供或做出某些有恶意意图的行为）、“WhatsApp 钓鱼”（通过 WhatsApp 信息与受害者进行恶意互动）、无线、磁盘投放（USB 和 SSD）和物理渗透测试。RTE 的限制是受时间限制、预定义场景和假设环境的约束。通常，RTE 会在每种技术的全程监控模式下运行，战术按程序执行，但当真正的攻击者想要实现目标时，情况并非如此。

*图 1.1* 展示了三种活动在关注的广度和深度上的差异：

![](img/B17765_01_01.png)

图 1.1：三种评估系统脆弱性的方法及其成功的广度和深度

通常，三种不同的测试方法都涉及到 *黑客* 或 *破坏* 这个术语。我们将黑进你的网络，告诉你哪里存在弱点；但是等一下，客户或业务负责人能理解这些术语之间的区别吗？我们如何衡量它？标准是什么？我们什么时候知道黑客攻击或破坏已经完成？所有这些问题都指向一个问题：测试的目的是什么，主要目标是什么。

# 目标导向渗透测试

渗透测试/红队评估（RTE）的主要目标是确定实际风险，将扫描器的风险评级与实际风险区分开，并为每个资产提供一个风险值，同时评估组织品牌形象的风险。这不仅仅是关于他们有多少风险，而是他们暴露在多少风险中以及这些暴露有多容易被利用。

已经发现的威胁不一定构成风险，也无需进行演示；例如，**跨站脚本攻击**（**XSS**）是一种脚本注入漏洞，能够窃取用户的凭据。如果一个经营交易公司的客户有一个提供静态内容的宣传网站，且该网站存在 XSS 漏洞，这可能对业务的影响不大。在这种情况下，客户可能会接受风险，并通过使用**Web 应用防火墙**（**WAF**）来防止 XSS 攻击。然而，如果同样的漏洞出现在他们的主要交易网站上，那么这将是一个需要尽快修复的重大问题，因为公司面临着由于攻击者窃取用户凭据而失去客户信任的风险。

基于目标的渗透测试是时间驱动的，取决于组织所面临的具体问题。一个目标的例子是：*我们最担心的是我们的数据被盗，以及因此产生的监管罚款*。因此，目标现在是通过利用系统漏洞或通过钓鱼攻击操纵员工来获取数据；有时，当看到一些他们的数据已经出现在暗网上时，可能会感到惊讶。每个目标都有自己的**战术、技术和程序**（**TTP**），这些将支持渗透测试活动的主要目标。在本书中，我们将使用 Kali Linux 2021.4 探索所有这些不同的方法论。

# 测试方法论

方法论很少考虑渗透测试的原因，或者哪些数据对于业务至关重要，必须加以保护。如果没有这个关键的第一步，渗透测试将失去焦点。

许多渗透测试员不愿意遵循定义好的方法论，担心这会妨碍他们在网络或应用程序中利用安全漏洞时的创造性。渗透测试无法真实反映恶意攻击者的实际活动。客户经常希望看到你是否能够获得某一系统的管理员访问权限（也就是说，*你能获得系统的根权限吗？*）。然而，攻击者可能专注于以不需要根权限或不会造成服务拒绝的方式复制关键信息。

为了应对正式测试方法论固有的局限性，必须将其整合到一个框架中，从攻击者的视角来看待网络，这被称为**网络** **杀链**。

2009 年，洛克希德·马丁公司的 Mike Cloppert 提出了如今被称为网络攻击链的概念。它包括对手在攻击网络时采取的步骤。它并不总是按线性流程进行，因为一些步骤可能是并行发生的。针对同一目标可能会在不同时间发起多个攻击，并且可能会出现重叠阶段。

在本书中，我们修改了 Cloppert 的网络攻击链，以更准确地反映攻击者在利用网络、应用程序和数据服务时如何应用这些步骤。*图 1.2* 显示了攻击者的典型网络攻击链：

![](img/B17765_01_02.png)

图 1.2：攻击者可能遵循的典型网络攻击链

攻击者的典型网络攻击链可以描述如下：

+   **探索或侦察阶段**：大多数军事组织采用的格言是，*侦察时间从不浪费*，这表明在与敌人交战之前，尽可能多地了解敌人是更好的。出于同样的原因，攻击者会在攻击之前对目标进行广泛的侦察。事实上，据估计，渗透测试或攻击的至少 70% 努力都用于侦察！通常，他们会采用两种类型的侦察：

    +   **被动**：没有与目标进行直接的敌对互动。例如，攻击者会审查公开可用的网站，评估在线媒体（尤其是社交媒体网站），并尝试确定目标的**攻击面**。其中一个具体任务是生成过去和当前员工的名单，甚至对公开可用的被攻破数据库进行调查。

        这些名字将成为使用暴力破解密码的尝试基础。它们还会在社交工程攻击中被使用。这种类型的侦察很难，甚至几乎不可能，与普通用户的行为区分开来。

    +   **主动**：目标可以检测到这一行为，但很难将其与大多数在线组织从常规流量中遇到的其他活动区分开来。在主动侦察阶段发生的活动包括对目标场所的实地访问、端口扫描和远程漏洞扫描。

+   **交付阶段**：交付是选择和开发在攻击过程中用于完成漏洞利用的武器。所选择的具体武器将取决于攻击者的意图以及交付路线（例如，通过网络、无线连接或基于 Web 的服务）。交付阶段的影响将在本书的后半部分详细讨论。

+   **利用或破坏阶段**：这是一个特定的漏洞被成功利用的阶段，允许攻击者在目标系统中站稳脚跟。破坏可能发生在单一阶段（例如，通过缓冲区溢出漏洞利用已知操作系统漏洞），也可能是多阶段的破坏（例如，攻击者可能会从 [`haveibeenpwned.com`](https://haveibeenpwned.com) 或类似网站下载互联网上的数据；这些网站通常包含泄露的数据，包括用户名、密码、电话号码和电子邮件地址，攻击者可以利用这些数据轻松创建密码字典，尝试访问 **软件即服务** **(SaaS)** 应用程序，如 Microsoft Office 365 或 Outlook Web，尝试直接登录企业 VPN，或使用电子邮件地址进行定向钓鱼攻击。攻击者甚至可能通过短信发送带有恶意链接的内容，进而传送恶意载荷）。多阶段攻击是恶意攻击者针对特定企业时的常见手段。

+   **达成阶段 – 执行目标**：这一阶段经常被错误地称为数据外泄阶段，因为人们倾向于把攻击视为单纯为了窃取敏感数据（如登录信息、个人信息和财务信息）。实际上，攻击者可能有不同的目标；例如，攻击者可能希望在竞争对手的系统中投放勒索软件包，以迫使客户转向他们自己的业务。因此，这一阶段必须关注攻击者可能采取的多种行动。最常见的攻击行为之一是攻击者试图提升其访问权限至最高级别（纵向升级），并尽可能多地攻破账户（横向升级）。

+   **达成阶段 – 持续性**：如果攻击网络或系统具有价值，那么如果能够保持持续访问，这个价值很可能会增加。这允许攻击者与被攻破的系统保持通信。从防御者的角度来看，这是网络杀伤链中通常最容易被检测到的部分。

网络杀伤链仅仅是攻击者在试图破坏网络或特定数据系统时的行为元模型。作为元模型，它可以结合任何专有的或商业的渗透测试方法。然而，与这些方法不同的是，网络杀伤链确保战略层面的重点，聚焦于攻击者如何接近网络。这一对攻击者活动的关注将指导本书的布局和内容。

# Kali Linux 功能介绍

**Kali Linux**（**Kali**）是 BackTrack 渗透测试平台的继任者，通常被视为用于保护数据和语音网络的渗透测试工具的事实标准包。它由 Offensive Security 的 Mati Aharoni 和 Devon Kearns 开发。该发行版主要用于渗透测试和数字取证。

在 **2021 年**，Kali 发布了四次更新。最新的滚动版本于 2021 年 12 月 9 日发布，内核为 5.14.0，桌面环境为 Xfce 4.16.3。此外，2021 年 12 月 23 日还发布了一个小版本更新，版本为 Kali 2021.4a。

该版本 Kali 的一些功能包括以下内容：

拥有超过 500 个先进的渗透测试、数据取证和防御工具。大多数旧的预安装工具已被删除，并由类似工具取代。它们提供广泛的无线支持，包含多个硬件和内核补丁，以支持一些无线攻击所需的包注入。*表 1.2* 提供了截至 2021 年 12 月工具按具体任务的详细分类：

| **工具类别** | **工具数量** |
| --- | --- |
| 信息收集 | 67 |
| 漏洞分析 | 27 |
| 无线攻击 | 54 |
| 网络应用 | 43 |
| 利用工具 | 21 |
| 取证工具 | 23 |
| 嗅探与欺骗 | 33 |
| 密码攻击 | 39 |
| 维持访问 | 17 |
| 逆向工程 | 11 |
| 硬件黑客 | 6 |
| 报告工具 | 10 |

表 1.2：可用工具的数量，按其使用的具体任务进行列出

Kali Linux 2021.4 的一些主要特点包括：

+   支持多种桌面环境，如 KDE、GNOME3、Xfce、MATE、e17、lxde 和 i3wm.021。

+   默认情况下，Kali Linux 拥有符合 Debian 标准的工具，并与 Debian 仓库同步，至少每日四次，使得更新包和应用安全修复更加简便。

+   提供安全的开发环境和 GPG 签名的包及仓库。

+   支持 ISO 定制，允许用户构建自己版本的定制 Kali，并仅包含有限的工具集，从而使其更加轻量。引导功能还执行全企业范围的网络安装，可以使用预种子文件自动化。

+   由于基于 ARM 的系统变得更加普及且价格更低，Kali Linux 支持 **ARMEL** 和 **ARMHF**，可以安装在如 rk3306 mk/ss808、Raspberry Pi、ODROID U2/X2、Samsung Chromebook、EfikaMX、Beaglebone Black、CuBox 和 Galaxy Note 10.1 等设备上。

+   Kali 仍然是一个免费的开源项目。最重要的是，它得到了活跃的在线社区的强力支持。

## Kali 在红队战术中的作用

虽然渗透测试人员可能更喜欢任何类型的操作系统来执行他们想要的操作，但使用 Kali Linux 可以节省大量时间，并避免需要寻找在其他操作系统中通常不可用的软件包。一些在红队演练中不容易注意到的 Kali Linux 优势包括：

+   一个单一的来源，可以攻击多种平台。

+   添加源和安装软件包及支持库非常快速（特别是那些在 Windows 上不可用的）。

+   使用 alien 工具，甚至可以安装 RPM 包。

Kali Linux 的目的是确保网络、云和应用程序基础设施的安全，并将所有工具捆绑在一个平台上，为渗透测试人员和取证分析师提供服务。

# 安装和更新 Kali Linux

在本书的前几版中，我们重点讲解了如何将 Kali Linux 安装到 VMware Player、VirtualBox、AWS 和使用 Docker 应用程序的 Raspberry Pi 上。在本节中，我们将介绍如何在这些相同平台上安装 Kali Linux，同时还包括 Google Cloud Platform 和非根安卓手机。

## 作为便携设备使用

将 Kali Linux 安装到便携设备上相当简单。在某些情况下，客户不允许在安全设施内使用外部笔记本电脑。在这些情况下，通常会由客户提供一台测试笔记本电脑给渗透测试人员进行扫描。通过便携设备运行 Kali Linux 在渗透测试或红队演练中具有更多优势：

+   它可以放入口袋中（如果是 USB 驱动器或移动设备的话）。

+   它可以在不对主机操作系统进行任何更改的情况下运行。

+   你可以自定义 Kali Linux 的构建，甚至使存储具备持久性。

将 USB 驱动器转化为便携版 Kali Linux 有三个简单步骤：

1.  从以下链接下载官方 Kali Linux 镜像：[`docs.kali.org/introduction/download-official-kali-linux-images`](http://docs.kali.org/introduction/download-official-kali-linux-images)

1.  我们将使用开源工具 Rufus 来创建可启动磁盘。Rufus 有助于创建和格式化可启动驱动器。下载最新版本的 Rufus：[`github.com/pbatard/rufus/releases/`](https://github.com/pbatard/rufus/releases/)

1.  以管理员身份打开 Rufus 可执行文件。将 USB 驱动器插入可用的 USB 端口。浏览到你下载映像的所在位置。你应该能看到 *图 1.3* 所显示的内容。选择正确的驱动器名称，然后点击 **开始**：![](img/B17765_01_03.png)

    图 1.3：运行 Rufus 将 Kali Linux 写入外部磁盘

安装完成后，关闭 Rufus 应用程序并安全地移除 USB 驱动器。Kali Linux 现在已准备好作为一个便携设备，可以插入任何笔记本电脑并启动。如果您计划在启动的实时磁盘上存储信息，请确保选择**持久化分区大小**，至少设置为 4 GB；然后在启动 Kali Linux 时选择**实时 USB 持久化**。如果您的主操作系统是 Linux，可以通过两个标准命令来实现：

```
sudo fdisk -l 
```

这将显示驱动器上所有已挂载的磁盘。`dd` 命令行工具执行转换和复制：

```
dd if=kali linux.iso of=/dev/nameofthedrive bs=512k 
```

`if` 用于输入文件，`of` 用于输出文件，`bs` 用于块大小。

## 在 Raspberry Pi 4 上安装 Kali

Raspberry Pi 是一种单板设备，结构紧凑，能够像功能齐全的计算机一样运行，且功能简约。这些设备在现场的 RTE 和渗透测试活动中非常有用。操作系统的基础从 SD 卡加载，就像普通计算机的硬盘一样。

您可以在一张高速 SD 卡上执行与上一节中概述的相同步骤，然后将其插入 Raspberry Pi。这样我们就可以无障碍地使用系统。如果安装成功，当从 Raspberry Pi 启动 Kali Linux 时，应该会出现以下屏幕。此次演示中使用的是 Raspberry Pi 4，并通过显示器访问 Pi 的操作系统：

![一张包含文字、显示器、电子设备和屏幕的图片 自动生成的描述](img/B17765_01_04.png)

图 1.4：成功在 Raspberry Pi 4 上安装 Kali Linux

## 在虚拟机上安装 Kali

在之前的版本中，我们讨论了如何将 Kali 安装到不同的虚拟化软件中。在这里，我们将做同样的事情，并简要介绍如何在这些设备上安装 Kali。

### VMware Workstation Player

VMware Workstation Player，前身为 VMware Player，个人使用免费，并且作为 VMware 的商业产品提供给企业使用，作为一种桌面应用程序，允许虚拟机在主操作系统内运行。该应用程序可以从[`www.vmware.com/uk/products/workstation-player/workstation-player-evaluation.html`](https://www.vmware.com/uk/products/workstation-player/workstation-player-evaluation.html)下载。

我们将使用版本 16.1。下载完安装程序后，根据您的主操作系统安装 VMware Player。如果安装完成，您应该看到类似于*图 1.5*中显示的屏幕：

![图形用户界面，应用程序，Word 自动生成的描述](img/B17765_01_05.png)

图 1.5：成功安装 VMware Workstation Player

在 VMware 上安装 Kali Linux 的下一步是点击**创建新的虚拟机**并选择**安装程序磁盘映像文件（iso）**。浏览到您已下载的 ISO 文件，然后点击**下一步**。现在，您可以输入自己喜欢的名称（例如，`HackBox`）并选择**自定义位置**，指定您想存储 VMware 映像的地方。点击**下一步**并指定磁盘容量。建议使用至少 2 GB 的 RAM，并且需要 15 GB 的磁盘空间来运行 Kali。点击**下一步**直到完成。

另一种方法是直接下载 VMware 映像：

[`www.offensive-security.com/kali-linux-vm-vmware-virtualbox-image-download/`](https://www.offensive-security.com/kali-linux-vm-vmware-virtualbox-image-download/)

打开 `.vmx` 文件并选择**我已复制它**。这应该会启动完全加载的 Kali Linux 在 VMware 中。您可以选择将 Kali Linux 安装为主机操作系统，或者作为实时映像运行。一旦所有安装步骤完成，您就可以毫无问题地从 VMware 启动 Kali Linux。*图 1.6* 显示的是应看到的界面：

![计算机屏幕截图  自动生成的描述，信心较低](img/B17765_01_06.png)

图 1.6：Kali Linux 成功安装在 VMware 上后的显示界面

### VirtualBox

与 VMware 工作站播放器类似，VirtualBox 是一个完全开源的虚拟机管理程序，它是一个免费的桌面应用程序，可以从主机操作系统运行任何虚拟机。此应用程序可以从[`www.virtualbox.org/wiki/Downloads`](https://www.virtualbox.org/wiki/Downloads)下载。

接下来，我们将在 VirtualBox 上安装 Kali。与 VMware 类似，我们只需执行已下载的可执行文件，直到成功安装 Oracle VirtualBox，如*图 1.7*所示：

![图形用户界面，文本，应用程序，电子邮件  自动生成的描述](img/B17765_01_07.png)

图 1.7：成功安装 VM VirtualBox 后显示的界面

在安装过程中，建议将 RAM 设置为至少 1 或 2 GB，并且创建虚拟硬盘时，最低应为 15 GB，以避免出现性能问题。完成最后一步后，您应该能够在 VirtualBox 中加载 Kali Linux，如*图 1.8*所示：

![](img/B17765_01_08.png)

图 1.8：Kali Linux 在 VM VirtualBox 中的显示

完成此步骤后，我们现在可以通过 VirtualBox 使用 Kali Linux。然而，我们将在后面的章节中探讨不同的网络选项，*实验室网络*。

## 安装到 Docker 设备

Docker 是一个开源项目，旨在自动化软件容器和应用程序的部署。Docker 还提供了在 Linux 或 Windows 上的操作系统级虚拟化的额外抽象和自动化层。

Docker 适用于 Windows、Mac、Linux 和 AWS。对于 Windows，可以从[`www.docker.com/get-started`](https://www.docker.com/get-started)下载 Docker。

Docker 安装后，使用以下命令运行 Kali Linux 应该是相当简单的：

```
sudo docker pull kalilinux/kali-rolling
sudo docker run -t -i kalilinux/kali-linux-docker /bin/bash 
```

这些命令可以在命令提示符（Windows）或终端（Linux 或 Mac）中执行，以确认安装是否成功。

我们应该能够直接从 Docker 运行 Kali Linux，如*图 1.9*所示。还要注意，Docker 使用基于容器的技术，它运行的是与操作系统其余部分隔离的进程，并且共享主机操作系统的内核。虽然 VirtualBox 环境并非基于容器的技术，但它虚拟化硬件并共享物理主机的硬件资源：

![图形用户界面 描述自动生成，具有中等置信度](img/B17765_01_09.png)图 1.9：使用 Docker 成功安装 Kali Linux

一旦 Kali Linux Docker 镜像下载完成，你可以通过在命令提示符或终端中运行`docker run --tty --interactive kalilinux/kali-rolling /bin/bash`来运行 Docker 镜像。你应该能看到与*图 1.10*所示相同的界面：

![计算机屏幕截图 描述自动生成，具有中等置信度](img/B17765_01_10.png)

图 1.10：成功运行 Kali Linux 来自 Docker

如果你的基础操作系统是 Windows 10，请确保在系统 BIOS 中启用 VT-X 以及**Hyper-V**。请注意，启用**Hyper-V**会禁用 VirtualBox，如*图 1.11*所示：

![](img/B17765_01_11.png)

图 1.11：安装 Docker 时显示的警告

读者应当注意，接下来的部分涉及使用商业服务，如 AWS 和 Google Cloud Platform，这可能会在使用过程中产生费用。建议读者在测试完成后，完全删除或终止实例。

## 在 AWS 云上的 Kali

**亚马逊网络服务**(**AWS**)将 Kali Linux 作为**亚马逊机器接口**(**AMI**)和**SaaS**的一部分提供。如今，大多数安全测试公司利用 AWS 进行渗透测试和更高效的钓鱼攻击。本节将介绍在 AWS 上启动 Kali Linux 的步骤。

首先，你需要拥有一个有效的 AWS 账户。你可以通过访问以下网址进行注册：[`console.aws.amazon.com/console/home`](https://console.aws.amazon.com/console/home)

登录到 AWS 账户时，我们应该能够看到所有的 AWS 服务。搜索 Kali Linux，接着应该会显示以下内容，如*图 1.12*所示。

此页面也可以通过以下链接访问：[`aws.amazon.com/marketplace/pp/prodview-fznsw3f7mq7to`](https://aws.amazon.com/marketplace/pp/prodview-fznsw3f7mq7to):

![图形用户界面，文本，网站 描述自动生成](img/B17765_01_12.png)

图 1.12：AWS Marketplace 中预配置的 Kali Linux

开源社区已将直接从 AWS Marketplace 启动预配置的 Kali Linux 2021.4 实例变得非常简单。接下来，我们将直接启动 Kali Linux，仅需几分钟：[`aws.amazon.com/marketplace/pp/prodview-fznsw3f7mq7to`](https://aws.amazon.com/marketplace/pp/prodview-fznsw3f7mq7to)。

按照说明操作；然后你应该能够通过选择**继续订阅**来启动 Kali 实例。如果尚未登录，这将带你到 AWS 的登录页面。点击**继续配置**，继续点击**继续启动**，你应该会到达*图 1.13*所示的页面。从**选择操作**中，选择**通过 EC2 启动**选项，同样在*图 1.13*中显示；最后，点击**启动**：

![](img/B17765_01_13.png)

图 1.13：选择通过 EC2 启动 Kali Linux 的方法

下一个屏幕将允许你选择**实例类型**；选择**t2.micro（符合免费套餐资格）**并点击**审查并启动**。最后，你应该会到达**审查实例启动**页面；点击**启动**。这将带你到一个可以创建新密钥对的页面，如*图 1.14*所示：

![](img/B17765_01_14.png)

图 1.14：创建新的密钥对以连接到 AWS 实例

如常，为了使用任何 AWS 虚拟机，必须创建自己的密钥对，以确保环境的安全。然后，你应该能够通过在命令行中输入以下命令登录。为了使用私钥免密登录，Amazon 强制要求文件权限进行隧道传输。我们将使用以下命令从终端连接到 Kali Linux 实例：

```
chmod 400 privatekey.pem
ssh -i privatekey.pem kali@PublicIPofAWS 
```

所有 Windows 用户可以通过运行以下命令，利用 Windows PowerShell 连接到实例：

```
ssh -i privatekey.pem kali@PublicIPofAWS 
```

*图 1.15* 展示了在 AWS 上成功使用 Kali：

![](img/B17765_01_15.png)

图 1.15：成功连接到 AWS 中的 Kali Linux 实例

必须满足所有条款和条件才能利用 AWS 进行渗透测试。在从云主机发起任何攻击之前，必须满足法律条款和条件。

## 在 Google Cloud Platform (GCP) 上的 Kali

与 AWS 不同，Google Cloud Marketplace 中没有现成的 Kali Linux 版本。因此，我们将采用不同的方法来启动 GCP 上的 Kali Linux。按照我们安装 Kali 在 VirtualBox 上的相同步骤，这次同样使用 12 GB 的硬盘空间和 2 GB 的内存。我们将利用本地镜像上传到 Google 存储桶，并通过计算引擎运行此实例。在此之前，我们必须确保在安装完成并登录 Kali Linux 后，启动 SSH 服务以使其保持持久，以下命令将在 Kali Linux 虚拟机的终端中运行：

```
sudo systemctl start ssh
sudo update-rc.d -f ssh enable 2 3 4 5
sudo reboot 
```

由于某些原因，GCP 不会部署启用了软盘的 VirtualBox 镜像，因此我们将通过选择 Kali，进入**设置**，然后选择**系统**，并取消选中**启动顺序**中的**软盘**来移除软盘，如*图 1.16*所示：

![](img/B17765_01_16.png)

图 1.16：启用软盘后，在启动顺序选项下，GCP 无法部署 VirtualBox 镜像

下一个重要步骤是确保我们的镜像能够连接到 GCP 的网络，获取 DHCP，并获得公共 IP 地址；因此，必须通过选择 Kali，进入**设置**，然后选择**网络**，点击**高级**并将**适配器类型**更改为**虚拟化网络**，如*图 1.17*所示：

![](img/B17765_01_17.png)

图 1.17：在 VirtualBox 中选择虚拟化网络

还建议移除音频功能，以避免兼容性问题；选择 Kali，进入**设置**，**音频**，然后取消选中**启用音频**，如*图 1.18*所示：

![](img/B17765_01_18.png)

图 1.18：在音频部分选择“启用音频”选项时，GCP 可能无法正常工作

现在我们必须将**虚拟磁盘镜像**（**VDI**）转换为 RAW 格式，并应用命名约定 `disk.raw`，以便 Google 的镜像自动化软件可以使用。

我们将利用通用的开源机器模拟器和虚拟化工具（QEMU）来转换 VDI 或 VMDK 文件为 RAW 格式。在接下来的步骤中，我们将转换 VDI 格式（类似的步骤也适用于 VMDK 文件）：

1.  导航到你保存磁盘镜像的 VirtualBox 位置。

1.  确保在本地系统中安装了 qemu-img：

    +   可以通过从[`www.qemu.org/download/#windows`](https://www.qemu.org/download/#windows)下载应用程序，在 Windows 中安装此工具

    +   可以通过运行命令`sudo apt install qemu-img`或`brew install qemu-img`在 Linux 或 macOS 系统中安装此工具

1.  要转换镜像，可以在相应的终端或命令提示符中运行以下命令：

    ```
    qemu-img convert –f vdi –O raw nameofthevm.vdi disk.raw 
    ```

1.  一旦创建了 `disk.raw` 文件，为了减少上传大小，我们将把原始磁盘压缩成 `tar.gz` 格式。然而，最好使用 `gtar`，因为 Google 强烈依赖此工具。对于 Windows 用户，这些工具并未预安装，但可以从[`gnuwin32.sourceforge.net/packages/gtar.htm`](http://gnuwin32.sourceforge.net/packages/gtar.htm)直接下载该工具。

    你可以通过在 Linux 和 macOS 系统上运行命令`gtar –cSzf kali.tar.gz disk.raw`或在 Windows 上运行`tar –zcvf kali.tar.gz disk.raw`来创建最终的 GCP 兼容镜像。

现在我们已经准备好将自己的镜像上传到 GCP。创建一个 GCP 账户或使用现有账户登录该服务。与 Microsoft 类似，GCP 也为用户提供了免费信用额度选项，供用户体验其云计算服务。启动 Kali Linux 在 GCP 上的步骤如下：

1.  登录到 [`console.cloud.google.com/`](https://console.cloud.google.com/)。

1.  导航到 **Cloud Storage** 并选择 **Browser**，然后点击 **Create a Bucket**。

1.  根据 GCP 的政策选择一个符合规范的桶名称（不允许大写字母）；在我们的例子中，我们创建了桶名称 `mastering-kali-linux-edition4`。

1.  点击 **Upload Files**，选择我们刚刚创建的压缩 `kali.tar.gz` 镜像。上传完成后，您应该能够看到与*图 1.19*中显示相同的屏幕：![](img/B17765_01_19.png)

    图 1.19：将压缩镜像上传到 GCP 后，将显示此屏幕

1.  返回到 **Home** 页面，选择 **Compute Engine**；在存储下选择 **Images**，然后点击 **Create Image**，并为镜像输入名称，在此情况下，我们输入了 `gcp-kali`。

1.  输入名称后，选择源为 **cloud storage file**，点击 **Bucket**，然后选择我们的压缩 gz 镜像（`kali.tar.gz`）。

1.  您可以选择任何您想运行的区域；我们选择了默认区域以供演示。点击 **Create**，这将带您到显示在*图 1.20*中的屏幕；如果没有看到该屏幕，请点击该屏幕上的 **REFRESH**：![](img/B17765_01_20.png)

    图 1.20：新创建的 gcp-kali 镜像在 GCP 镜像中显示

1.  镜像创建完成后，点击 **Actions** 和 **Create instance**，如*图 1.21*所示：![](img/B17765_01_21.png)

    图 1.21：成功创建我们的 gcp-kali 镜像，准备作为实例运行

1.  这将带我们进入虚拟机实例屏幕，以输入 Kali Linux 实例信息，如*图 1.22*所示：![](img/B17765_01_22.png)

    图 1.22：输入我们的 gcp-kali 实例详细信息并选择运行所需的资源

1.  我们现在可以选择 CPU（中央处理单元）平台和 GPU（图形处理单元）；我们将选择 `E2 medium`，它提供两个虚拟核心的 vCPU 和 4 GB 内存。我们的镜像包括我们在创建虚拟机时选择的存储（12 GB）。

1.  最后，确保启动磁盘保持不变—无需更改—然后点击 **Create**。这将带我们到最后一个屏幕，其中显示了内部和公共 IP 地址，如*图 1.23*所示：![](img/B17765_01_23.png)

    图 1.23：成功安装 Kali Linux 作为 GCP 中的实例，具有内部和外部 IP

1.  我们现在已经成功地在 GCP 上创建并运行了 Kali Linux 实例，现在可以使用在最初创建过程中设置的用户名和密码登录到公共 IP，如 *图 1.24* 所示：![](img/B17765_01_24.png)

    图 1.24：成功外部连接到 GCP 上的 Kali Linux 实例

# 在 Android 上运行 Kali（非 Root 手机）

通过 ARM 镜像的支持，可以直接从 Kali 网站下载 Nethunter 镜像；然而，在本节中我们将尝试不同的方法，在配置达到足够标准的任何 Android 设备上运行 Kali。

我们将使用来自受信任的 Google Play 商店的两个应用程序：

+   UserLAnd：这是一个开源应用，允许您在 Android 设备上运行多个 Linux 操作系统。您可以通过访问 [`play.google.com/store/apps/details?id=tech.ula&hl=en_GB&gl=US`](https://play.google.com/store/apps/details?id=tech.ula&hl=en_GB&gl=US) 在 Play 商店下载此应用。

+   ConnectBot：一款功能强大的开源 SSH 客户端，能够管理多个 SSH 会话，创建安全隧道，以及在其他应用之间进行复制/粘贴。此应用也可以直接通过 Play 商店下载，或者访问 [`play.google.com/store/apps/details?id=org.connectbot&hl=en_GB&gl=US`](https://play.google.com/store/apps/details?id=org.connectbot&hl=en_GB&gl=US) 进行下载。

下载 UserLAnd 后，您应该看到与 *图 1.25* 中相同的界面；选择 **Kali**：

![](img/B17765_01_25.png)

图 1.25：在 UserLAnd 移动应用中选择 Kali Linux

应用程序应该会要求输入您的用户名、密码和 Kali 的 VNC 密码进行登录。完成操作后，应该会弹出一个提示框，要求您选择连接机器人，如 *图 1.26* 所示：

![](img/B17765_01_26.png)

图 1.26：下载 Kali Linux 镜像后，您将获得两个选项；选择 ConnectBot

我们现在在手持 Android 设备上拥有一个轻量级的 Kali Linux 版本（您可能需要根据需要安装工具；例如，您可以通过运行 `sudo apt-get update && apt install routersploit` 来收集有关移动设备连接的路由器的信息）; 部分界面如 *图 1.27* 所示：

![](img/B17765_01_27.png)

图 1.27：在 Android 设备上成功安装 Kali Linux

我们现在已经看到如何在 Android 设备上安装并运行 Kali Linux，而无需对设备进行 root。设备上的 Kali Linux 版本在其自己的沙箱中运行；因此，我们可以自由地从设备上进行渗透测试。

# 组织 Kali Linux

安装只是开始；组织 Kali Linux 是一个非常重要的下一步。在本节中，我们将探讨如何通过自定义组织我们的 Kali Linux。

## 配置和自定义 Kali Linux

Kali 是一个用于进行渗透测试的框架。然而，测试者不应该仅仅依赖于默认安装的工具或 Kali 桌面的外观和感觉。通过定制 Kali，测试者可以提高收集的客户端数据的安全性，并使渗透测试更加方便。Kali 中常见的定制选项包括以下内容：

+   重置 Kali 密码

+   添加非 root 用户

+   配置网络服务和安全通信

+   调整网络代理设置

+   访问安全外壳

+   加速 Kali 操作

+   与 Microsoft Windows 共享文件夹

+   创建加密文件夹

现在让我们进一步查看这些选项。

## 重置默认密码

如果你下载了预配置的 VMware 或 VirtualBox 镜像，访问 Kali Linux 的默认用户名和密码是`kali`。建议更改默认密码；为此，请在 Kali Linux 终端中运行以下命令：

```
sudo passwd kali 
```

然后系统会提示你输入新密码，并再次确认。

## 配置网络服务和安全通信

确保能够访问内部网络的第一步是确保它能够连接到有线或无线网络，以支持更新和通信。你可能需要通过**动态主机配置协议**（**DHCP**）来获取 IP 地址，可以通过附加网络配置文件并添加以太网适配器，使用以下来自 Kali Linux 终端的命令形式：

```
# sudo nano /etc/network/interfaces
iface eth0 inet dhcp 
```

一旦网络配置文件被附加，你应该能够运行`ifup`脚本来自动分配 IP 地址，如*图 1.28*所示：

![](img/B17765_01_28.png)

图 1.28：通过 DHCP 使用 ifup 脚本成功分配 IP 地址

在静态 IP 的情况下，你可以在相同的网络配置文件中附加以下几行，并快速为你的 Kali Linux 版本设置静态 IP：

```
# nano /etc/network/interfaces
iface eth0 inet static
address <your address>
netmask <subnet mask>
broadcast <broadcast mask>
gateway <default gateway>
# nano /etc/resolv.conf
nameserver <your DNS ip> or <Google DNS (8.8.8.8)> 
```

默认情况下，Kali 启用了 DHCP 服务。这样会向网络宣布新的 IP 地址，这可能会提醒管理员测试者的存在。对于某些测试用例，这可能不是问题，并且在启动时自动启动某些服务可能是有利的。可以通过输入以下命令来实现：

```
update-rc.d networking defaults
/etc/init.d/networking restart 
```

Kali 安装时带有可根据需要启动或停止的网络服务，包括 DHCP、HTTP、SSH、TFTP 和 VNC 服务器。这些服务通常从命令行调用；然而，一些服务也可以从 Kali 菜单中访问。

## 调整网络代理设置

位于认证或未认证代理连接背后的用户必须修改`bash.bashrc`和`apt.conf`文件。这两个文件位于`/etc/`目录下。使用文本编辑器编辑`bash.bashrc`文件，如以下所示，在`bash.bashrc`文件的底部添加以下几行：

```
export ftp_proxy=ftp://username:password@proxyIP:port
export http_proxy=http://username:password@proxyIP:port
export https_proxy=https://username:password@proxyIP:port
export socks_proxy="https://username:password@proxyIP:port" 
```

将 `proxyIP` 和 `port` 替换为您的代理 IP 地址和端口号，分别将 `username` 和 `password` 替换为您的身份验证用户名和密码。如果不需要身份验证，只需写 `@` 符号后面的部分。保存并关闭文件。

## 远程访问安全外壳

为了在测试过程中尽量减少目标网络的检测，Kali 默认不启用任何外部监听网络服务。一些服务，如 SSH，已经安装。但是，它们在使用之前必须启用。Kali 默认配置了 SSH 密钥。启动 SSH 服务之前，最好禁用默认密钥并生成唯一的密钥集，代码如下所示。将默认的 SSH 密钥移动到备份文件夹，然后使用以下命令生成新的 SSH 密钥集：

```
sudo dpkg-reconfigure openssh-server 
```

要确认 SSH 服务是否正在运行，您可以使用命令 `sudo service ssh status` 来验证。

请注意，使用默认的 SSH 配置时，root 登录将被禁用。如果需要以 root 账户访问，您可能需要编辑 `/etc/ssh/sshd_config` 并将 `PermitRootLogin` 设置为 `yes`，然后保存并退出。最后，在同一网络上的任何系统上，您应该能够访问 SSH 服务并使用 Kali Linux。在本示例中，我们使用 PuTTY，这是一个免费的便携式 SSH 客户端，适用于 Windows。现在，您应该能够从另一台机器访问 Kali Linux，接受 SSH 证书并输入您的凭据。

## 提升 Kali 操作速度

有几个工具可以用来优化并加速 Kali 操作：

+   使用虚拟机时，安装其软件驱动程序包，选择 Guest Additions（VirtualBox）或 VMware Tools（VMware）。

    在安装之前，我们必须确保运行 `apt-get update`。

+   创建虚拟机时，选择一个固定磁盘大小，而不是动态分配的磁盘。将文件添加到固定磁盘更快，并且文件碎片较少。

+   默认情况下，Kali 不会显示启动菜单中所有的应用程序。启动过程中安装的每个应用程序都会拖慢系统数据，并可能影响内存使用和系统性能。可以通过以下命令在终端执行此操作：

    +   要列出启动时的所有服务，在终端输入 `sudo systemctl list-unit-files --type=service`，然后您可以通过运行 `sudo systemctl disable --now <nameoftheservice>` 来选择禁用不需要的服务。

    +   最后，您可以通过在终端运行 `sudo systemctl list-unit-files --type=service --state=enabled --all` 来列出已启用的服务。

## 与主机操作系统共享文件夹

Kali 工具集具有灵活性，可以与位于不同操作系统上的应用程序共享结果，特别是 Microsoft Windows。共享数据最有效的方法是创建一个文件夹，使宿主操作系统和 Kali Linux 虚拟机客户操作系统都能访问。当数据从宿主或虚拟机放入共享文件夹时，它会立即通过共享文件夹提供给所有访问该共享文件夹的系统。创建共享文件夹的步骤如下：

1.  在宿主操作系统上创建一个文件夹。在此示例中，文件夹名称为`kali_Share`。

1.  右键点击文件夹，选择**共享**选项卡。在该菜单中，选择**共享**。

1.  确保文件与**所有人**共享，并且此共享的**权限级别**设置为**读/写**。

1.  如果你还没有这样做，请分别在 Kali Linux 上安装 VMware 工具或 VirtualBox 客户端附加组件。

1.  安装完成后，进入 VMware 播放器菜单，选择**管理**，然后点击**虚拟机设置**。找到启用**共享文件夹**的菜单，选择**始终启用**。

1.  在 Oracle VirtualBox 的情况下，选择虚拟机并进入**设置**，然后选择**共享文件夹**，如*图 1.29*所示：![](img/B17765_01_29.png)

    图 1.29：从原始操作系统将共享驱动器挂载到客户操作系统

    请注意，旧版本的 VMware Player 使用的是不同的菜单。

1.  现在，文件夹应该会自动挂载到`/media/`文件夹中，如*图 1.30*所示：![](img/B17765_01_30.png)

    图 1.30：成功将共享驱动器挂载到 Kali Linux 虚拟机

1.  所有放入该文件夹的内容将在宿主操作系统中以相同名称的文件夹访问，反之亦然。

包含渗透测试敏感数据的共享文件夹必须加密，以保护客户的网络，并减少在数据丢失或被盗时对测试人员的责任。

## 使用 Bash 脚本定制 Kali

通常，为了维护系统和软件开发，Linux 开发了多个命令行界面（CLI），即`sh`、`bash`、`csh`、`tcsh` 和 `ksh`。

我们可以利用以下 Bash 脚本，根据我们的渗透测试目标定制 Kali Linux：[`github.com/PacktPublishing/Mastering-Kali-Linux-for-Advanced-Penetration-Testing-4E`](https://github.com/PacktPublishing/Mastering-Kali-Linux-for-Advanced-Penetration-Testing-4E)。

# 搭建验证实验室

作为渗透测试员，建议搭建自己的验证实验室，测试各种漏洞，并在模拟相同环境到生产环境之前，确保有正确的概念验证。

## 安装指定的目标

为了练习利用技术，建议使用一些已知存在漏洞的软件。在本节中，我们将安装 Metasploitable3，它有 Windows 和 Linux 版本；Metasploit Mutillidae，它是一个 PHP 框架的 Web 应用程序；我们还将使用 CloudGoat，这是一个 AWS 部署工具，用于部署脆弱的 AWS 实例。

### 实验室网络

我们需要确保创建一个仅供测试人员访问的独立网络——因此，我们将在 VirtualBox 中创建一个 NAT 网络，通过从命令提示符或终端运行以下命令来实现，具体路径取决于操作系统；对于 Windows 系统，路径是 `C:\Program Files\Oracle\VirtualBox\`：

```
VBoxManage natnetwork add --netname InsideNetwork --network "10.10.10.0/24" –-enable --dhcp on 
```

请注意，这是单行代码。

### 活动目录和域控制器

在前一版中，我们讨论了如何在 Windows 2008 R2 上设置活动目录；本节中，我们将升级测试实验室，并在 Windows Server 2016 Datacenter 上安装活动目录。一旦从 Microsoft 下载了 ISO 文件（[`www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2016-essentials`](https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2016-essentials)），并在 VMware Workstation Player 或 VirtualBox 上安装了操作系统，你应该能够执行以下步骤：

1.  确保网络适配器连接到正确的网络。选择虚拟机并点击 **设置**，然后在菜单中点击 **网络**，确保 **启用网络适配器** 被勾选，并且 **连接方式** 选择为 **NAT 网络**，名称为 **InsideNetwork**（或者你用来创建实验室网络的名称）。此外，点击 **高级** 并在 **混杂模式** 下选择 **允许所有**（此模式将允许虚拟机之间的所有流量）。

1.  成功登录 Windows 服务器后，通过在命令行中运行以下命令设置该服务器的静态 IP：

    ```
    netsh interface ip set address "ethernet" static 10.10.10.100 255.255.255.0 10.10.10.1 
    ```

1.  在 **服务器管理器** 中，点击 **添加角色和功能**。

1.  从 **安装类型** `屏幕` 中选择 **基于角色或基于功能的安装**，然后点击 **下一步**。

1.  默认情况下，系统会从 **选择服务器池中的服务器** 中选择相同的服务器；点击 **下一步**。

1.  在 **服务器角色** 页面中，在 **活动目录域服务** 旁边的复选框中打勾。安装域服务还需要其他角色、服务或功能：点击 **添加功能**，然后点击 **下一步**。

1.  在 AD DS 安装过程中，通过勾选任何需要的功能旁边的复选框来选择可选功能，然后点击 **下一步**。

1.  这将带我们进入确认屏幕，显示所有选定的功能和服务；点击 **安装**，安装完成后，点击 **关闭**。

1.  选择**AD DS**；它应该会显示一个警告，指出：`需要配置活动目录域服务`。现在点击**更多**以进行部署后配置，这应该会带我们到*图 1.31*：![](img/B17765_01_31.png)

    图 1.31：将服务器提升为域控制器

1.  点击**将此服务器提升为域控制器**。

1.  选择**添加一个新森林**并输入**完全限定域名**（**FQDN**）。在此示例中，我们将创建一个新的 FQDN，名为`mastering.kali.fourthedition`。然后点击**下一步**。

1.  在下一个屏幕上，对于**森林功能级别**和**域功能级别**，选择**Windows Server 2016**并输入**目录服务恢复模式**（**DSRM**）的密码；点击**下一步**。

1.  不要选择 DNS 委派——直接点击**下一步**，它应该会自动识别 NetBIOS 域名为**MASTERING**。点击**下一步**。

1.  选择 Active Directory 的数据库、日志文件和 SYSVOL 的位置，最后，应该会出现一个审查屏幕，如*图 1.32*所示；点击**下一步**：![](img/B17765_01_32.png)

    图 1.32：Windows Server 2016 上安装 Active Directory 服务器的最后阶段

1.  必须满足所有先决条件。忽略警告；完成后点击**安装**。

1.  在**确认安装选项**屏幕上，检查安装内容后点击**安装**。这样操作将重启系统，并且应该会建立一个新的包含域控制器的 Active Directory 服务器。

要在域中创建一个普通用户，在域控制器的命令行中运行以下命令：

```
net user normaluser Passw0rd12 /add /domain 
```

要创建一个域管理员账户，以下命令将创建该用户并将其添加到`domain admins`组中：

```
net user admin Passw0rd123 /add /domain
net group "domain admins" admin /add /domain 
```

要验证这些用户是否已创建，可以通过在命令行中运行`net user`来使用域控制器；你应该能够看到服务器上的所有本地用户。

我们还将通过在域控制器上运行以下命令来为新的 Exchange 服务器创建一个额外的用户：

```
net user exchangeadmin Passw0rd123 /add /domain
net group "domain admins" exchangeadmin /add /domain
net group "Schema admins" exchangeadmin /add /domain
net group "Enterprise admins" exchangeadmin /add /domain 
```

### 安装 Microsoft Exchange Server 2016

在本节中，我们将设置一个全新的 Windows Server 2016，并在其上安装 Microsoft Exchange 服务。这样做是为了探讨我们将在后续章节中探讨的 Exchange Server 2021 的某些漏洞。

我们将利用与 Active Directory 安装时下载的相同 Windows 2016 ISO 来创建一个全新的服务器。一旦 Windows Server 安装并启动，第一步是确保该服务器现在可以与域控制器的 DNS 服务进行通信；因此，通过运行以下命令或手动编辑以太网适配器设置来设置静态 IP 和 DNS（[`www.server-world.info/en/note?os=Windows_Server_2016&p=initial_conf&f=4`](https://www.server-world.info/en/note?os=Windows_Server_2016&p=initial_conf&f=4)）：

```
netsh interface ip set address "ethernet" static 10.10.10.5 255.255.255.0 10.10.10.1
netsh interface ip add dns "Ethernet" 10.10.10.100 
```

下一步是将 Exchange 服务器连接到域。这可以通过以下步骤完成：

1.  进入**系统属性**。按*Windows 键* + *R*并输入`sysdm.cpl`；点击**更改**，这将打开**计算机名称/域更改**的新界面。

1.  将计算机名称从默认名称更改为**ExchangeServer**，然后点击**域**；输入`Mastering.kali.fourthedition`，如果网络没有问题，你应该会看到提示要求你输入用户名和密码。

1.  输入先前创建的用户名`exchangeadmin`，并输入密码；此时你应该看到如*图 1.33*所示的界面，显示已成功加入域。

1.  最后一步是重启计算机，以便计算机名称的更改能在域中反映出来：![图形用户界面，应用程序 描述自动生成](img/B17765_01_33.png)

    图 1.33：成功将 Exchange 服务器添加到 Active Directory 域

以下步骤将把我们的普通 Windows Server 2016 升级为 Exchange 服务器：

1.  从[`www.microsoft.com/en-us/download/details.aspx?id=57827`](https://www.microsoft.com/en-us/download/details.aspx?id=57827)下载 Microsoft Exchange Server 2016 镜像。

1.  将 ISO 文件通过 VirtualBox 挂载为驱动器，方法是进入**设置**，**存储**，选择**光驱**，并添加 Exchange 服务器的 ISO 文件。

1.  在开始安装之前，我们需要安装一些先决条件，可以直接从 PowerShell（以管理员身份运行）安装，如下所示：

    ```
    PS > Install-WindowsFeature NET-Framework-45-Features, RPC-over-HTTP-proxy, RSAT-Clustering, RSAT-Clustering-CmdInterface, RSAT-Clustering-Mgmt, RSAT-Clustering-PowerShell, Web-Mgmt-Console,
    WAS-Process-Model, Web-Asp-Net45, Web-Basic-Auth, Web-Client-Auth, Web-Digest-Auth, Web-Dir-Browsing, Web-Dyn-Compression, Web-Http-Errors, Web-Http-Logging, Web-Http-Redirect, Web-Http-Tracing, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Lgcy-Mgmt-Console, Web-Metabase, Web-Mgmt-Console, Web-Mgmt-Service, Web-Net-Ext45, Web-Request-Monitor, Web-Server, Web-Stat-Compression, Web-Static-Content, Web-Windows-Auth, Web-WMI, Windows-Identity-Foundation, RSAT-ADDS 
    ```

1.  除了这些软件包，你还需要从[`www.microsoft.com/en-us/download/details.aspx?id=34992`](http://www.microsoft.com/en-us/download/details.aspx?id=34992)下载并安装 Unified Communications Managed API 4.0 Runtime。

1.  一旦所有先决条件完成，通过在命令行中输入`d:`来定位驱动器；然后输入`setup /PrepareSchema /IAcceptExchangeServerLicenseTerms`。如果没有错误发生，你应该看到与*图 1.34*中相同的屏幕：![](img/B17765_01_34.png)

    图 1.34：安装 Exchange 服务器前的先决条件检查

1.  一旦完成所有先决条件分析，我们可以通过运行以下命令来准备我们的 Active Directory，进入下一步：

    ```
     setup /Preparedomain /IAcceptExchangeServerLicenseTerms 
    ```

1.  作为最后一步，我们将通过运行以下命令在我们的 Exchange 服务器上安装`Mailbox`角色：

    ```
    setup /Mode:Install /Role:Mailbox /IAcceptExchangeServerLicenseTerms 
    ```

1.  这将导致所需的 Exchange 服务器组件和软件包成功安装，如*图 1.35*所示：![](img/B17765_01_35.png)

    图 1.35：安装 Exchange 服务器工具及其配置

1.  根据系统性能的不同，这可能需要一些时间。一旦完成，Exchange 服务器上的 Outlook Web Access 应该已启用，端口为`443`，如*图 1.36*所示：![](img/B17765_01_36.png)

    图 1.36：Exchange Server 安装成功，访问地址 https://localhost/owa/

### Metasploitable3

Metasploitable3 是一款明显易受攻击的虚拟机（VM），旨在使用 Metasploit 测试多个漏洞。它是以 BSD 风格的许可证发布的。我们将使用两台虚拟机，一台运行过时的 Windows 2008 服务器，另一台运行 Ubuntu 14.04 Linux 服务器，在我们的实验室网络中进行练习。你可以通过首先安装 Vagrant 应用程序来实现此设置。

Vagrant 是一个开源工具，主要用于构建和管理虚拟机环境。你可以从[`www.vagrantup.com/downloads`](https://www.vagrantup.com/downloads)下载适用于你操作系统的版本。安装应用程序成功后，通过在终端或命令提示符中运行以下命令安装所需插件 `vagrant-reload` 和 `vagrant-vbguest`：

```
Vagrant plugin install vagrant-reload
Vagrant plugin install vagrant-vbguest 
```

我们现在准备将 Metasploitable3 虚拟机下载到本地系统。我们将使用 `vagrant box add` 命令配合仓库来下载虚拟机，这些虚拟机托管在 `vagrantcloud.com` 上：

```
vagrant box add rapid7/metasploitable3-win2k8 
vagrant box add rapid7/metasploitable3-ub1404 
```

运行前面的命令应该能提供使用不同服务提供商下载的选项，如下所示的*图 1.37*：

![A screenshot of a computer  Description automatically generated with medium confidence](img/B17765_01_37.png)

图 1.37：通过 vagrant 下载 Metasploitable3

这些虚拟机被下载到`/home/username/.vagrant.d/boxes/` 或 `c:\users\username\.vagrant.d\boxes\` 文件夹。检查这些文件夹以验证下载情况：

1.  通过运行 cd `C:\Users\user\.vagrant.d\boxes` 或 cd `/home/username/.vagrant.d/boxes/` 来切换到相应的文件夹。

1.  我们可以通过运行 `vagrant box list` 来列出已安装在设备上的下载盒子。

1.  要运行这些虚拟机，我们需要通过运行 `vagrant init metasploitable3-win2k8` 来初始化它们。此命令会创建一个名为 `Vagrantfile` 的配置文件，其中包含所有虚拟机设置。从不同的文件夹运行 `vagrant init metasploitable3-ub1404` 以避免出现 `Vagrantfile already exists` 错误消息。

1.  最后，我们通过运行 `vagrant up` 启动虚拟机。你应该能看到虚拟机启动。渗透测试者会收到警告 `default: Warning: Authentication failure. Retrying`，这是由于用于 VM 与 Vagrant 之间 SSH 访问的不安全私钥。成功启动 Metasploitable3 Windows 服务器后，你应该能看到*图 1.38*所示的屏幕：![Graphical user interface, text  Description automatically generated](img/B17765_01_38.png)

    图 1.38：VirtualBox 运行 metasploitable 3

1.  通过运行 vagrant `global-status`验证当前初始化的系统。

1.  接下来的重要步骤是更改这些虚拟机的网络设置，将它们连接到我们的实验室网络。选择虚拟机并点击**设置**。在**常规**标签下，将虚拟机的**名称**更改为所需的名称，然后从菜单中点击**网络**。确保勾选**启用网络适配器**，并选择**附加到**为**NAT 网络**，名称为**InsideNetwork**。

我们已经成功地在我们的 VirtualBox 环境中部署了易受攻击的 Metasploitable3 虚拟机，接下来我们将在这些虚拟机上进行更高级的漏洞利用操作。

### Mutillidae

Mutillidae 是一个开源的、不安全的 Web 应用程序，旨在供渗透测试人员练习所有与 Web 应用程序相关的漏洞利用。XAMPP 是另一种免费的开源跨平台 Web 服务器解决方案堆栈，可以使用，由 Apache Friends 开发。

我们现在将在新安装的 Microsoft Windows Server 2016（域控制器）服务器上安装 Mutillidae 并托管它：

1.  您可以直接从[`www.apachefriends.org/download.html`](https://www.apachefriends.org/download.html)下载 XAMPP，也可以在 PowerShell 中运行以下命令：

    ```
    wget https://downloadsapachefriends.global.ssl.fastly.net/7.3.28/xampp-windows-x64-7.3.28-1-VC15-installer.exe?from_af=true -OutFile XAMPP-Installer.exe 
    ```

    如果在 PowerShell 中运行`wget`时遇到任何 SSL/TLS 错误，确保在 PowerShell 中运行以下命令：[Net.ServicePointManager]::SecurityProtocol=[Net.SecurityProtocolType]::Tls12，以确保 Windows Server 支持 TLS 1.2。

1.  我们将使用 Windows 版本的 XAMPP 7.1.30。一旦应用程序安装完成，确保通过点击 XAMPP 控制面板中的**服务**下的勾选框来启用 Apache 和 MySQL 服务，如*图 1.39*所示：![图形用户界面 自动生成的描述](img/B17765_01_39.png)

    图 1.39：XAMPP 控制面板显示 Apache 和 MySQL 正在运行

1.  您可以直接从[`github.com/webpwnized/mutillidae`](https://github.com/webpwnized/mutillidae)下载最新版本的 Mutillidae，也可以通过在 PowerShell 中运行以下命令来下载：

    ```
     wget https://github.com/webpwnized/mutillidae/archive/refs/heads/master.zip -OutFile mutillidae.zip 
    ```

1.  解压缩文件并将文件夹复制到`C:\yourxampplocation\htdocs\<mutillidae>`。

1.  打开`Mutillidae`文件夹中的`.htacess`文件，并在其中添加`Allow from 10.10.10.0/24`，以允许该 IP 范围访问。

1.  通过点击 XAMPP 控制面板中的**操作**下的**启动**按钮，启动 Apache 和 MySQL 服务。您应该能够看到 Web 应用程序在 Windows Server 上成功部署，并且可以通过访问`http://10.10.10.100/mutillidae/`来访问它。

1.  您将收到与 MySQL 根访问拒绝相关的数据库错误消息。打开 XAMPP 控制面板，确保 MySQL 服务已启动并运行，然后点击**Shell**，并按照*图 1.40*中所示的步骤重置 root 密码：

    ```
    mysql –u root
    use mysql
    SET PASSWORD FOR root@localhost = PASSWORD('mutillidae')
    Flush privileges 
    ```

    ![文本 自动生成的描述](img/B17765_01_40.png)

    图 1.40：从 XAMPP 运行 Shell 并为 root 用户设置 MySQL 密码

1.  最终成功部署漏洞的 Web 应用程序将导致显示 *图 1.41* 所示的界面：![](img/B17765_01_41.png)

    图 1.41：在同一实验室网络内成功访问 Kali Linux 上的 Mutillidae

如果出现数据库离线或类似的错误消息，你需要选择 **尝试设置/重置数据库** 以修复 Mutillidae。如果遇到其他缺少文件的错误消息 —— 确保通过以管理员身份在 PowerShell 中运行 `Set-MpPreference -DisableRealtimeMonitoring $true` 来禁用 Defender。

# CloudGoat

**CloudGoat** 是由 Rhino Security Labs 设计的 AWS 部署工具。该工具使用 Python 编写，能够在账户中部署一个故意存在漏洞的 AWS 资源。我们将在 Kali Linux 上设置 CloudGoat Docker 镜像，并探索攻击者在配置错误的云环境中可能利用的各种漏洞。

为了确保 CloudGoat 能够部署 AWS 资源，第一步是拥有一个有效的 AWS 账户。假设我们已经拥有一个来自 *Kali on AWS Cloud* 部分的账户，我们将执行以下步骤：

1.  访问 [`console.aws.amazon.com/iam/home?region=us-east-2#/home`](https://console.aws.amazon.com/iam/home?region=us-east-2#/home)。

1.  点击用户，然后点击 **添加用户**；输入 `cloudgoat` 并选择 **程序化访问**；点击 **下一步**，这应该会带我们到 *图 1.42* 中显示的界面：![](img/B17765_01_42.png)

    图 1.42：在 AWS 控制台中创建 IAM 用户账户

1.  选择 **直接附加现有策略** 并勾选 **AdministratorAccess**，如 *图 1.43* 所示；点击 **下一步**：![](img/B17765_01_43.png)

    图 1.43：将 IAM 用户添加到 AdministratorAccess 组

1.  点击 **下一步**，直到你到达最后阶段。如果没有显示错误信息，你应该会看到如下界面，其中显示了 **成功** 消息，你可以下载用户的 **访问密钥 ID** 和 **秘密访问密钥**：![](img/B17765_01_44.png)

    图 1.44：为 IAM 用户创建访问密钥 ID

既然我们已经在 AWS 账户内创建了具有管理员权限的 IAM 用户，接下来我们将在 Kali Linux 上的 Docker 镜像中安装 CloudGoat，方法是在终端中运行以下命令：

```
sudo apt install docker.io
sudo docker pull rhinosecuritylabs/cloudgoat
sudo docker run -it rhinosecuritylabs/cloudgoat:latest 
```

最后，使用 `aws configure --profile masteringkali` 配置 AWS 客户端，以连接到我们的 AWS 基础设施，并使用我们从 AWS 下载的最新访问密钥和秘密密钥，如 *图 1.45* 所示。我们将在 *第八章*，*云安全漏洞利用* 中更详细地探讨此工具：

![](img/B17765_01_45.png)

图 1.45：为新创建的访问密钥配置 AWS 客户端

*图 1.46* 描述了我们设置的实验架构，用于在我们定义的目标上进行渗透测试：

![图形用户界面 描述自动生成，信心中等](img/B17765_01_46.png)

图 1.46：我们的《掌握 Kali Linux》实践实验室架构

我们已经成功构建了自己的虚拟化内部实验室，这应该能为我们提供广泛的暴露机会，帮助识别和利用基础设施、应用程序和云中的多个漏洞。我们应该设置以下内容：

+   一个运行在 Windows Server 2016 上的域控制器，通过 XAMPP 运行 Mutillidae

+   一个易受攻击的本地 Microsoft Exchange 服务器，运行在 Windows Server 2016 上，缺少必要的补丁。

+   一个过时的 Microsoft Windows 2008 R2（Metasploitable3 服务器），运行多个易受攻击的服务。

+   一个域管理员，一个 Exchange 管理员，以及一个普通的域用户——我们将在本书的后续部分利用这些角色执行基于角色的权限提升。

+   在 Docker 镜像上的 AWS 云部署工具，用于设置易受攻击的 AWS 基础设施资源。

测试人员必须确保所有在此实验室网络中创建的虚拟机，网络设置始终为 NAT 网络，网络名称为 InsideNetwork，以便虚拟机之间可以互相通信。

# 使用 Faraday 管理协作渗透测试

渗透测试中最困难的方面之一是记住测试网络或系统目标的所有相关部分，或者在测试完成后记得目标是否实际测试过。在某些情况下，单个客户可能有多个渗透测试人员在多个位置执行扫描活动，而管理层希望能看到一个单一的视图。Faraday 可以提供这种功能，前提是所有渗透测试人员能够在同一网络上或通过互联网进行相互 ping 测试，以进行外部评估。

Faraday 是一个多用户渗透测试 **集成开发环境**（**IDE**）。它旨在帮助测试人员分发、索引和分析渗透测试或技术安全审计过程中生成的所有数据，提供不同的视图，例如 **管理**、**执行摘要** 和 **总体问题** 列表。

这个 IDE 平台是由 InfoByte 使用 Python 开发的，最新版本的 Kali Linux 默认安装了版本 3.14.3。你可以从菜单中导航到 **应用程序**，点击 **12-报告工具**，然后点击 **Faraday 启动**。它应该会打开一个新的屏幕，供你输入密码以执行服务更改。现在，你应该看到以下屏幕，设置 Faraday Web 门户的用户名和密码。

一旦设置好用户名和密码，应用程序应该打开一个指向 `http://localhost:5985/` 的网页浏览器。

现在，你将能够为每个项目创建工作空间。下一步是确保所有要使用 Faraday 客户端的测试人员，通过在终端运行`faraday-client`来执行所有任务；它会提示你输入应用程序的凭据。使用刚刚创建的凭据，你现在应该能够看到与*图 1.47*相同的界面：

![Text  Description automatically generated](img/B17765_01_47.png)

图 1.47：通过 Faraday 客户端运行 Nmap 扫描

在此界面之后，你或你团队中的其他渗透测试人员执行的任何扫描命令行操作都可以通过点击**Faraday web**应用程序进行可视化；这将显示类似于*图 1.48*所示的内容：

![Graphical user interface, text, application  Description automatically generated](img/B17765_01_48.png)

图 1.48：Faraday 的实时仪表盘

Faraday 3.15.0 免费版存在一个限制，即测试人员无法利用实时操作、洞察和数据分析功能在一个地方可视化所有问题列表。

# 总结

在本章中，我们探讨了不同的威胁行为者及其动机，以及一些方法论和基于目标的渗透测试，这些方法有助于组织测试自己应对实时攻击的能力。我们学习了渗透测试人员如何在不同平台上使用 Kali Linux 来评估数据系统和网络的安全性。我们简要了解了如何在不同的虚拟化和云平台上安装 Kali，并运行了 Kali Linux 操作系统的 Docker 镜像，同时也在一部非 root 的 Android 手机上运行了该镜像。

我们建立了自己的验证实验室，设置了 Active Directory 域服务，以及一个 Exchange Server 实例，并在同一网络上配置了两台虚拟机，其中一台托管着一个存在漏洞的 Web 应用程序。最重要的是，我们学习了如何定制 Kali，以提高我们工具的安全性和它们收集的数据的安全性。我们的目标是让工具支持我们的过程，而不是让过程适应工具！

在下一章中，我们将学习如何在这个时代有效掌握**开源情报**（**OSINT**），以识别目标的薄弱攻击面，并创建定制化的用户名和密码列表，以便进行更有针对性的攻击，并通过暗网等方法提取这些细节。
