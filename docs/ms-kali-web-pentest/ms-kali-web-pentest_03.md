# 第四章：使用 Arachni 扫描漏洞

Web 应用程序漏洞扫描器是一个大生意。 快速研究替代方案将告诉你，有数百种开源和商业扫描器，它们提供不同程度的漏洞覆盖，并且具有延伸到渗透测试 Kill 链的不同阶段的功能。 与安全领域的任何趋势一样，市场的爆炸是完全不同的东西的症状：Web 应用程序本质上易于访问，也是黑客利用的热门目标。 成功入侵或妥协的回报是巨大的。

参与网络安全解决方案的大公司都会发布年度报告，总结过去一年的事件，并预测未来几年将塑造业务的预期趋势。 Verizon、戴尔、思科、FireEye、赛门铁克和惠普只是每年更受期待的发布之一。 虽然它们通常不涉及特定威胁的技术细节和**战术**，但它们确实有助于阐明当前的威胁领域、高级交付模式以及对任何这些变化的感知动机。 2016 年和 2017 年的多份报告一致指出，攻击者转向利用用户浏览器和插件的漏洞，以及*恶意广告*、嵌入式广告和包含恶意软件或链接到恶意网站的框架。

这些趋势指向了一些事情。 首先，用户及其终端设备（移动设备、笔记本电脑、家庭设备）是我们安全故事中最薄弱的环节。 其次，随着同一用户要求随时随地访问，保护弹性边界变得困难，因为不再有需要防御的边界，而是一个非常灵活的环境。 黑客本质上会利用我们对这些新行为转变和相应弱点的信任；此时黑客企图入侵企业更加复杂和微妙，因此根据他们的动机，寻求快速致富的人会转向最易攻击的路径：Web 应用程序和应用-客户端范式。

那么，我们的客户做出了什么样的回应？ 他们开始购买可以帮助他们开始保护其环境的工具，但前提是这些工具必须被正确使用。 在 Kali Linux 中，我们有一些出色的、备受推崇的扫描器，可以帮助我们的客户更好地了解他们面临的漏洞和更好地了解他们的架构。 虽然我们有一些很好的选择，但混合它们以确保我们覆盖多个工具的矢量是有帮助的，这些工具可以相互补充，减少我们的盲点。 其中一个最好的工具，我相信你过去使用过，如果你进行过 Web 应用程序漏洞扫描，那就是**Arachni**。

在本章中，我们将看到如何使用 Arachni 来实现以下目标：

+   有效地爬行 Web 应用程序进行快速初始扫描

+   使用主动扫描技术进一步探测并发现更多矢量

+   在 DOM 和 JavaScript 环境中启动扫描和跟踪流

+   模仿移动平台的浏览器约束

+   生成高质量的报告，可以作为独立报告或多工具渗透测试交付的基础

## 走进蜘蛛网

* * *

Arachni 是一个专注于我们渗透测试的侦察阶段的开源扫描器，其方式与其他任何工具都不同。如果您使用 Arachni 而不注意它与众不同的地方（就像我一样），那么您可能会发现改变工作流程会极大地改善结果。工具的创建者*Tasos Laskos*开发了该工具以解决一些相反的目标。首先，扫描可能需要过多的时间（甚至数小时甚至数周），这使得这些扫描不太有用。时间被浪费了，使得测试变得更加冗长。其次，更多的数据和覆盖范围是一件好事，因为它增强了准确性，但也为测试过程增加了额外的时间来完成必要的交易。

Laskos 开发 Arachni 以减少扫描所需的时间，同时允许工具扩展，以便能够更有效地处理更多的测试向量。通过使用异步 HTTP 请求来执行工具的命令，并允许 Arachni 跨系统集群扩展，以便它们可以并行处理，从而改进了其时机。通过开源工具并使用 Ruby 框架增强了准确性目标，可以让任何人向工具添加新的或更优化的测试。通过机器学习技术进一步改进了测试的时机、准确性和覆盖范围，使扫描工具 Arachni 成为一个强大的工具，我们将更深入地探索以提高测试效果和时机。

### Arachni 部署的最佳实践

当我们只是使用 Arachni 进行练习时，我们可能会调用托管在同一 Kali Box 上的单个服务器和客户端。应该运行**Web UI Client**可执行文件，以确保 Arachni 的操作方式与实际测试场景中的操作方式相同。虽然有命令行选项可用，但在规模上有限，并且在单服务器部署中效果最佳。

Arachni 的高级架构可以在这里看到：

![](img/B03918_04_01-1.png)

Arachni 的架构是其秘密武器，它有助于扩展和速度。

这里的操作大脑是**Web UI Client**（**arachni_web**）。它提供了一个单一的联系点，将其网格的**Dispatch Servers**（**dispatchers**）与初始扫描请求联系起来。然后，调度程序在**服务器**上生成一个新的**实例**。此时，Web UI Client 将能够直接与生成的实例通信，为适当的扫描工作进行配置。当一个实例完成其任务时，Web UI 客户端会拉取数据并存储它，而实例只是消失了，将其消耗的资源返回给操作系统，以供将来的实例或其他软件任务使用。

随着我们进入生产测试阶段，我们可以扩展部署以利用网格中其他服务器上的额外资源，这不仅可以让我们运行多个扫描，还可以容纳用户团队，并将收集的数据集中存储在 Web UI 客户端的中央数据库中。SQLite3 是默认选项，但如果您将来要将此安装转换为网格或大规模安装，强烈建议您从 PostgreSQL 开始。如何执行此操作的文档位于此处：[`github.com/Arachni/arachni-ui-web/wiki/database`](https://github.com/Arachni/arachni-ui-web/wiki/database)。

### 注意

一旦您选择了其中一个数据库，您就会被锁定；改变主意意味着失去所有先前的数据。如果您认为情况会朝这个方向发展，那么在一开始构建出 PostgreSQL 环境是值得的。

Arachni 与其他黑盒**动态应用程序安全测试**（**DAST**）扫描器不同，它大量使用异步 HTTP 来进行扫描。这允许每个实例并行发送 HTTP 请求到目标。因为你可以同时进行多个扫描，这大大提高了我们从开始到完成的速度。大多数扫描器花费大量时间等待扫描线程完成。鉴于这些扫描器通常运行一组扫描并且不像 Arachni 那样即时调整扫描列表，这更加严重。

可以支持的实例数量实际上取决于可用服务器的数量，它们的资源可用性以及用于发起扫描的出站带宽。我要警告的是，如果你担心带宽，那么生成的流量很可能超过非常大的数量，应该进行限速，以避免损害真实用户的应用程序性能或者警告安全运营人员。没有什么比应用程序扫描器发起的**分布式拒绝服务**（**DDoS**）攻击更能表明*我是来损害你的应用程序的*。正如他们所说，伴随着巨大的力量而来的是巨大的责任！

## 堆栈和框架的再现

* * *

我们在任何主动侦察中的第一步很可能只是尝试进行扫描，但在接受任何工作或任务之前，最好先简单浏览一下网站的主页。使用浏览器插件，比如**Wappalyzer**（[`wappalyzer.com`](https://wappalyzer.com)），我们可以轻松地看到网站的初始足迹，并发现 Web 应用程序构建的平台或框架（如第一章*，常见的 Web 应用程序和架构*中所讨论的）。在我们开始详细介绍 Arachni 最佳实践之前，我们将使用**Damn Vulnerable Web Application**（**DVWA**），所以在我们进行扫描之前，让我们看看浏览器和 Wappalyzer 能告诉我们什么！

如下截图所示，DVWA 显然是在 Linux 操作系统上运行，使用 Apache 作为 Web 服务器，MySQL 作为数据库，并使用了多种脚本语言（Python，Perl，Ruby 和 PHP）。这看起来非常像您典型的**LAMP**堆栈，我们将制定一个扫描，以实现这些细节并帮助缩短扫描时间。其他传统堆栈，无论是基于 Windows 还是 Linux/Unix，使用诸如 PHP 或 ASP.NET 的语言，都正在让位于基于 Ruby，Java，JavaScript 和 Python 的新堆栈，这些堆栈专门用于移动服务，超可扩展的架构以及其他现代关注点，以至于有太多要提及。为了增加乐趣，Web 堆栈或框架对每个人来说意味着不同的东西。静态编码 HTML 的日子正在让位于围绕称为**文档对象模型**（**DOM**）的元素的新方法，其中脚本语言（JavaScript，Python 等）动态构建在浏览器中呈现的 HTML 或 XML。无论使用的是哪个版本的堆栈，能够快速确定正在运行的内容，可以指引我们朝着**常见漏洞和利用（CVEs）**以及我们在测试中可以利用的其他特征的正确方向。

![](img/B03918_04_02.png)

当我们让浏览器帮助我们快速了解目标时，扫描会更加高效。

DVWA 还使用 OpenSSL，在过去的两三年中，它值得仔细研究，因为它已经遭受了几个备受关注的漏洞，比如**Heartbleed**等（[`www.openssl.org/news/vulnerabilities.html`](https://www.openssl.org/news/vulnerabilities.html)），这些漏洞在全球范围内占据了新闻头条。对于一些如此技术性的东西能够成为新闻头条总是相当令人印象深刻，但我们追求的是即使是小事情-这些事情同样容易被利用，而且通常会被忽视，以便解决更高调的漏洞。Firefox 中的上一张截图与 Wappalyzer 插件向我们展示了所有这些有趣的信息。

### 注

要了解流行网站上运行的堆栈情况，您可以在[`stackshare.io`](https://stackshare.io/)上了解更多。如果您想了解有多少种堆栈和观点，这个 Reddit 主题是教育性的，令人印象深刻的，并且可以在[`www.reddit.com/r/webdev/comments/2les4x/what_frameworks_do_you_use_and_why_are_they/`](https://www.reddit.com/r/webdev/comments/2les4x/what_frameworks_do_you_use_and_why_are_they/)上找到。

## Arachni 测试场景

* * *

我们使用的 DVWA 包含在**OWASP BWA**镜像中，位于我的实验室地址`https://172.16.30.131/dvwa/`。我们的 Kali 盒子位于同一子网（`172.16.30.133`），我们希望在默认配置文件上缩短扫描时间。我们将在下图中使用这个非常简单的拓扑图，以展示 Arachni 在基本扫描之上通过一点额外的努力和输入可以做出的一些高级动作。

![](img/B03918_04_03a.png)

简单的 Arachni 测试场景

### 效率配置文件

大多数渗透测试人员早期使用 Arachni 的经验通常涉及使用默认设置运行扫描，这些设置会在目标环境中运行全面的威胁向量列表。这是了解 Arachni 能做什么的好方法，但在 Recon 阶段收集的 OSINT 甚至是通过浏览获得的信息，正如我们刚刚看到的那样，可以为我们提供一些有用的信息，帮助我们缩小搜索范围。我们可以利用这些信息来制定自定义配置文件，就 Arachni 而言，这是大部分功能的所在。

为什么我们要这样做？消除我们知道不感兴趣的向量（未使用的数据库测试、操作系统向量等）既可以减少扫描时间，又可以避免用过多的请求压垮目标。这些信息也可以引导我们以更低的速度进行更深入的调查。我们将一起走过这个过程，并确定一些值得考虑的选项。

#### 创建一个新配置文件

让我们为运行最常见堆栈之一的系统构建一个配置文件。我们在 DVWA 网站上看到的 LAMP 堆栈仍然是大多数 Web 应用程序的运行堆栈，而**Windows/IIS/SQL/ASP.NET**（**WISA**）紧随其后，因此这是一个很好的配置文件。我们将要点击**`Profiles`**菜单顶部的**`+`**按钮，如下所示：

![](img/B03918_04_03.png)

大多数 Arachni 默认情况下都是开启的-我们可以根据 Recon＆OSINT 使用 Profiles 进行定制或聚焦。

这将使我们从图中的**`Profiles`**导航菜单的**`Top`**开始，位于浏览器窗口左侧（1）。我们需要决定一个配置文件名称（2），输入一个描述以帮助跟踪意图（3，对于团队和大型生产网格来说是个好主意），以及可以访问它的用户（4）；选择**`Global`**。需要注意的是，这些配置文件是 Web UI Client 本地的，因此您的队友需要能够从他们的位置访问门户网站。

![](img/B03918_04_04.png)

并不是最令人兴奋的部分，但命名约定和文档使生活更轻松。

#### 范围和审计选项

**范围**部分定制得太细致，以至于无法用于适用于多个应用程序的配置文件。该部分包括仅扫描 HTTPS、设置路径和子域限制、根据字符串排除路径或限制 DOM 树深度的选项。如果您正在进行白盒测试或作为 SDLC 的一部分对同一应用程序进行内部渗透测试，这些选项是帮助将测试重点放在受影响的区域而不是扫描过大范围和包含多余结果的绝佳方式。牢记这一点，让我们继续。

我们将在接下来的图中使用**审计**选项来设置我们的高级扫描策略。当我们测试服务器时，如果我们省略了那些不必要地延迟我们进度的资源密集型元素，我们的扫描可以变得更加高效。如果我们知道一个网站同时使用 HTTP 的**GET**和**POST**，我们可以只测试其中一个查询。测试过程对我们每个人来说都是不同的 - 我们可能会将我们的 Arachni 扫描与 Burp Suite 或 OWASP ZAP 扫描重叠，并且不再需要扫描标头或处理 Cookie；我们将在第五章中介绍这一点，*使用 OWASP ZAP 和 Burp Suite 进行代理操作*。接下来，我们也将取消这里的复选框。

![](img/B03918_04_05-1.png)

审计部分是我们决定对 Web 服务器进行测试的方面。

#### 将社会工程转化为用户输入和移动平台模拟

根据我们在侦察阶段的成功，我们的一些 OSINT 可能包括网页用户的凭据。这些凭据通常可以在类似于我们在第三章中讨论的使用 SET 的 MITM 攻击中被获取。虽然在没有凭据的情况下扫描网站是可以接受的，但作为登录用户进行扫描可能会带来一些意想不到的发现。没有凭据的话，你可能只能看到大部分静态内容，以及在黑盒测试中暴露的更少的敏感信息。白盒测试可以更好地保护数据，以防凭据被泄露，因此如果这些凭据可用的话，输入字符串在这里同样具有价值。接下来的 HTTP 部分同样可以帮助定制 HTTP 请求，更好地模仿合法的客户端，处理路径中的任何代理，并限制一些请求速率和文件大小，以确保扫描器和目标都不会被压垮，或者在他们的情况下，察觉到我们的存在。如果你需要模拟不同的浏览器和平台组合，你可以在这里提供这些修改（网站[`www.useragentstring.com/pages/useragentstring.php`](http://www.useragentstring.com/pages/useragentstring.php)提供了详尽的列表）。正如我们将看到的，输入字段中输入的简单内容将导致我们在应用程序中深入挖掘时扫描的范围更广。

在接下来的图中，还有一系列其他字段*，*我们可能也需要注意。地址、姓名和其他静态信息很受欢迎，但更动态的输入过程，如 CAPTCHA 字段，专门设计用于防止非人类填写表单。这可能会限制扫描器的范围，但请放心，还有许多其他方法可以克服这一障碍，以便我们可以测试以确保目标真正受到保护。

![](img/B03918_04_06-1.png)

当我们有用户潜在的凭据可以利用时，输入部分非常方便

#### 指纹识别和确定平台

指纹识别部分是我们可以集中扫描并在日程表中节省时间的最有影响力的方式之一。如果您还不知道目标的堆栈，指纹识别本身就是一个很棒的工具。正如我们之前在浏览器中发现的那样，我们正在运行 LAMP，并且可以在选择只与该框架相关的测试时省略指纹识别。请注意，在下面的图中，我正在尝试针对检测到的所有 4 种语言（Perl、PHP、Python 和 Ruby）进行测试：

![](img/B03918_04_07.png)

指纹识别允许我们明确选择测试——如果我们不必使用所有测试，那就没有意义。

#### 检查（请）

**检查**部分提供了我们将测试的漏洞的细节。每个检查都是主动检查或被动检查，我们可以根据需要启用所有或部分检查。在这种情况下，我们对 DVWA 的框架有大量信息，但我们不知道它们将受到什么样的影响。如果这真的是一个黑盒扫描，并且我们试图保持隐蔽，我可能会在早期的扫描中省略所有主动检查（见下图），并等到我能够从一个不那么可疑的主机更接近 Web 服务器时再进行扫描。

![](img/B03918_04_08.png)

主动检查决定了 Arachni 将主动与目标进行交互以发现的漏洞。

被动扫描部分要少得多，虽然这些测试可能需要一些时间，但在早期的侦察工作中非常值得使用。这可以在下图中看到，要获取更多详细信息，您可以单击每种类型的名称以获取额外信息。

![](img/B03918_04_09-1.png)

被动检查是在不与应用程序的输入字段进行交互的情况下收集的。

#### 连接到 Arachni 扩展和第三方插件

Arachni 的基于 Ruby 的框架（因为，惊喜，Arachni 也是一个 Web 应用程序！）是任何人都可以构建额外功能的简单工具。广泛接受的插件，当满足开发人员的高标准时，甚至会进入**`插件`**部分的 Web UI 客户端。在这个版本的 Arachni 中，我们已经集成了几个插件，可以帮助我们的扫描减少对目标的影响（自动节流阀或速率限制器），或者添加功能来扫描其他怪癖和漏洞。甚至可以在运行时修改字段和测试参数。其中一些只是被检查了（见下图*），其他需要在展开它们后进行额外配置（只需单击每个插件的超链接名称以获取详细信息）。

我为此配置选择了**`AutoThrottle`**和**`WAF Detector`**：

![](img/B03918_04_10-1.png)

插件修改任何配置文件，以允许即时参数模糊、速率限制或其他特殊测试。

进行 WAF 检测的另一种方法是使用我们可靠的**Nmap**工具。Nmap 包括了一些用于此目的的脚本。一个脚本仅检测 WAF 的存在，而另一个脚本则在发现 WAF 时通常会告诉我们正在使用的品牌或版本。通过多个脚本和工具进行确认通常可以增加整体测试的可信度。要使用这些脚本，请输入以下命令：

```
nmap â��p 80,443 --script http-waf-detect <hostname or ip address> nmap --script=http-waf-fingerprint < hostname or ip address> 
```

#### 浏览器集群

所有这些扫描和测试都是作为实例实际上是与 Web 应用程序和用户进行交互的浏览器会话进行的。我们实际上可以修改浏览器的模拟行为、时间限制、大小，甚至是**`浏览器集群`**中使用的独立浏览器的数量。对于快速扫描，我建议勾选允许扫描程序省略图像的复选框。

会话检查也是一种潜在有价值的能力，其选项如下图所示。没有比扫描一个应用程序，然后发现该应用程序背后的逻辑已经将您的会话、扫描或流量转移到目标控制之外的链接域更糟糕的了。我们可以在这里输入确认页面，以确保我们定期返回到锚定页面，以确定我们的状态，并确保我们仍然在目标应用程序的结构内进行扫描，而不是进入链接应用程序的偏离。

![](img/B03918_04_11.png)

浏览器和会话设置确保我们向正确的站点展示我们最好的一面。

在我们进行了所有配置文件更改之后，我们可以在底部选择**`创建配置文件`**按钮，然后就可以开始了！如果遇到问题，顶部中心的错误框将引导您找到问题所在，并告诉您在接受配置文件之前必须进行哪些修改。

### 启动我们的自定义扫描

制作完自定义配置文件后，我们可以调用它、安排它，或者将其放在安全的地方。要运行扫描，只需启动扫描，并在**`要使用的配置文件`**字段中选择**`LAMP 配置文件`****`Â (全局)`**（或者您使用的任何名称），如下图所示。我们可以控制实例的数量，如何分配工作负载（直接到运行一个或多个实例的本地计算机，到远程服务器，或者使用计算机网格），如果需要的话可以安排它。在这里，我们现在只运行两个实例，看看它的表现如何。

![](img/B03918_04_12.png)

使用自定义配置文件运行扫描很简单。

在扫描运行时，我们可以观察摘要，看看我们的自定义配置文件效果如何。如下图所示，我们的扫描已经远远超出了默认配置文件所见的范围，发现了更多页面，尝试了更多请求，并在保持低调的同时获得了更好的覆盖范围。这导致了更长的完成时间，但自动化应该允许我们在处理其他事情时进行快速扫描。

我建议您在自己的工作流程中找到可以启动自动任务的地方，同时在个人工作中进行更费力的工作，例如 Maltego 图构建、社会工程或后续任务的设置。

![](img/B03918_04_13.png)

LAMP 配置文件速度较慢，但揭示了更多内容，并对目标服务器的负担较低。

### 审查结果

我们定制扫描的结果是，我们看到了 34 个问题，而不是之前广泛扫描中识别的 29 个问题，但我们的扫描时间是 28 分钟，而不是 34 秒。我们还发现了超过 90 页，而不是 27 页（其中一些是由于我们的用户输入），并且请求速率远低于默认值，因此保护了 DVWA 免受小规模**拒绝服务**（**DoS**）的影响，并且在任何可能到来的防御措施下保持低调。Arachni 会一直保存扫描结果，直到空间用完或者我们告诉它删除结果，因此我们将始终有两者进行比较和对比。在实践中，我建议在风险可接受时运行单个目标扫描，并在工作的更隐秘阶段运行较小的子扫描。

以下是这些结果的摘要：

| Â  | **LAMP 配置文件** | **默认配置文件** |
| --- | --- | --- |
| 完成时间 | 38 分钟 | 36 秒 |
| 找到的页面 | 90 | 27 |
| 高严重性 | 3 | 0 |
| 中等严重性 | 8 | 7 |
| 低严重性 | 6 | 6 |
| 信息性 | 17 | 16 |
| 总问题 | 34 | 29 |

报告可以以多种有用的格式导出，包括 HTML、JSON、XML、Marshal、YAMR 和 AFR。与所有其他报告一样，HTML 报告数据丰富，几乎可以直接呈现，如下图所示：

![](img/B03918_04_14.png)

Arachni 的报告格式已经准备就绪，是构建客户交付成果的绝佳起点。

对于更技术性的客户，提供后续或即时行动（见下图）是有帮助的。作为渗透测试人员，如果您不仅能够识别问题，还能够基于最佳实践提出建议，帮助客户的目标网络得到纠正并变得更加安全，那么您的价值将会更大。

![](img/B03918_04_15.png)

详细的漏洞信息可以帮助快速教育客户或设置下一阶段。

## 摘要

* * *

有效的渗透测试取决于许多因素，但最好的结果来自于一组经过良好教育的扫描，既可以教育又可以为测试的后期阶段做好准备。正如最近的事件和持续的头条新闻所证明的那样，攻击者可以利用的向量数量和种类令人震惊。这些潜在漏洞的数量和重要性要求全面的测试套件，可以自动化扫描，并帮助我们快速确定目标的风险暴露。几乎同样重要的是能够处理大量的原始数据，并将其转化为可操作的情报。

Arachni 在提供这些扫描方面是一个很棒的工具，作为额外的奖励，您可以构建我们详细报告或可交付成果的基础。因为 Arachni 是一个开源且可扩展的产品，它得到了社区的良好支持，并提供了一个 Ruby 框架，任何人都可以在其上添加自己的扩展或插件。Arachni 有成千上万的选项，但希望我们在配置文件生成器中的深入研究能够为您提供一些关于如何更好地使用 Arachni 和其他辅助工具（如浏览器或 nmap）来高效地勘察目标系统的见解。Arachni 调查目标漏洞的深度使其能够详细地发现潜在的向量，这与许多商业替代品相媲美甚至超出了许多商业替代品。

在本章中，我们讨论了如何扩展 Arachni 的部署方式，以及如何调整扫描配置文件以揭示更多信息并保持低调的技巧。我们看了如何更好地对目标进行配置文件，定制扫描行为，并加载并专注于测试的 Recon 阶段获得的目标属性。我们还看到这些调整在深入页面发现和漏洞识别方面取得了长足的进展。报告元素也简要讨论了；如果有的话，这个领域充满了可能性，根据您的工作流程，您的流程将大大加速报告生成，并支持长期持续改进，我们都希望这成为 SDLC 中的标准。

在下一章中，我们将介绍另外两个与 Arachni 有重叠的工具，但可以将渗透测试进一步延伸到 Kill Chain--**Burp Suite**和**OWASP ZAP**。这些工具复制了 Arachni 的一些功能，但也可以利用我们在这里学到的知识来开始实际利用这些漏洞并确认影响。在看到 DVWA 需要担心什么之后，我相信我们会看到一些有趣的结果！
