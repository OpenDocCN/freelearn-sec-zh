# 第五章：使用 OWASP ZAP 和 Burp Suite 进行代理操作

Web 服务器和应用程序比大多数其他企业应用程序更容易暴露在互联网上：它们必须可用并为最终客户提供服务。因此，防御者已经被教导将用户流量（浏览网站，与动态内容交互等）视为正常，只要它遵循行为规范。他们的防御将专注于广泛的交互，同时让*正常*用户活动的缓慢渗漏。有效的渗透测试人员将尽可能模仿这种行为，以在启动后更具侵入性的 Kill Chain 的阶段之前尽可能多地了解他们的目标。

正如我们在第四章中指出的，使用 Arachni 进行漏洞扫描，专门的扫描工具可能是一把双刃剑。首先，大多数扫描器，包括 Arachni 在内，专门通过被动和主动手段寻找漏洞。这两种方法都有帮助，但正如您可能很清楚的，它们会以时间成本和主动扫描的隐蔽性为代价。除了资源需求和所需的时间之外，我们还必须考虑我们自己的工作流程与所需的隐蔽级别。可以获得重要的情报，但如果配置文件的调整不精确，您就有可能警告目标的操作人员并被发现。在职业早期的渗透测试人员经常会释放 Nmap 扫描或其他主动侦察工具，然后发现他们的噪音破坏了他们进一步前进的机会。

以扫描为重点的工具还需要将发现转化为后期操作，并且它们在检测能力上也存在漏洞。大多数扫描工具不会代表您采取行动。这些警告可能在白盒测试场景中是可以接受的，在这种场景中，您可以毫无顾忌地测试 Web 应用程序，而不必担心被发现。在黑盒场景中，渗透测试更有可能由红队（作为外部攻击者）进行，更需要更精确的手术技术。你们中的许多人可能已经注意到，大多数扫描或*蜘蛛*工具存在盲点，特别是在遇到 JavaScript 或 Ajax 等新内容交付范式时，这些范式动态创建内容而不是依赖存储的 HTML。对于这些情况和许多其他情况，我们都有必要在您的武器库中拥有一两个备用工具集。

基于代理的工具为我们提供了一个补充工具，不仅可以进行扫描，还可以在同一个工具中进行漏洞利用和访问。这些产品充当客户端（浏览器）和服务器端（Web 层）元素之间的代理。通过坐在这个关键链接的中间，我们能够搜索两侧之间的消息流量，并观察甚至修改和攻击。代理工具的额外好处是允许我们在通过一些验证后修改请求，这样我们就可以规避应用程序可能存在的一些基本 JavaScript 和 HTML 限制。

您可能已经在您的武器库中使用了其中一些工具；毫无疑问，市场上充斥着开源和商业替代品。我们在本章中的目标将是进一步研究 Kali Linux 附带的两种最受欢迎的替代品——**Burp Suite**（[`portswigger.net/`](https://portswigger.net/)）和 OWASP 自己的**Zed Attack Proxy**（**ZAP**）。这两个工具都可以免费使用，但我们还将看到 Burp Suite 专业版可以为混合增加多少。我希望我们将涵盖一些更高级的技术，以利用这些基于代理的工具，然后您可以使用这些技术来改进您自己的流程，提供更好的结果，并更有效地帮助您的客户保护安全。

牢记这些高层次的目标，在本章中，我们将涵盖以下内容：

+   对比两个主要代理工具 Burp Suite 和 OWASP ZAP（以前称为 zaproxy）与 Paros 之间的差异

+   深入使用 Burp 的代理和扫描器以及 ZAP 来确定和检测 OWASP 十大漏洞

+   学习如何利用 Burp 的主动工具来枚举信息和利用漏洞

+   通过模糊化和 Burp Repeater 测试访问控制和会话管理

+   使用 Burp Suite 揭示和利用注入漏洞、输入验证和应用程序逻辑漏洞

## 使用 ZAP 拉开帷幕

* * *

学习 OWASP 的工具套件非常值得——它们的平台无关方法意味着您可以随时随地使用这些工具，而不必担心您所在的操作系统是哪个。幸运的是，Kali 默认捆绑了它。对于我们测试人员来说，更有帮助的是 OWASP 在 Web 应用程序安全领域的领导地位。他们的见解和指导都会融入 ZAP 工具的每一次迭代中（[`www.owasp.org/index.php/ZAP`](https://www.owasp.org/index.php/ZAP)），因此我们可以确信我们正在获得最前沿的漏洞和利用信息，这些信息会随着发现而被纳入工具中。

与 Kali 中的任何工具一样，您可能已经在学习或工作中使用过 ZAP，但有一些高级技术可以用来改进 ZAP 在您的工具集中的覆盖范围和效果。ZAP 可以主动扫描目标（这是他们“快速启动”选项卡使用的方法），也可以用作代理工具来捕获、迭代和模糊化站点。

ZAP 的代理功能扫描可以通过其“工具”菜单进行扩展，以进行应用程序扫描、蜘蛛爬行或模糊化。ZAP 充当 Web 代理，通常位于测试人员浏览器的同一主机上。以下屏幕截图显示了 ZAP 如何适应架构：

![](img/B03918_05_01.png)

OWASP 的 ZAP 是我们的中间人，可以减慢并重放服务器-客户端交互。

虽然大多数网络应用程序黑盒场景可以通过在同一主机上部署我们的代理中间人来解决，但应该注意，随着物联网的出现以及使用网络应用程序为这些设备提供服务的趋势，我们可以使用 ZAP 或 Burp 以代理模式进行代理，其中客户端实际上是嵌入式智能设备上的 Web 客户端（例如电视、摄像头、恒温器、SCADA 传感器、泵或电机等）。一些公司预测到 2020 年，互联网将连接 500 亿台设备，尽管最初被认为是过于热衷，但实际上可能相当保守。考虑到有多少制造商似乎在保护它们方面运气不佳（例如**Mirai 僵尸网络**），在机会出现时考虑这种用例是值得的。黑客们绝不是创业家！

### 快速回顾启动 ZAP 扫描

在我们深入了解 ZAP 的更高级功能之前，让我们快速建立一个基线项目，并使用持久项目（在会话之间保存数据）。假设您已经配置了浏览器将代理指向 ZAP（我的配置为`localhost:8080`），我们将针对`Mutillidae`应用程序进行目标设置，该应用程序类似于`DVWA`，但提供了更深入的功能，位于`http://172.16.30.129/mutillidae/`。我还配置了我的客户端信任来自 ZAP 的证书，以确保我在 SSL/TLS 方面没有问题，尽管在这种测试场景中不太可能出现问题。

**OWASP Broken Web Application** VM 上有大量的培训和存档应用程序，包括**DVWA**、**WebGoat**、**Multillidae**等。如果您下次旅行时只能在 Kali VM 旁边运行一个应用程序，那么这将是最好的选择。对于更专注的测试，我建议在[`www.vulnhub.com/`](http://www.vulnhub.com/)上找到最新的易受攻击的虚拟机。

#### 使用 ZAP 积极行动

如果我们想运行主动扫描，我们可以简单地在 URL 中输入 DVWA 的地址来攻击应用程序，然后点击**`Attack`**。许多人使用这个功能，但了解扫描可以帮助您更好地使用工具，并选择正确的功能组合。

![](img/B03918_05_02.png)

快速扫描揭示了大量的向量，但其中最紧迫的是那些讨厌的密码。

站点面板绘制了网站，显示文件和目录结构，如前面的屏幕截图所示。在下面的窗口中，我们会注意到**`Alerts`**根据它们的类型进行分组，ZAP 使得进入后续操作变得非常容易。我们可以看到每个 URL 对应的不同颜色的标志，表示相关漏洞的关注级别，以及一个蜘蛛符号，表示它是通过自动**`Spider`**功能学习到的。当我们通过浏览器访问这些位置时，随着与网站的交互，蜘蛛将消失，我们将获得更高的准确性。扫描可以节省时间，但自动蜘蛛，就像任何主动技术一样，往往是一种粗糙的工具，而不是一个精细调校的仪器。如果您已经对您要寻找的内容有一些想法，将这些扫描集中在目标的较小部分上将会在隐蔽性方面产生回报。

无论哪种情况，我们在 Mutillidae 中看到的基于 Web 的安全问题比 BWA 镜像上的其他应用程序更多，其中最严重的之一是**路径遍历**问题，似乎允许我们暴露`/etc/passwd/`的内容。我们可以使用上下文菜单来突出显示并阅读有关漏洞的信息，甚至可以在浏览器中启动标记的 URL，如下面的屏幕截图所示：

![](img/B03918_05_03.png)

哦，我们需要和客户谈谈一些密码的事情 - 在测试结束后。

正如我们所看到的，这些密码信息的宝库只需付出最小的努力就能获得，这并不总是情况（但我们可以希望），但 ZAP 提供的每一个警报都提供了一个我们在渗透测试中应该追求的线索。

#### 被动 ZAP 扫描

**被动扫描**是一种非侵入性的方式，我们可以通过它来绘制和了解网站的结构以及与之交互的代码。被动扫描不允许对 HTTP 消息进行内联修改，但对未修改的标头和内容进行全面检查，使 ZAP 能够提供洞察力。它将构建警报和标记，就像它们是通过主动扫描生成的一样。

Passive scanning only has two configuration areas:

+   第一个重点是扫描引擎的敏感性。我们可以访问**`Passive Scan Rules`**屏幕，如下面的屏幕截图所示，并选择**`Off`**、**`Low`**、**`Medium`**或**`High`**来改变对每种漏洞类型警报的阈值。**`Off`**禁用扫描和警报，**`Low`**提供最高级别的敏感性，而**`High`**只关注最明显的漏洞来标记。

![](img/B03918_05_04.png)

根据我们的需要，被动扫描可以省略或审查各种测试类型。

+   被动扫描的第二个配置区域是我们能够根据特定的正则表达式或标头信息进行标记，如下面的屏幕截图所示。这对我们有什么用呢？当我们对特定页面上要寻找的内容有一些想法时，我们可以创建自定义标记，让 ZAP 能够识别我们想要的模式。ZAP 中密码的默认标记模式可能对密码来说效果很好，但是当我们发现目标通过用*密码短语*或*秘密*替换字段名称时呢？这种标记定制也可以用来获取其他有趣的信息，这也是我们有充分理由复习我们的正则表达式或**regex**语法。

![](img/B03918_05_05.png)

可以添加或修改标签，以帮助我们发现目标的秘密。

#### 用 ZAP 进行模糊测试

ZAP 有能力修改或**模糊**请求发送到 Web 应用程序，这对于测试输入验证、应用程序逻辑、多种注入漏洞和错误处理非常有用。模糊攻击为原本繁琐、费力和迭代的测试添加了一些自动化，重点关注请求处理中的错误。内置的模糊测试负载相当简单，但可以通过使用附加组件甚至自定义脚本进行扩展。在 ZAP 上提高模糊测试技能的一个很好的资源是**OWASP 的 OTG 附录 C**，位于[`www.owasp.org/index.php/OWASP_Testing_Guide_Appendix_C:_Fuzz_Vectors`](https://www.owasp.org/index.php/OWASP_Testing_Guide_Appendix_C:_Fuzz_Vectors)。我们可以通过右键单击**`Alert`**、**`History`**或**`Request`**条目来启动模糊测试操作，几乎可以在 ZAP 的任何地方进行，就像我们再次访问 Mutillidae 网站时所看到的那样（该应用程序正在受到严重滥用！）。您的目标应该是寻找任何蜘蛛结果或浏览操作，导致客户端和服务器之间传递变量的请求或响应，并寻找测试接受限制的机会。在这种情况下，我们认为我们可能有机会攻击登录应用程序并测试一些 SQL 注入/输入验证漏洞。

![](img/B03918_05_06.png)

在 ZAP 中，几乎可以从任何地方开始进行模糊攻击。

然后，我们可以选择一个字段进行模糊测试，并添加我们想要部署的负载的位置（Mutillidae 在其*练习*模式中指出了几个测试向量，因此我建议尝试其他向量）。

要了解 OWASP 的 Mutillidae Web 应用程序提供的多种漏洞，您可以阅读 SANS 指南，该指南解释了该应用程序的起源、目的和内部工作，网址为[`www.sans.org/reading-room/whitepapers/application/introduction-owasp-mutillidae-ii-web-pen-test-training-environment-34380`](https://www.sans.org/reading-room/whitepapers/application/introduction-owasp-mutillidae-ii-web-pen-test-training-environment-34380)。

首先，我们将使用**JBroFuzz**附加组件提供文件模糊测试器，这意味着 JBroFuzz 将提供各种类别的列表进行尝试。密码、目录和用户名列表很常见，但各种 SQL 查询的有用字符串也很常见。这些步骤显示在下面的截图中。在测试强大的 Web 应用程序时，还可以测试常见的浏览器 URI 和 HTTP 版本，以查看是否存在可以迫使降级姿态的点，以便应用程序可以适应您*过时*的浏览器或操作系统。

![](img/B03918_05_07.png)

配置模糊测试负载是一个简单的过程。

根据您勾选的框和突出显示的字段，您会发现 ZAP 开始对页面或字段进行详尽测试。在**`Fuzzer`**选项卡中，您会注意到所有的结果。如果您看到感兴趣的结果，务必右键单击它并尝试在浏览器中启动它。我们在这里寻找的是差异。为什么在下面的截图中，输入**`41`**导致**`302`**响应和更大的字节计数？看起来模糊测试过程导致了该测试字符串的不同结果。

![](img/B03918_05_08.png)

模糊测试结果迅速引起我们对一小组字符串的注意。

在右上角面板中，您可以查看标题和正文代码或信息，正如我们在下图中所看到的，我们可以记录一些有趣的差异以供将来测试和分析。我们可以看到左侧似乎无害的有效负载`1 exec sp_（或 exec xp_）`的结果，以及右侧传递有效负载`â�� or username is not NULL or username = â��`的结果。

![](img/B03918_05_09.png)

模糊测试结果迅速将我们的注意力集中在一小组字符串上。

正如我们现在所看到的，这似乎表明右侧有效负载的某些部分找到了不同的响应--这些应用程序的漏洞可能是我们需要获取立足点并危害我们的目标。一旦您对感兴趣的任何字段进行了模糊测试，通常会对字段的组合进行模糊测试，以进行简单基于凭据的身份验证的暴力攻击。OWASP 的 ZAP 肯定也可以帮助进行这些后续测试。类似的功能也可以在其他 Kali 捆绑测试工具集中找到，如**w3af**、**WebScarab**和古老的经典工具**Paros**。作为渗透测试人员，花时间了解至少其中几个是值得的。

## 使用 Burp Suite 提升到一个新的水平

* * *

OWASP ZAP 是一个很棒的开源代理扫描和模糊测试工具的介绍。也就是说，大多数测试人员已经发现，需要额外的工具来完成完整的测试，原因是需要覆盖更多的输入向量，覆盖 Flash 和 Webservice 漏洞等其他内容类型，并自动化更多的报告和审计流程。可以在**SecToolMarket.com**（[`www.sectoolmarket.com/price-and-feature-comparison-of-web-application-scanners-unified-list.html`](http://www.sectoolmarket.com/price-and-feature-comparison-of-web-application-scanners-unified-list.html)）了解更多关于许多工具集的信息。与外部工具集协调以完成小型渗透测试以上的工作是不值得的。许多新的基于代理的**动态应用安全测试**（**DAST**）框架应运而生。这些解决方案从免费到极其昂贵不等，可能被大型企业或他们雇佣的渗透测试人员使用。许多这些平台可以在 Linux、Windows 甚至 Mac OS 上运行。

Kali Linux 方便地捆绑了 Linux 领域领先工具的免费版本；**Burp Suite**（[`portswigger.net/burp/`](https://portswigger.net/burp/)）由*Daffyd Studdard*创建，并由他的公司**PortSwigger**维护。Burp Suite 的架构包括其他工具集的代理和模糊测试功能，但通过内置工具扩展了这些功能，更完全地扫描、模糊测试和与目标环境交互。Burp Suite 可以比较站点地图并自动化许多其他对于 ZAP、w3af 和其他 Kali 捆绑工具来说是手动的任务，并且几乎涵盖了整个 OWASP OTG。我们将在后面详细讨论的一些这些工具在免费版本中要么被禁用要么受到限制，如下图所示。我强烈建议购买 Burp Suite Pro 订阅（截至撰写本文时每年 349 美元每用户），因为在这个价格下，您将获得频繁的更新、出色的支持，并且是市场上成本最低的网络渗透测试工具之一，并且您可以根据需要在 Kali（或其他形式的 Linux）、Windows 和 Mac OS 上使用它。

![](img/B03918_05_10.png)

Burp Suite 免费版和专业版的比较。

了解 Burp Suite 旨在支持的用户驱动工作流程有助于测试人员理解各版本之间的区别，并决定 Burp Suite 将如何支持他们自己的定制流程。

以下屏幕截图改编自位于[`portswigger.net/burp/help/suite_usingburp.html`](https://portswigger.net/burp/help/suite_usingburp.html)的图表，但在此处更清楚地概述了**专业版**添加的部分：

![](img/B03918_05_11.png)

Burp Suite 的架构支持完整的渗透测试工作流程。

不要担心前面的部分，我们将快速回顾代理和蜘蛛的设置和配置，然后迅速进入 Burp 提供的更高级功能，这些功能可以在整个渗透测试过程中提供自动化。

### 使用 Burp Suite 进行侦察

与任何代理工具一样，我们需要配置浏览器的设置以使用适当的 IP 地址和端口号（通常使用 IP 地址`127.0.0.1`和端口`8080`）。幸运的是，相同的配置对 ZAP 和 Burp 都适用，除非您打算链接代理。如果您需要通过多个工具传递流量或使用外部代理，则可能需要这样做，有关如何在图片中使用 Burp 进行此操作的详细信息，请参阅[`portswigger.net/burp/help/options_connections.html`](https://portswigger.net/burp/help/options_connections.html)。OWASP **Broken Web Application Virtual Machine**（**BWA VM**）包括多个用于测试和培训的应用程序，我们只想专注于 OWASP Mutillidae 应用程序，该应用程序为我们的实践提供了丰富的素材。

#### 保持目标！

您可能已经知道，开始侦察的推荐方法是首先手动映射目标，关闭代理的拦截功能。当我们点击各种页面并在表单中提交无意义的内容时，我们将填充**`目标`**选项卡的**`站点地图`**子选项卡。在这里对任何感兴趣的域或 IP 地址右键单击，可以将主机添加到我们分析的范围内。我们还可以手动将目标添加到**`目标范围`**（查看下面的屏幕截图），但这两种方法都让我们有机会将分析重点放在应用程序上，如绿色框中所示--在范围内定义的任何内容，您需要了解 Burp 将为您攻击！您还可以从范围中省略某些类型的内容（在红框内），但在这种情况下，我们将保留默认设置。

这些默认设置将确保我们不会浪费时间查看注销页面。

![](img/B03918_05_12.png)

目标范围是巨大的生产力增强。

为什么我们要费这么大的劲？自动化工具需要一些帮助。如果您没有任何限制地释放它们，您可能会面临不必要的流量破坏目标或对您的任务范围之外的站点造成附带损害的风险--这两种情况都对业务不利！手动映射类似于一次漫步，它使您和您的团队更好地了解可能正在使用的技术以及站点工作流程对用户交互的影响。我们需要在前期更好地回答一些问题，以确保后期获得更相关的结果。站点试图引导用户去哪里？提供了哪些服务？我们可以标记哪些表单以进行更深入的分析？您明白了，并且可能在自己的工作中获得了这方面的理解。Burp Suite 也需要理解这一点，以更有效地代表您进行操作。

当您接近被动和手动映射的结束时，您可以从 Burp 中获得一些帮助来完成探索。**`目标`**选项卡和**`站点地图`**子选项卡中的灰色站点是已经了解但尚未访问的链接，因此如果您认为访问它们可能会有所收获，那就尽管去做吧！您还可以激活**`内容发现`**，让 Burp 尝试发现可能已经断开链接或不再活跃但仍存储在服务器上的目录、模板或其他潜在隐藏的文件和文件夹。只需右键单击主机，选择**`参与工具`**，然后**`发现内容`**，如下所示：

![](img/B03918_05_13.png)

内容发现可以帮助找到隐藏或被遗忘的内容。

一旦您启动了**`内容发现`**，您就有机会选择用于自动发现操作的内置或自定义单词列表（请参阅下图）。内容发现实际上是一种特殊的蜘蛛功能，其目的是寻找未链接的页面和文件夹，而蜘蛛会专注于跟踪所有链接，直到网站被完全映射。在这里，我们可以决定是否遵守大小写敏感性（这会增加完全枚举所有可能性的操作次数）。我们还可以指定感兴趣的文件类型和扩展名，要使用的线程和连接数，甚至是否希望 Burp 的内容发现从这些隐藏的工件中蜘蛛出来，并深入到这些链接可能指向的任何内容。

我强烈建议在 Burp 中使用**注释**功能。内容窗口中任何发现的最左侧字段都可以使用下拉菜单进行颜色编码，您还可以双击添加评论。在处理复杂目标或作为团队的一部分时，这些工具可以帮助您保持组织，避免不必要的重复工作。

![](img/B03918_05_14.png)

调整内容发现的选项。

**`内容发现`** 工具将会全面测试所有潜在未开发或隐藏的内容，满足您设定的标准（参见下图），您可以在**`内容发现`**对话框的**`站点地图`**子选项卡中查看这些内容。

我建议您在任何机会都使用过滤器。特别是站点地图，它是将您的信息减少到只有您感兴趣的内容的绝佳工具。只需点击**`过滤器：`**对话框，并调整设置以确保过滤掉所有非必要的信息。

![](img/B03918_05_15.png)

内容发现有助于完成站点地图。

#### 使用代理进行特定设置

现在，我们准备开始使用更自动化的工具。您可能更喜欢首先激活代理拦截或进入**Burp Spider**，但我倾向于首先使用**Burp Proxy**，避免使用*蜘蛛*，除非这是一个白盒测试，客户期望我们这样做。在目标阶段进行被动和手动映射后，代理应该能够帮助我们集中精力解决我们已经标记为目标软点的应用程序领域。只需在**`代理`**选项卡的**`拦截`**子选项卡中切换到*拦截已开启*即可激活代理。

当你浏览网站时，**`Proxy`**会拦截这些请求，并允许你更改任何字段以供你自己使用。这可能非常费力，所以一定要将这种亲自操作的过程限制在你认为需要人工干预的应用程序部分，或者作为熟悉自己的手段。一旦你认为需要进一步分析或调查，右键单击代理的**`HTTP history`**标签（查看下面的截图），并将表单或 URL 交给 Burp Suite 中的另一个工具，以更好地利用你的时间。例如，如果你需要尝试多次修改表单，**Burp Repeater**可以提供这个功能，并同时跟踪多个这样的请求。如果你想发起自动攻击，Burp Intruder 可以代表你处理这些攻击。**`Sequencer`**和**`Comparer`**也可以在这里启动。

![](img/B03918_05_16.png)

Burp Suite 使得从代理分析转移变得容易。

#### 使用 Spider 进行主动操作

**Burp Spider**是一个快速方便的工具，但我建议谨慎使用。Spidering 可以帮助加快任何渗透测试过程，但该工具的作者建议仅在非常庞大的应用程序的部分或时间紧迫且风险被时间表所抵消的情况下使用。也就是说，了解并掌握这个工具是非常值得的，以备不时之需。好消息是，我们都有足够的时间来掌握它。

Spider 的配置位于一个选项卡上（查看下面的截图），并且让我们可以访问一些设置，这些设置可以帮助我们限制这个喧闹工具对我们目标的影响，自动生成填充数据，尝试登录，并传递特殊的浏览器请求头。我建议不要更改的一个设置是**`Passive Spidering`**设置。取消选中**`Passively spider as you browse`**框会阻止 Burp 在你使用套件中的其他工具时自动识别链接和内容。假设你已经将所有设置调整到你喜欢的状态，你可以在**`Control`**选项卡中启动主动的 Spidering 会话。

![](img/B03918_05_17.png)

Spidering 设置很有用，但除非你确定，否则不要碰被动设置！

Burp 的**`Target`**、**`Spider`**和**`Proxy`**工具都提供了目标的出色侦察，并为我们提供了一个整合的站点地图和潜在漏洞的目录，供我们调查。尽管站点地图和问题的有序列表可以帮助我们在测试的后期阶段，但你无法测试你看不到或不知道存在的东西！现在你已经收集了所有这些信息，你可能想对它们做些什么。

### 激活 Burp Suite

Burp Suite 对我们来说如此宝贵的原因在于，我们可以快速从侦察阶段转入测试的利用阶段，这样我们就可以验证我们的发现，而不必手动协调外部工具。在这一部分，我们将看到 Burp 的**`Scanner`**、**`Intruder`**、**`Repeater`**和**`Sequencer`**如何帮助我们深入挖掘漏洞的工作列表，并帮助我们确定对我们目标的损害（或潜在的损害）。一些渗透测试方法的问题在于，开发这些方法的人认为更多的工具意味着更好的结果。然而，我认识的一些有多年经验的同行发现，他们在较小的公司或团队中使用完全集成的工具套件时，能够获得更广泛的覆盖、更一致的报告，以及更少的错误和痛苦。你的情况可能有所不同，但在已经存在集成工具集的情况下，集成和操作一系列工具可能更适合较大的渗透测试团队。

本节中的四种工具几乎可以从 Burp 的任何站点地图或菜单中启动，很可能您以前已经使用过 Intruder 和 Repeater。我们将在这里对它们进行审查，并提出一些建议，以便为您的测试部署它们的最佳方式。请记住，一些特定攻击向量（如 SQL 注入、跨站脚本和请求伪造等）的有趣细节将在后面专门章节中进行讨论，Burp Suite 将作为我们用来追踪它们的工具之一。

#### 寻找生命（或漏洞）

代理和蜘蛛有助于构建站点地图，但是用于测试页面、表单等是否存在漏洞的工具是什么呢？最广泛的工具是 Burp Scanner。毫无疑问——扫描器可以起到非常积极的作用，并在其主动模式下对目标发起攻击。因此，请确保您已经缩小了范围，并且清楚地知道您正在释放 Burp Scanner 去执行的确切主机，尤其是在使用主动扫描功能时。我相信正是因为这些深远的影响，扫描器才被保留给专业许可证用户。

如果您没有使用 Burp Suite 专业版，我仍然建议您了解扫描器提供的功能和价值，以帮助证明其费用的合理性；但至少，它可以为您提供一个衡量您选择的扫描替代方案的标准，无论是 Accunetix、w3af、ZAP 还是其他工具。

值得一提的是，不可能在一本书中涵盖所有的替代方案并且仍然能够制作出一本有用的书。渗透测试，就像任何其他技术领域一样，针对同一个问题有多种解决方案；并且与其他领域一样，所选的工具和方法将根据用户的背景和能力以及工作的要求而有所不同。我鼓励您深入研究这里讨论的工具，并根据自己的需求考虑其他选择。

对进行定期渗透测试的同事进行的快速调查显示，虽然许多人使用 Burp Suite 和扫描器，但大多数人并没有停下来思考每个工具在整个方案中的作用。简单回顾一下：扫描器通过获取在侦察阶段观察到的缓存请求，并修改它们以测试底层代码中可能存在的漏洞。通过表现行为，扫描器可以验证漏洞的存在或不存在。在这些操作过程中，目标很可能会受到影响，因此我们必须获得许可，了解影响，并采取措施警告客户并保护服务器，以防测试对其姿态产生不利影响。

Burp 的扫描器工具也与市场上的其他工具不同，因为这些扫描器通常同时爬行和扫描，而 Burp 扫描器提供了两种不同的模式：

+   被动模式：扫描器通常在被动模式下在后台工作，观察我们生成的流量，并实时评估请求和响应。这有什么好处呢？首先，它允许我们驱动扫描并与应用程序进行交互，当需要对话（凭据、表单输入等）时，它可以进一步进入应用程序的内部。其次，它不需要我们做任何工作——只需通过浏览器进行交互即可启动被动扫描模式。

+   主动模式：在主动模式下，扫描器可以在您浏览网站时进行实时主动扫描，并可以通过上下文菜单手动启动，通过向导进行一些配置后，对页面或应用程序的分支进行漏洞追踪。

我们还应该注意，扫描器能够测试服务器端和客户端代码的已知漏洞；这非常有用，因为它允许我们向客户提供全面的报告，帮助他们全面了解应用程序的性能。

Scanner 的功能有三个关键原因使 Burp 与其他 DAST 工具有所不同：

+   其他工具对服务器端漏洞的准确性可能会低得多，因为许多这些错误局限于服务器端环境，并且不会反映在客户端上，从而避免了测试人员的检测。

+   Scanner 还专注于测试它有权威实际测试的漏洞，因此那些最多在这里被错误发现的漏洞被省略，以确保 Burp 的输出是可信的，没有误报。

+   扫描器可以快速地允许切换到套件中的其他工具（无需配置或传输数据），因此总是有另一条路径可用。

现在我们了解了扫描器的优势和我们的责任，让我们更有效地使用它。

##### 被动扫描是一个不费脑筋的选择。

很可能您在自己的工作中一直在使用扫描器的这个功能，但以防它被关闭或配置错误，我们可以首先检查被动扫描是否已打开，方法是访问**`Scanner`**选项卡的**`Live scanning`**子选项卡，如下图所示：

![](img/B03918_05_18.png)

被动扫描配置为扫描所有流量。

选择被动模式**`Scanner`**扫描的流量方面，您可以访问**`Options`**子选项卡，并打开或关闭十一个类别，如下截图所示。我建议除非某个类别超出范围，否则都保持选中。被动扫描仅在您访问和交互的页面上实施，并且几乎没有风险会导致附带损害的扫描结果。

![](img/B03918_05_19.png)

被动扫描可以观察到大部分有趣的流量区域。

如下截图所示，被动扫描捕获了几个潜在的漏洞，并提供了问题的解释和潜在的补救步骤，以及原始请求和相应的响应信息，包括标头、任何相关的 HTML 或 XML 等。对于一个免费的扫描来说，这并不算太糟糕，而且不需要额外的时间要求或资源！

![](img/B03918_05_20.png)

Scanner 的结果是描述性和完整的，并提供了补救步骤。

##### 主动扫描——谨慎使用！

如前所述，主动扫描是对目标的攻击。请确保您的目标、主动扫描和妥协的许可，并且了解如果发现意外或足够严重以至于需要立即向客户披露的情况下，您的道德和法律责任。

与被动扫描类似，您可以首先检查主动扫描是否已打开，方法是访问**`Scanner`**选项卡的**`Live Scanning`**子选项卡。您可以选择停用它，使用目标范围运行，甚至使用自定义范围。然后，您可以在**`Options`**子选项卡上配置许多潜在的漏洞类型和引擎调整，如下截图所示：

![](img/B03918_05_21.png)

主动扫描选项涵盖了引擎、优化和漏洞领域。

**`Active Scanning Areas`** 部分允许您取消漏洞类型，如果您已经在另一个工具集中涵盖了它们。您还可以选择事件的子集，集中在特定集合上（在白盒测试中很常见），或进行增量测试。

手动主动扫描可以遵循相同的路径，但是由我们发起，而不是自动进行，如下截图所示。这可能是最好的折中方案——拥有主动扫描的所有功能，但只针对明确的路径或页面。

![](img/B03918_05_22.png)

手动主动扫描可以明确地专注于任何主机、页面或文件夹。

在两种主动扫描技术中，扫描将被添加到**`扫描队列`**子选项卡中；当您满意地排队了足够多的主动操作时，您可以选择尽可能多的扫描，右键单击，然后恢复扫描。**`扫描队列`**子选项卡将报告所有进度（查看下面的截图），您将看到您的**`扫描器`**在对所有选定的页面进行迭代以完全确认这些页面上的任何漏洞时所需的大量资源需求。

![](img/B03918_05_23.png)

对所有排队的操作进行主动扫描进度。

**`扫描器`**的结果是我们的目的（如下图所示）。Burp 为我们提供了列表，每个列表都附有描述和后续操作。

![](img/B03918_05_24.png)

主动扫描器的结果显示在我们的指尖上，包含所有相关信息。

#### 入侵者的飞行

Burp Suite 还包括一些更专注的工具，其中 Intruder 是其中之一，它允许对字段操作进行严肃的自动化，这对注入尝试和暴力攻击等事情非常有用。**Intruder**是一种超级模糊器。当我们找到一个 HTTP 请求，看起来很适合进行任何这类攻击时，我们可以确定我们认为可以调整的字段（Burp 称它们为**位置**），然后要求 Intruder 对 Burp 称为**有效负载**的每个字段应用，这些有效负载可以来自预先构建的列表，也可以通过一些经过验证的算法生成。因为 Intruder 可以在多个位置上执行此操作，所以它对我们来说是一个巨大的时间节省者，并提供了详尽的测试覆盖。

入侵者的多功能性是一个巨大的帮助。它可以帮助我们揭示帐户名称（通常通过运行潜在列表并观察不同的响应）。入侵者还可以将这些技术应用于对每个帐户的各种字段进行迭代，例如地址、电话号码、社会安全号码、银行信息等，这些信息可能与用户的帐户或个人资料相关联。最后，为了确保我们充分利用了工具，入侵者还是一个用于漏洞搜索的全功能模糊器，例如注入攻击或输入验证问题。掌握入侵者的能力对我们自己的测试来说是一个巨大的增强力量，幸运的是，这是一个非常直接的工具。

##### 停下来，列举并倾听！

如果我们使用入侵者来列举单个字段，最常见的是用户名或帐户 ID，那么这个过程就非常简单。我将尝试访问 Mutillidae 的登录页面（如下图所示），看看我们能否找出可以挖掘出的用户名。我会随便填一些胡言乱语，只是为了触发 Burp 代理中的请求/响应对（拦截已打开），除非我非常幸运，否则会收到*帐户不存在*的消息。

![](img/B03918_05_25.png)

在这些字段中，任何东西都可以开始，我们只需要看到请求！

在**`代理`**选项卡和**`HTTP 历史`**子选项卡中，我可以看到我的**`请求`**，包括我在点击发送之前填写的胡言乱语。我可以右键单击此请求（如下图所示）并单击**`发送到 Intruder`**进行严肃的列举功夫：

![](img/B03918_05_26.png)

让我们将此请求发送到 Intruder 进行列举的精彩表现。

我们应该看到**`Intruder`**选项卡的名称变成橙色-这意味着一个新的 Intruder 请求已经排队准备好行动！在第一个选项卡（未显示）中，我们可以看到服务器的 IP 地址和端口已经填好。转到**`位置`**子选项卡，您将选择**`狙击手模式`**；然后清除所有字段（Intruder，尽管可能很有帮助，但是想要自愿猜测所有的位置），然后只选择用户名的胡言乱语，然后点击**`添加`**，如下面的截图所示。您会注意到，您添加的任何字段现在都会在每个位置的开头和结尾添加`Â§`（`asdf`现在读作`Â§asdfÂ§`），并用橙色突出显示。如果我们要尝试对漏洞扫描进行模糊测试，我们将选择一个适合的位置（类似于 cookie 信息、POST 页面名称等）。这将给我们一个位置，我们可以对其应用有效负载。如果我们想要暴力破解凭据，我们可以添加第二个字段（密码），从而有两个位置可以应用有效负载。相当聪明，对吧？

那么，这个模式到底是什么意思呢？嗯，这里是一个快速摘要：

+   **Sniper**：**使用单一的有效负载集，Intruder 依次插入每个位置，并报告结果。这对于简单的猜测游戏或单一字段的关注非常有用。

+   **Battering ram**：**这使用单一的有效负载集，但同时将相同的有效负载应用到多个字段。这是我们在处理某些头部位置（如 cookies）时的首选模式。

+   **Pitchfork**：**稍后的模糊攻击可能会让我们拥有相关信息，但需要同时将匹配的集合应用到多个字段。Pitchfork 允许我们将这些匹配的集合（如凭据对、用户名和 ID 号等）发送到它们各自的字段。

+   **Cluster bomb**：**与 Pitchfork 不同，cluster bomb 在每个相关字段的所有组合中迭代多个有效负载集。因此，如果您需要尝试一个用户名与一个 ID 列表，以及另一个与所有这些相同的 ID，那么这就是适合您的模式！

![](img/B03918_05_27.png)

有效负载位置确定了我们希望 Intruder 进行模糊测试的区域

现在，我们可以按照下面的截图进入**`有效负载`**子选项卡，这样我们就可以决定如何在每个请求中改变每个位置。从字段类型的下拉列表中，我们会选择**`简单列表`**，然后我们可以从**`从列表中添加`**下拉菜单中选择用户名。关于这些的更多信息可以在[`portswigger.net/burp/help/intruder_payloads_types.html`](https://portswigger.net/burp/help/intruder_payloads_types.html)的出色 Burp Suite 文档中找到。

在密码或用户名模糊测试中，社会工程学和 OSINT 可以为您节省大量时间，而不是使用密码列表。

![](img/B03918_05_28.png)

有效负载可以生成，从文件中提取，或手动输入。

现在，我们将看到所有这些的结果。**`结果`**选项卡将显示每次迭代的情况，可以根据有效负载本身进行排序，但最有用的是根据**状态**类型（标准 web 状态）或响应的**长度**进行排序，这两者都可以帮助识别任何我们应该更仔细查看的奇怪行为。下面截图中的示例显示用户列表相当平淡，这意味着我们需要寻找非标准的用户名或创建更复杂或定制的列表来枚举用户。

![](img/B03918_05_29.png)

在这次 Intruder 运行中，只有一个事件突出显示出来-这是开始探索的好地方！

##### 选择，攻击，突出显示，然后重复！

本章我们将讨论的最后一个工具是 Burp Suite 的**`Repeater`**工具，其中 Intruder 允许您专注于一个或多个字段并应用特定的有效负载集。Repeater 更专注于应用字段修改以进行输入验证检查，甚至可以以不同顺序重放请求以测试业务逻辑。

Repeater 是套件中其他工具的很好的补充工具，就像其他工具一样，可以通过右键单击并选择**`发送到 Repeater`**选项来调用，这将自动产生一个**`Repeater`**任务选项卡（查看下面的屏幕截图）并预先配置所有基本设置。

![](img/B03918_05_30.png)

Repeater 允许我们对我们捕获的请求进行操作。

一旦我们得到了我们的消息，我们就可以决定如何修改每次迭代中的任何或所有字段，然后修改这些部署的顺序，如下面的屏幕截图所示。

![](img/B03918_05_31.png)

Repeater 给了我们精细的控制，可以按任何顺序排队任何组合的变量。

Repeater 实际上非常简单。但是，制定我们自己的事件重放的能力将在以后的基于业务逻辑的攻击中非常有帮助，我们将在后面的章节中讨论这些内容。

## 摘要

* * *

OWASP 的 ZAP 工具和 Burp Suite 构成了许多 Web 应用程序安全测试方法的主体，原因是充分的。基于代理的工具能够观察客户端和服务器之间的交易，而不必担心丢失会话信息的上下文。代理因此可以做外部分析无法做到的事情，即*看到*应用程序的端到端工作。当我们看到攻击者通常如何破坏或利用现代应用程序时，他们使用相同的技术来捕获来回的数据或插入自己的恶意意图。ZAP 和 Burp 为我们提供了一种方式来预防 MITM 方法，并全面测试应用程序抵御这些攻击。

在本章中，我们介绍了这两个软件包中使用的一些更通用的工具。我希望这种对基础的投资将帮助我们在后面的章节中实际完成许多更高级的任务，而不必重复这里介绍的基础知识。对于练习渗透测试人员来说，最好的方法就是练习。利用空间中许多可用的易受攻击的目标虚拟机，您可以解决问题，并确定哪些工具最适合您的风格和流程。

在下一章中，我们将实际上深入了解我们的第一个专注攻击的细节-**跨站脚本**（或**XSS**）。我们还将讨论各种形式的 XSS，它们的目标以及它们最适用的地方。我们还将看到如何使用 Burp 和一些补充工具如**BeEF**，**XSSer**，**Webslpoit**和**Metasploit**执行这些攻击。可以合理地假设我们将做一些有趣的事情，所以紧紧抓住！
