# 第一章：常见的 Web 应用程序和架构

Web 应用程序对今天的文明至关重要。我知道这听起来很大胆，但当你想到技术如何改变了世界，毫无疑问，全球化是世界各地通过互联网迅速交换信息的原因。虽然互联网是多方面的，但最有价值的组成部分是数据所在的地方。自 1990 年代万维网的出现以来，这些数据已经激增，目前世界上的数据产生量在未来 2 年内将超过所有已记录历史的数据总和。虽然数据库和对象存储是这一庞大数据的主要存储库，但 Web 应用程序是数据进出、被操纵和加工成可操作信息的门户。这些信息以动态方式呈现给最终用户在他们的浏览器中，这种相对简单和便捷是 Web 应用程序不可避免的主要原因。我们对 Web 应用程序如此习以为常，以至于我们中的许多人会发现在没有它们的情况下过几个小时是不可能的。

金融、制造、政府、国防、企业、教育和娱乐机构依赖于 Web 应用程序，这些应用程序使它们能够运作并相互交互。这些无处不在的门户被信任来存储、处理、交换和呈现各种敏感信息和有价值的数据，同时保护它们免受伤害。工业界对这些系统寄予了极大的信任。因此，对这些系统的任何损害或任何信任违反都可能并经常造成深远的经济、政治或身体伤害，甚至可能导致生命的丧失。新闻充斥着每天有关被攻击的 Web 应用程序的突发新闻。每一次攻击都导致信任的丧失，因为数据（从财务和健康信息到知识产权）被窃取、泄露、滥用和披露。公司遭受了无法挽回的损失，患者处于危险之中，职业终结，命运改变。这是沉重的事情！

虽然有许多潜在问题让建筑师、开发人员和运营商感到紧张，但其中许多问题发生的可能性非常低，只有一个重大例外。犯罪和地缘政治行为者以及活动人士对计算系统、网络以及所有连接或利用它们的其他人或事物构成明显的危险。糟糕的编码、不正确的实施或缺少的对策对这些对手来说是一种福音，为他们提供了进入或掩盖其活动的方式。潜在的攻击者看到制造混乱的机会，他们会投入更多、学习、发展新技术，然后实现更雄心勃勃的目标。这种循环不断重复。捍卫网络、系统和应用程序免受这些威胁是一项崇高的事业。

也存在防御性方法，可以帮助减少风险和最小化暴露，但渗透测试人员（也称为白帽黑客）确保它们能够胜任。通过像攻击者一样思考，并使用许多相同的工具和技术，渗透测试人员可以发现设计或实施中的潜在缺陷，并允许应用程序利益相关者填补这些空白，以防止恶意黑客（也称为黑帽黑客）利用它们。安全是一种旅程，而不是目的地，渗透测试人员可以成为引导其他利益相关者走向安全的向导。

在本书中，我假设您是一名对使用 Kali Linux 专门测试 Web 应用程序感兴趣或有经验的渗透测试人员，Kali Linux 是当今最流行的开源渗透测试平台。Kali Linux 及其工具的基本设置和安装在许多其他地方都有介绍，无论是 Packt 自己的《使用 Kali Linux 进行 Web 渗透测试-第二版》（作者 Juned Ahmed Ansari，可在[`www.packtpub.com/networking-and-servers/web-penetration-testing-kali-linux-second-edition`](https://www.packtpub.com/networking-and-servers/web-penetration-testing-kali-linux-second-edition)上找到），还是其他大量的书籍和网站。

在本章中，我们将讨论以下内容：

+   领先的 Web 应用程序架构和趋势

+   常见的 Web 应用程序平台

+   云和私有托管解决方案

+   常见的防御措施

+   本书将评估的架构软点的高层视图

## 常见的架构

* * *

在过去的 15 年里，Web 应用程序发展迅速，从早期的单片设计到分段式方法，更专业的部署实例现在主导市场。它们还在架构元素的托管方式上发生了变化，从纯粹的本地服务器到虚拟化实例，再到纯粹或混合云部署。我们还应该了解客户在这种架构中的角色可能有很大的变化。这种演变改善了规模和可用性，但涉及的额外复杂性和变化性可能会对不那么勤奋的开发人员和运营商产生负面影响。

整体 Web 应用程序的架构可能在物理上、逻辑上或功能上分割。这些类型的分割可能以组合的形式出现；在企业中跨应用程序集成如此普遍，这些边界或特征很可能总是处于过渡状态。这种分割有助于提高可伸缩性和模块化，分割管理领域以匹配人员或团队结构，增加可用性，并且在发生妥协事件时还可以提供一些急需的分割。这种模块化发生的程度以及功能在逻辑上和物理上如何分割，很大程度上取决于所使用的框架。

让我们讨论一些常用的逻辑模型以及一些突出的这些模型所实施的框架。

### 独立模型

大多数小型或临时网络应用程序在某个时候都托管在物理或虚拟服务器上，并且在单个单片安装中，这在简单的自托管应用程序中经常遇到，比如小型或中型企业网页、库存服务、售票系统等。随着这些应用程序或其相关数据库的增长，有必要将组件或模块分开，以更好地支持规模并与相邻的应用程序和数据存储集成。

这些应用程序倾向于使用常见的现成的 Web 框架，如 Drupal、WordPress、Joomla！、Django 或其他多种框架，每个框架都包括内容交付管理器和语言平台（例如 Java、PHP：超文本预处理器（PHP）、Active Server Pages（ASP.NET）等），以**超文本标记语言**（**HTML**）生成内容，并支持数据库类型或它们支持的类型（各种**服务器查询语言**（**SQLs**）、Oracle、IBM DB2，甚至平面文件和 Microsoft Access 数据库）。作为单个图像或安装介质，所有功能都驻留在同一操作系统和内存空间中。为这个模型选择的平台和数据库组合往往更多是开发人员的能力和偏好的问题。对负责团队进行社会工程和开源信息收集肯定会有助于描述 Web 应用程序的架构。

下图显示了一个简单的单层或独立架构：

![](img/B03918_01_01-1.png)

独立架构在历史上是首次遇到的，并经常是任何应用程序演变的第一步。

### 三层模型

在概念上，三层设计仍然被用作参考模型，即使大多数应用程序已经迁移到其他拓扑结构或尚未从独立实现中演变出来。虽然许多应用程序现在偏离了这个经典模型，但我们仍然发现它对于理解真实世界应用程序所需的基本设施是有用的。我们称之为三层模型，但它还假设了第四个未命名的组件：客户端。

三层包括 Web 层（或**前端**）、应用层和数据库层，如下图所示：

![](img/B03918_01_02.png)

三层架构提供了现代企业应用程序所需的更大的可伸缩性和专业化。

考虑每个层的角色是很重要的：

+   **Web 或呈现层/服务器/前端**：该模块提供**用户界面**（**UI**）、身份验证和授权、扩展规定以适应大量用户、高可用性功能（处理负载转移、内容缓存和容错能力）以及必须为客户端提供的任何软件服务或用于与客户端通信的服务。HTML、**可扩展标记语言**（**XML**）、**异步 JavaScript 和 XML**（**AJAX**）、**通用样式表**（**CSS**）、JavaScript、Flash、其他呈现的内容和 UI 组件都驻留在这一层，通常由 Apache、IBM WebSphere 或 Microsoft IIS 托管。实际上，这一层是用户通过其浏览器看到并与之交互以请求和接收其所需结果的地方。

+   **应用程序或业务层/服务器**：这是 Web 应用程序的引擎。由 Web 层处理的请求在这里执行，这是业务逻辑、流程或算法所在的地方。这一层还充当了多个数据库或甚至同一组织内或受信任的第三方应用程序的桥接模块。C/C++、Java、Ruby 和 PHP 通常是用来处理繁重工作并将数据库层的原始数据转换为 Web 层向客户端呈现的信息的语言。

+   **数据库层/服务器**：各种形式的大量数据存储在称为数据库的专门系统中。这些信息宝库被安排得可以快速访问，但不断扩展。经典的 SQL 实现，如 MySQL 和 ProstgreSQL，Redis，CouchDB，Oracle 等，通常用于存储数据，以及大量的抽象工具帮助组织和访问数据。在数据收集和处理的高端，有越来越多的超标量数据库架构，涉及**不仅仅是 SQL**（**NoSQL**），它与 Hadoop 等数据库抽象软件相结合。这些通常出现在声称是*大数据*或*数据分析*的任何东西中，如 Facebook，Google，NASA 等。

+   **客户端**：所有三个层都需要受众，而客户端（更具体地说，他们的浏览器）是用户访问应用程序并进行交互的地方。浏览器及其插件软件模块支持 Web 层以按照应用程序开发人员的意图呈现信息。

供应商拿到这个模型并对其进行修改，以突出他们的优势或更贴近他们的策略。例如，甲骨文和微软的参考 Web 应用程序架构将 Web 和应用程序层合并为一个层，但甲骨文着重于其在数据库方面的优势，而微软则大力扩展其附加服务列表，以增加对客户的价值（并为微软带来收入），包括负载平衡、认证服务以及与其自己操作系统在全球大多数客户端的联系。

### 模型-视图-控制器设计

**模型-视图-控制器**（**MVC**）设计是一个功能模型，指导信息和暴露的分离，并在一定程度上也解决了利益相关者用户通过角色分离的特权。这使应用程序能够使用户及其输入与后端业务流程、逻辑和交易分离，从而避免了早期架构中的数据泄漏。MVC 设计方法实际上是由厚应用软件开发人员创建的，并不是服务和组件的逻辑分离，而是基于角色的分离。现在，Web 应用程序通常必须在跟踪和执行角色的同时进行扩展，Web 应用程序开发人员已经将其适应了他们的使用。MVC 设计还促进了代码重用和并行模块开发。

MVC 设计可以在以下图中看到：

![](img/B03918_01_03.png)

模型-视图-控制器设计侧重于角色，而不是功能，并经常与功能架构结合在一起。

在 MVC 设计中，这四个组件如下：

+   **模型**：模型作为应用程序的真相源，维护和更新数据对象，具有使应用程序有价值的规则，逻辑和模式。它不了解用户，而是接收来自控制器的调用，以处理对其自身数据对象的命令，并将结果返回给控制器和视图。另一种看待它的方式是，模型决定了应用程序的行为。

+   **视图**：视图负责向用户呈现信息，因此负责内容传递和响应：从控制器接收反馈和从模型接收结果。它构建用户查看和交互的界面。视图是用户看到应用程序工作的地方。

+   **控制器：** 控制器充当视图和模型之间的中央链接；在接收来自视图用户界面的输入时，控制器将这些输入调用转换为模型执行的请求。这些请求可以更新模型并执行用户的意图，或者更新向用户呈现的视图。控制器是使应用程序交互的部分，允许外部世界刺激模型并改变视图。

+   **用户：** 与早期模型一样，用户是设计的一个推断*组件*；事实上，整个设计将围绕如何使应用程序向客户提供价值展开。

请注意，在 MVC 模型中，对软件模块的细节很少给出，这是有意为之的。通过专注于角色和职责的分离，软件（现在是 Web）开发人员可以自由地创建自己的平台和架构，同时使用 MVC 作为基于角色的分割的指南。将这与独立或 3 层模型对应，我们会发现它们以非常不同的方式思考同一件事。

MVC 确实灌输了一种状态感，这意味着应用程序需要跟踪会话信息以保持连续性。这种连续性驱使了对 HTTP cookie 和令牌的需求，以跟踪会话，这本身就是我们的应用开发人员现在应该找到安全方式来保护的东西。大量使用应用程序编程接口（API）也意味着现在有更大的攻击面。如果应用程序只呈现数据库层中存储的一小部分数据，或者应该更有选择地填充信息以避免泄漏，通过在模型中保留太多信息，当配置错误或遭到侵犯时可以访问。在这些情况下，MVC 通常被视为一种方法论，因为在其中管理数据曝光可能会很困难。

需要注意的是，MVC 设计方法可以与功能的物理或逻辑模型相结合；实际上，使用一些 MVC 设计原则的平台支持大多数当今的 Web 应用程序。

## Web 应用程序托管

* * *

应用程序或其模块的位置直接影响我们作为渗透测试人员的角色。目标应用程序可以位于从物理到虚拟，到云托管组件，或三者的组合的连续体上的任何位置。最近，第四种可能性已经出现：容器。主机选项的连续体及其相对规模和安全属性如下图所示。请记住，这里显示的日期与每种可能性的流行度上升有关，但任何主机可能共存，事实上，容器可以在云端或本地数据中心中同样良好地托管。

这种演变在以下图中可以看到：

![](img/B03918_01_04.png)

主机选项已经发展，以更好地支持灵活和动态的部署-大多数客户在多个地方部署。

### 物理主机

多年来，应用程序架构和设计选择只需考虑物理的、基本的主机来运行架构的各个组件。随着 Web 应用程序的扩展和整合专门的平台，需要添加额外的主机来满足需求。随着数据集变得更加多样化，需要添加新的数据库服务器，需要添加额外的应用程序服务器来整合额外的软件平台，等等。劳动力和硬件资源都专门用于每个额外的实例，但它们增加了成本、复杂性和浪费到数据中心。工作负载依赖于专用资源，这使它们既脆弱又不灵活。

### 虚拟主机

虚拟化已经大大改变了这一范式。通过允许硬件资源被汇集并逻辑地分配给多个客户系统，一个硬件资源池可以包含所有不同的操作系统、应用程序、数据库类型和其他应用程序必需品，这些都在同质化的服务器池中提供了集中管理，并以优先方式动态分配接口和设备给多个组织。特别是 Web 应用程序受益于此，因为虚拟化的灵活性提供了创建并行应用程序环境、数据库克隆等的手段，用于测试、质量保证和增加容量。由于系统管理员现在可以在相同的资源池上管理多个工作负载，硬件和支持成本（例如电力、楼层空间、安装和配置）也可以减少，假设许可成本不会抵消固有的效率。许多应用程序仍然在虚拟的本地环境中运行。

### 注意

值得注意的是，虚拟化还引入了应用程序、系统管理和网络团队之间的新紧张关系，责任的转移涉及到安全相关方面。因此，职责可能不清楚，没有得到适当履行，甚至没有被考虑到。听起来像是一个很好的渗透测试机会！

### 云托管

亚马逊在 2006 年将托管虚拟工作负载的概念推进了一步，并引入了云计算，微软 Azure 和其他公司随后也跟进。通过互联网提供高度可靠的基础设施，承诺提供即插即用的软件即服务（SaaS）使公司能够构建应用程序，而无需投资于硬件、带宽，甚至房地产。云计算应该取代私有云（传统的本地系统），确实有一些组织已经实现了这一点。然而，主要趋势是大多数企业在私有云和公共云之间看到应用程序的分裂，这取决于这些服务的类型和稳定的需求。

### 容器-一种新趋势

容器提供了并行或替代的打包方式；与虚拟机中包含整个操作系统和模拟硬件不同，容器只带来它们的独特属性，并共享这些常见的附属和功能，使它们更小更灵活。这些特点使得像谷歌和 Facebook 这样的大公司能够实时扩展到用户的激增需求，响应时间为微秒，并完全自动化容器工作负载的生成和销毁。

那么，这对我们意味着什么？Web 应用程序的位置和打包方式影响其安全姿态。通常，私有云和公共云托管的应用程序将与可能跨越两个域的其他应用程序进行集成。这些集成点提供了潜在的威胁向量，必须进行测试，否则它们肯定会成为攻击目标。云托管的应用程序也可能受益于由服务提供商托管或提供的保护，但它们也可能限制防御选项和支持的 Web 平台的多样性。了解这些限制可以帮助我们专注于我们的探测和消除不必要的工作。托管范式还决定了我们所遇到的防御者和操作者团队的构成。云托管公司可能拥有更有能力的安全运营中心，但应用程序安全责任的分工可能导致情报的分散，并提供可以用来利用目标的空白。可用的虚拟化和操作系统也将影响应用程序平台的选择、周围的安全机制等等。

## 应用程序开发周期

* * *

应用程序开发人员遵循有助于按计划和预算保持进展的流程。每个开发应用程序的公司无疑都会有自己的流程，但这些流程的共同元素将是各种阶段：从构思到交付/运营以及任何所需的审查、可交付物期望、测试流程和资源需求。

Web 应用程序中常用的开发流程是应用程序或软件开发生命周期（SDLC），如下图所示，摘自[`commons.wikimedia.org/wiki/File:SDLC_-_Software_Development_Life_Cycle.jpg`](https://commons.wikimedia.org/wiki/File:SDLC_-_Software_Development_Life_Cycle.jpg)：

![](img/B03918_01_05.png)

每个现代应用程序开发人员都遵循 SDLC 或类似的流程。

无论公司的发展过程中定义了什么阶段，都很重要在每个阶段都加入测试，包括渗透测试，以在尽可能成本效益的阶段减轻风险。

我曾见过政府开发项目由于在周期早期不考虑安全和安全测试而迅速超支。在这些项目中，项目管理通常推迟了任何安全测试，直到产品离开实施阶段，认为测试阶段是为了包含所有验证活动。在这个阶段捕捉错误、缺陷或安全漏洞需要大量的重做、重新设计或解决方案，严重影响了进度和预算。

### 与开发团队协调

减轻威胁和影响整体进度的成本是早期测试的最基本原因，通常是开发周期的一部分。如果您是在多学科团队中工作的测试人员，早期协调的渗透测试可以消除缺陷并在它们变得具体和昂贵之前解决安全问题。渗透测试要求应该是任何验证和验证测试计划的一部分。此外，开发团队应在需求和设计阶段全程包括应用程序安全专家，以确保应用程序设计时考虑了安全性，这是 Web 应用程序渗透测试人员很擅长提供的视角。

有来自组织如 OWASP（[`www.owasp.org/index.php/Testing_Guide_Introduction)`](https://www.owasp.org/index.php/Testing_Guide_Introduction)）、SANS（[`www.sans.org)`](https://www.sans.org)）和美国计算机紧急响应小组（[`www.us-cert.gov/bsi/articles/best-practices/security-testing/adapting-penetration-testing-software-development-purposes)`](https://www.us-cert.gov/bsi/articles/best-practices/security-testing/adapting-penetration-testing-software-development-purposes)）的参考资料，可以帮助指导渗透测试流程适应公司自己的开发周期。这种早期和经常性策略的价值应该很容易向管理层表达，但针对特定 Web 应用程序漏洞和安全风险的具体建议可以在安全报告中找到，例如由 WhiteHat Security, Inc.准备的报告（[`info.whitehatsec.com/rs/675-YBI-674/images/WH-2016-Stats-Report-FINAL.pdf`](https://info.whitehatsec.com/rs/675-YBI-674/images/WH-2016-Stats-Report-FINAL.pdf)），以及来自 Verizon、Cisco、戴尔、麦克风和赛门铁克等大公司。在整个开发过程中，必须有公司赞助，以确保网络安全得到充分和持续的考虑。

### 部署后-持续警惕

测试不应该只是为了“打勾”而完成一次，然后不再重访。Web 应用程序很复杂；它们重复使用了大量由各种组织和项目贡献的代码库。近年来，漏洞的数量显然有所增加，2014 年和 2015 年是攻击常见开源库非常活跃的一年。诸如 Heartbleed、SSLPoodle 和 Shellshock 等攻击都利用了这些开源库，这些库在某些情况下支持了当今超过 80%的 Web 应用程序。管理员可能需要数年时间来升级服务器，而随着已记录的弱点数量不断增加，跟进可能会很困难。例如，2016 年是 Adobe Flash、Microsoft Internet Explorer 和 Silverlight 漏洞的一年。对于整个社区来说，不可能监督每一种基本构件的使用情况，而 Web 应用程序的所有者可能根本不知道这些模块被包含在其中。

同一组测试的应用程序应该在定期间隔内继续进行分析，以确定它们随时间的风险暴露。同样重要的是要确保尽可能经常地使用不同的测试方法，如果可能的话，使用不同的团队，以确保考虑到所有角度。这种测试有助于通过在测试和演进阶段提供所需的安全反馈来完成 SDLC，以确保应用程序不仅可以整合新功能，而且可以在潜在攻击者之前发展一步。强烈建议您建议您的客户资助或支持这种测试，并雇佣内部和一些外部测试团队，以便这些发现能够像功能增强一样进入补丁和修订计划。

## 常见弱点 - 从哪里开始

* * *

Web 应用程序渗透测试侧重于对应用程序、软件框架和平台进行彻底评估。Web 渗透测试已经发展成为一个专门的学科，与网络、无线或客户端（恶意软件）测试分开。我们很容易理解为什么最近的趋势表明几乎 75%的报告的网络攻击都集中在 Web 应用程序上。如果我们从黑客的角度来看，这是有道理的：

+   门户和工作流程非常定制化，在开发过程中隔离它们免受所有矢量的影响并不是一件小事。

+   Web 应用程序必须向外部世界开放，以使用户能够真正使用它们。过多的安全性被视为负担，可能会成为开展业务的潜在障碍。

+   防火墙和入侵系统在防范基于网络的攻击方面非常有效，但不一定参与 Web 门户的交付。

+   这些应用程序向外部用户呈现可能是专有或敏感的数据。他们的工作就是利用这种信任来暴露大量高价值信息。

+   Web 应用程序攻击通常可以在没有基于文件的侵入的情况下暴露整个数据库，使归因和取证变得更加困难。

本章的大部分内容旨在向您介绍目标的架构方面。对客户应用程序的深入了解将使您能够将精力集中在最有意义的测试上。

让我们再次看一下典型的 3 层应用程序架构（如下图所示*），看看我们应该调查的潜在问题：

![](img/B03918_01_06.png)

有害的 Web 应用程序攻击侧重于应用程序架构的各个方面 - 我们也应该如此。

这些潜在的向量是我们将进行测试的一些主要威胁；在某些情况下，我们将包括一系列类似的攻击类型。它们显示了它们在典型的 3 层设计中的典型位置，攻击通常会生效，但攻击者本身通常位于公共 Web 层，很像合法客户端。随着我们的讨论，我们将按以下方式对我们将讨论的攻击类型进行分组：

+   身份验证、授权和会话管理攻击：这些攻击（以及我们的测试）侧重于应用程序本身验证特定用户的身份并强制执行特权的严格程度。这些测试将专注于说服 Web 层我们属于这个对话。

+   跨站脚本（XSS）攻击：XSS 攻击涉及操纵客户端或 Web 和/或应用程序层，将有效会话的流量或注意力转向敌对位置，这可以使攻击者通过脚本利用有效客户端。劫持尝试通常也属于这一类别。

+   注入和溢出：各种攻击在 3 层设计中的各个位置找到机会，强迫应用程序在测试范围之外工作，通过注入代码，这可能是底层模块允许的，但应用程序的实施应该禁止。大多数这些注入（SQL、HTML、XML 等）可以迫使应用程序泄露不应该允许的信息，或者它们可以帮助攻击者找到管理特权，以便自己发起简单的转储。

+   中间人（MITM）攻击：会话劫持是黑客或测试人员在不被任何一方知晓的情况下拦截会话的一种方式。在这样做之后，黑客有能力操纵或*模糊*请求和响应，以操纵一方或双方，并揭示比合法用户实际寻求或有权获得的更多数据。

+   应用程序层攻击：一些应用程序未配置正确验证输入，无论是在验证操作输入方式还是在授予文件访问权限方面。通常也会看到应用程序在强制执行真正基于角色的控制方面存在不足；特权升级攻击经常发生，使黑客可以为所欲为。

## Web 应用程序防御

* * *

如果我们退一步思考客户所面临的问题，真的是令人震惊。构建安全的 Web 应用程序和网络就像建造核反应堆一样。没有细节是微不足道的，所以即使设计和实施中存在很多优点，一个微小的失败（裂缝、弱焊接或微小的污染）也可能意味着失败。同样的真相也影响着 Web 应用程序安全 - 只有一个缺陷，无论是在众多组件中的配置错误或遗漏，都足以为攻击者提供足够的空隙，通过这个空隙可以造成巨大的破坏。再加上这个额外的问题，这些积极的防御措施在许多环境中被依赖于帮助检测这些罕见事件（有时被称为黑天鹅事件）。网络和应用程序管理员的工作很艰巨，我们的目的是帮助他们和他们的组织更好地完成这项工作。

Web 应用程序框架和平台包含条款来帮助确保它们免受恶意行为者的侵害，但它们很少单独部署在生产系统中。我们的客户通常会部署网络防御系统，这些系统还可以增强其应用程序的保护、意识和抵抗攻击的能力。在大多数情况下，客户将与更多的元素关联起来，以提供更深层次的防御，并假设更高水平的保护。与其应用平台提供的措施一样，这些额外的系统只有在负责安装、配置、监视和将这些系统整体地整合到架构中的流程和人员负责时才能发挥作用。最后，鉴于这些应用在企业中的特殊地位，客户的各种利益相关者很可能已经采取了错误的解决方案来防范我们将要测试的攻击形式。我们必须努力评估目标并教育客户。

### 标准防御元素

那么，系统的哪些元素适合在这里？以下图显示了与 3 层设计相关的 Web 应用程序路径中涉及的最常见元素：

![](img/B03918_01_07.png)

大多数严肃的 Web 应用程序将包括防御措施来阻止我们的努力，但所有安全元素的有效性都取决于它们的最新补丁、配置和监视操作员。

典型 Web 应用程序防御的关键外部元素包括：

+   防火墙（FW）：安全方面的第一个重点元素通常是边界或互联网边缘防火墙，负责执行各种访问控制和策略，以减少企业的整体攻击面，包括 Web 应用程序。防火墙市场的最新进展已经看到防火墙成为**下一代防火墙**（**NGFW**），其中这些策略不再由严格的源和目的端口和 IP 地址对定义，而是以上下文方式，包括对话中的用户或组，地理位置，声誉或外部参与者的类别，以及对话的应用或目的。

+   **负载均衡器**：许多规模化设计依赖于负载均衡器来将工作负载无缝分配给一组 Web 服务器。虽然这样做是为了使应用程序能够接触更多用户，但这个功能通常与一些类似代理的功能相对应，可以隐藏实际的 Web 层资源，使黑客无法窥视。一些负载均衡器解决方案还包括面向安全的服务，除了它们的虚拟 IP 或反向代理功能。在功能上，它们可能包括 Web 应用程序防火墙功能。负载均衡器在帮助提供分散式拒绝服务（DDoS）保护方面也很重要，可以分散、转移或吸收恶意流量负载。

+   **Web 应用程序防火墙（WAF）**：WAF 提供应用层检查和防止攻击，以确保我们在本书中将尝试的许多利用要么不可能要么难以执行。这些防火墙与边界的网络防火墙不同，因为它们只检查 HTTP/HTTPS 流量以防范攻击。WAF 往往非常依赖签名，并必须与其他防御解决方案结合使用，以提供其他向量的覆盖。

### 额外的层

在上述图表中未显示的是可能作为防御措施的其他措施，这些措施可以作为防火墙的功能或独立地在环境的一个或多个阶段运行。各种供应商在各种市场类别和能力集中推广这些解决方案。尽管品牌可能有所不同，但它们可以分为几个主要类别：

+   **入侵检测/防范系统（IDS/IPS）**：这些关键元素为企业提供深度数据包检查功能，以检测原子和基于模式的（异常）威胁。在经典实施中，这些对于 Web 应用程序几乎没有价值，因为它们缺乏对黑客用来发起常见 Web 应用程序攻击的看似有效有效负载的各种操纵的洞察。**下一代 IPS**（**NGIPS**）可能会提供更多的保护，因为它们不仅处理经典的 IDS/IPS 算法，还结合上下文和滚动基线来识别异常交易或交互。这些工具也可以集成在网络防火墙或环境的各个层之间。更新的 NGIPS 技术可能具有检测常见 Web 漏洞的能力，这些工具在保护使用未打补丁或配置错误的软件模块的目标系统方面表现出了巨大的价值。

+   **网络行为分析（NBA）**：这些工具利用网络元素的元数据来查看趋势并识别异常行为。从 Syslogs 和流量源（Neflow/IPFIX、sFlow、jFlow、NSEL 等）获取的信息不会提供 IPS 可以获取的同样深入的数据包信息，但从网络中的许多流中获取的趋势和模式可以提示操作员存在非法提升凭证的行为。在 Web 应用程序中，更严重的特权攻击可能会被 NBA 工具识别出来，以及文件和目录抓取攻击。

提到的所有组件都可以以多种形式实施：从各种物理设备类型到虚拟机到云服务。更复杂的 Web 应用程序通常会差异化地使用多个层，以提供更强大的抵御攻击的能力，以及为地理上分散的托管站点提供全面的功能。例如，一家公司可能有 10 个地点，全球负载平衡以为客户提供服务。在这种情况下，基于云的负载均衡器、WAF 和防火墙可能提供第一层防御，而每个数据中心可能有额外的层，不仅提供本地 Web 应用程序保护，还提供特定于该站点的其他关键服务。

### 注意

组合是无限的，但请记住，随着部署的安全解决方案复杂性的提高，它们被配置错误的可能性也会增加。我们的侦察工作和随后的渗透测试计划需要考虑这些变量。

## 总结

* * *

由于这是一本关于*精通*Kali Linux 以进行 Web 应用程序渗透测试的书，也许会让人惊讶，我们从架构、安全元素等基础主题开始。我希望涵盖这些主题将帮助我们区别于通常进行渗透测试但提供最小价值的脚本小子。任何人都可以启动 Kali Linux 或其他发行版并开始黑客攻击，但没有这个基础，我们的测试可能会不完整或不准确。我们的有利就业取决于实际帮助客户推动他们的网络达到（商定的）极限，并帮助他们发现他们的弱点。同样，我们还应该向他们展示他们做得对。黑山信息安全公司的所有者和分析师约翰·斯特兰德喜欢说

> 我们应该努力在表现出色后被抓住

.Â

虽然工具和基础协议的知识通常是严肃黑客与新手之间的区别，但也是对他们的目标和所提供服务的深度的了解。如果我们只是为客户运行脚本并报告明显的问题，那么我们就错过了成为雇佣渗透测试人员的要点。是的，关键缺陷需要解决，但看似较小的问题也需要解决。专家才能发现潜在的缺陷，即使现在不影响性能，但将在以后导致重大灾难。这不仅适用于发电厂，也适用于我们的 Web 应用程序。我们需要不仅向他们展示他们自己可以看到的东西，还要进一步帮助他们防范明天的攻击。

在本章中，我们讨论了一些架构概念，这些概念可能帮助我们更好地了解我们的目标。我们还讨论了客户可以采取的各种安全措施，我们需要意识到这些措施，既要规划我们的攻击，也要测试其有效性。我们的讨论还涵盖了在应用程序的整个生命周期中进行测试的重要性。这样做既节省时间和金钱，也可以在应用程序投入生产后保护声誉并最小化风险。这些考虑应该使渗透测试人员成为任何开发团队的重要和永久成员。

在我们的下一章中，我们将简要讨论如何准备一个功能齐全的沙盒环境，可以帮助我们练习测试概念。我们还将讨论可以帮助我们提供全面测试覆盖的主要测试框架。最后，我们将讨论合同以及我们工作的道德和法律方面；避免入狱是一个关键目标。
