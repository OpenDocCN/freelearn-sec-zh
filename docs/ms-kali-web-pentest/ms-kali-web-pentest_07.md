# 第八章：通过加密测试利用信任

商用加密和密码方法的发展对于互联网作为全球经济引擎的采用至关重要。网络已经走过了很长的路，从早期的浏览器如 Erwise 和 Mosaic 向主要教育用户提供静态、开放信息的日子。很难想象网络曾经是纯文本的时代，信息在没有任何防盗或窥探保护的情况下传输（以及存储）。现在，互联网促进的金融、个人和知识交易受到数学驱动算法的保护，如安全套接字层（SSL）/传输层安全性（TLS）、高级加密标准（AES）、安全散列算法（SHA）和 Diffie-Helman（DH）。这些标准以及更多，再加上用于共享密钥的广泛基础设施，使我们能够信任这些交易。这种信任是可以理解的；消费级电子产品和开源软件可以轻松实现加密技术，以提供信息安全的三个关键原则；保密性、完整性和可用性（CIA）。当然，这假设每个人都在使用正确的标准和协议，并且它们被正确配置。

针对加密方法（以及相关领域，如隐写术）的攻击通常避免尝试破解加密本身。苹果公司与美国司法部之间关于 iPhone 后门的战斗说明了这一点；加密通信是廉价且容易的，但要破解相同的加密却非常困难。攻击者可能会试图在加密之前拦截信息，或者在接收方解密后拦截信息。从技术上讲，这更容易，但从实际上讲，他们必须在这些主机上。欺骗发送方和接收方；源和目的地相信他们自己的系统是两个感兴趣的方之一会更容易吗？这本质上就是中间人攻击，其用途远不止拦截。

中间人攻击在许多形式的黑客攻击中很受欢迎；捕获凭据、导致恶意软件传递的污染的网络流量、重定向到恶意门户，或者收集和潜在操纵流本身都是可能的。防御这些恶意用途变得更加困难，因为相同的技术在企业中也有合法用途。Web 代理和防火墙使用 SSL/TLS 中间人攻击是有益的，帮助隐藏和保护最终用户和他们的客户端，允许进行全面检查和内容过滤，并确保免受拒绝服务攻击和隐私侵犯。只要这两种相反的用途存在，攻击者就可以利用它们来黑客我们的客户。

我们必须能够发现和验证所有可察觉的缺陷，无论是通过规避还是中间人攻击。在本章中，我们将看到加密是如何在 Web 应用程序通信中使用的，窥视加密会话，并使用中间人攻击规避加密或突破加密。在本章中，我们将讨论以下主题：

+   学习如何持久攻击者可以通过 OpenSSL，SSLyze 和 SSLscan 检测到弱密码的妥协以及我们如何检测它们

+   体验我们如何对安全连接执行中间人攻击，发现有趣的有效载荷，并使用 SSLsplit 和 SSLsniff 进行操纵。

+   通过充当中间人并使用 SSLstrip 从流中删除加密来完全击败 SSL

## 你的秘密有多保密？

* * *

据估计，SSL/TLS 在网络流量中的使用率超过 60％，并且由于公众对黑客和政府的窥探和拦截的看法，我们应该预计这一比例将继续上升。虽然在实践中很困难，但如果获取的数据价值足够大，攻击者的时间确实是值得的。OWASP 的十大威胁列表在多个周期中都将**敏感数据暴露**列为最严重的威胁，2013 年和 2017 年的版本都将其排名为第 6 位：对 Web 应用程序最令人担忧的威胁。

在他们的敏感数据暴露部分的总结中（如下图所示），如果 Web 开发人员正确配置并使用当前技术和模块版本来提供保护，那么将会更加困难。我们的测试中相当大一部分将围绕检查过时的软件包、不足的密钥强度和配置错误的端点展开。也就是说，如果所有这些事情都得到了正确的配置，我们将看到一些中间人攻击如何帮助克服这种保护。

![](img/B03918_08_01.png)

OWASP 的破坏身份验证和会话劫持特征化

在开始之前，了解我们正在讨论的加密应用程序的类型是有帮助的。鉴于它在信息技术中的广泛应用，我们需要将此讨论范围限制在 Web 服务器及其服务器-客户端关系的范围内。即使在这种情况下，存在许多潜在的拓扑结构，但它们都有一些共同的元素，如下图所示：

![](img/B03918_08_02.png)

基本 SSL/TLS 结构和攻击点

一种不断增长的攻击手段涉及利用 DNS 和 PKI 基础设施来增强中间人攻击，并欺骗警惕的客户端，使其相信它们确实连接到适当的服务器或合法的代理（未显示）。这里的每个元素都将有自己的能力。我们作为测试人员的工作是找出哪些元素正在损害端到端的完整性。

## 像专业人士一样评估加密

* * *

通过连接到应用程序并查看协商的内容，可以简单地识别和验证应用程序的加密配置和潜在缺陷。这可能是相当费力的，所以幸运的是我们有一些快速扫描工具，可以系统地协商服务器的所有潜在配置，以更好地帮助我们了解它们允许的内容。

我仍然建议花一些时间学习如何手动测试 SSL/TLS，因为随时进行快速检查以确保版本、密码偏好和类似内容是非常方便的。[`www.exploresecurity.com/wp-content/uploads/custom/SSL_manual_cheatsheet.html`](http://www.exploresecurity.com/wp-content/uploads/custom/SSL_manual_cheatsheet.html)提供了一份很好的说明和备忘录。

### SSLyze-它切片，它扫描â�¦

在这方面，我们的第一个工具可能是你唯一需要的工具。用 Python 编写的 SSLyze ([`github.com/iSECPartners/sslyze`](https://github.com/iSECPartners/sslyze))将使用几乎任何当前使用的传输协议与服务器进行通信，并且速度很快！通过在所有类型的协议上启动 StartTLS 握手与服务器进行通信，它可以扫描密码套件问题，协商缺陷，证书不一致以及许多在新闻中引起关注的 SSL 相关漏洞（Heartbleed，CRIME 等）。

使用 SSLyze 是小菜一碟；您可以选择一些选项进行传递，然后同时测试多个服务器。这些选项可以帮助细化被测试的版本，与连接相关的超时和重试，添加客户端证书或*cert*以进行相互认证测试，并测试压缩和恢复。我倾向于使用常规选项和 Heartbleed 模块，并将输出写入文本文件。在这个例子中，我们将针对网站[www.hackthissite.org](http://www.hackthissite.org)运行：

```
sslyze [Options] [host:port | host]
sslyze ; regular ; heartbleed www.hackthissite.org:443 >>hackthissite.txt
```

如您在下面的截图中所见，SSLyze 为我们提供了大量的测试。我将广泛的输入转储到文本文件中，以更好地剪裁空白部分，但它们提供的主要见解领域是对站点的完整健康检查。

![](img/B03918_08_03-861x1024.png)

SSLyze 扫描输出

如您从输出中所见，有很多内容需要消化。第 1 部分概述了工具的实例化和基本连接。如果服务器输入不正确，脚本将在此退出。第 2 部分（为简洁起见剪裁）涵盖了使用已知的受信任的 PKI 证书颁发机构进行证书检查，以确保证书充分关联。证书存在问题可能会使攻击者假冒合法服务器的身份，从而劫持流量用于其自己的恶意需求。第 3 部分将帮助我们查看与插件相关的特殊压力测试的结果，例如 Heartbleed 模块和服务器的会话恢复能力。第 4 部分突出显示了可用的密码；支持较弱或已知易受攻击的密码套件的服务器只会招来麻烦。第 5 部分非常直接；扫描花了多长时间？过去，在测试 Cisco 防火墙时，推断启用和协商的密码套件的手动过程可能需要几个小时。还不错，但偶尔可能会提供不同的结果，因此让我们看看另一个工具，它可以帮助交叉检查并为我们提供另一个数据点。

### SSLscan 也可以！

SSLscan 是 Kali 中提供的另一个工具，擅长自动化扫描过程，帮助我们评估软件版本、使用的密码以及安全连接的许多其他方面。SSLscan 是用 C 语言构建的，利用了 OpenSSL 1.0.1 库，也是跨平台的，因此如果您需要 Microsoft Windows 或 Mac OS 版本的应用程序，它们是可用的。SSLscan 的选项更加简单直接，它们有助于文件简洁，虽然这使得它非常容易运行，但同时也有助于运行另一个具有更多 PKI 方面细节的工具。要运行 SSLscan，您可以简单地使用以下语法进行扫描：

```
sslscan [Options] [host:port | host]
sslscan www.hackthissite.org
```

如您从下面的截图中所见，它提供了更紧凑的输出，但其中一些是以牺牲证书检查和细节为代价的，这些在您的渗透测试中可能会有用。使用相同的颜色代码和编号方案来帮助与 SSLyze 输出形成对比：第 1 部分概述了工具的基本连接测试；第 2 部分显示了较少冗长的证书检查；第 3 部分仅限于 Heartbleed 扫描结果；第 4 部分突出显示了可用的密码。虽然没有包括计时器，但在对常见站点进行测试时，其时间与 SSLyze 相当。

![](img/B03918_08_04.png)

SSLscan 扫描输出

在这种特殊情况下，两个工具都检测到了相同的首选密码套件**`ECDHE-RSA-AES128-SHA`**，但在一些测试中，人们报告了 SSLyze 正确解释或协商与 SSLscan 相同的密码套件时出现了一些问题。这样的问题需要运行两个工具并使用手动分析来解决任何冲突。 Kali 发行版中的另一个工具**tlssled**，根据底层 SSLscan 结果重新格式化输出为摘要样式视图，但除了 SSLscan 的功能外，几乎没有其他功能。

### Nmap 也具有 SSL 技能

我们将要研究的最后一个通用 SSL/TLS 扫描工具是备受推崇的**Nmap**。配备了一个特定于任务的脚本（`ssl-enum-ciphers`），Nmap 可以枚举主机上所有可用的密码，并根据当前最佳实践为每个密码提供评分。虽然它缺乏 SSLyze 和 SSLscan 的完整性，但这个功能使它成为向客户提出建议的有用且知名的引擎。

以下屏幕截图中的输出显示了针对 OWASP BWA 本身（主页，而不是特定应用程序）的扫描可能是什么样子：

```
nmap -sV ; script ssl-enum-ciphers -p 443 www.hackthissite.org 
```

![](img/B03918_08_05.png)

Nmap 与 ssl-enum-ciphers 扫描输出

## 利用漏洞

* * *

一旦您扫描了 SSL/TLS 密码问题或证书问题，就可以做很多工作来寻找攻击者将使用的特定弱点，这些攻击也可以通过我们已经在之前章节中访问过的一些工具来传递。让我们看看一些更著名的漏洞。

### POODLE â�� 只会吠，不会咬（通常）

**降级遗留加密的填充 Oracle**（**POODLE**）（CVE-2014-3566）是一种漏洞，它利用了对受影响的 SSLv3.0 **Cipher Block Chaining**（**CBC**）**Â **密码套件的向下协商，从而允许中间人利用。使用中间人攻击，POODLE 需要 256 个 SSL 请求来揭示每个数据字节，并且除非存在大规模、强大且持久的中间人代理，否则它不经常使用。尽管如此，这是一个敏感问题，如果 SSLscan 或 SSLyze 显示存在这种组合，或者您可以选择使用`nmap`和其`ssl-poodle`模块来验证条件是否存在，那么您可以推断这可能存在于主机上。以下脚本将在目标上检查它：

```
nmap -sV ; version-light ; script ssl-poodle -p 443 <host>
```

与`ssl-enum-ciphers`脚本的 Nmap 扫描不同，这个扫描停止并且只深入到围绕这个 CVE 的具体细节（如下图所示）。您还可以看到我们在`ssl-enum-ciphers`扫描中捕获了 CVE，但没有标记它的常用名称。

![](img/B03918_08_06.png)

Nmap 与 SSL-poodle 模块扫描输出

OpenSSL 团队讨论了背景（[`www.openssl.org/~bodo/ssl-poodle.pdf`](https://www.openssl.org/~bodo/ssl-poodle.pdf)）和利用此漏洞的方法。我的朋友 Joey Muniz 也在他的*The Security Blogger*博客中写到了这个缺陷（[`www.thesecurityblogger.com/ssl-broken-again-in-poodle-attack/`](http://www.thesecurityblogger.com/ssl-broken-again-in-poodle-attack/)），并且在高层次上描述了它是如何实现的。

### 心脏出血

另一个引起大量媒体关注的漏洞是非常严重的**Heartbleed**漏洞（CVE-2014-0160，[`heartbleed.com`](http://heartbleed.com)）。与 POODLE 不同，这不能简单地通过配置来解决，而是需要对当时大约四分之三的互联网连接主机使用的基础 OpenSSL 软件进行修补。POODLE 允许攻击者一次一个字节地猜测会话 cookie，而 Heartbleed 是一种漏洞，允许攻击者读取所有私有加密密钥、用户名和密码、证书以及易受攻击主机上的所有受保护通信。尽管 POODLE 似乎是针对长期替换的密码类别的学术练习，但 Heartbleed 影响了全球绝大多数的网络设备。

我们已经看到 SSLyze 和 SSLscan 都能够检测到 Heartbleed 漏洞，但如果您想利用它作为更大的渗透测试的一部分，该怎么办？Metasploit 恰好能够提供，所以让我们来看看！

启动 Metasploit（使用`msfconsole`命令）后，我们可以使用`auxiliary/scanner/ssl/openssl_heartbleed`模块来支持我们利用 Heartbleed。

让我们继续查看选项（如下面的屏幕截图所示），我们需要考虑在配置利用时：

![](img/B03918_08_07.png)

在 Metasploit 中的 Heartbleed 模块的配置选项

我们将研究 BeeBox VM（[`www.itsecgames.com`](http://www.itsecgames.com)）并在下拉列表中选择**`Heartbleed Vulnerability`**，如下面的屏幕截图所示。请注意，还有其他旧的攻击，如前面提到的**`POODLE`**，可供您练习。我们可以看到实验室希望我们在名为`8443`的端口上工作，我的**RHOSTS**只是单个服务器`172.16.30.134`。我还将**VERBOSE**（在选项中未显示，因为它是一个更全局的、模块不可知的设置）设置为*true*，这样我们就可以看到所有的交易。我也会将其余的设置保持为默认设置。

![](img/B03918_08_08.png)

寻找一个受 Heartbleed 漏洞影响的服务器。

修改这些设置后，我们只需输入`run`或`exploit`，Metasploit 现在将尝试破坏服务器并获取它能找到的所有凭据和 cookie，如下面的屏幕截图所示。这么致命的东西不应该这么容易，您可以看到为什么我们需要测试和防范这些攻击。

![](img/B03918_08_09.png)

Metasploit 的 Heartbleed 利用是成功的。

### 淹没 HTTPS

**DROWN**（CVE-2016-0800）漏洞识别了一个开放 SSLv2 支持的服务器，这使得至少三分之一的互联网服务器在 2016 年 3 月时是脆弱的。攻击者将利用应用程序支持的 SSLv2，使用与用于*盐*或帮助随机化 TLS（更近期的协议版本）相同的密钥。通过启动数以万计的 SSLv2 消息，他们能够获取更强大和当前版本的 TLS 中使用的密钥，从而使用窃取的私钥破解更高级别的加密。曾经被认为是不切实际的，因为需要大量消息；他们也称之为*百万消息攻击*；现在已经知道可以通过商业可用的资源在几小时内使用数以万计的消息来实现。

检测 DROWN 漏洞就像看看目标服务器或共享相同密钥的其他服务器是否支持 SSLv2 一样简单。还有另一个工具可以用来识别这个漏洞，它位于[`test.drownattack.com`](http://test.drownattack.com)网站上。

### 重温经典

随着时间的推移，SSL 和 TLS 都经历了各自的漏洞；这是不可避免的，因为它们对由一小群过度工作和得不到支持的志愿者维护的 OpenSSL 等模块的巨大依赖。我们应该了解和检查的其他一些漏洞在这里描述：

+   **BEAST**：我们的客户需要练习良好的补丁和配置卫生习惯，以避免像**浏览器针对 SSL/TLS 的利用**（CVE-2011-3389）攻击这样的攻击。BEAST 针对 TLSv1.0 的**初始化向量**（**IVs**），这些是用来帮助随机加密的种子值。猜测 IVs 有助于攻击者重构对话并揭示本应被掩盖的明文。他们可以通过更新的 TLS 版本避免这些问题。

+   **CRIME**：**压缩比例信息泄漏变得容易**（CVE-2012-4929）是在旧版本中使用 TLS 压缩时的一个漏洞。通过注入字节并比较响应的大小，黑客可以识别和推断出 cookie 本身，这可以让他们为自己的邪恶用途劫持会话。现代浏览器不容易受到攻击，所以客户应该始终保持更新。

+   **BREACH**：**通过对超文本进行自适应压缩的浏览器侦察和外泄**（CVE-2013-3587）使用类似的技术，但使用 HTTP 压缩，因此不依赖于 TLS 压缩来使用 BREACH。您可以建议客户阻止压缩，并在多个事务中分割和掩盖任何密码或认证值，或者还可以使用包装器和操作来掩盖请求。

## 中间人攻击

* * *

中间人攻击受到网络和应用安全供应商的高度关注，这是理所当然的。中间人攻击可以在应用服务器附近进行，但更常见的是在客户端附近。中间人攻击的等级会有很大的变化，从 passively 监视流量模式到主动干扰和凭证收集。鉴于可以产生相同信息的更高优先级的妥协的普遍存在（例如**跨站脚本**或**XSS**），Web 应用程序渗透测试人员需要评估追求中间人攻击的风险与回报。让我们详细了解一下最受欢迎的工具，并调查一些不同中间人攻击目标的类似工具。

### 使用 SSLstrip 刮取凭证

**SSLstrip**（[`moxie.org/software/sslstrip/`](https://moxie.org/software/sslstrip/)）是由一个名叫 Moxie Marlinspike 的黑客创建的中间人攻击工具，它可以透明地拦截 HTTPS 流量，并用 HTTP 的替代品替换任何 HTTPS 链接和重定向，我们可以看到这些完全没有保护。这种攻击就像对浏览器配置和用户勤勉的测试，但它也可以强调 DNS 安全、PKI、双向证书检查和双因素授权的重要性。

*Jason Beltrame*和我在我们的书*《使用树莓派进行渗透测试，第二版》*（[`www.packtpub.com/networking-and-servers/penetration-testing-raspberry-pi-second-edition`](https://www.packtpub.com/networking-and-servers/penetration-testing-raspberry-pi-second-edition)）中写到了这一点，但在这种情况下，我们将放弃物理内联配置，而是通过将流量通过我们的 Kali VM 进行中间人攻击（请注意，这是一种基于 LAN 的攻击，所以您需要在受害者的 LAN 上）。毫无戒心的受害者相信他/她确实是安全连接的。

以下截图显示了一个高层概述：

![](img/B03918_08_10.png)

中间人攻击拓扑

首先，我们需要欺骗主机，让它认为我们是真正的默认网关。我们可以通过使用`route -n`确定段上的默认 GW 为什么使用，识别我们浏览受害者的 IP（我使用的是带有 IE9 的 Windows 7 虚拟机）。通过几个命令，我们可以打开 IP 转发并用我们的 MAC 地址对受害者进行`arpspoof`，如下所示：

```
echo 1 > /proc/sys/net/ipv4/ip_forward
arpspoof -i eth0 -t 172.16.30.135 172.16.30.2 
```

现在我们需要修改我们的`iptables`配置。如果你之前没有遇到过 iptables，它是 Linux 内核基于主机的防火墙的接口，所以你可以想象我们需要一些魔法来允许流量进入和离开，这些流量实际上并不是为我们准备的。在我的例子中，我使用端口`80`用于 HTTP，端口`1111`用于 SSLstrip，但如有需要，可以随意修改后者：

```
iptables -t nat -A PREROUTING -p tcp ; destination-port 80 -j REDIRECT ; to-port 1111 
```

现在我们需要启动 SSLstrip，可以从命令行或 GUI 快捷方式启动：

```
sslstrip â��l 1111 
```

完成后，我通常会浏览一些网站，比如[`www.aol.com/`](https://www.aol.com/)，然后输入一些假证书，希望能在我的 SSLstrip 日志中捕获它们，如下面的截图所示：

![](img/B03918_08_11.png)

任何 SSL 网站都可以用来测试。

通常情况下，我会从上一个终端会话中的 Python 脚本中收到一堆错误，但它仍然像一个冠军一样工作。只需打开`ssltrip.log`文件（我的文件位于`root`目录中），并滚动到搜索的末尾，查找其中一个字段字符串；在我的情况下，我使用了密码。

以下截图显示了我希望看到的假证书：

![](img/B03918_08_12.png)

SSLstrip 的日志和捕获的凭证。

### 使用 SSLsniff 和 SSLsplit 看起来很正规

我们希望我们的客户不会上当受骗，去除 SSL/TLS 保护的中间人攻击。更精明的客户将培训他们的用户并限制浏览器中的非 HTTPS 流量。对于这些情况，Moxie 再次使用 SSLsniff，就像 Daniel Roethlisberger 的**SSLsplit**（[`github.com/droe/sslsplit`](https://github.com/droe/sslsplit)）一样，可以通过充当透明代理并为服务器和客户端提供 SSL/TLS 连接来提供更高级别的中间人攻击。SSLsniff 和 SSLsplit 都将伪造 X.509 证书，并模仿服务器的大多数相关证书字段，因此这是一个适用于我们怀疑用户不注意他们的证书检查或执法可能较弱的环境的绝佳方法。这两个工具都依赖于伪造的证书，但使用相同的 IP 转发和`iptables`配置来传输流量。为了实现这一点，您需要运行证书颁发机构；如果您还没有建立自己的证书颁发机构，这是一个很棒的教程：[`jamielinux.com/docs/openssl-certificate-authority/`](https://jamielinux.com/docs/openssl-certificate-authority/)。

#### SSLsniff

我们先来看看 SSLsniff。然后，SSLsniff 要求您拥有目标 Web 应用程序的私钥和证书（不太可能），或者您生成伪造的证书，如下面的截图所示：

```
openssl req -config openssl.cnf -new -nodes -keyout <targetsite>.key -out <targetsite>.csr -days 365 
```

![](img/B03918_08_13.png)

为 SSLsniff 和 SSLsplit 伪造证书。

我们在**通用名称**（**CN**）中使用 Unicode `\x00`作为占位符，遵循优秀教程提供的指导，链接在这里：[`www.kimiushida.com/bitsandpieces/articles/attacking_ssl_with_sslsniff_and_null_prefixes/`](http://www.kimiushida.com/bitsandpieces/articles/attacking_ssl_with_sslsniff_and_null_prefixes/)。创建一个真正的欺骗证书作为后端编程是必要的，以创建允许受害者浏览器接受的空字符。创建`cert`和`key`后，我们需要使用自己的 CA 签署证书，连接`key`和`cert`，然后将其放置在我们假网站的目录中：

```
openssl ca -config openssl.cnf -policy policy_anything -out gmail.crt -infiles gmail.csr
cat paypal.crt gmail.key > gmail.pem
mkdir -p /usr/share/sslsniff/certs/fakegmail/
cp gmail.pem /usr/share/sslsniff/certs/fakegmail/ 
```

假设您已经正确配置了 IP 转发和`iptables`，SSLsniff 可以使用一个命令启动：

```
sslsniff -t -c /usr/share/sslsniff/certs/fakegmail -s 1111 -w /tmp/sslsniff.log -d â��p 
```

现在我们已经让 SSLsniff 等待我们受害者的流量，我们可以开始使用与 SSLstrip 中使用的相同类型的`arpspoof`来重定向来自客户端的流量：

```
arpspoof â��I eth0 â��t 172.16.30.135 172.16.30.2 
```

您可以查看`sslsniff.log`文件的内容并查看凭证（如下图所示）。这种攻击的成功可能性比 SSLstrip 更大，因为用户仍然会在其浏览器的地址栏中看到一个 HTTPS 会话；并且根据受信任的 CA 配置，他们可能很少意识到事情并不顺利。如果您使用真正的欺骗证书（查看此教程了解可能发生的情况：[`blog.leetsys.com/2012/01/18/insider-rogue-certification-authority-attack/`](https://blog.leetsys.com/2012/01/18/insider-rogue-certification-authority-attack/)），它甚至看起来是有效的。

![](img/B03918_08_14.png)

查看 SSLsniff 的凭证抓取

#### SSLsplit

SSLsplit 采用类似的方法；首先，您需要确保启用了 IP 转发。通常会使用更多的`iptables`条目来拉取更多的端口，提供 NAT，并使用`80`、`8080`、`443`和`8443`的典型重新映射端口：

```
iptables -t nat -F
iptables -t nat -A PREROUTING -p tcp â��dport 80 -j REDIRECT â��to-ports 8080
iptables -t nat -A PREROUTING -p tcp â��dport 443 -j REDIRECT â��to-ports 8443
iptables -I INPUT -p tcp -m state â��state NEW -m tcp â��dport 80 -j ACCEPT
iptables -I INPUT -p tcp -m state â��state NEW -m tcp â��dport 443 -j ACCEPT
iptables -I INPUT -p tcp -m state â��state NEW -m tcp â��dport 8443 -j ACCEPT
iptables -I INPUT -p tcp -m state â��state NEW -m tcp â��dport 8080 -j ACCEPT
service iptables save 
```

现在我们可以使用一个命令启动 SSLsplit。请注意，与生成欺骗证书相关的繁重开销已经消除；这非常有帮助，因为我们可以部署它来收集多个站点的信息，而无需为每个站点生成假证书：

```
sslsplit -l connections.log -S ~/scrapes/ -k ~/sslsplit-keys/ca.key -c ~/sslsplit-keys/ca.crt ssl 0.0.0.0 8443 tcp 0.0.0.0 8080 
```

与 SSLsniff 一样，输出指向一个日志文件，告诉您可以在`~/scrapes`文件夹中找到日志。

#### 替代中间人攻击动机

我们可以使用 Kali Linux 作为基础实施大量中间人攻击方法。如果您正在寻找仅限 HTTP 的中间人攻击（一些内部站点可能仍在使用不受保护的 HTTP），或者如果您正在寻找某些非常特定的东西，请查看**Driftnet**（[`www.ex-parrot.com/~chris/driftnet/`](http://www.ex-parrot.com/~chris/driftnet/)）和**Urlsnarf**。这两者都使用相同的 IP 转发和 arpspoof 配置，但提供了一些与 SSLstrip 不同的功能。Driftnet 专注于从通过您的 Kali VM 传递的 HTTP 流中提取图像和多媒体，这对拦截企业培训非常有帮助。Urlsnarf 只是拉取主机访问的所有网站，这可以帮助您映射明确访问的内部站点，并且可能不会出现在 DNS 侦察任务中。

## 摘要

* * *

尽管一些攻击受到了很多关注和荣耀，但推动社会对网络的依赖的信任关系至关重要。对这些信任机制的攻击非常令人担忧，因为它们经常让用户和应用程序开发人员对妥协毫不知情。本书涵盖的许多其他威胁以及 OWASP 十大威胁中所代表的威胁是网站应用程序所有者可以控制或有权利纠正的。然而，基于加密或 PKI 的攻击涉及到其他领域的方面，比如证书颁发机构的完整性，网络对 ARP 注入的容忍度，以及应用程序自身域之外的局域网的完整性。在 Heartbleed 和 POODLE 等攻击中，甚至提供这些服务的软件也可能会有最终妥协的问题：敏感数据和凭证的泄露。

在本章中，我们只是初步了解了如何扫描应用程序运行的软件中已知的漏洞。我们还看到了 SSLscan 和 SSLyze 在检测 PKI 细节方面的不同之处，以及如何使用它们和 Nmap 来识别弱点。我们还讨论了一些更常见的攻击方式，如如何利用 Heartbleed 以及如何以多种方式进行中间人攻击。

在第九章*，压力测试认证和会话管理*中，我们将假设加密技术非常完善，更容易的路径是在应用程序端破坏认证。这些认证和会话管理攻击更加关注特定应用程序配置和维护可能存在的缺陷，实际上，这些缺陷往往更容易受到攻击。这些攻击还具有利用与合法用户相同的安全通道进入环境的附加好处，这对于持续测试和对目标系统的深入分析至关重要。第九章*，压力测试认证和会话管理*，也将标志着我们回归到一些已经投资的工具集，所以拿杯饮料，让我们开始工作吧！
