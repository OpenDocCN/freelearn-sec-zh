# 第十六章：虚拟测试场地和分期

在过去的几章中，我们已经涵盖了很多内容。现在是时候测试我们在整本书中涵盖的所有方法，以及其他各种著名的测试工具，看看我们如何能够有效地使用行业领先的工具在 Metasploit 中对目标网络、网站或其他服务进行渗透测试和漏洞评估。

在本章中，我们将探讨各种测试方法，并涵盖以下主题：

+   使用 Metasploit 以及行业中的多种其他渗透测试工具。

+   将从各种工具和不同格式生成的报告导入 Metasploit 框架

+   创建渗透测试报告

本章的主要重点是使用 Metasploit 以及其他行业领先的工具进行渗透测试；然而，在进行基于 Web 的测试和其他测试技术时，测试的阶段可能会有所不同，但原则是相同的。

# 使用集成的 Metasploit 服务进行渗透测试

我们可以使用三种不同的方法进行渗透测试。这些方法是白盒、黑盒和灰盒测试技术。**白盒测试**是一种测试程序，测试人员完全了解系统，并且客户愿意提供有关环境的凭据、源代码和其他必要信息。**黑盒测试**是一种测试程序，测试人员对目标几乎一无所知。**灰盒测试**技术是白盒和黑盒技术的结合，测试人员对被测试环境只有少量或部分信息。在本章的后续部分中，我们将进行灰盒测试，因为它结合了两种技术的优点。灰盒测试可能包括或不包括操作系统详细信息、部署的 Web 应用程序、运行的服务器类型和版本以及执行渗透测试所需的其他技术方面。灰盒测试中的部分信息将要求测试人员执行额外的扫描，这将比黑盒测试耗时较少，但比白盒测试耗时更长。

考虑这样一个情景，我们知道目标服务器正在运行 Windows 操作系统；然而，我们不知道正在运行哪个版本的 Windows。在这种情况下，我们将消除对 Linux 和 UNIX 系统的指纹技术，并主要关注 Windows 操作系统，从而通过考虑单一操作系统的版本而节省时间，而不是扫描每种操作系统。

使用灰盒测试技术进行渗透测试时，我们需要涵盖以下阶段：

![](img/473b0618-348d-446a-9109-081c2458a664.png)

上图说明了在进行灰盒分析的渗透测试时需要涵盖的各个阶段。如图所示，虚线标记的阶段定义了可能需要或不需要的阶段。双线标记的阶段指定了关键阶段，而最后一个（单一连续线）描述了在进行测试时应遵循的标准阶段。现在让我们开始渗透测试，并分析灰盒测试的各个方面。

# 与员工和最终用户的互动

与员工和最终用户的沟通是到达客户现场后要进行的第一个阶段。这个阶段包括**非技术性黑客**，也可以描述为**社会工程学**。其目的是从最终用户的角度获取有关目标系统的知识。这个阶段还回答了一个组织是否受到了通过最终用户泄露信息的保护。以下示例应该使事情更加透明。

去年，我们的团队正在进行白盒测试，并且我们访问了客户现场进行现场内部测试。我们一到达，就开始与最终用户交谈，询问他们在使用新安装的系统时是否遇到任何问题。出乎意料的是，公司里没有一个客户允许我们触碰他们的系统，但他们很快解释说他们在登录时遇到了问题，因为每个会话不能接受超过 10 个连接。

我们对公司的安全政策感到惊讶，该政策不允许我们访问他们的任何客户系统；但后来，我的一个队友看到一位大约 55-60 岁的老人在账户部门挣扎着使用互联网。我们问他是否需要帮助，他很快同意了。我们告诉他，他可以通过连接 LAN 电缆到我们的笔记本电脑来完成未完成的交易。他把 LAN 电缆插入我们的电脑，开始工作。站在他身后的我的同事打开了他的笔形摄像头，迅速记录了他的所有打字活动，比如他用来登录内部网络的凭据。

我们发现另一名女性正在与她的系统苦苦挣扎，并告诉我们她在登录时遇到了问题。我们向这位女士保证我们会解决这个问题，因为她的账户需要从后端解锁。我们要求她的用户名、密码以及登录机制的 IP 地址。她同意并把凭据传给了我们，这就结束了我们的例子：这样的员工如果遇到问题，无论这些环境有多安全，都可能意外泄露他们的凭据。我们后来将这个问题作为报告的一部分报告给了公司。

对最终用户有意义的其他类型信息包括以下内容：

+   他们正在使用的技术

+   服务器的平台和操作系统详细信息

+   隐藏的登录 IP 地址或管理区域地址

+   系统配置和操作系统详细信息

+   Web 服务器背后的技术

这些信息是必需的，并将有助于在了解可测试系统中使用的技术的基础上，确定测试的关键领域。

然而，在执行灰盒渗透测试时，这个阶段可能包括也可能不包括。这类似于公司要求您在公司所在地完成测试，如果公司很远，甚至可能在另一个国家。在这些情况下，我们将排除这个阶段，并询问公司的管理员或其他官员有关他们正在使用的各种技术以及其他相关信息。

# 情报收集

与最终用户交谈后，我们需要深入了解网络配置并了解目标网络；然而，从最终用户那里收集到的信息可能不完整，更有可能是错误的。渗透测试人员必须确认每个细节两次，因为误报和虚假信息可能会在渗透测试过程中造成问题。

情报收集涉及捕获有关目标网络、使用的技术以及正在运行的服务版本等深入细节。

情报收集可以通过从最终用户、管理员和网络工程师收集的信息来执行。在远程测试的情况下，或者如果获得的信息部分不完整，我们可以使用各种漏洞扫描器，如 Nessus、GFI Lan Guard、OpenVAS 等，来找出任何缺失的信息，如操作系统、服务以及 TCP 和 UDP 端口。

在接下来的部分，我们将制定我们收集情报的需求，使用 OpenVAS、Mimikatz 等行业领先的工具；但在继续之前，让我们考虑一下使用从客户现场访问、预交互和问卷调查收集到的部分信息进行测试的环境设置。

# 正在测试的示例环境

根据我们使用问卷调查、互动和客户现场访问收集的信息，我们得出以下示例环境，将对其进行测试：

![](img/3f1b425f-517a-4a10-90e7-d30bf432dcc3.png)

我们获得了 VPN 访问权限，并被要求对网络进行渗透测试。我们还了解到公司网络上运行的操作系统是基于 Windows 的操作系统。我们假设我们已经完成了 NMAP 扫描，并发现了运行在`192.168.0.196`上的用户系统。现在我们准备使用 Metasploit 和其他行业领先的工具进行全面的渗透测试。我们将使用的主要工具是**OpenVAS**。OpenVAS 是一个漏洞扫描器，是最先进的漏洞管理工具之一。OpenVAS 最好的地方在于它完全免费，这使得它成为小规模公司和个人的首选；然而，OpenVAS 有时可能会有 bug，您可能需要一些努力来手动修复 bug，但由于它是社区中的一颗明珠，OpenVAS 将始终是我最喜欢的漏洞扫描器。

要在 Kali Linux 上安装 OpenVAS，请参考[`www.kali.org/penetration-testing/openvas-vulnerability-scanning/`](https://www.kali.org/penetration-testing/openvas-vulnerability-scanning/)。

# 使用 Metasploit 进行 OpenVAS 的漏洞扫描

要在 Metasploit 中集成 OpenVAS 的使用，我们需要加载 OpenVAS 插件，如下所示：

![](img/918080a6-cb91-403d-a87b-dc933399c905.png)

我们还可以看到有许多其他流行工具的模块，如 SQLMAP、Nexpose 和 Nessus。

要加载 OpenVAS 扩展到 Metasploit 中，我们需要从 Metasploit 控制台发出`load openvas`命令。

我们可以在上一个屏幕截图中看到，OpenVAS 插件已成功加载到 Metasploit 框架中。

要在 Metasploit 中使用 OpenVAS 的功能，我们需要将 OpenVAS Metasploit 插件与 OpenVAS 本身连接起来。我们可以通过使用`openvas_connect`命令，然后是用户凭据、服务器地址、端口号和 SSL 状态来实现这一点，如下面的屏幕截图所示：

![](img/b39fb6ba-8cb5-4a2d-865b-9aaeb45d966a.png)

在开始之前，让我们讨论工作空间，这是管理渗透测试的一个很好的方式，特别是当你在一家专门从事渗透测试和漏洞评估的公司工作时。通过切换和创建不同的工作空间来有效地处理不同的项目。使用工作空间还可以确保测试结果不会与其他项目混在一起。因此，在进行渗透测试时强烈建议使用工作空间。

创建并切换到新的工作空间非常容易，如下面的屏幕截图所示：

![](img/31e642a3-595b-4074-96b4-7f176584b99f.png)

在上一个屏幕截图中，我们添加了一个名为`AD_Test`的新工作空间，并通过简单地输入`workspace`，然后输入`AD_Test`（工作空间的名称）来切换到它。

要开始漏洞扫描，我们需要创建的第一件事是一个目标。我们可以使用`openvas_target_create`命令创建尽可能多的目标，如下面的屏幕截图所示：

![](img/6e80ee61-5a85-4b77-ba27-605b6ec9d40f.png)

我们可以看到，我们为`192.168.0.196` IP 地址创建了一个名为`196_System`的目标，并将其注释为`196_System_in_AD`，只是为了更容易记住。此外，记住目标的 ID 也是很好的。

继续前进，我们需要为正在测试的目标定义一个策略。我们可以通过发出`openvas_config_list`命令来列出示例策略，如下所示：

```
msf > openvas_config_list 
[+] OpenVAS list of configs

ID                                    Name
--                                    ----
085569ce-73ed-11df-83c3-002264764cea  empty
2d3f051c-55ba-11e3-bf43-406186ea4fc5  Host Discovery
698f691e-7489-11df-9d8c-002264764cea  Full and fast ultimate
708f25c4-7489-11df-8094-002264764cea  Full and very deep
74db13d6-7489-11df-91b9-002264764cea  Full and very deep ultimate
8715c877-47a0-438d-98a3-27c7a6ab2196  Discovery
bbca7412-a950-11e3-9109-406186ea4fc5  System Discovery
daba56c8-73ec-11df-a475-002264764cea  Full and fast
```

为了学习的目的，我们将只使用`Full and fast ultimate`策略。请注意策略 ID，在本例中为`698f691e-7489-11df-9d8c-002264764cea`。

现在我们有了目标 ID 和策略 ID，我们可以继续使用`openvas_task_create`命令创建一个漏洞扫描任务，如下所示：

```
msf > openvas_task_create 
[*] Usage: openvas_task_create <name> <comment> <config_id> <target_id>

msf > openvas_task_create 196_Scan NA **698f691e-7489-11df-9d8c-002264764cea 5e34d267-af41-4fe2-b729-2890ebf9ce97**
[*] 694e5760-bec4-4f80-984f-7c50105a1e00
[+] OpenVAS list of tasks
ID                                   Name      Comment  Status Progress
--                                  ----      -------  ------  --------
694e5760-bec4-4f80-984f-7c50105a1e00 196_Scan  NA       New     -1
```

我们可以看到我们使用`openvas_task_create`命令创建了一个新任务，然后分别是任务名称、注释、配置 ID 和目标 ID。有了创建的任务，我们现在准备启动扫描，如下面的输出所示：

```
msf > openvas_task_start 694e5760-bec4-4f80-984f-7c50105a1e00
[*] <X><authenticate_response status='200' status_text='OK'><role>Admin</role><timezone>UTC</timezone><severity>nist</severity></authenticate_response><start_task_response status='202' status_text='OK, request submitted'><report_id>c7886b9c-8958-4168-9781-cea09699bae6</report_id></start_task_response></X>  
```

在之前的结果中，我们可以看到我们使用`openvas_task_start`命令初始化了扫描，然后是任务 ID。我们可以随时使用`openvas_task_list`命令检查任务的进展，如下面的屏幕截图所示：

![](img/ac3f1b6a-8eef-40b2-8fcd-a6e7664af14c.png)

保持关注进展，一旦任务完成，我们可以使用`openvas_report_list`命令列出扫描报告，如下面的屏幕截图所示：

![](img/accb2927-3f7f-45da-b2e9-d07dae59aa44.png)

我们可以使用`openvas_report_download`命令下载这个报告，并直接将其导入到数据库中，然后是报告 ID、格式 ID、路径和名称，如下所示：

![](img/8772a9ab-21f6-4fbd-acf9-de8f2e0f687b.png)

我们现在可以使用`db_import`命令在 Metasploit 中导入报告，如下面的屏幕截图所示：

![](img/259e4ab2-2b1d-49db-a73d-b4fcdd987b01.png)

格式 ID 可以使用`openvas_format_list`命令找到，如下面的屏幕截图所示：

![](img/de7f0015-88e5-4135-9d48-9eb10923d5fb.png)

成功导入后，我们可以使用`vulns`命令检查 MSF 数据库中的漏洞，如下面的屏幕截图所示：

![](img/8b5f1a9d-cf53-4f64-a9c8-95d593f34bbb.png)

我们可以看到我们在数据库中有所有的漏洞。我们可以通过登录到端口`9392`上的浏览器中的 Greenbone Assistant 来交叉验证漏洞数量并深入了解详细信息，如下面的屏幕截图所示：

![](img/a35ff600-22a4-4b6b-ae5c-854b95cbd3ae.png)

我们可以看到我们有多个高影响的漏洞。现在是一个很好的时机来进行威胁建模，并只针对特定的弱点进行目标定位。

# 威胁区域建模

在进行渗透测试时，威胁区域建模是一个重要的关注点。这个阶段侧重于网络中需要关注和保护的特定区域。网络或系统中漏洞的影响取决于威胁区域。我们可能会在系统或网络中发现一些漏洞。然而，那些可能对关键区域产生影响的漏洞是首要关注的。这个阶段侧重于筛选那些可能对资产产生最大影响的漏洞。威胁区域建模将帮助我们针对正确的一组漏洞。然而，如果客户要求，这个阶段可以被跳过。

影响分析并标记对目标影响最大的漏洞也是必要的。此外，当受检网络范围广泛且只有关键区域需要测试时，这个阶段也是至关重要的。

从 OpenVAS 的结果中，我们可以看到 DCE/RPC 和 MSRPC 服务枚举报告漏洞，但由于网络是内部的，可能不会对基础设施造成任何伤害。因此，它被排除在利用的角度之外。此外，利用 DOS 等漏洞可能会导致**蓝屏**（**BSOD**）。在大多数基于生产的渗透测试中应避免 DOS 测试，并且只应在事先获得客户许可的测试环境中考虑。因此，我们跳过它，转而寻找可靠的漏洞，即 HTTP 文件服务器远程命令执行漏洞。浏览 OpenVAS Web 界面中漏洞的详细信息，我们可以发现该漏洞对应于 CVE `2014-6287`，在 Metasploit 中对应于`exploit/windows/http/rejetto_hfs_exec`模块，如下截图所示：

![](img/2d74708a-dadf-4711-82a9-af0b8ab5f01b.png)

# 获取目标访问权限

让我们通过加载模块并设置所需的选项来利用漏洞，如下截图所示：

![](img/a48fc3bc-110c-4257-8300-1e3c9c2d1b8e.png)

我们可以看到我们已经放置了所有必要的选项，所以让我们使用`exploit`命令来利用系统，如下截图所示：

![](img/21f78500-b808-4216-92d5-2ac17888e4b9.png)

砰！我们成功进入了系统。让我们进行一些后渗透，看看我们利用了什么样的系统：

![](img/2a4fff92-ed56-4a99-9d9d-e96bf366b3af.png)

运行`sysinfo`命令告诉我们系统是一个 Windows 10 x64 系统，目前属于一个名为 PYSSG 的域，有七个已登录用户，这很有趣。让我们运行`arp`命令看看我们是否能识别网络上的一些系统：

![](img/f8bf49c4-bca5-4b8d-8d6e-2652a3e75f37.png)

我们可以看到网络上有很多其他系统在运行，但我们知道网络是在活动目录下配置的。此时，我们可能考虑对活动目录架构本身进行渗透测试，并收集关于网络其他部分的信息，可能还能够获得对域控制器本身的访问权限。

# 使用 Metasploit 攻击 Active Directory（AD）

由于我们已经在活动目录网络中的一台机器上获得了访问权限，我们必须找到并记录域控制器，然后利用这些详细信息来破解域控制器本身。

# 查找域控制器

让我们使用`enum_domain`模块来查找域控制器，如下截图所示：

![](img/2fae25bb-ed0f-4a1f-b2af-877a92510412.png)

我们可以看到我们有域、域控制器和其 IP 地址等详细信息。模块所需的唯一选项是从受损机器获得的 Meterpreter 的会话标识符。

# 枚举在 Active Directory 网络中的共享

要在网络中查找共享，我们可以简单地使用`enum_shares`模块，如下截图所示：

![](img/c17e6c1b-ecae-44c7-b2ff-b44542af54a3.png)

我们可以看到网络中有一个打印共享；然而，这看起来并不乐观。让我们尝试一些其他模块。

# 枚举 AD 计算机

我们还可以尝试使用`enum_domain_computers`后模块查找 AD 中系统的详细信息，如下截图所示：

![](img/3f791cfe-caaa-4686-af77-5aa68502e586.png)

我们可以看到我们已经为模块设置了会话标识符。让我们运行模块并分析结果如下：

![](img/ec505c8f-7637-4262-8d4c-c808ddc88281.png)

我们可以看到我们已经获得了域详细信息、计算机名称、OU，甚至操作系统版本，即 Windows Server 2016 标准版。嗯，Windows Server 2016 是一个太现代的系统，要在其中找到并利用漏洞将是一项艰巨的任务。尽管如此，让我们继续寻找一些令人兴奋的信息。

# 枚举在 Active Directory 中登录的用户

有时，我们可能能够窃取管理员的令牌并使用它来执行各种任务。让我们看看目前有哪些用户登录到网络中：

![](img/fd8e26fe-9299-4bff-afe5-964b8a516c73.png)

好吧，我们只能看到一个用户登录到系统中。让我们使用一些高级的 Metasploit 功能从这个网络中收集有价值的信息。

# 枚举域令牌

让我们看看在受损主机上运行`post/windows/gather/enum_domain_tokens`模块后我们得到了哪些域帐户，如下面的截图所示：

![](img/60825e54-3cb5-416f-bf41-b917bcd8e0db.png)

有趣。我们可以看到`deepankar`帐户是机器的本地管理员；然而，在域组和用户令牌帐户中有一个有趣的条目，即域管理员用户`deep`。这也可能意味着域管理员可能从这台机器上登录。该模块还将列出用户的运行进程，如下所示：

![](img/9defed0c-7a7a-48f6-8f78-8b04367d446d.png)

不错。我们可以看到来自本地和域管理员的进程都在运行。让我们继续枚举域，看看我们是否能找到更多东西。

# 在 Meterpreter 中使用 extapi

Windows Meterpreter 通过扩展 API 提供了许多新功能。扩展 API 提供了对剪贴板操作、查询服务、Windows 枚举和 ADSI 查询的简单访问。

要在 Metasploit 中加载扩展 API，我们只需要使用`load`命令，然后跟着`extapi`，如下面的截图所示：

![](img/ed65a22d-a59f-4e99-86c8-09a25ad056fd.png)

运行上述命令在 Meterpreter 控制台中解锁了各种功能，可以通过在 Meterpreter 控制台中输入`?`来查看，如下所示：

![](img/f7a4598b-9253-49a7-96de-8eeb8cb87554.png)

# 使用 Metasploit 枚举打开的 Windows

扩展 API 中的`window_enum`功能为我们提供了受损机器上所有打开的 Windows 的列表。这可能使我们能够更多地了解目标和正在运行的应用程序。让我们看看在目标系统上运行此模块时会发生什么：

![](img/c0789c7c-50e3-42d8-8c9d-3fbb6814010a.png)

如建议的那样，我们有目标上所有打开的 Windows 的列表及其当前的进程 ID。让我们再探索一些：

![](img/7b311a71-2a77-4eac-b4fd-221187097c57.png)

我们可以看到 Microsoft Word 在目标系统上打开，这表明了机器上存在人的实体。

# 操作剪贴板

由于我们知道有人坐在机器上，而且我们已经拥有了扩展 API 的功能，让我们利用它来操作目标的剪贴板，如下所示：

![](img/13bc43a1-626a-4cc7-8c89-bf0ad016d51e.png)

嗯嗯！看起来有人正在将凭据复制到某个应用程序中。但等等！`192.168.0.190`是域控制器的 IP 地址。让我们记下这些凭据，因为我们将尝试使用它们进行更复杂的攻击。

# 在 Metasploit 中使用 ADSI 管理命令

我们已经获得了域控制器的一些关键凭据。但是在寻找目标上更多信息的可能性方面，我们不应该限制自己。让我们开始吧：

![](img/a7f732e2-7160-418f-b9d6-6ef9602f93c9.png)

我们可以看到在`pyssg.com`域上发出`adsi_computer_enum`命令会枚举出网络上以前未知的许多其他系统。大多数系统都在运行 Windows 10 专业版操作系统。让我们看看我们还能得到什么：

![](img/31f4daed-e9ed-4069-84db-1dbe1ef16f1e.png)

我们还可以使用`adsi_dc_enum`命令找到域控制器，后面跟着`pyssg.com`，这是前面截图中显示的域名。我们还可以通过使用`adsi_user_enum`命令更好地查看 AD 用户，如下面的截图所示：

![](img/ef19a8b0-9f68-4fb5-82fb-4ed38a4d7411.png)

最初，我们看到我们只有一个 OU，也就是域；然而，前面的命令揭示了原始 OU 是 OPS。

# 在网络中使用 PsExec 漏洞

我们在前面的部分注意到了一些凭据。让我们利用它们并尝试使用 Metasploit 中的`psexec`模块访问域控制器。根据微软的网站：

"PsExec 是一个轻量级的 telnet 替代品，它允许您在其他系统上执行进程，包括对控制台应用程序的完全交互，而无需手动安装客户端软件。PsExec 的最强大的用途包括在远程系统上启动交互式命令提示符和远程启用诸如 IpConfig 之类的工具，否则无法显示有关远程系统的信息。"

PsExec 用于通过哈希传递攻击，攻击者无需破解某些系统密码的获得的哈希，哈希本身可以传递以登录到机器并执行任意命令。但由于我们已经有明文凭据，我们可以直接加载模块并运行它以获得对域控制器的访问。让我们设置模块如下：

![](img/3f5abf98-aca5-436d-8c58-1ea71ef95c5d.png)

我们可以看到我们已经设置了所有必需的选项。让我们执行模块并分析输出：

![](img/2b551385-093f-44da-a23c-177f6ac1c7fb.png)

砰！我们已成功访问了域控制器。让我们进行一些后期利用，并看看我们还能得到什么：

![](img/b01f0f44-7842-4dc7-a08e-d8c46a42b12a.png)

是的！我们已经入侵了一个不包含严重漏洞但在权限范围上存在缺陷的 Windows 2016 服务器：

![](img/4c9b626d-f484-4df5-885b-d87f20b75e79.png)

我们可以看到我们对服务器有`SYSTEM`级别的访问权限，并且可以在目标上执行几乎任何操作。

# 在 Metasploit 中使用 Kiwi

Metasploit 提供**Mimikatz**和**Kiwi**扩展来执行各种类型的凭据操作，例如转储密码和哈希，转储内存中的密码，生成黄金票据等。让我们在 Metasploit 中加载`kiwi`，如下所示：

![](img/06c9a49f-bfe6-49a8-b694-0090ac9c7e24.png)

一旦我们加载了`kiwi`模块，我们可以看到我们有一个完整的命令菜单可以使用，如下面的截图所示：

![](img/a6217004-4476-48c0-bd35-bdd732856c00.png)

让我们尝试运行`lsa_dump_secrets`命令，并检查我们是否可以转储一些内容：

![](img/7b1fa7c4-c7af-476b-9e35-51388daf655a.png)

中了！我们可以看到我们已成功转储了 NTLM 和 SHA1 哈希以及秘密。我们有大量信息可以获得黄金票据；但是，我们将在接下来的章节中研究如何操纵黄金票据。现在让我们尝试使用`hashdump`命令转储哈希。要转储哈希，我们必须迁移到用户进程。让我们使用`ps`命令拉起进程列表，如下所示：

![](img/61f2e3ca-1d77-4f5a-92f6-fdd465fa47ce.png)

让我们迁移到运行在进程 ID`576`下的`lsass.exe`进程，如下所示：

![](img/5ebcab40-4f95-47f0-b072-212c58a3d968.png)

哇！我们可以看到成功迁移到`lsass.exe`进程后，运行`hashdump`命令会转储所有用户哈希，我们稍后可以破解。

# 在 Metasploit 中使用 cachedump

由于我们已经获得了良好的访问权限，最好进行`cachedump`以获取凭据，如下所示：

![](img/869ef393-12ad-48a9-a8c5-7f1c78a8ce11.png)

# 保持对 AD 的访问

我们已经看到我们有许多方法可以在目标系统上实现持久性，我们将在接下来的章节中看到更多方法；但是，在一个拥有许多用户的大型网络中，可能很容易秘密地将一个域用户添加到控制器上，以巩固我们对 AD 网络的访问。让我们加载`post/windows/manage/add_user_domain`模块，如下所示：

![](img/a56ddaee-33b2-4fe1-ae10-eb81f36d5341.png)

我们可以看到我们已经设置了所有必需的选项，如`USERNAME`、`PASSWORD`和`SESSION`。让我们运行这个模块，看看我们的用户是否被添加到域中：

![](img/ae27790c-2ad7-4237-a6c0-8fc9ab1a7f21.png)

我们可以看到我们已成功将用户 hacker 添加到域`PYSSG`中。我们可以随时轻松地使用这个用户来回登录；但是，我建议将名称与现有用户匹配，因为像*hacker*这样的词会引起一些疑问。

此外，我们可以使用`loot`命令查看所有收集的细节，如下所示：

![](img/f20b2d2c-8807-4dc1-8aea-55ab0705fad3.png)

# 生成手动报告

现在让我们讨论如何创建渗透测试报告，看看应该包括什么，应该在哪里包括，应该添加/删除什么，如何格式化报告，使用图表等等。许多人，如经理、管理员和高级管理人员，都会阅读渗透测试的报告。因此，有必要对发现的问题进行良好的组织，以便目标受众能够正确传达和理解正确的信息。

# 报告的格式

一个好的渗透测试报告可以分解为以下格式：

+   页面设计

+   文件控制：

+   封面

+   文件属性

+   报告内容列表:

+   目录

+   插图列表

+   执行/高层摘要：

+   渗透测试的范围

+   严重信息

+   目标

+   假设

+   漏洞摘要

+   漏洞分布图

+   建议摘要

+   方法论/技术报告

+   测试细节

+   漏洞列表

+   可能性

+   建议

+   参考资料

+   术语表

+   附录

以下是一些重要部分的简要描述：

+   **页面设计**：页面设计指的是选择报告中要使用的字体、页眉和页脚、颜色等

+   **文件控制**：这里涵盖了报告的一般属性

+   **封面**：包括报告的名称、版本、时间和日期、目标组织、序列号等

+   **文件属性**：包括报告的标题、测试人员的姓名以及审阅此报告的人的姓名

+   **报告内容列表**：包含报告的内容，并与之相关联的清晰定义的页码

+   **目录**：这包括从报告开始到结束的所有材料的列表

+   **插图列表**：报告中使用的所有图表都应在此部分列出，并附有适当的页码

# 执行摘要

**执行摘要**包括了报告的总体摘要和非技术性术语，并专注于向公司的高级员工提供知识。它包含以下信息：

+   **渗透测试的范围**：这一部分包括进行的分析类型和测试的系统。在这一部分列出了测试的所有 IP 范围。此外，这一部分包含了关于测试的严重性信息。

+   **目标**：这一部分定义了测试将如何帮助目标组织，测试的好处等等。

+   **假设**：如果在测试过程中做出了任何假设，都需要在这里列出。假设在测试网站时发现了管理员面板中的 XSS 漏洞，但要执行它，我们需要以管理员权限登录。在这种情况下，需要做出的假设是我们需要管理员权限进行攻击。

+   **漏洞摘要**：以表格形式提供信息，并描述根据其风险级别（高、中、低）发现的漏洞数量。它们根据影响程度排序，从对资产影响最大的弱点到对影响最小的弱点。此外，该阶段还包含了多个系统的多个问题的漏洞分布图表。以下是一个示例：

| **影响** | **漏洞数量** |
| --- | --- |
| 高 | 19 |
| 中 | 15 |
| 低 | 10 |

+   **建议摘要**：此部分的建议仅适用于影响因子最高的漏洞，并且它们应相应列出。

# 方法论/网络管理员级报告

报告的这一部分包括渗透测试期间要执行的步骤，漏洞的深入细节以及建议。以下项目符号列表详细说明了管理员感兴趣的部分：

+   **测试细节**：报告的这一部分包括与测试总结相关的信息，以图表和表格的形式呈现漏洞、风险因素以及受这些漏洞感染的系统的信息。

+   **漏洞清单**：报告的这一部分包括漏洞的详细信息、位置以及主要原因。

+   **可能性**：这一部分解释了这些漏洞被攻击者针对的可能性。这是通过分析触发特定漏洞的易用性来完成的，并通过找出可以针对漏洞进行的最简单和最困难的测试来找出最容易和最困难的测试。

+   **建议**：此部分列出了修补漏洞的建议。如果渗透测试不建议修补程序，则只被视为半成品。

# 其他部分

+   **参考**：在制作报告时使用的所有参考资料都应在此列出。例如书籍、网站、文章等的参考资料都应明确列出，包括作者、出版物名称、出版年份或文章发表日期等。

+   **术语表**：报告中使用的所有技术术语都应在此列出并附上它们的含义。

+   **附录**：这一部分是添加不同脚本、代码和图像的绝佳位置。

# 摘要

在本章中，我们看到了如何使用 OpenVAS 内置连接器和各种 Metasploit 扩展有效地对网络进行渗透测试，以及如何生成测试的适当报告。我们还有许多其他连接器可供使用，例如 Nessus、SQLMAP 等，我们将在接下来的章节中继续研究它们。

在下一章中，我们将看到如何使用 Metasploit 进行客户端攻击，并通过社会工程和有效载荷传递获取无法渗透的目标的访问权限。
