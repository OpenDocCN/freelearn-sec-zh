

# 第一章：Bash 命令行及其黑客环境

在这一基础章节中，你将开始踏上进入 Bash shell 脚本世界的旅程，特别是面向**渗透测试员`(`pentesters**)。你将清楚地了解什么是 Bash，为什么它对**渗透测试`(`pentesting**)至关重要，以及如何设置你的脚本环境。通过实际的示例和解释，你将为成为网络安全领域的熟练 Bash 脚本编写者打下基础。

Bash 不仅仅是一个命令解释器——它是一个自动化我们每天在网络安全中遇到的复杂和繁琐任务的工具。在没有训练的人的手中，Bash 就像一根大棒，显得沉重、过于复杂且不舒服。而在那些能够看到其好处并投入时间去学习其细节的人手中，Bash 就像一把外科医生使用的手术刀，你可以像机器人专家一样使用它来切割数据并自动化渗透测试方法。

在本章中，我们将涵盖以下主要内容：

+   Bash 简介

+   实验室设置

+   配置你的黑客终端

+   设置基本的渗透测试工具

# 技术要求

要跟随本章的练习，你需要一个 Linux 环境。本书假设你具备安装操作系统的能力，并熟悉虚拟机环境的安装与配置。如果你需要帮助来设置实验室环境，可以参考 VirtualBox 在线手册（*Oracle VM VirtualBox 用户手册*，[`download.virtualbox.org/virtualbox/UserManual.pdf`](https://download.virtualbox.org/virtualbox/UserManual.pdf)）和一些 YouTube 视频（VirtualBox – YouTube [`www.youtube.com/results?search_query=virtualbox`](https://www.youtube.com/results?search_query=virtualbox)）。

幸运的是，有许多免费的方式可以配置 Bash 学习环境。所有示例将使用 Kali Linux 展示。然而，任何 Linux 或 macOS 环境都可以使用。

*“Kali Linux 是一个开源的、基于 Debian 的 Linux 发行版，旨在进行各种信息安全任务，如渗透测试、安全研究、计算机取证和逆向工程。”*（*Kali* *Linux*， [`www.kali.org/`](https://www.kali.org/)）

我强烈建议你使用一个全新的 Kali Linux 虚拟机来跟随本书中的练习或进行渗透测试。在本书和你的渗透测试过程中，你将安装很多工具及其依赖项。工具依赖项之间的冲突是常见的，这种情况被称为*依赖地狱*。如果在安装过程中没有正确地隔离这些工具，可能会对你的主系统造成损害。你也不希望冒险让恶意软件感染你的主系统。

Kali 提供了多种解决方案。它们提供安装镜像、虚拟机、云镜像和**Windows 子系统 for Linux**(**WSL**) 包。

你可以从 [`www.kali.org/get-kali/#kali-platforms`](https://www.kali.org/get-kali/#kali-platforms) 下载 Kali。

本章中将使用的所有命令可以在本书的 GitHub 仓库中找到：[`github.com/PacktPublishing/Bash-Shell-Scripting-for-Pentesters/tree/main/Chapter01`](https://github.com/PacktPublishing/Bash-Shell-Scripting-for-Pentesters/tree/main/Chapter01)。

# Bash 简介

Bash，亦称为 *Bourne Again Shell*，是一个命令行 shell 解释器和脚本语言。Bash 由 Brian Fox 于 1989 年创建，作为 Bourne shell（一个专有软件）的自由软件替代品。（Bash – GNU 项目 – 自由软件基金会，[`www.gnu.org/software/bash/`](https://www.gnu.org/software/bash/)）。它是最常见的 Linux shell。Bash 还引入了将多个命令组合成脚本的功能，用户只需输入一个命令即可执行这些脚本。

当你在 Linux 系统中打开终端并输入命令时，你的 Bash shell 管理着与操作系统的交互以及运行可执行文件和脚本。Bash 和 Linux 可执行文件形成了共生关系，彼此增强对方的功能性和效率。Bash 作为用户和脚本与 Linux 内核（操作系统的核心）互动的门户。它解析用户命令，无论是直接输入到终端还是写入文件中的脚本，并在系统中启动相应的操作。另一方面，Linux 可执行文件是执行这些操作的“工作马”。它们是二进制文件，通常使用 C 或 C++ 等编程语言编写，并被编译以在 Linux 系统上高效运行。当用户在 Bash 中发出命令时，通常涉及调用一个或多个可执行文件来执行某项任务。

以下是 Bash 的一些功能：

+   **带参数的命令执行**：命令可以是二进制文件、内建的 shell 命令或脚本。

+   **命令补全**：这是一个通过按下 *Tab* 键自动补全部分输入的命令或文件名的功能，帮助用户提高效率。

+   **命令历史**：命令历史允许你快速重用先前在 shell 中输入的命令。

+   **作业控制**：将命令发送到后台并将其带到前台。

+   **Shell 函数和别名**：函数将相关代码组织成一个可以在需要时调用的名称。别名允许用户将复杂命令简化为单个名称。

+   **数组**：数组将元素存储在一个列表中，我们可以在之后检索和处理这些元素。

+   **命令与大括号扩展**：命令扩展使用一个命令的结果作为另一个命令的输入。大括号扩展允许生成字符串。

+   **管道与重定向**：一个命令的输出作为另一个命令的输入。

+   **环境变量**：动态值被分配到标签名，这些标签通常用于表示系统配置或存储环境相关信息。

+   **文件系统导航**：Bash 提供了更改目录、打印当前目录以及查找文件和目录的命令。

+   **帮助**：`man`命令，简写为*manual*，为用户提供有关如何执行命令的信息和示例。

Bash 脚本是我在渗透测试生涯中学到的最重要的技能之一，并且我每天都会使用。当你在开发应用程序时，某一时刻你可能会需要使用其他脚本语言，例如 Python。在大多数情况下，你在终端中想做的任何事情，都可以通过 Bash 完成，Bash 负责协调输入输出以及解析来自多个工具的数据。Bash 与 Linux 操作系统紧密集成，因此在学习其他脚本语言如 Python 或 Ruby 之前，学习 Bash 是非常有意义的。尽管我知道多种脚本和编程语言，但由于 Bash 与 Shell 的紧密集成以及通过一行甚至一个单词的命令快速获得结果的便利性，Bash 仍是我最常使用的工具。

在我作为渗透测试员的工作中，每天我都会使用 Bash 来解析数据或自动化将多个工具串联在一起。当客户给我提供范围数据时，我通常需要从*参与规则*文档、电子邮件或 Excel 表格中复制一个范围内的 IP 地址或主机名列表，并粘贴到文本文件中。数据中难免会有多余的字符，或者数据的格式不适合用作扫描目标列表。我可以使用 Bash 清理文件数据，并通过在终端中输入一行简单的代码，将其格式化成我需要的样子以便测试。

渗透测试工具接受各种格式的数据，并输出扫描结果或以常见格式如 XML、JSON 或纯文本显示的数据。纯文本输出可能会通过多个空格、制表符或两者的组合进行格式化。我通过管道将源文件的内容传递到 Bash 管道中，以解析、清理、重新格式化并排序数据。我可能会使用一组合适的 Bash 命令，在一个命令的输出和另一个命令的输入之间执行这些操作，形成自动化管道。Bash 确实是渗透测试工具箱中不可或缺的工具。

以下是我在渗透测试工作流中常用的一些 Bash 脚本应用：

+   **自动化网络扫描**：我经常处理 Masscan（一个快速的 TCP 扫描器）的输出，并将其输入到 Nmap 中进行深入的服务检测和脚本扫描。

+   **密码破解**：我使用一个 Bash 脚本，执行一系列复杂的密码破解功能，涉及破解 Microsoft LM 和 NTLM 哈希值，并将 Hashcat 的输出格式化，以便输入到报告工具中。

+   **文本搜索**：在文本中搜索 IP 地址或其他细节。

+   **范围自动化**：我使用子域枚举工具和 Bash 脚本，确保发现的子域在渗透测试的规则范围内。

+   **数据格式化**：我使用 Bash 解析和重新格式化 Nuclei 扫描的输出，从 TLS 证书中枚举子域和 Web 应用，并重新格式化数据以用于绕过 **内容分发网络**（**CDN**）绕过 **Web 应用防火墙**（**WAF**）并直接扫描目标。

+   **搜索和排序 Nmap 报告**：在扫描数百或甚至数千个 IP 地址后，我使用 Bash 解析 `gnmap` 文件，创建包含按 TCP 或 UDP 端口组织的目标的文本文件，以便进行更有针对性的扫描。例如，所有的 SMB 服务器或 HTTP 服务器的 IP 地址会被提取并放入名为 `smb.txt` 和 `http.txt` 的文件中。

+   **排序数据和去重**：将唯一的 IP 地址按顺序放入一个文件中进行去重。

+   **数据转换**：将姓名转换为多种格式用于密码喷洒。如果我能通过 **开源情报**（**OSINT**）获取员工姓名列表，我会查看任何可能提示他们的 Active Directory 姓名格式的信息，例如 `f.last` 或 `first.last`，然后使用 Bash 按适当的格式转换姓名。

+   **数据过滤**：有时，我需要从工具的输出日志文件中删除终端颜色代码，以便用于报告，因为我忘记了包括不显示颜色的命令行标志，或者该工具可能没有此选项。我不想为客户的报告截图时包含颜色代码，这会使数据难以阅读。

+   **数据迭代**：我使用 Bash `for` 和 `while` 循环来遍历文件，并对每一行运行一个命令。一个典型的例子是当你需要使用一个每次只能扫描一个主机的工具，且该工具没有处理多个目标的选项时。

我相信学习 Bash 脚本会让你在工作中更加高效，节省时间。当你能用 Bash 自动化那些时间密集、无聊的任务时，你就可以腾出时间去做更重要的事。难道不是很棒吗？你可以有更多时间用于学习或研究，而不是浪费在那些可以用很少的努力就能自动化的手动任务上。

现在我们对 Bash 有了基本了解，也明白了它在渗透测试中的用处，接下来我们来看看如何搭建一个实验室环境，在这里你可以安全地学习并跟随我的练习。下一节我们将介绍如何搭建实验室环境，以便你能跟着我一起学习。

# 实验室搭建

Bash 不是 Linux 和 Unix 系统上唯一的 Shell 解释器，但它是最常见的。其他 Shell 受到了 Bash 的影响。你可能还会在 macOS 和 Kali Linux 上遇到 Zsh。

你可能会好奇，尽管一些操作系统已经转向 Zsh，本书为何仍专注于 Bash。虽然 macOS 和 Kali 在新用户账户中已经转为使用 Zsh，但它们依然安装有 Bash。大多数为 Bash 编写的代码在 Zsh 上也能运行，只需做一些小的调整。你可以在脚本中加入 `shebang` 行，确保在多个 shell 系统中使用 Bash 解释器来执行脚本。在进行安全评估时，你很可能会遇到 Bash 是默认 shell 的 Linux 服务器。对于渗透测试人员来说，理解如何与 Bash 交互以利用应用程序、提升权限和横向移动是至关重要的。

幸运的是，你可以通过多种方式免费访问 Bash shell。本节将探讨在理想环境中访问 Bash shell 的各种方式，这样你可以跟随学习并掌握如何使用 Bash 进行渗透测试。我们还将探索一些易受攻击的实验环境，你可以在这些环境中安全地练习使用 Bash 和渗透测试工具。

虚拟机是跟随本书活动以及进行渗透测试时的首选方式。你可能会想在同一系统上安装渗透测试工具和漏洞利用代码，来处理日常的业务或个人事务。但安装各种工具的软件先决条件很容易破坏你的系统。黑客工具中可能包含恶意软件，感染你日常用来发送邮件或上网的系统。虚拟机提供了一个便捷的沙盒环境，所有你需要的内容都能快速恢复或更换测试环境。我在所有示范中都选择使用 Kali Linux。我们希望避免在日常工作或个人使用的同一系统中安装渗透测试工具和漏洞利用代码。最好使用一个干净的测试环境，以避免产生软件依赖问题。Kali 让安装与渗透测试相关的软件包变得非常简单。

## 虚拟机

使用 **虚拟机** 是首选方法。在进行渗透测试时，你很可能会安装大量的工具和漏洞利用概念验证代码。到某个阶段，你还可能会保存客户或目标的敏感数据。虚拟机提供了一个便捷的容器，你可以对其进行快照并恢复，或者在评估后轻松删除和替换。

有许多免费和付费的虚拟化解决方案，可以满足各种需求：

+   Oracle VirtualBox 是一款免费的 x86 虚拟化管理程序。它适用于 Windows、macOS（Intel 芯片组）和 Linux。VirtualBox 用户友好，深受初学者和专业人士的喜爱。它支持广泛的客户操作系统，并提供如快照、无缝模式和共享文件夹等功能。

+   VMware 提供了一款免费的虚拟化软件版本，名为 VMware Workstation Player，仅供非商业使用。它与 Windows 和 Linux 主机兼容。Workstation Player 使用简便，支持 VMware 的 VMDK 虚拟磁盘格式，并且与其他 VMware 产品创建的虚拟机兼容。

+   Microsoft Hyper-V 在 Windows 10 Pro、Enterprise 和 Education 版本中是免费的。虽然它更常用于服务器环境，但 Hyper-V 也可以作为 Microsoft Windows 主机上的桌面虚拟化的良好选择。

提示

对于使用 Apple CPU 的 macOS 用户，您的虚拟化选项有 UTM、Parallels 和 VMWare Fusion。UTM 是唯一免费的选项。

## Docker 容器

**Docker 容器**相比虚拟机提供了一个轻量级的选择。Docker 为 Windows、Linux 和 macOS 提供运行时。由于 Docker 使用主机的内核，它不需要像传统虚拟化软件那样虚拟化硬件，因此在低端硬件上，容器比虚拟机更加轻量和高效。

由于 Docker 使用主机的内核，您只能在与主机相同的操作系统上运行容器。Docker Desktop 是一个替代方案，它使用虚拟机运行与主机操作系统不同的容器。

根据我的经验，使用 Docker 有一些积极和消极的因素需要考虑。

Docker 更加轻量，是传统虚拟机的良好替代方案，尤其是在硬件不够强大的情况下。我为运行 Kali Linux 的虚拟机分配的最小硬件资源是 4 GB 的内存和 40 GB 的磁盘空间。您并不总是会使用到这 4 GB/40 GB 的资源。同时，除非您关闭虚拟机、调整内存并扩展磁盘，否则您会被限制在这些数值范围内。Docker 容器以本地进程运行（不包括 Docker Desktop），因此它只会使用运行容器所需的内存和磁盘空间。

在 Linux 主机上，您可以将容器直接附加到主机网络，并根据需要打开和关闭端口，前提是您包含特定的命令行参数。这使您可以在不停止和启动容器的情况下，动态地打开主机网络适配器上的监听服务器端口。您还可以将容器附加到 USB 或串行端口，以便与硬件设备进行交互。当我需要运行一个与 USB 或串行设备接口的旧 Python2 渗透测试应用程序，用于无线频率和硬件黑客攻击时，我有时会使用这个选项。

使用 Docker Desktop 时，NAT 用于将容器网络端口连接到主机网络，因此，如果需要关闭或打开额外的端口，必须停止并重新启动容器。在 Docker Desktop 中，无法将容器附加到硬件设备。当你在容器中配置了应用程序及其依赖项，之后摧毁容器并启动一个新实例时，你可能会失去工作进度并需要重新开始，特别是当你只是想为反向监听器或服务器应用程序打开另一个 TCP 端口时，这会让人感到沮丧。

总结来说，我更倾向于仅在 Linux 主机上使用 Docker，并且我将其用于三种特定的渗透测试场景：

+   它提供了一种轻松隔离旧版 Python 2 应用程序并避免依赖地狱的方式。对于所有 Python 2 和 3 版本，Docker 都有官方容器。

+   我用它来创建和运行通过我的包管理器无法获得的应用程序，并且我想避免浪费时间解决依赖问题。例如，某个黑客工具可以通过 Kali 软件库获得，但在 Ubuntu 中无法使用。我可以创建一个简洁的 Kali 容器，只使用足够的资源来运行其中的应用程序，并在 `~/.bashrc` 文件中使用别名，将冗长的 `docker run` 命令缩短为我可以在终端中输入的单个单词。当我只想运行一个无法或难以在主机系统上运行的应用程序时，这是比沉重的虚拟机更快、更轻量的选择。

+   当我想练习利用或创建针对最近公布的易受攻击的 web 应用程序的利用工具时，我通常可以找到一个 Docker 容器，让我立即启动这个易受攻击的应用程序，而无需花费宝贵的时间进行安装和配置。

Docker 容器非常适合特定的使用场景。然而，它们不如虚拟机更受青睐。接下来，我们将探讨将 live USB 系统作为虚拟机和容器的替代方案。

## Live USB

`Live USB` 是一种将操作系统镜像写入 USB 硬盘的方式，使其可以启动。Live USB 是当计算机没有足够的硬件资源运行虚拟机时的一个不错选择。你可以使用镜像软件将 Linux ISO 镜像刻录到 USB 并启动 Linux 操作系统。在 Linux 上完成工作后，你只需重新启动计算机并拔掉 USB 驱动器，即可恢复到已安装的操作系统。某些 Linux 发行版允许你在 USB 驱动器上创建持久存储，这样你在重启时就不会丢失更改。

以下是通过 live USB 运行 Linux 发行版的一些常规步骤：

1.  下载 ISO 镜像。一些受渗透测试者喜爱的 Linux 发行版包括 Kali、Parrot Security OS 和 BlackArch。

1.  创建一个 live USB 驱动器。常用的工具包括 Rufus、balenaEtcher 和 Linux 的`dd`命令。

1.  配置持久性（可选）。这通常涉及在 USB 驱动器上创建一个独立的分区，并配置引导加载程序以识别并使用此分区。你可以在 [`www.kali.org/docs/usb/usb-persistence/`](https://www.kali.org/docs/usb/usb-persistence/) 找到创建 live USB Kali 系统所需的文档步骤。

使用 live USB 时有一些考虑事项和缺点：

+   USB 存储通常比直接从 SSD 运行要慢。如果你使用 live USB，请确保使用 USB 3.0 或 3.1 标准，以获得最佳性能。

+   始终从官方来源下载 ISO 镜像，并在信任之前验证其校验和。

+   如果你计划将其用于生产环境，请务必使用加密的持久性存储，因为存在将驱动器上的敏感数据暴露给未授权人员的风险。

现在，让我们继续讨论基于云的系统。

## 基于云的系统

许多云平台为访问具有足够资源以应对适度工作负载的 Linux 系统创建了免费层。提供免费层的云服务商包括`Google Cloud Platform`（**GCP**）、Microsoft Azure 和 Amazon EC2。请注意，免费层可能不足以提供生产环境所需的 RAM，且不适合运行 Kali Linux 镜像。

Kali Linux 提供了用于在 AWS、Digital Ocean、Linode 和 Azure 上运行的文档和市场镜像（[`www.kali.org/docs/cloud/`](https://www.kali.org/docs/cloud/)）。我有与客户合作的经验，他们在云中配置 Kali 以进行云安全评估，或通过 VPN 连接到其内部网络基础设施以促进内部网络渗透测试。如果客户的内部网络已经通过 VPN 与云服务提供商连接，那么他们可以相对轻松地启动 Kali 镜像并创建防火墙规则，允许从我的 IP 地址进行 SSH 访问。现在我们已经探讨了使用 Bash 运行渗透测试系统的选项，让我们来发现一些可以在实验室中使用的易受攻击的系统，以进行实践。

## 易受攻击的实验室目标

在后续章节中跟随一些与渗透测试方法论相关的内容时，能够访问易受攻击的目标会对你运行命令并开发 Bash 脚本有很大帮助。你可以从几个很好的来源获取易受攻击的目标，用于在你的实验室中进行实践。

Metasploitable 2 是由 Rapid7 提供的一个易受攻击的虚拟机。它的设计目的是展示 Metasploit 框架的功能。Metasploitable 2 也是一个很好的初学者挑战，帮助你发展黑客方法论，并学习用于渗透测试的 Bash。该项目需要适度的资源来运行虚拟机，并包含有关机器漏洞的文档（*Metasploitable 2 | Metasploit* *Documentation* ，[`docs.rapid7.com/metasploit/metasploitable-2/`](https://docs.rapid7.com/metasploit/metasploitable-2/)）。

活跃目录游戏（GOAD）也是一个选项。

*“GOAD 是一个渗透测试的 Active Directory 实验室项目。该实验室的目的是为渗透测试人员提供一个易受攻击的 Active Directory 环境，供他们练习常见的攻击技术。”* (*Active Directory 的游戏 –* *Orange-CyberDefense*，[`github.com/Orange-Cyberdefense/GOAD`](https://github.com/Orange-Cyberdefense/GOAD))

请注意，GOAD 是免费的，并且使用免费的微软 Windows 许可证，激活期限为 180 天。GOAD 是我找到的用于在内部 Active Directory 网络环境中练习黑客技术的最佳资源。

MayFly 是 GOAD 的创建者。他们的网站上有大量关于如何在不同虚拟机虚拟化平台上设置 GOAD 的文章，以及使用常见渗透测试工具进行 Active Directory 攻击的实验室指南。

提示

MayFly 还发布了一个全面的 Active Directory 渗透测试思维导图。尽管我在黑客攻击 Active Directory 上有多年的经验，但我仍然发现自己有时会用尽测试的项目，并且在遇到卡壳或者想确保自己没有遗漏任何地方时，我会参考这张思维导图。这张思维导图也是我推荐给初学渗透测试的年轻渗透测试员的首要资源，帮助他们学习 Active Directory 黑客技术和工具（你可以在 [`orange-cyberdefense.github.io/ocd-mindmaps/img/pentest_ad_dark_2022_11.svg`](https://orange-cyberdefense.github.io/ocd-mindmaps/img/pentest_ad_dark_2022_11.svg) 上查看更多细节）。

如果你希望在 web 应用程序上练习 Bash 脚本、工具和方法，OWASP Juice Shop 是一个很好的资源。

*“OWASP Juice Shop 可能是最现代、最复杂的不安全 web 应用程序！它可以用于安全培训、意识演示、CTF 以及作为安全工具的试验品！Juice Shop 包含了整个 OWASP 前十漏洞（[`owasp.org/www-project-top-ten/`](https://owasp.org/www-project-top-ten/)）的漏洞，以及在现实世界应用程序中发现的许多其他安全缺陷！”* (*OWASP Juice Shop – OWASP* *基金会*，[`owasp.org/www-project-juice-shop/`](https://owasp.org/www-project-juice-shop/))

一个较老但仍然非常相关的脆弱 web 应用程序是 Mutillidae II。

*“OWASP Mutillidae II 是一个免费的开源故意设计为脆弱的 web 应用程序，旨在为 web 安全培训提供目标。它包含了数十个漏洞，并提供了帮助用户的提示，是一个易于使用的 web 黑客环境，专为实验室、安全爱好者、课堂、CTF 和漏洞评估工具目标设计。”* (*OWASP Mutillidae II – OWASP* *基金会*，[`owasp.org/www-project-mutillidae-ii/`](https://owasp.org/www-project-mutillidae-ii/))

我喜欢 Mutillidae 的一件事是它在内容中嵌入了提示、教程和视频教程。Mutillidae 是我很多年前作为初级渗透测试员时学习 Web 应用测试的资源。Juice Shop 和 Mutillidae 之间的区别在于，Juice Shop 是一个现代化的 Web 应用，使用了 JavaScript 框架，而 Mutillidae 是一个更传统的 Web 应用。虽然 Juice Shop 有一个排行榜，并且你可以在线找到第三方的教程，Mutillidae 在应用中嵌入了大量的培训文本和视频。

网络安全领域始终在变化，新的漏洞定期被发现。实验室设置是进行研究和开发的理想场所，它让你能够安全地实验这些漏洞。这里是你通过发现新漏洞或改进现有渗透测试方法来为网络安全社区做出贡献的地方。

现在我们已经探索了渗透测试实验室中的易受攻击目标，接下来，我们将讨论如何定制你的 Bash shell，以便它符合你的需求和个人风格。

# 配置你的黑客 shell

如果你正在使用 Kali Linux 或 macOS，请注意，默认情况下你的终端 shell 使用的是 Zsh，而不是 Bash。Zsh 有更多功能（例如更好的标签补全和主题支持），但 Bash 更加广泛且标准。Bash 自 80 年代末期就已经存在，是 shell 领域的老将。它是大多数 Linux 发行版和 macOS（直到 Catalina 版本，Zsh 才接管）的默认 shell。Bash 的长寿意味着它极为稳定并且得到良好的支持。

Zsh，相比之下，稍晚一些出现。它以比 Bash 更优秀的交互性和更强大的脚本功能而闻名。

你可以通过在终端中输入`echo $SHELL`命令来确定配置了哪个 shell。书中展示的几乎所有代码都可以在 Bash 和 Zsh 中运行，除非特别注明。在我的日常渗透测试活动中，我很少注意到任何区别。然而，如果你想将 shell 从 Zsh 更改为 Bash，可以在终端中执行`chsh -s /bin/bash`命令，然后登出并重新登录，以查看更改生效。

Bash 配置文件可以在用户的主目录`/home/username` 中找到。由于文件名以点（.）开头，它们通常被称为*dotfiles*。以下配置文件用于配置 Bash shell：

+   `~/.bash_profile` : 此文件在交互式登录时执行，用于初始化用户环境。可以把交互式登录看作是通过命令行登录，例如通过 SSH 会话访问一个基于文本的终端。

+   `~/.bashrc` : 此文件用于在通过**图形用户界面**（**GUI**）登录时配置终端。此文件包含别名、函数、提示符定制和环境变量等设置。

+   `~/.bash_logout`：当你的会话结束时会执行此文件。它用于执行与注销时清理环境相关的任务。

提示

如果你不理解波浪号（**~**）字符和点文件名前的斜杠的作用，波浪号字符代表用户的主目录。`~/.bashrc` 路径相当于 `/home/username/.bashrc`。这个概念将在 *第二章* 中讲解。

你最常见的编辑包括添加别名和函数，以及自定义 `~/.bashrc` 文件中的命令提示符。别名是一个很好的方法，可以将长的或复杂的命令缩短为一个单词。函数更为复杂，可以把函数看作是一个短脚本，你可以将其包含在 shell 配置中，并通过名字在终端中调用。函数将在稍后的 *第五章* 中讲解。

下面是我在`~/.bashrc`文件中用于搜索文本中 IP 地址的别名示例：

```
 alias grepip="grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}'"
```

你可以看到这个命令很难记住，所以创建一个别名对于任何你可能需要反复使用的复杂命令是很有帮助的。

重要提示

当你编辑 Bash 配置文件时，你必须退出并重新登录，或者获取文件以使更改生效。

输入以下命令以获取文件并立即生效：

```
 $ source ~/.bashrc
```

现在你已经理解了 Bash 点文件的作用，让我们继续了解如何编辑它们来个性化我们的环境。

## 自定义 Bash 提示符

提示符是你在 Bash 终端中输入命令的地方。你的提示符可以简单或复杂，取决于你的喜好和个性。可以把你的提示符设计选择想象成画家挑选调色板的方式。

你可以通过在 `~/.bashrc` 文件中查找以 `PS1` 开头的行来找到当前配置的提示符。一个常见的 Bash 提示符会使用类似 `export PS1="\u@\h \w\$ "` 的 `PS1` 值，它会在提示符处显示为 `username@hostname ~$`。让我们来拆解一下。以下是每个部分的作用：

+   `\u` 会被当前用户名替换。

+   `@` 是一个字面字符，会出现在用户名之后。

+   `\h` 会被主机名替换，直到第一个句点为止。

+   `\w` 会被当前工作目录替换，`$HOME` 会被缩写为波浪号字符。

+   `\$` 显示普通用户的 `$` 字符，或显示根用户的 `#` 字符。

一旦你编辑了 `PS1` 提示符，记得获取文件，以便看到更改生效。

你也可以非常炫酷地定制你的提示符。我曾经在我的`PS1`提示符中插入`$(ip a show eth0 | grep -m 1 inet | tr -s ' ' | cut -d ' ' -f 3)`字符串，用来显示我的 IP 地址，以便在我的日志或报告截图中捕捉，并帮助客户将我的活动与他们的**安全信息和事件管理**（**SIEM**）警报关联起来。请参见[`bash-prompt-generator.org/`](https://bash-prompt-generator.org/) 了解图形化的 Bash 提示符生成器，或者查阅官方 Bash 手册获取所有选项。

定制 Bash 环境就是让你的终端为你工作。这是一个不断试验和改进的过程，找出什么能让你更高效，什么能为你的命令行会话带来一点乐趣。从小处着手，实验一下，看看一些改变能如何大大改善你每天的任务。

# 设置基本的渗透测试工具

在这一部分，我们将介绍通过更新系统软件包并安装必要的工具来设置我们的渗透测试环境。大多数所需的工具已经预装在 Kali 中，所以我们只需要再安装几个软件包。

## 更新包管理器

使用新 Linux 安装时的第一步应该是更新软件包。正如前面所说，我将在所有演示中使用 Kali Linux。Kali 基于 Debian Linux 发行版，使用**高级包管理工具**（**APT**）包管理器。在其核心，`apt`简化了软件管理。它自动化了从预定义的仓库中获取、配置和安装软件包的过程。这个自动化不仅节省了时间，还确保在没有人工干预的情况下解决软件依赖关系。

运行`sudo apt update`可以刷新本地可用软件包及其版本的数据库，确保你从仓库获取到最新的信息。在安装新软件或更新现有软件包之前，这一步是至关重要的，确保你得到的是最新版本。如果你使用的是 Kali、Ubuntu 或 Debian Linux，以下的更新和升级命令将按预期工作，因为它们都使用`apt`包管理器：

```
 $ sudo apt update && sudo apt upgrade -y && reboot
```

在前面的命令中，我们使用`sudo`提升权限，使用`apt`更新可用软件包的列表。双重与符号（**&&**）像逻辑与操作符一样工作；第二个命令用于在不提示的情况下升级软件包（**-y**），仅在第一个命令成功执行时才会运行。最后，我们重启系统以确保所有服务和内核更新生效。

## 安装 ProjectDiscovery 工具

`ProjectDiscovery`提供了一些我推荐用于渗透测试的工具（PDTM – ProjectDiscovery，[`github.com/projectdiscovery/pdtm`](https://github.com/projectdiscovery/pdtm)）。在安装它们之前，我们必须安装 Go 编程语言运行时和库。按照以下步骤操作：

1.  在你的网页浏览器中，导航到[`go.dev/dl/`](https://go.dev/dl/)。

1.  下载适用于你 Linux 发行版的正确包。确保仔细查看处理器架构。通常，这将是一个`Kind`值为`archive`，`OS`值为`Linux`，`Arch`值为`x86-64`或`ARM64`。

1.  解压下载的压缩包。确保更改包版本，以使其与所下载的版本匹配：

    ```
    $ sudo tar -C /usr/local -xzf go1.22.0.linux-amd64.tar.gz
    ```

1.  将`/usr/local/go/bin`添加到你`~/.bashrc`文件中的`PATH`环境变量中。`PATH`环境变量告诉你的 Bash shell 在你没有在命令前加上路径时在哪里找到可执行程序的完整路径。`echo`命令会将引号内的文本打印到终端，且大于号（**>**）将输出重定向到文件。请注意，我们在这里使用了两个大于号来重定向输出。如果只使用一个，它将覆盖文件内容。我们希望通过使用两个符号将内容追加到文件中：

    ```
    $ echo "export PATH=$PATH:/usr/local/go/bin" >> ~/.bashrc
    ```

1.  获取文件以执行你的更改：

    ```
    $ source ~/.bashrc
    ```

1.  检查确保`/usr/local/go/bin`已被添加到你的`PATH`中（请查看最后一个冒号字符之后的部分）：

    ```
    $ echo $PATH
    /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games:/usr/local/go/bin
    ```

1.  验证 Go 是否已正确安装，并且可以在你的`PATH`中找到。你的版本和架构可能有所不同：

    ```
    $ go version
    go version go1.22.0 linux/arm64
    ```

1.  从 ProjectDiscovery 安装`pdtm`。这是一个安装和管理所有 ProjectDiscovery 工具更新的工具：

    ```
    $ go install -v github.com/projectdiscovery/pdtm/cmd/pdtm@latest
    ```

1.  将`pdtm`添加到你的路径中：

    ```
    $ echo "export PATH=$PATH:$HOME/.pdtm/go/bin" >> ~/.bashrc
    ```

1.  运行以下`pdtm`命令以安装所有工具：

    ```
    $ pdtm -install-all
    ```

1.  为`naabu`安装`libpcap`：

    ```
    $ sudo apt install -y libpcap-dev
    ```

这就完成了安装所有必需的 ProjectDiscovery 工具。

## 安装 NetExec

*NetExec 是一个网络服务利用工具，帮助自动化评估大型网络的安全性*（*NetExec* *wiki*，[`www.netexec.wiki/`](https://www.netexec.wiki/)）。

在我看来，NetExec 是内部网络渗透测试中最有用的工具之一。它支持大多数在内部网络渗透测试中需要的网络协议，还支持 Microsoft Active Directory 测试。

这里列举的功能太多，无法一一列出。我使用 NetExec 的一些功能包括以下内容：

+   扫描漏洞；NetExec 包括一些有用的模块来测试常见漏洞

+   对身份验证进行暴力破解攻击，以测试弱密码

+   向服务器喷射密码或密码哈希，以查找提供的凭据在哪些地方具有本地管理员访问权限

+   命令执行

+   收集凭据

+   枚举 SMB 共享的读/写访问权限

输入以下命令来安装 NetExec：

```
 $ sudo apt install -y pipx git && pipx ensurepath && pipx install git+https://github.com/Pennyw0rth/NetExec
```

这就完成了安装最常用的渗透测试工具的过程，这些工具默认情况下未安装。

# 总结

在本章中，您已经了解了不可或缺的 Bash Shell 脚本世界，这是任何有志于在渗透测试中脱颖而出的人必备的核心技能。本章开始时，我们解开了 Bash 的神秘面纱，并强调了它在网络安全任务中的重要性。这不仅仅是记住命令，更是利用 Bash 来自动化重复任务、处理数据，并高效地进行安全评估。接下来的内容提供了如何选择支持 Bash 的操作系统的指导，为成功的脚本编写奠定了基础。然后，我们卷起袖子，配置了我们的黑客 Shell，定制了其外观和行为，以反映个人的品味和偏好。这种定制不仅仅是为了美观，更是为了创建一个功能强大且高效的工作环境。最后，本章介绍了必备的渗透测试工具，带领您完成了它们的安装和基础使用。到此为止，您已经具备了一个准备充分的环境，并对 Bash 脚本如何显著提升您的渗透测试能力有了基础的理解。

下一章将介绍处理文件和目录的技巧。
