# 第二章：信息收集和扫描

在本章中，我们将涵盖：

+   被动信息收集 1.0-传统方式

+   被动信息收集 2.0-下一个级别

+   端口扫描-Nmap 方式

+   探索用于扫描的辅助模块

+   使用辅助模块进行目标服务扫描

+   使用 Nessus 进行漏洞扫描

+   使用 NeXpose 进行扫描

+   使用 Dradis 框架共享信息

# 介绍

信息收集是渗透测试的第一步基本步骤。这一步是为了尽可能多地了解目标机器的信息。我们拥有的信息越多，就越有可能利用目标。在信息收集阶段，我们的主要重点是收集有关目标机器的事实，比如 IP 地址、可用服务、开放端口。这些信息在渗透测试过程中起着至关重要的作用。信息收集中基本上使用了三种类型的技术。

+   被动信息收集

+   主动信息收集

+   社会工程学

让我们快速了解这些过程：

+   被动信息收集：这种技术用于在没有任何物理连接或访问的情况下获取有关目标的信息。这意味着我们使用其他来源来获取有关目标的信息，比如使用`whois`查询、`Nslookup`等。假设我们的目标是一个在线 Web 应用程序，那么简单的`whois`查询可以为我们提供大量关于 Web 应用程序的信息，比如其 IP 地址、域和子域、服务器位置、托管服务器等。这些信息在渗透测试期间可能非常有用，因为它可以扩大我们利用目标的轨迹。

+   主动信息收集：在这种技术中，建立与目标的逻辑连接以获取信息。这种技术为我们提供了下一个级别的信息，可以直接帮助我们了解目标的安全性。端口扫描；目标是最广泛使用的主动扫描技术，我们关注的是目标上运行的开放端口和可用服务。

+   社会工程学：这种信息收集类似于被动信息收集，但依赖于人为错误和以打印输出、电话对话或不正确的电子邮件 ID 等形式泄露的信息。利用这种方法的技术是多种多样的，信息收集的伦理非常不同，因此，社会工程学是一个独立的类别。例如，黑客注册拼写错误相似的域名，并设置邮件服务器以接收这些错误的电子邮件。这样的域名被称为 Doppelganger Domains，即邪恶的双胞胎。

在本章中，我们将详细分析各种被动和主动信息收集技术。在开始的两个步骤中，我们将分析被动信息收集中最常用和最常被忽视的技术，然后在后续步骤中，我们将专注于通过端口扫描获取信息。Metasploit 具有几种内置的扫描功能，以及一些集成到其中以进一步增强端口扫描过程的第三方工具。我们将分析内置扫描仪以及一些流行的第三方扫描仪，这些扫描仪可以在 Metasploit 框架上运行。让我们继续进行步骤，并开始获取有关我们目标的信息的过程。

# 被动信息收集 1.0-传统方式

让我们来处理一些最常用的信息收集技术。

## 准备就绪

`whois`，`Dig`和`Nslookup`是获取有关我们目标的初始信息的三个最基本和最简单的步骤。由于这两者都是 passiv 技术，因此不需要与目标进行连接。这些命令可以直接从`BackTrack`的终端执行。因此，打开终端窗口并继续进行。

## 如何做...

我们将从简单的`whois`查找开始我们的信息收集。`whois`是`BackTrack`中的内置命令，因此我们可以直接从终端调用它。

让我们快速对[www.packtpub.com](http://www.packtpub.com)进行`whois`查找并分析输出。输出可能很大，所以这里我们只关注输出的相关要点。

```
root@bt:~# whois www.packtpub.com
Domain Name: PACKTPUB.COM
Registrar: EASYDNS TECHNOLOGIES, INC.
Whois Server: whois.easydns.com
Referral URL: http://www.easydns.com
Name Server: NS1.EASYDNS.COM
Name Server: NS2.EASYDNS.COM
Name Server: NS3.EASYDNS.ORG
Name Server: NS6.EASYDNS.NET
Name Server: REMOTE1.EASYDNS.COM
Name Server: REMOTE2.EASYDNS.COM
Status: clientTransferProhibited
Status: clientUpdateProhibited
Updated Date: 09-feb-2011
Creation Date: 09-may-2003
Expiration Date: 09-may-2016

```

在这里，我们可以看到简单的`whois`查找已经揭示了有关目标网站的一些信息。信息包括 DNS 服务器、创建日期、到期日期等。由于此信息是从目标以外的来源收集的，因此被称为被动信息收集技术。

被动获取信息的另一种方式可以通过查询 DNS 记录。最常见的技术是使用 Unix 机器中默认的`dig`命令。让我们分析一下对[www.packtpub.com](http://www.packtpub.com)的`dig`查询。

```
 root@bt:~# dig www.packtpub.com
; <<>> DiG 9.7.0-P1 <<>> www.packtpub.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 1583
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 6, ADDITIONAL: 1
;; QUESTION SECTION:
;www.packtpub.com. IN A
;; ANSWER SECTION:
www.packtpub.com. 1200 IN CNAME packtpub.com.
packtpub.com. 1200 IN A 83.166.169.228
;; AUTHORITY SECTION:
packtpub.com. 1200 IN NS remote1.easydns.com.
packtpub.com. 1200 IN NS ns2.easydns.com.
packtpub.com. 1200 IN NS ns6.easydns.net.
packtpub.com. 1200 IN NS ns3.easydns.org.
packtpub.com. 1200 IN NS ns1.easydns.com.
packtpub.com. 1200 IN NS remote2.easydns.com.
;; ADDITIONAL SECTION:
ns3.easydns.org. 5951 IN A 64.68.192.10 
```

查询 DNS 记录已经揭示了有关目标的更多信息。`dig`可以用于将主机的名称解析为 IP 地址，反之亦然。此外，`dig`还可以用于从可能用于帮助利用主机的名称服务器中收集版本信息。正如我们在输出中所看到的，很难识别主 DNS，或者在某些情况下是主邮件服务器或文件托管服务器等。这就是`Nslookup`出现的地方。`Nslookup`几乎和 dig 一样灵活，但提供了一个更简单的默认方法来识别主机，例如邮件和 DNS 服务器。

```
 root@bt:~# nslookup www.packtpub.com
Server: 220.226.6.104
Address: 220.226.6.104#53
Non-authoritative answer:
www.packtpub.com canonical name = packtpub.com.
Name: packtpub.com
Address: 83.166.169.228 
```

`Nslookup`已经揭示了有关目标的更多信息，例如其 IP 地址、服务器 IP 等。这些被动技术可以揭示有关目标的一些有趣信息，并可以为我们的渗透测试铺平道路。

## 工作原理...

`dig`可以用来查找**SPF**（发件人策略框架）记录。 SPF 记录是定义域的邮件发送策略的记录，即哪些服务器负责代表其发送邮件。不正确的 SPF 记录总会导致钓鱼/垃圾邮件。

SPF 记录以文本格式发布。 SPF 记录负责确保特定域的注册用户或特定域的合作伙伴不会受到钓鱼邮件的攻击。从`dig`查询中收集的信息可以帮助我们确定目标中的此类问题。

## 还有更多...

让我们更多地了解被动信息收集。

### 使用第三方网站

我们已经使用内置命令查询了有关我们目标的信息。还有一种同样好的技术，可以使用专门用于此类查找的网站，特别是提供有关地理位置、联系电话、管理员电子邮件等信息的网站。

一些有用的链接是：

[`who.is`](http://who.is)

[`www.kloth.net`](http://www.kloth.net)

# 被动信息收集 2.0-下一个级别

每个安全专业人员都知道前面一篇文章中讨论的信息收集技术。但是有一些技术分析人员因其较低的流行度和认知度而忽视，但它们可以产生与前一技术一样好的结果。我们将在这里讨论的技术涉及对我们目标的更深入分析，尽管我们仍将使用被动技术。这些技术不需要使用 Metasploit，但由于信息收集对于渗透测试是一个重要领域，因此我们将在这里讨论它。

## 准备工作

在这个配方中，我们将了解三种技术：

+   **区域传输：** 这可以使用终端执行。

+   **SMTP 头部：** 对于这种技术，我们需要目标发送给渗透测试人员的电子邮件。

+   **Google dork：** 这是一种简单但有用的通过搜索引擎获取信息的技术。

让我们从区域传输开始。

## 如何做到...

**区域传输**是 DNS 服务器用来在多个服务器之间交换域的权威记录的一种特殊方法。这种方法负责在主服务器和辅助服务器之间传输大量的域信息列表。配置错误的 DNS 服务器可以响应客户端查询并提供有关查询域的信息。

考虑以下示例，在该示例中，查询`dig @ns1.example.com example.com axfr`返回一个 IP 地址列表及其对应的主机名：

![如何做到...](img/7423_02_01.jpg)

这个查询已经识别出十个主机名，其中有八个唯一的主机属于`example.com`。我们可以看到主机名足够描述性，可以清楚地了解正在运行的服务类型。

分析 SMTP 头部可能是收集有关目标信息的另一个潜在来源。它可以为我们提供有关邮件服务器、其 IP 地址、版本等信息。这种方法的唯一缺点是我们需要一封从目标位置发送的电子邮件来进行分析。以下截图显示了从目标发送的邮件头部的一部分。

![如何做到...](img/7423_02_02.jpg)

对头部的仔细分析显示邮件服务器的 IP 地址是 83.166.169.248。邮件服务器使用 ESMTP 服务，用户使用 IMAP 服务。这些额外的信息在进一步探索目标时非常有用。

最后一种技术是使用**Google dorks**。这种方法只能在某些情况下起作用，但值得一试，因为你永远不知道它可能揭示的秘密信息。许多时候，Google 爬虫会到达存储在目标服务器上供内部使用的某些文件或文档，但由于互联网访问，爬虫会将文档索引到搜索结果中。在这种情况下，我们可以使用一些 Google 搜索技巧来寻找这样的文件。在搜索结果中**site**和**filetype**的组合可以揭示一些令人兴奋的东西。

例如，在 Google 中执行以下搜索查询：

+   `www.target .com filetype:xls`

+   `www.target.com filetype:pdf`

+   `site:www.target.com filetype:db`

同样，我们可以尝试几种不同的组合来从 Google 搜索中挖掘结果。

## 它是如何工作的...

`dig`查询基本上返回在 IP 或域所有者注册时提供的数据。区域传输信息特别提供给 DNS 服务器，以便建立正确的注册域的映射。`dig`查询可以帮助获取这些信息。SMTP 头部是电子邮件的原始数据主体。由于它是电子邮件的主要数据表示，它包含了关于发件人的大量信息。 

Google dorks 只是 Google 爬虫索引的各种文件的搜索结果。一旦文件在 Google 搜索中被索引，就可以使用一些特定的搜索类型查看它。

## 还有更多...

### 与 dorks 一起玩耍

[www.jhony.ihackstuff.com](http://www.jhony.ihackstuff.com) 是 Google dorks 的最全面指南，您可以在其中找到许多关于目标的隐藏信息的完整 dorks 列表。

# 端口扫描 - Nmap 方式

端口扫描是一种主动的信息收集技术，我们现在将直接开始处理我们的目标。端口扫描是一种有趣的信息收集过程。它涉及对目标机器的深入搜索。`Nmap`是安全专业人员最强大和首选的扫描器。`Nmap`的使用范围从初学者到高级水平不等。我们将详细分析各种扫描技术。

## 准备工作

从`Metasploit`启动`nmap`很容易。启动`msf`控制台，输入`nmap`以显示`Nmap`提供的扫描选项列表。

```
msf > nmap

```

## 如何做...

我们将分析四种不同类型的`Nmap`扫描，在渗透测试过程中非常有帮助。`Nmap`提供了许多不同的扫描模式来扫描目标机器。在这里，我们将重点关注四种扫描类型，即**TCP 连接扫描、SYN 隐秘扫描、UDP 扫描**和**ACK 扫描**。`Nmap`的不同扫描选项也可以组合在单个扫描中，以执行更高级和复杂的目标扫描。让我们继续并开始扫描过程。

**TCP 连接[-sT]**扫描是`Nmap`中最基本和默认的扫描类型。它遵循三次握手过程来检测目标机器上的开放端口。让我们在目标上执行这种扫描。

```
msf > nmap -sT -p1-10000 192.168.56.102 [*] exec: nmap -sT -p1-10000 192.168.56.102 Starting Nmap 5.51SVN ( http://nmap.org ) at 2011-10-19 00:03 IST Nmap scan report for 192.168.56.102 Host is up (0.0058s latency).
Not shown: 9997 closed ports
PORT STATE SERVICE 135/tcp open msrpc 139/tcp open netbios-ssn 445/tcp open microsoft-ds MAC Address: 08:00:27:34:A8:87 (Cadmus Computer Systems 
```

正如我们所看到的，我们传递了`-sT`参数，表示我们要执行 TCP 连接扫描。`-p`参数显示我们要扫描的端口号范围。TCP 连接扫描基于三次握手过程，因此返回的扫描结果被认为是准确的。

**SYN 扫描[-sS]**被认为是一种隐秘的扫描技术，因为它从不在目标和扫描器之间形成完整的连接。因此，它也被称为半开放扫描。让我们分析一下对目标的 SYN 扫描。

```
msf > nmap -sS 192.168.56.102 [*] exec: nmap -sS 192.168.56.102 Starting Nmap 5.51SVN ( http://nmap.org ) at 2011-10-19 00:17 IST Nmap scan report for 192.168.56.102 Host is up (0.0019s latency).
Not shown: 997 closed ports
PORT STATE SERVICE 135/tcp open msrpc 139/tcp open netbios-ssn 445/tcp open microsoft-ds MAC Address: 08:00:27:34:A8:87 (Cadmus Computer Systems 

```

`-sS`参数将指示`Nmap`在目标机器上执行 SYN 扫描。在大多数情况下，TCP 连接和 SYN 扫描的输出是相似的，但唯一的区别在于 SYN 扫描难以被防火墙和入侵检测系统（IDS）检测到。然而，现代防火墙也足够能够捕捉到 SYN 扫描。

**UDP 扫描[-sU]**是用于识别目标上开放 UDP 端口的扫描技术。将 0 字节的 UDP 数据包发送到目标机器，而收到 ICMP 端口不可达消息的接收者表明该端口已关闭，否则被视为打开。可以这样使用：

```
msf > nmap -sU -p9001 192.168.56.102

```

以下命令将检查 192.168.56.102 上的 UDP 端口是否打开。同样，我们可以通过修改`-p`操作符在完整的端口范围上执行 UDP 扫描。

**ACK 扫描[-sA]**是一种特殊的扫描类型，可以告诉防火墙过滤或未过滤哪些端口。它通过向远程端口发送 TCP ACK 帧来操作。如果没有响应，则被视为过滤端口。如果目标返回 RST 数据包（连接重置），则该端口被视为未过滤端口。

```
msf > nmap -sA 192.168.56.102 [*] exec: nmap -sA 192.168.56.102 Starting Nmap 5.51SVN ( http://nmap.org ) at 2011-10-19 00:19 IST Nmap scan report for 192.168.56.102 Host is up (0.0011s latency).
Not shown: 999 filtered ports
PORT STATE SERVICE 9001/tcp unfiltered tor-orport
MAC Address: 08:00:27:34:A8:87 (Cadmus Computer Systems)

```

上述输出显示了对目标执行的 ACK 扫描的结果。输出显示目标上的所有端口都被过滤，除了端口号为 9001 的未过滤端口。这将帮助我们找出目标的弱点，因为攻击未过滤端口将更有可能成功利用目标。

## 工作原理...

一般来说，渗透测试人员不会过分强调扫描过程，但是良好的扫描可以提供许多有用的结果。由于这里收集的信息将构成渗透测试的基础，因此强烈建议对扫描类型有适当的了解。现在让我们深入了解我们刚学到的每种扫描技术。

TCP 连接扫描是最基本的扫描技术，它与测试端口建立完整的连接。它使用操作系统的网络功能来建立连接。扫描器向目标机器发送一个 SYN 数据包。如果端口打开，则返回一个 ACK 消息给扫描器。然后扫描器向目标发送一个 ACK 数据包，显示成功建立连接。这被称为三次握手过程。一旦打开连接，连接就会终止。这种技术有其好处，但易于被防火墙和 IDS 追踪。

SYN 扫描是另一种 TCP 扫描类型，但它从不与目标建立完整的连接。它不使用操作系统的网络功能，而是生成原始 IP 数据包并监视响应。如果端口打开，则目标将以 ACK 消息做出响应。然后扫描器发送 RST（重置连接）消息并结束连接。因此，它也被称为**半开放扫描**。这被认为是一种隐蔽扫描技术，因为它可以避免在一些配置错误的防火墙和 IDS 中引发警报。

UDP 扫描是一种无连接的扫描技术，因此没有通知被发送回扫描器，告知数据包是否已被目标接收。如果端口关闭，则会向扫描器发送 ICMP 端口不可达消息。如果没有收到消息，则报告端口为打开状态。由于防火墙可以阻止数据包，因此此方法可能返回错误结果，因此不会生成响应消息，扫描器将报告端口为打开状态。

ACK 扫描的唯一目的是识别被过滤和未被过滤的端口。这是一种独特而方便的扫描技术，可以帮助找到目标系统的弱点，因为未被过滤的端口可能是易受攻击的目标。但 ACK 扫描的一个主要缺点是，由于它从不与目标连接，因此无法识别打开的端口。ACK 扫描的输出将仅列出端口是被过滤还是未被过滤。将 ACK 扫描与其他扫描类型结合使用可以形成非常隐秘的扫描过程。

## 还有更多...

让我们更多地了解 nmap 扫描，并看看我们如何将不同的扫描类型组合在一起。

### 操作系统和版本检测

除了端口扫描外，`Nmap`还提供了一些高级选项。这些选项可以帮助我们获取有关目标的更多信息。其中最常用的选项之一是**操作系统识别[-O]**。这可以帮助我们识别目标机器上运行的操作系统。操作系统检测扫描输出如下所示：

```
msf > nmap -O 192.168.56.102 [*] exec: nmap -O 192.168.56.102 Starting Nmap 5.51SVN ( http://nmap.org ) at 2011-10-19 02:25 IST Nmap scan report for 192.168.56.102 Host is up (0.0014s latency). MAC Address: 08:00:27:34:A8:87 (Cadmus Computer Systems) Device type: general purpose
Running: Microsoft Windows XP|2003

```

正如我们所看到的，`Nmap`已成功检测到目标机器的操作系统。这可以简化我们根据目标操作系统找到合适的漏洞利用的任务。

另一个广泛使用的`Nmap`选项是**版本检测[-sV]**，用于目标上不同开放端口的版本检测。它可以与我们之前看到的任何扫描类型混合在一起，以提供有关目标开放端口上运行的服务版本的额外信息。

```
msf > nmap -sT -sV 192.168.56.102 [*] exec: nmap -sV 192.168.56.102 Starting Nmap 5.51SVN ( http://nmap.org ) at 2011-10-19 02:27 IST Nmap scan report for 192.168.56.102 Host is up (0.0011s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn 445/tcp open microsoft-ds Microsoft Windows XP
MAC Address: 08:00:27:34:A8:87 (Cadmus Computer Systems) Service Info: OS: Windows

```

正如我们所看到的，在我们的扫描输出中添加了一个名为“版本”的额外列，报告了目标机器上运行的不同服务的版本。

### 增加匿名性

以匿名方式执行扫描非常重要。如果您在不使用安全措施的情况下执行扫描，防火墙和 IDS 日志可能会显示您的 IP 地址。`Nmap`提供了一个名为**欺骗[-D]**的功能。

诱饵选项不能阻止您的 IP 地址被记录在防火墙和 IDS 的日志文件中，但它确实使扫描看起来很可怕。它在日志文件中添加其他种子，从而给人一种印象，即有几个其他攻击者同时扫描机器。因此，如果您添加了两个诱饵 IP 地址，那么日志文件将显示请求数据包是从三个不同的 IP 地址发送的，一个是您的 IP 地址，另外两个是您添加的虚假地址。

```
msf > nmap -sS 192.168.56.102 -D 192.134.24.34,192.144.56.21 

```

以下扫描示例显示了诱饵参数的使用。在`-D`运算符之后的 IP 地址是虚假 IP 地址，它们也将出现在目标机器的网络日志文件中，以及原始 IP 地址。这个过程可以混淆网络管理员，并在他们的脑海中引起怀疑，认为所有三个 IP 地址都是虚假的或伪造的。但添加太多的诱饵地址可能会影响扫描结果，因此应该只使用有限数量的诱饵地址。

# 探索用于扫描的辅助模块

辅助模块是 Metasploit 的内置模块，可以帮助我们执行各种任务。它们与利用程序不同，因为它们在渗透测试者的机器上运行，也不提供任何 shell。Metasploit 框架中有超过 350 个不同的辅助模块，每个模块都有特定的任务。在这里，我们将讨论扫描器辅助模块。

## 准备工作

要使用任何辅助模块，我们将不得不按照三个简单的步骤，使我们的模块准备好启动。让我们通过这三个步骤。

1.  激活模块：使用`use`命令设置特定模块处于活动状态并准备接受命令。

1.  设置规格：使用`set`命令设置模块执行所需的各种参数。

1.  运行模块：完成前两个步骤后，使用`run`命令最终执行模块并生成结果。

要查看 Metasploit 框架中可用的扫描模块，可以浏览以下位置：

```
root@bt:~# cd /pentest/exploits/framework3/modules/auxiliary/scanner

```

要开始使用模块，我们将启动`msfconsole`会话。

## 如何做...

现在让我们实际实施这些步骤来运行端口扫描辅助模块。

首先，让我们搜索框架中可用的端口扫描模块。

```
msf > search portscan Matching Modules ================ Name Disclosure Date Rank Description ---- --------------- ---- ----------- auxiliary/scanner/portscan/ack normal TCP ACK Firewall Scanner auxiliary/scanner/portscan/ftpbounce normal FTP Bounce Port Scanner auxiliary/scanner/portscan/syn normal TCP SYN Port Scanner auxiliary/scanner/portscan/tcp normal TCP Port Scanner auxiliary/scanner/portscan/xmas normal TCP "XMas" Port Scanner

```

我们可以看到可用的扫描仪列表。它包含我们在先前的示例中讨论过的一些基本扫描类型。让我们从一个简单的 SYN 扫描开始。

## 它是如何工作的...

现在我们将按照我们的三个步骤过程开始使用模块。让我们从第一步开始。

1.  要激活模块，我们将执行以下命令：

```
msf > use auxiliary/scanner/portscan/syn msf auxiliary(syn) > 
```

我们将发现提示已更改为我们要使用的模块。这表明模块现在处于活动状态。

1.  现在让我们看看模块需要哪些参数。这将通过使用`show options`命令来完成：

```
msf auxiliary(syn) > show options Module options (auxiliary/scanner/portscan/syn): Name Current Setting Required Description ---- --------------- -------- ----------- BATCHSIZE 256 yes number of hosts to scan per set INTERFACE no The name of the interface PORTS 1-10000 yes Ports to scan RHOSTS yes target address range or CIDR SNAPLEN 65535 yes The number of bytes to capture THREADS 1 yes The number of concurrent threads TIMEOUT 500 yes The reply read timeout in milliseconds
msf auxiliary(syn) > show options Module options (auxiliary/scanner/portscan/syn): Name Current Setting Required Description ---- --------------- -------- ----------- BATCHSIZE 256 yes number of hosts to scan per set INTERFACE no The name of the interface PORTS 1-10000 yes Ports to scan RHOSTS yes target address range or CIDR SNAPLEN 65535 yes The number of bytes to capture THREADS 1 yes The number of concurrent threads TIMEOUT 500 yes The reply read timeout in milliseconds 
```

第一列列出了所有必需的参数。名为`Required`的列告诉我们哪些参数是必须传递的。对于所有标记为`yes`的参数，包含值是必要的。正如我们所看到的，所有列都包含默认值。`RHOSTS`包含我们要扫描的 IP 地址范围。因此，让我们使用我们的目标 IP 地址设置`RHOSTS`参数。

```
msf auxiliary(syn) > set RHOSTS 192.168.56.1 RHOSTS => 192.168.56.1 
```

现在我们的模块已准备好对目标 IP 地址执行 SYN 扫描。使用`set`命令，我们也可以更改其他值。例如，如果我们想要更改端口号的范围，那么以下命令可以解决我们的问题：

```
msf auxiliary(syn) > set PORTS 1-500 
```

1.  最后，我们的最后一步将是执行模块以执行其相应的操作：

```
msf auxiliary(syn) > run 
```

成功执行`run`命令后，模块将执行 SYN 扫描并生成结果。

## 还有更多...

让我们在下一节中了解线程的使用。

### 管理线程

设置和管理辅助模块中的线程数量可以大大提高辅助模块的性能。如果你需要扫描整个网络或一系列 IP 地址，增加线程数量将使扫描过程更快。

```
msf auxiliary(syn) > set THREADS 10 
```

# 使用辅助模块进行目标服务扫描

现在让我们尝试对一系列 IP 地址或单个目标主机上运行的特定服务进行有针对性的扫描。有各种基于服务的扫描可用；VNC、FTP、SMB 等等。在我们寻找目标上特定类型的服务时，辅助模块可以非常方便。

## 准备工作

让我们找出哪些基于服务的扫描辅助模块对我们可用。我们可以通过以下路径导航：

```
root@bt:~# cd /pentest/exploits/framework3/modules/auxiliary/scanner
root@bt:/pentest/exploits/framework3/modules/auxiliary/scanner# ls
backdoor emc ip mysql pop3 sap ssh vnc db2 finger lotus netbios portscan sip telephony voice dcerpc ftp misc nfs postgres smb telnet vxworks dect http motorola ntp rogue smtp tftp x11 discovery imap mssql oracle rservices snmp upnp 
```

正如我们所看到的，有许多服务扫描模块的选项，在渗透测试中非常有用。让我们快速地使用其中一些。

## 操作方法...

这些服务扫描模块的工作方式类似于使用任何其他模块。我们将遵循在上一个示例中学到的相同的三个步骤过程。

让我们来研究一下 NetBIOS 模块。扫描 NetBIOS 可以有助于识别 Windows 操作系统。这次我们将扫描一系列网络，以找出哪台机器正在运行 NetBIOS 服务。

```
msf > use auxiliary/scanner/netbios/nbname msf auxiliary(nbname) > show options Module options (auxiliary/scanner/netbios/nbname): Name Current Setting Required Description ---- --------------- -------- ----------- BATCHSIZE 256 yes The number of hosts to probe CHOST no The local client address RHOSTS yes The target address range RPORT 137 yes The target port THREADS 1 yes The number of concurrent threads msf auxiliary(nbname) > set RHOSTS 192.168.56.1/24 RHOSTS => 192.168.56.1/24 msf auxiliary(nbname) > set THREADS 10 THREADS => 10
msf > use auxiliary/scanner/netbios/nbname msf auxiliary(nbname) > show options Module options (auxiliary/scanner/netbios/nbname): Name Current Setting Required Description ---- --------------- -------- ----------- BATCHSIZE 256 yes The number of hosts to probe CHOST no The local client address RHOSTS yes The target address range RPORT 137 yes The target port THREADS 1 yes The number of concurrent threads msf auxiliary(nbname) > set RHOSTS 192.168.56.1/24 RHOSTS => 192.168.56.1/24 msf auxiliary(nbname) > set THREADS 10 THREADS => 10 
```

`RHOSTS`现在设置为扫描整个 IP 地址范围，线程数量也设置为十。现在让我们运行这个模块并分析结果。

```
msf auxiliary(nbname) > run
[*] Sending NetBIOS status requests to 192.168.56.0->192.168.56.255 (256 hosts)
[*] 192.168.56.1 [DARKLORD-PC] OS:Windows Names:(DARKLORD-PC, WORKGROUP, __MSBROWSE__) Addresses:(192.168.56.1) Mac:08:00:27:00:a8:a3
[*] 192.168.56.103 [SP3] OS:Windows Names:(SP3, WORKGROUP) Addresses:(10.0.2.15, 192.168.56.103) Mac:08:00:27:4b:65:35
[*] 192.168.56.102 [ABHINAV-5C02603] OS:Windows Names:(ABHINAV-5C02603, WORKGROUP) Addresses:(10.0.2.15, 192.168.56.102) Mac:08:00:27:34:a8:87
[*] Scanned 256 of 256 hosts (100% complete) 
```

扫描网络发现有三台机器正在运行 NetBIOS。扫描还报告了它们各自的 MAC 地址。

让我们进行另一个服务扫描。这次我们将尝试找出哪些机器正在运行 MySQL 数据库服务器。此外，我们还将尝试找出服务器的版本。

```
msf > use auxiliary/scanner/mysql/mysql_version
msf auxiliary(mysql_version) > show options Module options (auxiliary/scanner/mysql/mysql_version): Name Current Setting Required Description ---- --------------- -------- ----------- RHOSTS yes The target address range RPORT 3306 yes The target port THREADS 1 yes The number of concurrent threads msf auxiliary(mysql_version) > set RHOSTS 192.168.56.1/24 RHOSTS => 192.168.56.1/24
msf auxiliary(mysql_version) > set THREADS 10 THREADS => 10
msf auxiliary(mysql_version) > run [*] 192.168.56.102:3306 is running MySQL, but responds with an error: \x04Host '192.168.56.101' is not allowed to connect to this MySQL server 
```

扫描过程发现 IP 地址 192.168.56.102 正在运行 MySQL 服务器，但不幸的是，无法连接到服务器。这再次证明了辅助模块是多么简单和方便，它们也可以为我们提供大量有用的信息。

建议尝试所有可用的辅助扫描模块，因为它们可以帮助你更好地了解你的目标。

## 工作原理...

辅助模块是专门用于执行特定任务的特殊目的模块。有时你可能需要执行特定类型的扫描来发现服务。例如，MySQL 辅助扫描器通过对默认端口号（3306）进行 ping 来检测数据库的存在。它进一步检查默认登录是否在数据库上启用。你可以在`/modules/auxiliary/scanner`下分析脚本。你可以根据需要扩展代码，甚至重用脚本来构建自己特定的辅助扫描器。

# 使用 Nessus 进行漏洞扫描

到目前为止，我们已经学习了端口扫描的基础知识，并进行了 Nmap 的实际实现。端口扫描已经扩展到其他几种工具，进一步增强了扫描和信息收集的过程。在接下来的几个示例中，我们将涵盖那些扫描目标以发现可用服务和开放端口，然后尝试确定可能存在的特定服务或端口的漏洞类型的工具。让我们开始我们的漏洞扫描之旅。

Nessus 是最广泛使用的漏洞扫描器之一。它会扫描目标以发现一系列漏洞，并为其生成详细报告。Nessus 在渗透测试中非常有帮助。你可以使用 Nessus 的图形界面版本，也可以在 Metasploit 控制台中使用它。在本书中，我们将主要关注使用`msfconsole`与 Nessus 一起使用。

## 准备工作

要在`msfconsole`中开始使用 Nessus，我们需要加载 Nessus，然后连接到服务器开始我们的渗透测试。

首先，我们将连接我们的数据库与 Metasploit，以存储临时结果。在前一章中已经解释了在 Metasploit 中启动和连接数据库的过程。连接数据库后，我们的下一个任务是加载 Nessus 插件。

## 如何操作...

1.  要连接数据库并在 Metasploit 中加载 Nessus，我们将执行以下命令：

```
msf > db_connect msf3:8b826ac0@127.0.0.1:7175/msf3
msf > load nessus
[*] Nessus Bridge for Nessus 4.2.x
[+] Type nessus_help for a command listing
[*] Successfully loaded plugin: nessus 
```

1.  成功加载后，我们将需要将其与服务器连接。以下命令用于将其与服务器连接：

```
msf > nessus_connect root:toor@localhost ok
[*] Connecting to https://127.0.0.1:8834/ as root
[*] Authenticated 
```

在上述命令中，`ok`是一个额外的参数，用于确保 Nessus 服务器在受信任的网络上运行。

我们可以使用`nessus_user_list`命令检查 Nessus 中可用用户的列表。

也可以使用`nessus_user_add`命令添加新用户。通过使用`nessus_policy_list`命令，我们可以查看服务器上可用策略的列表。

## 工作原理...

一旦 Nessus 与服务器连接，就可以用于扫描目标机器。扫描的过程简单而快速。让我们对目标进行快速扫描，看看 Nessus 扫描是如何操作的。要开始扫描，我们将需要传递以下命令：

```
msf > nessus_scan_new 1 testscan 192.168.56.102
[*] Creating scan from policy number 1, called "testscan" and scanning 192.168.56.102
[*] Scan started. uid is 9d337e9b-82c7-89a1-a194-4ef154b82f624de2444e6ad18a1f 
```

一旦扫描过程完成，我们的下一个目标将是导入 Nessus 生成的列表。让我们查看可用的列表：

```
msf > nessus_report_list
[+] Nessus Report List
ID Name Status
---- ------
9d337e9b-82c7-
89a1-a19-4ef154b82 testscan completed
f624de2444e6ad18a1f 
```

ID 列代表我们扫描生成的报告。现在让我们导入这份报告。

```
msf > nessus_report_get 9d337e9b-82c7-89a1-a1944ef154b82f624de2444e6ad18a1f
[*] importing 9d337e9b-82c7-89a1-a1944ef154b82f624de2444e6ad18a1f 
```

报告导入后，可以使用控制台命令操作，并进行分析，以找出目标中的弱点。要查看目标中的漏洞，执行以下命令：

```
msf> hosts -c address, vuls, os_name 
```

## 还有更多...

让我们快速浏览一下在 GUI 模式下使用 Nessus 的快速指南。

### 在 Web 浏览器中使用 Nessus

Nessus 也可以从其 GUI 模式中使用，这也和控制台模式一样强大且易于使用。如果您是第一次使用 Nessus，则首先需要注册并从 Nessus 网站获取注册码。注册可以在以下链接完成：

[`www.nessus.org/register/`](http://www.nessus.org/register/)

注册完成后，我们将需要启动 Nessus 并添加注册码。转到**应用程序** | **BackTrack | 漏洞评估 | 网络评估 | 漏洞扫描器 | nessus start**。

启动 Nessus 时，可能会提示以下错误消息：

```
Starting Nessus : . Missing plugins. Attempting a plugin update... Your installation is missing plugins. Please register and try again. To register, please visit http://www.nessus.org/register/ 
```

错误是因为 Nessus 尚未注册。为了注册，我们需要使用从 Nessus 收到的注册码。以下命令将帮助我们完成注册过程：

```
/opt/nessus/bin/nessus-fetch -register YOUR REGISTRATIN CODE
root@bt:~# /opt/nessus/bin/nessus-fetch --register E8A5-5367-982E-05CB-972A
Your activation code has been registered properly - thank you. Now fetching the newest plugin set from plugins.nessus.org... Your Nessus installation is now up-to-date. If auto_update is set to 'yes' in nessusd.conf, Nessus will update the plugins by itself. 
```

现在启动浏览器并输入以下地址：

`https://localhost:8834`

如果您第一次在浏览器中启动 Nessus，加载可能需要一些时间。请耐心等待。

# 使用 NeXpose 进行扫描

在上一篇文章中，我们讨论了 Nessus 作为一个潜在的漏洞扫描器。在本篇文章中，我们将介绍另一个重要的漏洞扫描器 NeXpose。

NeXpose 是 Rapid7 的一款热门工具，用于执行漏洞扫描并将结果导入 Metasploit 数据库。NeXpose 的使用方式类似于我们在上一篇文章中学到的 Nessus，但让我们快速了解一下如何开始使用 NeXpose。我将把更深入地探索留作你的任务。

## 准备工作

从`msf`控制台启动 NeXpose，我们首先需要将数据库连接到 Metasploit，然后加载插件将其与 NeXpose 服务器连接，以启动目标扫描的过程。让我们在命令行中执行这些步骤。

```
msf > db_connect msf3:8b826ac0@127.0.0.1:7175/msf3
msf > load nexpose
msf > nexpose_connect darklord:toor@localhost ok
[*] Connecting to NeXpose instance at 127.0.0.1:3780 with username darklord... 
```

## 如何操作...

现在我们已经连接到我们的服务器，我们可以扫描我们的目标并生成报告。NeXpose 支持两种扫描命令。一个是`nexpose_scan`，另一个是`nexpose_discover`。前者将扫描一系列 IP 地址并导入结果，而后者将仅扫描以发现主机和运行在其上的服务。让我们使用 NeXpose 对我们的目标进行快速扫描。

```
msf > nexpose_discover 192.168.56.102
[*] Scanning 1 addresses with template aggressive-discovery in sets of 32
[*] Completed the scan of 1 addresses 
```

## 它是如何工作的...

扫描完成后，我们可以使用`msf`控制台的默认数据库命令查看其结果。

让我们看看 NeXpose 产生了什么扫描结果：

```
msf > hosts -c address,os_name,os_flavor
Hosts
=====
address os_name os_flavor
------- ------- ---------
192.168.56.102 Microsoft Windows XP
msf > 
```

## 还有更多...

信息收集完成后，最后一步是导入结果。让我们看看它是如何执行的。

### 导入扫描结果

如果您已经从`msfconsole`使用了 Nessus 和 NeXpose，您可以跳过此信息。

当您使用 Nessus 或 NeXpose 的 GUI 版本时，您将不得不手动将扫描结果导入数据库。我强调导入和存储结果的原因是，在我们的下一章中，我们将看到如何使用`autopwn`命令自动在我们的数据库中运行主机上的利用。因此，为了导入扫描结果，我们将使用`db_import`命令如下：`db_import filename`

```
msf > db_import nexposelist.xml
[*] Importing 'Nexpose XML (v2)' data
[*] Importing host 192.168.56.102
[*] Successfully imported /root/nexposelist.xml 
```

# 与 Dradis 框架共享信息

在我们之前的教程中，我们学习了几种获取有关目标信息的技术。在执行渗透测试时，我们可能需要与其他渗透测试人员共享信息，他们可能位于其他物理位置。在这种情况下，使用 Dradis 框架可以更轻松地共享渗透测试信息。它是一个用于在安全评估期间共享信息的开源框架。它具有几个功能，使其成为一个出色的信息共享工具。其中一些是：

+   通过 SSL 进行通信

+   附件文件和笔记

+   从 Nessus、NeXpose 等导入扫描结果

+   可以扩展以连接外部系统，如漏洞数据库

虽然它不会帮助我们获取有关目标的任何信息，但对于所有安全专业人员来说，该工具在共享渗透测试结果和发现方面非常重要。

## 做好准备

要在 BackTrack 中启动 Dradis 框架，我们需要在终端执行以下命令：

```
root@bt:~# cd /pentest/misc/dradis
root@bt:/pentest/misc/dradis# ./start.sh 
```

成功执行命令后，我们可以通过浏览器启动框架，通过以下地址传递：

`https://127.0.0.1:3004`

我们将被提示设置密码和框架帐户。

![做好准备](img/7423_02_03.jpg)

## 如何做...

让我们开始我们的 Dradis 实验。该框架使我们能够为域和子域地址建立类似树状的结构。这使我们清晰地了解目标结构，并帮助我们以逻辑方式存储信息。它还提供了生成信息完整报告的功能。

![如何做...](img/7423_02_04.jpg)

框架为我们提供了五个重要选项。它们是**添加分支，从文件导入，导出，添加笔记**和**笔记类别**。

一旦您使用您的凭据登录，您将看到一个类似于前面截图中显示的屏幕。您可以在框架的左上角找到五个选项。让我们看看这些选项为我们做了什么。

## 它是如何工作的...

让我们开始创建一个新报告。该过程很简单，从添加主机和子主机开始。

**添加分支**选项使我们能够添加新的 IP 或域名。一旦添加了顶级域，我们可以进一步添加其子域以包括子域。现在下一个任务是添加有关它们的信息。

**添加笔记**选项使我们能够添加我们从各种扫描结果中收集的信息。例如，我们可以添加来自 Nmap、Nessus 等的扫描结果。

**注释类别**选项帮助我们选择用于获取信息的媒介。各种选项包括 Brup 扫描、Nessus 扫描、NeXpose、Nmap 等。您可以选择您用于生成扫描结果的适当选项。

以下截图显示了针对 IP 地址范围 192.168.56.1/24 进行的 Nmap 扫描的信息。左侧的树形结构包含了有关可用目标的信息，右侧的列提供了有关其报告的信息。

![工作原理...](img/7423_02_05.jpg)

接下来我们可以用 Dradis 框架做的事情是导入现有报告或导出创建的报告。

**从文件导入**选项为我们提供了灵活性，可以从不同的扫描仪中导入先前的扫描结果。这进一步增强了该框架的功能，因为不同的测试人员可以将结果导入框架并将它们组合成单个报告。

**导出**选项为专业渗透测试人员提供了一个选项，可以将各个域和子域的完整报告生成为单个文件。报告可以以 XML 或 HTML 格式导出。也可以以项目或自定义模板的形式导出。
