

# 第十一章：PowerShell 和远程控制与管理

本章首先深入探讨远程管理的基本原理；本章深入讲解了使 PowerShell 连接管理员与远程目标的核心技术。涵盖 PowerShell 远程连接的基础知识，并逐步介绍管理多个远程会话的高级方法，你将全面了解支撑远程控制可行性的架构基础。

在此基础上，本章进一步提供了实际示例和动手练习，展示了如何利用 PowerShell 执行地理分布环境中的各种管理任务。无论是执行远程计算机上的命令，监控远程进程，还是管理远程文件和目录，本章都将使你掌握必备的技能，优化工作流程，提高生产力。

本章将涵盖以下主题：

+   远程访问与 PowerShell

+   PowerShell 和远程管理

+   使用 PowerShell 进行 **简单网络管理协议**（**SNMP**）

# 远程访问与 PowerShell

PowerShell 由微软开发，在 Windows 环境中提供强大的远程管理和自动化功能。**Windows 远程管理**（**WinRM**）协议主要用于支持远程访问 PowerShell。接下来，我将描述 PowerShell 远程连接的各个方面，包括其设置、配置和远程命令的执行。

## 启用 PowerShell 远程连接

远程访问的第一步是启用目标计算机上的 PowerShell 远程连接。为此，可以使用 `Enable-PSRemoting` cmdlet：

```
 Enable-PSRemoting -Force
```

`-Force` 参数确保在需要时覆盖现有配置。此命令配置 WinRM 服务，使其能够接受远程 PowerShell 命令。

## 配置 WinRM

WinRM 依赖 HTTP 或 HTTPS 协议进行通信。要配置 WinRM 设置，可以使用 `winrm` 命令行工具或 PowerShell cmdlet。以下是配置 WinRM 使用 HTTPS 和自签名证书的示例：

```
 $thumbprint = (New-SelfSignedCertificate -DnsName localhost -CertStoreLocation Cert:\LocalMachine\My).Thumbprint
winrm create winrm/config/Listener?Address=*+Transport=HTTPS '@{Hostname="localhost";CertificateThumbprint="$thumbprint"}'
```

此脚本创建自签名证书并配置 WinRM 以通过 HTTPS 进行监听。

## 连接到远程计算机

启用远程连接后，管理员可以使用 `Enter-PSSession` cmdlet 启动远程 PowerShell 会话：

```
 Enter-PSSession -ComputerName <RemoteComputer>
```

此命令在指定的远程计算机上建立交互式会话，允许管理员像在本地计算机上一样执行命令。

## 在远程计算机上执行命令

PowerShell 提供了 `Invoke-Command` cmdlet 用于在远程计算机上执行命令。以下是示例：

```
 Invoke-Command -ComputerName <RemoteComputer> -ScriptBlock { Get-Process }
```

此命令检索指定远程计算机上正在运行的进程信息。

## 使用凭据进行远程连接

要在远程机器上创建 PowerShell 会话，可以使用 `New-PSSession` cmdlet。以下是一个示例：

```
 $RemoteComputer = "powershell.snowcapcyber.com"
# Create a new PowerShell session on the remote machine
$session = New-PSSession -ComputerName $remoteComputer
# Now, you can run commands on the remote machine
Invoke-Command -Session $session -ScriptBlock {
    # Your PowerShell commands go here
    Get-Process
}
Remove-PSSession -Session $session
```

对于此示例，请注意以下几点：

+   将 `RemoteComputer` 替换为您要连接的远程机器的实际主机名或 IP 地址。

+   `New-PSSession` cmdlet 在远程机器上建立 PowerShell 会话，并将其存储在 `$**session` 变量中。

+   `Invoke-Command` cmdlet 允许您通过创建的会话在远程机器上运行 PowerShell 命令（在 `-ScriptBlock` 参数中指定）。在此案例中，它使用 `Get-Process` 获取进程列表。

+   最后，使用 `Remove-PSSession` cmdlet 关闭远程机器上的 PowerShell 会话。

这个示例演示了如何在远程机器上创建和使用 PowerShell 会话，为更高级的远程管理任务提供基础。

## 配置可信主机

为确保安全通信，管理员可以配置可信主机列表。在受信任网络中进行远程操作时，这一点尤为重要。以下是一个示例：

```
 Set-Item wsman:\localhost\Client\TrustedHosts -Value <RemoteComputer> -Force
```

该命令将指定的远程计算机添加到可信主机列表中。

## 会话配置

PowerShell 会话可以根据特定需求进行配置和定制——例如，创建持久化会话：

```
 $session = New-PSSession -ComputerName <RemoteComputer>
Invoke-Command -Session $session -ScriptBlock { Get-Process }
```

在这里，会话被创建并用于在远程机器上执行命令。

## 并行远程操作

PowerShell 支持使用 `-ThrottleLimit` 参数与 `Invoke-Command` 在多台远程机器上并行执行命令。以下是一个示例：

```
 $computers = "<RemoteComputer1>", "<RemoteComputer2>", "<RemoteComputer3>"
Invoke-Command -ComputerName $computers -ScriptBlock { Get-Process } -ThrottleLimit 3
```

该命令同时从三台远程机器上获取进程信息。

总之，通过 WinRM 实现的 PowerShell 远程访问功能，使管理员能够高效地在 Windows 网络中管理和自动化任务。管理员可以通过配置 WinRM、建立会话并使用如 `Invoke-Command` 和 `Enter-PSSession` 等 cmdlet 来无缝管理远程机器，使 PowerShell 成为 Windows 环境下强大的远程管理和自动化工具。

# PowerShell 与远程管理

PowerShell 是由微软开发的，通过 WinRM 协议提供强大的远程访问和管理功能。在本综合指南中，我们将探讨 PowerShell 在远程访问中的各个方面，包括建立远程会话、在远程机器上执行命令、处理后台作业、并行远程操作、变量使用、脚本执行以及远程管理服务、注册表和事件日志等内容。

## 建立远程会话

PowerShell 远程操作允许管理员使用 `Enter-PSSession` cmdlet 在远程机器上建立交互式会话。以下是一个示例：

```
 Enter-PSSession -ComputerName <RemoteComputer>
```

该命令启动一个交互式会话，允许在指定的远程计算机上执行命令并管理资源，提供无缝的操作环境。

## 在远程计算机上执行命令

`Invoke-Command` cmdlet 对于在远程计算机上执行命令至关重要。以下是一个示例：

```
 Invoke-Command -ComputerName <RemoteComputer> -ScriptBlock { Get-Service -Name Spooler }
```

此命令检索指定远程计算机上 `Spooler` 服务的信息。`-ScriptBlock` 参数允许在远程计算机上执行 PowerShell 代码块。

## 远程变量使用

PowerShell 远程操作支持在远程会话之间使用变量。以下是一个示例：

```
 $remoteVar = "Hello from remote"
Invoke-Command -ComputerName <RemoteComputer> -ScriptBlock { Write-Host $using:remoteVar }
```

在此示例中，一个变量（**$remoteVar**）在本地会话中赋值，然后在远程会话中使用。`$using:` 范围修饰符对于在远程上下文中引用本地变量至关重要。

## 远程脚本执行

PowerShell 通过 `Invoke-Command` 的 `-FilePath` 参数，允许在远程计算机上执行完整脚本。以下是一个示例：

```
 Invoke-Command -ComputerName <RemoteComputer> -FilePath C:\Scripts\RemoteScript.ps1
```

此命令在远程计算机上执行指定脚本（**RemoteScript.ps1**），允许管理员远程自动化复杂任务。

## 处理后台作业

PowerShell 支持后台作业，允许命令异步和并行执行。以下是一个示例：

```
 $scriptBlock = {
    Get-Process
    Start-Sleep -Seconds 5
    Get-Service
}
$job = Invoke-Command -ComputerName <RemoteComputer> -ScriptBlock $scriptBlock -AsJob
Receive-Job -Job $job
```

在此示例中，脚本块作为后台作业在远程计算机上执行，结果异步返回。

## 并行远程操作

PowerShell 通过 `-ThrottleLimit` 参数与 `Invoke-Command` 配合使用，允许在多台远程计算机上并行执行命令。以下是一个示例：

```
 $computers = "<RemoteComputer1>", "<RemoteComputer2>", "<RemoteComputer3>"
Invoke-Command -ComputerName $computers -ScriptBlock { Get-Process } -ThrottleLimit 3
```

此命令同时从三台远程计算机检索进程信息，提高了管理多个系统的效率。

## 远程注册表操作

管理员可以使用 PowerShell 远程操作 Windows 注册表。以下是修改远程计算机上注册表项的示例：

```
 Invoke-Command -ComputerName <RemoteComputer> -ScriptBlock {
    Set-ItemProperty -Path "HKLM:\Software\Example" -Name "Setting" -Value "NewValue"
}
```

此命令更新指定远程计算机上的 `Setting` 注册表项的值，展示了远程执行配置更改的能力。

## 远程事件日志检索

PowerShell 在检索远程计算机的事件日志条目时非常有效。以下是从远程计算机获取最近系统事件的示例：

```
 Get-WinEvent -ComputerName <RemoteComputer> -LogName System -MaxEvents 10
```

此命令从指定远程计算机的 `System` 事件日志中检索最近的 10 条记录，帮助进行故障排除和监控。

## 远程服务管理

PowerShell 允许管理员管理远程计算机上的服务。以下是远程停止服务的示例：

```
 Invoke-Command -ComputerName <RemoteComputer> -ScriptBlock { Stop-Service -Name <ServiceName> }
```

此命令停止远程计算机上指定的服务，展示了远程执行管理任务的能力。

## 远程软件安装

PowerShell 可以远程安装软件到多台计算机。以下是一个示例：

```
 $computers = "<RemoteComputer1>", "<RemoteComputer2>", "<RemoteComputer3>"
$softwarePath = "\\FileServer\Software\InstallScript.ps1"
Invoke-Command -ComputerName $computers -ScriptBlock {
    param($path)
    Invoke-Expression (Get-Content $path -Raw)
} -ArgumentList $softwarePath
```

在此示例中，脚本使用位于文件服务器上的脚本安装软件，并在多个远程计算机上同时执行。

## 远程访问 Azure 虚拟机

PowerShell 远程访问扩展至 Azure **虚拟机**（**VMs**）。以下是一个示例：

```
 $cred = Get-Credential
Enter-PSSession -HostName "<AzureVMName>.cloudapp.net" -Credential $cred -UseSSL
```

使用指定的凭据，此脚本建立与 Azure 虚拟机的安全远程会话。

## 远程网络配置

PowerShell 可用于配置远程计算机上的网络设置。以下是示例：

```
 Invoke-Command -ComputerName <RemoteComputer> -ScriptBlock {
    New-NetIPAddress -InterfaceAlias "Ethernet" -IPAddress "192.168.1.100" -PrefixLength 24
}
```

此命令配置指定远程计算机以太网接口上的新 IP 地址。

## 远程用户管理

PowerShell 允许管理员在远程计算机上管理用户。以下是远程创建新用户的示例：

```
 Invoke-Command -ComputerName <RemoteComputer> -ScriptBlock {
    New-LocalUser -Name "NewUser" -Password (ConvertTo-SecureString "Password123" -AsPlainText) -FullName "New User"
}
```

此命令在指定的远程计算机上创建一个新的本地用户帐户。

## 安全性考虑

使用 PowerShell 远程访问计算机时，必须考虑安全性。确保适当的身份验证和授权机制到位。这可能包括使用安全凭据、HTTPS 和其他安全协议。

## 远程文件复制

PowerShell 可用于将文件复制到远程计算机。以下是示例：

```
 $sourcePath = "C:\LocalPath\File.txt"
$destinationPath = "\\RemoteComputer\C$\RemotePath"
Copy-Item -Path $sourcePath -Destination $destinationPath
```

此命令将文件从本地计算机复制到远程计算机。

总结来说，PowerShell 的远程访问功能使管理员能够高效地管理和自动化网络中的任务。通过利用 `Invoke-Command` 和 `Enter-PSSession` 等 cmdlet，结合后台作业和并行远程操作，管理员可以简化工作流程，并保持对分布式系统的控制。

# 使用 PowerShell 进行 SNMP 操作

凭借其多功能性和可扩展性，PowerShell 可用于通过 SNMP 管理系统。SNMP 是一种广泛使用的网络管理和监控协议。在接下来的部分中，我们将探索 PowerShell 如何与 SNMP 交互，以便检索信息并管理网络设备。

## SNMP 模块安装

在 PowerShell 中与 SNMP 交互之前，必须安装 SNMP 模块。各种 SNMP 模块可用，其中一个流行的选择是 `SNMPHelper` 模块。你可以通过 PowerShell Gallery 安装它：

```
 Install-Module -Name SNMPHelper -Force -AllowClobber
```

## SNMP 代理查询

要查询 SNMP 代理，请指定目标 IP 地址、SNMP 社区字符串（如密码）和 SNMP 版本。`Get-SNMP` cmdlet 来自 `SNMPHelper` 模块，允许你检索 SNMP 数据：

```
 Import-Module SNMPHelper
Get-SNMP -HostName <TargetIPAddress> -Community <CommunityString> -Version 2 -Oid "1.3.6.1.2.1.1.1"
```

此示例查询指定 IP 地址上的 SNMP 代理，以获取系统信息，特别是 `sysDescr`（系统描述）**对象标识符**（**OID**）。

## SNMP 遍历

SNMP 遍历涉及遍历 SNMP 树以检索一系列 OID。这对于发现 SNMP 代理上的所有可用信息非常有用。此命令遍历指定设备上的整个 SNMP 树，检索广泛的信息：

```
 # Walk the SNMP tree to get information about the target device
Get-SNMP -HostName <TargetIPAddress> -Community <CommunityString> -Version 2 -Oid "1.3.6.1.2.1"
```

## SNMP 设置

SNMP 还可用于修改 SNMP 启用设备上的设置。`Set-SNMP` cmdlet 允许你为特定的 OID 设置值。此示例设置 `sysContact` OID 的新值，该值通常表示 SNMP 代理的联系信息：

```
 # Set a new value for the sysContact OID
Set-SNMP -HostName <TargetIPAddress> -Community <CommunityString> -Version 2 -Oid "1.3.6.1.2.1.1.4.0" -ValueType OctetString -Value "New Contact Information"
```

## SNMP 陷阱处理

PowerShell 也可以处理 SNMP 陷阱，SNMP 代理发送的这些异步消息用于通知管理系统特定事件。以下是一个示例：

```
 # Register an SNMP trap handler
Register-SNMPtrap -Handler {
    param($trap)
    Write-Host "Received SNMP Trap: $($trap.GenericMessage)" }
# Wait for traps
Start-Sleep -Seconds 60
```

在这个示例中，注册了一个陷阱处理程序，脚本等待 60 秒接收 SNMP 陷阱。你可以自定义处理程序，根据接收到的陷阱执行特定操作。

## SNMP 批量请求

SNMP 批量请求可用于高效地检索大量数据。以下是一个示例：

```
 # Perform a bulk SNMP request to get system information
Get-SNMP -HostName <TargetIPAddress> -Community <CommunityString> -Version 2 -Oid "1.3.6.1.2.1.1" -Bulk
```

这个示例使用 `-Bulk` 参数执行批量 SNMP 请求以获取系统信息。批量请求在检索多项信息时更为高效。

## PowerShell 与 SNMP 监控

PowerShell 可以用来创建持续的 SNMP 监控脚本。以下是一个监控 CPU 使用情况的示例：

```
 # Monitor CPU usage using SNMP
while ($true) {
    $cpuUsage = Get-SNMP -HostName <TargetIPAddress> -Community <CommunityString> -Version 2 -Oid "1.3.6.1.2.1.25.3.3.1.2.196608" -ErrorAction SilentlyContinue
    Write-Host "CPU Usage: $($cpuUsage.Value)"
    Start-Sleep -Seconds 60
}
```

这个脚本定期通过 SNMP 检索 CPU 使用情况信息，并输出结果。

## SNMP 和 PowerShell 集成

PowerShell 可以与其他 PowerShell 模块和功能集成，以提供全面的系统管理。以下是将 SNMP 与 `Common Information Model`（**CIM**）/`Windows Management Instrumentation`（**WMI**）查询结合的示例：

```
 # Get SNMP and CIM-based system information
$snmpInfo = Get-SNMP -HostName <TargetIPAddress> -Community <CommunityString> -Version 2 -Oid "1.3.6.1.2.1.1"
$cimInfo = Get-CimInstance -ComputerName <TargetIPAddress> -ClassName Win32_OperatingSystem
# Display combined information
Write-Host "SNMP System Name: $($snmpInfo.Value)"
Write-Host "CIM OS Version: $($cimInfo.Version)"
```

这个示例使用 SNMP 和 CIM/WMI 查询同时检索系统信息，并显示合并结果。

## SNMP 和图形界面

PowerShell 可以与图形界面集成，以增强 SNMP 管理。以下是使用 `Windows Forms`（**WinForms**）创建一个简单的 SNMP 管理器的示例：

```
 # Load Windows Forms assembly
Add-Type -AssemblyName System.Windows.Forms
# Create a simple SNMP manager form
$form = New-Object System.Windows.Forms.Form
$form.Text = "SNMP Manager"
$button = New-Object System.Windows.Forms.Button
$button.Text = "Get System Info"
$button.Add_Click({
    $snmpInfo = Get-SNMP -HostName <TargetIPAddress> -Community <CommunityString> -Version 2 -Oid "1.3.6.1.2.1.1"
    [System.Windows.Forms.MessageBox]::Show("System Name: $($snmpInfo.Value)", "SNMP Result")
})
$form.Controls.Add($button)
$form.ShowDialog()
```

这个示例创建了一个简单的 WinForms 应用程序，带有一个按钮，用于检索 SNMP 系统信息。

## SNMP 和日志记录

PowerShell 可以用来记录 SNMP 数据，以便分析或存档。以下是一个示例：

```
 # Log SNMP system information to a file
$snmpInfo = Get-SNMP -HostName <TargetIPAddress> -Community <CommunityString> -Version 2 -Oid "1.3.6.1.2.1.1"
$timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
$snmpInfo | Out-File -Append -FilePath "SNMP_Log_$timestamp.txt"
```

这个脚本检索 SNMP 系统信息，并将其附加到日志文件中，包括每个条目的时间戳。总的来说，PowerShell 提供了一个强大且灵活的平台，用于通过 SNMP 管理系统。通过合适的模块和 cmdlet，管理员可以检索信息、设置配置、处理陷阱，并在支持 SNMP 的设备上执行各种管理任务。无论是简单的查询、持续监控，还是将 SNMP 与其他 PowerShell 功能集成，PowerShell 都是一个强大的工具，用于基于 SNMP 的系统管理和监控。

# 总结

本章提供了技术经验，帮助你理解 PowerShell 远程管理的工作原理，包括使用 cmdlet 如 `Enter-PSSession`、`Invoke-Command` 和 `New-PSSession`。它还介绍了 SNMP 及其与 PowerShell 的集成。通过本章所学，你还可以将 PowerShell 远程管理与 `Desired State Configuration`（**DSC**）集成，用于跨多台计算机的配置管理，以及故障排除、识别和解决常见的远程管理问题，如认证问题、网络连接问题和配置错误。

本章还专注于 SNMP 基础知识，例如探索**管理信息库**（**MIB**）的结构、OID 层次结构，以及如何解释和导航 MIB 数据，以及 SNMP 操作如`GET`、`GETNEXT`、`SET` 和 `TRAP`，以及它们如何用于检索和操作 SNMP 管理设备上的信息。

在这些基础上，本章转向实际应用，通过示例和练习为您提供了实践经验。这些活动阐明了在执行地理分布环境中各种管理任务时，PowerShell 的多用途使用。无论是在远程机器上发出命令、监视远程进程，还是远程管理文件和目录，本章都为您提供了提升工作流效率和生产力所需的基本技能。

在下一章中，我们将探讨如何使用 PowerShell 对基于 Azure 的基础架构进行渗透测试。

# 第三部分：Azure 和 AWS 云环境的渗透测试

本节概述了在云计算环境中进行渗透测试的过程，特别是针对 Azure 和 AWS 平台。它介绍了此类评估所涉及的方法论和技术。通过专注于 Azure 和 AWS，您将获得有关这些流行云服务独特安全挑战和考虑的实际见解。通过实践探索，您将培养识别云基础架构中漏洞并减轻风险的能力。这些基础知识将为您提供在面对潜在威胁时保护数字资产和确保云环境完整性所需的重要技能。

此部分包括以下章节：

+   *第十二章*，*在 Azure 中使用 PowerShell*

+   *第十三章*，*在 AWS 中使用 PowerShell*
