

# 第四章：网络枚举和端口扫描

在本章中，我们将探讨如何将 PowerShell 用作渗透测试的一部分来执行 TCP/UDP 端口扫描。通过实际示例，我们将探索如何使用特定的 cmdlet，以及 PowerShell 如何使用其他框架（如 .NET）中的函数。最后，我们将审视一些可以用来执行端口扫描的开源工具。我们现在将通过查看如何使用各种 cmdlet 来进行网络枚举，来开始本章内容。

本章我们将覆盖的主要主题如下：

+   使用 PowerShell 进行网络枚举

+   使用 PowerShell 进行 TCP 端口扫描

+   使用 PowerShell 进行 UDP 端口扫描

+   使用 PowerShell 工具进行端口扫描

# 使用 PowerShell 进行网络枚举

网络枚举是渗透测试中的一个关键阶段，安全专家评估目标网络的漏洞和弱点。PowerShell 是一种强大的脚本语言和框架，适用于 Windows 环境，并且在进行网络枚举时，可以作为一个极具价值的工具。在这里，我们将深入探讨如何在渗透测试中使用 PowerShell 来实现这一目标：

+   **网络资产的发现**：PowerShell 允许测试人员发现网络资产，如主机、服务器和设备。可以使用 `Test-Connection` 命令来 ping 主机并检查其可用性。`Resolve-DnsName` 可以帮助识别主机名，而 `Test-NetConnection` 可以评估开放的端口和服务。

+   **Active Directory 枚举**：通过 PowerShell，测试人员可以收集有关目标 `Active Directory** (`AD**) 环境的宝贵信息。工具如 `Get-ADUser`、`Get-ADComputer` 和 `Get-ADGroupMember` 可用于检索用户、计算机和组数据。这些数据有助于理解网络结构和潜在的入口点。详细内容将在 *第六章* 中进一步讨论。

+   **网络共享和权限**：PowerShell 脚本可以编写来枚举网络共享及其权限。可以使用 `Get-SmbShare` 和 `Get-Acl` 等命令来识别开放的共享及其相关访问权限，从而提供潜在的利用点。这将在 *第六章* 中进一步详细讨论。

+   **网络共享和用户信息的枚举**：PowerShell 可以通过查询 LDAP 和 SMB 服务，帮助枚举网络共享和用户信息。像 `NetView` 和 `NetUser` 这样的工具可以揭示关于网络结构和潜在漏洞的更多信息。详细内容将在 *第六章*中进一步介绍。

+   **正在运行的服务枚举**：PowerShell 允许测试人员识别目标主机上正在运行的服务。通过使用`Get-Service`或查询`Windows Management Instrumentation`（**WMI**）存储库的`Get-WmiObject`，测试人员可以收集有关服务、其配置和潜在漏洞的信息。这些服务类型包括数据库。详细内容将在*第七章*、*第八章*和*第九章*中讨论。

+   **漏洞扫描**：PowerShell 可以用于在目标系统上发起漏洞扫描，利用脚本检查已知的漏洞或过时的软件版本。这有助于优先考虑潜在的攻击途径。

+   **端口扫描和横幅抓取**：PowerShell 的 `Test-NetConnection` 和 `Invoke-WebRequest` 可以用来执行端口扫描和横幅抓取。这些信息帮助测试人员识别开放端口、服务以及可能存在的过时软件版本，这些版本可能容易受到已知漏洞的攻击。

因此，PowerShell 是 Windows 环境中渗透测试期间进行网络枚举的不可或缺的工具。它的多功能性、脚本能力和对系统资源的访问使测试人员能够收集关于目标网络的关键信息，帮助他们识别潜在的弱点和进一步利用的入口。然而，必须在道德和授权的前提下进行这些活动，以确保被评估网络的安全性。

# 使用 PowerShell 进行 TCP 端口扫描

端口扫描是指系统地检查目标系统上开放、关闭或被过滤的端口。开放端口代表潜在的攻击入口，而关闭或被过滤的端口可能表明存在安全措施。通过进行端口扫描，渗透测试人员可以收集有关网络或系统安全状态的重要信息。

`Test-NetConnection` 是 Windows PowerShell（版本 4.0 及以上）中提供的多功能 cmdlet，主要用于诊断网络连接。然而，它也可以重新用于渗透测试上下文中的端口扫描。

## 使用 Test-NetConnection 扫描单个端口

要使用`Test-NetConnection`对目标主机进行简单的端口扫描，请参考此示例：

```
 Test-NetConnection -ComputerName 192.168.1.100 -Port 80
ComputerName           : 192.168.1.100
RemoteAddress          : 192.168.1.100
RemotePort             : 80
InterfaceAlias         : Ethernet
SourceAddress          : 192.168.1.101
TcpTestSucceeded       : True
```

在此示例中，`Test-NetConnection` 确认目标系统上的端口`80`已打开，表明该系统运行着一个 Web 服务器。

## 使用 Test-NetConnection 扫描多个端口

渗透测试人员通常需要扫描目标系统上的多个端口。`Test-NetConnection` 可以通过循环来扫描一系列端口或特定端口列表：

```
 $RemoteHost = "192.168.1.100"
$Ports = 80, 443
foreach ($Port in $Ports) {
    Test-NetConnection -ComputerName $RemoteHost -Port $Port }
ComputerName           : 192.168.1.100
RemoteAddress          : 192.168.1.100
RemotePort             : 80
InterfaceAlias         : Ethernet
SourceAddress          : 192.168.1.101
TcpTestSucceeded       : True
ComputerName           : 192.168.1.100
RemoteAddress          : 192.168.1.100
RemotePort             : 443
InterfaceAlias         : Ethernet
SourceAddress          : 192.168.1.101
TcpTestSucceeded       : False
```

在此案例中，`Test-NetConnection` 扫描目标系统上的端口`80`和`443`，结果显示每个端口是否开放。

## 使用 Test-NetConnection 枚举开放端口

渗透测试的主要目标之一是列举开放的端口。你可以利用 PowerShell 仅筛选并显示开放的端口：

```
 $RemoteHost = "192.168.1.100"
$Ports = 1..65535
$OpenPorts = foreach ($Port in $Ports) {
    $Result = Test-NetConnection -ComputerName $RemoteHost -Port $Port
    if ($Result.TcpTestSucceeded) {
        $Port
    }
}
```

在这个例子中，`Test-NetConnection`扫描所有可能的端口并识别开放的端口。`Test-NetConnection`主要用于诊断网络连接，但它对渗透测试人员来说也是一个宝贵的端口扫描工具。通过利用它的功能来检查目标系统上特定端口的状态，渗透测试人员可以收集有关潜在漏洞和安全弱点的重要信息。然而，重要的是要注意，渗透测试应始终在获得适当授权并以负责任、道德的方式进行，以避免任何法律或道德问题。`Test-NetConnection`在这些指导方针下使用时，可以成为渗透测试人员工具箱中的一项资产。

## 使用.NET 进行单端口扫描

PowerShell 可以创建一个.NET 套接字对象，与目标主机上的单个端口建立连接。以下是一个示例：

```
 $RHost = "192.168.1.100"
$Port = 80
$TcpClient = New-Object System.Net.Sockets.TcpClient
try {
    $TcpClient.Connect($RHost, $Port)
    Write-Host "Port $Port on $RHost is open." }
catch {
    Write-Host "Port $Port on $RHost is closed or filtered." }
finally {
    $TcpClient.Close()}
```

在这个例子中，PowerShell 创建了一个 TCP 客户端对象，并尝试连接到目标主机的指定端口。然后，它报告该端口是开放还是关闭的。

## 使用.NET 进行多端口扫描

一次典型的渗透测试涉及扫描目标系统上的多个端口。PowerShell 可以遍历端口列表并检查它们的状态：

```
 $RHost = "192.168.1.100"
$Ports = 80, 443, 22
foreach ($Port in $Ports) {
    $TcpClient = New-Object System.Net.Sockets.TcpClient
    try {
        $TcpClient.Connect($RHost, $Port)
        Write-Host "Port $Port on $RHost is open." }
    catch {
        Write-Host "Port $Port on $RHost is closed or filtered."     }
    finally {
        $TcpClient.Close()}}
```

这个 PowerShell 脚本扫描目标主机上的端口列表，并报告它们的状态。

## 使用.NET 列举所有开放端口

在某些情况下，列举目标系统上所有开放的端口是非常重要的。PowerShell 可以用来系统地扫描一系列端口：

```
 $RHost = "192.168.1.100"
$StartPort = 1
$EndPort = 65535
for ($Port = $StartPort; $Port -le $EndPort; $Port++) {
    $TcpClient = New-Object System.Net.Sockets.TcpClient
    try {
        $TcpClient.Connect($RHost, $Port)
        Write-Host "Port $Port on $RHost is open."     }
    catch {# Port is closed or filtered.}
    finally {
        $TcpClient.Close()}}
```

PowerShell 系统地扫描目标主机上所有可能的端口，并报告开放的端口。

在 PowerShell 中利用.NET 套接字对象为渗透测试人员提供了一种多功能且可编程的端口扫描方法，作为道德黑客评估的一个重要组成部分。端口扫描在识别目标系统中的潜在漏洞方面发挥着关键作用，而.NET 套接字对象使测试人员能够有效地自动化和自定义这个过程。然而，进行渗透测试时，必须负责任地进行，遵守法律和道德规范并获得适当的授权。负责任地使用时，PowerShell 中的.NET 套接字对象为渗透测试人员评估系统和网络的安全态势提供了强大的工具，最终提升了网络安全性。

# 使用 PowerShell 进行 UDP 端口扫描

在 PowerShell 中执行 UDP 端口扫描涉及向目标主机的特定端口发送 UDP 数据包，以确定这些端口是开放还是关闭的。与 TCP 不同，UDP 是无连接的，这使得 UDP 端口扫描更加具有挑战性，因为没有握手来确认端口的状态。以下是使用 PowerShell 的简化方法：

```
 $RHost = "192.168.1.100"
$Ports = 53, 67, 123
foreach ($Port in $Ports) {
    $UdpClient = New-Object System.Net.Sockets.UdpClient
    try {
        $UdpClient.Connect($RHost, $Port)
        $UdpClient.Send([byte[]](0), 0, 0)
        Write-Host "UDP Port $Port open - $RHost"
    }
    catch {
        Write-Host "UDP Port $Port closed - $Host."     }
    finally {
        $UdpClient.Close()}}
```

此脚本会遍历指定的 UDP 端口，创建 UDP 客户端对象，并向每个端口发送一个空的 UDP 数据包。如果在过程中捕获到异常，则表示端口已关闭或被过滤。如果没有异常，则认为该端口是开放的。

请注意，UDP 扫描可能不如 TCP 扫描可靠，因为 UDP 不像 TCP 那样提供相同的确认和响应机制。某些开放的 UDP 端口可能不会响应空的 UDP 数据包，这可能导致假阴性。此外，防火墙和网络过滤可能会影响 UDP 端口扫描的准确性。请始终确保获得适当的授权，并考虑使用更专业的工具进行全面的渗透测试任务。

# 使用 PowerShell 工具进行端口扫描

有几个开源的 PowerShell 工具支持 TCP/UDP 端口扫描。以下是一个 PowerShell 扫描工具的示例：[`github.com/BornToBeRoot/PowerShell_IPv4PortScanner`](https://github.com/BornToBeRoot/PowerShell_IPv4PortScanner)。

IPv4PortScan 是一个异步的 TCP 扫描工具，允许用户定义要扫描的端口范围。该工具的命令行如下：

```
 .\IPv4PortScan.ps1 [-ComputerName] <String> [[-StartPort] <Int32>] [[-EndPort] <Int32>] [[-Threads] <Int32>] [[-Force]] [<CommonParameters>]
```

在接下来的步骤中，我们将使用此工具扫描计算机`www.snowcapcyber.com`上的前 500 个端口：

```
 PS> .\IPv4PortScan.ps1 -ComputerName www.snowcapcyber.com -EndPort 500
Port Protocol ServiceName  ServiceDescription   Status
---- -------- -----------  ------------------   ------
  53  tcp     domain       Domain Name Server   open
  80 tcp      http         World Wide Web HTTP  open
```

PS2 工具是一个 TCP 端口扫描器工具，模拟了 Nmap 的一些功能。此工具可以在[`github.com/nccgroup/PS2`](https://github.com/nccgroup/PS2)下载。

该工具支持 TCP 和 UDP 扫描，并通过 Traceroute 功能绘制网络拓扑。接下来，我们将使用此工具扫描常用的前 1,000 个 TCP 端口：

```
 PS C:\>ps2.ps1 -sT -i 192.168.1.1
```

在以下示例中，我们将使用该工具扫描所有 TCP 端口：

```
 PS C:\>ps2.ps1 -sT -p (1..65535) -i 192.168.1.1
```

最后，我们将使用此工具扫描常用的前 1,000 个 UDP 端口：

```
 PS C:\>ps2.ps1 -sU -i 192.168.1.1
```

总结来说，PowerShell 使我们能够创建简单而强大的 TCP/UDP 端口扫描工具。我们展示了如何使用和脚本化 cmdlet，以及如何利用 PowerShell 调用.NET 功能。这些工具使我们能够在渗透测试中“活用土地”，并减少在安全测试中所需支持的工具数量。

# 总结

本章全面探讨了如何利用 PowerShell 进行强大的网络侦察和安全评估。详细阐述了理解网络结构的重要性，并揭示了如何有效地利用 PowerShell 列举设备和服务。你将深入了解网络枚举的复杂性，掌握使用 PowerShell 技术发现活跃主机、识别在线系统以及绘制网络架构的技巧。

本章深入探讨了端口扫描的领域，强调了它在漏洞评估中的关键作用。通过展示 PowerShell 在端口扫描中的强大功能，本章揭示了识别开放端口、服务和潜在漏洞的策略。实际案例和真实场景为你提供了动手实践的经验，使你能够增强网络安全性。无论是用于防御目的还是道德黑客，本章都作为一个宝贵的资源，提供了使用 PowerShell 多功能能力进行网络枚举和端口扫描的深刻理解。

在下一章中，我们将学习如何在对 REST 和 SOAP API 进行渗透测试时使用 PowerShell。
