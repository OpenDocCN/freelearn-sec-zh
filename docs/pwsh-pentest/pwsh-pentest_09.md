

# 第九章：PowerShell 和 FTP、SFTP、SSH 以及 TFTP

在本章中，我们将导航评估 **文件传输协议**（**FTP**）、**简单文件传输协议**（**TFTP**）和 **安全文件传输协议**（**SFTP**）服务器的复杂性。在这里，我们展示 PowerShell 的多面手能力，将其定位为这一关键领域中的一个多用途工具。

在本章节中，我们深入剖析每种协议的细微差别——FTP 因其广泛应用，TFTP 因其简化的特性，SFTP 因其强大的安全文件传输功能。章节阐明了这些协议所带来的独特安全挑战，并为如何有效利用 PowerShell 解决和缓解这些挑战提供了研究基础。

在整个叙述过程中，实际的示范和现实场景展示了 PowerShell 的适应性，特别是通过编写定制的测试脚本。从探测这些协议固有的漏洞，到执行模拟的恶意活动和发起有针对性的暴力破解攻击，PowerShell 成为检查 FTP、TFTP 和 SFTP 服务器安全态势的灵活且强大的工具。

在我们探索 PowerShell 在安全测试中的应用时，不仅可以获得技术见解，还能获得优化测试工作流程的可操作策略。无论是经验丰富的安全专家，还是该领域的新手，本章都为利用 PowerShell 强大的功能，在网络安全的动态环境中加强 FTP、TFTP 和 SFTP 服务器的防御，提供了宝贵的资源。

本章将涵盖以下主题：

+   PowerShell 和 FTP

+   FTP 连接的暴力破解身份验证

+   PowerShell 和 FTP

+   PowerShell 和 SSH、SCP 以及 SFTP

+   SSH 的暴力破解身份验证

+   SSH 安全审计工具

# PowerShell 和 FTP

使用 PowerShell 评估 FTP 服务器的安全性涉及一系列测试和检查，以识别潜在的漏洞和配置弱点。虽然我无法提供完整的 1,111 字的文章，但我可以为您提供概述以及如何使用 PowerShell 测量 FTP 服务器安全性的示例。

## FTP 横幅抓取

评估 FTP 服务器安全性的第一步通常是横幅抓取（banner grabbing），它能够获取有关 FTP 服务器的信息。横幅抓取使我们能够识别正在运行的服务的类型/版本号。然后，可以利用这些信息识别与该服务相关的漏洞。这有助于识别软件及其版本，为潜在漏洞提供有价值的信息。我们之前的回答中已经涵盖了横幅抓取，因此这里有一个脚本：

```
 $ftpServer = "ft p://ftp.snowcap cyber.com"
$request = [System.Net.WebRequest]::Create($ftpServer)
$request.Method = [System.Net.WebRequestMethods+Ftp]::ListDirectoryDetails
$response = $request.GetResponse()
$stream = $response.GetResponseStream()
$reader = [System.IO.StreamReader]::new($stream)
$banner = $reader.ReadToEnd()
Write-Host "Banner Information:"
Write-Host $banner
$reader.Close()
$response.Close()
```

## 连接到 FTP 服务器

在以下代码中，我们将使用 PowerShell 建立与远程 FTP 服务器的 TCP 连接。以下是一个示例：

```
 $ftpServer = "ft p://ftp.snowcap cyber.com"
$ftpUsername = "your_username"
$ftpPassword = "your_password"
$ftpWebRequest = [System.Net.FtpWebRequest]::Create($ftpServer)
$ftpWebRequest.Credentials = New-Object System.Net.NetworkCredential($ftpUsername, $ftpPassword)
$ftpResponse = $ftpWebRequest.GetResponse()
```

该代码使用指定的凭据建立与服务器的 FTP 连接。

# 暴力破解 FTP 连接的身份验证

任何允许用户通过用户名和密码进行身份验证的服务都可以被暴力破解。术语“暴力破解”指的是系统地尝试所有可能的密码或加密密钥组合，直到找到正确的那个为止。这种方法用于获取未经授权的访问权限，针对系统、应用程序或加密数据。攻击者会尝试每一个可能的 FTP 用户名和密码或密钥，直到找到正确的组合。

## 匿名访问检查

FTP 服务器有时允许匿名访问，这可能带来安全风险。您可以使用 PowerShell 检查服务器是否允许匿名登录：

```
 $ftpServer = "ft p://ftp.snowcap cyber.com"
$webClient = New-Object System.Net.WebClient
$credentials = $webClient.Credentials
if ($credentials.UserName -eq "anonymous" -or $credentials.UserName -eq "") {
    Write-Host "Anonymous access is enabled." } else {
    Write-Host "Anonymous access is disabled."}
```

## FTP 服务器的 SSL/TLS 支持

检查 FTP 服务器是否支持安全连接（SSL/TLS）对数据安全至关重要。PowerShell 可以帮助您验证这一点。在以下代码中，我们将尝试建立与 FTP 服务器的 SSL/TLS 连接：

```
 $ftpServer = "ft p://ftp.snowcap cyber.com"
$request = [System.Net.WebRequest]::Create($ftpServer)
$request.Method = [System.Net.WebRequestMethods+Ftp]::ListDirectoryDetails
$request.EnableSsl = $true
try {
    $response = $request.GetResponse()
    Write-Host "SSL/TLS is supported." $response.Close()
} catch {
    Write-Host "SSL/TLS is not supported or misconfigured." }
```

PowerShell 可以成为连接到 FTP 服务器并执行各种 FTP 命令的强大工具。PowerShell 中的 .NET Framework 提供了内置的功能来处理 FTP 连接。以下是如何使用 PowerShell 连接到 FTP 服务器并执行命令的示例。

## 列出 FTP 服务器上的文件

您可以使用 PowerShell 列出 FTP 服务器上目录中的文件：

```
 $ftpServer = "ft p://ftp.snowcap cyber.com"
$ftpUsername = "ajcblyth"
$ftpPassword = "Th1s1sMyOa55w9rd"
$remoteDirectory = "/home/ajcblyth/directory"
$ftpWebRequest = [System.Net.FtpWebRequest]::Create("$ftpServer$remoteDirectory")
$ftpWebRequest.Credentials = New-Object System.Net.NetworkCredential($ftpUsername, $ftpPassword)
$ftpWebRequest.Method = [System.Net.WebRequestMethods+Ftp]::ListDirectory
$ftpResponse = $ftpWebRequest.GetResponse()
```

这段代码连接到 FTP 服务器，并列出指定目录中的文件。

## 将文件上传到 FTP 服务器

在以下示例中，我们将使用 PowerShell 将文件上传到 FTP 服务器：

```
 $ftpServer = "ft p://ftp.snowcap cyber.com"
$ftpUsername = "ajcblyth"
$ftpPassword = ".Th1s1sMyOa55w9rd"
$localFilePath = "C:\local\file.txt"
$remoteFilePath = "/remote/directory/file.txt"
$ftpWebRequest = [System.Net.FtpWebRequest]::Create("$ftpServer$remoteFilePath")
$ftpWebRequest.Credentials = New-Object System.Net.NetworkCredential($ftpUsername, $ftpPassword)
$ftpWebRequest.Method = [System.Net.WebRequestMethods+Ftp]::UploadFile
$fileContent = Get-Content $localFilePath
$ftpRequestStream = $ftpWebRequest.GetRequestStream()
$ftpRequestStream.Write($fileContent, 0, $fileContent.Length)
$ftpRequestStream.Close()
$ftpResponse = $ftpWebRequest.GetResponse()
```

这段代码将本地文件上传到 FTP 服务器的指定位置。

## 从 FTP 服务器下载文件

您可以使用 PowerShell 从 FTP 服务器下载文件：

```
 $ftpServer = "ft p://ftp.snowcap cyber.com"
$ftpUsername = "ajcblyth"
$ftpPassword = ".Th1s1sMyOa55w9rd"
$remoteFilePath = "/remote/directory/file.txt"
$localFilePath = "C:\local\downloaded_file.txt"
$ftpWebRequest = [System.Net.FtpWebRequest]::Create("$ftpServer$remoteFilePath")
$ftpWebRequest.Credentials = New-Object System.Net.NetworkCredential($ftpUsername, $ftpPassword)
$ftpWebRequest.Method = [System.Net.WebRequestMethods+Ftp]::DownloadFile
$ftpResponse = $ftpWebRequest.GetResponse()
$ftpResponseStream = $ftpResponse.GetResponseStream()
$fileStream = [System.IO.File]::Create($localFilePath)
$buffer = New-Object byte[] 1024
while ($true) {
    $read = $ftpResponseStream.Read($buffer, 0, $buffer.Length)
    if ($read -le 0) {
        break
    }
    $fileStream.Write($buffer, 0, $read)
}
$fileStream.Close()
$ftpResponseStream.Close()
```

这段代码将文件从 FTP 服务器下载到本地目录。PowerShell 提供了连接 FTP 服务器、执行命令以及自动化各种文件传输任务的灵活性。这些示例可以作为构建更复杂自动化脚本的基础，并在管理和开发工作流程中管理 FTP 交互。

## 强密码策略用于 FTP

您可以通过尝试暴力破解或猜测密码来测试 FTP 用户密码的强度。然而，只有在适当的授权下，作为安全审计或渗透测试的一部分，才能进行此操作。您可以将 PowerShell 与可能的密码列表结合使用，来测试密码强度：

```
 $ftpServer = "ft p://ftp.snowcap cyber.com"
$ftpUsername = "ajcblyth"
$passwords = "password1", "password123", "ftpuserpass", "secureftp"
$webClient = New-Object System.Net.WebClient
$failedAttempts = 0
foreach ($password in $passwords) {
    $webClient.Credentials = New-Object System.Net.NetworkCredential($ftpUsername, $password)
    try {
     $webClient.UploadFile("$ftpServer/test.txt", "C:\temp\test.txt")
        Write-Host "Password '$password' worked!" break
    } catch {
        $failedAttempts++  } }
if ($failedAttempts -eq $passwords.Count) {
    Write-Host "No valid password found." }
```

请注意，没有适当授权的情况下进行密码暴力破解不是一种负责任的做法。

## FTP 的防火墙和访问控制列表

FTP 服务器安全性还可能确保正确的防火墙和 **访问控制列表**(**ACL**) 配置。PowerShell 可以检查 FTP 服务器是否可以从您的系统访问，并分析潜在的限制：

```
 Test-NetConnection -ComputerName ftp.snowcapcyber.com -Port 21
```

此 cmdlet 检查您的系统是否能够连接到 FTP 服务器的端口 `21`，即默认的 FTP 控制端口。它帮助您识别潜在的网络问题。

PowerShell 是评估 FTP 服务器安全性的多功能工具。然而，需要注意的是，安全评估只能在合法和道德的框架下进行，并且需要获得适当的授权。未经授权的活动，如暴力破解攻击，是非法和不道德的。负责任的安全测试和漏洞评估应在受控环境中进行，并获得必要的权限。

# PowerShell 和 TFTP

PowerShell 提供了一套库，可以作为对 TFTP 服务器进行安全测试的一部分。特别是，它们允许我们进行身份识别、枚举，并检查访问控制。

## 识别 TFTP 服务器

使用 PowerShell 识别 TFTP 服务器及其详细信息，如 IP 地址和端口：

```
 Test-NetConnection -ComputerName tftp.snowcapcyber.com -Port 69
```

## 枚举 TFTP 服务器配置

收集 TFTP 服务器配置的相关信息，包括允许的传输模式和任何限制：

```
 Install-Module -Name PSFTP
Get-PSFTPConfiguration -ComputerName tftp.snowcapcyber.com
```

## 验证 TFTP 的访问控制

检查 TFTP 服务器上的访问控制和权限：

```
 Get-PSFTPFile -ComputerName tftp.snowcapcyber.com -Path "/"
```

我们可以使用此方法尝试检索一系列文件。我们可以将所有希望从 TFTP 服务器上检索的文件放在一个文件中，然后通过该文件循环执行 `Get-PSFTPFile` 命令，如下所示：

```
 # Specify the path to the file
$filePath = "C:\Path\To\Your\TFTPFile.txt"
$computer = "tftp.snowcapcyber.com"
# Check if the file exists
if (Test-Path $filePath -PathType Leaf) {
    # Read the contents of the file and print each line
    Get-Content $filePath | ForEach-Object {
        Get-PSFTPFile -ComputerName $computer -Path $_
    }
} else {
    Write-Host "File not found: $filePath"
}
```

在对您不拥有的系统进行安全评估之前，请始终确保获得适当的授权。

# PowerShell 和 SSH、SCP、SFTP

使用 PowerShell 对 **安全外壳（SSH）**、**安全复制（SCP）** 和 SFTP 服务器进行安全审计，涉及一系列步骤来评估安全配置、识别潜在漏洞并收集相关信息。此综合指南提供了逐步的处理方法，并附有每个审计方面的示例。

## SSH 服务器配置评估

评估从识别 SSH 服务器版本开始。然后可以通过各种数据库搜索来识别可能的 CVE 漏洞：

```
 Invoke-Command -ComputerName ssh.snowcapcyber.com -ScriptBlock { ssh -V }
```

该命令连接到 SSH 服务器（**ssh.snowcapcyber.com**）并检索版本信息。了解版本对于识别与特定版本相关的漏洞至关重要。下一步是识别支持的密钥交换算法：

```
 Invoke-Command -ComputerName ssh.snowcapcyber.com -ScriptBlock { ssh -Q kex }
```

该命令查询 SSH 服务器以获取支持的密钥交换算法。识别这些算法有助于评估密钥交换过程的安全性。下一步是列出支持的加密算法：

```
 Invoke-Command -ComputerName ssh.snowcapcyber.com -ScriptBlock { ssh -Q cipher }
```

该命令查询 SSH 服务器以获取支持的加密算法。了解支持的加密算法对于评估数据加密的强度非常重要。下一步是审查 SSH 服务器支持的认证方法：

```
 Invoke-Command -ComputerName ssh.snowcapcyber.com -ScriptBlock { ssh -Q auth }
```

该命令查询 SSH 服务器以获取支持的认证方法。审查这些方法对于确保安全的认证过程至关重要。

# 强力破解 SSH 认证

任何允许用户通过用户名和密码进行身份验证的服务都可能遭受暴力破解。所谓“暴力破解”是指系统地尝试所有可能的密码或加密密钥组合，直到找到正确的为止。这种方法用于未经授权地访问系统、应用程序或加密数据。攻击者会尝试每个可能的 SSH、SCP 和 SFTP 用户名、密码或密钥，直到找到正确的组合。

## SSH 服务器访问控制

我们可以通过以下方式检查 SSH 服务器配置文件：

```
 Invoke-Command -ComputerName ssh.snowcapcyber.com -ScriptBlock { Get-Content /etc/ssh/sshd_config }
```

该命令检索 SSH 服务器配置文件的内容。分析此文件可以提供有关各种安全设置的见解。

## 审查用户访问

我们可以通过以下方式审查用户访问要求：

```
 Invoke-Command -ComputerName ssh.snowcapcyber.com -ScriptBlock { cat /etc/ssh/sshd_config | grep AllowUsers }
```

该命令提取配置文件中包含`AllowUsers`的行，提供有关用户访问控制的见解。限制对特定用户的访问有助于增强安全性。

## SCP 服务器配置评估

与 SCP 相关，识别版本信息的方法如下：

```
 Invoke-Command -ComputerName scp.snowcapcyber.com -ScriptBlock { scp -V }
```

该命令连接到 SSH 服务器并检查是否支持 SCP。验证 SCP 支持对于评估文件传输的安全性非常重要。

## SFTP 服务器配置评估

与 SFTP 相关，识别版本信息的方法如下：

```
 Invoke-Command -ComputerName sftp.snowcapcyber.com -ScriptBlock { sftp -V }
```

该命令连接到 SSH 服务器并检索 SFTP 子系统的版本信息。了解版本信息对于识别与特定版本相关的漏洞至关重要。

## 审查 SFTP 配置

我们也可以如下审查 SFTP 配置：

```
 Invoke-Command -ComputerName www.snowcapcyber.com -ScriptBlock { Get-Content /etc/ssh/sshd_config | grep Subsystem }
```

该命令提取配置文件中包含`Subsystem`的行，提供有关已配置 SFTP 子系统的信息。审查 SFTP 配置设置对于安全评估至关重要。

# SSH 的安全审计工具

我们还可以利用各种审计工具进行安全审计：

```
 Invoke-Command -ComputerName YourSSHServer -ScriptBlock { ssh-audit YourSSHServer }
```

该命令使用`ssh-audit`工具对 SSH 服务器进行安全审计，实施加固建议。安全审计工具可以自动化评估过程，并提供有关潜在漏洞的有价值见解。

## 用户身份验证和授权

作为安全服务器审计的一部分，我们应验证是否能够使用 SSH 密钥认证：

```
 # Invoke SSH command on the remote server using the private key
Invoke-Command -ComputerName ssh.snowcapcyber.com -ScriptBlock {
    param($sshKey)
    ssh -T -i $using:sshKey ajcblyth@ssh.snowcapcyber.com
} -ArgumentList $sshKey
```

该命令使用 SSH 密钥认证连接到 SSH 服务器。需要替换密钥文件路径和用户详细信息。SSH 密钥认证是一种安全的用户身份验证方法。此外，我们还需要验证用户权限。可以通过以下方式实现：

```
 Invoke-Command -ComputerName ssh.snowcapcyber.com -ScriptBlock { sudo -l }
```

该命令检查用户在 SSH 服务器上的`sudo`权限。验证用户权限对于确保用户拥有必要的访问权限而不具备不必要的权限至关重要。

## 监控和日志记录

安全审计的一部分是能够审查监控和日志记录：

```
 Invoke-Command -ComputerName ssh.snowcapcyber.com -ScriptBlock { Get-EventLog -LogName Security -Source sshd }
```

此命令从 SSH 服务器的`Security`日志中检索与 SSH 相关的事件。监控和查看日志有助于检测和响应安全事件。

## 模块

已开发出多个第三方模块和工具，将 SSH 功能带入 PowerShell。接下来，我们将看一些流行的模块和工具，这些工具使得 PowerShell 能够访问 SSH。

### Posh-SSH

GitHub 仓库是`Posh-SSH`。

`Posh-SSH`是一个为 PowerShell 提供 SSH 功能的模块。它允许你建立 SSH 会话、在远程服务器上执行命令，并通过 SCP 和 SFTP 传输文件：

```
 # Install Posh-SSH module
Install-Module -Name Posh-SSH -Force -AllowClobber
# Import the module
Import Module Posh-SSH
# Example: Establish an SSH session
$session = New-SSHSession -Port 22 -ComputerName ssh.snowcapcyber.com -Credential (Get-Credential)
# Example: Run a command on the remote server
Invoke-SSHCommand -SessionId $session.SessionId -Command "ls -l"
# Example: Close the SSH session
Remove-SSHSession -SessionId $session.SessionId
```

### WinSCP .NET 程序集

这是网站：WinSCP .NET 程序集 ([`winscp.net/eng/docs/library`](https://winscp.net/eng/docs/library))。

`WinSCP`主要是一个基于 GUI 的 SCP 和 SFTP 客户端，但它也提供了一个可以在 PowerShell 脚本中使用的.NET 程序集：

```
 # Example: Using WinSCP .NET Assembly for SFTP
$sessionOptions = New-Object WinSCP.SessionOptions -Property @{
    Protocol = [WinSCP.Protocol]::Sftp
    HostName = "ssh.snowcapcyber.com"
    UserName = "ajcblyth"
    Password = "MyPa55w0RdL3tM31N"
}
$session = New-Object WinSCP.Session
try {
    $session.Open($sessionOptions)
    $session.GetFiles("/remote/path/*.txt", "C:\local\path\").Check()
}
finally {
    $session.Dispose()
}
```

### SSH 会话

GitHub 仓库是`SSH-Sessions`。

`SSH-Sessions`是一个允许你在 PowerShell 中创建和管理持久 SSH 会话的模块：

```
 # Install SSH-Sessions module
Install-Module -Name SSH-Sessions -Force -AllowClobber
# Import the module
Import-Module SSH-Sessions
# Example: Establish a persistent SSH session
$session = New-SshSession -ComputerName ssh.snowcapcyber.com -Credential (Get-Credential)
# Example: Run a command on the remote server
Invoke-SshCommand -SessionId $session.SessionId -Command "ls -l"
# Example: Close the persistent SSH session
Remove-SshSession -SessionId $session.SessionId
```

### Chilkat PowerShell SSH/SFTP 模块

这是网站：Chilkat PowerShell SSH/SFTP 模块 ([`www.chilkatsoft.com/refdoc/cssftpref.html`](https://www.chilkatsoft.com/refdoc/cssftpref.html))。

Chilkat 提供了一个 PowerShell 模块，用于 SSH 和 SFTP 操作，允许你执行各种与 SSH 相关的操作：

```
 # Example: Using Chilkat SSH/SFTP Module
$ssh = New-Object Chilkat.Ssh
$success = $ssh.Connect("ssh.snowcapcyber.com")
if ($success -eq $true) {
    $ssh.AuthenticatePw("ajcblyth", "MyPa55w0RdL3tM31N")
    $commandResult = $ssh.QuickCmd("ls -l")
    Write-Host $commandResult
}
$ssh.Disconnect()
```

请记住，这些示例基于我最后一次更新时工具和模块的状态，之后可能已发生更新或更改。始终参考官方文档和发布说明，获取关于这些模块的最新信息。此外，确保遵循安全最佳实践，并在使用 SSH 模块时获得适当的授权。

总之，本指南提供了如何使用 PowerShell 对 SSH、SCP 和 SFTP 服务器进行安全审计的全面概述。所列的步骤涵盖了服务器配置评估、访问控制、身份验证方法和最佳实践。示例演示了如何利用 PowerShell 收集信息并对远程服务器进行安全检查。

安全审计对于维护强健的安全态势至关重要，定期评估有助于识别和减轻潜在的漏洞。PowerShell 的多功能性使其成为自动化审计任务和获取关于基于 SSH 服务的安全性有价值见解的工具。始终在适当授权下进行安全评估，并遵守道德和法律准则。

# 总结

本章广泛探讨了与 FTP、TFTP 和 SFTP 服务器相关的安全测试的复杂领域。我们研究的一个重点是 PowerShell 的使用，这是一种极其灵活的工具，在应对这一关键领域的复杂性时证明了它的不可或缺性。在整章内容中，我们揭示了 PowerShell 所具备的强大功能，展示了它作为解决文件传输环境中的安全问题的全面解决方案的多功能性。

我们的探索不仅深入了理论方面，还通过实际的示例提供了实践性见解。这些示范场景作为宝贵的指南，帮助我们深入理解如何在安全测试的背景下有效地使用 PowerShell。通过剖析每种协议的细微差别——FTP、TFTP 和 SFTP——我们的目标是使你掌握加强服务器环境安全所必需的知识和技能。

在本章的学习过程中，重点不仅仅放在理论讨论上，还涵盖了概念的实际应用。通过揭示安全测试的复杂性并提供具体的例子，我们力图为你提供可操作的见解，提升你在保护文件传输基础设施方面的能力。总的来说，本章作为一个全面的指南，架起了理论与实践之间的桥梁，在 FTP、TFTP 和 SFTP 服务器安全测试的动态领域中，PowerShell 成为这一关键任务中的强大盟友。

在下一章，我们将学习如何使用 PowerShell 对网络连接进行暴力破解，例如 FTP 和 SSH。
