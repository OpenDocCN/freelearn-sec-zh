# 第十三章：PCI DSS 扫描和渗透测试

支付卡行业数据安全标准（PCI DSS）成立于 2006 年，由包括万事达卡、Discover、Visa、美国运通和 JCB 国际在内的几家领先的信用卡公司联合创办。PCI DSS（当前版本为 3.2.1）适用于所有接受、处理、传输和存储信用卡信息及相关细节的机构、商家和企业。该标准的目的仍然是保护商家、服务提供商和消费者免受与信用卡和相关个人可识别信息（PII）的数据安全违规相关的财务和商誉损失。

根据 PCI DSS，持卡人数据包括：

+   持卡人的姓名

+   持卡人的帐号

+   持卡人的服务代码

+   卡的到期日期

敏感数据还包括个人识别号码（PIN）和磁条或芯片上的数据。

PCI DSS 包括 6 个目标和 12 个要求。所有 6 个目标和 12 个要求都可以通过深入评估来实现，以验证已采取措施积极确保持卡人信息的保护。尽管满足 6 个目标和 12 个成就听起来可能很简单，但实际上有 250 个 PCI 子要求。

根据万事达卡，PCI DSS 的六个目标如下：

+   建立和维护安全的网络和系统

+   持卡人数据的保护

+   维护漏洞管理计划

+   实施强大的访问控制措施

+   定期监控和测试网络

+   维护信息安全政策

处理的持卡人交易量决定了公司需要完成的评估类型。一些公司，如 Discover 卡的 Discover Global Network，要求所有使用 Discover 网络处理、传输或存储持卡人数据的商家都符合 PCI 标准。

信用卡机构有各种级别和类别，用于确定合规要求，如下一节所列。这些标准在不同机构之间有所不同，尽管要求对所有机构都是相同的。

+   **级别 1**：必须提交一份年度现场安全评估报告，详细说明处理、存储或传输信用卡信息的评估系统。还需要进行季度网络扫描，必须由批准的扫描供应商（ASV）进行，以远程扫描漏洞和潜在威胁。

+   美国运通年交易量：2.5 百万（或更多）

+   万事达卡年交易量：6 百万或更多

+   **级别 2**：50,000-2.5 百万。需要进行年度自我评估，以及季度网络扫描。商家也可以根据自己的意愿提供现场评估。

+   美国运通年交易量：少于 50,000

+   万事达卡年交易量：1 至 6 百万之间

+   **级别 3**：需要进行年度自我评估，以及季度网络扫描。商家也可以根据自己的意愿提供现场评估。

+   美国运通年交易量：少于 50,000

+   万事达卡年交易量：超过 20,000，但少于 100 万

额外级别：

+   **级别 EMV（美国运通）**：处理超过 50,000 笔芯片启用卡交易需要进行年度 EMV Attestation（AEA）自我检查。

+   **级别 4（万事达卡）**：需要进行年度自我评估，以及季度网络扫描。商家也可以根据自己的意愿提供现场评估。

# PCI DSS v3.2.1 要求 11.3

在本章的前面，我提到 PCI DSS 包括 6 个目标和 12 个要求。官方的 PCI DSS v3.2.1 快速参考指南提供了所有 12 个要求的摘要，可以在[`www.pcisecuritystandards.org/documents/PCI_DSS-QRG-v3_2_1.pdf?agreement=true&time=1535479943356`](https://www.pcisecuritystandards.org/documents/PCI_DSS-QRG-v3_2_1.pdf?agreement=true&time=1535479943356)下载。在本节中，我们关注 PCI DSS 评估的渗透测试元素，这属于*要求 11：定期测试安全系统和流程*，属于*目标 5：定期监控和测试网络*。

要求 11.3 基于实施渗透测试方法，如建议的*NIST SP800-115 信息安全测试和评估技术指南*。尽管 NIST SP800-115 是在 2008 年发布的，但它提供了经过验证的技术和最佳实践，用于范围界定和执行渗透测试，并且在考虑或创建渗透测试方法时应作为指南使用。

要求 11.3.1 侧重于进行外部渗透测试。这应该每年进行一次，或在组织内进行任何有影响力和重大的升级后进行，例如服务器升级、骨干应用程序、交换机、路由器、防火墙、云迁移，甚至环境中操作系统的升级。外部渗透测试应由合格和有经验的人员或第三方进行。

要求 11.3.2 侧重于内部渗透测试。与要求 11.3.1 一样，内部渗透测试应每年进行一次，并由合格和有经验的个人或第三方进行。

要求 11.3.3 更多地是作为分析性要求而不是技术要求，因为它涉及对内部和外部渗透测试的分析，以确保消除所揭示的漏洞和利用。

要求 11.4 定义了方法论范围内的分割。在确定评估范围时（我们将在下一节中看到），强烈建议采取措施来减少范围本身，因为并非网络或 CDE 中的每个系统都需要进行评估。可以使用防火墙和路由器中的访问控制列表配置来进行这种类型的网络隔离。

# PCI DSS 渗透测试的范围

在进行任何类型的渗透测试之前，渗透测试人员需要与客户合作，以确保获得所有适当的信息。在目标范围界定阶段，渗透测试人员将从客户那里收集信息，用于生成目标评估要求，定义测试的参数，以及客户的业务目标和时间表。这个过程在定义任何类型的安全评估的明确目标方面起着重要作用。通过确定这些关键目标，您可以轻松地绘制出将要测试的内容、如何测试、将分配哪些资源、将应用哪些限制、将实现哪些业务目标以及测试项目将如何计划和安排的实际路线图。所有这些信息最终都在一个测试计划中明确说明测试的范围。

我们可以将所有这些元素结合起来，并以正式的范围流程呈现，以实现所需的目标。以下是本章将讨论的关键概念：

+   **收集客户需求**：这涉及通过口头或书面沟通积累有关目标环境的信息。

+   **准备测试计划**：这取决于不同的变量集。这些变量可能包括将实际要求塑造成结构化的测试过程、法律协议、成本分析和资源分配。

+   **确定测试边界**：这确定了与渗透测试任务相关的限制。这些可能是技术、知识的限制，或者是客户 IT 环境的正式限制。

+   **定义业务目标**：这是一个将业务观点与渗透测试计划的技术目标对齐的过程。

+   **项目管理和安排**：这指导了渗透测试过程的每一步，为测试执行制定了适当的时间表。可以使用多种先进的项目管理工具来实现这一目标。

强烈建议您遵循范围界定过程，以确保测试的一致性和更大的成功概率。此外，该过程还可以根据特定情况和测试因素进行调整。如果没有这样的过程，失败的可能性会更大，因为收集到的要求没有适当的定义和程序可供遵循。这可能会使整个渗透测试项目面临风险，并可能导致意外的业务中断。在这个阶段，特别关注渗透测试过程将对测试的其他阶段和技术管理领域的观点有很好的贡献。关键是尽可能多地从客户那里获取信息，以制定反映渗透测试多个方面的战略路径。这些可能包括可协商的法律条款、合同协议、资源分配、测试限制、核心能力、基础设施信息、时间表和参与规则。作为最佳实践的一部分，范围界定过程解决了启动我们的渗透测试项目所必需的每个属性。

每个步骤都包含独特的信息，按照逻辑顺序进行，以成功进行测试执行。这也管理着在早期阶段需要解决的任何法律问题。因此，我们将在下一节更详细地解释每个步骤。请记住，如果所有收集到的信息都以有组织的方式进行管理，对于客户和渗透测试顾问来说，更容易进一步理解测试过程。

# 收集客户需求

这一步提供了一个通用的指南，可以以问卷的形式绘制，以便从客户那里获取有关目标基础设施的所有信息。客户可以是任何与目标组织有法律和商业约束关系的主体。因此，为了成功进行渗透测试项目，关键是在项目的早期阶段识别所有内部和外部利益相关者，并分析他们的利益水平、期望、重要性和影响力。然后可以制定策略，以满足每个利益相关者的需求和参与渗透测试项目，以最大化积极影响并减轻潜在的负面影响。

渗透测试人员有责任在进一步采取任何行动之前验证合同方的身份。

收集客户需求的基本目的是打开一个真实和真实的渠道，通过这个渠道，渗透测试人员可以获取可能对测试过程有必要的任何信息。一旦确定了测试需求，客户应验证这些需求，以消除任何误导性信息。这将确保未来的测试计划是一致和完整的。

# 创建客户需求表

我们列出了一些常见的问题和考虑因素，这些可以作为创建传统客户需求表的基础。需要注意的是，根据客户的目标，这个清单可以扩展或缩短：

+   收集基本信息，如公司名称、地址、网站、联系人详细信息、电子邮件地址和电话号码

+   确定渗透测试项目背后的关键目标

+   确定渗透测试类型（是否具有特定标准）：

+   黑盒测试

+   白盒测试

+   外部测试

+   内部测试

+   包括社会工程

+   排除社会工程

+   调查员工背景信息

+   采用员工的假身份（可能需要法律顾问）

+   包括拒绝服务

+   排除拒绝服务

+   渗透业务合作伙伴系统：

+   需要测试多少台服务器、工作站和网络设备？

+   您的基础设施支持哪些操作系统技术？

+   哪些网络设备需要进行测试？防火墙、路由器、交换机、负载均衡器、IDS、IPS 或其他设备？

+   是否有灾难恢复计划？如果有，我们应该联系谁？

+   目前是否有管理员管理您的网络？

+   是否有遵守行业标准的特定要求？如果有，请列出。

+   谁将成为这个项目的联系人？

+   为这个项目分配了多少时间？

+   您对这个项目的预算是多少？

+   列出任何其他必要的杂项要求。

# 准备测试计划

一旦客户收集并验证了要求，就是时候制定一个正式的测试计划，该计划应反映所有这些要求，以及关于测试过程的法律和商业基础的其他必要信息。准备测试计划涉及的关键变量包括结构化测试流程、资源分配、成本分析、保密协议、渗透测试合同和参与规则。每个领域都有简短的描述，如下所示：

+   **结构化测试流程**：在分析客户提供的细节后，重构测试方法可能很重要。例如，如果社会工程服务即将被排除，您需要将其从正式测试流程中删除。有时，这种做法被称为**测试流程验证**。这是一个需要反复访问的任务，每当客户需求发生变化时都需要重新访问。如果在测试执行过程中涉及任何不必要的步骤，可能会违反组织的政策并造成严重处罚。此外，根据测试类型，测试流程可能会有一些变化。例如，白盒测试可能不需要信息收集和目标发现阶段，因为测试人员已经了解内部基础设施。

无论测试类型如何，验证网络和环境数据可能都是有用的。毕竟，客户可能不知道他们的网络真正是什么样子！

+   **资源分配**：确定实现测试完整性所需的专业知识是最重要的领域之一。因此，将适当技能的渗透测试人员分配到特定任务可能会导致更好的安全评估。例如，对应用程序进行渗透测试需要具有专业知识的应用程序安全测试人员。这项活动在渗透测试任务的成功中起着重要作用。

+   **成本分析**：渗透测试的成本取决于几个因素。这可能涉及分配时间来完成项目范围的天数、额外的服务要求，如社会工程和物理安全评估，以及评估特定技术所需的专业知识。从行业的角度来看，这应该结合定性和定量价值。

+   **保密协议**（**NDA**）：在开始测试过程之前，有必要签署一份能够反映双方利益的保密协议：客户和渗透测试人员。使用这样一份相互保密协议应该明确测试应该遵循的条款和条件。渗透测试人员应该在整个测试过程中遵守这些条款。违反任何一项协议条款都可能导致严重处罚或永久性排除在工作之外。

+   **渗透测试合同**：总是需要一份法律合同来解决客户和渗透测试人员之间的技术和商业事项。这就是渗透测试合同的用武之地。这类合同中的基本信息集中在提供的测试服务、它们的主要目标、如何进行测试、支付声明以及保持整个项目的保密性。强烈建议您由律师或法律顾问创建此文件，因为它将用于大部分渗透测试活动。

+   **参与规则（ROE）**：渗透测试过程可能具有侵入性，并需要清楚了解评估的要求、客户提供的支持以及每种评估技术可能产生的潜在影响或效果类型。此外，渗透测试过程中使用的工具应明确说明其目的，以便测试人员可以相应地使用它们。ROE 以更详细的方式定义了所有这些陈述，以解决测试执行过程中应遵循的技术标准的必要性。您绝不能越过预先同意的 ROE 设定的界限。

通过准备测试计划的每个子部分，您可以确保对渗透测试过程有一致的视图。这将为渗透测试人员提供更具体的评估细节，这些细节是从客户的要求中得出的。始终建议您准备一份测试计划检查表，用于验证与承包方的评估标准及其基础条款。以下部分讨论了一种这样的示范性检查表。

# 测试计划检查表

在范围过程中采取任何进一步步骤之前，以下是一组问题的示例，应正确回答：

+   在 RFP 期间承诺的所有要求都得到满足了吗？

+   测试范围是否明确定义了？

+   所有测试实体都已经确定了吗？

+   所有非测试实体都已经单独列出了吗？

+   是否有任何特定的测试流程将被遵循？

+   测试过程是否被正确记录了？

+   测试过程完成后是否会产生可交付成果？

+   在测试之前是否已经对整个目标环境进行了研究和记录？

+   所有与测试活动相关的角色和责任都已经分配了吗？

+   是否有第三方承包商来完成特定技术评估？

+   是否已经采取任何步骤将项目优雅地结束？

+   灾难恢复计划已经确定了吗？

+   测试项目的成本已经最终确定了吗？

+   已经确定了谁将批准测试计划吗？

+   已经确定了谁将接受测试结果吗？

# 测试边界的分析

了解测试环境的限制和边界与客户需求息息相关，可以解释为有意或无意的利益。这些可以是技术、知识或客户对基础设施施加的任何其他正式限制的形式。每个施加的限制可能会对测试过程造成严重中断，并可以使用替代方法解决。但是，请注意，某些限制无法修改，因为它们由客户管理以控制渗透测试的过程。我们将讨论每种通用类型的限制及其相关示例如下：

+   **技术限制**：这种限制发生在项目范围得到了正确定义，但网络基础设施中存在新技术阻止审计员进行测试。这只有在审计员没有任何可以协助评估这种新技术的渗透测试工具时才会发生。例如，想象一家公司引入了一个强大的 GZ 网络防火墙设备，它位于边界并用于保护整个内部网络。然而，防火墙内部专有方法的实施阻止了任何防火墙评估工具的工作。因此，总是需要一个能够处理这种新技术评估的最新解决方案。

+   **知识限制**：如果渗透测试人员的技能水平有限，无法测试某些技术，那么渗透测试人员的知识限制可能会产生负面影响。例如，专门的数据库渗透测试人员将无法评估网络基础设施的物理安全。因此，根据渗透测试人员的技能和知识，划分角色和责任是有益的，以实现所需的目标。

+   **其他基础设施限制**：客户可以通过限制评估过程来控制某些测试限制。这可以通过限制 IT 基础设施的视图，仅包括需要评估的特定网络设备和技术来实现。通常，这种限制是在需求收集阶段引入的；例如，在测试给定网络段后面的所有设备，除了第一个路由器。客户施加的这种限制首先不能确保路由器的安全，这可能导致整个网络的妥协，即使所有其他网络设备都经过了加固和安全保证。因此，在对渗透测试施加任何此类限制之前，总是需要进行适当的思考。

对所有这些限制和限制进行概要是重要的，可以在收集客户需求的同时进行。一名优秀的渗透测试人员的职责是剖析每个需求，并与客户进行讨论，以撤销或更改可能导致测试过程中断或在不久的将来导致安全漏洞的任何模糊限制。引入高技能的渗透测试人员和先进的工具和技术也可以克服这些限制，尽管某些技术限制天生无法消除，可能需要额外时间来开发测试解决方案。

# 定义业务目标

根据评估要求和服务的认可，定义业务目标至关重要。这将确保测试输出以多种方式使业务受益。每个业务目标都是根据评估要求专注和结构化的，并且可以清晰地展示行业希望实现的目标。我们已经制定了一些通用的业务目标，可以用于任何渗透测试任务。但是，它们也可以根据需求的变化进行重新设计。这个过程很重要，可能需要渗透测试人员在测试完成之前、期间和之后观察和理解业务动机，同时保持标准的最低水平。业务目标是将管理和技术团队聚集在一起，以支持强有力的主张和保护信息系统的想法的主要方面。根据要进行的不同类型的安全评估，得出了以下常见目标列表：

+   通过定期进行安全检查，提供行业范围内的可见性和认可。

+   通过保证业务完整性，实现必要的标准和合规性。

+   保护持有关于客户、员工和其他业务实体的机密数据的信息系统。

+   列出在网络基础设施中发现的活动威胁和漏洞，并帮助制定应该阻止已知和未知风险的安全政策和程序。

+   提供一个平稳而强大的业务结构，将使其合作伙伴和客户受益。

+   保持维护 IT 基础设施安全的最低成本。安全评估衡量了业务系统的机密性、完整性和可用性。

+   通过消除可能由恶意对手利用而造成更多成本的潜在风险，实现更大的投资回报。

+   详细说明组织的技术团队可以遵循的补救程序，以关闭任何开放的漏洞，从而减少运营负担。

+   遵循行业最佳实践和最佳工具和技术，根据基础技术评估信息系统的安全性。

+   建议应该用于保护业务资产的任何可能的安全解决方案。

# 项目管理和排程

管理渗透测试项目需要对范围过程的所有个体部分有透彻的理解。一旦这些范围目标得到清晰，项目经理可以与渗透测试人员协调，制定一个定义项目计划和时间表的正式大纲。通常情况下，渗透测试人员可以独立完成这项任务，但客户的合作可能会给该时间表的这一部分带来积极的关注。这很重要，因为测试执行需要仔细分配不应超过声明的截止日期的时间范围。一旦确定了适当的资源并分配了执行评估期间某些任务的资源，就有必要绘制一个时间表，描述这些资源在渗透测试过程中的关键角色。

每个任务都被定义为渗透测试人员进行的工作。资源可以是参与安全评估的人员，也可以是实验室设备等普通资源，这些资源对渗透测试有帮助。为了有效和经济地管理这些项目，有许多项目管理工具可供选择，可用于实现我们的任务。我们在下表中列出了一些重要的项目管理工具。选择最佳工具取决于环境和测试标准的规定：

| **项目管理工具** | **网站** |
| --- | --- |
| 微软办公项目专业版 | [`www.microsoft.com/project/`](http://www.microsoft.com/project/) |
| TimeControl | [`www.timecontrol.com/`](http://www.timecontrol.com/) |
| TaskMerlin | [`www.taskmerlin.com/`](http://www.taskmerlin.com/) |
| Project KickStart Pro | [`www.projectkickstart.com/`](http://www.projectkickstart.com/) |
| FastTrack Schedule | [`www.aecsoftware.com/`](http://www.aecsoftware.com/) |
| ProjectLibre | [www.projectlibre.org](http://www.projectlibre.org) |
| TaskJuggler | [`www.taskjuggler.org/`](http://www.taskjuggler.org/) |

使用任何这些强大的工具，渗透测试人员的工作可以轻松地按照其定义的任务和时间段进行跟踪和管理。此外，这些工具还提供其他高级功能，例如在任务完成或截止日期超过时为项目经理生成警报。在渗透测试任务期间使用项目管理工具的许多其他积极因素。这些包括按时交付服务的效率，提高测试生产率和客户满意度，提高工作的质量和数量，以及灵活控制工作的进展。

# 执行 PCI DSS 渗透测试的工具

PCI DSS 规定 ASV 每年进行评估，而合格和有经验的专业人士可以每季度进行自我评估。合格的人员应具有多年的渗透测试经验，并持有以下一项或多项认证：

+   **Certified Ethical Hacker** (**CEH**)

+   **Offensive Security Certified Professional** (**OSCP**)

+   **CREST**渗透测试认证

+   **全球信息保障认证** (**GIAC**)，例如 GPEN，GWAPT 和 GXPN。

PCI DSS 评估专业人员使用的工具可以是商业工具或开源工具，只要它们能够产生高水平的准确性。在本书中，我们使用了许多工具，其中一些不仅执行多个功能，而且以自动化的方式执行，通常在指定了所有 IP 信息之后执行。

在第六章，*漏洞扫描*中，我们看了几种用于执行自动化漏洞评估的工具，包括 Tenable 的 Nessus 的试用版及其用于 PCI DSS 评估和合规性的可用选项。Tenable 也是许多公司之一，可以直接聘请作为独立第三方进行年度 PCI DSS 报告的 PCI ASV 漏洞扫描，具体取决于公司的合规水平和年度交易量。

尽管现在只能通过付费订阅获得，但 Nessus 也可以执行内部和外部 PCI DSS 评估。以下屏幕截图显示了 Nessus 内部 PCI DSS 评估的详细信息：

![](img/1729167c-d925-4bc9-890c-9d3096417f09.jpg)

为了简化事情，我列出了前几章涵盖的工具列表，这些工具可以帮助您作为 PCI DSS 自我评估的一部分执行漏洞评估和渗透测试。同样，某些工具可能在列表中重复出现，因为它们可能执行多个功能：

+   信息收集（第四章，*足迹和信息收集*）：

1.  Devsploit

1.  Striker

1.  RedHawk

+   扫描（第五章，*扫描和规避技术*）：

1.  Nmap

1.  RedHawk

+   漏洞评估（第六章，*漏洞扫描*）：

1.  OpenVAS

1.  Nessus

1.  Lynis（Linux 系统审计）。

1.  Sparta

+   第七章，*社会工程*：

1.  社会工程工具包

+   利用（第 8-12 章）：

1.  Metasploit

1.  NetHunter

+   报告（第十四章，*渗透测试报告工具*）：

1.  Dradis 框架

当然，还有许多其他工具可用于评估，但这些工具应该足以让您开始。

# Summary

在本章中，我们介绍了**支付卡行业数据安全标准**（**PCI DSS**）及其对必须符合 PCI DSS 的组织的目标和要求。我们还了解了根据每年处理的支付卡交易量所需的不同合规级别。我们还了解了分割的重要性及其对 PCI DSS 评估的影响，然后详细了解了范围界定过程。

在本章的最后，我们了解到只有合格和有经验的专业人员才能被授权进行 PCI DSS 自我评估，还要雇佣 PCI DSS ASV 来执行年度外部 PCI DSS 评估。最后，我们回顾了本书中之前章节中使用的各种工具，这些工具可以用于执行评估。

在下一章中，我们将介绍创建报告并帮助我们整合渗透测试各个方面的工具。

# 问题

1.  哪些公司制定了 PCI DSS 标准？

1.  PCI DSS 的当前版本是什么？

1.  PCI DSS 中有多少个目标和要求？

1.  哪些要求涉及内部和外部 PCI DSS 评估？

1.  ASV 可以进行哪种类型的评估？

1.  ASV 必须多久进行一次外部评估？

1.  分割的目的是什么？

1.  在提到评估的范围方面时，结构化测试过程指的是什么？

1.  专业的渗透测试人员应具备哪些资格？

1.  哪些漏洞评估工具可用于执行 PCI DSS 自我评估？

# 进一步阅读

关于 PCI DSS、评估和与此相关的一般知识，还有更多内容可以了解，请访问以下链接。

+   要求和安全评估程序：[`www.pcisecuritystandards.org/documents/PCI_DSS_v3-2-1.pdf`](https://www.pcisecuritystandards.org/documents/PCI_DSS_v3-2-1.pdf)

+   PCI DSS 快速参考指南：[`www.pcisecuritystandards.org/documents/PCI_DSS-QRG-v3_2_1.pdf?agreement=true&time=1535905197919`](https://www.pcisecuritystandards.org/documents/PCI_DSS-QRG-v3_2_1.pdf?agreement=true&time=1535905197919)

+   PCI DSS 合规性报告模板：[`www.pcisecuritystandards.org/documents/PCI-DSS-v3_2_1-ROC-Reporting-Template.pdf?agreement=true&time=1535905197972`](https://www.pcisecuritystandards.org/documents/PCI-DSS-v3_2_1-ROC-Reporting-Template.pdf?agreement=true&time=1535905197972)

+   追求 PCI DSS 合规性的优先方法概述：[`www.pcisecuritystandards.org/documents/Prioritized-Approach-for-PCI-DSS-v3_2_1.pdf?agreement=true&time=1535905628536`](https://www.pcisecuritystandards.org/documents/Prioritized-Approach-for-PCI-DSS-v3_2_1.pdf?agreement=true&time=1535905628536)
