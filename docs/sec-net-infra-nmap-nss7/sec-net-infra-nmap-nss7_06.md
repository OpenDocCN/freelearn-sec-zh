# 第六章：报告分析和确认

在本章中，我们将涵盖以下内容：

+   理解 Nmap 输出

+   理解 Nessus 输出

+   如何使用 Nmap 和其他工具确认 Nessus 漏洞

# 介绍

在本章中，我们将介绍使用 Nmap 和 Nessus 生成的报告的各种方法。我们还将看一下使用 Nmap 确认 Nessus 报告的漏洞的方法。始终需要确认扫描器报告的漏洞，因为有可能扫描器报告了假阳性漏洞。确认这些漏洞将允许管理团队专注于已确认的漏洞，而不是浪费资源在已报告的假阳性上。Nmap 和 Nessus 生成不同格式的报告，允许用户根据其要求进行选择。

# 理解 Nmap 输出

Nmap 根据它从远程主机接收到的响应来显示结果。扫描的主机越多，打印在屏幕上的结果就越复杂。当主机数量增加时，在终端或命令提示符中打印这些结果变得不可能。为了解决这个问题，Nmap 支持各种报告格式，可以根据用户的要求使用。存储 Nmap 输出的最简单方法之一是使用`>>`运算符，后面跟着一个文本文件名，比如`output.txt`。这将允许 Nmap 将所有内容转发到那个文本文件。即使对于 10 个以上的主机，文本文件的内容也变得难以分析。Nmap 还提供了大量冗长和调试信息，以及端口扫描，这可能会使这个过程变得更加复杂。操作系统的检测和指纹识别为这些数据增加了更多的垃圾。

以下命令用于在 IP 地址`192.168.75.128`上运行 SYN 扫描，并将显示的输出存储到`output.txt`文件中。由于命令提示符在相同的文件夹中运行，因此可以在`C:\Users\admin`文件夹中找到此文件。此外，您可以通过在双引号中提及文件的绝对路径来将此文件存储在任何位置：

```
Nmap –sS –Pn192.168.65.128>> output.txt
```

让我们通过以下截图来看看结果如何被复制到文本文件中：

![](img/3a70314e-1c1a-4a40-8cb7-5db9ef5ce80a.png)

导航到 Nmap 安装文件夹并找到`output.txt`文件：

![](img/da88a502-c8df-4724-8f24-a18522e6bfb7.png)

您可以使用任何文本编辑器打开此文件。我个人推荐 Notepad++，因为它允许您对文本文件进行复杂的分析，并以分隔的方式显示它们：

![](img/5d234020-0813-4438-b954-9d5f231dc44a.png)

Nmap 允许用户使用命令行标志定义输出格式。以下列表解释了 Nmap 允许的不同标志： 

+   **交互式输出**：这是直接显示在终端或命令提示符中的输出类型。这不需要任何特殊的命令提示符参数或标志，因为这是基本的默认输出格式。这个结果不会被存储或保存在任何位置；只有在命令提示符或终端没有关闭的情况下才能访问这个输出。

+   **正常输出**（`-oN`）：这个输出允许用户将交互式输出保存到用户选择的文件中。根据用户选择的冗长级别，这个报告选项进一步削减了交互式输出扫描中不必要的冗长数据。这将允许用户通过省略不需要的数据来更好地查看端口扫描结果。如果用户需要性能数据，比如扫描时间和警报，这不是正确的格式选择。此外，您可以通过提及绝对路径或启动具有相同路径的命令提示符来指定文件夹位置。

+   **XML 输出**（`-oX`）：上传 Nmap 数据到各种工具和网站需要此类型的输出。一旦将此格式上传到任何工具，然后由解析器解析，以便我们可以理解输出中的各种数据类型并相应地对数据进行分离。有许多可用作开源的 XML 解析器，这些解析器是由各种工具 OEM 定制构建的。

+   **Grepable 输出**（`-oG`）：此格式允许用户对生成的输出执行简单的操作，例如`grep`，`awk`，`cut`和`diff`。该格式遵循为每个主机创建单行输出的结构，并带有适当的分隔符，以便用户可以使用操作系统中的简单现有工具来分隔和分析结果。Notepad++实用程序就是这样一个例子，它允许基于分隔符的分隔，可以用于创建更有意义的报告。

+   **Script kiddie**（`-oS`）：此格式以脚本形式打印输出。

+   **以所有格式保存**（`-oA`）：此标志允许用户以前面提到的三种格式（`-oN`，`-oX`和`-oG`）生成输出。用户可以简单地使用此标志一次性获得所有三种报告格式，并将其保存在提供的位置的文件中，而不是执行三次不同的扫描以获得输出格式。

Nmap 还提供了作为扫描结果的一部分的各种其他详细信息，其中一些可以通过可用的详细选项来控制。以下是由详细选项产生的一些额外数据：

+   **扫描完成时间估计**：Nmap 还提供性能数据，例如以分钟为单位的扫描完成时间，这使用户可以了解 Nmap 执行扫描所需的时间。Nmap 会在时间间隔内更新用户有关所花时间和正在执行的任务以及完成百分比的信息。这使用户可以监视更大网络的网络扫描并偶尔改善脚本的执行时间。

+   **开放端口**：在未启用详细信息的正常扫描中，所有开放端口都会显示在扫描结束时。相反，如果启用了详细信息，则每个开放端口在检测到时都会立即显示。

+   **附加警告**：Nmap 还会显示在扫描过程中发生的任何警告或错误，无论端口扫描是否需要额外时间，还是与扫描的正常行为有任何差异。这将允许用户检查任何网络限制并相应地采取行动。

+   **OS 检测信息**：Nmap 中的 OS 检测是使用基于 TCP ISN 和 IP ID 预测的签名检测进行的。如果启用了详细信息，并选择了 OS 检测选项，Nmap 将显示这些 OS 的预测。

+   **主机状态**：Nmap 还会在运行时打印主机的状态，指示主机是活动的还是已关闭的：

![](img/e644259a-ed97-4e8c-bbde-944690164a8f.png)

可以与详细信息一起使用的一些选项来控制输出中显示的数据如下：

+   **调试输出**：调试模式是 Nmap 提供的另一个附加标志选项，可帮助用户进一步了解端口扫描过程的数据。可以通过在详细信息语法后附加`-d`来启用此选项。此外，还可以通过在详细信息语法后附加`-d9`来设置要启用的调试级别，范围为 1 至 9。这是最高级别的调试，提供有关正在执行的端口扫描的大量技术数据：

![](img/40095613-b813-43df-81b0-ac88d46b5078.png)

+   **数据包跟踪**：此选项允许用户获取 Nmap 正在发送的每个数据包的跟踪。这将使用户能够详细了解扫描。可以通过在详细信息语法后附加`--packet-trace`来配置此选项：

![](img/2d7612e5-ee64-431e-a436-cf8e1792cee2.png)

# 准备就绪

为了完成此活动，您必须满足计算机上的以下先决条件：

1.  您必须安装 Nmap。

1.  您必须对要执行扫描的主机具有网络访问权限。

要安装 Nmap，可以按照第二章中提供的说明进行操作，*了解网络扫描工具*。这将允许您下载兼容版本的 Nmap 并安装所有必需的插件。为了检查您的计算机是否安装了 Nmap，请打开命令提示符并输入`Nmap`。如果 Nmap 已安装，您将看到类似以下的屏幕：

![](img/c7b49d51-14eb-4652-80bd-3dd2c34acfcb.png)

如果您没有看到上述屏幕，请将命令提示符控件移动到 Nmap 安装的文件夹（`C:\Program Files\Nmap`）中重试相同步骤。如果这样做后仍然看不到屏幕，请删除并重新安装 Nmap。

为了填充扫描将要执行的主机上的开放端口，您需要对该主机具有网络级访问权限。通过向主机发送 ping 数据包来检查您是否可以访问主机是一种简单的方法。但是，如果在该网络中禁用了 ICMP 和 ping，则此方法仅适用。在禁用 ICMP 的情况下，活动主机检测技术各不相同。我们将在本书的后续部分中详细介绍这一点。

为了获得上述输出，我们需要安装虚拟机。为了运行虚拟机，我建议使用 VMware 的 30 天试用版本，可以从[`www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html`](https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html)下载并安装。

对于测试系统，读者可以从[`information.rapid7.com/download-metasploitable-2017.html`](https://information.rapid7.com/download-metasploitable-2017.html)下载 Metasploitable（Rapid 7 提供的一个易受攻击的虚拟机）。执行以下步骤打开 Metasploitable。这提供了各种组件，如操作系统、数据库和易受攻击的应用程序，这将帮助我们测试本章的配方：

1.  解压下载的 Metasploitable 软件包：

![](img/3386810f-b74e-4cb6-bddb-553bc6cf9265.png)

1.  使用安装的 VMware Workstation 或 VMware Player 打开`.vmx`文件：

![](img/1e6aa6bb-35a6-4bf4-994f-7ac81c473ac0.png)

1.  使用`msfadmin`/`msfadmin`作为用户名和密码登录：

![](img/5f5b0990-5c5c-4b7e-b877-fa7234a9334b.png)

# 如何操作…

执行以下步骤：

1.  在命令提示符中打开 Nmap。

1.  在命令提示符中输入以下语法以获取交互式输出：

```
Nmap -sS -Pn 192.168.103.129
```

![](img/c768eace-d3cd-4c46-89f9-56f2160a8fec.png)

1.  在命令提示符中输入以下语法以获取正常输出：

```
Nmap -sS -Pn 192.168.103.129 -oN output
```

![](img/4b1aeb28-33b2-4591-ae84-c90e6b75f721.png)

您可以导航到`system32`文件夹，找到输出文件并用文本编辑工具打开它：

![](img/525cbe28-55c1-4c60-a635-6d337cab2861.png)

1.  在命令提示符中输入以下语法以获取 XML 输出：

```
Nmap -sS -Pn 192.168.103.129 -oX  output
```

![](img/0b3bc66a-3613-406d-a08e-2f2abe1e2fc3.png)

您可以导航到`system32`文件夹，找到输出文件并用文本编辑工具打开它：

![](img/448f4fb1-c55b-4dda-932a-2a5c7e097cb0.png)

1.  在命令提示符中输入以下语法以获取脚本小子输出：

```
Nmap -sS -Pn 192.168.103.129 -oS  output
```

![](img/a6ea532e-8151-4e14-b15c-eb2952e2f9a9.png)

您可以导航到`system32`文件夹，找到输出文件并用文本编辑工具打开它：

![](img/92de9919-2d00-4089-b78f-ec0fed19577a.png)

1.  在命令提示符中输入以下语法以获取 grepable 格式的输出：

```
Nmap -sS -Pn 192.168.103.129 -v -oG output
```

![](img/77fc0b87-e02c-461a-993a-aef195d25014.png)

您可以导航到`Windows`文件夹，找到输出文件并用文本编辑工具打开它：

![](img/54f8693a-27ee-48d1-ac09-359550f61f45.png)

1.  在命令提示符中输入以下语法以获取启用详细信息的所有格式的输出：

```
Nmap -sS -Pn 192.168.103.129 -v-oA  output
```

![](img/ad2aa4cf-ee5f-47a4-9779-e373d5794928.png)

您可以导航到`Windows`文件夹，找到输出文件并用文本编辑工具打开它：

![](img/11e0bd24-44d9-4942-827c-abba222680ce.png)

# 它是如何工作的...

这些不同的格式帮助用户利用报告进行多种操作，并以不同的方式分析报告。端口扫描结果代表侦察的关键阶段，这使用户可以进一步规划漏洞扫描和检测活动。然后将这些报告上传到不同的工具和站点进行进一步分析和扫描。值得一提的是，Nmap 是各种漏洞扫描软件的后台实用程序。生成这些报告后，这些工具使用它们来执行进一步的操作。

# 了解 Nessus 输出

Nessus 更多地是一个面向企业的工具。报告更全面，用户友好。Nessus 提供基于文档和结构的报告。可以通过在扫描结果页面右上角的“导出”下拉菜单中选择所需的格式来导出这些报告：

![](img/6ec6bfc4-c127-49e1-b0ce-520a3a6d8894.png)

在这里，我们将介绍 Nessus 支持的报告格式。

# Nessus

这种格式允许用户以`.nessus`格式导入结果。这是一种只能使用 Nessus 解析的格式。它允许用户下载扫描结果，然后将其导入 Nessus 进行任何类型的分析。

# HTML

Nessus 提供了一个 HTML 文件格式的扫描报告的良好示例，这是一个独立的文件，可以在任何浏览器中打开以查看结果。该报告还允许在不同部分之间进行导航，以便用户可以轻松阅读大型报告。这些 HTML 报告也可以定制下载以下报告：

+   执行摘要报告：

![](img/2ea39a0e-64eb-4ba3-a1c6-5a50e7e63b4f.png)

+   自定义报告，漏洞和修复措施按主机分组

+   自定义报告，漏洞和修复措施按插件分组

HTML 报告包含以下部分：

+   **目录**：这列出了按主机和建议漏洞的所需导航窗格。这些包含了复杂报告中的进一步细节，如合规审计：

![](img/4182584a-9542-4be6-bec4-0b847d74b05b.png)

+   **按主机的漏洞**：此部分包括按主机的实际漏洞。这遵循报告每个主机的所有漏洞，然后转移到下一个主机的格式。这进一步从每个主机的漏洞数量和风险评级的简单摘要开始。这包括**扫描信息**，如**开始时间**和**结束时间**，以及**主机信息**：

![](img/4661874c-07ed-4079-9c40-37e51d1b2df4.png)

每个漏洞包括以下部分，其详细信息已在第五章中描述，*配置审计*：

+   插件 ID

+   简介

+   描述

+   解决方案

+   风险因素

+   参考

+   插件信息和输出：

![](img/9ba73cb0-1d4f-4829-b41a-0dd13abb6bfc.png)

# CSV

CSV 是一种用于在表格中存储数据的简单格式，稍后可以导入到数据库和诸如 Excel 之类的应用程序中。这允许用户将报告导出为`.csv`文件，可以使用 Excel 等工具打开。以下是一个示例 CSV 报告的截图：

![](img/0c10d923-52cc-4b8a-bd22-c2d20318cdc6.png)

它包含与 HTML 格式中提到的类似部分。

# Nessus 数据库

这是 Nessus 专有的自定义数据库格式。这是一种加密格式，用于存储扫描的详细信息：

![](img/a27da4a1-07bf-4e6f-9cd5-6b7780fb145c.png)

导入 Nessus 时需要创建和使用密码。

# 准备就绪

为了执行此操作，您必须满足计算机上的以下先决条件：

1.  您必须安装 Nessus。

1.  您必须能够访问要执行扫描的主机的网络。

要安装 Nesus，您可以按照第二章中提供的说明。这将允许您下载兼容版本的 Nessus 并安装所有必需的插件。要检查您的计算机是否已安装 Nessus，请打开搜索栏并搜索`Nessus Web 客户端`。一旦找到并点击，它将在默认浏览器窗口中打开：

![](img/296b1bae-d6e6-4ecc-bb14-9f115a61fc06.png)

如果您确定 Nessus 已正确安装，可以直接从浏览器使用`https://localhost:8834` URL 打开 Nessus Web 客户端。如果找不到**Nessus Web 客户端**，您应该删除并重新安装 Nessus。有关删除 Nessus 和安装说明，请参阅第二章，*了解网络扫描工具*。如果找到**Nessus Web 客户端**但无法在浏览器窗口中打开它，则需要检查 Nessus 服务是否在 Windows 服务实用程序中运行：

![](img/e16bb391-a138-42bd-96f3-51d9238aec2e.png)

您可以根据需要使用服务实用程序进一步启动和停止 Nessus。为了进一步确认使用命令行界面进行安装，您可以导航到安装目录以查看和访问 Nessus 的命令行实用程序：

![](img/dbeed0a4-3cb3-4d5a-a27f-b6a5369011a9.png)

建议始终具有管理员级别或根级别凭据，以便为扫描仪提供对所有系统文件的访问权限。这将允许扫描仪执行更深入的扫描，并与非凭证扫描相比，生成更好的结果，因为没有适当的权限，系统将无法访问所有文件和文件夹。策略合规模块仅在 Nessus 的付费版本中可用，例如 Nessus 专业版或 Nessus 管理器。为此，您将需要从 tenable 购买激活密钥，并在设置页面中更新，如下面的屏幕截图所示：

![](img/90147f33-b14b-44d3-8224-3510ab2325b5.png)

点击编辑按钮打开一个窗口，输入一个新的激活码，你将从 tenable 购买：

![](img/1034f750-69d3-42e0-beb1-4a8e7252fe81.png)

为了测试扫描，我们需要安装一个虚拟机。为了运行虚拟机，我建议使用 VMware 的 30 天试用版，可以从[`www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html`](https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html)下载并安装。

对于测试系统，读者可以参考上一篇文章的*准备就绪*部分下载 Metasploitable。

# 如何做…

执行以下步骤：

1.  打开 Nessus Web 客户端。

1.  使用您在安装过程中创建的用户登录 Nessus 客户端。

1.  对虚拟机执行简单的网络扫描并打开扫描结果：

![](img/87245a45-d5e8-4f48-9590-1ddd53a82d56.png)

1.  导航到导出功能，并选择 Nessus 格式以下载报告的`.nessus`版本：

![](img/adff5c34-2e6e-46ee-be70-55c8fa512397.png)

1.  导航到导出功能，并选择 Nessus 格式以下载报告的 HTML 版本，选择所需的选项：

![](img/3e53f918-4016-4844-ad6c-47b54201a12a.png)

1.  导航到导出功能，并选择 Nessus 格式以下载报告的 CSV 版本：

![](img/f49b7a21-6f82-4808-a6a7-1f8cb89f809b.png)

1.  导航到导出功能，并选择 Nessus 格式以下载报告的 Nessus DB 版本：

![](img/02a7a670-0038-44ab-ae4c-447a65b21761.png)

输入所需的密码，然后单击**导出**以下载带有扩展名`.db`的 Nessus DB 文件。

# 它是如何工作的...

Nessus 支持的报告格式允许用户以多种方式呈现报告。如果用户希望以安全的方式存储扫描结果，他们可以使用加密的 DB 格式。如果用户希望直接共享报告，他们可以使用报告的 HTML 格式。对于进一步的分析，他们可以使用 CSV 格式将报告结果导入工具或软件。如果用户需要与其他管理员共享扫描结果，他们可以使用`.nessus`格式，管理员可以将文件导入其自己的 Nessus 并进行进一步分析。

对于 CSV 报告，如果有多个 CSV 报告并且用户需要在 Windows 中合并所有报告，他们可以从包含所有 CSV 文件的文件夹中打开命令提示符，并使用`copy *.csv <新文件名>.csv`命令，从而获得一个合并的 CSV 单个文件。进一步的过滤和去除重复项并排序允许您创建一个线性报告。

# 如何使用 Nmap 和其他工具确认 Nessus 漏洞

Nessus 报告的大多数漏洞都是基于签名和值的，Nessus 根据插件中的代码做出决定。需要使用手动技术（如 Nmap 脚本或特定端口的开源工具）来确认这些漏洞。这将使管理团队能够将精力集中在消除实际漏洞而不是错误阳性上。此外，有时 Nessus 会报告已经应用了解决方法的漏洞，因为 Nessus 只检查插件中提到的条件，无法识别任何其他偏差。在这个食谱中，我们将查看使用 Nmap 和其他开源工具验证 Nessus 报告的多个漏洞的设置。

为了创建这个食谱，我们将在 Metasploitable 2 的易受攻击的虚拟机上执行一个演示基本网络扫描（请查看*准备就绪*部分以下载此内容）。扫描完成后，查看结果将显示共计七个关键、五个高、18 个中等和七个低漏洞。在 Nessus 报告的漏洞中，我们将尝试手动确认以下漏洞：

+   **绑定外壳后门检测**：这是 Nessus 报告的关键风险漏洞。该漏洞指出远程主机上的一个端口允许网络上的任何用户在易受攻击的虚拟机上以 root 权限运行外壳。我们将使用 Windows Telnet 实用程序来确认这个漏洞：

![](img/82e11413-d8ca-4787-978e-13de2a841d1d.png)

+   **SSL 版本 2 和 3 协议检测**：这是 Nessus 报告的高风险漏洞。该漏洞涉及使用遗留的 SSL 协议，如 SSL 版本 2 和版本 3，已知会导致多个漏洞。我们将使用 Nmap 脚本来确认这个漏洞：

![](img/e4808bc8-293b-4b13-b41c-acbad7d1520e.png)

+   **Apache Tomcat 默认文件**：这是 Nessus 报告的中等风险漏洞。该漏洞提到了安装 Apache 工具时创建的各种默认文件。这些文件仍然可以在网络上供任何用户使用，无需身份验证。我们将使用 Web 浏览器（在这种情况下是 Chrome）来确认这个漏洞。

# 准备就绪

为了创建这个设置，您需要按照前面的食谱“理解 Nmap 输出”和“理解 Nessus 输出”的*准备就绪*部分中提到的所有步骤进行操作。

# 如何做到…

执行以下步骤：

1.  要确认绑定外壳后门检测，打开 Windows 的命令提示符并输入以下命令：

```
telnet 192.168.103.129 1524
```

![](img/6bb22868-f00a-41b7-ae86-9a47a3c8497b.png)

1.  执行后，用户直接登录到远程计算机，无需提供任何身份验证：

![](img/fe9dd893-7b9f-4e4b-91d2-6c5bab9ddcea.png)

1.  为了确认用户的权限，我们将使用标准的 Linux 命令`id`来确认漏洞：

![](img/fb2a317f-7068-4b5c-a47d-8f64200a416c.png)

这个命令显示 UID 和 GID 都是`0`，代表着一个 root 用户，因此我们可以确认这个漏洞是严重的，因为它允许任何远程用户在没有任何认证的情况下登录到机器上。这意味着这个漏洞是可以确认的。

1.  对于 SSL v2 和 SSL v3，我们可以通过使用 Nmap 的 Poodle 确认脚本来确定正在运行的版本，因为只有 SSL v3 容易受到 Poodle 攻击。在命令提示符中打开 Nmap。

1.  输入以下命令来确定远程服务器是否容易受到 SSL Poodle 攻击：

```
Nmap -sV –script ssl-poodle -p 25 192.168.103.129
```

*![](img/3cea245b-5eaf-48af-ba88-86e03210f383.png) *

由于 Nmap 没有显示任何结果，让我们检查一下`ssl-enum-ciphers`脚本：

![](img/ddb99f1b-745d-429d-8b82-04b61288fbee.png)

即使`enum-ciphers`脚本也没有返回任何结果，所以我们可以得出结论，Nmap 无法使用 SSL 密码与端口进行协商。因此，我们可以将漏洞标记为误报。如果在端口`25`上使用 Telnet 也收到类似的响应，我们也可以确认相同的情况。这意味着端口`25`正在运行非 SSL 明文协议，并且插件对此报告了误报。

![](img/74571dd0-0cec-4a24-942d-705134f4a20f.png)

1.  要确认 Apache 默认文件，请访问 Nessus 在漏洞输出部分提到的 URL：

![](img/8ea41469-d1a4-4a64-8c31-61eebd51406c.png)

1.  打开浏览器，然后在地址栏中输入`http://192.168.103.129:8180/tomcat-docs/index.html`：

![](img/47d46f0b-1571-4202-8fcf-4d4c71395a69.png)

这显示了默认的文档文件夹，确认了服务器上默认文件的存在。这表明这个漏洞是可以确认的。

# 工作原理...

这些漏洞可以根据其风险进行识别，然后确认，从而使分析人员能够将他们的努力优先放在他们试图确认的漏洞上。识别这些误报需要努力，因为你必须实际利用漏洞并检查它是否可行。为了做到这一点，分析人员必须决定他们愿意为了修复漏洞而付出多少努力。例如，如果漏洞是端口`1406`上运行着 SQL 服务对网络中的所有人都是开放的，分析人员就必须决定是只检查开放的端口还是尝试使用默认服务账户或弱密码登录到 SQL 服务。
